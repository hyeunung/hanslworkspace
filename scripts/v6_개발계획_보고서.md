# V6 Engine 개발 계획 보고서

## 📋 프로젝트 개요

### 목적
**BOM, 좌표 원본 파일을 업로드하여 정리본 파일을 자동 생성**

### 현재 상태
- BOM, 좌표 원본 파일 및 수동으로 정리한 **약 200개 폴더(보드명)** 존재
- 수동 정리본: 담당자가 하나하나 정리해 놓은 정답 데이터

---

## 📁 파일 식별 규칙

### 1. BOM 원본
| 항목 | 내용 |
|------|------|
| 파일명 | `part`, `bom` 텍스트 포함 |
| 확장자 | `.xls`, `.xlsx`, `.txt`, `.bom` |

### 2. 좌표 원본
| 항목 | 내용 |
|------|------|
| 파일명 | `좌표` 텍스트 포함 |
| 확장자 | `.xls`, `.xlsx`, `.txt` |

### 3. 정리본 (정답지)
| 항목 | 내용 |
|------|------|
| 파일명 형식 | `보드명(숫자)` |
| 예시 | `H25-090_LGIT_BOS_PJT_C50_SAA_V1.1(2505)` |

---

## 📊 데이터 추출 명세

### BOM 파일에서 추출해야 할 항목

| 원본 칼럼명 | 정답지 칼럼명 | 설명 |
|------------|--------------|------|
| PCB Footprint / Partnumber / (제목없음) | 품명 | 칼럼명이 다양함, 제목 없는 경우도 있음 |
| Reference | Ref | Reference 목록 |
| Quantity | SET | 수량 |

### BOM 파일에서 제외해야 할 항목

| 제외 대상 | 예시 |
|----------|------|
| Reference에 `TP` 포함 | TP_DOVOD, TP_VD, TP17 등 |

### 좌표 파일에서 추출해야 할 항목

| 원본 칼럼명 | 정답지 칼럼명 |
|------------|--------------|
| RefDes | RefDes |
| Layer | Layer |
| LocationX | LocationX |
| LocationY | LocationY |
| Rotation | Rotation |

### 좌표 파일에서 제외해야 할 항목

| 제외 대상 | 예시 |
|----------|------|
| RefDes가 숫자로만 이루어진 항목 | 1, 2, 3, 4 등 단일 숫자 |

---

## 🎓 학습해야 할 항목

### 1. 미삽 처리 항목 (비고란)
- **기본값**: `OPEN`, `NC`, `POGO`, `PAD`
- **학습 방향**: 전체 폴더를 돌면서 추가해야 할 항목이나 틀린 것 확인
- **적용 위치**: 비고 칼럼

### 2. 품명별 종류 매핑
- **내용**: 담당자가 '이 부품은 이 종류의 부품이다'라고 명명해 놓음
- **학습 방향**: 수동정리본을 보고 품명 → 종류 매핑 학습
- **중요**: 적힌 그대로 인지 (이름 추측 불필요)

### 3. 종류 정렬 순서
- **규칙**: 수동정리본마다 종류별로 나열되어 있음
- **예시**: IC(SMD)는 항상 맨 위, 커넥터는 항상 맨 아래
- **특이사항**: 같은 종류끼리 모아놓고, 같은 종류의 맨 위에만 이름 있고 나머지는 빈칸

---

## ⚠️ 주의 사항

### 1. 테이블 범위
- 부품 리스트 테이블 테두리 **내의 데이터만** 사용
- 테두리 밖에 작업자가 적어둔 것은 **무시**

### 2. 칼럼 구조 (정답지)
| 위치 | 내용 | 제목 유무 |
|------|------|----------|
| 맨 앞 칼럼 | 종류 | 제목 없음 |
| 맨 뒤 칼럼 | 비고 | 제목 없음 |

### 3. 데이터 복사 원칙
- **절대 추측 금지**: 원본에 있는 이름 그대로 가져와서 적기
- **환각 금지**: BOM, 좌표에 있는 파일 그대로 가져오기
- **정렬**: 같은 종류끼린 모아놓고, 같은 종류끼리는 오름차순 정리 권장
- **핵심**: 1:1 매칭 했을 때 모든 부품 정리가 완료됐는지가 중요

---

## 🔄 검증 프로세스

### Round 1: 기본 추출 검증

#### Step 1: BOM 검증
```
1. SET 총합 확인
   - TP 제외한 나머지 부품들의 총합 비교
   - 숫자가 맞으면 다음 단계 진행

2. 품명 매핑 확인
   - 원본의 품명이 빠짐없이 가져왔는지 확인

3. Ref 매핑 확인
   - 원본의 Reference가 빠짐없이 가져왔는지 확인
```

#### Step 2: 좌표 검증
```
1. TOP/BOTTOM 시트 분리
   - Layer별로 부품 나누기

2. RefDes 매핑 확인
   - 숫자만 있는 항목 제외하고 모두 가져왔는지 확인

3. 좌표값 확인
   - LocationX, LocationY, Rotation 값 확인
```

#### Round 1 로그 형식
```
H25-120_BOI-T_C40_APS_COMMON2.0_6L
  ✅ SET: 일치 (100%)
  ✅ 품명: 일치 (100%)
  ❌ Ref: 불일치 (U4, U7...) 32건 누락
  ✅ 좌표X: 일치 (100%)
  ✅ 좌표Y: 일치 (100%)
  ✅ 회전: 일치 (100%)
  ✅ 면: 일치 (100%)
```

### Round 2: 종류 검증 추가

#### 추가 검증 항목
```
1. 종류 매핑 확인
   - 품명별 종류가 정답지와 일치하는지 확인

2. 종류 정렬 순서 확인
   - IC(SMD) → ... → 커넥터 순서 확인
```

#### Round 2 로그 형식
```
H25-120_BOI-T_C40_APS_COMMON2.0_6L
  ✅ SET: 일치 (100%)
  ✅ 품명: 일치 (100%)
  ✅ Ref: 일치 (100%)
  ❌ 종류: 불일치 (R1005→Resistor, C1608→Capacitor) 5건
  ✅ 좌표X: 일치 (100%)
  ✅ 좌표Y: 일치 (100%)
  ✅ 회전: 일치 (100%)
  ✅ 면: 일치 (100%)
```

### Round 3 이후: 무한 루프

- 모든 보드가 **100% 일치**될 때까지 반복
- 100% 달성 시 루프 종료

---

## 🤖 모델 선택 전략

### 추천 구성

| 역할 | 모델 | 이유 |
|------|------|------|
| 원본 데이터 추출 | `gpt-4o-mini` | 비용 효율적, 단순 추출 작업에 충분 |
| 비교/채점/검증 | `gpt-4o` | 높은 정확도 필요, 복잡한 비교 로직 |

### 비용 효율성 분석

```
gpt-4o-mini (추출용):
- 입력: $0.15 / 1M tokens
- 출력: $0.60 / 1M tokens
- 용도: BOM/좌표 파일 읽기 및 구조화

gpt-4o (검증용):
- 입력: $2.50 / 1M tokens
- 출력: $10.00 / 1M tokens
- 용도: 정답지 추출, 정확한 비교/채점
```

### 최종 추천
- **추출**: `gpt-4o-mini` (저비용, 빠른 속도)
- **검증**: `gpt-4o` (높은 정확도)
- **이유**: 추출은 단순 작업이므로 mini로 충분, 검증은 정확도가 중요하므로 4o 사용

---

## 📂 정답지 시트 구조

### Main 시트 (BOM 정리)
| 종류 | 품명 | SET | ... | Ref | 비고 |
|------|------|-----|-----|-----|------|
| IC(SMD) | U1234 | 5 | ... | U1,U2,U3,U4,U5 | |
| | U5678 | 3 | ... | U6,U7,U8 | |
| DIODE(SMD) | D0603 | 2 | ... | D1,D2 | |
| C/C(1005) | C1005 | 10 | ... | C1~C10 | OPEN |

※ 종류는 맨 위에만 표시, 아래는 빈칸 (같은 종류)

### TOP 시트 (좌표)
| 종류 | Type | RefDes | Layer | LocationX | LocationY | Rotation | 비고 |
|------|------|--------|-------|-----------|-----------|----------|------|
| IC(SMD) | U1234 | U1 | Top | 10.5 | 20.3 | 0 | |

### BOTTOM 시트 (좌표)
| 종류 | Type | RefDes | Layer | LocationX | LocationY | Rotation | 비고 |
|------|------|--------|-------|-----------|-----------|----------|------|
| IC(SMD) | U1234 | U10 | Bottom | 15.2 | 30.1 | 180 | |

---

## 🔧 V6 엔진 설계

### 파일 구조
```
scripts/
  v6-engine.js          # 메인 엔진
  v6_progress.json      # 진행 상황 저장
  v6_dataset.jsonl      # 학습 데이터셋
  v6_last_model.txt     # 마지막 학습된 모델 ID
  v6_개발계획_보고서.md  # 본 문서
```

### 상수 설정
```javascript
const INITIAL_MODEL = 'gpt-4o-mini-2024-07-18';  // 추출용
const VERIFIER_MODEL = 'gpt-4o';                  // 검증용
const BATCH_SIZE = 5;                             // 배치 크기
const BASE_PATH = 'sample-data/24_25_SOCKET';    // 데이터 경로
```

### 주요 함수 설계

#### 1. 파일 분류
```javascript
classifyFiles(dirPath)
// - BOM: part, bom 포함
// - 좌표: 좌표 포함
// - 정답지: (숫자) 패턴
```

#### 2. BOM 추출
```javascript
extractBOM(bomText, modelId)
// 입력: BOM 파일 텍스트
// 출력: { items: [{ itemName, qty, refs }] }
// 제외: TP로 시작하는 Reference
```

#### 3. 좌표 추출
```javascript
extractCoords(coordText, modelId)
// 입력: 좌표 파일 텍스트
// 출력: { "R1": { x, y, rot, layer }, ... }
// 제외: RefDes가 숫자만 있는 경우
```

#### 4. 정답지 추출
```javascript
getTrueData(answerText)
// 입력: 정답지 파일 텍스트
// 출력: { bom: [...], top: [...], bottom: [...] }
// 모델: gpt-4o (정확도 중요)
```

#### 5. 비교 함수
```javascript
compare(extracted, truth, round)
// Round 1: SET, 품명, Ref, 좌표 비교
// Round 2+: 종류 추가 비교
// 출력: { diffs: [...], stats: {...} }
```

#### 6. 데이터셋 저장
```javascript
saveTrainingData(bomText, coordText, truth)
// 조건: 비교 성공한 보드만 저장
// 형식: JSONL
```

---

## 📋 검증 항목 체크리스트

### BOM 검증
- [ ] SET 총합 일치 (TP 제외)
- [ ] 품명 1:1 매핑 완료
- [ ] Ref 1:1 매핑 완료
- [ ] TP 항목 제외 확인

### 좌표 검증
- [ ] TOP/BOTTOM 분리 완료
- [ ] RefDes 1:1 매핑 완료
- [ ] LocationX 일치
- [ ] LocationY 일치
- [ ] Rotation 일치
- [ ] 숫자만 있는 RefDes 제외 확인

### 종류 검증 (Round 2+)
- [ ] 품명별 종류 일치
- [ ] 종류 정렬 순서 일치
- [ ] 미삽 항목 (OPEN, NC, POGO, PAD) 확인

---

## 🚀 개발 로드맵

### Phase 1: 기본 추출 (Round 1)
1. 파일 분류 로직 구현
2. BOM 추출 로직 구현 (TP 제외)
3. 좌표 추출 로직 구현 (숫자 RefDes 제외)
4. 정답지 추출 로직 구현
5. SET/품명/Ref/좌표 비교 로직 구현

### Phase 2: 종류 학습 (Round 2)
1. 종류 매핑 학습 로직 구현
2. 종류 정렬 순서 학습 로직 구현
3. 종류 비교 로직 추가

### Phase 3: 미삽 학습
1. 미삽 항목 패턴 학습 로직 구현
2. 비고란 자동 채우기 로직 구현

### Phase 4: 최적화
1. 무한 루프 안정화
2. 진행 상황 저장/복원 개선
3. 로그 시스템 개선

---

## ✅ V5 대비 개선 사항

| 항목 | V5 | V6 |
|------|-----|-----|
| Round 증가 | 학습 전 증가 (버그) | 학습 후 증가 |
| 데이터셋 | 모든 보드 저장 | 성공한 보드만 저장 |
| TP 제외 | 미구현 | 구현 |
| 숫자 RefDes 제외 | 미구현 | 구현 |
| 미삽 학습 | 미구현 | 구현 |
| 종류 정렬 | 미구현 | 구현 |
| 비용 최적화 | 단일 모델 | 용도별 모델 분리 |

---

## 📝 결론

V6 엔진은 다음과 같은 방식으로 진행됩니다:

1. **Round 1**: BOM/좌표 원본에서 데이터 추출 → 정답지와 비교 → SET, 품명, Ref, 좌표 검증
2. **Round 2**: 종류 매핑 학습 → 종류 검증 추가
3. **Round 3+**: 100% 일치 달성까지 반복 학습

핵심 원칙:
- **추측 금지**: 원본 데이터 그대로 복사
- **정확도 우선**: 1:1 매핑 완료가 목표
- **비용 효율**: 추출은 mini, 검증은 4o 사용

이상으로 V6 엔진 개발 계획 보고서를 마칩니다.

