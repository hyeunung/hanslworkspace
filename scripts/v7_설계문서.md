# BOM 좌표 자동 정리 엔진 v7 설계 문서

## 1. 프로젝트 개요

### 목적
BOM, 좌표 원본 파일 → 정리본 파일 자동 생성

### 현재 상황
- 약 200개 폴더(보드)에 원본 + 수동정리본(정답지) 존재
- 이를 학습하여 새 파일도 자동 정리

---

## 2. 파일 식별

| 파일 종류 | 파일명 특징 | 확장자 |
|---------|-----------|-------|
| BOM 원본 | `part` 또는 `bom` 포함 | .xls, .xlsx, .txt, .bom |
| 좌표 원본 | `좌표` 포함 | .xls, .xlsx, .txt |
| 정리본 | `보드명(숫자)` 형식 | .xlsx |

---

## 3. 파일 구조 분석 결과

### 3.1 정리본(정답지) - 보드명 시트

```
행 6: 헤더
[1]번호 | [2]종류 | [3]품명 | [4]SET | [5]수량 | [6]재고 | [7]CHECK | [8]Ref | [9]대체 가능품목 | [10]비고

행 8~: 데이터
[1]번호 | [2]IC(SMD) | [3]24LC256-I/SN | [4]1 | [5]10 | [6] | [7]□양호 □불량 | [8]U10 | [9] | [10]
```

- **종류**: 칼럼 2 (같은 종류끼리 모음, 첫 번째만 표시)
- **품명**: 칼럼 3
- **SET**: 칼럼 4
- **Ref**: 칼럼 8
- **비고**: 칼럼 10

### 3.2 정리본(정답지) - TOP/BOTTOM 시트

```
행 1: 헤더
[1]종류 | [2]Type | [3]RefDes | [4]Layer | [5]LocationX | [6]LocationY | [7]Rotation | [8]비고

행 3~: 데이터
[1]IC(SMD) | [2]24LC256ISN | [3]U10 | [4]Top | [5]204.27 | [6]68.905 | [7]180 | [8]
```

- **종류**: 칼럼 1 (제목 없음, 첫 번째만 표시)
- **Type(품명)**: 칼럼 2
- **RefDes**: 칼럼 3
- **Layer**: 칼럼 4
- **LocationX**: 칼럼 5
- **LocationY**: 칼럼 6
- **Rotation**: 칼럼 7
- **비고**: 칼럼 8 (제목 없음)

### 3.3 BOM 원본

```
행 12: 헤더
[1]Item | [2]Quantity | [3]Reference | [4]Part | [5]PCB Footprint

행 15~: 데이터
[1]1 | [2]2 | [3]BD2,BD3 | [4]BLM21BB050SN1D/B2012 | [5]BLM21BB050SN1D
```

- **Quantity**: 칼럼 2
- **Reference**: 칼럼 3
- **Part**: 칼럼 4
- **PCB Footprint**: 칼럼 5

### 3.4 좌표 원본 (TXT)

```
RefDes                         Type                           Layer                          LocationX  LocationY  Rotation
------------------------------ ------------------------------ ------------------------------ ---------- ---------- --------
U10                            24LC256ISN                     Top                                204.270     68.905    180.0
```

---

## 4. 파싱 항목

### BOM 원본에서 파싱
| 원본 칼럼 | 용도 |
|---------|-----|
| Reference | Ref (정답지 비교용) |
| Quantity | SET (검증용) |

**제외**: TP로 시작하는 Reference

### 좌표 원본에서 파싱
| 원본 칼럼 | 용도 |
|---------|-----|
| RefDes | RefDes |
| Layer | Layer (TOP/BOTTOM 분리) |
| LocationX | LocationX |
| LocationY | LocationY |
| Rotation | Rotation |

**제외**: RefDes가 숫자만인 것

**소수점 처리**: 4.00→4, 0.0→0, 0.400→0.4 (동일 인식)

---

## 5. 학습 항목

### 5.1 미삽처리 항목
- 기본: OPEN, NC, POGO, PAD
- 전체 파일에서 추가 학습

### 5.2 품명별 종류 ⚠️ 중요 변경
- 정답지 보드명 시트에서 **파싱한 값 그대로 저장**
- ~~GPT-4o 학습~~ → **GPT 사용 안 함** (값 변조 방지)
- 충돌 발생 시: 가장 많이 나온 값으로 임시 저장 + 충돌 목록 기록
- 충돌 목록: `v7_분석결과/종류_충돌목록.json`

### 5.3 품명 매핑
- 원본 BOM 품명 → 정리본 품명
- 예: `LM2662MX_NOPB_R-PDSO-G8_D` → `LM2662MX/NOPB`

---

## 6. 검증 프로세스

### Round 1
1. BOM: Ref 비교 + 종류/품명 학습
2. 좌표: TOP/BOTTOM 비교

### Round 2
- 종류, 품명 학습 완료
- 일치/불일치 판별 추가

### 반복
- 종류, 품명, Ref, 좌표 100% 일치까지 무한 루프

---

## 7. 로그 형식

### Round 1
```
H25-120_BOI-T_C40_APS_COMMON2.0_6L
📚 종류: 학습중
📚 품명: 학습중
❌ Ref: 불일치 (U4, U7...) 32건 누락
✅ 좌표: 일치 (100%)
```

### Round 2+
```
H25-120_BOI-T_C40_APS_COMMON2.0_6L
✅ 종류: 일치 (100%)
✅ 품명: 일치 (100%)
✅ Ref: 일치 (100%)
✅ 좌표: 일치 (100%)
```

---

## 8. 디렉토리 구조

```
scripts/
├── v7-engine.js              # 메인 엔진
├── v7_설계문서.md             # 이 문서
├── v7_학습데이터/
│   ├── 종류_매핑.json          # 품명 → 종류
│   ├── 종류_정렬순서.json       # 종류 우선순위
│   ├── 품명_매핑.json          # 원본품명 → 정리본품명
│   └── 미삽항목.json           # 미삽 키워드
└── v7_분석결과/
    └── 불일치_분석.json        # 불일치 건 분석
```

---

## 9. 실행

```bash
node scripts/v7-engine.js
```

---

## 10. 변경 이력

### 2024-12-06: 종류 매핑 방식 변경

**문제점:**
- 기존: GPT-4o에게 품명-종류 쌍을 보내서 "학습"
- GPT가 값을 변조할 수 있음 (예: R0_1608 → 저항(1608)인데 저항(1005)로 반환)

**해결:**
- **GPT 사용 제거** - 파싱한 값 그대로 저장
- 충돌 시 가장 많이 나온 값으로 임시 저장 + 충돌 목록 파일 생성
- 충돌 목록은 사용자가 확인 후 수동 수정

**교훈:**
- 종류-품명 매핑은 "학습"이 아니라 "파싱"
- 정답지에 있는 값을 그대로 가져오면 됨
- GPT가 개입하면 오히려 데이터가 오염될 수 있음
