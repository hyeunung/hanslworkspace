const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/FastPurchaseTable-BaDwcL3F.js","assets/index-C0ltpiux.js","assets/index-D29sxav7.css","assets/index-j9japXFC.js","assets/PurchaseDetailModal-CtzeTnKh.js","assets/helpers-Buk9LCEc.js","assets/useConfirmDateAction-DJ82cyz7.js","assets/calendar-DNmpbVOW.js","assets/chevron-right-C2GXKUgO.js","assets/chevron-down-RH9PHyLT.js","assets/popover-PYdW6pYI.js","assets/input-D22UTg78.js","assets/calendar-CpcDMxLg.js","assets/check-BiDmNjpw.js","assets/package-B43wqxRF.js","assets/credit-card-C9RDkJ2f.js","assets/trash-2-CnftE5Qo.js","assets/plus-Bur0L2OL.js","assets/save-Dd_EWd65.js","assets/eye-DN8Qg4B1.js","assets/PurchaseItemsModal-Mq9E9iTE.js","assets/table-BYQF0JWX.js"])))=>i.map(i=>d[i]);
import{r as e,a as r,l as s,j as a,_ as t,u as n,e as l,B as i}from"./index-C0ltpiux.js";import{t as c,B as u}from"./index-j9japXFC.js";import{C as o,c as d}from"./card-DsoMh2us.js";import{P as m}from"./plus-Bur0L2OL.js";import{P as p}from"./package-B43wqxRF.js";const _={purchases:null,vendors:null,employees:null,lastFetch:0,userInfo:null,CACHE_DURATION:3e5,filteredData:new Map,FILTER_CACHE_DURATION:3e4},h=e=>{_.filteredData.clear()},f=["정희웅"],y=e.lazy(()=>t(()=>import("./FastPurchaseTable-BaDwcL3F.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19]))),g=e.memo(()=>a.jsx("div",{className:"p-4 space-y-4",children:[...Array(5)].map((e,r)=>a.jsxs("div",{className:"flex space-x-4 animate-pulse",children:[a.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4"}),a.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4"}),a.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4"}),a.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4"})]},r))}));g.displayName="TableSkeleton";const v=e.memo(({purchases:r,activeTab:s,currentUserRoles:t,onRefresh:n,onOptimisticUpdate:l,onPaymentComplete:i,onReceiptComplete:c})=>a.jsx(e.Suspense,{fallback:a.jsx(g,{}),children:a.jsx(y,{purchases:r,activeTab:s,currentUserRoles:t,onRefresh:n,onOptimisticUpdate:l,onPaymentComplete:i,onReceiptComplete:c})}));v.displayName="LazyPurchaseTable";class b{constructor(){this.measurements=new Map,this.SLOW_THRESHOLD=1e3}static getInstance(){return b.instance||(b.instance=new b),b.instance}startMeasure(e){this.measurements.set(e,performance.now())}endMeasure(e,r){const a=this.measurements.get(e);if(!a)return s.warn("성능 측정 시작 시간을 찾을 수 없습니다",{key:e}),0;const t=performance.now()-a;this.measurements.delete(e);const n=t>this.SLOW_THRESHOLD;return s[n?"warn":"debug"](`⚡ 성능 측정: ${e}`,{duration:`${t.toFixed(2)}ms`,context:r,isSlow:n,threshold:`${this.SLOW_THRESHOLD}ms`}),t}async measureAsync(e,r,s){this.startMeasure(e);try{const a=await r();return this.endMeasure(e,s),a}catch(a){throw this.endMeasure(e,`Error: ${s}`),a}}measureSync(e,r,s){this.startMeasure(e);try{const a=r();return this.endMeasure(e,s),a}catch(a){throw this.endMeasure(e,`Error: ${s}`),a}}}const w=b.getInstance(),x=e.lazy(()=>t(()=>import("./PurchaseItemsModal-Mq9E9iTE.js"),__vite__mapDeps([20,1,2,11,21,3,6,7,8,9,10,17,18,16]))),j=[{key:"pending",label:"승인대기"},{key:"purchase",label:"구매 현황"},{key:"receipt",label:"입고 현황"},{key:"done",label:"전체 항목"}];function S({onEmailToggle:t,showEmailButton:y=!0}){const g=n(),b=l(),S=r(),[N,q]=e.useState(null),[T,k]=e.useState({}),[C,O]=e.useState(null),[I,P]=e.useState(!1),{purchases:E,loading:R,currentUserRoles:A,currentUserName:D,refreshPurchases:M,updatePurchaseOptimistic:U}=(()=>{const[a,t]=e.useState([]),[n,l]=e.useState([]),[i,u]=e.useState([]),[o,d]=e.useState(!0),[m,p]=e.useState([]),[f,y]=e.useState(""),[g,v]=e.useState(""),[b,w]=e.useState(""),x=r(),j=e.useRef(!1);e.useEffect(()=>{(async()=>{if(j.current)return;j.current=!0;const e=Date.now(),r=_.lastFetch&&e-_.lastFetch<_.CACHE_DURATION;try{if(r&&_.vendors&&_.employees&&_.userInfo)try{l(_.vendors),u(_.employees);const e=_.userInfo;if(e){let r=[];e.purchase_role&&(r=Array.isArray(e.purchase_role)?e.purchase_role.map(e=>String(e).trim()):String(e.purchase_role).split(",").map(e=>e.trim()).filter(e=>e.length>0)),p(r),y(e.name||e.full_name||""),v(e.email||""),w(e.id||"")}return}catch(a){s.error("캐시 데이터 사용 중 오류",a),_.purchases=null,_.vendors=null,_.employees=null,_.userInfo=null,_.lastFetch=0}const[t,n,i]=await Promise.all([x.from("vendors").select("*"),x.from("employees").select("*"),x.auth.getUser()]);if(t.error)throw t.error;const c=t.data||[];if(l(c),_.vendors=c,n.error)throw n.error;const o=n.data||[];if(u(o),_.employees=o,i.data.user&&!i.error){let r=null;if(i.data.user.email&&(r=(await x.from("employees").select("*").eq("email",i.data.user.email).maybeSingle()).data),r){_.userInfo=r;let e=[];r.purchase_role&&(e=Array.isArray(r.purchase_role)?r.purchase_role.map(e=>String(e).trim()):String(r.purchase_role).split(",").map(e=>e.trim()).filter(e=>e.length>0)),p(e),y(r.name||r.full_name||""),v(r.email||""),w(r.id||"")}_.lastFetch=e}}catch(a){s.error("초기 데이터 로드 실패",a)}})()},[]);const S=e.useCallback(async(e,r)=>{const a=!r?.silent;a&&d(!0);try{const r=Date.now(),u=_.lastFetch&&r-_.lastFetch<_.CACHE_DURATION;if(e&&(h(),_.purchases=null,_.lastFetch=0),!e&&u&&_.purchases)try{return t(_.purchases),void(a&&d(!1))}catch(l){s.error("발주 데이터 캐시 사용 중 오류",l),_.purchases=null,_.lastFetch=0,h()}let o=i;if(0===o.length&&(o=_.employees||[],0===o.length)){const{data:e}=await x.from("employees").select("*");o=e||[]}let m=n;if(0===m.length&&(m=_.vendors||[],0===m.length)){const{data:e}=await x.from("vendors").select("*");m=e||[]}const{data:{user:p},error:f}=await x.auth.getUser();if(f||!p)return s.error("사용자 인증 실패",f),c.error("로그인이 필요합니다."),void(a&&d(!1));const{data:y,error:g}=await x.from("purchase_requests").select("\n          *,\n          purchase_request_items(*)\n        ").order("request_date",{ascending:!1}).limit(1e3);if(g)throw g;const v=(new Date).toISOString().split("T")[0],b=((y||[]).filter(e=>e.request_date?.startsWith(v)),(y||[]).map(e=>{const r=e.purchase_request_items?.[0]||{},s=o.find(r=>r.id===e.requester_id),a=m.find(r=>r.id===e.vendor_id);return{id:Number(e.id),purchase_order_number:e.purchase_order_number,request_date:e.request_date,delivery_request_date:e.delivery_request_date??null,revised_delivery_request_date:e.revised_delivery_request_date??null,progress_type:e.progress_type,payment_completed_at:e.payment_completed_at,payment_completed_by_name:e.payment_completed_by_name,payment_category:e.payment_category,currency:e.currency,request_type:e.request_type,vendor:void 0,vendor_name:e.vendor_name||"",vendor_payment_schedule:a?.vendor_payment_schedule||"",vendor_contacts:[],requester_id:e.requester_id,requester_name:e.requester_name,requester_full_name:s?.full_name||s?.name||e.requester_name||"",item_name:r.item_name||"",specification:r.specification||"",quantity:Number(r.quantity)||0,unit_price_value:Number(r.unit_price_value)||0,amount_value:Number(r.amount_value)||0,remark:r.remark||"",project_vendor:e.project_vendor,sales_order_number:e.sales_order_number,project_item:e.project_item,line_number:Number(r.line_number)||1,contact_name:"",middle_manager_status:e.middle_manager_status,final_manager_status:e.final_manager_status,is_received:!!e.is_received,received_at:e.received_at,is_payment_completed:!!e.is_payment_completed,is_po_download:!!e.is_po_download,link:r.link,items:(e.purchase_request_items||[]).sort((e,r)=>(e.line_number||0)-(r.line_number||0)),total_amount:e.purchase_request_items?.reduce((e,r)=>e+(Number(r.amount_value)||0),0)||0,purchase_status:e.purchase_status||"pending"}}));t(b),_.purchases=b,_.lastFetch=r}catch(u){s.error("발주 목록 로드 실패",u),c.error("발주 목록을 불러올 수 없습니다.")}finally{a&&d(!1)}},[i]),N=e.useCallback((e,r)=>{t(s=>{const a=s.map(s=>s.id===e?r(s):s);return _.purchases=a,a})},[]);return e.useEffect(()=>{S()},[S]),{purchases:a,vendors:n,employees:i,loading:o,currentUserRoles:m,currentUserName:f,currentUserEmail:g,currentUserId:b,refreshPurchases:S,updatePurchaseOptimistic:N}})(),F=A?.includes("app_admin"),{activeTab:L,setActiveTab:H,filteredPurchases:$,tabCounts:z}=((s,a,t)=>{r();const[n,l]=e.useState("pending"),[i,c]=e.useState(""),u=a?.includes("app_admin");a?.includes("final_approver"),a?.includes("middle_manager");const o=a?.includes("purchase_manager"),d=a?.includes("raw_material_manager")||a?.includes("consumable_manager")||a?.includes("purchase_manager"),m=a?.includes("hr"),p=e.useMemo(()=>a&&0!==a.length?o?2:a.some(e=>["middle_manager","final_approver","app_admin","ceo"].includes(e))?3:1:1,[a,o]),_=e.useCallback(e=>{if(!t)return"all";if("purchase"===e)return d||m||u?"all":t;if("receipt"===e)return d||m||u?"all":t;switch(p){case 1:case 2:return"done"===e?"all":t;case 3:return"all";default:return t}},[t,p,d,m,u]);e.useEffect(()=>{if(!t)return;const e=_(n);c(e)},[n,t,p,_]);const h=e.useMemo(()=>a.includes("purchase_manager")||a.includes("app_admin")?s:s.filter(e=>!f.includes(e.requester_name)),[s,a]),y=e.useMemo(()=>((new Date).toISOString().split("T")[0],h.filter(e=>{let r=!1;switch(n){case"pending":const s=["pending","대기","",null,void 0].includes(e.middle_manager_status),a=["pending","대기","",null,void 0].includes(e.final_manager_status),t="rejected"===e.middle_manager_status,n="rejected"===e.final_manager_status;if(t||n)return!1;const l="approved"===e.middle_manager_status,i="approved"===e.final_manager_status;return(!l||!i)&&(r=s||a,r);case"purchase":{const s="구매 요청"===e.payment_category,a=(e.progress_type||"").includes("선진행"),t=(e.progress_type||"").includes("일반"),n="approved"===e.final_manager_status;return!e.is_payment_completed&&(r=!!s&&(a||t&&n),r)}case"receipt":{const s=(e.progress_type||"").includes("선진행"),a="approved"===e.final_manager_status;return!e.is_received&&(r=s||a,r)}case"done":return r=!0,r;default:return!0}})),[h,n]),g=e.useMemo(()=>{let e;return e=i&&"all"!==i&&"전체"!==i?y.filter(e=>e.requester_name===i):y,e},[y,i]),v=e.useMemo(()=>[...g].sort((e,r)=>{const s=e.request_date?new Date(e.request_date).getTime():0;return(r.request_date?new Date(r.request_date).getTime():0)-s}),[g]),b=e.useMemo(()=>{const e=h,r=e=>new Set(e.map(e=>e.purchase_order_number)).size,s=r=>{if("purchase"===r)return d||m||u?e:e.filter(e=>e.requester_name===t);if("receipt"===r)return d||m||u?e:e.filter(e=>e.requester_name===t);const s=_(r);return"all"===s||"전체"===s?e:e.filter(e=>e.requester_name===s)},a=s("pending"),n=s("purchase"),l=s("receipt"),i=s("done"),c=a.filter(e=>{(new Date).toISOString().split("T")[0];const r=["pending","대기","",null,void 0].includes(e.middle_manager_status),s=["pending","대기","",null,void 0].includes(e.final_manager_status),a="rejected"===e.middle_manager_status,t="rejected"===e.final_manager_status;if(a||t)return!1;const n="approved"===e.middle_manager_status,l="approved"===e.final_manager_status;return(!n||!l)&&(r||s)}),o=n.filter(e=>{(new Date).toISOString().split("T")[0];const r="구매 요청"===e.payment_category,s=(e.progress_type||"").includes("선진행"),a=(e.progress_type||"").includes("일반"),t="approved"===e.final_manager_status;return!e.is_payment_completed&&!!r&&(s||a&&t)}),p=l.filter(e=>{(new Date).toISOString().split("T")[0];const r=(e.progress_type||"").includes("선진행"),s="approved"===e.final_manager_status;return!e.is_received&&(r||s)});return{pending:r(c),purchase:r(o),receipt:r(p),done:r(i)}},[h,p,t,_,d,m,u]);return{activeTab:n,selectedEmployee:i,setActiveTab:l,setSelectedEmployee:c,filteredPurchases:v,tabCounts:b}})(E,A,D);e.useEffect(()=>{"purchase"===new URLSearchParams(b.search).get("tab")&&H("purchase")},[b.search,H]),e.useCallback(e=>e.is_received?a.jsx(u,{variant:null,className:"badge-success",children:"입고완료"}):"approved"===e.middle_manager_status&&"approved"===e.final_manager_status?a.jsx(u,{variant:null,className:"badge-primary",children:"구매진행"}):"rejected"===e.middle_manager_status||"rejected"===e.final_manager_status?a.jsx(u,{variant:null,className:"badge-danger",children:"반려"}):a.jsx(u,{variant:null,className:"badge-warning",children:"승인대기"}),[]);const B=e.useCallback(async e=>{try{const r=(new Date).toISOString(),[s,a]=await Promise.all([S.from("purchase_requests").update({is_received:!0,received_at:r}).eq("id",e),S.from("purchase_request_items").update({is_received:!0,delivery_status:"received"}).eq("purchase_request_id",e)]);if(s.error)throw s.error;if(a.error)throw a.error;c.success("입고완료 처리되었습니다."),await M()}catch(r){c.error("처리 중 오류가 발생했습니다.")}},[S,M]),W=e.useCallback(async e=>{try{const r=(new Date).toISOString(),[s,a]=await Promise.all([S.from("purchase_requests").update({is_payment_completed:!0,payment_completed_at:r}).eq("id",e),S.from("purchase_request_items").update({is_payment_completed:!0}).eq("purchase_request_id",e)]);if(s.error)throw s.error;if(a.error)throw a.error;c.success("구매완료 처리되었습니다."),await M()}catch(r){c.error("처리 중 오류가 발생했습니다.")}},[S,M]);e.useCallback(e=>{(async(e,r)=>{w.measureAsync(`modal-load-${e}`,async()=>{const e=r();e instanceof Promise&&await e},`Modal load: ${e}`)})("PurchaseItems",()=>{O(e),P(!0)})},[]);const V=e.useMemo(()=>C?{...C,vendor_name:C.vendor_name||"",project_vendor:C.project_vendor||"",sales_order_number:C.sales_order_number||"",project_item:C.project_item||""}:null,[C]);return a.jsxs("div",{className:"w-full",children:[a.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"page-title",children:"발주요청 관리"}),a.jsx("p",{className:"page-subtitle",style:{marginTop:"-2px",marginBottom:"-4px"},children:"Purchase Management"})]}),a.jsxs(i,{onClick:()=>g("/purchase/new"),className:"mt-4 sm:mt-0 bg-hansl-500 hover:bg-hansl-600",children:[a.jsx(m,{className:"w-4 h-4 mr-2"}),"새 발주요청 작성"]})]}),a.jsxs("div",{className:"space-y-3",children:[a.jsx("div",{className:"flex flex-col sm:flex-row sm:space-x-1 space-y-1 sm:space-y-0 bg-gray-50 p-1 business-radius-card border border-gray-200",children:j.map(e=>a.jsxs("button",{onClick:()=>(async(e,r)=>w.measureAsync(`tab-switch-${e}`,async()=>{const e=r();e instanceof Promise&&await e},`Tab switch to ${e}`))(e.key,()=>{H(e.key),M(!1,{silent:!0})}),className:"flex-1 flex items-center justify-center space-x-2 py-1.5 px-3 sm:px-4 business-radius-button button-text font-medium transition-colors "+(L===e.key?"text-hansl-600 bg-white shadow-sm border border-gray-200":"text-gray-600 bg-transparent hover:text-gray-900 hover:bg-white/50"),children:[a.jsx("span",{className:"whitespace-nowrap",children:e.label}),a.jsx(u,{variant:"secondary",className:L===e.key?"badge-stats-active":"badge-stats-secondary",children:z[e.key]})]},e.key))}),a.jsx(o,{className:"overflow-hidden border border-gray-200",children:a.jsx(d,{className:"p-0",children:R?a.jsxs("div",{className:"flex items-center justify-center py-12",children:[a.jsx("div",{className:"w-8 h-8 border-2 border-hansl-500 border-t-transparent rounded-full animate-spin"}),a.jsx("span",{className:"ml-3 card-subtitle",children:"로딩 중..."})]}):0===$.length?a.jsxs("div",{className:"text-center py-12",children:[a.jsx(p,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),a.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"발주요청서가 없습니다"}),a.jsx("p",{className:"card-subtitle",children:"새로운 발주요청서를 작성해보세요."})]}):a.jsx(v,{purchases:$,activeTab:L,currentUserRoles:A,onRefresh:M,onOptimisticUpdate:U,onPaymentComplete:W,onReceiptComplete:B})})})]}),V&&a.jsx(e.Suspense,{fallback:a.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white"})}),children:a.jsx(x,{isOpen:I,onClose:()=>{P(!1),O(null)},purchase:V,isAdmin:F||!1,onUpdate:M,activeTab:L})})]})}export{S as default};
//# sourceMappingURL=PurchaseListMain-Cz537uJM.js.map
