import{r as e,a,l as t,j as s,B as i,X as r}from"./index-B4P5lBGn.js";import{D as n,a as l,b as c,c as m}from"./dialog-BD1q0cHG.js";import{a as o,b as d,c as u,d as x,e as h}from"./table-D-p_BDz3.js";import{I as p}from"./input-DhMfgfHz.js";import{t as g}from"./index-BeXSRcJw.js";import{u as _,D as b}from"./useConfirmDateAction-DHVRbpzJ.js";import{P as j}from"./pen-DbAo9ECd.js";import{P as v}from"./plus-DjEdFcvb.js";import{S as f}from"./save-a-Siv81l.js";import{T as w}from"./trash-2-DGHuUO3W.js";import{f as N}from"./calendar-Cgba2l4j.js";import"./popover-B16aSPPO.js";import"./chevron-right-DEFzQSa7.js";import"./chevron-down-BImc6y-q.js";function y({isOpen:y,onClose:q,purchase:C,isAdmin:k,onUpdate:T,activeTab:D="done"}){const[S,M]=e.useState(C.items||[]),[z,I]=e.useState(!1),[A,U]=e.useState(""),E=a();e.useEffect(()=>{y&&(async()=>{try{const{data:{user:e}}=await E.auth.getUser();if(e?.email){const{data:a}=await E.from("employees").select("name").eq("email",e.email).single();U(a?.name?a.name:e.email)}if(C.id){const{data:e}=await E.from("purchase_request_items").select("*").eq("purchase_request_id",C.id).order("line_number");e&&M(e)}}catch(e){t.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨",e),U("ì‚¬ìš©ì")}})()},[y,E,C.id]);const P=C?.requester_name===A,B=k||P;t.debug("ğŸ” PurchaseItemsModal ê¶Œí•œ ì²´í¬ ì •ë³´",{currentUserName:A,isAdmin:k,isRequester:P,canReceiptCheck:B,purchaseRequesterName:C?.requester_name,activeTab:D});const L=e.useCallback(async()=>{if(C.id)try{const{data:e}=await E.from("purchase_request_items").select("*").eq("purchase_request_id",C.id).order("line_number");e&&(M(e),t.debug("ëª¨ë‹¬ ì•„ì´í…œ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ - ëª¨ë‹¬ ìƒíƒœ ìœ ì§€"))}catch(e){t.error("ëª¨ë‹¬ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨",e)}},[C.id,E]),F=_({config:{field:"statement_received",confirmMessage:{confirm:"ê±°ë˜ëª…ì„¸ì„œ í™•ì¸ì„ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",cancel:"ê±°ë˜ëª…ì„¸ì„œ í™•ì¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"},successMessage:{confirm:"ê±°ë˜ëª…ì„¸ì„œ í™•ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",cancel:"ê±°ë˜ëª…ì„¸ì„œ í™•ì¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."},completedText:"âœ“ ì™„ë£Œ",waitingText:"ëŒ€ê¸°"},currentUserName:A,canPerformAction:B,onUpdate:L}),H=_({config:{field:"actual_received",confirmMessage:{confirm:"ì‹¤ì œ ì…ê³  ì²˜ë¦¬ë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",cancel:"ì‹¤ì œ ì…ê³  ì²˜ë¦¬ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"},successMessage:{confirm:"ì‹¤ì œ ì…ê³  ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",cancel:"ì‹¤ì œ ì…ê³  ì²˜ë¦¬ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."},completedText:"ì…ê³ ì™„ë£Œ",waitingText:"ì…ê³ ëŒ€ê¸°"},currentUserName:A,canPerformAction:B,onUpdate:L}),R=(e,a,t)=>{const s=[...S];if(s[e]={...s[e],[a]:"quantity"===a||"unit_price_value"===a||"amount_value"===a?Number(t):t},"quantity"===a||"unit_price_value"===a){const a=s[e].quantity||0,t=s[e].unit_price_value||0;s[e].amount_value=t>0?a*t:0}M(s)},$=S,O=$.reduce((e,a)=>e+(a.amount_value||0),0);return s.jsx(n,{open:y,onOpenChange:q,children:s.jsxs(l,{className:"w-full max-w-[98vw] max-h-[95vh] overflow-hidden flex flex-col bg-white p-3 sm:p-6",maxWidth:"max-w-none",showCloseButton:!1,children:[s.jsx(c,{className:"flex-shrink-0",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs(m,{className:"modal-title",children:["ë°œì£¼ ìƒì„¸ í•­ëª© - ",C.purchase_order_number]}),s.jsxs("div",{className:"flex items-center gap-2",children:[k&&!z&&s.jsxs(i,{variant:"outline",size:"sm",onClick:()=>{I(!0),M([...C.items||[]])},children:[s.jsx(j,{className:"h-4 w-4 mr-1"}),"í¸ì§‘"]}),z&&s.jsxs(s.Fragment,{children:[s.jsxs(i,{variant:"outline",size:"sm",onClick:()=>{const e={line_number:S.reduce((e,a)=>{const t=a.line_number||0;return t>e?t:e},0)+1,item_name:"",specification:"",quantity:1,unit_price_value:void 0,amount_value:0,remark:"",is_received:!1},a=[...S,e].sort((e,a)=>(e.line_number||999999)-(a.line_number||999999));M(a)},children:[s.jsx(v,{className:"h-4 w-4 mr-1"}),"í’ˆëª© ì¶”ê°€"]}),s.jsxs(i,{variant:"default",size:"sm",onClick:async()=>{try{t.debug("í’ˆëª© ì €ì¥ ì‹œì‘",{editingItems:S.length,purchaseId:C.id});if(S.filter(e=>!e.item_name||!e.item_name.trim()).length>0)return void g.error("í’ˆëª©ëª…ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.");const{error:e}=await E.from("purchase_request_items").delete().eq("purchase_request_id",C.id);if(e)throw t.error("ê¸°ì¡´ í’ˆëª© ì‚­ì œ ì‹¤íŒ¨",e),e;const a=S.map(e=>({purchase_request_id:C.id,purchase_order_number:C.purchase_order_number,line_number:e.line_number,item_name:e.item_name.trim(),specification:e.specification||"",quantity:Number(e.quantity)||0,unit_price_value:null!==e.unit_price_value&&void 0!==e.unit_price_value&&""!==e.unit_price_value?Number(e.unit_price_value):null,amount_value:Number(e.amount_value)||0,remark:e.remark||"",link:e.link||null,is_received:e.is_received||!1,delivery_status:e.delivery_status||"pending"}));t.debug("í’ˆëª© ì‚½ì… ë°ì´í„°",{itemsToInsert:a});const{error:s}=await E.from("purchase_request_items").insert(a);if(s)throw t.error("í’ˆëª© ì‚½ì… ì‹¤íŒ¨",s),s;const i=S.reduce((e,a)=>e+(Number(a.amount_value)||0),0),{error:r}=await E.from("purchase_requests").update({total_amount:i}).eq("id",C.id);if(r)throw t.error("ì´ê¸ˆì•¡ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",r),r;t.debug("í’ˆëª© ì €ì¥ ì™„ë£Œ"),g.success("í’ˆëª©ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."),I(!1),T(),q()}catch(e){t.error("í’ˆëª© ì €ì¥ ì¤‘ ì˜¤ë¥˜",e),g.error(`ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${e instanceof Error?e.message:e}`)}},children:[s.jsx(f,{className:"h-4 w-4 mr-1"}),"ì €ì¥"]}),s.jsx(i,{variant:"ghost",size:"sm",onClick:()=>{I(!1),M(C.items||[])},children:"ì·¨ì†Œ"})]}),s.jsx(i,{variant:"ghost",size:"icon",onClick:q,className:"h-6 w-6",children:s.jsx(r,{className:"h-4 w-4"})})]})]})}),s.jsxs("div",{className:"flex-shrink-0 grid grid-cols-2 md:grid-cols-4 gap-3 py-3 border-b",children:[s.jsxs("div",{children:[s.jsx("p",{className:"modal-label",children:"ì—…ì²´ëª…"}),s.jsx("p",{className:"modal-value",children:C.vendor_name})]}),s.jsxs("div",{children:[s.jsx("p",{className:"modal-label",children:"ìš”ì²­ì"}),s.jsx("p",{className:"modal-value",children:C.requester_name})]}),s.jsxs("div",{children:[s.jsx("p",{className:"modal-label",children:"í”„ë¡œì íŠ¸"}),s.jsx("p",{className:"modal-value truncate",title:C.project_vendor,children:C.project_vendor})]}),s.jsxs("div",{children:[s.jsx("p",{className:"modal-label",children:"ë‚©ê¸°ì¼"}),s.jsx("p",{className:"modal-value",children:C.delivery_request_date&&N(new Date(C.delivery_request_date),"yyyy-MM-dd")})]})]}),s.jsx("div",{className:"flex-1 overflow-hidden",children:s.jsx("div",{className:"w-full h-full overflow-auto",style:{maxHeight:"60vh"},children:s.jsxs("table",{className:"w-full min-w-[1400px] caption-bottom text-[13px] leading-[1.6] border-collapse",children:[s.jsx(o,{className:"sticky top-0 bg-white z-10 shadow-sm",children:s.jsxs(d,{children:[s.jsx(u,{className:"w-16 min-w-[64px]",children:"No."}),s.jsx(u,{className:"min-w-[120px]",children:"í’ˆëª©"}),s.jsx(u,{className:"min-w-[100px]",children:"ê·œê²©"}),s.jsx(u,{className:"text-right min-w-[80px]",children:"ìˆ˜ëŸ‰"}),s.jsx(u,{className:"text-right min-w-[100px]",children:"ë‹¨ê°€"}),s.jsx(u,{className:"text-right min-w-[120px]",children:"ê¸ˆì•¡"}),"purchase"===D&&s.jsx(u,{className:"min-w-[100px]",children:"êµ¬ë§¤ìƒíƒœ"}),("receipt"===D||"done"===D)&&s.jsx(u,{className:"min-w-[100px]",children:"ì…ê³ ìƒíƒœ"}),"done"===D&&s.jsxs(s.Fragment,{children:[s.jsx(u,{className:"text-center min-w-[120px]",children:"ê±°ë˜ëª…ì„¸ì„œ í™•ì¸"}),s.jsx(u,{className:"text-center min-w-[120px]",children:"íšŒê³„ìƒ ì…ê³ ì¼"}),s.jsx(u,{className:"text-center min-w-[80px]",children:"ì²˜ë¦¬ì"})]}),"receipt"===D&&s.jsx(u,{className:"text-center min-w-[120px]",children:"ì‹¤ì œ ì…ê³ ì¼"}),s.jsx(u,{className:"min-w-[100px]",children:"ë¹„ê³ "}),z&&s.jsx(u,{className:"w-20 min-w-[80px]",children:"ì‚­ì œ"})]})}),s.jsx(x,{children:(z?S:$).map((e,a)=>s.jsxs(d,{children:[s.jsx(h,{className:"text-center modal-value",children:e.line_number||a+1}),s.jsx(h,{className:"min-w-[120px]",children:z?s.jsx(p,{value:e.item_name,onChange:e=>R(a,"item_name",e.target.value),className:"h-7 modal-label w-full"}):s.jsx("div",{className:"max-w-[200px]",children:s.jsx("p",{className:"modal-value truncate",title:e.item_name,children:e.item_name})})}),s.jsx(h,{className:"min-w-[100px]",children:z?s.jsx(p,{value:e.specification,onChange:e=>R(a,"specification",e.target.value),className:"h-7 modal-label w-full"}):s.jsx("div",{className:"max-w-[150px] truncate",title:e.specification,children:e.specification})}),s.jsx(h,{className:"text-right min-w-[80px]",children:z?s.jsx(p,{type:"number",value:e.quantity,onChange:e=>R(a,"quantity",e.target.value),className:"h-7 text-xs text-right w-full"}):s.jsx("div",{className:"text-right",children:s.jsx("span",{className:"modal-value",style:{display:"block",textAlign:"right"},children:e.quantity.toLocaleString()})})}),s.jsx(h,{className:"text-right min-w-[100px]",children:z?s.jsx(p,{type:"number",value:e.unit_price_value,onChange:e=>R(a,"unit_price_value",e.target.value),className:"h-7 text-xs text-right w-full"}):s.jsx("div",{className:"text-right",children:s.jsxs("span",{className:"modal-subtitle",style:{display:"block",textAlign:"right"},children:[(e.unit_price_value||0).toLocaleString()," ",C.currency]})})}),s.jsx(h,{className:"text-right min-w-[120px]",children:z?s.jsx(p,{type:"number",value:e.amount_value,onChange:e=>R(a,"amount_value",e.target.value),className:"h-7 modal-label text-right w-full"}):s.jsx("div",{className:"text-right",children:s.jsxs("span",{className:"modal-value",style:{display:"block",textAlign:"right"},children:[(e.amount_value||0).toLocaleString()," ",C.currency]})})}),"purchase"===D&&s.jsx(h,{className:"min-w-[100px]",children:B?e.is_payment_completed?s.jsx("button",{onClick:async()=>{try{if(t.debug("êµ¬ë§¤ì·¨ì†Œ ë²„íŠ¼ í´ë¦­",{itemId:e.id,itemName:e.item_name,currentStatus:e.is_payment_completed}),!e.id)throw new Error("í’ˆëª© IDê°€ ì—†ìŠµë‹ˆë‹¤.");const{error:a,data:s}=await E.from("purchase_request_items").update({is_payment_completed:!1}).eq("id",e.id).select();if(a)throw t.error("êµ¬ë§¤ì·¨ì†Œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",a),a;t.debug("êµ¬ë§¤ì·¨ì†Œ ì—…ë°ì´íŠ¸ ì„±ê³µ",{data:s}),g.success("êµ¬ë§¤ ì·¨ì†Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."),await L()}catch(a){t.error("êµ¬ë§¤ì·¨ì†Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜",a),g.error(`ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${a instanceof Error?a.message:a}`)}},className:"button-base bg-green-500 hover:bg-green-600 text-white transition-colors",title:"í´ë¦­í•˜ì—¬ êµ¬ë§¤ ì·¨ì†Œ",children:"êµ¬ë§¤ì™„ë£Œ"}):s.jsx("button",{onClick:async()=>{try{if(t.debug("êµ¬ë§¤ì™„ë£Œ ë²„íŠ¼ í´ë¦­",{itemId:e.id,itemName:e.item_name,currentStatus:e.is_payment_completed}),!e.id)throw new Error("í’ˆëª© IDê°€ ì—†ìŠµë‹ˆë‹¤.");const{error:a,data:s}=await E.from("purchase_request_items").update({is_payment_completed:!0}).eq("id",e.id).select();if(a)throw t.error("êµ¬ë§¤ì™„ë£Œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",a),a;t.debug("êµ¬ë§¤ì™„ë£Œ ì—…ë°ì´íŠ¸ ì„±ê³µ",{data:s}),g.success("êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."),await L()}catch(a){t.error("êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜",a),g.error(`ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${a instanceof Error?a.message:a}`)}},className:"button-base border border-gray-300 text-gray-600 bg-white hover:bg-gray-50",children:"êµ¬ë§¤ëŒ€ê¸°"}):s.jsx("span",{className:"button-base "+(e.is_payment_completed?"bg-green-500 text-white":"border border-gray-300 text-gray-400 bg-white"),children:e.is_payment_completed?"êµ¬ë§¤ì™„ë£Œ":"êµ¬ë§¤ëŒ€ê¸°"})}),("receipt"===D||"done"===D)&&s.jsx(h,{className:"min-w-[100px]",children:"receipt"===D?B?H.isCompleted(e)?s.jsx("button",{onClick:()=>{H.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-base bg-green-500 hover:bg-green-600 text-white transition-colors",title:"í´ë¦­í•˜ì—¬ ì‹¤ì œ ì…ê³  ì²˜ë¦¬ ì·¨ì†Œ",children:H.config.completedText}):s.jsx(b,{onDateSelect:a=>{H.handleConfirm(e.id,a,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"ì‹¤ì œ ì…ê³  ë‚ ì§œ ì„ íƒ",children:s.jsx(i,{variant:"outline",size:"sm",className:"button-base border border-gray-300 text-gray-600 bg-white hover:bg-gray-50",children:H.config.waitingText})}):s.jsx("span",{className:"button-base "+(H.isCompleted(e)?"bg-green-500 text-white":"border border-gray-300 text-gray-400 bg-white"),children:H.isCompleted(e)?H.config.completedText:H.config.waitingText}):s.jsx("span",{className:"button-base "+(H.isCompleted(e)?"bg-green-500 text-white":"border border-gray-300 text-gray-600 bg-white"),children:H.isCompleted(e)?H.config.completedText:H.config.waitingText})}),"receipt"===D&&s.jsx(h,{className:"text-center min-w-[120px]",children:H.getCompletedDate(e)?s.jsx("span",{className:"modal-subtitle text-green-600",children:N(new Date(H.getCompletedDate(e)),"yyyy-MM-dd HH:mm")}):s.jsx("span",{className:"modal-subtitle",children:"-"})}),"done"===D&&s.jsxs(s.Fragment,{children:[s.jsx(h,{className:"text-center min-w-[120px]",children:B?F.isCompleted(e)?s.jsx("button",{onClick:()=>{F.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-base bg-green-500 hover:bg-green-600 text-white transition-colors",title:"í´ë¦­í•˜ì—¬ ê±°ë˜ëª…ì„¸ì„œ í™•ì¸ ì·¨ì†Œ",children:F.config.completedText}):s.jsx(b,{onDateSelect:a=>{F.handleConfirm(e.id,a,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"ë‚ ì§œ ì„ íƒ",children:s.jsx(i,{variant:"outline",size:"sm",className:"button-base border border-gray-300 text-gray-600 bg-white hover:bg-gray-50",children:F.config.waitingText})}):s.jsx("span",{className:"button-base "+(F.isCompleted(e)?"bg-green-500 text-white":"border border-gray-300 text-gray-400 bg-white"),children:F.isCompleted(e)?F.config.completedText:F.config.waitingText})}),s.jsx(h,{className:"text-center min-w-[120px]",children:F.getCompletedDate(e)?s.jsx("span",{className:"modal-subtitle",children:N(new Date(F.getCompletedDate(e)),"yyyy-MM-dd")}):s.jsx("span",{className:"modal-subtitle",children:"-"})}),s.jsx(h,{className:"text-center min-w-[80px]",children:F.getCompletedByName(e)?s.jsx("span",{className:"modal-subtitle",children:F.getCompletedByName(e)}):s.jsx("span",{className:"modal-subtitle",children:"-"})})]}),s.jsx(h,{className:"min-w-[100px]",children:z?s.jsx(p,{value:e.remark||"",onChange:e=>R(a,"remark",e.target.value),className:"h-7 modal-label w-full",placeholder:"ë¹„ê³ "}):s.jsx("div",{className:"max-w-[150px]",children:s.jsx("span",{className:"modal-subtitle truncate block",title:e.remark,children:e.remark||"-"})})}),z&&s.jsx(h,{className:"min-w-[80px]",children:s.jsx(i,{variant:"ghost",size:"icon",onClick:()=>(e=>{const a=S.filter((a,t)=>t!==e).sort((e,a)=>(e.line_number||999999)-(a.line_number||999999));M(a)})(a),className:"h-7 w-7 text-red-500 hover:text-red-700",children:s.jsx(w,{className:"h-4 w-4"})})})]},e.id||a))})]})})}),s.jsxs("div",{className:"flex-shrink-0 border-t pt-4 flex justify-between items-center",children:[s.jsxs("div",{className:"modal-subtitle",children:["ì´ ",$.length,"ê°œ í’ˆëª©"]}),s.jsxs("div",{className:"modal-value-large",children:["ì´ ê¸ˆì•¡: ",O.toLocaleString()," ",C.currency]})]})]})})}export{y as default};
//# sourceMappingURL=PurchaseItemsModal-C638zpN8.js.map
