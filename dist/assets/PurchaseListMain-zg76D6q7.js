const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/FastPurchaseTable-dwuwCenc.js","assets/index-BQwRJ39C.js","assets/index-z9INqFZg.css","assets/index-Dnyy7QE1.js","assets/PurchaseDetailModal-lk6lNshx.js","assets/helpers-C_CnFjYT.js","assets/input-C-GHgBpt.js","assets/format-CxKLXZZI.js","assets/chevron-left-BkZ2VskV.js","assets/eye-DC2WMEgk.js","assets/chevron-down-DJW8wVpf.js","assets/popover-CW-7Farr.js","assets/calendar-BNgXXIKE.js","assets/package-Dq3CxM12.js","assets/credit-card-B_5X_TF8.js","assets/trash-2-DaRRNvbx.js","assets/plus-DhbjqVV0.js","assets/save-pBILeM8t.js","assets/PurchaseItemsModal-irmMsOGW.js","assets/table-9FaptC4l.js"])))=>i.map(i=>d[i]);
import{r as e,a as r,l as t,j as s,_ as a,u as n,e as i,B as l}from"./index-BQwRJ39C.js";import{t as c,B as u}from"./index-Dnyy7QE1.js";import{C as o,c as m}from"./card-3Cdpb4al.js";import{P as d}from"./plus-DhbjqVV0.js";import{P as p}from"./package-Dq3CxM12.js";const _={purchases:null,vendors:null,employees:null,lastFetch:0,userInfo:null,CACHE_DURATION:12e4};const h=["정희웅"],f=new Map,g=(t,s,a,n,i)=>{r();const[l,c]=e.useState("pending"),[u,o]=e.useState(""),[m,d]=e.useState(""),[p,_]=e.useState(""),[g,y]=e.useState(""),[v,b]=e.useState(""),[x,w]=e.useState(""),[j,N]=e.useState(""),[q,S]=e.useState(""),C=function(r,t=500){const[s,a]=e.useState(r);return e.useEffect(()=>{const e=setTimeout(()=>{a(r)},t);return()=>{clearTimeout(e)}},[r,t]),s}(u,300),k=s?.includes("app_admin");s?.includes("final_approver"),s?.includes("middle_manager");const T=s?.includes("purchase_manager"),F=s?.includes("raw_material_manager")||s?.includes("consumable_manager")||s?.includes("purchase_manager"),L=e.useMemo(()=>s&&0!==s.length?T?2:s.some(e=>["middle_manager","final_approver","app_admin","ceo"].includes(e))?3:1:1,[s,T]),R=e.useCallback(e=>{if(!a)return"all";if("purchase"===e)return F||k?"all":a;switch(L){case 1:case 2:return"done"===e?"all":a;case 3:return"all";default:return a}},[a,L,F,k]);e.useEffect(()=>{if(!a)return;const e=R(l);_(e)},[l,a,L,R]);const P=e.useMemo(()=>{try{const e=`visible_${t.length}_${s.join(",")}`;if(f.has(e))return f.get(e);let r;if(r=s.includes("purchase_manager")||s.includes("app_admin")?t:t.filter(e=>!h.includes(e.requester_name)),f.size>=100){const e=f.keys().next().value;f.delete(e)}return f.set(e,r),r}catch(e){return f.clear(),s.includes("purchase_manager")||s.includes("app_admin")?t:t.filter(e=>!h.includes(e.requester_name))}},[t,s]),A=e.useMemo(()=>{const e=`tab_${P.length}_${l}`;if(f.has(e))return f.get(e);const r=P.filter(e=>{let r=!1;switch(l){case"pending":const t=["pending","대기","",null,void 0].includes(e.middle_manager_status),s=["pending","대기","",null,void 0].includes(e.final_manager_status),a="rejected"===e.middle_manager_status,n="rejected"===e.final_manager_status;return!a&&!n&&(r=t||s,r);case"purchase":{const t="구매 요청"===e.payment_category,s=!e.is_payment_completed,a=(e.progress_type||"").includes("선진행"),n=(e.progress_type||"").includes("일반"),i="approved"===e.final_manager_status;return r=!(!t||!s)&&(a||n&&i),r}case"receipt":{const t=!e.is_received,s=(e.progress_type||"").includes("선진행"),a="approved"===e.final_manager_status;return r=t&&(s||a),r}case"done":return r=!0,r;default:return!0}});if(f.size>=100){const e=f.keys().next().value;f.delete(e)}return f.set(e,r),r},[P,l]),E=e.useMemo(()=>{const e=`employee_${A.length}_${p}`;if(f.has(e))return f.get(e);let r;if(r=p&&"all"!==p&&"전체"!==p?A.filter(e=>e.requester_name===p):A,f.size>=100){const e=f.keys().next().value;f.delete(e)}return f.set(e,r),r},[A,p]),I=e.useMemo(()=>m?E.filter(e=>e.vendor_name===m):E,[E,m]),U=e.useMemo(()=>{let e=I;if(g){const r=g.trim().toLowerCase();e=e.filter(e=>e.purchase_order_number?.toLowerCase().includes(r))}if(v){const r=v.trim().toLowerCase();e=e.filter(e=>!!(e.items&&e.items.length>0)&&e.items.some(e=>e.item_name?.toLowerCase().includes(r)))}if(x){const r=x.trim().toLowerCase();e=e.filter(e=>!!(e.items&&e.items.length>0)&&e.items.some(e=>e.specification?.toLowerCase().includes(r)))}if(j&&"all"!==j&&(e=e.filter(e=>{switch(j){case"pending":return!e.final_manager_status||"pending"===e.final_manager_status||"대기"===e.final_manager_status;case"approved":return"approved"===e.final_manager_status;case"rejected":return"rejected"===e.final_manager_status||"rejected"===e.middle_manager_status;default:return!0}})),q){const r=q.trim().toLowerCase();e=e.filter(e=>!!(e.items&&e.items.length>0)&&e.items.some(e=>e.remark?.toLowerCase().includes(r)))}return e},[I,g,v,x,j,q]),D=e.useMemo(()=>{if(!C)return U;const e=C.trim().toLowerCase();return U.filter(r=>!!(r.purchase_order_number?.toLowerCase().includes(e)||r.vendor_name?.toLowerCase().includes(e)||r.requester_name?.toLowerCase().includes(e)||r.project_vendor?.toLowerCase().includes(e))||!!(r.items&&r.items.length>0)&&r.items.some(r=>r.item_name&&r.item_name.toLowerCase().includes(e)||r.specification&&r.specification.toLowerCase().includes(e)))},[U,C]),M=e.useMemo(()=>[...D].sort((e,r)=>{const t=e.request_date?new Date(e.request_date).getTime():0;return(r.request_date?new Date(r.request_date).getTime():0)-t}),[D,l]),O=e.useMemo(()=>{const e=P,r=e=>new Set(e.map(e=>e.purchase_order_number)).size,t=r=>{if("purchase"===r)return F||k?e:e.filter(e=>e.requester_name===a);const t=R(r);return"all"===t||"전체"===t?e:e.filter(e=>e.requester_name===t)},s=t("pending"),n=t("purchase"),i=t("receipt"),l=t("done"),c=s.filter(e=>{const r=["pending","대기","",null,void 0].includes(e.middle_manager_status),t=["pending","대기","",null,void 0].includes(e.final_manager_status),s="rejected"===e.middle_manager_status,a="rejected"===e.final_manager_status;return!s&&!a&&(r||t)}),u=n.filter(e=>{const r="구매 요청"===e.payment_category,t=!e.is_payment_completed;if(!r||!t)return!1;const s=(e.progress_type||"").includes("선진행"),a=(e.progress_type||"").includes("일반"),n="approved"===e.final_manager_status;return s||a&&n}),o=i.filter(e=>{const r=!e.is_received,t=(e.progress_type||"").includes("선진행"),s="approved"===e.final_manager_status;return r&&(t||s)});return{pending:r(c),purchase:r(u),receipt:r(o),done:r(l)}},[P,L,a,R,F,k]);return{activeTab:l,searchTerm:u,vendorFilter:m,selectedEmployee:p,purchaseNumberFilter:g,itemNameFilter:v,specificationFilter:x,approvalStatusFilter:j,remarkFilter:q,setActiveTab:c,setSearchTerm:o,setVendorFilter:d,setSelectedEmployee:_,setPurchaseNumberFilter:y,setItemNameFilter:b,setSpecificationFilter:w,setApprovalStatusFilter:N,setRemarkFilter:S,filteredPurchases:M,tabCounts:O}},y=e.lazy(()=>a(()=>import("./FastPurchaseTable-dwuwCenc.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17]))),v=e.memo(()=>s.jsx("div",{className:"p-4 space-y-4",children:[...Array(5)].map((e,r)=>s.jsxs("div",{className:"flex space-x-4 animate-pulse",children:[s.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4"}),s.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4"}),s.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4"}),s.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4"})]},r))}));v.displayName="TableSkeleton";const b=e.memo(({purchases:r,activeTab:t,currentUserRoles:a,onRefresh:n,onPaymentComplete:i,onReceiptComplete:l})=>s.jsx(e.Suspense,{fallback:s.jsx(v,{}),children:s.jsx(y,{purchases:r,activeTab:t,currentUserRoles:a,onRefresh:n,onPaymentComplete:i,onReceiptComplete:l})}));b.displayName="LazyPurchaseTable";const x=e.lazy(()=>a(()=>import("./PurchaseItemsModal-irmMsOGW.js"),__vite__mapDeps([18,1,2,6,19,3,7,16,17,15]))),w=[{key:"pending",label:"승인대기"},{key:"purchase",label:"구매 현황"},{key:"receipt",label:"입고 현황"},{key:"done",label:"전체 항목"}];function j({onEmailToggle:a,showEmailButton:h=!0}){const f=n(),y=i(),v=r(),[j,N]=e.useState(null),[q,S]=e.useState({}),[C,k]=e.useState(null),[T,F]=e.useState(!1),{purchases:L,loading:R,currentUserRoles:P,currentUserName:A,refreshPurchases:E}=(()=>{const[s,a]=e.useState([]),[n,i]=e.useState([]),[l,u]=e.useState([]),[o,m]=e.useState(!0),[d,p]=e.useState([]),[h,f]=e.useState(""),[g,y]=e.useState(""),[v,b]=e.useState(""),x=r(),w=e.useRef(!1);e.useEffect(()=>{(async()=>{if(w.current)return;w.current=!0;const e=Date.now(),r=_.lastFetch&&e-_.lastFetch<_.CACHE_DURATION;try{if(r&&_.vendors&&_.employees&&_.userInfo)try{i(_.vendors),u(_.employees);const e=_.userInfo;if(e){let r=[];e.purchase_role&&(r=Array.isArray(e.purchase_role)?e.purchase_role.map(e=>String(e).trim()):String(e.purchase_role).split(",").map(e=>e.trim()).filter(e=>e.length>0)),p(r),f(e.name||e.full_name||""),y(e.email||""),b(e.id||"")}return}catch(s){t.error("캐시 데이터 사용 중 오류",s),_.purchases=null,_.vendors=null,_.employees=null,_.userInfo=null,_.lastFetch=0}const[a,n,l]=await Promise.all([x.from("vendors").select("*"),x.from("employees").select("*"),x.auth.getUser()]);if(a.error)throw a.error;const c=a.data||[];if(i(c),_.vendors=c,n.error)throw n.error;const o=n.data||[];if(u(o),_.employees=o,l.data.user&&!l.error){let r=null;if(l.data.user.email&&(r=(await x.from("employees").select("*").eq("email",l.data.user.email).maybeSingle()).data),r){_.userInfo=r;let e=[];r.purchase_role&&(e=Array.isArray(r.purchase_role)?r.purchase_role.map(e=>String(e).trim()):String(r.purchase_role).split(",").map(e=>e.trim()).filter(e=>e.length>0)),p(e),f(r.name||r.full_name||""),y(r.email||""),b(r.id||"")}_.lastFetch=e}}catch(s){t.error("초기 데이터 로드 실패",s)}})()},[]);const j=e.useCallback(async e=>{m(!0);try{const s=Date.now(),n=_.lastFetch&&s-_.lastFetch<_.CACHE_DURATION;if(!e&&n&&_.purchases)try{return a(_.purchases),void m(!1)}catch(r){t.error("발주 데이터 캐시 사용 중 오류",r),_.purchases=null,_.lastFetch=0}let i=l;if(0===i.length&&(i=_.employees||[],0===i.length)){const{data:e}=await x.from("employees").select("*");i=e||[]}const{data:{user:u},error:o}=await x.auth.getUser();if(o||!u)return t.error("사용자 인증 실패",o),c.error("로그인이 필요합니다."),void m(!1);const{data:d,error:p}=await x.from("purchase_requests").select("\n          *,\n          purchase_request_items(*)\n        ").order("request_date",{ascending:!1}).limit(1e3);if(p)throw p;const h=(new Date).toISOString().split("T")[0],f=((d||[]).filter(e=>e.request_date?.startsWith(h)),(d||[]).map(e=>{const r=e.purchase_request_items?.[0]||{},t=i.find(r=>r.id===e.requester_id);return{id:Number(e.id),purchase_order_number:e.purchase_order_number,request_date:e.request_date,delivery_request_date:e.delivery_request_date,progress_type:e.progress_type,payment_completed_at:e.payment_completed_at,payment_category:e.payment_category,currency:e.currency,request_type:e.request_type,vendor:void 0,vendor_name:e.vendor_name||"",vendor_payment_schedule:"",vendor_contacts:[],requester_id:e.requester_id,requester_name:e.requester_name,requester_full_name:t?.full_name||t?.name||e.requester_name||"",item_name:r.item_name||"",specification:r.specification||"",quantity:Number(r.quantity)||0,unit_price_value:Number(r.unit_price_value)||0,amount_value:Number(r.amount_value)||0,remark:r.remark||"",project_vendor:e.project_vendor,sales_order_number:e.sales_order_number,project_item:e.project_item,line_number:Number(r.line_number)||1,contact_name:"",middle_manager_status:e.middle_manager_status,final_manager_status:e.final_manager_status,is_received:!!e.is_received,received_at:e.received_at,is_payment_completed:!!e.is_payment_completed,is_po_download:!!e.is_po_download,link:r.link,items:(e.purchase_request_items||[]).sort((e,r)=>(e.line_number||0)-(r.line_number||0)),total_amount:e.purchase_request_items?.reduce((e,r)=>e+(Number(r.amount_value)||0),0)||0,purchase_status:e.purchase_status||"pending"}}));a(f),_.purchases=f,_.lastFetch=s}catch(s){t.error("발주 목록 로드 실패",s),c.error("발주 목록을 불러올 수 없습니다.")}finally{m(!1)}},[l]);return e.useEffect(()=>{j()},[j]),{purchases:s,vendors:n,employees:l,loading:o,currentUserRoles:d,currentUserName:h,currentUserEmail:g,currentUserId:v,refreshPurchases:j}})(),I=P?.includes("app_admin"),{activeTab:U,setActiveTab:D,filteredPurchases:M,tabCounts:O}=g(L,P,A);e.useEffect(()=>{"purchase"===new URLSearchParams(y.search).get("tab")&&D("purchase")},[y.search,D]);return s.jsxs("div",{className:"w-full",children:[s.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"page-title",children:"발주요청 관리"}),s.jsx("p",{className:"page-subtitle",style:{marginTop:"-2px",marginBottom:"-4px"},children:"Purchase Management"})]}),s.jsxs(l,{onClick:()=>f("/purchase/new"),className:"mt-4 sm:mt-0 bg-hansl-500 hover:bg-hansl-600",children:[s.jsx(d,{className:"w-4 h-4 mr-2"}),"새 발주요청 작성"]})]}),s.jsxs("div",{className:"space-y-3",children:[s.jsx("div",{className:"flex flex-col sm:flex-row sm:space-x-1 space-y-1 sm:space-y-0 bg-gray-50 p-1 business-radius-card border border-gray-200",children:w.map(e=>s.jsxs("button",{onClick:()=>D(e.key),className:"flex-1 flex items-center justify-center space-x-2 py-2.5 px-3 sm:px-4 business-radius-button text-xs sm:text-sm font-medium transition-colors "+(U===e.key?"text-hansl-600 bg-white shadow-sm border border-gray-200":"text-gray-600 bg-transparent hover:text-gray-900 hover:bg-white/50"),children:[s.jsx("span",{className:"whitespace-nowrap",children:e.label}),s.jsx(u,{variant:"secondary",className:"text-[10px] sm:text-xs business-radius-badge "+(U===e.key?"bg-hansl-50 text-hansl-700":"bg-gray-100 text-gray-600"),children:O[e.key]})]},e.key))}),s.jsx(o,{className:"overflow-hidden border border-gray-200",children:s.jsx(m,{className:"p-0",children:R?s.jsxs("div",{className:"flex items-center justify-center py-12",children:[s.jsx("div",{className:"w-8 h-8 border-2 border-hansl-500 border-t-transparent rounded-full animate-spin"}),s.jsx("span",{className:"ml-3 text-gray-600",children:"로딩 중..."})]}):0===M.length?s.jsxs("div",{className:"text-center py-12",children:[s.jsx(p,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),s.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"발주요청서가 없습니다"}),s.jsx("p",{className:"text-gray-600",children:"새로운 발주요청서를 작성해보세요."})]}):s.jsx(b,{purchases:M,activeTab:U,currentUserRoles:P,onRefresh:E,onPaymentComplete:async e=>{try{const{error:r}=await v.from("purchase_requests").update({is_payment_completed:!0,payment_completed_at:(new Date).toISOString()}).eq("id",e);if(r)throw r;await v.from("purchase_request_items").update({is_payment_completed:!0}).eq("purchase_request_id",e),c.success("구매완료 처리되었습니다."),await E()}catch(r){c.error("처리 중 오류가 발생했습니다.")}},onReceiptComplete:async e=>{try{const{error:r}=await v.from("purchase_requests").update({is_received:!0,received_at:(new Date).toISOString()}).eq("id",e);if(r)throw r;await v.from("purchase_request_items").update({is_received:!0,delivery_status:"received"}).eq("purchase_request_id",e),c.success("입고완료 처리되었습니다."),await E()}catch(r){c.error("처리 중 오류가 발생했습니다.")}}})})})]}),C&&s.jsx(e.Suspense,{fallback:s.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white"})}),children:s.jsx(x,{isOpen:T,onClose:()=>{F(!1),k(null)},purchase:{...C,vendor_name:C.vendor_name||"",project_vendor:C.project_vendor||"",sales_order_number:C.sales_order_number||"",project_item:C.project_item||""},isAdmin:I||!1,onUpdate:E})})]})}export{j as default};
//# sourceMappingURL=PurchaseListMain-zg76D6q7.js.map
