import{r as e,a,l as t,j as s,B as r,X as i}from"./index-B5W_Rbic.js";import{D as n,a as l,b as c,c as m,I as o}from"./input-Jf-PHH8U.js";import{T as d,a as u,b as h,c as x,d as p,e as g}from"./table-l0POa7ix.js";import{t as _}from"./index-B0C9_qk1.js";import{u as j,D as b}from"./useConfirmDateAction-CwuKw1kH.js";import{P as v,f}from"./format-YcZ-PTGF.js";import{P as N}from"./plus-D9xxlVTf.js";import{S as y}from"./save-BRLSOWUh.js";import{T as w}from"./trash-2-BGqKwIOx.js";import"./chevron-right-BVg381Xs.js";import"./chevron-down-DWqmUTCH.js";import"./popover-CguIg9ls.js";function q({isOpen:q,onClose:C,purchase:k,isAdmin:T,onUpdate:D,activeTab:S="done"}){const[M,z]=e.useState(k.items||[]),[I,A]=e.useState(!1),[E,U]=e.useState(""),P=a();e.useEffect(()=>{q&&(async()=>{try{const{data:{user:e}}=await P.auth.getUser();if(e?.email){const{data:a}=await P.from("employees").select("name").eq("email",e.email).single();U(a?.name?a.name:e.email)}if(k.id){const{data:e}=await P.from("purchase_request_items").select("*").eq("purchase_request_id",k.id).order("line_number");e&&z(e)}}catch(e){t.error("Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®",e),U("ÏÇ¨Ïö©Ïûê")}})()},[q,P,k.id]);const L=k?.requester_name===E,B=T||L;t.debug("üîê PurchaseItemsModal Í∂åÌïú Ï≤¥ÌÅ¨ Ï†ïÎ≥¥",{currentUserName:E,isAdmin:T,isRequester:L,canReceiptCheck:B,purchaseRequesterName:k?.requester_name,activeTab:S});const F=e.useCallback(async()=>{if(k.id)try{const{data:e}=await P.from("purchase_request_items").select("*").eq("purchase_request_id",k.id).order("line_number");e&&(z(e),t.debug("Î™®Îã¨ ÏïÑÏù¥ÌÖú Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ® ÏôÑÎ£å - Î™®Îã¨ ÏÉÅÌÉú Ïú†ÏßÄ"))}catch(e){t.error("Î™®Îã¨ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ® Ïã§Ìå®",e)}},[k.id,P]),R=j({config:{field:"statement_received",confirmMessage:{confirm:"Í±∞ÎûòÎ™ÖÏÑ∏ÏÑú ÌôïÏù∏ÏùÑ Ï≤òÎ¶¨ÌïòÏãúÍ≤†ÏäµÎãàÍπå?",cancel:"Í±∞ÎûòÎ™ÖÏÑ∏ÏÑú ÌôïÏù∏ÏùÑ Ï∑®ÏÜåÌïòÏãúÍ≤†ÏäµÎãàÍπå?"},successMessage:{confirm:"Í±∞ÎûòÎ™ÖÏÑ∏ÏÑú ÌôïÏù∏Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.",cancel:"Í±∞ÎûòÎ™ÖÏÑ∏ÏÑú ÌôïÏù∏Ïù¥ Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§."},completedText:"‚úì ÏôÑÎ£å",waitingText:"ÎåÄÍ∏∞"},currentUserName:E,canPerformAction:B,onUpdate:F}),$=j({config:{field:"actual_received",confirmMessage:{confirm:"Ïã§Ï†ú ÏûÖÍ≥† Ï≤òÎ¶¨Î•º ÏßÑÌñâÌïòÏãúÍ≤†ÏäµÎãàÍπå?",cancel:"Ïã§Ï†ú ÏûÖÍ≥† Ï≤òÎ¶¨Î•º Ï∑®ÏÜåÌïòÏãúÍ≤†ÏäµÎãàÍπå?"},successMessage:{confirm:"Ïã§Ï†ú ÏûÖÍ≥† Ï≤òÎ¶¨Í∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.",cancel:"Ïã§Ï†ú ÏûÖÍ≥† Ï≤òÎ¶¨Í∞Ä Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§."},completedText:"ÏûÖÍ≥†ÏôÑÎ£å",waitingText:"ÏûÖÍ≥†ÎåÄÍ∏∞"},currentUserName:E,canPerformAction:B,onUpdate:F}),H=(e,a,t)=>{const s=[...M];if(s[e]={...s[e],[a]:"quantity"===a||"unit_price_value"===a||"amount_value"===a?Number(t):t},"quantity"===a||"unit_price_value"===a){const a=s[e].quantity||0,t=s[e].unit_price_value||0;s[e].amount_value=t>0?a*t:0}z(s)},O=M,G=O.reduce((e,a)=>e+(a.amount_value||0),0);return s.jsx(n,{open:q,onOpenChange:C,children:s.jsxs(l,{className:"w-full max-w-[95vw] sm:max-w-6xl max-h-[80vh] overflow-hidden flex flex-col bg-white",children:[s.jsx(c,{className:"flex-shrink-0",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs(m,{className:"modal-title",children:["Î∞úÏ£º ÏÉÅÏÑ∏ Ìï≠Î™© - ",k.purchase_order_number]}),s.jsxs("div",{className:"flex items-center gap-2",children:[T&&!I&&s.jsxs(r,{variant:"outline",size:"sm",onClick:()=>{A(!0),z([...k.items||[]])},children:[s.jsx(v,{className:"h-4 w-4 mr-1"}),"Ìé∏Ïßë"]}),I&&s.jsxs(s.Fragment,{children:[s.jsxs(r,{variant:"outline",size:"sm",onClick:()=>{const e={line_number:M.length+1,item_name:"",specification:"",quantity:1,unit_price_value:void 0,amount_value:0,remark:"",is_received:!1};z([...M,e])},children:[s.jsx(N,{className:"h-4 w-4 mr-1"}),"ÌíàÎ™© Ï∂îÍ∞Ä"]}),s.jsxs(r,{variant:"default",size:"sm",onClick:async()=>{try{t.debug("ÌíàÎ™© Ï†ÄÏû• ÏãúÏûë",{editingItems:M.length,purchaseId:k.id});if(M.filter(e=>!e.item_name||!e.item_name.trim()).length>0)return void _.error("ÌíàÎ™©Î™ÖÏùÄ ÌïÑÏàò ÏûÖÎ†• Ìï≠Î™©ÏûÖÎãàÎã§.");const{error:e}=await P.from("purchase_request_items").delete().eq("purchase_request_id",k.id);if(e)throw t.error("Í∏∞Ï°¥ ÌíàÎ™© ÏÇ≠Ï†ú Ïã§Ìå®",e),e;const a=M.map(e=>({purchase_request_id:k.id,purchase_order_number:k.purchase_order_number,line_number:e.line_number,item_name:e.item_name.trim(),specification:e.specification||"",quantity:Number(e.quantity)||0,unit_price_value:null!==e.unit_price_value&&void 0!==e.unit_price_value&&""!==e.unit_price_value?Number(e.unit_price_value):null,amount_value:Number(e.amount_value)||0,remark:e.remark||"",link:e.link||null,is_received:e.is_received||!1,delivery_status:e.delivery_status||"pending"}));t.debug("ÌíàÎ™© ÏÇΩÏûÖ Îç∞Ïù¥ÌÑ∞",{itemsToInsert:a});const{error:s}=await P.from("purchase_request_items").insert(a);if(s)throw t.error("ÌíàÎ™© ÏÇΩÏûÖ Ïã§Ìå®",s),s;const r=M.reduce((e,a)=>e+(Number(a.amount_value)||0),0),{error:i}=await P.from("purchase_requests").update({total_amount:r}).eq("id",k.id);if(i)throw t.error("Ï¥ùÍ∏àÏï° ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®",i),i;t.debug("ÌíàÎ™© Ï†ÄÏû• ÏôÑÎ£å"),_.success("ÌíàÎ™©Ïù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§."),A(!1),D(),C()}catch(e){t.error("ÌíàÎ™© Ï†ÄÏû• Ï§ë Ïò§Î•ò",e),_.error(`Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${e instanceof Error?e.message:e}`)}},children:[s.jsx(y,{className:"h-4 w-4 mr-1"}),"Ï†ÄÏû•"]}),s.jsx(r,{variant:"ghost",size:"sm",onClick:()=>{A(!1),z(k.items||[])},children:"Ï∑®ÏÜå"})]}),s.jsx(r,{variant:"ghost",size:"icon",onClick:C,className:"h-6 w-6",children:s.jsx(i,{className:"h-4 w-4"})})]})]})}),s.jsxs("div",{className:"flex-shrink-0 grid grid-cols-2 md:grid-cols-4 gap-3 py-3 border-b",children:[s.jsxs("div",{children:[s.jsx("p",{className:"modal-label",children:"ÏóÖÏ≤¥Î™Ö"}),s.jsx("p",{className:"modal-value",children:k.vendor_name})]}),s.jsxs("div",{children:[s.jsx("p",{className:"modal-label",children:"ÏöîÏ≤≠Ïûê"}),s.jsx("p",{className:"modal-value",children:k.requester_name})]}),s.jsxs("div",{children:[s.jsx("p",{className:"modal-label",children:"ÌîÑÎ°úÏ†ùÌä∏"}),s.jsx("p",{className:"modal-value truncate",title:k.project_vendor,children:k.project_vendor})]}),s.jsxs("div",{children:[s.jsx("p",{className:"modal-label",children:"ÎÇ©Í∏∞Ïùº"}),s.jsx("p",{className:"modal-value",children:k.delivery_request_date&&f(new Date(k.delivery_request_date),"yyyy-MM-dd")})]})]}),s.jsx("div",{className:"flex-1 overflow-auto",children:s.jsxs(d,{children:[s.jsx(u,{className:"sticky top-0 bg-white z-10",children:s.jsxs(h,{children:[s.jsx(x,{className:"w-12",children:"No."}),s.jsx(x,{children:"ÌíàÎ™©"}),s.jsx(x,{children:"Í∑úÍ≤©"}),s.jsx(x,{className:"text-right",children:"ÏàòÎüâ"}),s.jsx(x,{className:"text-right",children:"Îã®Í∞Ä"}),s.jsx(x,{className:"text-right",children:"Í∏àÏï°"}),"purchase"===S&&s.jsx(x,{children:"Íµ¨Îß§ÏÉÅÌÉú"}),("receipt"===S||"done"===S)&&s.jsx(x,{children:"ÏûÖÍ≥†ÏÉÅÌÉú"}),"done"===S&&s.jsxs(s.Fragment,{children:[s.jsx(x,{className:"text-center",children:"Í±∞ÎûòÎ™ÖÏÑ∏ÏÑú ÌôïÏù∏"}),s.jsx(x,{className:"text-center",children:"ÌöåÍ≥ÑÏÉÅ ÏûÖÍ≥†Ïùº"}),s.jsx(x,{className:"text-center",children:"Ï≤òÎ¶¨Ïûê"})]}),"receipt"===S&&s.jsx(x,{className:"text-center",children:"Ïã§Ï†ú ÏûÖÍ≥†Ïùº"}),s.jsx(x,{children:"ÎπÑÍ≥†"}),I&&s.jsx(x,{className:"w-20",children:"ÏÇ≠Ï†ú"})]})}),s.jsx(p,{children:O.map((e,a)=>s.jsxs(h,{children:[s.jsx(g,{className:"modal-value",children:e.line_number||a+1}),s.jsx(g,{children:I?s.jsx(o,{value:e.item_name,onChange:e=>H(a,"item_name",e.target.value),className:"h-7 modal-label"}):s.jsx("div",{className:"sm:max-w-[200px]",children:s.jsx("p",{className:"modal-value truncate",title:e.item_name,children:e.item_name})})}),s.jsx(g,{children:I?s.jsx(o,{value:e.specification,onChange:e=>H(a,"specification",e.target.value),className:"h-7 modal-label"}):s.jsx("div",{className:"sm:max-w-[150px] truncate",title:e.specification,children:e.specification})}),s.jsx(g,{className:"text-right",children:I?s.jsx(o,{type:"number",value:e.quantity,onChange:e=>H(a,"quantity",e.target.value),className:"h-7 text-xs text-right"}):s.jsx("div",{className:"text-right",children:s.jsx("span",{className:"modal-value text-right",style:{display:"block",textAlign:"right"},children:e.quantity.toLocaleString()})})}),s.jsx(g,{className:"text-right",children:I?s.jsx(o,{type:"number",value:e.unit_price_value,onChange:e=>H(a,"unit_price_value",e.target.value),className:"h-7 text-xs text-right"}):s.jsx("div",{className:"text-right",children:s.jsxs("span",{className:"modal-subtitle text-right",style:{display:"block",textAlign:"right"},children:[(e.unit_price_value||0).toLocaleString()," ",k.currency]})})}),s.jsx(g,{className:"text-right",children:I?s.jsx(o,{type:"number",value:e.amount_value,onChange:e=>H(a,"amount_value",e.target.value),className:"h-7 modal-label text-right"}):s.jsx("div",{className:"text-right",children:s.jsxs("span",{className:"modal-value text-right",style:{display:"block",textAlign:"right"},children:[(e.amount_value||0).toLocaleString()," ",k.currency]})})}),"purchase"===S&&s.jsx(g,{children:B?e.is_payment_completed?s.jsx("button",{onClick:async()=>{try{if(t.debug("Íµ¨Îß§Ï∑®ÏÜå Î≤ÑÌäº ÌÅ¥Î¶≠",{itemId:e.id,itemName:e.item_name,currentStatus:e.is_payment_completed}),!e.id)throw new Error("ÌíàÎ™© IDÍ∞Ä ÏóÜÏäµÎãàÎã§.");const{error:a,data:s}=await P.from("purchase_request_items").update({is_payment_completed:!1}).eq("id",e.id).select();if(a)throw t.error("Íµ¨Îß§Ï∑®ÏÜå ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®",a),a;t.debug("Íµ¨Îß§Ï∑®ÏÜå ÏóÖÎç∞Ïù¥Ìä∏ ÏÑ±Í≥µ",{data:s}),_.success("Íµ¨Îß§ Ï∑®ÏÜå Ï≤òÎ¶¨ÎêòÏóàÏäµÎãàÎã§."),await F()}catch(a){t.error("Íµ¨Îß§Ï∑®ÏÜå Ï≤òÎ¶¨ Ï§ë Ïò§Î•ò",a),_.error(`Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${a instanceof Error?a.message:a}`)}},className:"button-base bg-green-500 hover:bg-green-600 text-white transition-colors",title:"ÌÅ¥Î¶≠ÌïòÏó¨ Íµ¨Îß§ Ï∑®ÏÜå",children:"Íµ¨Îß§ÏôÑÎ£å"}):s.jsx("button",{onClick:async()=>{try{if(t.debug("Íµ¨Îß§ÏôÑÎ£å Î≤ÑÌäº ÌÅ¥Î¶≠",{itemId:e.id,itemName:e.item_name,currentStatus:e.is_payment_completed}),!e.id)throw new Error("ÌíàÎ™© IDÍ∞Ä ÏóÜÏäµÎãàÎã§.");const{error:a,data:s}=await P.from("purchase_request_items").update({is_payment_completed:!0}).eq("id",e.id).select();if(a)throw t.error("Íµ¨Îß§ÏôÑÎ£å ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®",a),a;t.debug("Íµ¨Îß§ÏôÑÎ£å ÏóÖÎç∞Ïù¥Ìä∏ ÏÑ±Í≥µ",{data:s}),_.success("Íµ¨Îß§ÏôÑÎ£å Ï≤òÎ¶¨ÎêòÏóàÏäµÎãàÎã§."),await F()}catch(a){t.error("Íµ¨Îß§ÏôÑÎ£å Ï≤òÎ¶¨ Ï§ë Ïò§Î•ò",a),_.error(`Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${a instanceof Error?a.message:a}`)}},className:"button-base border border-gray-300 text-gray-600 bg-white hover:bg-gray-50",children:"Íµ¨Îß§ÎåÄÍ∏∞"}):s.jsx("span",{className:"button-base "+(e.is_payment_completed?"bg-green-500 text-white":"border border-gray-300 text-gray-400 bg-white"),children:e.is_payment_completed?"Íµ¨Îß§ÏôÑÎ£å":"Íµ¨Îß§ÎåÄÍ∏∞"})}),("receipt"===S||"done"===S)&&s.jsx(g,{children:"receipt"===S?B?$.isCompleted(e)?s.jsx("button",{onClick:()=>{$.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-base bg-green-500 hover:bg-green-600 text-white transition-colors",title:"ÌÅ¥Î¶≠ÌïòÏó¨ Ïã§Ï†ú ÏûÖÍ≥† Ï≤òÎ¶¨ Ï∑®ÏÜå",children:$.config.completedText}):s.jsx(b,{onDateSelect:a=>{$.handleConfirm(e.id,a,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"Ïã§Ï†ú ÏûÖÍ≥† ÎÇ†Ïßú ÏÑ†ÌÉù",children:s.jsx(r,{variant:"outline",size:"sm",className:"button-base border border-gray-300 text-gray-600 bg-white hover:bg-gray-50",children:$.config.waitingText})}):s.jsx("span",{className:"button-base "+($.isCompleted(e)?"bg-green-500 text-white":"border border-gray-300 text-gray-400 bg-white"),children:$.isCompleted(e)?$.config.completedText:$.config.waitingText}):s.jsx("span",{className:"button-base "+($.isCompleted(e)?"bg-green-500 text-white":"border border-gray-300 text-gray-600 bg-white"),children:$.isCompleted(e)?$.config.completedText:$.config.waitingText})}),"receipt"===S&&s.jsx(g,{className:"text-center",children:$.getCompletedDate(e)?s.jsx("span",{className:"modal-subtitle text-green-600",children:f(new Date($.getCompletedDate(e)),"yyyy-MM-dd HH:mm")}):s.jsx("span",{className:"modal-subtitle",children:"-"})}),"done"===S&&s.jsxs(s.Fragment,{children:[s.jsx(g,{className:"text-center",children:B?R.isCompleted(e)?s.jsx("button",{onClick:()=>{R.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-base bg-green-500 hover:bg-green-600 text-white transition-colors",title:"ÌÅ¥Î¶≠ÌïòÏó¨ Í±∞ÎûòÎ™ÖÏÑ∏ÏÑú ÌôïÏù∏ Ï∑®ÏÜå",children:R.config.completedText}):s.jsx(b,{onDateSelect:a=>{R.handleConfirm(e.id,a,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"ÎÇ†Ïßú ÏÑ†ÌÉù",children:s.jsx(r,{variant:"outline",size:"sm",className:"button-base border border-gray-300 text-gray-600 bg-white hover:bg-gray-50",children:R.config.waitingText})}):s.jsx("span",{className:"button-base "+(R.isCompleted(e)?"bg-green-500 text-white":"border border-gray-300 text-gray-400 bg-white"),children:R.isCompleted(e)?R.config.completedText:R.config.waitingText})}),s.jsx(g,{className:"text-center",children:R.getCompletedDate(e)?s.jsx("span",{className:"modal-subtitle",children:f(new Date(R.getCompletedDate(e)),"yyyy-MM-dd")}):s.jsx("span",{className:"modal-subtitle",children:"-"})}),s.jsx(g,{className:"text-center",children:R.getCompletedByName(e)?s.jsx("span",{className:"modal-subtitle",children:R.getCompletedByName(e)}):s.jsx("span",{className:"modal-subtitle",children:"-"})})]}),s.jsx(g,{children:I?s.jsx(o,{value:e.remark||"",onChange:e=>H(a,"remark",e.target.value),className:"h-7 modal-label",placeholder:"ÎπÑÍ≥†"}):s.jsx("div",{className:"sm:max-w-[150px]",children:s.jsx("span",{className:"modal-subtitle truncate block",title:e.remark,children:e.remark||"-"})})}),I&&s.jsx(g,{children:s.jsx(r,{variant:"ghost",size:"icon",onClick:()=>(e=>{const a=M.filter((a,t)=>t!==e);a.forEach((e,a)=>{e.line_number=a+1}),z(a)})(a),className:"h-7 w-7 text-red-500 hover:text-red-700",children:s.jsx(w,{className:"h-4 w-4"})})})]},e.id||a))})]})}),s.jsxs("div",{className:"flex-shrink-0 border-t pt-4 flex justify-between items-center",children:[s.jsxs("div",{className:"modal-subtitle",children:["Ï¥ù ",O.length,"Í∞ú ÌíàÎ™©"]}),s.jsxs("div",{className:"modal-value-large",children:["Ï¥ù Í∏àÏï°: ",G.toLocaleString()," ",k.currency]})]})]})})}export{q as default};
//# sourceMappingURL=PurchaseItemsModal-DiLAUBU8.js.map
