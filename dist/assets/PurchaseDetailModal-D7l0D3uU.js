import{c as e,j as a,B as t,k as s,r,a as i,l as n,X as l,H as c,g as m}from"./index-BjQfKsz5.js";import{f as d}from"./helpers-Buk9LCEc.js";import{C as o,k as u,u as x,D as p}from"./useConfirmDateAction-BijC1hXy.js";import{P as h,a as g,b as v}from"./popover-fqFFHJHr.js";import{C as _}from"./calendar-B8gDSV1k.js";import{f as b,P as j}from"./format-C9v-JHhC.js";import{t as y,B as f}from"./index-DMhMemmS.js";import{I as N,D as w,a as C}from"./input-DZeHNnGi.js";import{C as q}from"./check-dWobChbv.js";import{P as k}from"./package-BsQjQIc2.js";import{C as S}from"./credit-card-DVCuA_Pi.js";import{T as D}from"./trash-2-Q_rjc0gc.js";import{P as T}from"./plus-CNKBYCVi.js";import{S as I}from"./save-E7vGK4sj.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const R=e("truck",[["path",{d:"M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2",key:"wrbu53"}],["path",{d:"M15 18H9",key:"1lyqi6"}],["path",{d:"M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14",key:"lysw3i"}],["circle",{cx:"17",cy:"18",r:"2",key:"332jqn"}],["circle",{cx:"7",cy:"18",r:"2",key:"19iecd"}]]);function $({date:e,onDateChange:r,placeholder:i="날짜 선택",className:n,disabled:l=!1}){return a.jsxs(h,{children:[a.jsx(g,{asChild:!0,children:a.jsxs(t,{variant:"outline",className:s("justify-start text-left font-normal",!e&&"text-muted-foreground",n),disabled:l,children:[a.jsx(_,{className:"mr-2 h-4 w-4"}),e?b(e,"yyyy-MM-dd",{locale:u}):a.jsx("span",{children:i})]})}),a.jsx(v,{className:"w-auto p-0",children:a.jsx(o,{mode:"single",selected:e,onSelect:r,initialFocus:!0})})]})}function O({purchaseId:e,isOpen:s,onClose:o,embedded:u=!1,currentUserRoles:h=[],activeTab:g,onRefresh:v,onDelete:b}){const[O,F]=r.useState(!1),[A,M]=r.useState(null),[z,P]=r.useState(!1),[K,E]=r.useState(null),[B,L]=r.useState([]),[U,H]=r.useState([]),[W,J]=r.useState([]),[V,G]=r.useState(""),[Q,X]=r.useState([]),Y=r.useRef(null),Z=i();r.useEffect(()=>{s&&(async()=>{try{const{data:{user:e}}=await Z.auth.getUser();if(e){let{data:a}=await Z.from("employees").select("*").eq("id",e.id).maybeSingle();if(!a&&e.email){const{data:t}=await Z.from("employees").select("*").eq("email",e.email).maybeSingle();a=t}if(a?.name&&G(a.name),a?.purchase_role){let e=[];e=Array.isArray(a.purchase_role)?a.purchase_role.map(e=>String(e).trim()):String(a.purchase_role).split(",").map(e=>e.trim()).filter(e=>e.length>0),J(e)}}}catch(e){}})()},[s]);const ee=Array.isArray(h)&&h.length>0?h:W,ae=ee.includes("final_approver")||ee.includes("app_admin")||ee.includes("ceo"),te="approved"===A?.final_manager_status?ae:ae||A?.requester_name===V,se=ee.includes("app_admin")||ee.includes("lead_buyer")||ee.includes("lead buyer"),re=ee.includes("app_admin")||A?.requester_name===V,ie=ee.includes("final_approver")||ee.includes("app_admin")||ee.includes("ceo"),ne=A?.requester_name===V,le=ie||ne,ce=x({config:{field:"statement_received",confirmMessage:{confirm:"거래명세서 확인을 처리하시겠습니까?",cancel:"거래명세서 확인을 취소하시겠습니까?"},successMessage:{confirm:"거래명세서 확인이 완료되었습니다.",cancel:"거래명세서 확인이 취소되었습니다."},completedText:"✓ 완료",waitingText:"대기"},currentUserName:V,canPerformAction:le,onUpdate:()=>{v&&v(!0)}}),me=x({config:{field:"actual_received",confirmMessage:{confirm:"실제 입고 처리를 진행하시겠습니까?",cancel:"실제 입고 처리를 취소하시겠습니까?"},successMessage:{confirm:"실제 입고 처리가 완료되었습니다.",cancel:"실제 입고 처리가 취소되었습니다."},completedText:"입고완료",waitingText:"입고대기"},currentUserName:V,canPerformAction:le,onUpdate:()=>{v&&v(!0)}});n.debug("Receipt Check",{activeTab:g,canReceiptCheck:le,isAdmin:ie,isRequester:ne,currentUserName:V,requesterName:A?.requester_name,effectiveRoles:ee});const de=ee.includes("middle_manager")||ee.includes("app_admin")||ee.includes("ceo"),oe=ee.includes("final_approver")||ee.includes("app_admin")||ee.includes("ceo"),ue="inline-flex items-center gap-1 business-radius-badge !h-auto !min-h-0 !px-2.5 !py-0.5 badge-text leading-tight",xe="inline-flex items-center gap-1 business-radius-badge px-2.5 py-0.5 badge-text leading-tight";n.debug("PurchaseDetailModal 권한 체크",{currentUserRoles:h,userRoles:W,effectiveRoles:ee,canApproveMiddle:de,canApproveFinal:oe,isEditing:z,middleManagerStatus:A?.middle_manager_status,finalManagerStatus:A?.final_manager_status}),r.useEffect(()=>{e&&s&&(ge(e.toString()),P(!1))},[e,s]);const pe=()=>{if(Y.current&&!z){const e=Y.current.children,a=Array.from(e).map(e=>e.getBoundingClientRect().width);X(a),n.debug("Column widths measured",{widths:a})}};r.useEffect(()=>{A&&A.items&&A.items.length>0&&!z&&setTimeout(pe,100)},[A,z,g]);const he=e=>{e&&!z&&pe(),P(e)},ge=async e=>{try{F(!0);const a=i(),{data:t,error:s}=await a.from("purchase_requests").select("\n          *,\n          vendors(id, vendor_name),\n          purchase_request_items(*)\n        ").eq("id",e).single();if(s)throw s;if(t){const e={...t,items:t.purchase_request_items||[],vendor:t.vendors||{id:0,vendor_name:"알 수 없음"},vendor_contacts:[]};M(e),E(e),L(e.items||[])}}catch(a){y.error("발주 상세 정보를 불러오는데 실패했습니다.")}finally{F(!1)}},ve=e=>new Intl.NumberFormat("ko-KR").format(e),_e=(e,a,t)=>{const s=[...B];if("amount_value"===a)s[e]={...s[e],amount_value:t};else if("quantity"===a||"unit_price_value"===a){const r="quantity"===a?t:s[e].quantity,i="unit_price_value"===a?t:s[e].unit_price_value;s[e]={...s[e],[a]:t,amount_value:r*i}}else s[e]={...s[e],[a]:t};L(s)},be=e=>{const a=B[e];a.id&&H([...U,a.id]);const t=B.filter((a,t)=>t!==e);L(t)},je=async(e,a)=>{if(!se)return void y.error("구매완료 처리 권한이 없습니다.");const t=String(e),s="number"==typeof e?e:Number(e);if(Number.isNaN(s))return void y.error("유효하지 않은 항목 ID 입니다.");const r=A?.items?.find(e=>e.id===t);if(!r)return;const i=`품명: ${r.item_name}\n규격: ${r.specification||"미입력"}\n수량: ${r.quantity?.toLocaleString()||0}${r.unit||""}\n단가: ₩${r.unit_price_value?.toLocaleString()||0}\n합계: ₩${r.amount_value?.toLocaleString()||0}`,n=a?`다음 품목을 구매완료 처리하시겠습니까?\n\n${i}`:`다음 품목의 구매완료를 취소하시겠습니까?\n\n${i}`;if(window.confirm(n))try{const{error:e}=await Z.from("purchase_request_items").update({is_payment_completed:a,payment_completed_at:a?(new Date).toISOString():null}).eq("id",s);if(e)throw e;M(e=>{if(!e)return null;const s=e.items?.map(e=>e.id===t?{...e,is_payment_completed:a,payment_completed_at:a?(new Date).toISOString():null}:e);return{...e,items:s}}),y.success(a?"구매완료 처리되었습니다.":"구매완료가 취소되었습니다.")}catch(l){y.error("구매완료 처리 중 오류가 발생했습니다.")}},ye=async e=>{if(!A)return;const a="middle"===e?"1차 승인":"최종 승인",t=`발주번호: ${A.purchase_order_number}\n\n${a}을 진행하시겠습니까?`;if(window.confirm(t))try{const a="middle"===e?{middle_manager_status:"approved"}:{final_manager_status:"approved"},{error:t}=await Z.from("purchase_requests").update(a).eq("id",A.id);if(t)throw t;M("middle"===e?e=>e?{...e,middle_manager_status:"approved"}:null:e=>e?{...e,final_manager_status:"approved"}:null),y.success(("middle"===e?"중간":"최종")+" 승인이 완료되었습니다.")}catch(s){y.error("승인 처리 중 오류가 발생했습니다.")}},fe=a.jsx("div",{className:"space-y-1 sm:space-y-4",children:O?a.jsx("div",{className:"flex items-center justify-center py-12",children:a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-hansl-600"})}):A?a.jsxs("div",{children:[a.jsx("div",{className:"bg-gray-50 rounded-lg p-2 sm:p-3 mb-1 sm:mb-2 border border-gray-100",children:a.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 items-center gap-3 sm:gap-0",children:[a.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-4",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[(()=>{if(!A)return null;if(A.payment_category){const e=A.payment_category.trim();return"발주"===e?a.jsx(f,{variant:null,className:"badge-success",children:"발주"}):"구매요청"===e?a.jsx(f,{variant:null,className:"badge-primary",children:"구매요청"}):"현장결제"===e?a.jsx(f,{variant:null,className:"badge-secondary",children:"현장결제"}):a.jsx(f,{variant:null,className:"badge-primary",children:e})}return a.jsx(f,{variant:null,className:"badge-primary",children:"구매요청"})})(),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"modal-label",children:"요청자:"}),a.jsx("span",{className:"modal-value",children:A.requester_name})]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(_,{className:"w-3 h-3 text-gray-500"}),a.jsxs("span",{className:"modal-subtitle",children:["청구일: ",d(A.request_date)]})]})]}),a.jsxs("div",{className:"flex items-center justify-center gap-2 sm:gap-3 flex-wrap",children:[de&&"pending"===A.middle_manager_status&&a.jsx(t,{size:"sm",variant:"outline",onClick:()=>ye("middle"),className:`${ue} border border-gray-400 bg-white hover:bg-gray-50 hover:border-gray-500`,children:"1차 승인 대기"}),"approved"===A.middle_manager_status&&a.jsxs("div",{className:"button-approved badge-text shadow-sm",children:[a.jsx(q,{className:"w-3 h-3"}),"1차 승인완료"]}),"rejected"===A.middle_manager_status&&a.jsxs("div",{className:"button-rejected badge-text",children:[a.jsx(l,{className:"w-3 h-3"}),"1차 반려"]}),"pending"===A.middle_manager_status&&!de&&a.jsx("div",{className:`${xe} border border-gray-300 text-gray-600 bg-white`,children:"1차 승인대기"}),oe&&"approved"===A.middle_manager_status&&"pending"===A.final_manager_status&&a.jsxs(t,{size:"sm",variant:"outline",onClick:()=>ye("final"),className:`${ue} border border-gray-400 bg-white hover:bg-gray-50 hover:border-gray-500`,children:[a.jsx(q,{className:"w-3 h-3"}),"최종 승인"]}),"approved"===A.final_manager_status&&a.jsxs("div",{className:"button-approved badge-text",children:[a.jsx(q,{className:"w-3 h-3"}),"최종 승인완료"]}),"rejected"===A.final_manager_status&&a.jsxs("div",{className:"button-rejected badge-text",children:[a.jsx(l,{className:"w-3 h-3"}),"최종 반려"]}),"approved"!==A.middle_manager_status&&"pending"===A.final_manager_status&&a.jsx("div",{className:`${xe} border border-gray-300 text-gray-600 bg-white`,children:"최종 승인대기"})]}),a.jsx("div",{})]})}),a.jsxs("div",{className:"flex flex-col lg:flex-row gap-3 sm:gap-6",children:[a.jsxs("div",{className:"lg:w-80 lg:flex-shrink-0 space-y-1 sm:space-y-4 relative",children:[a.jsxs("div",{className:"bg-white rounded-lg p-2 sm:p-3 border border-gray-100 shadow-sm",children:[a.jsx("div",{className:"mb-3",children:a.jsxs("h3",{className:"modal-section-title flex items-center",children:[a.jsx(c,{className:"w-4 h-4 mr-2 text-gray-600"}),A?.purchase_order_number||"PO번호 없음"]})}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"발주서 종류"}),z?a.jsx(N,{value:K?.request_type||"",onChange:e=>E(a=>a?{...a,request_type:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"일반"}):a.jsx("p",{className:"modal-value",children:A.request_type||"일반"})]}),a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"결제 종류"}),z?a.jsx(N,{value:K?.payment_category||"",onChange:e=>E(a=>a?{...a,payment_category:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"발주/구매요청/현장결제"}):a.jsx("p",{className:"modal-value",children:A.payment_category||"-"})]})]}),a.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"입고 요청일"}),z?a.jsx($,{date:K?.delivery_request_date?new Date(K.delivery_request_date):void 0,onDateChange:e=>E(a=>a?{...a,delivery_request_date:e?.toISOString().split("T")[0]||""}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]"}):a.jsx("p",{className:"modal-subtitle",children:d(A.delivery_request_date)})]}),a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label text-orange-500",children:"변경 입고일"}),z?a.jsx($,{date:K?.revised_delivery_request_date?new Date(K.revised_delivery_request_date):void 0,onDateChange:e=>E(a=>a?{...a,revised_delivery_request_date:e?.toISOString().split("T")[0]||""}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]"}):a.jsx("p",{className:"modal-subtitle text-orange-700",children:A.revised_delivery_request_date?d(A.revised_delivery_request_date):"미설정"})]})]})]})]}),a.jsxs("div",{className:"bg-white rounded-lg p-2 sm:p-3 border border-gray-100 shadow-sm",children:[a.jsxs("h3",{className:"modal-section-title mb-3 flex items-center",children:[a.jsx(m,{className:"w-4 h-4 mr-2 text-gray-600"}),"업체 정보"]}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"업체명"}),z?a.jsx(N,{value:K?.vendor?.vendor_name||K?.vendor_name||"",onChange:e=>E(a=>a?{...a,vendor_name:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"업체 선택"}):a.jsx("p",{className:"modal-value",children:A.vendor?.vendor_name||"-"})]}),a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"업체 담당자"}),z?a.jsx(N,{value:K?.vendor_contacts?.[0]?.contact_name||"",onChange:e=>{E(a=>{if(!a)return null;const t=[...a.vendor_contacts||[]];return t[0]?t[0]={...t[0],contact_name:e.target.value}:t[0]={contact_name:e.target.value},{...a,vendor_contacts:t}})},className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"담당자 선택"}):a.jsx("p",{className:"modal-value",children:A.vendor_contacts?.[0]?.contact_name||"-"})]})]}),a.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"PJ업체"}),z?a.jsx(N,{value:K?.project_vendor||"",onChange:e=>E(a=>a?{...a,project_vendor:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"입력"}):a.jsx("p",{className:"modal-value",children:A.project_vendor||"-"})]}),a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"Item"}),z?a.jsx(N,{value:K?.project_item||"",onChange:e=>E(a=>a?{...a,project_item:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"입력"}):a.jsx("p",{className:"modal-subtitle",children:A.project_item||"-"})]})]}),a.jsx("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"수주번호"}),z?a.jsx(N,{value:K?.order_number||"",onChange:e=>E(a=>a?{...a,order_number:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"입력"}):a.jsx("p",{className:"modal-subtitle",children:A.order_number||"-"})]})})]})]})]}),a.jsx("div",{className:"lg:flex-1 lg:min-w-0 relative overflow-visible",children:a.jsxs("div",{className:"bg-white rounded-lg border border-gray-100 overflow-hidden shadow-sm",children:[a.jsxs("div",{className:"p-2 sm:p-3 bg-gray-50 border-b border-gray-100 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-0",children:[a.jsxs("h3",{className:"modal-section-title flex items-center",children:[a.jsx(k,{className:"w-4 h-4 mr-2 text-gray-600"}),"품목 리스트",a.jsxs("span",{className:"ml-2 badge-secondary",children:[A.items?.length||0,"개"]})]}),!z&&a.jsxs(a.Fragment,{children:["purchase"===g&&se&&a.jsxs(t,{size:"sm",onClick:async()=>{if(!A||!se)return;const e=`발주번호: ${A.purchase_order_number}\n\n모든 품목을 구매완료 처리하시겠습니까?`;if(window.confirm(e))try{const e={is_payment_completed:!0,payment_completed_at:(new Date).toISOString()},{error:a}=await Z.from("purchase_request_items").update(e).eq("purchase_request_id",A.id).eq("is_payment_completed",!1);if(a)throw a;M(e=>{if(!e)return null;const a=e.items?.map(e=>e.is_payment_completed?e:{...e,is_payment_completed:!0,payment_completed_at:(new Date).toISOString()});return{...e,items:a}}),y.success("모든 품목이 구매완료 처리되었습니다.")}catch(a){n.error("전체 구매완료 처리 오류",a),y.error("구매완료 처리 중 오류가 발생했습니다.")}},className:"button-base bg-orange-500 hover:bg-orange-600 text-white",children:[a.jsx(S,{className:"w-3 h-3 mr-1"}),"전체 구매완료"]}),"receipt"===g&&re&&a.jsx(p,{onDateSelect:async e=>{if(A&&re)try{const{error:a}=await Z.from("purchase_request_items").update({is_received:!0,received_at:(new Date).toISOString(),actual_received_date:e.toISOString()}).eq("purchase_request_id",A.id).is("actual_received_date",null);if(a)throw a;M(a=>{if(!a)return null;const t=a.items?.map(a=>a.actual_received_date?a:{...a,is_received:!0,received_at:(new Date).toISOString(),actual_received_date:e.toISOString()});return{...a,items:t}}),y.success("모든 품목이 입고완료 처리되었습니다.")}catch(a){n.error("전체 입고완료 처리 오류",a),y.error("입고완료 처리 중 오류가 발생했습니다.")}},placeholder:"전체 입고완료 날짜를 선택하세요",align:"end",side:"bottom",children:a.jsxs(t,{size:"sm",className:"button-base button-action-primary",children:[a.jsx(R,{className:"w-3 h-3 mr-1"}),"전체 입고완료"]})})]})]}),a.jsx("div",{className:"block sm:hidden bg-gray-50 px-2 py-1 border-b border-gray-100",children:a.jsx("div",{className:"text-xs font-medium text-gray-600",children:"품목 목록 (터치하여 스크롤)"})}),a.jsxs("div",{className:"max-h-[50vh] sm:max-h-[40vh] overflow-y-auto overflow-x-auto min-w-fit",children:[a.jsx("div",{className:"bg-gray-50 px-2 sm:px-3 py-1 border-b border-gray-100 sticky top-0 z-10",children:a.jsxs("div",{ref:Y,className:"hidden sm:grid gap-3 modal-label",style:{gridTemplateColumns:z&&Q.length>0?Q.map(e=>`${e}px`).join(" "):"receipt"===g?"minmax(120px, 1fr) minmax(200px, 2fr) minmax(70px, auto) minmax(90px, auto) minmax(100px, auto) minmax(80px, 1fr) minmax(80px, auto) minmax(100px, auto) minmax(100px, auto) minmax(80px, auto) minmax(120px, auto)":"minmax(120px, 1fr) minmax(200px, 2fr) minmax(70px, auto) minmax(90px, auto) minmax(100px, auto) minmax(80px, 1fr) minmax(80px, auto) minmax(100px, auto) minmax(100px, auto) minmax(80px, auto)"},children:[a.jsx("div",{children:"품목명"}),a.jsx("div",{children:"규격"}),a.jsx("div",{className:"text-center",children:"수량"}),a.jsx("div",{className:"text-right",children:"단가"}),a.jsx("div",{className:"text-right",children:"합계"}),a.jsx("div",{className:"text-center",children:"비고"}),z?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"text-center",children:"삭제"}),"receipt"===g&&a.jsx(a.Fragment,{children:a.jsx("div",{className:"text-center",children:"실제입고일"})}),"done"===g&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"text-center",children:"거래명세서 확인"}),a.jsx("div",{className:"text-center",children:"회계상 입고일"}),a.jsx("div",{className:"text-center",children:"처리자"})]})]}):a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"text-center",children:"purchase"===g?"구매상태":"receipt"===g?"입고상태":"상태"}),"done"===g&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"text-center",children:"거래명세서 확인"}),a.jsx("div",{className:"text-center",children:"회계상 입고일"}),a.jsx("div",{className:"text-center",children:"처리자"})]}),"receipt"===g&&a.jsx(a.Fragment,{children:a.jsx("div",{className:"text-center",children:"실제입고일"})})]})]})}),(z?B:A.items)?.map((e,s)=>a.jsxs("div",{className:"px-2 sm:px-3 py-1.5 border-b border-gray-50 hover:bg-gray-50/50 transition-colors",children:[a.jsxs("div",{className:"hidden sm:grid items-center gap-3",style:{gridTemplateColumns:z&&Q.length>0?Q.map(e=>`${e}px`).join(" "):"receipt"===g?"minmax(120px, 1fr) minmax(200px, 2fr) minmax(70px, auto) minmax(90px, auto) minmax(100px, auto) minmax(80px, 1fr) minmax(80px, auto) minmax(120px, auto)":"done"===g?"minmax(120px, 1fr) minmax(200px, 2fr) minmax(70px, auto) minmax(90px, auto) minmax(100px, auto) minmax(80px, 1fr) minmax(80px, auto) minmax(100px, auto) minmax(100px, auto) minmax(80px, auto)":"minmax(120px, 1fr) minmax(200px, 2fr) minmax(70px, auto) minmax(90px, auto) minmax(100px, auto) minmax(80px, 1fr) minmax(80px, auto)"},children:[a.jsx("div",{className:"min-w-0",children:z?a.jsx(N,{value:e.item_name,onChange:e=>_e(s,"item_name",e.target.value),className:"modal-label border-gray-200 rounded-lg w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"품목명"}):a.jsx("span",{className:"modal-value",children:e.item_name||"품목명 없음"})}),a.jsx("div",{className:"min-w-0",children:z?a.jsx(N,{value:e.specification,onChange:e=>_e(s,"specification",e.target.value),className:"modal-label border-gray-200 rounded-lg w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"규격"}):a.jsx("span",{className:"modal-subtitle",children:e.specification||"-"})}),a.jsx("div",{className:"text-center min-w-0",children:z?a.jsx(N,{type:"number",value:e.quantity,onChange:e=>_e(s,"quantity",Number(e.target.value)),className:"modal-label border-gray-200 rounded-lg text-center w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"수량",max:"99999"}):a.jsx("span",{className:"modal-subtitle",children:e.quantity||0})}),a.jsx("div",{className:"text-right min-w-0",children:z?a.jsx(N,{type:"number",value:e.unit_price_value,onChange:e=>_e(s,"unit_price_value",Number(e.target.value)),className:"modal-label border-gray-200 rounded-lg text-right w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"단가",max:"100000000000"}):a.jsxs("span",{className:"modal-subtitle",children:["₩",ve(e.unit_price_value)]})}),a.jsx("div",{className:"text-right min-w-0",children:z?a.jsx(N,{type:"number",value:e.amount_value,onChange:e=>_e(s,"amount_value",Number(e.target.value)),className:"modal-label border-gray-200 rounded-lg text-right w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"합계",max:"10000000000"}):a.jsxs("span",{className:"modal-value",children:["₩",ve(e.amount_value||0)]})}),a.jsx("div",{className:"min-w-0 flex justify-center items-start pt-1 text-center",children:z?a.jsx(N,{value:e.remark||"",onChange:e=>_e(s,"remark",e.target.value),className:"modal-label border-gray-200 rounded-lg text-center w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"비고"}):a.jsx("span",{className:"modal-subtitle text-center",children:e.remark||"-"})}),a.jsx("div",{className:"text-center flex justify-center items-start pt-1",children:z?a.jsx(t,{size:"sm",variant:"ghost",onClick:()=>be(s),className:"text-red-600 hover:bg-red-50 rounded-lg p-1 h-6 w-6",children:a.jsx(D,{className:"w-3 h-3"})}):a.jsxs(a.Fragment,{children:["purchase"===g&&a.jsx("div",{className:"flex justify-center",children:se?a.jsx("button",{onClick:()=>je(e.id,!e.is_payment_completed),className:"transition-colors "+(e.is_payment_completed?"button-toggle-active bg-orange-500 hover:bg-orange-600 text-white":"button-toggle-inactive"),children:e.is_payment_completed?"구매완료":"구매대기"}):a.jsx("span",{className:""+(e.is_payment_completed?"button-toggle-active bg-orange-500 text-white":"button-waiting-inactive"),children:e.is_payment_completed?"구매완료":"구매대기"})}),"receipt"===g&&a.jsx("div",{className:"flex justify-center",children:le?me.isCompleted(e)?a.jsx("button",{onClick:()=>{me.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-action-primary",children:me.config.completedText}):a.jsx(p,{onDateSelect:a=>{me.handleConfirm(e.id,a,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"실제 입고된 날짜를 선택하세요",align:"center",side:"bottom",children:a.jsx("button",{className:"button-toggle-inactive",children:me.config.waitingText})}):a.jsx("span",{className:""+(me.isCompleted(e)?"button-action-primary":"button-waiting-inactive"),children:me.isCompleted(e)?me.config.completedText:me.config.waitingText})}),"purchase"!==g&&"receipt"!==g&&a.jsx("div",{className:"flex justify-center",children:a.jsx("span",{className:"badge-text",children:"-"})})]})}),"receipt"===g&&a.jsx("div",{className:"text-center flex justify-center items-start pt-1 pl-2",children:me.getCompletedDate(e)?a.jsx("div",{className:"modal-subtitle text-green-700",children:new Date(me.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})}):a.jsx("span",{className:"modal-subtitle text-gray-400",children:"-"})}),"done"===g&&a.jsx("div",{className:"text-center flex justify-center items-start pt-1",children:le?ce.isCompleted(e)?a.jsx("button",{onClick:()=>{ce.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-action-primary hover:bg-green-600 transition-colors",title:"클릭하여 거래명세서 확인 취소",children:ce.config.completedText}):a.jsx(p,{onDateSelect:a=>{ce.handleConfirm(e.id,a,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"회계상 입고일을 선택하세요",align:"center",side:"bottom",children:a.jsx("button",{className:"button-toggle-inactive",onClick:()=>{},children:ce.config.waitingText})}):a.jsx("span",{className:""+(ce.isCompleted(e)?"button-action-primary":"button-waiting-inactive"),children:ce.isCompleted(e)?ce.config.completedText:ce.config.waitingText})}),"done"===g&&a.jsx("div",{className:"text-center flex justify-center items-start pt-1",children:ce.getCompletedDate(e)?a.jsx("div",{className:"modal-subtitle text-blue-700",children:new Date(ce.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})}):a.jsx("span",{className:"modal-subtitle text-gray-400",children:"-"})}),"done"===g&&a.jsx("div",{className:"text-center flex justify-center items-start pt-1",children:ce.getCompletedByName(e)?a.jsx("span",{className:"modal-subtitle text-gray-600",children:ce.getCompletedByName(e)}):a.jsx("span",{className:"modal-subtitle text-gray-400",children:"-"})})]}),a.jsxs("div",{className:"block sm:hidden space-y-2",children:[a.jsxs("div",{className:"flex justify-between items-start",children:[a.jsxs("div",{className:"flex-1 min-w-0",children:[z?a.jsx(N,{value:e.item_name,onChange:e=>_e(s,"item_name",e.target.value),className:"modal-label border-gray-200 rounded-lg w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"품목명"}):a.jsx("div",{className:"modal-value font-medium",children:e.item_name||"품목명 없음"}),z?a.jsx(N,{value:e.specification,onChange:e=>_e(s,"specification",e.target.value),className:"modal-label border-gray-200 rounded-lg mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"규격"}):a.jsx("div",{className:"modal-subtitle text-gray-500",children:e.specification||"-"})]}),a.jsx("div",{className:"ml-3 text-right flex-shrink-0",children:z?a.jsx(N,{type:"number",value:e.amount_value,onChange:e=>_e(s,"amount_value",Number(e.target.value)),className:"modal-label border-gray-200 rounded-lg text-right w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"합계"}):a.jsxs("div",{className:"modal-value font-semibold",children:["₩",ve(e.amount_value||0)]})})]}),a.jsxs("div",{className:"grid grid-cols-3 gap-2 text-sm",children:[a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"수량:"}),z?a.jsx(N,{type:"number",value:e.quantity,onChange:e=>_e(s,"quantity",Number(e.target.value)),className:"modal-label border-gray-200 rounded-lg mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"수량"}):a.jsx("div",{className:"modal-subtitle",children:e.quantity||0})]}),a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"단가:"}),z?a.jsx(N,{type:"number",value:e.unit_price_value,onChange:e=>_e(s,"unit_price_value",Number(e.target.value)),className:"modal-label border-gray-200 rounded-lg mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"단가"}):a.jsxs("div",{className:"modal-subtitle",children:["₩",ve(e.unit_price_value)]})]}),a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"상태:"}),a.jsx("div",{className:"mt-1",children:z?a.jsx(t,{size:"sm",variant:"ghost",onClick:()=>be(s),className:"text-red-600 hover:bg-red-50 rounded-lg p-1 h-6 w-6",children:a.jsx(D,{className:"w-3 h-3"})}):a.jsxs(a.Fragment,{children:["purchase"===g&&a.jsx(a.Fragment,{children:se?a.jsx("button",{onClick:()=>je(e.id,!e.is_payment_completed),className:"text-xs px-2 py-1 rounded transition-colors "+(e.is_payment_completed?"bg-orange-500 text-white hover:bg-orange-600":"bg-gray-100 text-gray-600"),children:e.is_payment_completed?"구매완료":"구매대기"}):a.jsx("span",{className:"text-xs px-2 py-1 rounded "+(e.is_payment_completed?"bg-orange-500 text-white":"bg-gray-100 text-gray-400"),children:e.is_payment_completed?"구매완료":"구매대기"})}),"receipt"===g&&a.jsx(a.Fragment,{children:le?me.isCompleted(e)?a.jsx("button",{onClick:()=>{me.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"text-xs px-2 py-1 rounded button-action-primary",children:me.config.completedText}):a.jsx(p,{onDateSelect:a=>{me.handleConfirm(e.id,a,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"실제 입고된 날짜를 선택하세요",align:"center",side:"bottom",children:a.jsx("button",{className:"text-xs px-2 py-1 rounded bg-gray-100 text-gray-600",children:me.config.waitingText})}):a.jsx("span",{className:"text-xs px-2 py-1 rounded "+(me.isCompleted(e)?"button-action-primary":"bg-gray-100 text-gray-400"),children:me.isCompleted(e)?me.config.completedText:me.config.waitingText})}),"purchase"!==g&&"receipt"!==g&&a.jsx("span",{className:"text-xs text-gray-400",children:"-"})]})})]})]}),(e.remark||z)&&a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"비고:"}),z?a.jsx(N,{value:e.remark||"",onChange:e=>_e(s,"remark",e.target.value),className:"modal-label border-gray-200 rounded-lg mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"비고"}):a.jsx("div",{className:"modal-subtitle text-gray-500 mt-1",children:e.remark||"-"})]}),!z&&"receipt"===g&&me.getCompletedDate(e)&&a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"실제입고일:"}),a.jsxs("div",{className:"mt-1",children:[a.jsx("div",{className:"modal-subtitle text-green-700",children:new Date(me.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})}),a.jsx("div",{className:"text-[9px] text-gray-500",children:new Date(me.getCompletedDate(e)).toLocaleTimeString("ko-KR",{hour:"2-digit",minute:"2-digit"})})]})]}),!z&&"done"===g&&a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"거래명세서 확인:"}),a.jsx("div",{className:"flex items-center gap-2",children:le?ce.isCompleted(e)?a.jsx("button",{onClick:()=>{ce.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"text-xs px-2 py-1 rounded button-action-primary hover:bg-green-600 transition-colors",title:"클릭하여 거래명세서 확인 취소",children:ce.config.completedText}):a.jsx(p,{onDateSelect:a=>{ce.handleConfirm(e.id,a,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"회계상 입고일을 선택하세요",align:"end",side:"bottom",children:a.jsx("button",{className:"text-xs px-2 py-1 rounded bg-gray-100 text-gray-600",onClick:()=>{},children:ce.config.waitingText})}):a.jsx("span",{className:"text-xs px-2 py-1 rounded "+(ce.isCompleted(e)?"button-action-primary":"bg-gray-100 text-gray-400"),children:ce.isCompleted(e)?ce.config.completedText:ce.config.waitingText})})]}),!z&&"done"===g&&ce.getCompletedDate(e)&&a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"회계상 입고일:"}),a.jsx("div",{className:"mt-1",children:a.jsx("div",{className:"modal-subtitle text-blue-700",children:new Date(ce.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})})})]}),!z&&"done"===g&&ce.getCompletedByName(e)&&a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"처리자:"}),a.jsx("div",{className:"mt-1",children:a.jsx("div",{className:"modal-subtitle text-gray-600",children:ce.getCompletedByName(e)})})]})]})]},s))]}),a.jsxs("div",{className:"bg-gray-50 px-2 sm:px-3 border-t border-gray-100",children:[a.jsxs("div",{className:"hidden sm:grid items-center gap-3 py-0.5",style:{gridTemplateColumns:z&&Q.length>0?Q.map(e=>`${e}px`).join(" "):"receipt"===g?"minmax(120px, 1fr) minmax(200px, 2fr) minmax(70px, auto) minmax(90px, auto) minmax(100px, auto) minmax(80px, 1fr) minmax(80px, auto) minmax(100px, auto)":"minmax(120px, 1fr) minmax(250px, 2fr) minmax(70px, auto) minmax(90px, auto) minmax(100px, auto) minmax(120px, 1fr) minmax(80px, auto)"},children:[a.jsx("div",{}),a.jsx("div",{}),a.jsx("div",{}),a.jsx("div",{className:"text-right",children:a.jsx("span",{className:"text-[12px] font-bold text-gray-900",children:"총액"})}),a.jsx("div",{className:"text-right",children:a.jsxs("span",{className:"text-[12px] font-bold text-gray-900",children:["₩",ve((z?B:A.items)?.reduce((e,a)=>e+(a.amount_value||0),0)||0)]})}),a.jsx("div",{}),a.jsx("div",{}),"receipt"===g&&a.jsx("div",{})]}),a.jsx("div",{className:"block sm:hidden py-0.5",children:a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsx("span",{className:"text-[13px] font-bold text-gray-900",children:"총액"}),a.jsxs("span",{className:"text-[13px] font-bold text-gray-900",children:["₩",ve((z?B:A.items)?.reduce((e,a)=>e+(a.amount_value||0),0)||0)]})]})})]}),z&&a.jsx("div",{className:"p-2 sm:p-3 border-t border-gray-100",children:a.jsxs(t,{size:"sm",variant:"outline",onClick:()=>{const e={item_name:"",specification:"",quantity:1,unit_price_value:0,amount_value:0,remark:"",line_number:B.length+1};L([...B,e])},className:"w-full rounded-lg border-dashed border-2 border-gray-300 hover:border-gray-400 py-2 badge-text",children:[a.jsx(T,{className:"w-4 h-4 mr-1"}),"항목 추가"]})})]})})]})]}):a.jsx("div",{className:"text-center py-12",children:a.jsx("span",{className:"modal-subtitle",children:"발주 정보를 불러올 수 없습니다."})})});return u?fe:a.jsx(w,{open:s,onOpenChange:o,children:a.jsxs(C,{className:"overflow-hidden bg-white rounded-lg shadow-sm border-0 w-[100vw] h-[100vh] sm:w-auto sm:min-w-[1000px] sm:max-w-none sm:max-h-[90vh] lg:max-h-[85vh] sm:rounded-lg flex flex-col",showCloseButton:!1,children:[a.jsxs("div",{className:"relative px-3 sm:px-6 pt-0 sm:pt-3 lg:pt-4 pb-0 sm:pb-2 lg:pb-3 flex-shrink-0",children:[a.jsx("button",{onClick:o,className:"button-base button-action-secondary absolute right-3 sm:right-6 top-0 sm:top-3 lg:top-4 w-6 h-6 sm:w-8 sm:h-8 rounded-full",children:a.jsx(l,{className:"w-4 h-4 text-gray-500"})}),a.jsx("div",{className:"pr-8 sm:pr-16",children:a.jsxs("div",{className:"flex items-start gap-4 mb-0 sm:mb-3",children:[a.jsx("div",{className:"min-w-0 flex-1",children:a.jsx("h1",{className:"page-title mb-0 sm:mb-1",children:"발주 기본정보"})}),a.jsxs("div",{className:"flex items-center gap-3",children:[!z&&ae&&a.jsxs(a.Fragment,{children:[a.jsxs(t,{size:"sm",variant:"outline",onClick:()=>he(!0),className:"button-base button-action-secondary",children:[a.jsx(j,{className:"w-4 h-4 mr-2"}),"수정"]}),te&&b&&a.jsxs(t,{size:"sm",variant:"outline",onClick:()=>A&&b(A),className:"button-base button-action-danger",children:[a.jsx(D,{className:"w-4 h-4 mr-2"}),"삭제"]})]}),z&&a.jsxs(a.Fragment,{children:[a.jsxs(t,{size:"sm",variant:"outline",onClick:()=>{he(!1),E(A),L(A?.items||[]),H([])},className:"button-base button-action-secondary",children:[a.jsx(l,{className:"w-4 h-4 mr-2"}),"취소"]}),a.jsxs(t,{size:"sm",onClick:async()=>{if(A&&K)try{n.debug("저장 시작",{purchaseId:A.id,editedItemsCount:B.length,deletedItemsCount:U.length});const a=B.reduce((e,a)=>e+(a.amount_value||0),0);n.debug("계산된 총액",{totalAmount:a});const{error:t}=await Z.from("purchase_requests").update({purchase_order_number:K.purchase_order_number||null,requester_name:K.requester_name||null,delivery_request_date:K.delivery_request_date||null,revised_delivery_request_date:K.revised_delivery_request_date||null,payment_category:K.payment_category||null,project_vendor:K.project_vendor||null,total_amount:Number(a),updated_at:(new Date).toISOString()}).eq("id",A.id);if(t)throw t;if(U.length>0){const{error:e}=await Z.from("purchase_request_items").delete().in("id",U);if(e)throw e}n.debug("저장할 editedItems",{count:B.length});for(const e of B){if(n.debug("처리 중인 item",{itemId:e.id,itemName:e.item_name,quantity:e.quantity,unitPrice:e.unit_price_value,amount:e.amount_value}),!e.item_name||!e.item_name.trim())throw new Error("품목명은 필수입니다.");if(!e.quantity||e.quantity<=0)throw new Error("수량은 0보다 커야 합니다.");if(!e.unit_price_value||e.unit_price_value<0)throw new Error("단가는 0 이상이어야 합니다.");if(!e.amount_value||e.amount_value<0)throw new Error("합계는 0 이상이어야 합니다.");if(e.id){n.debug("기존 항목 업데이트",{itemId:e.id});const{error:a}=await Z.from("purchase_request_items").update({item_name:e.item_name.trim(),specification:e.specification||null,quantity:Number(e.quantity),unit_price_value:Number(e.unit_price_value),unit_price_currency:A.currency||"KRW",amount_value:Number(e.amount_value),amount_currency:A.currency||"KRW",remark:e.remark||null,updated_at:(new Date).toISOString()}).eq("id",e.id);if(a)throw n.error("기존 항목 업데이트 오류",a),a}else{n.debug("새 항목 생성",{itemName:e.item_name});const a={purchase_request_id:A.id,item_name:e.item_name.trim(),specification:e.specification||null,quantity:Number(e.quantity),unit_price_value:Number(e.unit_price_value),unit_price_currency:A.currency||"KRW",amount_value:Number(e.amount_value),amount_currency:A.currency||"KRW",remark:e.remark||null,line_number:e.line_number||B.indexOf(e)+1,created_at:(new Date).toISOString()};n.debug("삽입할 데이터",{itemName:a.item_name});const{error:t}=await Z.from("purchase_request_items").insert(a);if(t)throw n.error("새 항목 생성 오류",t),t;n.debug("새 항목 생성 성공")}}n.debug("저장 완료"),y.success("발주 내역이 성공적으로 저장되었습니다."),he(!1),H([]),await ge(e?.toString()||"")}catch(a){n.error("저장 중 전체 오류",a);const e=a instanceof Error?a.message:"알 수 없는 오류가 발생했습니다";y.error(`저장 실패: ${e}`)}else y.error("저장할 데이터가 없습니다.")},className:"button-base button-action-primary",children:[a.jsx(I,{className:"w-4 h-4 mr-2"}),"저장"]})]})]})]})})]}),a.jsx("div",{className:"overflow-y-auto flex-1 px-3 sm:px-6 pb-1 sm:pb-6 mt-0",children:fe})]})})}export{O as P,R as T};
//# sourceMappingURL=PurchaseDetailModal-D7l0D3uU.js.map
