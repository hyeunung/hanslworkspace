{"version":3,"file":"transactionStatementService-CwTePWPx.js","sources":["../../node_modules/lucide-react/dist/esm/icons/circle-check-big.js","../../node_modules/lucide-react/dist/esm/icons/image.js","../../src/types/transactionStatement.ts","../../src/services/transactionStatementService.ts"],"sourcesContent":["/**\n * @license lucide-react v0.541.0 - ISC\n *\n * This source code is licensed under the ISC license.\n * See the LICENSE file in the root directory of this source tree.\n */\n\nimport createLucideIcon from '../createLucideIcon.js';\n\nconst __iconNode = [\n  [\"path\", { d: \"M21.801 10A10 10 0 1 1 17 3.335\", key: \"yps3ct\" }],\n  [\"path\", { d: \"m9 11 3 3L22 4\", key: \"1pflzl\" }]\n];\nconst CircleCheckBig = createLucideIcon(\"circle-check-big\", __iconNode);\n\nexport { __iconNode, CircleCheckBig as default };\n//# sourceMappingURL=circle-check-big.js.map\n","/**\n * @license lucide-react v0.541.0 - ISC\n *\n * This source code is licensed under the ISC license.\n * See the LICENSE file in the root directory of this source tree.\n */\n\nimport createLucideIcon from '../createLucideIcon.js';\n\nconst __iconNode = [\n  [\"rect\", { width: \"18\", height: \"18\", x: \"3\", y: \"3\", rx: \"2\", ry: \"2\", key: \"1m3agn\" }],\n  [\"circle\", { cx: \"9\", cy: \"9\", r: \"2\", key: \"af1f0g\" }],\n  [\"path\", { d: \"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21\", key: \"1xmnt7\" }]\n];\nconst Image = createLucideIcon(\"image\", __iconNode);\n\nexport { __iconNode, Image as default };\n//# sourceMappingURL=image.js.map\n","/**\n * ê±°ë˜ëª…ì„¸ì„œ í™•ì¸ ì‹œìŠ¤í…œ íƒ€ì… ì •ì˜\n */\n\n// ê±°ë˜ëª…ì„¸ì„œ ìƒíƒœ\nexport type TransactionStatementStatus = \n  | 'pending'     // ì—…ë¡œë“œë¨, ì²˜ë¦¬ ëŒ€ê¸°\n  | 'processing'  // OCR ì²˜ë¦¬ ì¤‘\n  | 'extracted'   // ì¶”ì¶œ ì™„ë£Œ, í™•ì¸ ëŒ€ê¸°\n  | 'confirmed'   // í™•ì •ë¨\n  | 'rejected';   // ê±°ë¶€ë¨\n\n// ë§¤ì¹­ ì‹ ë¢°ë„\nexport type MatchConfidence = 'low' | 'med' | 'high';\n\n// ë§¤ì¹­ ë°©ë²•\nexport type MatchMethod = 'po_number' | 'item_similarity' | 'manual';\n\n// ê±°ë˜ëª…ì„¸ì„œ í…Œì´ë¸” íƒ€ì…\nexport interface TransactionStatement {\n  id: string;\n  image_url: string;\n  file_name?: string;\n  uploaded_at: string;\n  uploaded_by?: string;\n  uploaded_by_name?: string;\n  status: TransactionStatementStatus;\n  confirmed_at?: string;\n  confirmed_by?: string;\n  confirmed_by_name?: string;\n  statement_date?: string;\n  vendor_name?: string;\n  total_amount?: number;\n  tax_amount?: number;\n  grand_total?: number;\n  extracted_data?: ExtractedData;\n  extraction_error?: string;\n  created_at: string;\n  updated_at: string;\n}\n\n// ê±°ë˜ëª…ì„¸ì„œ í’ˆëª© íƒ€ì…\nexport interface TransactionStatementItem {\n  id: string;\n  statement_id: string;\n  line_number?: number;\n  extracted_item_name?: string;\n  extracted_specification?: string;\n  extracted_quantity?: number;\n  extracted_unit_price?: number;\n  extracted_amount?: number;\n  extracted_tax_amount?: number;\n  extracted_po_number?: string;\n  extracted_remark?: string;\n  \n  // ë§¤ì¹­ ì •ë³´\n  matched_purchase_id?: number;\n  matched_item_id?: number;\n  match_confidence?: MatchConfidence;\n  match_method?: MatchMethod;\n  \n  // ì¶”ê°€ ê³µì •\n  is_additional_item: boolean;\n  parent_item_id?: string;\n  \n  // í™•ì • ì •ë³´\n  is_confirmed: boolean;\n  confirmed_unit_price?: number;\n  confirmed_amount?: number;\n  confirmed_quantity?: number;\n  \n  created_at: string;\n  updated_at: string;\n}\n\n// OCR êµì • ë°ì´í„° íƒ€ì…\nexport interface OCRCorrection {\n  id: string;\n  statement_id?: string;\n  statement_item_id?: string;\n  original_text: string;\n  corrected_text: string;\n  field_type: OCRFieldType;\n  corrected_by?: string;\n  corrected_by_name?: string;\n  created_at: string;\n}\n\nexport type OCRFieldType = \n  | 'po_number' \n  | 'item_name' \n  | 'quantity' \n  | 'unit_price' \n  | 'amount' \n  | 'date' \n  | 'vendor_name' \n  | 'remark';\n\n// OCR/LLM ì¶”ì¶œ ê²°ê³¼ íƒ€ì…\nexport interface ExtractedItem {\n  line_number: number;\n  item_name: string;\n  specification?: string;\n  quantity: number;\n  unit_price: number;\n  amount: number;\n  tax_amount?: number;\n  po_number?: string;\n  remark?: string;\n  confidence: MatchConfidence;\n}\n\nexport interface ExtractedData {\n  statement_date?: string;\n  vendor_name?: string;\n  total_amount?: number;\n  tax_amount?: number;\n  grand_total?: number;\n  items: ExtractedItem[];\n  raw_vision_text?: string;\n}\n\n// ë°œì£¼ ë§¤ì¹­ í›„ë³´ íƒ€ì…\nexport interface MatchCandidate {\n  purchase_id: number;\n  purchase_order_number: string;\n  sales_order_number?: string;\n  item_id: number;\n  item_name: string;\n  specification?: string;\n  quantity: number;\n  unit_price?: number;\n  vendor_name?: string;\n  score: number; // ë§¤ì¹­ ì ìˆ˜ (0-100)\n  match_reasons: string[]; // ë§¤ì¹­ ì´ìœ \n}\n\n// ê±°ë˜ëª…ì„¸ì„œ ìƒì„¸ (í’ˆëª© í¬í•¨)\nexport interface TransactionStatementWithItems extends TransactionStatement {\n  items: TransactionStatementItemWithMatch[];\n}\n\n// í’ˆëª© + ë§¤ì¹­ í›„ë³´\nexport interface TransactionStatementItemWithMatch extends TransactionStatementItem {\n  match_candidates?: MatchCandidate[];\n  matched_purchase?: {\n    id: number;\n    purchase_order_number: string;\n    sales_order_number?: string;\n    vendor_name?: string;\n  };\n  matched_item?: {\n    id: number;\n    item_name: string;\n    specification?: string;\n    quantity: number;\n    unit_price_value?: number;\n  };\n}\n\n// ì—…ë¡œë“œ ìš”ì²­ íƒ€ì…\nexport interface UploadStatementRequest {\n  file: File;\n}\n\n// ì—…ë¡œë“œ ì‘ë‹µ íƒ€ì…\nexport interface UploadStatementResponse {\n  statementId: string;\n  imageUrl: string;\n}\n\n// OCR ì¶”ì¶œ ìš”ì²­ íƒ€ì…\nexport interface ExtractStatementRequest {\n  statementId: string;\n  imageUrl: string;\n}\n\n// í™•ì • ìš”ì²­ íƒ€ì…\nexport interface ConfirmStatementRequest {\n  statementId: string;\n  items: ConfirmItemRequest[];\n}\n\nexport interface ConfirmItemRequest {\n  itemId: string;\n  matched_purchase_id?: number;\n  matched_item_id?: number;\n  confirmed_quantity?: number;\n  confirmed_unit_price?: number;\n  confirmed_amount?: number;\n  is_additional_item?: boolean;\n  parent_item_id?: string;\n}\n\n// êµì • ì €ì¥ ìš”ì²­ íƒ€ì…\nexport interface SaveCorrectionRequest {\n  statement_id?: string;\n  statement_item_id?: string;\n  original_text: string;\n  corrected_text: string;\n  field_type: OCRFieldType;\n}\n\n// ë°œì£¼ë²ˆí˜¸/ìˆ˜ì£¼ë²ˆí˜¸ íŒ¨í„´\n// ë°œì£¼ë²ˆí˜¸: F + YYYYMMDD + _ + 3ìë¦¬ ìˆ«ì (ì˜ˆ: F20251008_001, F20251008_002)\nexport const PO_NUMBER_PATTERN = /^F\\d{8}_\\d{3}$/;\n// ìˆ˜ì£¼ë²ˆí˜¸: HS + YYYYMMDD + - + 2ìë¦¬ ìˆ«ì (ì˜ˆ: HS20251201-01, HS20251201-11)\nexport const SO_NUMBER_PATTERN = /^HS\\d{8}-\\d{2}$/;\n\n// OCRì—ì„œ ì½ì€ ë²ˆí˜¸ë¥¼ ì‹œìŠ¤í…œ í˜•ì‹ìœ¼ë¡œ ì •ê·œí™”\nexport function normalizeOrderNumber(input: string): string {\n  if (!input) return input;\n  \n  let normalized = input.toUpperCase().replace(/\\s+/g, '');\n  \n  // ë°œì£¼ë²ˆí˜¸ ì •ê·œí™”: F20251008_1 ë˜ëŠ” F20251008_01 â†’ F20251008_001\n  const poMatch = normalized.match(/^(F\\d{8})_(\\d{1,3})$/);\n  if (poMatch) {\n    const [, prefix, num] = poMatch;\n    return `${prefix}_${num.padStart(3, '0')}`;\n  }\n  \n  // ìˆ˜ì£¼ë²ˆí˜¸ ì •ê·œí™”: HS20251201-1 â†’ HS20251201-01\n  const soMatch = normalized.match(/^(HS\\d{8})-(\\d{1,2})$/);\n  if (soMatch) {\n    const [, prefix, num] = soMatch;\n    return `${prefix}-${num.padStart(2, '0')}`;\n  }\n  \n  return normalized;\n}\n\n// íŒ¨í„´ ê²€ì¦ í•¨ìˆ˜\nexport function isValidPoNumber(value: string): boolean {\n  return PO_NUMBER_PATTERN.test(value.toUpperCase());\n}\n\nexport function isValidSoNumber(value: string): boolean {\n  return SO_NUMBER_PATTERN.test(value.toUpperCase());\n}\n\nexport function isValidOrderNumber(value: string): boolean {\n  return isValidPoNumber(value) || isValidSoNumber(value);\n}\n\n// ë²ˆí˜¸ì—ì„œ ë‚ ì§œ ì¶”ì¶œ\nexport function extractDateFromOrderNumber(orderNumber: string): string | null {\n  const match = orderNumber.match(/\\d{8}/);\n  if (!match) return null;\n  \n  const dateStr = match[0];\n  const year = dateStr.substring(0, 4);\n  const month = dateStr.substring(4, 6);\n  const day = dateStr.substring(6, 8);\n  \n  return `${year}-${month}-${day}`;\n}\n\n","/**\n * ê±°ë˜ëª…ì„¸ì„œ í™•ì¸ ì‹œìŠ¤í…œ ì„œë¹„ìŠ¤\n * - ì´ë¯¸ì§€ ì—…ë¡œë“œ\n * - OCR/LLM ì¶”ì¶œ (Edge Function í˜¸ì¶œ)\n * - ë°œì£¼ ë§¤ì¹­\n * - í™•ì • ë° ë°˜ì˜\n * - í•™ìŠµ ë°ì´í„° ì €ì¥\n */\n\nimport { createClient } from \"@/lib/supabase/client\";\nimport type {\n  TransactionStatement,\n  TransactionStatementItem,\n  TransactionStatementWithItems,\n  TransactionStatementItemWithMatch,\n  MatchCandidate,\n  OCRCorrection,\n  ConfirmStatementRequest,\n  SaveCorrectionRequest\n} from \"@/types/transactionStatement\";\nimport { normalizeOrderNumber } from \"@/types/transactionStatement\";\n\nclass TransactionStatementService {\n  private supabase;\n\n  constructor() {\n    this.supabase = createClient();\n  }\n\n  /**\n   * ê±°ë˜ëª…ì„¸ì„œ ì´ë¯¸ì§€ ì—…ë¡œë“œ\n   */\n  async uploadStatement(\n    file: File,\n    uploaderName: string\n  ): Promise<{ success: boolean; data?: { statementId: string; imageUrl: string }; error?: string }> {\n    try {\n      // ê³ ìœ  íŒŒì¼ëª… ìƒì„±\n      const ext = file.name.split('.').pop()?.toLowerCase() || 'png';\n      const uuid = crypto.randomUUID();\n      const fileName = `${uuid}.${ext}`;\n      const storagePath = `Transaction Statement/${fileName}`;\n\n      // Storageì— ì—…ë¡œë“œ\n      const { data: uploadData, error: uploadError } = await this.supabase\n        .storage\n        .from('receipt-images')\n        .upload(storagePath, file, {\n          contentType: file.type,\n          upsert: false\n        });\n\n      if (uploadError) throw uploadError;\n\n      // Public URL ê°€ì ¸ì˜¤ê¸°\n      const { data: urlData } = this.supabase\n        .storage\n        .from('receipt-images')\n        .getPublicUrl(storagePath);\n\n      const imageUrl = urlData.publicUrl;\n\n      // í˜„ì¬ ì‚¬ìš©ì ì •ë³´\n      const { data: { user } } = await this.supabase.auth.getUser();\n\n      // DBì— ë ˆì½”ë“œ ìƒì„±\n      console.log('[Upload] DB ë ˆì½”ë“œ ìƒì„± ì‹œë„:', { imageUrl, fileName: file.name, userId: user?.id });\n      \n      const { data: statement, error: dbError } = await this.supabase\n        .from('transaction_statements')\n        .insert({\n          image_url: imageUrl,\n          file_name: file.name,\n          uploaded_by: user?.id,\n          uploaded_by_name: uploaderName,\n          status: 'pending'\n        })\n        .select()\n        .single();\n\n      if (dbError) {\n        console.error('[Upload] DB insert ì‹¤íŒ¨:', dbError);\n        throw new Error(`DB ì €ì¥ ì‹¤íŒ¨: ${dbError.message} (code: ${dbError.code})`);\n      }\n      \n      console.log('[Upload] DB ë ˆì½”ë“œ ìƒì„± ì„±ê³µ:', { statementId: statement.id });\n\n      return {\n        success: true,\n        data: {\n          statementId: statement.id,\n          imageUrl\n        }\n      };\n    } catch (error) {\n      console.error('Upload statement error:', error);\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : 'ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'\n      };\n    }\n  }\n\n  /**\n   * OCR/LLM ì¶”ì¶œ ì‹¤í–‰ (Edge Function í˜¸ì¶œ)\n   */\n  async extractStatementData(\n    statementId: string,\n    imageUrl: string\n  ): Promise<{ success: boolean; data?: TransactionStatementWithItems; error?: string }> {\n    try {\n      console.log('[Service] Calling Edge Function with:', { statementId, imageUrl });\n      \n      // OCR ì‹œì‘ ì „ ìƒíƒœë¥¼ processingìœ¼ë¡œ ë³€ê²½\n      await this.supabase\n        .from('transaction_statements')\n        .update({ status: 'processing' })\n        .eq('id', statementId);\n      \n      // Edge Function í˜¸ì¶œ\n      const { data, error } = await this.supabase.functions.invoke('ocr-transaction-statement', {\n        body: {\n          statementId,\n          imageUrl\n        }\n      });\n\n      console.log('[Service] Edge Function response:', { data, error });\n\n      if (error) throw error;\n\n      if (!data.success) {\n        throw new Error(data.error || 'OCR ì¶”ì¶œ ì‹¤íŒ¨');\n      }\n\n      // ê±°ë˜ì²˜ëª… í™•ì¸ ë¡œê·¸\n      console.log('[Service] ê±°ë˜ì²˜ ë§¤ì¹­ ê²°ê³¼:', { \n        vendor_name: data.vendor_name, \n        vendor_match_source: data.vendor_match_source \n      });\n\n      // ì¶”ì¶œëœ ë°ì´í„° ì¡°íšŒ\n      const result = await this.getStatementWithItems(statementId);\n      return result;\n    } catch (error) {\n      console.error('[Service] Extract statement error:', error);\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : 'OCR ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'\n      };\n    }\n  }\n\n  /**\n   * ê±°ë˜ëª…ì„¸ì„œ ëª©ë¡ ì¡°íšŒ\n   */\n  async getStatements(filters?: {\n    status?: string;\n    dateFrom?: string;\n    dateTo?: string;\n    search?: string;\n    limit?: number;\n    offset?: number;\n  }): Promise<{ success: boolean; data?: TransactionStatement[]; count?: number; error?: string }> {\n    try {\n      let query = this.supabase\n        .from('transaction_statements')\n        .select('*', { count: 'exact' })\n        .order('uploaded_at', { ascending: false });\n\n      if (filters?.status && filters.status !== 'all') {\n        query = query.eq('status', filters.status);\n      }\n\n      if (filters?.dateFrom) {\n        query = query.gte('uploaded_at', filters.dateFrom);\n      }\n\n      if (filters?.dateTo) {\n        query = query.lte('uploaded_at', filters.dateTo + 'T23:59:59');\n      }\n\n      if (filters?.search) {\n        query = query.or(`vendor_name.ilike.%${filters.search}%,file_name.ilike.%${filters.search}%`);\n      }\n\n      if (filters?.limit) {\n        query = query.limit(filters.limit);\n      }\n\n      if (filters?.offset) {\n        query = query.range(filters.offset, filters.offset + (filters.limit || 20) - 1);\n      }\n\n      const { data, count, error } = await query;\n\n      if (error) throw error;\n\n      return { success: true, data: data || [], count: count || 0 };\n    } catch (error) {\n      console.error('Get statements error:', error);\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : 'ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'\n      };\n    }\n  }\n\n  /**\n   * ê±°ë˜ëª…ì„¸ì„œ ìƒì„¸ ì¡°íšŒ (í’ˆëª© í¬í•¨)\n   */\n  async getStatementWithItems(\n    statementId: string\n  ): Promise<{ success: boolean; data?: TransactionStatementWithItems; error?: string }> {\n    try {\n      // ê±°ë˜ëª…ì„¸ì„œ ì¡°íšŒ\n      const { data: statement, error: stmtError } = await this.supabase\n        .from('transaction_statements')\n        .select('*')\n        .eq('id', statementId)\n        .single();\n\n      if (stmtError) throw stmtError;\n\n      // í’ˆëª© ì¡°íšŒ\n      const { data: items, error: itemsError } = await this.supabase\n        .from('transaction_statement_items')\n        .select('*')\n        .eq('statement_id', statementId)\n        .order('line_number', { ascending: true });\n\n      if (itemsError) throw itemsError;\n\n      // í’ˆëª©ë³„ ë§¤ì¹­ í›„ë³´ ì¡°íšŒ (ê±°ë˜ì²˜ëª…ì„ ì „ë‹¬í•˜ì—¬ í•„í„°ë§)\n      const statementVendorName = statement.vendor_name || '';\n      const itemsWithMatch: TransactionStatementItemWithMatch[] = await Promise.all(\n        (items || []).map(async (item: TransactionStatementItem) => {\n          const matchCandidates = await this.findMatchCandidates(item, statementVendorName);\n          \n          // ë§¤ì¹­ëœ ë°œì£¼/í’ˆëª© ì •ë³´\n          let matchedPurchase = undefined;\n          let matchedItem = undefined;\n          \n          if (item.matched_purchase_id) {\n            const { data: purchase } = await this.supabase\n              .from('purchase_requests')\n              .select('id, purchase_order_number, sales_order_number, vendor:vendors(vendor_name)')\n              .eq('id', item.matched_purchase_id)\n              .single();\n            \n            if (purchase) {\n              matchedPurchase = {\n                id: purchase.id,\n                purchase_order_number: purchase.purchase_order_number || '',\n                sales_order_number: purchase.sales_order_number,\n                vendor_name: purchase.vendor?.vendor_name\n              };\n            }\n          }\n\n          if (item.matched_item_id) {\n            const { data: purchaseItem } = await this.supabase\n              .from('purchase_request_items')\n              .select('id, item_name, specification, quantity, unit_price_value')\n              .eq('id', item.matched_item_id)\n              .single();\n            \n            if (purchaseItem) {\n              matchedItem = {\n                id: purchaseItem.id,\n                item_name: purchaseItem.item_name,\n                specification: purchaseItem.specification,\n                quantity: purchaseItem.quantity,\n                unit_price_value: purchaseItem.unit_price_value\n              };\n            }\n          }\n\n          return {\n            ...item,\n            match_candidates: matchCandidates,\n            matched_purchase: matchedPurchase,\n            matched_item: matchedItem\n          };\n        })\n      );\n\n      return {\n        success: true,\n        data: {\n          ...statement,\n          items: itemsWithMatch\n        }\n      };\n    } catch (error) {\n      console.error('Get statement with items error:', error);\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : 'ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'\n      };\n    }\n  }\n\n  /**\n   * ë°œì£¼ ë§¤ì¹­ í›„ë³´ ì°¾ê¸°\n   * - ë‹¤ì¤‘ ì‹ í˜¸ ë§¤ì¹­: ë°œì£¼ë²ˆí˜¸ + í’ˆëª©ëª… + ìˆ˜ëŸ‰ì„ ëª¨ë‘ ê³ ë ¤\n   * - ë°œì£¼ë²ˆí˜¸ê°€ ë‹¬ë¼ë„ í’ˆëª©ëª…+ìˆ˜ëŸ‰ì´ ë§ìœ¼ë©´ í›„ë³´ì— í¬í•¨\n   * - ê±°ë˜ì²˜ê°€ ì¼ì¹˜/ìœ ì‚¬í•´ì•¼ë§Œ í›„ë³´ì— í¬í•¨ (í•„ìˆ˜ ì¡°ê±´)\n   */\n  async findMatchCandidates(item: TransactionStatementItem, statementVendorName?: string): Promise<MatchCandidate[]> {\n    const candidateMap = new Map<string, MatchCandidate>(); // ì¤‘ë³µ ë°©ì§€ìš©\n\n    try {\n      const rawNumber = item.extracted_po_number || '';\n      const normalizedNumber = rawNumber ? normalizeOrderNumber(rawNumber) : '';\n      \n      // ë¶€ë¶„ ë°œì£¼ë²ˆí˜¸ íŒ¨í„´ ì²´í¬ (F20251212 ë˜ëŠ” HS20251212 - ë’·ë¶€ë¶„ ì—†ì´ ë‚ ì§œë§Œ)\n      const partialPOMatch = rawNumber.toUpperCase().match(/^(F)(\\d{8})$/);\n      const partialSOMatch = rawNumber.toUpperCase().match(/^(HS)(\\d{8})$/);\n      const isPartialNumber = !!(partialPOMatch || partialSOMatch);\n      const datePrefix = partialPOMatch ? `F${partialPOMatch[2]}` : (partialSOMatch ? `HS${partialSOMatch[2]}` : '');\n\n      // 1. PO/SO ë²ˆí˜¸ë¡œ ë§¤ì¹­ ì‹œë„\n      if (normalizedNumber) {\n        const { data: byNumber } = await this.supabase\n          .from('purchase_requests')\n          .select(`\n            id, \n            purchase_order_number, \n            sales_order_number,\n            vendor:vendors(vendor_name),\n            items:purchase_request_items(id, item_name, specification, quantity, unit_price_value)\n          `)\n          .or(`purchase_order_number.eq.${normalizedNumber},sales_order_number.eq.${normalizedNumber}`)\n          .limit(10);\n\n        if (byNumber) {\n          for (const purchase of byNumber) {\n            // ê±°ë˜ì²˜ ìœ ì‚¬ë„ ì²´í¬ (ê±°ë˜ëª…ì„¸ì„œì˜ ê±°ë˜ì²˜ì™€ ì‹œìŠ¤í…œ ë°œì£¼ì˜ ê±°ë˜ì²˜ ë¹„êµ)\n            const sysVendorName = purchase.vendor?.vendor_name || '';\n            const vendorSimilarity = statementVendorName \n              ? this.calculateVendorSimilarity(statementVendorName, sysVendorName)\n              : 100; // ê±°ë˜ì²˜ ì •ë³´ ì—†ìœ¼ë©´ í†µê³¼\n            \n            // ê±°ë˜ì²˜ ìœ ì‚¬ë„ 70% ë¯¸ë§Œì´ë©´ ìŠ¤í‚µ (ê±°ë˜ì²˜ ë‹¤ë¥´ë©´ í›„ë³´ ì œì™¸)\n            if (vendorSimilarity < 50) {\n              console.log(`âŒ ê±°ë˜ì²˜ ë¶ˆì¼ì¹˜ë¡œ ì œì™¸: \"${statementVendorName}\" vs \"${sysVendorName}\" (${vendorSimilarity}%)`);\n              continue;\n            }\n\n            for (const purchaseItem of purchase.items || []) {\n              const key = `${purchase.id}-${purchaseItem.id}`;\n              const matchReasons = ['ë°œì£¼/ìˆ˜ì£¼ë²ˆí˜¸ ì¼ì¹˜'];\n              let score = 50; // ê¸°ë³¸ ë²ˆí˜¸ ë§¤ì¹­ ì ìˆ˜\n              \n              // ê±°ë˜ì²˜ ì¼ì¹˜ ë³´ë„ˆìŠ¤\n              if (vendorSimilarity >= 90) {\n                score += 10;\n                matchReasons.push('ê±°ë˜ì²˜ ì¼ì¹˜');\n              } else if (vendorSimilarity >= 70) {\n                score += 5;\n                matchReasons.push('ê±°ë˜ì²˜ ìœ ì‚¬');\n              }\n              \n              // í’ˆëª©ëª… OR ê·œê²© ìœ ì‚¬ë„ ì¶”ê°€ ì ìˆ˜\n              if (item.extracted_item_name) {\n                const itemMatch = this.calculateItemMatchScore(\n                  item.extracted_item_name, \n                  purchaseItem.item_name, \n                  purchaseItem.specification\n                );\n                score += itemMatch.score * 0.3; // ìµœëŒ€ +30ì \n                if (itemMatch.score >= 80) {\n                  matchReasons.push(itemMatch.matchedField === 'specification' ? 'ê·œê²© ì¼ì¹˜' : 'í’ˆëª©ëª… ì¼ì¹˜');\n                }\n              }\n              \n              // ìˆ˜ëŸ‰ ë¹„êµ: ê°™ìœ¼ë©´ ë³´ë„ˆìŠ¤, ë‹¤ë¥´ë©´ ì•½ê°„ ë‚®ì€ ì ìˆ˜\n              if (item.extracted_quantity && purchaseItem.quantity) {\n                if (item.extracted_quantity === purchaseItem.quantity) {\n                  score += 15;\n                  matchReasons.push(`ìˆ˜ëŸ‰ ì¼ì¹˜ (${item.extracted_quantity})`);\n                } else if (item.extracted_quantity <= purchaseItem.quantity) {\n                  score += 5;\n                  matchReasons.push(`ìˆ˜ëŸ‰ (ìš”ì²­:${purchaseItem.quantity}, ì…ê³ :${item.extracted_quantity})`);\n                }\n              }\n              \n              candidateMap.set(key, {\n                purchase_id: purchase.id,\n                purchase_order_number: purchase.purchase_order_number || '',\n                sales_order_number: purchase.sales_order_number,\n                item_id: purchaseItem.id,\n                item_name: purchaseItem.item_name,\n                specification: purchaseItem.specification,\n                quantity: purchaseItem.quantity,\n                unit_price: purchaseItem.unit_price_value,\n                vendor_name: sysVendorName,\n                score,\n                match_reasons: matchReasons\n              });\n            }\n          }\n        }\n      }\n\n      // 1.5. ë¶€ë¶„ ë°œì£¼ë²ˆí˜¸ë¡œ ê²€ìƒ‰ (F20251212 ë˜ëŠ” HS20251212 - ë’¤ ìˆ«ì ì—†ì´ ë‚ ì§œë§Œ ì íŒ ê²½ìš°)\n      if (isPartialNumber && datePrefix && candidateMap.size === 0) {\n        console.log(`ğŸ“… ë¶€ë¶„ ë°œì£¼ë²ˆí˜¸ ê²€ìƒ‰: \"${datePrefix}%\" (í•´ë‹¹ ë‚ ì§œì˜ ëª¨ë“  ë°œì£¼)`);\n        \n        const { data: byDatePrefix } = await this.supabase\n          .from('purchase_requests')\n          .select(`\n            id, \n            purchase_order_number, \n            sales_order_number,\n            vendor:vendors(vendor_name),\n            items:purchase_request_items(id, item_name, specification, quantity, unit_price_value)\n          `)\n          .or(`purchase_order_number.ilike.${datePrefix}%,sales_order_number.ilike.${datePrefix}%`)\n          .limit(20);\n\n        if (byDatePrefix) {\n          for (const purchase of byDatePrefix) {\n            const sysVendorName = purchase.vendor?.vendor_name || '';\n            const vendorSimilarity = statementVendorName \n              ? this.calculateVendorSimilarity(statementVendorName, sysVendorName)\n              : 100;\n            \n            // ê±°ë˜ì²˜ ìœ ì‚¬ë„ 70% ë¯¸ë§Œì´ë©´ ìŠ¤í‚µ\n            if (vendorSimilarity < 50) {\n              continue;\n            }\n\n            for (const purchaseItem of purchase.items || []) {\n              const key = `${purchase.id}-${purchaseItem.id}`;\n              if (candidateMap.has(key)) continue;\n\n              const matchReasons = [`ë‚ ì§œ ì¼ì¹˜ (${datePrefix})`];\n              let score = 30; // ë‚ ì§œ ë§¤ì¹­ ê¸°ë³¸ ì ìˆ˜\n              \n              // ê±°ë˜ì²˜ ì¼ì¹˜ ë³´ë„ˆìŠ¤\n              if (vendorSimilarity >= 90) {\n                score += 20;\n                matchReasons.push('ê±°ë˜ì²˜ ì¼ì¹˜');\n              } else if (vendorSimilarity >= 70) {\n                score += 10;\n                matchReasons.push('ê±°ë˜ì²˜ ìœ ì‚¬');\n              }\n              \n              // í’ˆëª©ëª… OR ê·œê²© ìœ ì‚¬ë„ ì¶”ê°€ ì ìˆ˜\n              if (item.extracted_item_name) {\n                const itemMatch = this.calculateItemMatchScore(\n                  item.extracted_item_name, \n                  purchaseItem.item_name, \n                  purchaseItem.specification\n                );\n                score += itemMatch.score * 0.4; // ìµœëŒ€ +40ì \n                if (itemMatch.score >= 80) {\n                  matchReasons.push(itemMatch.matchedField === 'specification' ? 'ê·œê²© ì¼ì¹˜' : 'í’ˆëª©ëª… ì¼ì¹˜');\n                } else if (itemMatch.score >= 50) {\n                  matchReasons.push(itemMatch.matchedField === 'specification' ? 'ê·œê²© ìœ ì‚¬' : 'í’ˆëª©ëª… ìœ ì‚¬');\n                }\n              }\n              \n              // ìˆ˜ëŸ‰ ë¹„êµ: ê°™ìœ¼ë©´ ë³´ë„ˆìŠ¤, ë‹¤ë¥´ë©´ ì•½ê°„ ë‚®ì€ ì ìˆ˜\n              if (item.extracted_quantity && purchaseItem.quantity) {\n                if (item.extracted_quantity === purchaseItem.quantity) {\n                  score += 15;\n                  matchReasons.push(`ìˆ˜ëŸ‰ ì¼ì¹˜ (${item.extracted_quantity})`);\n                } else if (item.extracted_quantity <= purchaseItem.quantity) {\n                  score += 5;\n                  matchReasons.push(`ìˆ˜ëŸ‰ (ìš”ì²­:${purchaseItem.quantity}, ì…ê³ :${item.extracted_quantity})`);\n                }\n              }\n              \n              candidateMap.set(key, {\n                purchase_id: purchase.id,\n                purchase_order_number: purchase.purchase_order_number || '',\n                sales_order_number: purchase.sales_order_number,\n                item_id: purchaseItem.id,\n                item_name: purchaseItem.item_name,\n                specification: purchaseItem.specification,\n                quantity: purchaseItem.quantity,\n                unit_price: purchaseItem.unit_price_value,\n                vendor_name: sysVendorName,\n                score,\n                match_reasons: matchReasons\n              });\n            }\n          }\n        }\n      }\n\n      // 2. í’ˆëª©ëª…+ìˆ˜ëŸ‰ìœ¼ë¡œ ë§¤ì¹­ ì‹œë„ (ë°œì£¼ë²ˆí˜¸ê°€ ë‹¬ë¼ë„ ì°¾ê¸°) - item_name AND specification ëª¨ë‘ ê²€ìƒ‰\n      if (item.extracted_item_name) {\n        const itemName = item.extracted_item_name.trim();\n        \n        // ê²€ìƒ‰ì–´ í›„ë³´êµ° ìƒì„± (ê¸´ ê²ƒë¶€í„° ì‹œë„)\n        const searchTermCandidates = [\n          itemName,                                              // ì „ì²´\n          itemName.substring(0, Math.min(itemName.length, 12)),  // 12ê¸€ì\n          itemName.substring(0, Math.min(itemName.length, 8)),   // 8ê¸€ì\n          itemName.split(/[\\[\\]\\s\\-_]/)[0]                        // ì²« ë‹¨ì–´ (íŠ¹ìˆ˜ë¬¸ì ê¸°ì¤€)\n        ].filter(t => t && t.length >= 3);\n        \n        // ì¤‘ë³µ ì œê±°\n        const uniqueSearchTerms = [...new Set(searchTermCandidates)];\n        console.log(`ğŸ” í’ˆëª©ëª… ê²€ìƒ‰ì–´ í›„ë³´: ${uniqueSearchTerms.join(', ')}`);\n        \n        // ê° ê²€ìƒ‰ì–´ë¡œ ê²€ìƒ‰ ì‹œë„ (í•˜ë‚˜ë¼ë„ ì°¾ìœ¼ë©´ ë¨)\n        for (const searchTerm of uniqueSearchTerms) {\n          const { data: byNameOrSpec } = await this.supabase\n            .from('purchase_request_items')\n            .select(`\n              id, \n              item_name, \n              specification, \n              quantity, \n              unit_price_value,\n              purchase:purchase_requests!inner(\n                id, \n                purchase_order_number, \n                sales_order_number,\n                vendor:vendors(vendor_name)\n              )\n            `)\n            .or(`item_name.ilike.%${searchTerm}%,specification.ilike.%${searchTerm}%`)\n            .limit(50);\n          \n          if (byNameOrSpec && byNameOrSpec.length > 0) {\n            console.log(`âœ… ê²€ìƒ‰ì–´ \"${searchTerm}\"ë¡œ ${byNameOrSpec.length}ê°œ í’ˆëª© ë°œê²¬`);\n            \n            for (const purchaseItem of byNameOrSpec) {\n              const key = `${purchaseItem.purchase?.id}-${purchaseItem.id}`;\n              \n              // ì´ë¯¸ ë²ˆí˜¸ ë§¤ì¹­ìœ¼ë¡œ ì¶”ê°€ëœ ê²½ìš° ìŠ¤í‚µ\n              if (candidateMap.has(key)) continue;\n              \n              // ê±°ë˜ì²˜ ìœ ì‚¬ë„ ì²´í¬ - ê±°ë˜ì²˜ ë‹¤ë¥´ë©´ í›„ë³´ì—ì„œ ì œì™¸\n              const sysVendorName = purchaseItem.purchase?.vendor?.vendor_name || '';\n              const vendorSimilarity = statementVendorName \n                ? this.calculateVendorSimilarity(statementVendorName, sysVendorName)\n                : 100; // ê±°ë˜ì²˜ ì •ë³´ ì—†ìœ¼ë©´ í†µê³¼\n              \n              console.log(`ğŸ” í›„ë³´ ê²€í† : OCRê±°ë˜ì²˜=\"${statementVendorName}\" vs ì‹œìŠ¤í…œê±°ë˜ì²˜=\"${sysVendorName}\" â†’ ìœ ì‚¬ë„=${vendorSimilarity}%`);\n              \n              // ê±°ë˜ì²˜ ìœ ì‚¬ë„ 50% ë¯¸ë§Œì´ë©´ ìŠ¤í‚µ (ë” ê´€ëŒ€í•˜ê²Œ - ì•½ê°„ì˜ ì°¨ì´ëŠ” í—ˆìš©)\n              if (vendorSimilarity < 50) {\n                console.log(`âŒ ê±°ë˜ì²˜ ìœ ì‚¬ë„ ${vendorSimilarity}% < 50% ìŠ¤í‚µ`);\n                continue;\n              }\n              \n              const matchReasons: string[] = [];\n              let score = 0;\n              \n              // ê±°ë˜ì²˜ ì¼ì¹˜ ë³´ë„ˆìŠ¤ (ë†’ì€ ì ìˆ˜)\n              if (vendorSimilarity >= 90) {\n                score += 20;\n                matchReasons.push('ê±°ë˜ì²˜ ì¼ì¹˜');\n              } else if (vendorSimilarity >= 70) {\n                score += 10;\n                matchReasons.push('ê±°ë˜ì²˜ ìœ ì‚¬');\n              }\n              \n              // í’ˆëª©ëª… OR ê·œê²© ìœ ì‚¬ë„ ì ìˆ˜ - í•µì‹¬ ë§¤ì¹­ ê¸°ì¤€\n              const itemMatch = this.calculateItemMatchScore(\n                item.extracted_item_name, \n                purchaseItem.item_name, \n                purchaseItem.specification\n              );\n              if (itemMatch.score >= 30) { // 30% ì´ìƒì´ë©´ ì ìˆ˜ ë¶€ì—¬ (ë” ê´€ëŒ€í•˜ê²Œ)\n                score += itemMatch.score * 0.7; // ìµœëŒ€ 70ì  (ê°€ì¤‘ì¹˜ ì¦ê°€)\n                if (itemMatch.score >= 80) {\n                  matchReasons.push(itemMatch.matchedField === 'specification' ? 'ê·œê²© ì¼ì¹˜' : 'í’ˆëª©ëª… ì¼ì¹˜');\n                } else if (itemMatch.score >= 50) {\n                  matchReasons.push(itemMatch.matchedField === 'specification' ? 'ê·œê²© ìœ ì‚¬' : 'í’ˆëª©ëª… ìœ ì‚¬');\n                } else {\n                  matchReasons.push('í’ˆëª© ë¶€ë¶„ì¼ì¹˜');\n                }\n              }\n              \n              // ìˆ˜ëŸ‰ ë¹„êµ: ê°™ìœ¼ë©´ ë³´ë„ˆìŠ¤, ë‹¤ë¥´ë©´ ì•½ê°„ ë‚®ì€ ì ìˆ˜ (ì™„ì „ ì œì™¸ëŠ” ì•ˆí•¨)\n              if (item.extracted_quantity && purchaseItem.quantity) {\n                if (item.extracted_quantity === purchaseItem.quantity) {\n                  score += 15; // ìˆ˜ëŸ‰ ì¼ì¹˜ ë³´ë„ˆìŠ¤\n                  matchReasons.push(`ìˆ˜ëŸ‰ ì¼ì¹˜ (${item.extracted_quantity})`);\n                } else if (item.extracted_quantity <= purchaseItem.quantity) {\n                  // ë°°ì†¡ ìˆ˜ëŸ‰ì´ ìš”ì²­ë³´ë‹¤ ì ì€ ê²½ìš° - í”í•œ ì¼€ì´ìŠ¤ì´ë¯€ë¡œ ì‘ì€ ë³´ë„ˆìŠ¤\n                  score += 5;\n                  matchReasons.push(`ìˆ˜ëŸ‰ (ìš”ì²­:${purchaseItem.quantity}, ì…ê³ :${item.extracted_quantity})`);\n                }\n                // ìˆ˜ëŸ‰ì´ ìš”ì²­ë³´ë‹¤ ë§ìœ¼ë©´ ì ìˆ˜ 0 (ì´ìƒí•œ ì¼€ì´ìŠ¤)\n              }\n              \n              // ë°œì£¼ë²ˆí˜¸ê°€ ë‹¤ë¥´ë©´ í‘œì‹œ + OCR ì˜¤ë¥˜ ê°€ëŠ¥ì„± í‘œì‹œ\n              const sysPO = purchaseItem.purchase?.purchase_order_number || '';\n              const sysSO = purchaseItem.purchase?.sales_order_number || '';\n              if (normalizedNumber && sysPO !== normalizedNumber && sysSO !== normalizedNumber) {\n                matchReasons.push(`âš ï¸ OCR ì˜¤ë¥˜ ê°€ëŠ¥: ${normalizedNumber} â†’ ${sysPO || sysSO}`);\n              }\n              \n              console.log(`ğŸ“Š ì ìˆ˜ ê³„ì‚°: score=${score}ì , í’ˆëª©=\"${purchaseItem.item_name}\", ê·œê²©=\"${purchaseItem.specification}\", ë°œì£¼=\"${purchaseItem.purchase?.purchase_order_number}\"`);\n              \n              // ì ìˆ˜ê°€ 15ì  ì´ìƒì´ë©´ í›„ë³´ì— ì¶”ê°€ (ë” ê´€ëŒ€í•œ ì„ê³„ê°’ - í’ˆëª©ëª…ë§Œ ìœ ì‚¬í•´ë„ í›„ë³´ë¡œ)\n              if (score >= 15) {\n                console.log(`âœ… í›„ë³´ ì¶”ê°€! score=${score}ì `);\n                candidateMap.set(key, {\n                  purchase_id: purchaseItem.purchase?.id,\n                  purchase_order_number: sysPO,\n                  sales_order_number: sysSO,\n                  item_id: purchaseItem.id,\n                  item_name: purchaseItem.item_name,\n                  specification: purchaseItem.specification,\n                  quantity: purchaseItem.quantity,\n                  unit_price: purchaseItem.unit_price_value,\n                  vendor_name: purchaseItem.purchase?.vendor?.vendor_name,\n                  score,\n                  match_reasons: matchReasons\n                });\n              }\n            }\n            \n            // ì¶©ë¶„í•œ í›„ë³´ë¥¼ ì°¾ì•˜ìœ¼ë©´ ë” ì´ìƒ ê²€ìƒ‰ ì•ˆí•¨\n            if (candidateMap.size >= 5) break;\n          }\n        }\n      }\n\n      // 3. í’ˆëª©ëª… ìœ ì‚¬ë„ 60% ì´ìƒì¸ ê³ í’ˆì§ˆ í›„ë³´ê°€ ì—†ìœ¼ë©´ ê±°ë˜ì²˜ì˜ ìµœê·¼ ë°œì£¼ì—ì„œ ê²€ìƒ‰ (fallback)\n      // ì¡°ê±´: í›„ë³´ê°€ ì•„ì˜ˆ ì—†ê±°ë‚˜, ìˆë”ë¼ë„ ì ìˆ˜ê°€ ë‚®ìœ¼ë©´(40ì  ë¯¸ë§Œ) ì¶”ê°€ ê²€ìƒ‰\n      const hasHighQualityCandidate = Array.from(candidateMap.values()).some(c => c.score >= 40);\n      const needsFallback = candidateMap.size === 0 || !hasHighQualityCandidate;\n      \n      if (needsFallback && statementVendorName) {\n        console.log(`âš ï¸ ê³ í’ˆì§ˆ í›„ë³´ ì—†ìŒ - ê±°ë˜ì²˜ \"${statementVendorName}\"ì˜ ìµœê·¼ ë°œì£¼ì—ì„œ ê²€ìƒ‰ ì‹œë„ (í˜„ì¬ í›„ë³´: ${candidateMap.size}ê°œ, ìµœê³ ì : ${Math.max(...Array.from(candidateMap.values()).map(c => c.score), 0)}ì )`);\n        \n        // ê±°ë˜ì²˜ëª…ìœ¼ë¡œ vendor_id ì°¾ê¸°\n        const { data: vendors } = await this.supabase\n          .from('vendors')\n          .select('id, vendor_name')\n          .limit(100);\n\n        if (vendors) {\n          // ìœ ì‚¬ë„ ë†’ì€ ê±°ë˜ì²˜ ì°¾ê¸°\n          const matchedVendors = vendors.filter((v: { id: number; vendor_name: string }) => \n            this.calculateVendorSimilarity(statementVendorName, v.vendor_name) >= 70\n          );\n\n          if (matchedVendors.length > 0) {\n            const vendorIds = matchedVendors.map((v: { id: number; vendor_name: string }) => v.id);\n            \n            // í•´ë‹¹ ê±°ë˜ì²˜ì˜ ìµœê·¼ 3ê°œì›” ë°œì£¼ ì¡°íšŒ\n            const threeMonthsAgo = new Date();\n            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);\n\n            const { data: recentPurchases } = await this.supabase\n              .from('purchase_requests')\n              .select(`\n                id, \n                purchase_order_number, \n                sales_order_number,\n                vendor:vendors(vendor_name),\n                items:purchase_request_items(id, item_name, specification, quantity, unit_price_value)\n              `)\n              .in('vendor_id', vendorIds)\n              .gte('created_at', threeMonthsAgo.toISOString())\n              .order('created_at', { ascending: false })\n              .limit(30);\n\n            if (recentPurchases) {\n              for (const purchase of recentPurchases) {\n                const sysVendorName = purchase.vendor?.vendor_name || '';\n                \n                for (const purchaseItem of purchase.items || []) {\n                  const key = `${purchase.id}-${purchaseItem.id}`;\n                  if (candidateMap.has(key)) continue;\n\n                  const matchReasons: string[] = ['ê±°ë˜ì²˜ ì¼ì¹˜'];\n                  let score = 20; // ê±°ë˜ì²˜ ì¼ì¹˜ ê¸°ë³¸ì \n                  \n                  // í’ˆëª©ëª… OR ê·œê²© ìœ ì‚¬ë„\n                  if (item.extracted_item_name) {\n                    const itemMatch = this.calculateItemMatchScore(\n                      item.extracted_item_name, \n                      purchaseItem.item_name, \n                      purchaseItem.specification\n                    );\n                    if (itemMatch.score >= 30) {\n                      score += itemMatch.score * 0.5;\n                      if (itemMatch.score >= 80) {\n                        matchReasons.push(itemMatch.matchedField === 'specification' ? 'ê·œê²© ì¼ì¹˜' : 'í’ˆëª©ëª… ì¼ì¹˜');\n                      } else if (itemMatch.score >= 50) {\n                        matchReasons.push(itemMatch.matchedField === 'specification' ? 'ê·œê²© ìœ ì‚¬' : 'í’ˆëª©ëª… ìœ ì‚¬');\n                      }\n                    }\n                  }\n                  \n                  // ìˆ˜ëŸ‰ ë¹„êµ: ê°™ìœ¼ë©´ ë³´ë„ˆìŠ¤, ë‹¤ë¥´ë©´ ì•½ê°„ ë‚®ì€ ì ìˆ˜\n                  if (item.extracted_quantity && purchaseItem.quantity) {\n                    if (item.extracted_quantity === purchaseItem.quantity) {\n                      score += 15;\n                      matchReasons.push(`ìˆ˜ëŸ‰ ì¼ì¹˜ (${item.extracted_quantity})`);\n                    } else if (item.extracted_quantity <= purchaseItem.quantity) {\n                      score += 5;\n                      matchReasons.push(`ìˆ˜ëŸ‰ (ìš”ì²­:${purchaseItem.quantity}, ì…ê³ :${item.extracted_quantity})`);\n                    }\n                  }\n                  \n                  // OCR ì˜¤ë¥˜ ê°€ëŠ¥ì„± í‘œì‹œ\n                  const sysPO = purchase.purchase_order_number || '';\n                  const sysSO = purchase.sales_order_number || '';\n                  if (normalizedNumber) {\n                    matchReasons.push(`âš ï¸ OCR ì˜¤ë¥˜ ê°€ëŠ¥: ${normalizedNumber} â†’ ${sysPO || sysSO}`);\n                  }\n                  \n                  // ì ìˆ˜ 15ì  ì´ìƒì´ë©´ í›„ë³´ì— ì¶”ê°€ (ë” ê´€ëŒ€í•˜ê²Œ)\n                  if (score >= 15) {\n                    candidateMap.set(key, {\n                      purchase_id: purchase.id,\n                      purchase_order_number: sysPO,\n                      sales_order_number: sysSO,\n                      item_id: purchaseItem.id,\n                      item_name: purchaseItem.item_name,\n                      specification: purchaseItem.specification,\n                      quantity: purchaseItem.quantity,\n                      unit_price: purchaseItem.unit_price_value,\n                      vendor_name: sysVendorName,\n                      score,\n                      match_reasons: matchReasons\n                    });\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n\n      // ì ìˆ˜ìˆœ ì •ë ¬\n      const candidates = Array.from(candidateMap.values());\n      candidates.sort((a, b) => b.score - a.score);\n\n      console.log(`ğŸ¯ findMatchCandidates ì™„ë£Œ: OCRí’ˆëª©=\"${item.extracted_item_name}\" â†’ ${candidates.length}ê°œ í›„ë³´ ë°œê²¬`);\n      if (candidates.length > 0) {\n        console.log(`   ìµœê³ ì  í›„ë³´: \"${candidates[0].item_name}\" (${candidates[0].purchase_order_number}) score=${candidates[0].score}`);\n      }\n\n      return candidates.slice(0, 15); // ìƒìœ„ 15ê°œ ë°˜í™˜\n    } catch (error) {\n      console.error('Find match candidates error:', error);\n      return [];\n    }\n  }\n  \n  /**\n   * í’ˆëª©ëª… ìœ ì‚¬ë„ ê³„ì‚° (0-100)\n   */\n  private calculateNameSimilarity(name1: string, name2: string): number {\n    const s1 = name1.toLowerCase().replace(/\\s+/g, '');\n    const s2 = name2.toLowerCase().replace(/\\s+/g, '');\n    \n    if (!s1 || !s2) return 0;\n    if (s1 === s2) return 100;\n    \n    // í¬í•¨ ê´€ê³„\n    if (s1.includes(s2) || s2.includes(s1)) {\n      return 80;\n    }\n    \n    // Levenshtein distance ê¸°ë°˜ ìœ ì‚¬ë„\n    const maxLen = Math.max(s1.length, s2.length);\n    const distance = this.levenshteinDistance(s1, s2);\n    const similarity = ((maxLen - distance) / maxLen) * 100;\n    \n    return Math.round(similarity);\n  }\n\n  /**\n   * í’ˆëª© ë§¤ì¹­ ì ìˆ˜ ê³„ì‚° (í’ˆëª©ëª… OR ê·œê²©)\n   * OCR ì¶”ì¶œê°’ì„ ì‹œìŠ¤í…œì˜ item_name ë˜ëŠ” specificationê³¼ ë¹„êµ\n   * ë‘˜ ì¤‘ ë†’ì€ ì ìˆ˜ ë°˜í™˜\n   */\n  private calculateItemMatchScore(\n    ocrItemName: string,\n    systemItemName: string,\n    systemSpecification?: string\n  ): { score: number; matchedField: 'item_name' | 'specification' | 'none' } {\n    if (!ocrItemName) {\n      return { score: 0, matchedField: 'none' };\n    }\n\n    // í’ˆëª©ëª…ê³¼ ë¹„êµ\n    const itemNameScore = systemItemName \n      ? this.calculateNameSimilarity(ocrItemName, systemItemName) \n      : 0;\n    \n    // ê·œê²©ê³¼ ë¹„êµ\n    const specScore = systemSpecification \n      ? this.calculateNameSimilarity(ocrItemName, systemSpecification) \n      : 0;\n\n    // ë‘˜ ì¤‘ ë†’ì€ ì ìˆ˜ ë°˜í™˜\n    if (itemNameScore >= specScore) {\n      return { \n        score: itemNameScore, \n        matchedField: itemNameScore > 0 ? 'item_name' : 'none' \n      };\n    } else {\n      return { \n        score: specScore, \n        matchedField: specScore > 0 ? 'specification' : 'none' \n      };\n    }\n  }\n\n  /**\n   * ê±°ë˜ì²˜ëª… ìœ ì‚¬ë„ ê³„ì‚° (0-100)\n   * - (ì£¼), ì£¼ì‹íšŒì‚¬, ãˆœ ë“± ì œê±° í›„ ë¹„êµ\n   * - ê³µë°±, íŠ¹ìˆ˜ë¬¸ì ì œê±°\n   * - ì˜ì–´ â†” í•œê¸€ ìŒì—­ ì§€ì›\n   */\n  private calculateVendorSimilarity(vendor1: string, vendor2: string): number {\n    if (!vendor1 || !vendor2) return 0;\n    \n    // ì •ê·œí™”: íšŒì‚¬ ì ‘ë‘ì–´/ì ‘ë¯¸ì–´ ì œê±°\n    const normalize = (name: string) => {\n      return name\n        .toLowerCase()\n        .replace(/\\(ì£¼\\)|ì£¼ì‹íšŒì‚¬|ãˆœ|ì£¼\\)|ì£¼|co\\.|co,|ltd\\.|ltd|inc\\.|inc|corp\\.|corp|company|ì»´í¼ë‹ˆ/gi, '')\n        .replace(/[^a-z0-9ê°€-í£]/g, '') // íŠ¹ìˆ˜ë¬¸ì, ê³µë°± ì œê±°\n        .trim();\n    };\n\n    const n1 = normalize(vendor1);\n    const n2 = normalize(vendor2);\n\n    if (!n1 || !n2) return 0;\n    if (n1 === n2) return 100;\n\n    // í¬í•¨ ê´€ê³„\n    if (n1.includes(n2) || n2.includes(n1)) {\n      return 90;\n    }\n\n    // ì˜ì–´ â†” í•œê¸€ ìŒì—­ ë§¤í•‘\n    const translitMap: Record<string, string[]> = {\n      'yg': ['ì™€ì´ì§€', 'yg'],\n      'ì™€ì´ì§€': ['yg', 'ì™€ì´ì§€'],\n      'tech': ['í…Œí¬', 'í…', 'tech'],\n      'í…Œí¬': ['tech', 'í…', 'í…Œí¬'],\n      'í…': ['tech', 'í…Œí¬', 'í…'],\n      'high': ['í•˜ì´', 'high'],\n      'í•˜ì´': ['high', 'í•˜ì´'],\n      'korea': ['ì½”ë¦¬ì•„', 'í•œêµ­', 'korea'],\n      'ì½”ë¦¬ì•„': ['korea', 'í•œêµ­', 'ì½”ë¦¬ì•„'],\n      'electric': ['ì „ê¸°', 'ì¼ë ‰íŠ¸ë¦­', 'electric'],\n      'ì „ê¸°': ['electric', 'ì¼ë ‰íŠ¸ë¦­', 'ì „ê¸°'],\n      'steel': ['ìŠ¤í‹¸', 'ì² ê°•', 'steel'],\n      'ìŠ¤í‹¸': ['steel', 'ì² ê°•', 'ìŠ¤í‹¸'],\n      'metal': ['ë©”íƒˆ', 'ê¸ˆì†', 'metal'],\n      'ë©”íƒˆ': ['metal', 'ê¸ˆì†', 'ë©”íƒˆ'],\n      'system': ['ì‹œìŠ¤í…œ', 'system'],\n      'ì‹œìŠ¤í…œ': ['system', 'ì‹œìŠ¤í…œ'],\n      'soft': ['ì†Œí”„íŠ¸', 'soft'],\n      'ì†Œí”„íŠ¸': ['soft', 'ì†Œí”„íŠ¸'],\n      'net': ['ë„·', 'net'],\n      'ë„·': ['net', 'ë„·'],\n      'global': ['ê¸€ë¡œë²Œ', 'global'],\n      'ê¸€ë¡œë²Œ': ['global', 'ê¸€ë¡œë²Œ'],\n      'trade': ['íŠ¸ë ˆì´ë“œ', 'ë¬´ì—­', 'trade'],\n      'íŠ¸ë ˆì´ë“œ': ['trade', 'ë¬´ì—­', 'íŠ¸ë ˆì´ë“œ'],\n      'international': ['ì¸í„°ë‚´ì…”ë„', 'international'],\n      'ì¸í„°ë‚´ì…”ë„': ['international', 'ì¸í„°ë‚´ì…”ë„'],\n    };\n\n    // ìŒì—­ ì¹˜í™˜ í›„ ë¹„êµ\n    let n1Replaced = n1;\n    let n2Replaced = n2;\n    \n    for (const [key, values] of Object.entries(translitMap)) {\n      if (n1.includes(key)) {\n        for (const val of values) {\n          n1Replaced = n1Replaced.replace(key, val);\n          if (n1Replaced === n2 || n2.includes(n1Replaced) || n1Replaced.includes(n2)) {\n            return 85;\n          }\n        }\n        n1Replaced = n1; // ë¦¬ì…‹\n      }\n      if (n2.includes(key)) {\n        for (const val of values) {\n          n2Replaced = n2Replaced.replace(key, val);\n          if (n1 === n2Replaced || n1.includes(n2Replaced) || n2Replaced.includes(n1)) {\n            return 85;\n          }\n        }\n        n2Replaced = n2; // ë¦¬ì…‹\n      }\n    }\n\n    // Levenshtein ê±°ë¦¬ ê¸°ë°˜ ìœ ì‚¬ë„\n    const maxLen = Math.max(n1.length, n2.length);\n    const distance = this.levenshteinDistance(n1, n2);\n    const similarity = ((maxLen - distance) / maxLen) * 100;\n\n    return Math.round(similarity);\n  }\n\n  /**\n   * ê±°ë˜ì²˜ ë§¤ì¹­ ì—¬ë¶€ í™•ì¸ (70% ì´ìƒì´ë©´ ë™ì¼ ê±°ë˜ì²˜ë¡œ ê°„ì£¼)\n   */\n  isVendorMatch(vendor1: string, vendor2: string, threshold: number = 70): boolean {\n    return this.calculateVendorSimilarity(vendor1, vendor2) >= threshold;\n  }\n  \n  /**\n   * Levenshtein ê±°ë¦¬ ê³„ì‚°\n   */\n  private levenshteinDistance(s1: string, s2: string): number {\n    const m = s1.length;\n    const n = s2.length;\n    const dp: number[][] = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));\n    \n    for (let i = 0; i <= m; i++) dp[i][0] = i;\n    for (let j = 0; j <= n; j++) dp[0][j] = j;\n    \n    for (let i = 1; i <= m; i++) {\n      for (let j = 1; j <= n; j++) {\n        if (s1[i - 1] === s2[j - 1]) {\n          dp[i][j] = dp[i - 1][j - 1];\n        } else {\n          dp[i][j] = Math.min(dp[i - 1][j - 1], dp[i - 1][j], dp[i][j - 1]) + 1;\n        }\n      }\n    }\n    \n    return dp[m][n];\n  }\n\n  /**\n   * ìœ ì‚¬ë„ ì ìˆ˜ ê³„ì‚° - í’ˆëª©ëª…/ê·œê²© êµì°¨ ë¹„êµ ì§€ì›\n   */\n  private calculateSimilarityScore(\n    extractedItem: TransactionStatementItem,\n    purchaseItem: any\n  ): number {\n    let score = 0;\n\n    // í’ˆëª©ëª… ìœ ì‚¬ë„ (ìµœëŒ€ 40ì ) - item_nameê³¼ specification ëª¨ë‘ ë¹„êµ í›„ ë†’ì€ ì ìˆ˜ ì‚¬ìš©\n    if (extractedItem.extracted_item_name) {\n      const itemMatch = this.calculateItemMatchScore(\n        extractedItem.extracted_item_name,\n        purchaseItem.item_name || '',\n        purchaseItem.specification || ''\n      );\n      score += itemMatch.score * 0.4; // ìµœëŒ€ 40ì \n    }\n\n    // OCR ì¶”ì¶œ ê·œê²©ë„ êµì°¨ ë¹„êµ (ìµœëŒ€ 20ì )\n    if (extractedItem.extracted_specification) {\n      const specMatch = this.calculateItemMatchScore(\n        extractedItem.extracted_specification,\n        purchaseItem.item_name || '',\n        purchaseItem.specification || ''\n      );\n      score += specMatch.score * 0.2; // ìµœëŒ€ 20ì \n    }\n\n    // ìˆ˜ëŸ‰ ê·¼ì ‘ë„ (ìµœëŒ€ 20ì )\n    if (extractedItem.extracted_quantity && purchaseItem.quantity) {\n      const diff = Math.abs(extractedItem.extracted_quantity - purchaseItem.quantity);\n      if (diff === 0) {\n        score += 20;\n      } else if (diff <= purchaseItem.quantity * 0.1) {\n        score += 15;\n      } else if (diff <= purchaseItem.quantity * 0.2) {\n        score += 10;\n      }\n    }\n\n    // ë‹¨ê°€ ê·¼ì ‘ë„ (ìµœëŒ€ 20ì )\n    if (extractedItem.extracted_unit_price && purchaseItem.unit_price_value) {\n      const diff = Math.abs(extractedItem.extracted_unit_price - purchaseItem.unit_price_value);\n      if (diff === 0) {\n        score += 20;\n      } else if (diff <= purchaseItem.unit_price_value * 0.05) {\n        score += 15;\n      } else if (diff <= purchaseItem.unit_price_value * 0.1) {\n        score += 10;\n      }\n    }\n\n    return score;\n  }\n\n  /**\n   * ë§¤ì¹­ ì´ìœ  ìƒì„± - í’ˆëª©ëª…/ê·œê²© êµì°¨ ë¹„êµ ì§€ì›\n   */\n  private getMatchReasons(\n    extractedItem: TransactionStatementItem,\n    purchaseItem: any,\n    score: number\n  ): string[] {\n    const reasons: string[] = [];\n\n    // í’ˆëª©ëª… êµì°¨ ë¹„êµ (item_nameê³¼ specification ëª¨ë‘ í™•ì¸)\n    if (extractedItem.extracted_item_name) {\n      const itemMatch = this.calculateItemMatchScore(\n        extractedItem.extracted_item_name,\n        purchaseItem.item_name || '',\n        purchaseItem.specification || ''\n      );\n      \n      if (itemMatch.score >= 90) {\n        reasons.push(itemMatch.matchedField === 'specification' ? 'ê·œê²© ì™„ì „ ì¼ì¹˜' : 'í’ˆëª©ëª… ì™„ì „ ì¼ì¹˜');\n      } else if (itemMatch.score >= 70) {\n        reasons.push(itemMatch.matchedField === 'specification' ? 'ê·œê²© ë†’ì€ ìœ ì‚¬ë„' : 'í’ˆëª©ëª… ë†’ì€ ìœ ì‚¬ë„');\n      } else if (itemMatch.score >= 50) {\n        reasons.push(itemMatch.matchedField === 'specification' ? 'ê·œê²© ë¶€ë¶„ ì¼ì¹˜' : 'í’ˆëª©ëª… ë¶€ë¶„ ì¼ì¹˜');\n      }\n    }\n\n    // ìˆ˜ëŸ‰ ë¹„êµ í‘œì‹œ\n    if (extractedItem.extracted_quantity && purchaseItem.quantity) {\n      if (extractedItem.extracted_quantity === purchaseItem.quantity) {\n        reasons.push(`ìˆ˜ëŸ‰ ì¼ì¹˜ (${extractedItem.extracted_quantity})`);\n      } else if (extractedItem.extracted_quantity <= purchaseItem.quantity) {\n        reasons.push(`ìˆ˜ëŸ‰ (ìš”ì²­:${purchaseItem.quantity}, ì…ê³ :${extractedItem.extracted_quantity})`);\n      }\n    }\n\n    if (extractedItem.extracted_unit_price === purchaseItem.unit_price_value) {\n      reasons.push('ë‹¨ê°€ ì¼ì¹˜');\n    }\n\n    if (score >= 70) {\n      reasons.push('ë†’ì€ ìœ ì‚¬ë„');\n    } else if (score >= 50) {\n      reasons.push('ë³´í†µ ìœ ì‚¬ë„');\n    }\n\n    return reasons;\n  }\n\n  /**\n   * í’ˆëª© ë§¤ì¹­ ì—…ë°ì´íŠ¸\n   */\n  async updateItemMatch(\n    itemId: string,\n    matchedPurchaseId: number | null,\n    matchedItemId: number | null,\n    matchMethod: 'po_number' | 'item_similarity' | 'manual' = 'manual'\n  ): Promise<{ success: boolean; error?: string }> {\n    try {\n      const { error } = await this.supabase\n        .from('transaction_statement_items')\n        .update({\n          matched_purchase_id: matchedPurchaseId,\n          matched_item_id: matchedItemId,\n          match_method: matchMethod\n        })\n        .eq('id', itemId);\n\n      if (error) throw error;\n\n      return { success: true };\n    } catch (error) {\n      console.error('Update item match error:', error);\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : 'ë§¤ì¹­ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'\n      };\n    }\n  }\n\n  /**\n   * ê±°ë˜ëª…ì„¸ì„œ í™•ì •\n   */\n  async confirmStatement(\n    request: ConfirmStatementRequest,\n    confirmerName: string\n  ): Promise<{ success: boolean; error?: string }> {\n    try {\n      const { data: { user } } = await this.supabase.auth.getUser();\n\n      // 1. í’ˆëª©ë³„ í™•ì • ì²˜ë¦¬\n      for (const item of request.items) {\n        // í’ˆëª© í™•ì • ìƒíƒœ ì—…ë°ì´íŠ¸\n        const { error: itemError } = await this.supabase\n          .from('transaction_statement_items')\n          .update({\n            is_confirmed: true,\n            matched_purchase_id: item.matched_purchase_id,\n            matched_item_id: item.matched_item_id,\n            confirmed_quantity: item.confirmed_quantity,\n            confirmed_unit_price: item.confirmed_unit_price,\n            confirmed_amount: item.confirmed_amount,\n            is_additional_item: item.is_additional_item || false,\n            parent_item_id: item.parent_item_id\n          })\n          .eq('id', item.itemId);\n\n        if (itemError) throw itemError;\n\n        // 2. ë°œì£¼ í’ˆëª©ì— ë‹¨ê°€/ê¸ˆì•¡ ë°˜ì˜\n        if (item.matched_item_id && item.confirmed_unit_price !== undefined) {\n          const { error: purchaseError } = await this.supabase\n            .from('purchase_request_items')\n            .update({\n              unit_price_value: item.confirmed_unit_price,\n              amount_value: item.confirmed_amount\n            })\n            .eq('id', item.matched_item_id);\n\n          if (purchaseError) {\n            console.warn('Failed to update purchase item:', purchaseError);\n          }\n        }\n\n        // 3. ì¶”ê°€ ê³µì • ì²˜ë¦¬ (ìƒˆ í’ˆëª© ì‚½ì…)\n        if (item.is_additional_item && item.matched_purchase_id && !item.matched_item_id) {\n          const statementItem = await this.getStatementItem(item.itemId);\n          if (statementItem) {\n            const { error: insertError } = await this.supabase\n              .from('purchase_request_items')\n              .insert({\n                purchase_request_id: item.matched_purchase_id,\n                item_name: statementItem.extracted_item_name || 'ì¶”ê°€ ê³µì •',\n                specification: statementItem.extracted_specification,\n                quantity: item.confirmed_quantity || statementItem.extracted_quantity || 1,\n                unit_price_value: item.confirmed_unit_price || statementItem.extracted_unit_price,\n                amount_value: item.confirmed_amount || statementItem.extracted_amount,\n                remark: 'ê±°ë˜ëª…ì„¸ì„œì—ì„œ ì¶”ê°€ë¨'\n              });\n\n            if (insertError) {\n              console.warn('Failed to insert additional item:', insertError);\n            }\n          }\n        }\n      }\n\n      // 4. ê±°ë˜ëª…ì„¸ì„œ ìƒíƒœë¥¼ confirmedë¡œ ë³€ê²½\n      const { error: stmtError } = await this.supabase\n        .from('transaction_statements')\n        .update({\n          status: 'confirmed',\n          confirmed_at: new Date().toISOString(),\n          confirmed_by: user?.id,\n          confirmed_by_name: confirmerName\n        })\n        .eq('id', request.statementId);\n\n      if (stmtError) throw stmtError;\n\n      return { success: true };\n    } catch (error) {\n      console.error('Confirm statement error:', error);\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : 'í™•ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'\n      };\n    }\n  }\n\n  /**\n   * í’ˆëª© ë‹¨ì¼ ì¡°íšŒ\n   */\n  private async getStatementItem(itemId: string): Promise<TransactionStatementItem | null> {\n    const { data } = await this.supabase\n      .from('transaction_statement_items')\n      .select('*')\n      .eq('id', itemId)\n      .single();\n    \n    return data;\n  }\n\n  /**\n   * ê±°ë˜ëª…ì„¸ì„œ ê±°ë¶€\n   */\n  async rejectStatement(statementId: string): Promise<{ success: boolean; error?: string }> {\n    try {\n      const { error } = await this.supabase\n        .from('transaction_statements')\n        .update({ status: 'rejected' })\n        .eq('id', statementId);\n\n      if (error) throw error;\n\n      return { success: true };\n    } catch (error) {\n      console.error('Reject statement error:', error);\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : 'ê±°ë¶€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'\n      };\n    }\n  }\n\n  /**\n   * ê±°ë˜ëª…ì„¸ì„œ ì‚­ì œ\n   */\n  async deleteStatement(statementId: string): Promise<{ success: boolean; error?: string }> {\n    try {\n      // ì´ë¯¸ì§€ URL ì¡°íšŒ\n      const { data: statement } = await this.supabase\n        .from('transaction_statements')\n        .select('image_url')\n        .eq('id', statementId)\n        .single();\n\n      // DB ì‚­ì œ (cascadeë¡œ í’ˆëª©ë„ í•¨ê»˜ ì‚­ì œë¨)\n      const { error } = await this.supabase\n        .from('transaction_statements')\n        .delete()\n        .eq('id', statementId);\n\n      if (error) throw error;\n\n      // Storage íŒŒì¼ ì‚­ì œ ì‹œë„\n      if (statement?.image_url) {\n        try {\n          const path = statement.image_url.split('/receipt-images/')[1];\n          if (path) {\n            await this.supabase.storage.from('receipt-images').remove([path]);\n          }\n        } catch (e) {\n          console.warn('Failed to delete storage file:', e);\n        }\n      }\n\n      return { success: true };\n    } catch (error) {\n      console.error('Delete statement error:', error);\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'\n      };\n    }\n  }\n\n  /**\n   * ì„¸íŠ¸ ë§¤ì¹­ - ê±°ë˜ëª…ì„¸ì„œ ì „ì²´ í’ˆëª©ê³¼ ì‹œìŠ¤í…œ ë°œì£¼ ì „ì²´ í’ˆëª© ë¹„êµ\n   * Case 1: ëª¨ë“  í’ˆëª©ì´ ê°™ì€ ë°œì£¼ë²ˆí˜¸ì¼ ë•Œ ì‚¬ìš©\n   * \n   * ìš°ì„ ìˆœìœ„:\n   * 1. OCR ì¶”ì¶œ ë°œì£¼/ìˆ˜ì£¼ë²ˆí˜¸ë¡œ ë¨¼ì € ê²€ìƒ‰ (ê°€ì¥ ë¹ ë¦„)\n   * 2. í•´ë‹¹ ë°œì£¼ì˜ í’ˆëª©ë“¤ê³¼ ì„¸íŠ¸ ë¹„êµ\n   * 3. ë§¤ì¹­ë¥  ë‚®ìœ¼ë©´ ì „ì²´ ë°œì£¼ ìŠ¤ìº”í•´ì„œ ì„¸íŠ¸ ë§¤ì¹­\n   */\n  async findBestMatchingPurchaseOrderSet(\n    extractedItems: TransactionStatementItem[],\n    extractedPONumber?: string,\n    statementVendorName?: string\n  ): Promise<{\n    success: boolean;\n    data?: {\n      bestMatch: {\n        purchase_id: number;\n        purchase_order_number: string;\n        sales_order_number?: string;\n        vendor_name?: string;\n        matchScore: number;        // 0-100 ì„¸íŠ¸ ë§¤ì¹­ ì ìˆ˜\n        matchedItemCount: number;  // ë§¤ì¹­ëœ í’ˆëª© ìˆ˜\n        totalItemCount: number;    // ì „ì²´ í’ˆëª© ìˆ˜\n        confidence: 'high' | 'medium' | 'low';\n        itemMatches: Array<{\n          ocrItemId: string;\n          systemItemId: number;\n          systemItemName: string;\n          similarity: number;\n        }>;\n      } | null;\n      candidates: Array<{\n        purchase_id: number;\n        purchase_order_number: string;\n        sales_order_number?: string;\n        vendor_name?: string;\n        matchScore: number;\n        matchedItemCount: number;\n      }>;\n    };\n    error?: string;\n  }> {\n    try {\n      const normalizedNumber = extractedPONumber \n        ? normalizeOrderNumber(extractedPONumber) \n        : '';\n\n      const purchaseScores: Array<{\n        purchase_id: number;\n        purchase_order_number: string;\n        sales_order_number?: string;\n        vendor_name?: string;\n        matchScore: number;\n        matchedItemCount: number;\n        totalItemCount: number;\n        items: any[];\n        itemMatches: Array<{\n          ocrItemId: string;\n          systemItemId: number;\n          systemItemName: string;\n          similarity: number;\n        }>;\n      }> = [];\n\n      // 1. OCR ì¶”ì¶œ ë°œì£¼ë²ˆí˜¸ë¡œ ë¨¼ì € ê²€ìƒ‰ (ê°€ì¥ ë¹ ë¦„)\n      if (normalizedNumber) {\n        const { data: byNumber } = await this.supabase\n          .from('purchase_requests')\n          .select(`\n            id, \n            purchase_order_number, \n            sales_order_number,\n            vendor:vendors(vendor_name),\n            items:purchase_request_items(id, item_name, specification, quantity, unit_price_value)\n          `)\n          .or(`purchase_order_number.eq.${normalizedNumber},sales_order_number.eq.${normalizedNumber}`)\n          .limit(5);\n\n        if (byNumber && byNumber.length > 0) {\n          for (const purchase of byNumber) {\n            // ê±°ë˜ì²˜ ìœ ì‚¬ë„ ì²´í¬\n            const sysVendorName = purchase.vendor?.vendor_name || '';\n            const vendorSimilarity = statementVendorName \n              ? this.calculateVendorSimilarity(statementVendorName, sysVendorName)\n              : 100;\n            \n            // ê±°ë˜ì²˜ ìœ ì‚¬ë„ 70% ë¯¸ë§Œì´ë©´ ìŠ¤í‚µ (ê±°ë˜ì²˜ ë‹¤ë¥´ë©´ í›„ë³´ ì œì™¸)\n            if (vendorSimilarity < 50) {\n              console.log(`âŒ ì„¸íŠ¸ ë§¤ì¹­ - ê±°ë˜ì²˜ ë¶ˆì¼ì¹˜ë¡œ ì œì™¸: \"${statementVendorName}\" vs \"${sysVendorName}\" (${vendorSimilarity}%)`);\n              continue;\n            }\n            \n            const setScore = this.calculateSetMatchScore(extractedItems, purchase.items || []);\n            purchaseScores.push({\n              purchase_id: purchase.id,\n              purchase_order_number: purchase.purchase_order_number || '',\n              sales_order_number: purchase.sales_order_number,\n              vendor_name: sysVendorName,\n              matchScore: setScore.score,\n              matchedItemCount: setScore.matchedCount,\n              totalItemCount: extractedItems.length,\n              items: purchase.items || [],\n              itemMatches: setScore.itemMatches\n            });\n          }\n        }\n      }\n\n      // 2. ë²ˆí˜¸ë¡œ ì°¾ì€ ê²°ê³¼ ì¤‘ ìµœê³  ì ìˆ˜ í™•ì¸\n      const bestByNumber = purchaseScores.length > 0 \n        ? purchaseScores.reduce((a, b) => a.matchScore > b.matchScore ? a : b)\n        : null;\n\n      // 3. ë²ˆí˜¸ ë§¤ì¹­ ì ìˆ˜ê°€ 80% ì´ìƒì´ë©´ ë°”ë¡œ ë°˜í™˜ (í™•ì‹  ìˆìŒ)\n      if (bestByNumber && bestByNumber.matchScore >= 80) {\n        return {\n          success: true,\n          data: {\n            bestMatch: {\n              ...bestByNumber,\n              confidence: 'high'\n            },\n            candidates: purchaseScores.map(p => ({\n              purchase_id: p.purchase_id,\n              purchase_order_number: p.purchase_order_number,\n              sales_order_number: p.sales_order_number,\n              vendor_name: p.vendor_name,\n              matchScore: p.matchScore,\n              matchedItemCount: p.matchedItemCount\n            }))\n          }\n        };\n      }\n\n      // 4. ì ìˆ˜ê°€ ë‚®ê±°ë‚˜ ë²ˆí˜¸ë¡œ ëª» ì°¾ì•˜ìœ¼ë©´ â†’ í’ˆëª©ëª… ê¸°ë°˜ ì „ì²´ ìŠ¤ìº”\n      // ìµœê·¼ 3ê°œì›” ë°œì£¼ ì¤‘ì—ì„œ í’ˆëª© ê°œìˆ˜ê°€ ë¹„ìŠ·í•œ ê²ƒë“¤ì„ ê²€ìƒ‰\n      const threeMonthsAgo = new Date();\n      threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);\n\n      const { data: recentPurchases } = await this.supabase\n        .from('purchase_requests')\n        .select(`\n          id, \n          purchase_order_number, \n          sales_order_number,\n          vendor:vendors(vendor_name),\n          items:purchase_request_items(id, item_name, specification, quantity, unit_price_value)\n        `)\n        .gte('created_at', threeMonthsAgo.toISOString())\n        .order('created_at', { ascending: false })\n        .limit(100);\n\n      if (recentPurchases) {\n        for (const purchase of recentPurchases) {\n          // ì´ë¯¸ ë²ˆí˜¸ë¡œ ê²€ìƒ‰í•œ ê²ƒì€ ìŠ¤í‚µ\n          if (purchaseScores.some(p => p.purchase_id === purchase.id)) continue;\n\n          // ê±°ë˜ì²˜ ìœ ì‚¬ë„ ì²´í¬ - ê±°ë˜ì²˜ ë‹¤ë¥´ë©´ í›„ë³´ì—ì„œ ì œì™¸\n          const sysVendorName = purchase.vendor?.vendor_name || '';\n          const vendorSimilarity = statementVendorName \n            ? this.calculateVendorSimilarity(statementVendorName, sysVendorName)\n            : 100;\n          \n          // ê±°ë˜ì²˜ ìœ ì‚¬ë„ 70% ë¯¸ë§Œì´ë©´ ìŠ¤í‚µ (ê±°ë˜ì²˜ ë‹¤ë¥´ë©´ í›„ë³´ ì œì™¸)\n          if (vendorSimilarity < 50) {\n            continue;\n          }\n\n          const setScore = this.calculateSetMatchScore(extractedItems, purchase.items || []);\n          \n          // 30ì  ì´ìƒë§Œ í›„ë³´ì— ì¶”ê°€\n          if (setScore.score >= 30) {\n            purchaseScores.push({\n              purchase_id: purchase.id,\n              purchase_order_number: purchase.purchase_order_number || '',\n              sales_order_number: purchase.sales_order_number,\n              vendor_name: sysVendorName,\n              matchScore: setScore.score,\n              matchedItemCount: setScore.matchedCount,\n              totalItemCount: extractedItems.length,\n              items: purchase.items || [],\n              itemMatches: setScore.itemMatches\n            });\n          }\n        }\n      }\n\n      // 5. ì ìˆ˜ìˆœ ì •ë ¬\n      purchaseScores.sort((a, b) => b.matchScore - a.matchScore);\n\n      const bestMatch = purchaseScores.length > 0 ? purchaseScores[0] : null;\n\n      return {\n        success: true,\n        data: {\n          bestMatch: bestMatch ? {\n            ...bestMatch,\n            confidence: bestMatch.matchScore >= 80 ? 'high' \n              : bestMatch.matchScore >= 50 ? 'medium' \n              : 'low'\n          } : null,\n          candidates: purchaseScores.slice(0, 10).map(p => ({\n            purchase_id: p.purchase_id,\n            purchase_order_number: p.purchase_order_number,\n            sales_order_number: p.sales_order_number,\n            vendor_name: p.vendor_name,\n            matchScore: p.matchScore,\n            matchedItemCount: p.matchedItemCount\n          }))\n        }\n      };\n    } catch (error) {\n      console.error('Find best matching PO set error:', error);\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : 'ì„¸íŠ¸ ë§¤ì¹­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'\n      };\n    }\n  }\n\n  /**\n   * ì„¸íŠ¸ ë§¤ì¹­ ì ìˆ˜ ê³„ì‚°\n   * ê±°ë˜ëª…ì„¸ì„œ í’ˆëª©ë“¤ê³¼ ì‹œìŠ¤í…œ ë°œì£¼ í’ˆëª©ë“¤ì„ 1:1 ë§¤ì¹­í•˜ì—¬ ì ìˆ˜ ê³„ì‚°\n   */\n  private calculateSetMatchScore(\n    ocrItems: TransactionStatementItem[],\n    systemItems: any[]\n  ): { \n    score: number; \n    matchedCount: number;\n    itemMatches: Array<{\n      ocrItemId: string;\n      systemItemId: number;\n      systemItemName: string;\n      similarity: number;\n    }>;\n  } {\n    if (ocrItems.length === 0 || systemItems.length === 0) {\n      return { score: 0, matchedCount: 0, itemMatches: [] };\n    }\n\n    const itemMatches: Array<{\n      ocrItemId: string;\n      systemItemId: number;\n      systemItemName: string;\n      similarity: number;\n    }> = [];\n\n    // ê° OCR í’ˆëª©ì— ëŒ€í•´ ê°€ì¥ ìœ ì‚¬í•œ ì‹œìŠ¤í…œ í’ˆëª© ì°¾ê¸°\n    const usedSystemItems = new Set<number>();\n    let totalSimilarity = 0;\n\n    for (const ocrItem of ocrItems) {\n      let bestMatch: { id: number; name: string; similarity: number } | null = null;\n\n      for (const sysItem of systemItems) {\n        // ì´ë¯¸ ë§¤ì¹­ëœ ì‹œìŠ¤í…œ í’ˆëª©ì€ ìŠ¤í‚µ\n        if (usedSystemItems.has(sysItem.id)) continue;\n\n        // í’ˆëª©ëª… OR ê·œê²© ìœ ì‚¬ë„ (í•µì‹¬ ë§¤ì¹­ ê¸°ì¤€)\n        const itemMatch = this.calculateItemMatchScore(\n          ocrItem.extracted_item_name || '',\n          sysItem.item_name || '',\n          sysItem.specification || ''\n        );\n\n        // ìˆ˜ëŸ‰ ë¹„êµ: ê°™ìœ¼ë©´ ë³´ë„ˆìŠ¤, ë‹¤ë¥´ë©´ ì•½ê°„ ë‚®ì€ ì ìˆ˜\n        let quantityBonus = 0;\n        if (ocrItem.extracted_quantity && sysItem.quantity) {\n          if (ocrItem.extracted_quantity === sysItem.quantity) {\n            quantityBonus = 15; // ìˆ˜ëŸ‰ ì¼ì¹˜ ë³´ë„ˆìŠ¤\n          } else if (ocrItem.extracted_quantity <= sysItem.quantity) {\n            quantityBonus = 5; // ë°°ì†¡ ìˆ˜ëŸ‰ì´ ìš”ì²­ë³´ë‹¤ ì ì€ ê²½ìš° ì‘ì€ ë³´ë„ˆìŠ¤\n          }\n        }\n        const totalScore = itemMatch.score + quantityBonus;\n\n        if (!bestMatch || totalScore > bestMatch.similarity) {\n          bestMatch = {\n            id: sysItem.id,\n            name: sysItem.item_name,\n            similarity: totalScore\n          };\n        }\n      }\n\n      // ìœ ì‚¬ë„ 40ì  ì´ìƒì´ë©´ ë§¤ì¹­ìœ¼ë¡œ ì²˜ë¦¬\n      if (bestMatch && bestMatch.similarity >= 40) {\n        usedSystemItems.add(bestMatch.id);\n        totalSimilarity += bestMatch.similarity;\n        itemMatches.push({\n          ocrItemId: ocrItem.id,\n          systemItemId: bestMatch.id,\n          systemItemName: bestMatch.name,\n          similarity: bestMatch.similarity\n        });\n      }\n    }\n\n    // ì„¸íŠ¸ ë§¤ì¹­ ì ìˆ˜ ê³„ì‚°\n    // - ë§¤ì¹­ëœ í’ˆëª© ë¹„ìœ¨ (50%)\n    // - í‰ê·  ìœ ì‚¬ë„ (50%)\n    const matchRatio = itemMatches.length / ocrItems.length;\n    const avgSimilarity = itemMatches.length > 0 \n      ? totalSimilarity / itemMatches.length \n      : 0;\n    \n    const score = Math.round((matchRatio * 50) + (avgSimilarity * 0.5));\n\n    return {\n      score: Math.min(100, score),\n      matchedCount: itemMatches.length,\n      itemMatches\n    };\n  }\n\n  /**\n   * OCR êµì • ë°ì´í„° ì €ì¥\n   */\n  async saveCorrection(request: SaveCorrectionRequest): Promise<{ success: boolean; error?: string }> {\n    try {\n      const { data: { user } } = await this.supabase.auth.getUser();\n      \n      // êµì • ë°ì´í„° ì €ì¥\n      const { error } = await this.supabase\n        .from('ocr_corrections')\n        .insert({\n          statement_id: request.statement_id,\n          statement_item_id: request.statement_item_id,\n          original_text: request.original_text,\n          corrected_text: request.corrected_text,\n          field_type: request.field_type,\n          corrected_by: user?.id\n        });\n\n      if (error) throw error;\n\n      return { success: true };\n    } catch (error) {\n      console.error('Save correction error:', error);\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : 'êµì • ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'\n      };\n    }\n  }\n\n  /**\n   * íŠ¹ì • ë°œì£¼ì— ì—°ê²°ëœ ê±°ë˜ëª…ì„¸ì„œ ëª©ë¡ ì¡°íšŒ\n   */\n  async getStatementsByPurchaseId(purchaseId: number): Promise<{\n    success: boolean;\n    data?: TransactionStatement[];\n    error?: string;\n  }> {\n    try {\n      // í•´ë‹¹ ë°œì£¼ì— ë§¤ì¹­ëœ í’ˆëª©ì´ ìˆëŠ” ê±°ë˜ëª…ì„¸ì„œ ì¡°íšŒ\n      const { data: items } = await this.supabase\n        .from('transaction_statement_items')\n        .select('statement_id')\n        .eq('matched_purchase_id', purchaseId);\n\n      if (!items || items.length === 0) {\n        return { success: true, data: [] };\n      }\n\n      const statementIds = [...new Set(items.map((i: { statement_id: string }) => i.statement_id))];\n\n      const { data: statements, error } = await this.supabase\n        .from('transaction_statements')\n        .select('*')\n        .in('id', statementIds)\n        .order('uploaded_at', { ascending: false });\n\n      if (error) throw error;\n\n      return { success: true, data: statements || [] };\n    } catch (error) {\n      console.error('Get statements by purchase error:', error);\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : 'ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'\n      };\n    }\n  }\n}\n\nexport const transactionStatementService = new TransactionStatementService();\nexport default transactionStatementService;\n\n"],"names":["CircleCheckBig","createLucideIcon","d","key","Image","width","height","x","y","rx","ry","cx","cy","r","normalizeOrderNumber","input","normalized","toUpperCase","replace","poMatch","match","prefix","num","padStart","soMatch","transactionStatementService","constructor","this","supabase","createClient","uploadStatement","file","uploaderName","ext","name","split","pop","toLowerCase","uuid","crypto","randomUUID","storagePath","data","uploadData","error","uploadError","storage","from","upload","contentType","type","upsert","urlData","getPublicUrl","imageUrl","publicUrl","user","auth","getUser","statement","dbError","insert","image_url","file_name","uploaded_by","id","uploaded_by_name","status","select","single","Error","message","code","success","statementId","extractStatementData","update","eq","functions","invoke","body","getStatementWithItems","getStatements","filters","query","count","order","ascending","dateFrom","gte","dateTo","lte","search","or","limit","offset","range","stmtError","items","itemsError","statementVendorName","vendor_name","itemsWithMatch","Promise","all","map","async","item","matchCandidates","findMatchCandidates","matchedPurchase","matchedItem","matched_purchase_id","purchase","purchase_order_number","sales_order_number","vendor","matched_item_id","purchaseItem","item_name","specification","quantity","unit_price_value","match_candidates","matched_purchase","matched_item","candidateMap","Map","rawNumber","extracted_po_number","normalizedNumber","partialPOMatch","partialSOMatch","isPartialNumber","datePrefix","byNumber","sysVendorName","vendorSimilarity","calculateVendorSimilarity","matchReasons","score","push","extracted_item_name","itemMatch","calculateItemMatchScore","matchedField","extracted_quantity","set","purchase_id","item_id","unit_price","match_reasons","size","byDatePrefix","has","itemName","trim","searchTermCandidates","substring","Math","min","length","filter","t","uniqueSearchTerms","Set","searchTerm","byNameOrSpec","sysPO","sysSO","hasHighQualityCandidate","Array","values","some","c","vendors","matchedVendors","v","vendorIds","threeMonthsAgo","Date","setMonth","getMonth","recentPurchases","in","toISOString","candidates","sort","a","b","slice","calculateNameSimilarity","name1","name2","s1","s2","includes","maxLen","max","similarity","levenshteinDistance","round","ocrItemName","systemItemName","systemSpecification","itemNameScore","specScore","vendor1","vendor2","normalize","n1","n2","translitMap","yg","tech","high","korea","electric","steel","metal","system","soft","net","global","trade","international","n1Replaced","n2Replaced","Object","entries","val","isVendorMatch","threshold","m","n","dp","fill","i","j","calculateSimilarityScore","extractedItem","extracted_specification","diff","abs","extracted_unit_price","getMatchReasons","reasons","updateItemMatch","itemId","matchedPurchaseId","matchedItemId","matchMethod","match_method","confirmStatement","request","confirmerName","itemError","is_confirmed","confirmed_quantity","confirmed_unit_price","confirmed_amount","is_additional_item","parent_item_id","purchaseError","amount_value","statementItem","getStatementItem","insertError","purchase_request_id","extracted_amount","remark","confirmed_at","confirmed_by","confirmed_by_name","rejectStatement","deleteStatement","delete","path","remove","e","findBestMatchingPurchaseOrderSet","extractedItems","extractedPONumber","purchaseScores","setScore","calculateSetMatchScore","matchScore","matchedItemCount","matchedCount","totalItemCount","itemMatches","bestByNumber","reduce","bestMatch","confidence","p","ocrItems","systemItems","usedSystemItems","totalSimilarity","ocrItem","sysItem","quantityBonus","totalScore","add","ocrItemId","systemItemId","matchRatio","avgSimilarity","saveCorrection","statement_id","statement_item_id","original_text","corrected_text","field_type","corrected_by","getStatementsByPurchaseId","purchaseId","statementIds","statements"],"mappings":";;;;;;GASA,MAIMA,EAAiBC,EAAiB,mBAJrB,CACjB,CAAC,OAAQ,CAAEC,EAAG,kCAAmCC,IAAK,WACtD,CAAC,OAAQ,CAAED,EAAG,iBAAkBC,IAAK,aCGjCC,EAAQH,EAAiB,QALZ,CACjB,CAAC,OAAQ,CAAEI,MAAO,KAAMC,OAAQ,KAAMC,EAAG,IAAKC,EAAG,IAAKC,GAAI,IAAKC,GAAI,IAAKP,IAAK,WAC7E,CAAC,SAAU,CAAEQ,GAAI,IAAKC,GAAI,IAAKC,EAAG,IAAKV,IAAK,WAC5C,CAAC,OAAQ,CAAED,EAAG,4CAA6CC,IAAK,aCsM3D,SAASW,EAAqBC,GACnC,IAAKA,EAAO,OAAOA,EAEnB,IAAIC,EAAaD,EAAME,cAAcC,QAAQ,OAAQ,IAGrD,MAAMC,EAAUH,EAAWI,MAAM,wBACjC,GAAID,EAAS,CACX,MAAM,CAAGE,EAAQC,GAAOH,EACxB,MAAO,GAAGE,KAAUC,EAAIC,SAAS,EAAG,MACtC,CAGA,MAAMC,EAAUR,EAAWI,MAAM,yBACjC,GAAII,EAAS,CACX,MAAM,CAAGH,EAAQC,GAAOE,EACxB,MAAO,GAAGH,KAAUC,EAAIC,SAAS,EAAG,MACtC,CAEA,OAAOP,CACT,CCy3CO,MAAMS,EAA8B,IAzkD3C,MAGE,WAAAC,GACEC,KAAKC,SAAWC,GAClB,CAKA,qBAAMC,CACJC,EACAC,GAEA,IAEE,MAAMC,EAAMF,EAAKG,KAAKC,MAAM,KAAKC,OAAOC,eAAiB,MACnDC,EAAOC,OAAOC,aAEdC,EAAc,yBADH,GAAGH,KAAQL,OAIpBS,KAAMC,EAAYC,MAAOC,SAAsBlB,KAAKC,SACzDkB,QACAC,KAAK,kBACLC,OAAOP,EAAaV,EAAM,CACzBkB,YAAalB,EAAKmB,KAClBC,QAAQ,IAGZ,GAAIN,EAAa,MAAMA,EAGvB,MAAQH,KAAMU,GAAYzB,KAAKC,SAC5BkB,QACAC,KAAK,kBACLM,aAAaZ,GAEVa,EAAWF,EAAQG,WAGjBb,MAAMc,KAAEA,UAAiB7B,KAAKC,SAAS6B,KAAKC,WAK5ChB,KAAMiB,EAAWf,MAAOgB,SAAkBjC,KAAKC,SACpDmB,KAAK,0BACLc,OAAO,CACNC,UAAWR,EACXS,UAAWhC,EAAKG,KAChB8B,YAAaR,GAAMS,GACnBC,iBAAkBlC,EAClBmC,OAAQ,YAETC,SACAC,SAEH,GAAIT,EAEF,MAAM,IAAIU,MAAM,aAAaV,EAAQW,kBAAkBX,EAAQY,SAKjE,MAAO,CACLC,SAAS,EACT/B,KAAM,CACJgC,YAAaf,EAAUM,GACvBX,YAGN,OAASV,GAEP,MAAO,CACL6B,SAAS,EACT7B,MAAOA,aAAiB0B,MAAQ1B,EAAM2B,QAAU,oBAEpD,CACF,CAKA,0BAAMI,CACJD,EACApB,GAEA,UAIQ3B,KAAKC,SACRmB,KAAK,0BACL6B,OAAO,CAAET,OAAQ,eACjBU,GAAG,KAAMH,GAGZ,MAAMhC,KAAEA,QAAME,SAAgBjB,KAAKC,SAASkD,UAAUC,OAAO,4BAA6B,CACxFC,KAAM,CACJN,cACApB,cAMJ,GAAIV,EAAO,MAAMA,EAEjB,IAAKF,EAAK+B,QACR,MAAM,IAAIH,MAAM5B,EAAKE,OAAS,aAWhC,aADqBjB,KAAKsD,sBAAsBP,EAElD,OAAS9B,GAEP,MAAO,CACL6B,SAAS,EACT7B,MAAOA,aAAiB0B,MAAQ1B,EAAM2B,QAAU,uBAEpD,CACF,CAKA,mBAAMW,CAAcC,GAQlB,IACE,IAAIC,EAAQzD,KAAKC,SACdmB,KAAK,0BACLqB,OAAO,IAAK,CAAEiB,MAAO,UACrBC,MAAM,cAAe,CAAEC,WAAW,IAEjCJ,GAAShB,QAA6B,QAAnBgB,EAAQhB,SAC7BiB,EAAQA,EAAMP,GAAG,SAAUM,EAAQhB,SAGjCgB,GAASK,WACXJ,EAAQA,EAAMK,IAAI,cAAeN,EAAQK,WAGvCL,GAASO,SACXN,EAAQA,EAAMO,IAAI,cAAeR,EAAQO,OAAS,cAGhDP,GAASS,SACXR,EAAQA,EAAMS,GAAG,sBAAsBV,EAAQS,4BAA4BT,EAAQS,YAGjFT,GAASW,QACXV,EAAQA,EAAMU,MAAMX,EAAQW,QAG1BX,GAASY,SACXX,EAAQA,EAAMY,MAAMb,EAAQY,OAAQZ,EAAQY,QAAUZ,EAAQW,OAAS,IAAM,IAG/E,MAAMpD,KAAEA,EAAA2C,MAAMA,EAAAzC,MAAOA,SAAgBwC,EAErC,GAAIxC,EAAO,MAAMA,EAEjB,MAAO,CAAE6B,SAAS,EAAM/B,KAAMA,GAAQ,GAAI2C,MAAOA,GAAS,EAC5D,OAASzC,GAEP,MAAO,CACL6B,SAAS,EACT7B,MAAOA,aAAiB0B,MAAQ1B,EAAM2B,QAAU,mBAEpD,CACF,CAKA,2BAAMU,CACJP,GAEA,IAEE,MAAQhC,KAAMiB,EAAWf,MAAOqD,SAAoBtE,KAAKC,SACtDmB,KAAK,0BACLqB,OAAO,KACPS,GAAG,KAAMH,GACTL,SAEH,GAAI4B,EAAW,MAAMA,EAGrB,MAAQvD,KAAMwD,EAAOtD,MAAOuD,SAAqBxE,KAAKC,SACnDmB,KAAK,+BACLqB,OAAO,KACPS,GAAG,eAAgBH,GACnBY,MAAM,cAAe,CAAEC,WAAW,IAErC,GAAIY,EAAY,MAAMA,EAGtB,MAAMC,EAAsBzC,EAAU0C,aAAe,GAC/CC,QAA4DC,QAAQC,KACvEN,GAAS,IAAIO,IAAIC,MAAOC,IACvB,MAAMC,QAAwBjF,KAAKkF,oBAAoBF,EAAMP,GAG7D,IAAIU,EACAC,EAEJ,GAAIJ,EAAKK,oBAAqB,CAC5B,MAAQtE,KAAMuE,SAAmBtF,KAAKC,SACnCmB,KAAK,qBACLqB,OAAO,8EACPS,GAAG,KAAM8B,EAAKK,qBACd3C,SAEC4C,IACFH,EAAkB,CAChB7C,GAAIgD,EAAShD,GACbiD,sBAAuBD,EAASC,uBAAyB,GACzDC,mBAAoBF,EAASE,mBAC7Bd,YAAaY,EAASG,QAAQf,aAGpC,CAEA,GAAIM,EAAKU,gBAAiB,CACxB,MAAQ3E,KAAM4E,SAAuB3F,KAAKC,SACvCmB,KAAK,0BACLqB,OAAO,4DACPS,GAAG,KAAM8B,EAAKU,iBACdhD,SAECiD,IACFP,EAAc,CACZ9C,GAAIqD,EAAarD,GACjBsD,UAAWD,EAAaC,UACxBC,cAAeF,EAAaE,cAC5BC,SAAUH,EAAaG,SACvBC,iBAAkBJ,EAAaI,kBAGrC,CAEA,MAAO,IACFf,EACHgB,iBAAkBf,EAClBgB,iBAAkBd,EAClBe,aAAcd,MAKpB,MAAO,CACLtC,SAAS,EACT/B,KAAM,IACDiB,EACHuC,MAAOI,GAGb,OAAS1D,GAEP,MAAO,CACL6B,SAAS,EACT7B,MAAOA,aAAiB0B,MAAQ1B,EAAM2B,QAAU,mBAEpD,CACF,CAQA,yBAAMsC,CAAoBF,EAAgCP,GACxD,MAAM0B,MAAmBC,IAEzB,IACE,MAAMC,EAAYrB,EAAKsB,qBAAuB,GACxCC,EAAmBF,EAAYlH,EAAqBkH,GAAa,GAGjEG,EAAiBH,EAAU/G,cAAcG,MAAM,gBAC/CgH,EAAiBJ,EAAU/G,cAAcG,MAAM,iBAC/CiH,KAAqBF,IAAkBC,GACvCE,EAAaH,EAAiB,IAAIA,EAAe,KAAQC,EAAiB,KAAKA,EAAe,KAAO,GAG3G,GAAIF,EAAkB,CACpB,MAAQxF,KAAM6F,SAAmB5G,KAAKC,SACnCmB,KAAK,qBACLqB,OAAO,sPAOPyB,GAAG,4BAA4BqC,2BAA0CA,KACzEpC,MAAM,IAET,GAAIyC,EACF,IAAA,MAAWtB,KAAYsB,EAAU,CAE/B,MAAMC,EAAgBvB,EAASG,QAAQf,aAAe,GAChDoC,EAAmBrC,EACrBzE,KAAK+G,0BAA0BtC,EAAqBoC,GACpD,IAGJ,KAAIC,EAAmB,IAKvB,IAAA,MAAWnB,KAAgBL,EAASf,OAAS,GAAI,CAC/C,MAAM/F,EAAM,GAAG8G,EAAShD,MAAMqD,EAAarD,KACrC0E,EAAe,CAAC,cACtB,IAAIC,EAAQ,GAYZ,GATIH,GAAoB,IACtBG,GAAS,GACTD,EAAaE,KAAK,WACTJ,GAAoB,KAC7BG,GAAS,EACTD,EAAaE,KAAK,WAIhBlC,EAAKmC,oBAAqB,CAC5B,MAAMC,EAAYpH,KAAKqH,wBACrBrC,EAAKmC,oBACLxB,EAAaC,UACbD,EAAaE,eAEfoB,GAA2B,GAAlBG,EAAUH,MACfG,EAAUH,OAAS,IACrBD,EAAaE,KAAgC,kBAA3BE,EAAUE,aAAmC,QAAU,SAE7E,CAGItC,EAAKuC,oBAAsB5B,EAAaG,WACtCd,EAAKuC,qBAAuB5B,EAAaG,UAC3CmB,GAAS,GACTD,EAAaE,KAAK,UAAUlC,EAAKuC,wBACxBvC,EAAKuC,oBAAsB5B,EAAaG,WACjDmB,GAAS,EACTD,EAAaE,KAAK,UAAUvB,EAAaG,gBAAgBd,EAAKuC,yBAIlEpB,EAAaqB,IAAIhJ,EAAK,CACpBiJ,YAAanC,EAAShD,GACtBiD,sBAAuBD,EAASC,uBAAyB,GACzDC,mBAAoBF,EAASE,mBAC7BkC,QAAS/B,EAAarD,GACtBsD,UAAWD,EAAaC,UACxBC,cAAeF,EAAaE,cAC5BC,SAAUH,EAAaG,SACvB6B,WAAYhC,EAAaI,iBACzBrB,YAAamC,EACbI,QACAW,cAAeZ,GAEnB,CACF,CAEJ,CAGA,GAAIN,GAAmBC,GAAoC,IAAtBR,EAAa0B,KAAY,CAG5D,MAAQ9G,KAAM+G,SAAuB9H,KAAKC,SACvCmB,KAAK,qBACLqB,OAAO,sPAOPyB,GAAG,+BAA+ByC,+BAAwCA,MAC1ExC,MAAM,IAET,GAAI2D,EACF,IAAA,MAAWxC,KAAYwC,EAAc,CACnC,MAAMjB,EAAgBvB,EAASG,QAAQf,aAAe,GAChDoC,EAAmBrC,EACrBzE,KAAK+G,0BAA0BtC,EAAqBoC,GACpD,IAGJ,KAAIC,EAAmB,IAIvB,IAAA,MAAWnB,KAAgBL,EAASf,OAAS,GAAI,CAC/C,MAAM/F,EAAM,GAAG8G,EAAShD,MAAMqD,EAAarD,KAC3C,GAAI6D,EAAa4B,IAAIvJ,GAAM,SAE3B,MAAMwI,EAAe,CAAC,UAAUL,MAChC,IAAIM,EAAQ,GAYZ,GATIH,GAAoB,IACtBG,GAAS,GACTD,EAAaE,KAAK,WACTJ,GAAoB,KAC7BG,GAAS,GACTD,EAAaE,KAAK,WAIhBlC,EAAKmC,oBAAqB,CAC5B,MAAMC,EAAYpH,KAAKqH,wBACrBrC,EAAKmC,oBACLxB,EAAaC,UACbD,EAAaE,eAEfoB,GAA2B,GAAlBG,EAAUH,MACfG,EAAUH,OAAS,GACrBD,EAAaE,KAAgC,kBAA3BE,EAAUE,aAAmC,QAAU,UAChEF,EAAUH,OAAS,IAC5BD,EAAaE,KAAgC,kBAA3BE,EAAUE,aAAmC,QAAU,SAE7E,CAGItC,EAAKuC,oBAAsB5B,EAAaG,WACtCd,EAAKuC,qBAAuB5B,EAAaG,UAC3CmB,GAAS,GACTD,EAAaE,KAAK,UAAUlC,EAAKuC,wBACxBvC,EAAKuC,oBAAsB5B,EAAaG,WACjDmB,GAAS,EACTD,EAAaE,KAAK,UAAUvB,EAAaG,gBAAgBd,EAAKuC,yBAIlEpB,EAAaqB,IAAIhJ,EAAK,CACpBiJ,YAAanC,EAAShD,GACtBiD,sBAAuBD,EAASC,uBAAyB,GACzDC,mBAAoBF,EAASE,mBAC7BkC,QAAS/B,EAAarD,GACtBsD,UAAWD,EAAaC,UACxBC,cAAeF,EAAaE,cAC5BC,SAAUH,EAAaG,SACvB6B,WAAYhC,EAAaI,iBACzBrB,YAAamC,EACbI,QACAW,cAAeZ,GAEnB,CACF,CAEJ,CAGA,GAAIhC,EAAKmC,oBAAqB,CAC5B,MAAMa,EAAWhD,EAAKmC,oBAAoBc,OAGpCC,EAAuB,CAC3BF,EACAA,EAASG,UAAU,EAAGC,KAAKC,IAAIL,EAASM,OAAQ,KAChDN,EAASG,UAAU,EAAGC,KAAKC,IAAIL,EAASM,OAAQ,IAChDN,EAASxH,MAAM,eAAe,IAC9B+H,OAAOC,GAAKA,GAAKA,EAAEF,QAAU,GAGzBG,EAAoB,IAAI,IAAIC,IAAIR,IAItC,IAAA,MAAWS,KAAcF,EAAmB,CAC1C,MAAQ1H,KAAM6H,SAAuB5I,KAAKC,SACvCmB,KAAK,0BACLqB,OAAO,8WAaPyB,GAAG,oBAAoByE,2BAAoCA,MAC3DxE,MAAM,IAET,GAAIyE,GAAgBA,EAAaN,OAAS,EAAG,CAG3C,IAAA,MAAW3C,KAAgBiD,EAAc,CACvC,MAAMpK,EAAM,GAAGmH,EAAaL,UAAUhD,MAAMqD,EAAarD,KAGzD,GAAI6D,EAAa4B,IAAIvJ,GAAM,SAG3B,MAAMqI,EAAgBlB,EAAaL,UAAUG,QAAQf,aAAe,GAC9DoC,EAAmBrC,EACrBzE,KAAK+G,0BAA0BtC,EAAqBoC,GACpD,IAKJ,GAAIC,EAAmB,GAErB,SAGF,MAAME,EAAyB,GAC/B,IAAIC,EAAQ,EAGRH,GAAoB,IACtBG,GAAS,GACTD,EAAaE,KAAK,WACTJ,GAAoB,KAC7BG,GAAS,GACTD,EAAaE,KAAK,WAIpB,MAAME,EAAYpH,KAAKqH,wBACrBrC,EAAKmC,oBACLxB,EAAaC,UACbD,EAAaE,eAEXuB,EAAUH,OAAS,KACrBA,GAA2B,GAAlBG,EAAUH,MACfG,EAAUH,OAAS,GACrBD,EAAaE,KAAgC,kBAA3BE,EAAUE,aAAmC,QAAU,UAChEF,EAAUH,OAAS,GAC5BD,EAAaE,KAAgC,kBAA3BE,EAAUE,aAAmC,QAAU,UAEzEN,EAAaE,KAAK,YAKlBlC,EAAKuC,oBAAsB5B,EAAaG,WACtCd,EAAKuC,qBAAuB5B,EAAaG,UAC3CmB,GAAS,GACTD,EAAaE,KAAK,UAAUlC,EAAKuC,wBACxBvC,EAAKuC,oBAAsB5B,EAAaG,WAEjDmB,GAAS,EACTD,EAAaE,KAAK,UAAUvB,EAAaG,gBAAgBd,EAAKuC,yBAMlE,MAAMsB,EAAQlD,EAAaL,UAAUC,uBAAyB,GACxDuD,EAAQnD,EAAaL,UAAUE,oBAAsB,GACvDe,GAAoBsC,IAAUtC,GAAoBuC,IAAUvC,GAC9DS,EAAaE,KAAK,iBAAiBX,OAAsBsC,GAASC,KAMhE7B,GAAS,IAEXd,EAAaqB,IAAIhJ,EAAK,CACpBiJ,YAAa9B,EAAaL,UAAUhD,GACpCiD,sBAAuBsD,EACvBrD,mBAAoBsD,EACpBpB,QAAS/B,EAAarD,GACtBsD,UAAWD,EAAaC,UACxBC,cAAeF,EAAaE,cAC5BC,SAAUH,EAAaG,SACvB6B,WAAYhC,EAAaI,iBACzBrB,YAAaiB,EAAaL,UAAUG,QAAQf,YAC5CuC,QACAW,cAAeZ,GAGrB,CAGA,GAAIb,EAAa0B,MAAQ,EAAG,KAC9B,CACF,CACF,CAIA,MAAMkB,EAA0BC,MAAM5H,KAAK+E,EAAa8C,UAAUC,KAAKC,GAAKA,EAAElC,OAAS,IAGvF,IAF4C,IAAtBd,EAAa0B,OAAekB,IAE7BtE,EAAqB,CAIxC,MAAQ1D,KAAMqI,SAAkBpJ,KAAKC,SAClCmB,KAAK,WACLqB,OAAO,mBACP0B,MAAM,KAET,GAAIiF,EAAS,CAEX,MAAMC,EAAiBD,EAAQb,OAAQe,GACrCtJ,KAAK+G,0BAA0BtC,EAAqB6E,EAAE5E,cAAgB,IAGxE,GAAI2E,EAAef,OAAS,EAAG,CAC7B,MAAMiB,EAAYF,EAAevE,IAAKwE,GAA2CA,EAAEhH,IAG7EkH,MAAqBC,KAC3BD,EAAeE,SAASF,EAAeG,WAAa,GAEpD,MAAQ5I,KAAM6I,SAA0B5J,KAAKC,SAC1CmB,KAAK,qBACLqB,OAAO,8QAOPoH,GAAG,YAAaN,GAChBzF,IAAI,aAAc0F,EAAeM,eACjCnG,MAAM,aAAc,CAAEC,WAAW,IACjCO,MAAM,IAET,GAAIyF,EACF,IAAA,MAAWtE,KAAYsE,EAAiB,CACtC,MAAM/C,EAAgBvB,EAASG,QAAQf,aAAe,GAEtD,IAAA,MAAWiB,KAAgBL,EAASf,OAAS,GAAI,CAC/C,MAAM/F,EAAM,GAAG8G,EAAShD,MAAMqD,EAAarD,KAC3C,GAAI6D,EAAa4B,IAAIvJ,GAAM,SAE3B,MAAMwI,EAAyB,CAAC,UAChC,IAAIC,EAAQ,GAGZ,GAAIjC,EAAKmC,oBAAqB,CAC5B,MAAMC,EAAYpH,KAAKqH,wBACrBrC,EAAKmC,oBACLxB,EAAaC,UACbD,EAAaE,eAEXuB,EAAUH,OAAS,KACrBA,GAA2B,GAAlBG,EAAUH,MACfG,EAAUH,OAAS,GACrBD,EAAaE,KAAgC,kBAA3BE,EAAUE,aAAmC,QAAU,UAChEF,EAAUH,OAAS,IAC5BD,EAAaE,KAAgC,kBAA3BE,EAAUE,aAAmC,QAAU,UAG/E,CAGItC,EAAKuC,oBAAsB5B,EAAaG,WACtCd,EAAKuC,qBAAuB5B,EAAaG,UAC3CmB,GAAS,GACTD,EAAaE,KAAK,UAAUlC,EAAKuC,wBACxBvC,EAAKuC,oBAAsB5B,EAAaG,WACjDmB,GAAS,EACTD,EAAaE,KAAK,UAAUvB,EAAaG,gBAAgBd,EAAKuC,yBAKlE,MAAMsB,EAAQvD,EAASC,uBAAyB,GAC1CuD,EAAQxD,EAASE,oBAAsB,GACzCe,GACFS,EAAaE,KAAK,iBAAiBX,OAAsBsC,GAASC,KAIhE7B,GAAS,IACXd,EAAaqB,IAAIhJ,EAAK,CACpBiJ,YAAanC,EAAShD,GACtBiD,sBAAuBsD,EACvBrD,mBAAoBsD,EACpBpB,QAAS/B,EAAarD,GACtBsD,UAAWD,EAAaC,UACxBC,cAAeF,EAAaE,cAC5BC,SAAUH,EAAaG,SACvB6B,WAAYhC,EAAaI,iBACzBrB,YAAamC,EACbI,QACAW,cAAeZ,GAGrB,CACF,CAEJ,CACF,CACF,CAGA,MAAM+C,EAAaf,MAAM5H,KAAK+E,EAAa8C,UAQ3C,OAPAc,EAAWC,KAAK,CAACC,EAAGC,IAAMA,EAAEjD,MAAQgD,EAAEhD,OAGlC8C,EAAWzB,OAIRyB,EAAWI,MAAM,EAAG,GAC7B,OAASlJ,GAEP,MAAO,EACT,CACF,CAKQ,uBAAAmJ,CAAwBC,EAAeC,GAC7C,MAAMC,EAAKF,EAAM3J,cAAcnB,QAAQ,OAAQ,IACzCiL,EAAKF,EAAM5J,cAAcnB,QAAQ,OAAQ,IAE/C,IAAKgL,IAAOC,EAAI,OAAO,EACvB,GAAID,IAAOC,EAAI,OAAO,IAGtB,GAAID,EAAGE,SAASD,IAAOA,EAAGC,SAASF,GACjC,OAAO,GAIT,MAAMG,EAAStC,KAAKuC,IAAIJ,EAAGjC,OAAQkC,EAAGlC,QAEhCsC,GAAeF,EADJ1K,KAAK6K,oBAAoBN,EAAIC,IACJE,EAAU,IAEpD,OAAOtC,KAAK0C,MAAMF,EACpB,CAOQ,uBAAAvD,CACN0D,EACAC,EACAC,GAEA,IAAKF,EACH,MAAO,CAAE9D,MAAO,EAAGK,aAAc,QAInC,MAAM4D,EAAgBF,EAClBhL,KAAKoK,wBAAwBW,EAAaC,GAC1C,EAGEG,EAAYF,EACdjL,KAAKoK,wBAAwBW,EAAaE,GAC1C,EAGJ,OAAIC,GAAiBC,EACZ,CACLlE,MAAOiE,EACP5D,aAAc4D,EAAgB,EAAI,YAAc,QAG3C,CACLjE,MAAOkE,EACP7D,aAAc6D,EAAY,EAAI,gBAAkB,OAGtD,CAQQ,yBAAApE,CAA0BqE,EAAiBC,GACjD,IAAKD,IAAYC,EAAS,OAAO,EAGjC,MAAMC,EAAa/K,GACVA,EACJG,cACAnB,QAAQ,4EAA6E,IACrFA,QAAQ,gBAAiB,IACzB0I,OAGCsD,EAAKD,EAAUF,GACfI,EAAKF,EAAUD,GAErB,IAAKE,IAAOC,EAAI,OAAO,EACvB,GAAID,IAAOC,EAAI,OAAO,IAGtB,GAAID,EAAGd,SAASe,IAAOA,EAAGf,SAASc,GACjC,OAAO,GAIT,MAAME,EAAwC,CAC5CC,GAAM,CAAC,MAAO,MACd,MAAO,CAAC,KAAM,OACdC,KAAQ,CAAC,KAAM,IAAK,QACpB,KAAM,CAAC,OAAQ,IAAK,MACpB,IAAK,CAAC,OAAQ,KAAM,KACpBC,KAAQ,CAAC,KAAM,QACf,KAAM,CAAC,OAAQ,MACfC,MAAS,CAAC,MAAO,KAAM,SACvB,MAAO,CAAC,QAAS,KAAM,OACvBC,SAAY,CAAC,KAAM,OAAQ,YAC3B,KAAM,CAAC,WAAY,OAAQ,MAC3BC,MAAS,CAAC,KAAM,KAAM,SACtB,KAAM,CAAC,QAAS,KAAM,MACtBC,MAAS,CAAC,KAAM,KAAM,SACtB,KAAM,CAAC,QAAS,KAAM,MACtBC,OAAU,CAAC,MAAO,UAClB,MAAO,CAAC,SAAU,OAClBC,KAAQ,CAAC,MAAO,QAChB,MAAO,CAAC,OAAQ,OAChBC,IAAO,CAAC,IAAK,OACb,IAAK,CAAC,MAAO,KACbC,OAAU,CAAC,MAAO,UAClB,MAAO,CAAC,SAAU,OAClBC,MAAS,CAAC,OAAQ,KAAM,SACxB,OAAQ,CAAC,QAAS,KAAM,QACxBC,cAAiB,CAAC,QAAS,iBAC3B,QAAS,CAAC,gBAAiB,UAI7B,IAAIC,EAAahB,EACbiB,EAAahB,EAEjB,IAAA,MAAYhN,EAAKyK,KAAWwD,OAAOC,QAAQjB,GAAc,CACvD,GAAIF,EAAGd,SAASjM,GAAM,CACpB,IAAA,MAAWmO,KAAO1D,EAEhB,GADAsD,EAAaA,EAAWhN,QAAQf,EAAKmO,GACjCJ,IAAef,GAAMA,EAAGf,SAAS8B,IAAeA,EAAW9B,SAASe,GACtE,OAAO,GAGXe,EAAahB,CACf,CACA,GAAIC,EAAGf,SAASjM,GAAM,CACpB,IAAA,MAAWmO,KAAO1D,EAEhB,GADAuD,EAAaA,EAAWjN,QAAQf,EAAKmO,GACjCpB,IAAOiB,GAAcjB,EAAGd,SAAS+B,IAAeA,EAAW/B,SAASc,GACtE,OAAO,GAGXiB,EAAahB,CACf,CACF,CAGA,MAAMd,EAAStC,KAAKuC,IAAIY,EAAGjD,OAAQkD,EAAGlD,QAEhCsC,GAAeF,EADJ1K,KAAK6K,oBAAoBU,EAAIC,IACJd,EAAU,IAEpD,OAAOtC,KAAK0C,MAAMF,EACpB,CAKA,aAAAgC,CAAcxB,EAAiBC,EAAiBwB,EAAoB,IAClE,OAAO7M,KAAK+G,0BAA0BqE,EAASC,IAAYwB,CAC7D,CAKQ,mBAAAhC,CAAoBN,EAAYC,GACtC,MAAMsC,EAAIvC,EAAGjC,OACPyE,EAAIvC,EAAGlC,OACP0E,EAAiBhE,MAAM8D,EAAI,GAAGG,KAAK,MAAMnI,IAAI,IAAMkE,MAAM+D,EAAI,GAAGE,KAAK,IAE3E,IAAA,IAASC,EAAI,EAAGA,GAAKJ,EAAGI,IAAKF,EAAGE,GAAG,GAAKA,EACxC,IAAA,IAASC,EAAI,EAAGA,GAAKJ,EAAGI,IAAKH,EAAG,GAAGG,GAAKA,EAExC,IAAA,IAASD,EAAI,EAAGA,GAAKJ,EAAGI,IACtB,IAAA,IAASC,EAAI,EAAGA,GAAKJ,EAAGI,IAClB5C,EAAG2C,EAAI,KAAO1C,EAAG2C,EAAI,GACvBH,EAAGE,GAAGC,GAAKH,EAAGE,EAAI,GAAGC,EAAI,GAEzBH,EAAGE,GAAGC,GAAK/E,KAAKC,IAAI2E,EAAGE,EAAI,GAAGC,EAAI,GAAIH,EAAGE,EAAI,GAAGC,GAAIH,EAAGE,GAAGC,EAAI,IAAM,EAK1E,OAAOH,EAAGF,GAAGC,EACf,CAKQ,wBAAAK,CACNC,EACA1H,GAEA,IAAIsB,EAAQ,EAGZ,GAAIoG,EAAclG,oBAAqB,CAMrCF,GAA2B,GALTjH,KAAKqH,wBACrBgG,EAAclG,oBACdxB,EAAaC,WAAa,GAC1BD,EAAaE,eAAiB,IAEboB,KACrB,CAGA,GAAIoG,EAAcC,wBAAyB,CAMzCrG,GAA2B,GALTjH,KAAKqH,wBACrBgG,EAAcC,wBACd3H,EAAaC,WAAa,GAC1BD,EAAaE,eAAiB,IAEboB,KACrB,CAGA,GAAIoG,EAAc9F,oBAAsB5B,EAAaG,SAAU,CAC7D,MAAMyH,EAAOnF,KAAKoF,IAAIH,EAAc9F,mBAAqB5B,EAAaG,UACzD,IAATyH,EACFtG,GAAS,GACAsG,GAAgC,GAAxB5H,EAAaG,SAC9BmB,GAAS,GACAsG,GAAgC,GAAxB5H,EAAaG,WAC9BmB,GAAS,GAEb,CAGA,GAAIoG,EAAcI,sBAAwB9H,EAAaI,iBAAkB,CACvE,MAAMwH,EAAOnF,KAAKoF,IAAIH,EAAcI,qBAAuB9H,EAAaI,kBAC3D,IAATwH,EACFtG,GAAS,GACAsG,GAAwC,IAAhC5H,EAAaI,iBAC9BkB,GAAS,GACAsG,GAAwC,GAAhC5H,EAAaI,mBAC9BkB,GAAS,GAEb,CAEA,OAAOA,CACT,CAKQ,eAAAyG,CACNL,EACA1H,EACAsB,GAEA,MAAM0G,EAAoB,GAG1B,GAAIN,EAAclG,oBAAqB,CACrC,MAAMC,EAAYpH,KAAKqH,wBACrBgG,EAAclG,oBACdxB,EAAaC,WAAa,GAC1BD,EAAaE,eAAiB,IAG5BuB,EAAUH,OAAS,GACrB0G,EAAQzG,KAAgC,kBAA3BE,EAAUE,aAAmC,WAAa,aAC9DF,EAAUH,OAAS,GAC5B0G,EAAQzG,KAAgC,kBAA3BE,EAAUE,aAAmC,YAAc,cAC/DF,EAAUH,OAAS,IAC5B0G,EAAQzG,KAAgC,kBAA3BE,EAAUE,aAAmC,WAAa,YAE3E,CAqBA,OAlBI+F,EAAc9F,oBAAsB5B,EAAaG,WAC/CuH,EAAc9F,qBAAuB5B,EAAaG,SACpD6H,EAAQzG,KAAK,UAAUmG,EAAc9F,uBAC5B8F,EAAc9F,oBAAsB5B,EAAaG,UAC1D6H,EAAQzG,KAAK,UAAUvB,EAAaG,gBAAgBuH,EAAc9F,wBAIlE8F,EAAcI,uBAAyB9H,EAAaI,kBACtD4H,EAAQzG,KAAK,SAGXD,GAAS,GACX0G,EAAQzG,KAAK,UACJD,GAAS,IAClB0G,EAAQzG,KAAK,UAGRyG,CACT,CAKA,qBAAMC,CACJC,EACAC,EACAC,EACAC,EAA0D,UAE1D,IACE,MAAM/M,MAAEA,SAAgBjB,KAAKC,SAC1BmB,KAAK,+BACL6B,OAAO,CACNoC,oBAAqByI,EACrBpI,gBAAiBqI,EACjBE,aAAcD,IAEf9K,GAAG,KAAM2K,GAEZ,GAAI5M,EAAO,MAAMA,EAEjB,MAAO,CAAE6B,SAAS,EACpB,OAAS7B,GAEP,MAAO,CACL6B,SAAS,EACT7B,MAAOA,aAAiB0B,MAAQ1B,EAAM2B,QAAU,wBAEpD,CACF,CAKA,sBAAMsL,CACJC,EACAC,GAEA,IACE,MAAQrN,MAAMc,KAAEA,UAAiB7B,KAAKC,SAAS6B,KAAKC,UAGpD,IAAA,MAAWiD,KAAQmJ,EAAQ5J,MAAO,CAEhC,MAAQtD,MAAOoN,SAAoBrO,KAAKC,SACrCmB,KAAK,+BACL6B,OAAO,CACNqL,cAAc,EACdjJ,oBAAqBL,EAAKK,oBAC1BK,gBAAiBV,EAAKU,gBACtB6I,mBAAoBvJ,EAAKuJ,mBACzBC,qBAAsBxJ,EAAKwJ,qBAC3BC,iBAAkBzJ,EAAKyJ,iBACvBC,mBAAoB1J,EAAK0J,qBAAsB,EAC/CC,eAAgB3J,EAAK2J,iBAEtBzL,GAAG,KAAM8B,EAAK6I,QAEjB,GAAIQ,EAAW,MAAMA,EAGrB,GAAIrJ,EAAKU,sBAAiD,IAA9BV,EAAKwJ,qBAAoC,CACnE,MAAQvN,MAAO2N,SAAwB5O,KAAKC,SACzCmB,KAAK,0BACL6B,OAAO,CACN8C,iBAAkBf,EAAKwJ,qBACvBK,aAAc7J,EAAKyJ,mBAEpBvL,GAAG,KAAM8B,EAAKU,gBAKnB,CAGA,GAAIV,EAAK0J,oBAAsB1J,EAAKK,sBAAwBL,EAAKU,gBAAiB,CAChF,MAAMoJ,QAAsB9O,KAAK+O,iBAAiB/J,EAAK6I,QACvD,GAAIiB,EAAe,CACjB,MAAQ7N,MAAO+N,SAAsBhP,KAAKC,SACvCmB,KAAK,0BACLc,OAAO,CACN+M,oBAAqBjK,EAAKK,oBAC1BO,UAAWkJ,EAAc3H,qBAAuB,QAChDtB,cAAeiJ,EAAcxB,wBAC7BxH,SAAUd,EAAKuJ,oBAAsBO,EAAcvH,oBAAsB,EACzExB,iBAAkBf,EAAKwJ,sBAAwBM,EAAcrB,qBAC7DoB,aAAc7J,EAAKyJ,kBAAoBK,EAAcI,iBACrDC,OAAQ,eAMd,CACF,CACF,CAGA,MAAQlO,MAAOqD,SAAoBtE,KAAKC,SACrCmB,KAAK,0BACL6B,OAAO,CACNT,OAAQ,YACR4M,cAAA,IAAkB3F,MAAOK,cACzBuF,aAAcxN,GAAMS,GACpBgN,kBAAmBlB,IAEpBlL,GAAG,KAAMiL,EAAQpL,aAEpB,GAAIuB,EAAW,MAAMA,EAErB,MAAO,CAAExB,SAAS,EACpB,OAAS7B,GAEP,MAAO,CACL6B,SAAS,EACT7B,MAAOA,aAAiB0B,MAAQ1B,EAAM2B,QAAU,mBAEpD,CACF,CAKA,sBAAcmM,CAAiBlB,GAC7B,MAAM9M,KAAEA,SAAef,KAAKC,SACzBmB,KAAK,+BACLqB,OAAO,KACPS,GAAG,KAAM2K,GACTnL,SAEH,OAAO3B,CACT,CAKA,qBAAMwO,CAAgBxM,GACpB,IACE,MAAM9B,MAAEA,SAAgBjB,KAAKC,SAC1BmB,KAAK,0BACL6B,OAAO,CAAET,OAAQ,aACjBU,GAAG,KAAMH,GAEZ,GAAI9B,EAAO,MAAMA,EAEjB,MAAO,CAAE6B,SAAS,EACpB,OAAS7B,GAEP,MAAO,CACL6B,SAAS,EACT7B,MAAOA,aAAiB0B,MAAQ1B,EAAM2B,QAAU,sBAEpD,CACF,CAKA,qBAAM4M,CAAgBzM,GACpB,IAEE,MAAQhC,KAAMiB,SAAoBhC,KAAKC,SACpCmB,KAAK,0BACLqB,OAAO,aACPS,GAAG,KAAMH,GACTL,UAGGzB,MAAEA,SAAgBjB,KAAKC,SAC1BmB,KAAK,0BACLqO,SACAvM,GAAG,KAAMH,GAEZ,GAAI9B,EAAO,MAAMA,EAGjB,GAAIe,GAAWG,UACb,IACE,MAAMuN,EAAO1N,EAAUG,UAAU3B,MAAM,oBAAoB,GACvDkP,SACI1P,KAAKC,SAASkB,QAAQC,KAAK,kBAAkBuO,OAAO,CAACD,GAE/D,OAASE,GAET,CAGF,MAAO,CAAE9M,SAAS,EACpB,OAAS7B,GAEP,MAAO,CACL6B,SAAS,EACT7B,MAAOA,aAAiB0B,MAAQ1B,EAAM2B,QAAU,mBAEpD,CACF,CAWA,sCAAMiN,CACJC,EACAC,EACAtL,GA+BA,IACE,MAAM8B,EAAmBwJ,EACrB5Q,EAAqB4Q,GACrB,GAEEC,EAeD,GAGL,GAAIzJ,EAAkB,CACpB,MAAQxF,KAAM6F,SAAmB5G,KAAKC,SACnCmB,KAAK,qBACLqB,OAAO,sPAOPyB,GAAG,4BAA4BqC,2BAA0CA,KACzEpC,MAAM,GAET,GAAIyC,GAAYA,EAAS0B,OAAS,EAChC,IAAA,MAAWhD,KAAYsB,EAAU,CAE/B,MAAMC,EAAgBvB,EAASG,QAAQf,aAAe,GAMtD,IALyBD,EACrBzE,KAAK+G,0BAA0BtC,EAAqBoC,GACpD,KAGmB,GAErB,SAGF,MAAMoJ,EAAWjQ,KAAKkQ,uBAAuBJ,EAAgBxK,EAASf,OAAS,IAC/EyL,EAAe9I,KAAK,CAClBO,YAAanC,EAAShD,GACtBiD,sBAAuBD,EAASC,uBAAyB,GACzDC,mBAAoBF,EAASE,mBAC7Bd,YAAamC,EACbsJ,WAAYF,EAAShJ,MACrBmJ,iBAAkBH,EAASI,aAC3BC,eAAgBR,EAAexH,OAC/B/D,MAAOe,EAASf,OAAS,GACzBgM,YAAaN,EAASM,aAE1B,CAEJ,CAGA,MAAMC,EAAeR,EAAe1H,OAAS,EACzC0H,EAAeS,OAAO,CAACxG,EAAGC,IAAMD,EAAEkG,WAAajG,EAAEiG,WAAalG,EAAIC,GAClE,KAGJ,GAAIsG,GAAgBA,EAAaL,YAAc,GAC7C,MAAO,CACLrN,SAAS,EACT/B,KAAM,CACJ2P,UAAW,IACNF,EACHG,WAAY,QAEd5G,WAAYiG,EAAelL,IAAI8L,IAAA,CAC7BnJ,YAAamJ,EAAEnJ,YACflC,sBAAuBqL,EAAErL,sBACzBC,mBAAoBoL,EAAEpL,mBACtBd,YAAakM,EAAElM,YACfyL,WAAYS,EAAET,WACdC,iBAAkBQ,EAAER,sBAQ5B,MAAM5G,MAAqBC,KAC3BD,EAAeE,SAASF,EAAeG,WAAa,GAEpD,MAAQ5I,KAAM6I,SAA0B5J,KAAKC,SAC1CmB,KAAK,qBACLqB,OAAO,0OAOPqB,IAAI,aAAc0F,EAAeM,eACjCnG,MAAM,aAAc,CAAEC,WAAW,IACjCO,MAAM,KAET,GAAIyF,EACF,IAAA,MAAWtE,KAAYsE,EAAiB,CAEtC,GAAIoG,EAAe9G,KAAK0H,GAAKA,EAAEnJ,cAAgBnC,EAAShD,IAAK,SAG7D,MAAMuE,EAAgBvB,EAASG,QAAQf,aAAe,GAMtD,IALyBD,EACrBzE,KAAK+G,0BAA0BtC,EAAqBoC,GACpD,KAGmB,GACrB,SAGF,MAAMoJ,EAAWjQ,KAAKkQ,uBAAuBJ,EAAgBxK,EAASf,OAAS,IAG3E0L,EAAShJ,OAAS,IACpB+I,EAAe9I,KAAK,CAClBO,YAAanC,EAAShD,GACtBiD,sBAAuBD,EAASC,uBAAyB,GACzDC,mBAAoBF,EAASE,mBAC7Bd,YAAamC,EACbsJ,WAAYF,EAAShJ,MACrBmJ,iBAAkBH,EAASI,aAC3BC,eAAgBR,EAAexH,OAC/B/D,MAAOe,EAASf,OAAS,GACzBgM,YAAaN,EAASM,aAG5B,CAIFP,EAAehG,KAAK,CAACC,EAAGC,IAAMA,EAAEiG,WAAalG,EAAEkG,YAE/C,MAAMO,EAAYV,EAAe1H,OAAS,EAAI0H,EAAe,GAAK,KAElE,MAAO,CACLlN,SAAS,EACT/B,KAAM,CACJ2P,UAAWA,EAAY,IAClBA,EACHC,WAAYD,EAAUP,YAAc,GAAK,OACrCO,EAAUP,YAAc,GAAK,SAC7B,OACF,KACJpG,WAAYiG,EAAe7F,MAAM,EAAG,IAAIrF,IAAI8L,IAAA,CAC1CnJ,YAAamJ,EAAEnJ,YACflC,sBAAuBqL,EAAErL,sBACzBC,mBAAoBoL,EAAEpL,mBACtBd,YAAakM,EAAElM,YACfyL,WAAYS,EAAET,WACdC,iBAAkBQ,EAAER,qBAI5B,OAASnP,GAEP,MAAO,CACL6B,SAAS,EACT7B,MAAOA,aAAiB0B,MAAQ1B,EAAM2B,QAAU,sBAEpD,CACF,CAMQ,sBAAAsN,CACNW,EACAC,GAWA,GAAwB,IAApBD,EAASvI,QAAuC,IAAvBwI,EAAYxI,OACvC,MAAO,CAAErB,MAAO,EAAGoJ,aAAc,EAAGE,YAAa,IAGnD,MAAMA,EAKD,GAGCQ,MAAsBrI,IAC5B,IAAIsI,EAAkB,EAEtB,IAAA,MAAWC,KAAWJ,EAAU,CAC9B,IAAIH,EAAqE,KAEzE,IAAA,MAAWQ,KAAWJ,EAAa,CAEjC,GAAIC,EAAgBhJ,IAAImJ,EAAQ5O,IAAK,SAGrC,MAAM8E,EAAYpH,KAAKqH,wBACrB4J,EAAQ9J,qBAAuB,GAC/B+J,EAAQtL,WAAa,GACrBsL,EAAQrL,eAAiB,IAI3B,IAAIsL,EAAgB,EAChBF,EAAQ1J,oBAAsB2J,EAAQpL,WACpCmL,EAAQ1J,qBAAuB2J,EAAQpL,SACzCqL,EAAgB,GACPF,EAAQ1J,oBAAsB2J,EAAQpL,WAC/CqL,EAAgB,IAGpB,MAAMC,EAAahK,EAAUH,MAAQkK,IAEhCT,GAAaU,EAAaV,EAAU9F,cACvC8F,EAAY,CACVpO,GAAI4O,EAAQ5O,GACZ/B,KAAM2Q,EAAQtL,UACdgF,WAAYwG,GAGlB,CAGIV,GAAaA,EAAU9F,YAAc,KACvCmG,EAAgBM,IAAIX,EAAUpO,IAC9B0O,GAAmBN,EAAU9F,WAC7B2F,EAAYrJ,KAAK,CACfoK,UAAWL,EAAQ3O,GACnBiP,aAAcb,EAAUpO,GACxB0I,eAAgB0F,EAAUnQ,KAC1BqK,WAAY8F,EAAU9F,aAG5B,CAKA,MAAM4G,EAAajB,EAAYjI,OAASuI,EAASvI,OAC3CmJ,EAAgBlB,EAAYjI,OAAS,EACvC0I,EAAkBT,EAAYjI,OAC9B,EAEErB,EAAQmB,KAAK0C,MAAoB,GAAb0G,EAAoC,GAAhBC,GAE9C,MAAO,CACLxK,MAAOmB,KAAKC,IAAI,IAAKpB,GACrBoJ,aAAcE,EAAYjI,OAC1BiI,cAEJ,CAKA,oBAAMmB,CAAevD,GACnB,IACE,MAAQpN,MAAMc,KAAEA,UAAiB7B,KAAKC,SAAS6B,KAAKC,WAG9Cd,MAAEA,SAAgBjB,KAAKC,SAC1BmB,KAAK,mBACLc,OAAO,CACNyP,aAAcxD,EAAQwD,aACtBC,kBAAmBzD,EAAQyD,kBAC3BC,cAAe1D,EAAQ0D,cACvBC,eAAgB3D,EAAQ2D,eACxBC,WAAY5D,EAAQ4D,WACpBC,aAAcnQ,GAAMS,KAGxB,GAAIrB,EAAO,MAAMA,EAEjB,MAAO,CAAE6B,SAAS,EACpB,OAAS7B,GAEP,MAAO,CACL6B,SAAS,EACT7B,MAAOA,aAAiB0B,MAAQ1B,EAAM2B,QAAU,0BAEpD,CACF,CAKA,+BAAMqP,CAA0BC,GAK9B,IAEE,MAAQnR,KAAMwD,SAAgBvE,KAAKC,SAChCmB,KAAK,+BACLqB,OAAO,gBACPS,GAAG,sBAAuBgP,GAE7B,IAAK3N,GAA0B,IAAjBA,EAAM+D,OAClB,MAAO,CAAExF,SAAS,EAAM/B,KAAM,IAGhC,MAAMoR,EAAe,IAAI,IAAIzJ,IAAInE,EAAMO,IAAKoI,GAAgCA,EAAEyE,iBAEtE5Q,KAAMqR,EAAAnR,MAAYA,SAAgBjB,KAAKC,SAC5CmB,KAAK,0BACLqB,OAAO,KACPoH,GAAG,KAAMsI,GACTxO,MAAM,cAAe,CAAEC,WAAW,IAErC,GAAI3C,EAAO,MAAMA,EAEjB,MAAO,CAAE6B,SAAS,EAAM/B,KAAMqR,GAAc,GAC9C,OAASnR,GAEP,MAAO,CACL6B,SAAS,EACT7B,MAAOA,aAAiB0B,MAAQ1B,EAAM2B,QAAU,mBAEpD,CACF","x_google_ignoreList":[0,1]}