import{e,r as t,c as r,j as a,X as s,B as n,a3 as i,a4 as o,v as c}from"./index-B2fe1AdS.js";import{C as d,c as l,T as m}from"./card-B_1zkS1U.js";import{D as u,a as p,b as x,c as h,d as _,P as b,I as g}from"./dialog-DUVaXYsz.js";import{t as f}from"./index-BTwCLR-H.js";import{e as y,S as N,a as j,b as v,c as w,d as S}from"./select-C76T8Meu.js";import{I as C,t as k,n as q,C as M,P as O}from"./PurchaseDetailModal-Mvqf3tHU.js";import{U as $,Z as I,a as E}from"./zoom-out-BJW-XMza.js";import{L as W}from"./loader-circle-Q_l7C3ET.js";import{D as z}from"./download-CCtE4wN_.js";import{S as P}from"./search-BKX69ZPt.js";import{C as R}from"./check-CvQ_W1_B.js";import{C as D}from"./index-BfVTsRpp.js";import{C as T}from"./clock-CIKFuud1.js";import"./helpers-CmqE03mo.js";import"./react-select.esm-C5MKaNnv.js";import"./popover-COhCG0fj.js";import"./textarea-DDPFFRhy.js";import"./calendar-3CKV3bB7.js";import"./credit-card-BgVJo3aw.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const B=e("circle-x",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]),L=e("external-link",[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]]),F=e("refresh-cw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]),H=e("rotate-cw",[["path",{d:"M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8",key:"1p45f6"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}]]),U=e("sliders-horizontal",[["line",{x1:"21",x2:"14",y1:"4",y2:"4",key:"obuewd"}],["line",{x1:"10",x2:"3",y1:"4",y2:"4",key:"1q6298"}],["line",{x1:"21",x2:"12",y1:"12",y2:"12",key:"1iu8h1"}],["line",{x1:"8",x2:"3",y1:"12",y2:"12",key:"ntss68"}],["line",{x1:"21",x2:"16",y1:"20",y2:"20",key:"14d8ph"}],["line",{x1:"12",x2:"3",y1:"20",y2:"20",key:"m0wm8r"}],["line",{x1:"14",x2:"14",y1:"2",y2:"6",key:"14e1ph"}],["line",{x1:"8",x2:"8",y1:"10",y2:"14",key:"1i6ji0"}],["line",{x1:"16",x2:"16",y1:"18",y2:"22",key:"1lctlv"}]]);function A({isOpen:e,onClose:i,onSuccess:o}){const[c,d]=t.useState(null),[l,m]=t.useState(null),[b,g]=t.useState(!1),[y,N]=t.useState(""),j=t.useRef(null),v=r();t.useEffect(()=>{e&&(async()=>{try{const{data:{user:e}}=await v.auth.getUser();if(e?.email){const{data:t}=await v.from("employees").select("name").eq("email",e.email).single();t?.name&&N(t.name)}}catch(e){}})()},[e]);const w=e=>{if(!e.type.startsWith("image/"))return void f.error("Ïù¥ÎØ∏ÏßÄ ÌååÏùºÎßå ÏóÖÎ°úÎìúÌï† Ïàò ÏûàÏäµÎãàÎã§.");if(e.size>10485760)return void f.error("ÌååÏùº ÌÅ¨Í∏∞Îäî 10MB Ïù¥ÌïòÏó¨Ïïº Ìï©ÎãàÎã§.");d(e);const t=new FileReader;t.onloadend=()=>{m(t.result)},t.readAsDataURL(e)},S=()=>{b||(d(null),m(null),j.current&&(j.current.value=""),i())};return a.jsx(u,{open:e,onOpenChange:S,children:a.jsxs(p,{className:"sm:max-w-[480px] business-radius-modal",children:[a.jsx(x,{className:"border-b border-gray-100 pb-3",children:a.jsxs(h,{className:"flex items-center gap-2 text-[13px] font-bold text-gray-900",children:[a.jsx($,{className:"w-4 h-4 text-hansl-600"}),"Í±∞ÎûòÎ™ÖÏÑ∏ÏÑú ÏóÖÎ°úÎìú"]})}),a.jsxs("div",{className:"py-4",children:[a.jsxs("div",{className:`\n              border-2 border-dashed business-radius-card p-6 text-center cursor-pointer transition-colors\n              ${l?"border-hansl-300 bg-hansl-50":"border-gray-200 hover:border-hansl-300 hover:bg-gray-50"}\n            `,onDrop:e=>{e.preventDefault(),e.stopPropagation();const t=e.dataTransfer.files[0];t&&w(t)},onDragOver:e=>{e.preventDefault(),e.stopPropagation()},onClick:()=>{j.current?.click()},children:[a.jsx("input",{ref:j,type:"file",accept:"image/*",onChange:e=>{const t=e.target.files?.[0];t&&w(t)},className:"hidden"}),l?a.jsxs("div",{className:"relative",children:[a.jsx("img",{src:l,alt:"ÎØ∏Î¶¨Î≥¥Í∏∞",className:"max-h-52 mx-auto business-radius-card shadow-sm"}),a.jsx("button",{className:"absolute top-2 right-2 p-1.5 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors",onClick:e=>{e.stopPropagation(),d(null),m(null),j.current&&(j.current.value="")},children:a.jsx(s,{className:"w-3.5 h-3.5"})}),a.jsx("p",{className:"mt-3 text-[11px] text-gray-600 truncate px-4",children:c?.name})]}):a.jsxs(a.Fragment,{children:[a.jsx(C,{className:"w-10 h-10 text-gray-300 mx-auto mb-3"}),a.jsx("p",{className:"text-[11px] text-gray-600 mb-1",children:"Í±∞ÎûòÎ™ÖÏÑ∏ÏÑú Ïù¥ÎØ∏ÏßÄÎ•º ÎìúÎûòÍ∑∏ÌïòÍ±∞ÎÇò ÌÅ¥Î¶≠ÌïòÏó¨ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî"}),a.jsx("p",{className:"text-[10px] text-gray-400",children:"ÏßÄÏõê ÌòïÏãù: JPG, PNG, GIF, WEBP (ÏµúÎåÄ 10MB)"})]})]}),a.jsx("div",{className:"mt-3 p-2.5 bg-blue-50 business-radius-card border border-blue-100",children:a.jsx("p",{className:"text-[10px] text-blue-700 leading-relaxed",children:"üí° Í±∞ÎûòÎ™ÖÏÑ∏ÏÑúÎ•º Ï¥¨ÏòÅÌïòÍ±∞ÎÇò Ïä§Ï∫îÌïú Ïù¥ÎØ∏ÏßÄÎ•º ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî. ÏóÖÎ°úÎìú ÌõÑ OCRÎ°ú ÌíàÎ™©, ÏàòÎüâ, Í∏àÏï°, Î∞úÏ£ºÎ≤àÌò∏ Îì±ÏùÑ ÏûêÎèôÏúºÎ°ú Ï∂îÏ∂úÌï©ÎãàÎã§."})})]}),a.jsxs(_,{className:"border-t border-gray-100 pt-3 gap-2",children:[a.jsx(n,{variant:"outline",onClick:S,disabled:b,className:"button-base h-8 text-[11px]",children:"Ï∑®ÏÜå"}),a.jsx(n,{onClick:async()=>{if(c)try{g(!0);const e=await k.uploadStatement(c,y||"Ïïå Ïàò ÏóÜÏùå");e.success&&e.data?(f.success("ÏóÖÎ°úÎìúÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§."),o(e.data.statementId,e.data.imageUrl),S()):f.error(e.error||"ÏóÖÎ°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.")}catch(e){f.error("ÏóÖÎ°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.")}finally{g(!1)}else f.error("ÌååÏùºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.")},disabled:!c||b,className:"button-base h-8 text-[11px] bg-hansl-600 hover:bg-hansl-700 text-white",children:b?a.jsxs(a.Fragment,{children:[a.jsx(W,{className:"w-3.5 h-3.5 mr-1.5 animate-spin"}),"ÏóÖÎ°úÎìú Ï§ë..."]}):a.jsxs(a.Fragment,{children:[a.jsx($,{className:"w-3.5 h-3.5 mr-1.5"}),"ÏóÖÎ°úÎìú"]})})]})]})})}function G({isOpen:e,imageUrl:r,onClose:n}){const[i,o]=t.useState(1),[c,d]=t.useState(0),l=()=>{o(1),d(0),n()};return r?a.jsx(u,{open:e,onOpenChange:l,children:a.jsxs(p,{className:"max-w-[90vw] max-h-[90vh] p-0 bg-black/95 border-none",children:[a.jsxs("div",{className:"absolute top-0 left-0 right-0 z-50 flex items-center justify-between px-4 py-3 bg-gradient-to-b from-black/80 to-transparent",children:[a.jsxs("div",{className:"flex items-center gap-1.5",children:[a.jsx("button",{onClick:()=>{o(e=>Math.max(e-.25,.5))},disabled:i<=.5,className:"p-2 rounded-lg bg-white/10 hover:bg-white/20 text-white disabled:opacity-40 transition-colors",children:a.jsx(I,{className:"w-4 h-4"})}),a.jsxs("span",{className:"text-[11px] text-white min-w-[50px] text-center font-medium",children:[Math.round(100*i),"%"]}),a.jsx("button",{onClick:()=>{o(e=>Math.min(e+.25,3))},disabled:i>=3,className:"p-2 rounded-lg bg-white/10 hover:bg-white/20 text-white disabled:opacity-40 transition-colors",children:a.jsx(E,{className:"w-4 h-4"})}),a.jsx("div",{className:"w-px h-5 bg-white/30 mx-1.5"}),a.jsx("button",{onClick:()=>{d(e=>(e+90)%360)},className:"p-2 rounded-lg bg-white/10 hover:bg-white/20 text-white transition-colors",children:a.jsx(H,{className:"w-4 h-4"})}),a.jsx("button",{onClick:async()=>{try{const e=await fetch(r),t=await e.blob(),a=window.URL.createObjectURL(t),s=document.createElement("a");s.href=a,s.download=`Í±∞ÎûòÎ™ÖÏÑ∏ÏÑú_${(new Date).toISOString().split("T")[0]}.jpg`,document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(a),f.success("Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§.")}catch(e){f.error("Îã§Ïö¥Î°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.")}},className:"p-2 rounded-lg bg-white/10 hover:bg-white/20 text-white transition-colors",children:a.jsx(z,{className:"w-4 h-4"})})]}),a.jsx("button",{onClick:l,className:"p-2 rounded-lg bg-white/10 hover:bg-white/20 text-white transition-colors",children:a.jsx(s,{className:"w-4 h-4"})})]}),a.jsx("div",{className:"flex items-center justify-center w-full h-[80vh] overflow-auto p-4 pt-16",children:a.jsx("img",{src:r,alt:"Í±∞ÎûòÎ™ÖÏÑ∏ÏÑú",className:"max-w-full max-h-full object-contain transition-transform duration-200",style:{transform:`scale(${i}) rotate(${c}deg)`}})})]})}):null}function J(e,t){const r=e?.toLowerCase().replace(/\s+/g,"")||"",a=t?.toLowerCase().replace(/\s+/g,"")||"";if(!r||!a)return 0;if(r===a)return 100;const s=Math.min(r.length,a.length),n=Math.max(r.length,a.length),i=s/n;if(r.includes(a)||a.includes(r))return i>=.7?90:i>=.5?70:i>=.3?50:30;const o=(n-function(e,t){const r=e.toLowerCase().replace(/\s+/g,""),a=t.toLowerCase().replace(/\s+/g,"");if(r===a)return 0;if(0===r.length)return a.length;if(0===a.length)return r.length;const s=[];for(let n=0;n<=r.length;n++)s[n]=[n];for(let n=0;n<=a.length;n++)s[0][n]=n;for(let n=1;n<=r.length;n++)for(let e=1;e<=a.length;e++){const t=r[n-1]===a[e-1]?0:1;s[n][e]=Math.min(s[n-1][e]+1,s[n][e-1]+1,s[n-1][e-1]+t)}return s[r.length][a.length]}(r,a))/n*100,c=e?.split(/\s+/).filter(e=>e.length>=2)||[],d=t?.split(/\s+/).filter(e=>e.length>=2)||[];if(0===c.length||0===d.length)return o;const l=c.filter(e=>d.some(t=>{const r=e.toLowerCase(),a=t.toLowerCase();return r===a||r.length>=3&&a.includes(r)||a.length>=3&&r.includes(a)})).length/Math.max(c.length,d.length)*15;return Math.min(100,o+l)}function K(e,t,r){const a=J(e,t),s=r?J(e,r):0;return a>=30?a:s>=60&&a<30?Math.min(35,.4*s):Math.max(a,.3*s)}function V(e,t){return null!=e&&(null!=t&&e===t)}function X({isOpen:e,statement:s,onClose:o,onConfirm:c}){const[d,l]=t.useState(!0),[m,b]=t.useState(!1),[g,N]=t.useState(null),[j,v]=t.useState(!1),[w,S]=t.useState(""),[$,I]=t.useState(""),[E,z]=t.useState(new Map),[D,T]=t.useState(new Map),[F,H]=t.useState(new Set),[U,A]=t.useState({top:0,left:0}),[J,X]=t.useState(!1),[Y,Z]=t.useState(null),[Q,ee]=t.useState(new Map),[te,re]=t.useState(null),[ae,se]=t.useState(!1),[ne,ie]=t.useState(""),[oe,ce]=t.useState([]),[de,le]=t.useState(!1),[me,ue]=t.useState(!1),[pe,xe]=t.useState(null),[he,_e]=t.useState(new Map),be=t.useRef(!1),ge=t.useRef(null),[fe,ye]=t.useState(!1),[Ne,je]=t.useState(""),[ve,we]=t.useState([]),[Se,Ce]=t.useState(!1),[ke,qe]=t.useState(!1),[Me,Oe]=t.useState(!1),$e=t.useRef(!1),[Ie,Ee]=t.useState({}),[We,ze]=t.useState({}),[Pe,Re]=t.useState({}),De=t.useRef(null),Te=t.useRef(null),Be=t.useRef(null),[Le,Fe]=t.useState(""),[He,Ue]=t.useState(new Map),Ae=t.useRef(new Set),[Ge,Je]=t.useState(null),Ke=r(),Ve=t.useMemo(()=>{if(!g?.items.length)return!0;const e=g.items.map(e=>e.extracted_po_number?q(e.extracted_po_number):null).filter(Boolean);return 0===e.length||e.every(t=>t===e[0])},[g]),Xe=t.useMemo(()=>{if(!g?.items.length)return null;const e=g.items.find(e=>e.extracted_po_number)?.extracted_po_number;return e?q(e):null},[g]);t.useEffect(()=>{if(!g)return;const e=g.vendor_name||"";e&&!ne&&ie(e),e&&!be.current&&(be.current=!0,lt(e,{silent:!0}))},[g,ne]);const Ye=e=>{if(!e)return"";const t=e.trim();if(!t)return"";if(/^\d{4}-\d{2}-\d{2}$/.test(t))return t;const r=new Date(t);return Number.isNaN(r.getTime())?t.slice(0,10):r.toISOString().slice(0,10)};t.useEffect(()=>{g&&Fe(Ye(g.statement_date))},[g]),t.useEffect(()=>{if(!e)return;const t=Te.current,r=Be.current;if(!t||!r)return;const a=t.getBoundingClientRect(),s=r.getBoundingClientRect(),n=t.offsetWidth-t.clientWidth;fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"StatementConfirmModal.tsx:layout:headerGap",message:"table_layout_metrics",data:{containerClientWidth:t.clientWidth,containerScrollWidth:t.scrollWidth,containerOffsetWidth:t.offsetWidth,tableWidth:r.offsetWidth,tableScrollWidth:r.scrollWidth,scrollbarWidth:n,containerRectWidth:a.width,tableRectWidth:s.width},timestamp:Date.now(),sessionId:"debug-session",runId:"run5",hypothesisId:"H1"})}).catch(()=>{}),fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"StatementConfirmModal.tsx:layout:padding",message:"container_padding",data:{containerPaddingRight:window.getComputedStyle(t).paddingRight,containerPaddingLeft:window.getComputedStyle(t).paddingLeft,containerBg:window.getComputedStyle(t).backgroundColor},timestamp:Date.now(),sessionId:"debug-session",runId:"run6",hypothesisId:"H2"})}).catch(()=>{}),fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"StatementConfirmModal.tsx:layout:tableStyles",message:"table_styles",data:{tableBg:window.getComputedStyle(r).backgroundColor,tableWidthStyle:window.getComputedStyle(r).width,tableMinWidth:window.getComputedStyle(r).minWidth,tbodyBg:window.getComputedStyle(r.tBodies[0]).backgroundColor,theadBg:window.getComputedStyle(r.tHead).backgroundColor},timestamp:Date.now(),sessionId:"debug-session",runId:"run7",hypothesisId:"H3"})}).catch(()=>{});const i=r.tBodies[0]?.rows?.[0],o=i?.cells?.[0],c=o?.getBoundingClientRect(),d=c?c.left-s.left:null;fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"StatementConfirmModal.tsx:layout:leftGap",message:"table_left_gap",data:{firstCellLeftGap:d,tableBorderSpacing:window.getComputedStyle(r).borderSpacing,tablePaddingLeft:window.getComputedStyle(r).paddingLeft,tbodyPaddingLeft:window.getComputedStyle(r.tBodies[0]).paddingLeft,firstCellPaddingLeft:o?window.getComputedStyle(o).paddingLeft:null},timestamp:Date.now(),sessionId:"debug-session",runId:"run8",hypothesisId:"H4"})}).catch(()=>{})},[e,g]);const Ze=t.useCallback(async()=>{try{l(!0);const{data:{user:e}}=await Ke.auth.getUser();if(e?.email){const{data:t}=await Ke.from("employees").select("name").eq("email",e.email).single();t?.name&&S(t.name)}const t=await k.getStatementWithItems(s.id);if(t.success&&t.data){N(t.data);const e=new Map,r=new Map;t.data.items.forEach(t=>{let a="";if(t.extracted_po_number){a=q(t.extracted_po_number);const r=t.match_candidates?.some(e=>e.purchase_order_number===a||e.sales_order_number===a);r&&e.set(t.id,a)}if(t.matched_purchase&&t.matched_item_id){const a=t.matched_purchase.purchase_order_number||t.matched_purchase.sales_order_number||"";a&&e.set(t.id,a),r.set(t.id,{purchase_id:t.matched_purchase_id,item_id:t.matched_item_id,purchase_order_number:t.matched_purchase.purchase_order_number||"",sales_order_number:t.matched_purchase.sales_order_number,item_name:t.matched_item_name||"",quantity:t.matched_item_quantity,unit_price:t.matched_item_unit_price,amount:t.matched_item_amount,vendor_name:t.matched_purchase.vendor_name})}else{let s=null,n=-1;const i=t.match_candidates?.filter(e=>e.purchase_order_number===a||e.sales_order_number===a)||[];for(const e of i){const r=K(t.extracted_item_name||"",e.item_name,e.specification);r>n&&(n=r,s={purchase_id:e.purchase_id,item_id:e.item_id,purchase_order_number:e.purchase_order_number||"",sales_order_number:e.sales_order_number,item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price:e.unit_price,amount:e.amount,vendor_name:e.vendor_name})}if(!s&&t.match_candidates&&t.match_candidates.length>0){for(const e of t.match_candidates){const r=K(t.extracted_item_name||"",e.item_name,e.specification);r>n&&r>=40&&(n=r,s={purchase_id:e.purchase_id,item_id:e.item_id,purchase_order_number:e.purchase_order_number||"",sales_order_number:e.sales_order_number,item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price:e.unit_price,amount:e.amount,vendor_name:e.vendor_name})}if(s){const r=s.purchase_order_number||s.sales_order_number||"";r&&e.set(t.id,r)}}if(!e.has(t.id)&&t.match_candidates&&t.match_candidates.length>0){const a=t.match_candidates.reduce((e,t)=>e?(t.score??-1)>(e.score??-1)?t:e:t,t.match_candidates[0]),n=a.purchase_order_number||a.sales_order_number||"";if(n&&e.set(t.id,n),!s&&n){const e=t.match_candidates.filter(e=>e.purchase_order_number===n||e.sales_order_number===n);let a=null,s=-1;for(const r of e){const e=K(t.extracted_item_name||"",r.item_name,r.specification);e>s&&(s=e,a={purchase_id:r.purchase_id,item_id:r.item_id,purchase_order_number:r.purchase_order_number||"",sales_order_number:r.sales_order_number,item_name:r.item_name,specification:r.specification,quantity:r.quantity,unit_price:r.unit_price,amount:r.amount,vendor_name:r.vendor_name})}a&&r.set(t.id,a)}}r.has(t.id)||r.set(t.id,s)}}),z(e),T(r);const a=t.data.items.find(e=>e.extracted_po_number)?.extracted_po_number;a&&I(q(a));const s=t.data.items.map(e=>e.extracted_po_number?q(e.extracted_po_number):null).filter(Boolean);if(0===s.length||s.every(e=>e===s[0])){const e=await k.findBestMatchingPurchaseOrderSet(t.data.items,a,t.data.vendor_name);if(e.success&&e.data&&(Je(e.data),e.data.bestMatch)){const a=e.data.bestMatch.purchase_order_number||e.data.bestMatch.sales_order_number||"";I(a);const s=new Map;e.data.bestMatch.itemMatches.forEach(e=>{for(const r of t.data.items){const t=r.match_candidates?.find(t=>t.item_id===e.systemItemId);if(t){s.set(e.ocrItemId,{purchase_id:t.purchase_id,item_id:t.item_id,purchase_order_number:t.purchase_order_number||"",sales_order_number:t.sales_order_number,item_name:t.item_name,specification:t.specification,quantity:t.quantity,unit_price:t.unit_price,amount:t.amount,vendor_name:t.vendor_name});break}}});const n=new Map(r);s.forEach((e,t)=>{e&&n.set(t,e)}),T(n);const i=e.data.bestMatch.confidence,o="high"===i?"ÎÜíÏùå":"medium"===i?"Î≥¥ÌÜµ":"ÎÇÆÏùå";f.success(`ÏÑ∏Ìä∏ Îß§Ïπ≠ ÏôÑÎ£å! ${e.data.bestMatch.matchedItemCount}/${t.data.items.length}Í∞ú ÌíàÎ™© Îß§Ïπ≠ (Ïã†Î¢∞ÎèÑ: ${o})`)}}}else f.error(t.error||"Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.")}catch(e){f.error("Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.")}finally{l(!1)}},[s.id,Ke]);t.useEffect(()=>{e&&s&&(Oe(!1),Ze())},[e,s,Ze]),t.useEffect(()=>{if(!g||!e)return;if(d)return;const t=new Map,r=new Map(E);let a=!1,s=!1;g.items.forEach(e=>{const n=D.get(e.id),i=Ve?$:E.get(e.id)||(e.extracted_po_number?q(e.extracted_po_number):"");if(n&&(n.purchase_order_number===i||n.sales_order_number===i))return void t.set(e.id,n);let o=null,c=-1;const d=i&&e.match_candidates?.filter(e=>e.purchase_order_number===i||e.sales_order_number===i)||[];for(const t of d){const r=K(e.extracted_item_name||"",t.item_name,t.specification);r>c&&(c=r,o={purchase_id:t.purchase_id,item_id:t.item_id,purchase_order_number:t.purchase_order_number||"",sales_order_number:t.sales_order_number,item_name:t.item_name,specification:t.specification,quantity:t.quantity,unit_price:t.unit_price,amount:t.amount,vendor_name:t.vendor_name})}if(!o&&e.match_candidates)for(const t of e.match_candidates){const r=K(e.extracted_item_name||"",t.item_name,t.specification);r>c&&r>=40&&(c=r,o={purchase_id:t.purchase_id,item_id:t.item_id,purchase_order_number:t.purchase_order_number||"",sales_order_number:t.sales_order_number,item_name:t.item_name,specification:t.specification,quantity:t.quantity,unit_price:t.unit_price,amount:t.amount,vendor_name:t.vendor_name})}if(t.set(e.id,o),o){const t=o.purchase_order_number||o.sales_order_number||"",a=E.get(e.id)||"";t&&t!==a&&(r.set(e.id,t),s=!0)}n!==o&&(a=!0)}),a&&T(t),s&&z(r)},[$,Ve,g,e,d]);const Qe=t.useMemo(()=>{if(!g)return[];const e=g.items.find(e=>e.extracted_po_number)?.extracted_po_number||"",t=(e?q(e).toUpperCase():"").startsWith("HS"),r=new Map;Ge?.candidates&&Ge.candidates.forEach(e=>{const a=t&&e.sales_order_number||e.purchase_order_number;a&&r.set(a,{poNumber:e.purchase_order_number||"",salesOrderNumber:e.sales_order_number,itemCount:e.matchedItemCount,items:[],vendorName:e.vendor_name,setMatchScore:e.matchScore,matchedItemCount:e.matchedItemCount,purchaseId:e.purchase_id})}),g.items.forEach(e=>{e.match_candidates?.forEach(e=>{const a=t?e.sales_order_number||"":e.purchase_order_number||"";if(a&&!r.has(a)&&r.set(a,{poNumber:e.purchase_order_number||"",salesOrderNumber:e.sales_order_number,itemCount:0,items:[],vendorName:e.vendor_name,purchaseId:e.purchase_id}),a&&r.has(a)){const t=r.get(a);t.items.push(e),t.setMatchScore||(t.itemCount=t.items.length)}})}),he.size>0&&he.forEach((e,a)=>{const s=q(a),n=s.startsWith("HS");t&&!n||!t&&n||r.has(s)||r.set(s,{poNumber:n?"":s,salesOrderNumber:n?s:void 0,itemCount:e.length,items:e.map(e=>({purchase_id:e.purchase_id,purchase_order_number:e.purchase_order_number||"",sales_order_number:e.sales_order_number,item_id:e.item_id,item_name:e.item_name,specification:e.specification,quantity:e.quantity??0,unit_price:e.unit_price,vendor_name:e.vendor_name,score:0,match_reasons:["po_items_map"]})),vendorName:e[0]?.vendor_name,purchaseId:e[0]?.purchase_id})}),r.forEach((e,t)=>{let r=0,a=0,s=0,n=0;const i=q(t).toUpperCase(),o=g.items.map(e=>{const t=nt(e,"po_number");return t?q(t).toUpperCase():null}).filter(Boolean).some(e=>e===i),c=e.items;g.items.forEach(e=>{let t=0,i=null;const o=nt(e,"item_name");for(const r of c){const e=r,a=K(o||"",e.item_name,e.specification);a>t&&(t=a,i=e)}if(t>=40&&null!==i){a++;const t=nt(e,"quantity"),r="number"==typeof t?t:""!==t?Number(t):void 0,o=i.quantity;void 0!==r&&!Number.isNaN(r)&&V(r,o)?s++:n++}r+=t});const d=g.items.length>0?Math.round(r/g.items.length):0,l=a>0&&s===a?10:0,m=Math.min(100,d+l),u=o?100:0;void 0===e.setMatchScore?(e.setMatchScore=m+u,e.displayScore=m,e.matchedItemCount=a):o&&(e.setMatchScore=(e.setMatchScore??0)+u,void 0===e.displayScore&&(e.displayScore=e.setMatchScore-u)),e.quantityMatchedCount=s,e.quantityMismatchedCount=n,e.hasOrderNumberMatch=o});const a=Array.from(r.values());return a.sort((e,t)=>{const r=e.hasOrderNumberMatch?1:0,a=t.hasOrderNumberMatch?1:0;if(r!==a)return a-r;const s=e.setMatchScore??0,n=t.setMatchScore??0;return s!==n?n-s:t.itemCount-e.itemCount}),a},[g,Ge,he,Q]),et=t.useCallback(e=>{if(!e)return;const t=q(e),r=Qe.find(r=>r.poNumber===t||r.salesOrderNumber===t||r.poNumber===e||r.salesOrderNumber===e);if(r)return t.startsWith("F")?r.salesOrderNumber:t.startsWith("HS")?r.poNumber:r.salesOrderNumber||r.poNumber;const a=he.get(t)||he.get(e)||[];if(a.length>0){const e=a[0];return t.startsWith("F")?e.sales_order_number:t.startsWith("HS")?e.purchase_order_number||e.purchase_order_number:e.sales_order_number||e.purchase_order_number}},[Qe,he]),tt=e=>{if(!e)return;const t=q(e),r=He.get(t);return void 0!==r?r||void 0:et(e)};t.useEffect(()=>{if(!Qe.length||!Ve)return;if(Me)return;const e=Qe.find(e=>!0===e.hasOrderNumberMatch);if(e){const t=e.poNumber||e.salesOrderNumber||"";if(t&&t!==$)return void I(t)}if(!Qe.some(e=>e.poNumber===$||e.salesOrderNumber===$)&&Qe[0]){const e=Qe[0],t=e.poNumber||e.salesOrderNumber||"";t&&I(t)}},[Qe,$,Ve,Me]);const rt=t.useCallback(e=>{if(!g||!e)return[];const t=he.get(e)||[];if(t.length>0){return t.filter((e,t,r)=>t===r.findIndex(t=>t.item_id===e.item_id))}const r=[];g.items.forEach(t=>{t.match_candidates?.forEach(t=>{t.purchase_order_number!==e&&t.sales_order_number!==e||r.push({purchase_id:t.purchase_id,item_id:t.item_id,purchase_order_number:t.purchase_order_number||"",sales_order_number:t.sales_order_number,item_name:t.item_name,specification:t.specification,quantity:t.quantity,unit_price:t.unit_price,amount:t.amount,vendor_name:t.vendor_name})})});return r.filter((e,t,r)=>t===r.findIndex(t=>t.item_id===e.item_id))},[g,he]),at=t.useCallback(e=>{if(!g)return[];const t=g.items.find(t=>t.id===e);if(!t)return[];const r=new Set,a=(t.extracted_po_number?q(t.extracted_po_number).toUpperCase():"").startsWith("HS");t.match_candidates?.forEach(e=>{a?e.sales_order_number&&r.add(e.sales_order_number):e.purchase_order_number&&r.add(e.purchase_order_number)});return Array.from(r)},[g]),st=(e,t,r)=>{ee(a=>{const s=new Map(a),n=s.get(e)||{};return s.set(e,{...n,[t]:r}),s})};function nt(e,t){const r=Q.get(e.id);if(r&&void 0!==r[t])return r[t];switch(t){case"item_name":return e.extracted_item_name||"";case"quantity":return e.extracted_quantity??"";case"unit_price":return e.extracted_unit_price??"";case"amount":return e.extracted_amount??"";case"po_number":return E.get(e.id)||(e.extracted_po_number?q(e.extracted_po_number):"");default:return""}}const it=(e,t)=>{const r=Q.get(e.id);if(!r||void 0===r[t])return!1;switch(t){case"item_name":return r.item_name!==e.extracted_item_name;case"quantity":return r.quantity!==e.extracted_quantity;case"unit_price":return r.unit_price!==e.extracted_unit_price;case"amount":return r.amount!==e.extracted_amount;case"po_number":{const t=e.extracted_po_number?q(e.extracted_po_number):"";return r.po_number!==t}default:return!1}},ot=async(e,t,r)=>{if(I(e),r){const t=q(e);Ue(e=>{const a=new Map(e);return a.set(t,r),a})}const a=Qe.find(t=>t.poNumber===e||t.salesOrderNumber===e);let s=[],n=t||"";if(a&&a.items.length>0&&(s=a.items.map(e=>({purchase_id:e.purchase_id,item_id:e.item_id,purchase_order_number:e.purchase_order_number||"",sales_order_number:e.sales_order_number,item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price:e.unit_price,amount:e.amount,vendor_name:e.vendor_name})),s=s.filter((e,t,r)=>t===r.findIndex(t=>t.item_id===e.item_id)),!n&&s[0]?.vendor_name&&(n=s[0].vendor_name)),0===s.length&&(s=rt(e),!n&&s[0]?.vendor_name&&(n=s[0].vendor_name)),0===s.length)try{const{data:t}=await Ke.from("purchase_requests").select("\n            id,\n            purchase_order_number,\n            sales_order_number,\n            vendor:vendors(vendor_name)\n          ").or(`purchase_order_number.eq.${e},sales_order_number.eq.${e}`).limit(1).single();if(t){!n&&t.vendor?.vendor_name&&(n=t.vendor.vendor_name);const r=q(e),a=e.startsWith("F")?t.sales_order_number:t.purchase_order_number;a&&Ue(e=>{const t=new Map(e);return t.set(r,a),t});const{data:i}=await Ke.from("purchase_request_items").select("\n              id,\n              item_name,\n              specification,\n              quantity,\n              received_quantity,\n              unit_price_value,\n              amount_value\n            ").eq("purchase_request_id",t.id);i&&i.length>0&&(s=i.map(e=>({purchase_id:t.id,item_id:e.id,purchase_order_number:t.purchase_order_number||"",sales_order_number:t.sales_order_number,item_name:e.item_name||"",specification:e.specification,quantity:e.quantity,received_quantity:e.received_quantity,unit_price:e.unit_price_value,amount:e.amount_value,vendor_name:n})))}}catch(i){}if(s.length>0&&_e(t=>{const r=new Map(t);r.set(e,s);const a=s[0]?.sales_order_number;return a&&a!==e&&r.set(a,s),r}),n&&ie(n),g){const e=new Map;g.items.forEach(t=>{let r=null,a=0;s.forEach(e=>{const s=K(t.extracted_item_name||"",e.item_name,e.specification);s>a&&s>=40&&(a=s,r=e)}),e.set(t.id,r)}),T(e)}},ct=t.useCallback(async e=>{const t=e.trim();if(!t)return;const r=q(t);if(r&&!He.has(r)&&!Ae.current.has(r)){Ae.current.add(r);try{const{data:e,error:t}=await Ke.from("purchase_requests").select("purchase_order_number,sales_order_number").or(`purchase_order_number.eq.${r},sales_order_number.eq.${r}`).limit(1);if(t)throw t;const a=e?.[0],s=a?r.startsWith("F")?a.sales_order_number:r.startsWith("HS")?a.purchase_order_number:a.sales_order_number||a.purchase_order_number:null;Ue(e=>{const t=new Map(e);return t.set(r,s??null),t})}catch(a){Ue(e=>{const t=new Map(e);return t.set(r,null),t})}finally{Ae.current.delete(r)}}},[He,Ke]),dt=t.useCallback(async e=>{ct(e),g&&g.items.forEach(t=>{st(t.id,"po_number",e)});const t=q(e);if(!t)return;const r=Qe.find(e=>e.poNumber===t||e.salesOrderNumber===t);if(r){const e=r.poNumber||r.salesOrderNumber||"";e&&e!==$&&I(e),r.vendorName&&(ie(r.vendorName),xe(r.vendorName))}else{I(t);try{const{data:e}=await Ke.from("purchase_requests").select("\n            id,\n            purchase_order_number,\n            sales_order_number,\n            vendor:vendors(vendor_name),\n            purchase_request_items (\n              id,\n              item_name,\n              specification,\n              quantity,\n              received_quantity,\n              unit_price_value,\n              amount_value\n            )\n          ").or(`purchase_order_number.eq.${t},sales_order_number.eq.${t}`).limit(1);if(e&&e.length>0){const r=e[0],a=r.purchase_request_items||[],s=r.vendor?.vendor_name||"",n=a.map(e=>({purchase_id:r.id,item_id:e.id,purchase_order_number:r.purchase_order_number||"",sales_order_number:r.sales_order_number,item_name:e.item_name,specification:e.specification,quantity:e.quantity??0,received_quantity:e.received_quantity,unit_price:e.unit_price_value,amount:e.amount_value,vendor_name:s}));_e(e=>{const a=new Map(e);return a.set(t,n),r.purchase_order_number&&a.set(r.purchase_order_number,n),r.sales_order_number&&a.set(r.sales_order_number,n),a}),s&&(ie(s),xe(s))}}catch(a){}}},[g,Qe,$,ct,st,Ke]),lt=async(e,t)=>{const r=!t?.silent;xe(e),ie(e),ue(!1),ce([]),r&&f.success(`Í±∞ÎûòÏ≤òÍ∞Ä "${e}"(Ïúº)Î°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§. Î∞úÏ£º ÌõÑÎ≥¥Î•º Îã§Ïãú Í≤ÄÏÉâÌï©ÎãàÎã§.`);try{const{data:t,error:a}=await Ke.from("purchase_requests").select("\n          id,\n          purchase_order_number,\n          sales_order_number,\n          vendor:vendors!inner(vendor_name),\n          items:purchase_request_items(\n            id,\n            item_name,\n            specification,\n            quantity,\n            received_quantity,\n            unit_price_value,\n            amount_value\n          )\n        ").eq("vendor.vendor_name",e).order("created_at",{ascending:!1}).limit(50);if(a)throw a;if(!t||0===t.length)return void(r&&f.error(`"${e}" Í±∞ÎûòÏ≤òÏùò Î∞úÏ£º ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.`));const s=new Map;let n=0;t.forEach(t=>{const r=(t.items||[]).map(r=>({purchase_id:t.id,item_id:r.id,purchase_order_number:t.purchase_order_number||"",sales_order_number:t.sales_order_number,item_name:r.item_name||"",specification:r.specification,quantity:r.quantity,received_quantity:r.received_quantity,unit_price:r.unit_price_value,amount:r.amount_value,vendor_name:e}));0!==r.length&&(n+=r.length,t.purchase_order_number&&s.set(t.purchase_order_number,r),t.sales_order_number&&s.set(t.sales_order_number,r))}),_e(s);const i=new Map,o=t[0]?.purchase_order_number||t[0]?.sales_order_number||"";if(g){g.items.forEach((r,a)=>{const s=[];let n=0,o=0;t.forEach(t=>{(t.items||[]).forEach(a=>{const i=K(r.extracted_item_name||"",a.item_name,a.specification);o+=1,i>n&&(n=i),i>=40&&s.push({purchase_id:t.id,item_id:a.id,purchase_order_number:t.purchase_order_number||"",sales_order_number:t.sales_order_number,item_name:a.item_name||"",specification:a.specification,quantity:a.quantity,unit_price:a.unit_price_value,score:i,match_reasons:["Í±∞ÎûòÏ≤ò Îß§Ïπ≠"],vendor_name:e})})}),s.sort((e,t)=>t.score-e.score),i.set(r.id,s.slice(0,5))}),I(o);const a=new Map,s=(t[0]?.items||[]).map(r=>({purchase_id:t[0].id,item_id:r.id,purchase_order_number:t[0].purchase_order_number||"",sales_order_number:t[0].sales_order_number,item_name:r.item_name||"",specification:r.specification,quantity:r.quantity,unit_price:r.unit_price_value,amount:r.amount_value,vendor_name:e}));g.items.forEach(e=>{let t=null,r=0;s.forEach(a=>{const s=K(e.extracted_item_name||"",a.item_name,a.specification);s>r&&s>=30&&(r=s,t=a)}),a.set(e.id,t)}),T(a),Je({bestMatch:{purchase_id:t[0].id,purchase_order_number:t[0].purchase_order_number||"",sales_order_number:t[0].sales_order_number,vendor_name:e,matchScore:100,matchedItemCount:a.size,totalItemCount:g.items.length,confidence:"high",itemMatches:[]},candidates:t.map(r=>({purchase_id:r.id,purchase_order_number:r.purchase_order_number||"",sales_order_number:r.sales_order_number,vendor_name:e,matchScore:r.id===t[0].id?100:50,matchedItemCount:(r.items||[]).length}))}),r&&f.success(`${t.length}Í∞ú Î∞úÏ£º ÌõÑÎ≥¥Î•º Ï∞æÏïòÏäµÎãàÎã§. ÏûêÎèô Îß§Ïπ≠ ÏôÑÎ£å.`)}}catch(a){f.error("Î∞úÏ£º ÌõÑÎ≥¥ Í≤ÄÏÉâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.")}},mt=(e,t)=>{z(r=>{const a=new Map(r);return a.set(e,t),a});const r=g?.items.find(t=>t.id===e);if(r){const a=r.match_candidates?.filter(e=>e.purchase_order_number===t||e.sales_order_number===t)||[];let s=null,n=-1;if(a.length>0&&a.forEach(e=>{const t=K(r.extracted_item_name||"",e.item_name,e.specification);t>n&&(n=t,s={purchase_id:e.purchase_id,item_id:e.item_id,purchase_order_number:e.purchase_order_number||"",sales_order_number:e.sales_order_number,item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price:e.unit_price,amount:e.amount,vendor_name:e.vendor_name})}),!s){rt(t).forEach(e=>{const t=K(r.extracted_item_name||"",e.item_name,e.specification);t>n&&(n=t,s=e)})}T(t=>{const r=new Map(t);return r.set(e,s),r})}H(t=>{const r=new Set(t);return r.delete(`po-${e}`),r})},ut=t.useCallback(e=>{const t=Qe.find(t=>t.poNumber===e||t.salesOrderNumber===e);return t?.purchaseId||t?.items?.[0]?.purchase_id},[Qe]),pt=t.useCallback(async(e,t)=>{if(Ee(r=>({...r,[e]:t})),!t||t.trim().length<2)ze(t=>({...t,[e]:[]}));else{Re(t=>({...t,[e]:!0}));try{const{data:r,error:a}=await Ke.from("purchase_requests").select("\n          id,\n          purchase_order_number,\n          sales_order_number,\n          vendor:vendors(vendor_name)\n        ").or(`purchase_order_number.ilike.%${t}%,sales_order_number.ilike.%${t}%`).order("created_at",{ascending:!1}).limit(20);if(a)throw a;const s=(r||[]).map(e=>({id:e.id,poNumber:e.purchase_order_number||"",soNumber:e.sales_order_number||void 0,vendorName:e.vendor?.vendor_name}));ze(t=>({...t,[e]:s}))}catch(r){ze(t=>({...t,[e]:[]}))}finally{Re(t=>({...t,[e]:!1}))}}},[Ke]),xt=(e,t)=>{De.current=e,T(r=>{const a=new Map(r);return a.set(e,t),a}),H(t=>{const r=new Set(t);return r.delete(`item-${e}`),r})};t.useEffect(()=>{if(!De.current)return;const e=De.current;D.get(e)},[D]),t.useEffect(()=>{if(!g||0===D.size)return;let e=!1;const t=new Map(D);g.items.forEach(r=>{const a=D.get(r.id);if(!a||null!=a.received_quantity)return;const s=Ve?$:E.get(r.id)||(r.extracted_po_number?q(r.extracted_po_number):""),n=s?rt(s):[];if(0===n.length)return;const i=n.find(e=>e.item_id===a.item_id);i&&null!=i.received_quantity&&(t.set(r.id,{...a,received_quantity:i.received_quantity}),e=!0)}),e&&T(t)},[g,D,Ve,$,E,rt]);const ht=e=>null==e?"-":e.toLocaleString("ko-KR"),_t=e=>{if(!e)return"";const t=e.item_name?.trim();if(t)return t;const r=e.specification?.trim();return r||`ÌíàÎ™© #${e.item_id}`},bt=(e,t)=>{if(e.startsWith("item-"),t&&"global-po"===e){const e=t.currentTarget.getBoundingClientRect();A({top:e.bottom+4,left:e.left})}H(t=>{const r=new Set(t);return r.has(e)?r.delete(e):(r.clear(),r.add(e)),r})};return s?a.jsxs(a.Fragment,{children:[a.jsx(u,{open:e,onOpenChange:o,children:a.jsxs(p,{className:"max-w-[95vw] md:max-w-[1200px] max-h-[90vh] overflow-hidden flex flex-col business-radius-modal",showCloseButton:!1,onInteractOutside:e=>{F.size>0&&e.preventDefault()},children:[a.jsx(x,{className:"border-b border-gray-100 pb-3 px-4",children:a.jsxs(h,{className:"flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-2 modal-title",children:[a.jsx(M,{className:"w-4 h-4 text-hansl-600"}),"Í±∞ÎûòÎ™ÖÏÑ∏ÏÑú ÌôïÏù∏ Î∞è ÌôïÏ†ï"]}),a.jsxs(n,{variant:"outline",size:"sm",onClick:()=>{const e=g?.image_url||s.image_url;if(!e)return;const t=Math.max(0,window.screenX+(window.outerWidth-1e3)/2),r=Math.max(0,window.screenY+(window.outerHeight-800)/2);window.open(e,"transaction-statement-image",`width=1000,height=800,left=${t},top=${r}`)},className:"button-base h-7 text-[10px]",children:[a.jsx(C,{className:"w-3.5 h-3.5 mr-1"}),"ÏõêÎ≥∏ Î≥¥Í∏∞"]})]})}),d?a.jsxs("div",{className:"flex items-center justify-center py-12",children:[a.jsx(W,{className:"w-6 h-6 animate-spin text-hansl-600"}),a.jsx("span",{className:"ml-3 modal-subtitle",children:"Î°úÎî© Ï§ë..."})]}):g?a.jsxs("div",{className:"flex-1 overflow-hidden flex flex-col py-3 px-4",children:[a.jsxs("div",{className:"flex items-center gap-6 p-3 bg-gray-50 business-radius-card mb-4",children:[a.jsxs("div",{className:"relative",children:[a.jsx("p",{className:"modal-label",children:"Í±∞ÎûòÏ≤ò"}),a.jsxs("div",{className:"relative",children:[a.jsx("input",{type:"text",value:ne,onChange:e=>{ie(e.target.value),(async e=>{if(!e.trim())return ce([]),void ue(!1);le(!0),ue(!0);try{const{data:t,error:r}=await Ke.from("vendors").select("id, vendor_name").ilike("vendor_name",`%${e}%`).limit(10);if(r)throw r;ce((t||[]).map(e=>({id:e.id,name:e.vendor_name})))}catch(t){ce([])}finally{le(!1)}})(e.target.value)},onFocus:()=>{oe.length>0&&ue(!0)},onBlur:()=>{setTimeout(()=>ue(!1),200)},placeholder:"Í±∞ÎûòÏ≤ò Í≤ÄÏÉâ...",className:"w-[120px] h-5 px-1.5 bg-white border business-radius focus:outline-none focus:ring-1 focus:ring-hansl-400 "+(pe?"border-green-400 text-green-700":"border-gray-300 text-gray-900"),style:{fontSize:"11px",fontWeight:700}}),de&&a.jsx(W,{className:"absolute right-2 top-1/2 -translate-y-1/2 w-3 h-3 animate-spin text-gray-400"}),me&&oe.length>0&&a.jsx("div",{className:"absolute top-full left-0 mt-1 w-[200px] bg-white border border-gray-200 rounded-lg shadow-lg z-50 max-h-[180px] overflow-y-auto",children:oe.map(e=>a.jsx("button",{onMouseDown:e=>e.preventDefault(),onClick:()=>{ie(e.name),ue(!1),lt(e.name)},className:"w-full px-2 py-1.5 text-left hover:bg-gray-50 border-b border-gray-100 last:border-b-0",children:a.jsx("div",{className:"text-[10px] font-medium text-gray-900",children:e.name})},e.id))})]})]}),a.jsxs("div",{children:[a.jsx("p",{className:"modal-label",children:"Í±∞ÎûòÏùº"}),a.jsx("input",{type:"date",value:Le,onChange:e=>Fe(e.target.value),className:"w-[120px] h-5 px-1.5 bg-white border border-gray-300 business-radius-input focus:outline-none focus:ring-1 focus:ring-hansl-400 text-gray-900",style:{fontSize:"11px",fontWeight:600}})]}),a.jsxs("div",{children:[a.jsx("p",{className:"modal-label",children:"Ìï©Í≥ÑÍ∏àÏï°"}),a.jsxs("p",{className:"modal-value-large",children:[ht(g.grand_total),"Ïõê"]})]}),a.jsxs("div",{children:[a.jsx("p",{className:"modal-label",children:"ÌíàÎ™© Ïàò"}),a.jsxs("p",{className:"modal-value",children:[g.items.length,"Í±¥"]})]})]}),a.jsx("div",{className:"flex-1 overflow-auto border border-gray-200 business-radius-card bg-gray-100",ref:Te,children:a.jsxs("table",{className:"modal-value table-auto min-w-full",ref:Be,style:{borderCollapse:"collapse",borderSpacing:0},children:[a.jsxs("thead",{className:"bg-gray-100 sticky top-0 z-10",children:[a.jsxs("tr",{className:"border-b border-gray-200",children:[a.jsx("th",{colSpan:Ve?4:5,className:"border-r-2 border-gray-300 p-2 text-left w-[45%]",children:a.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[a.jsx("span",{className:"modal-section-title text-gray-700",children:"ÏãúÏä§ÌÖú Î∞úÏ£ºÌíàÎ™©"}),Ve&&Qe.length>0&&a.jsxs("div",{className:"relative flex items-center gap-1",children:[a.jsxs("button",{onClick:e=>bt("global-po",e),className:"inline-flex items-center gap-1 px-1.5 h-5 text-[10px] font-medium bg-white border border-gray-300 rounded-md hover:bg-gray-50 text-gray-700",children:[(()=>{if(!$)return"Î∞úÏ£ºÎ≤àÌò∏ ÏÑ†ÌÉù";const e=Qe.find(e=>e.poNumber===$||e.salesOrderNumber===$);if(e?.poNumber&&e?.salesOrderNumber)return a.jsxs(a.Fragment,{children:[e.poNumber," ",a.jsxs("span",{className:"text-gray-400",children:["(",e.salesOrderNumber,")"]})]});const t=et($);return t?a.jsxs(a.Fragment,{children:[$," ",a.jsxs("span",{className:"text-gray-400",children:["(",t,")"]})]}):$})(),a.jsx(y,{className:"w-3 h-3"})]}),Xe&&$&&Xe!==$&&a.jsx("span",{className:"text-[9px] text-orange-500",title:"OCR Ï∂îÏ∂ú Î∞úÏ£ºÎ≤àÌò∏ÏôÄ Îã§Î•∏ Î∞úÏ£ºÍ∞Ä Îß§Ïπ≠Îê®",children:"‚ö†Ô∏è"}),a.jsx("div",{className:"relative flex items-center",children:fe?a.jsxs(a.Fragment,{children:[a.jsx("input",{type:"text",value:Ne,onChange:e=>{je(e.target.value),(async e=>{if(!e.trim())return we([]),void qe(!1);Ce(!0),qe(!0);try{const t=q(e.trim()),{data:r,error:a}=await Ke.from("purchase_requests").select("\n          id,\n          purchase_order_number,\n          sales_order_number,\n          vendor:vendors(vendor_name)\n        ").or(`purchase_order_number.ilike.%${t}%,sales_order_number.ilike.%${t}%`).order("created_at",{ascending:!1}).limit(10);if(a)throw a;we((r||[]).map(e=>({id:e.id,poNumber:e.purchase_order_number||"",soNumber:e.sales_order_number,vendorName:e.vendor?.vendor_name})))}catch(t){we([])}finally{Ce(!1)}})(e.target.value)},onBlur:()=>{$e.current?$e.current=!1:setTimeout(()=>{ye(!1),qe(!1)},200)},placeholder:"F... ÎòêÎäî HS...",className:"w-[150px] h-5 px-1.5 bg-white border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-hansl-400",style:{fontSize:"10px",fontWeight:500},autoFocus:!0,onClick:e=>e.stopPropagation()}),Se&&a.jsx(W,{className:"absolute right-1 w-3 h-3 animate-spin text-gray-400"}),ke&&ve.length>0&&a.jsx("div",{className:"absolute top-full left-0 mt-1 w-[280px] bg-white border border-gray-200 rounded-lg shadow-lg z-50 max-h-[180px] overflow-y-auto",children:ve.map(e=>a.jsxs("div",{className:"w-full px-2 py-1.5 hover:bg-gray-50 border-b border-gray-100 last:border-b-0",children:[a.jsx("button",{onMouseDown:e=>e.preventDefault(),onClick:t=>{t.stopPropagation(),$e.current=!1;const r=Ne.trim().toUpperCase();let a;a=r.startsWith("HS")&&e.soNumber?e.soNumber:r.startsWith("F")&&e.poNumber?e.poNumber:e.poNumber||e.soNumber||"",je(""),ye(!1),qe(!1),Oe(!0),ot(a,e.vendorName,e.soNumber),f.success(`${a} Î∞úÏ£ºÍ∞Ä ÏÑ†ÌÉùÎêòÏóàÏäµÎãàÎã§`)},className:"w-full text-left",children:a.jsxs("div",{className:"flex items-center justify-between gap-2",children:[a.jsxs("div",{className:"text-[10px] font-medium text-gray-900",children:[e.poNumber,e.soNumber&&a.jsxs("span",{className:"text-gray-400 ml-1",children:["(",e.soNumber,")"]})]}),a.jsx("button",{type:"button",onMouseDown:e=>{$e.current=!0,e.preventDefault()},onClick:t=>{t.stopPropagation(),Z(e.id),X(!0)},className:"text-[9px] font-medium text-blue-600 hover:text-blue-800",children:"ÏÉÅÏÑ∏"})]})}),e.vendorName&&a.jsx("div",{className:"text-[9px] text-gray-500",children:e.vendorName})]},e.id))})]}):a.jsx("button",{onClick:e=>{e.stopPropagation(),ye(!0)},className:"inline-flex items-center gap-0.5 px-1 h-5 text-[9px] font-medium text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded",title:"Î∞úÏ£º/ÏàòÏ£ºÎ≤àÌò∏ ÏßÅÏ†ë Í≤ÄÏÉâ",children:a.jsx(P,{className:"w-3 h-3"})})}),$&&(()=>{const e=Qe.find(e=>e.poNumber===$||e.salesOrderNumber===$),t=e?.purchaseId||e?.items[0]?.purchase_id;return t?a.jsx("button",{onClick:e=>{e.stopPropagation(),Z(t),X(!0)},className:"inline-flex items-center gap-0.5 px-1 h-5 text-[9px] font-medium text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded",title:"Î∞úÏ£º ÏÉÅÏÑ∏ Î≥¥Í∏∞",children:a.jsx(L,{className:"w-3 h-3"})}):null})()]})]})}),a.jsx("th",{className:"border-r-2 border-gray-300 p-2 text-center bg-blue-50/30 w-[10%]"}),a.jsx("th",{colSpan:Ve?4:5,className:"p-2 text-left w-[45%]",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"modal-section-title text-gray-700",children:"OCR Ï∂îÏ∂ú ÌíàÎ™©"}),Ve&&Xe&&a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx("input",{type:"text",value:(()=>{const e=g?.items[0];return e?nt(e,"po_number"):Xe})(),onChange:e=>dt(e.target.value),className:"px-1.5 h-5 bg-white border border-gray-300 text-gray-700 text-[10px] font-medium business-radius focus:outline-none focus:ring-1 focus:ring-gray-400",style:{fontSize:"11px",fontWeight:500},title:"OCR Ï∂îÏ∂ú Î∞úÏ£ºÎ≤àÌò∏ (ÏàòÏ†ï Í∞ÄÎä•)"}),(()=>{const e=g?.items[0],t=e?nt(e,"po_number"):Xe,r=tt(t);return r?a.jsx("span",{className:"text-gray-400 text-[10px] font-normal",style:{fontSize:"11px"},children:r}):null})()]}),Ve&&!Xe&&a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx("input",{type:"text",placeholder:"Î∞úÏ£º/ÏàòÏ£ºÎ≤àÌò∏ ÏûÖÎ†•",onChange:e=>dt(e.target.value),className:"px-1.5 h-5 bg-white border border-gray-300 text-gray-700 text-[10px] font-medium business-radius focus:outline-none focus:ring-1 focus:ring-gray-400",style:{fontSize:"11px",fontWeight:500},title:"Î∞úÏ£ºÎ≤àÌò∏ ÏßÅÏ†ë ÏûÖÎ†•"}),(()=>{const e=g?.items[0],t=e?nt(e,"po_number"):"",r=tt(t);return r?a.jsx("span",{className:"text-gray-400 text-[10px] font-normal",style:{fontSize:"11px"},children:r}):null})()]})]})})]}),a.jsxs("tr",{className:"modal-label",children:[!Ve&&a.jsx("th",{className:"p-1 text-left whitespace-nowrap modal-label",children:"Î∞úÏ£º/ÏàòÏ£ºÎ≤àÌò∏"}),a.jsx("th",{className:"p-1 text-left modal-label",children:"ÌíàÎ™©Î™Ö"}),a.jsx("th",{className:"p-1 text-right modal-label",children:"ÏàòÎüâ"}),a.jsx("th",{className:"p-1 text-right modal-label",children:"Îã®Í∞Ä"}),a.jsx("th",{className:"border-r-2 border-gray-300 p-1 text-right modal-label",children:"Ìï©Í≥Ñ"}),a.jsx("th",{className:"border-r-2 border-gray-300 p-1 text-center bg-blue-50/30",children:a.jsx("span",{className:"text-gray-400 text-sm",children:"‚áÑ"})}),a.jsx("th",{className:"p-1 text-left whitespace-nowrap modal-label",children:"ÌíàÎ™©Î™Ö"}),a.jsx("th",{className:"p-1 text-right whitespace-nowrap w-16 modal-label",children:"ÏàòÎüâ"}),a.jsx("th",{className:"p-1 text-right whitespace-nowrap w-20 modal-label",children:"Îã®Í∞Ä"}),a.jsx("th",{className:"p-1 text-right whitespace-nowrap w-24 modal-label",children:"Ìï©Í≥Ñ"}),!Ve&&a.jsx("th",{className:"p-1 text-left whitespace-nowrap modal-label",children:"Î∞úÏ£º/ÏàòÏ£ºÎ≤àÌò∏"})]})]}),a.jsxs("tbody",{className:"bg-white",children:[g.items.map((e,t)=>{const r=D.get(e.id);(e=>{let t=D.get(e.id)||null;if(!t){const r=Ve?$:E.get(e.id)||(e.extracted_po_number?q(e.extracted_po_number):"");if(r){const a=rt(r);a.length;let s=0;a.forEach(r=>{const a=K(e.extracted_item_name||"",r.item_name,r.specification);a>s&&(s=a,t=r)})}}if(!t)return"unmatched";const r=K(e.extracted_item_name||"",t.item_name||"",t.specification)})(e);const s=e.extracted_po_number?q(e.extracted_po_number):void 0,n=at(e.id),i=n.map(e=>q(e)),o=new Set(i),c=E.get(e.id),d=c?q(c):"",l=s&&o.has(s)?s:"",m=d&&o.has(d)?d:l;t<5&&fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"StatementConfirmModal.tsx:render:grouping",message:"grouping_inputs",data:{rowIndex:t,ocrItemId:e.id,normalizedExtractedPO:s,selectedPO:c,normalizedSelectedPO:d,itemPO:m,candidateCount:n.length},timestamp:Date.now(),sessionId:"debug-session",runId:"run3",hypothesisId:"H1"})}).catch(()=>{});const u=Array.from(new Set(n)),p=g.items[t+1],x=p?(e=>{const t=e.extracted_po_number?q(e.extracted_po_number):void 0,r=at(e.id),a=new Set(r.map(e=>q(e))),s=E.get(e.id),n=s?q(s):"",i=t&&a.has(t)?t:"";return n&&a.has(n)?n:i})(p):"",h=t<g.items.length-1&&m!==x,_=h?"hover:bg-gray-50 border-b-2 border-gray-500":"hover:bg-gray-50";t<=1&&fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"StatementConfirmModal.tsx:render:headerDivider",message:"row_class_state",data:{rowIndex:t,isGroupEnd:h,rowClassName:_,itemPO:m,nextItemPO:x},timestamp:Date.now(),sessionId:"debug-session",runId:"run4",hypothesisId:"H1"})}).catch(()=>{});const b=Ie[e.id]||"",f=We[e.id]||[],N=Pe[e.id]||!1,j=Ve?$:m||"",v=rt(j),w=0===v.length&&j?(e.match_candidates||[]).filter(e=>e.purchase_order_number===j||e.sales_order_number===j).map(e=>({purchase_id:e.purchase_id,item_id:e.item_id,purchase_order_number:e.purchase_order_number||"",sales_order_number:e.sales_order_number,item_name:e.item_name||"ÌíàÎ™©Î™Ö ÏóÜÏùå",specification:e.specification,quantity:e.quantity,unit_price:e.unit_price,amount:e.amount,vendor_name:e.vendor_name})):[],S=v.length>0?v:w,C=S.map(t=>({candidate:t,score:K(e.extracted_item_name||"",t.item_name,t.specification)})).sort((e,t)=>t.score-e.score);if(0===t){const t=`${e.id}|${Ve?"same":"multi"}|${j}|${v.length}`;ge.current!==t&&(ge.current=t,v[0])}const k=$?q($):"",M=$?et($):void 0,O=M?q(M):"",I=g.items.length,z=g.items.map(e=>nt(e,"po_number")).filter(Boolean).map(e=>q(e)),P=!!k&&z.some(e=>e===k||O&&e===O),R=0===t;return a.jsxs("tr",{className:_,children:[!Ve&&a.jsx("td",{className:"p-1 whitespace-nowrap",children:a.jsxs("div",{className:"relative",children:[a.jsxs("button",{onClick:()=>bt(`po-${e.id}`),className:"inline-flex items-center gap-1 px-1.5 h-5 text-[10px] font-medium bg-white border border-gray-300 business-radius hover:bg-gray-50 text-gray-700 whitespace-nowrap",style:{fontSize:"11px"},children:[a.jsx("span",{children:m||"ÏÑ†ÌÉù"}),a.jsx(y,{className:"w-3 h-3 flex-shrink-0"})]}),F.has(`po-${e.id}`)&&a.jsxs("div",{className:"absolute left-0 top-full mt-1 z-20 bg-white border border-gray-200 rounded-md shadow-lg w-[280px] max-h-[200px] overflow-auto",children:[a.jsx("div",{className:"p-2 border-b border-gray-100",children:a.jsxs("div",{className:"relative",children:[a.jsx("input",{type:"text",value:b,onChange:t=>pt(e.id,t.target.value),placeholder:"Î∞úÏ£º/ÏàòÏ£ºÎ≤àÌò∏ Í≤ÄÏÉâ...",className:"w-full h-6 px-2 pr-6 text-[10px] bg-white border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-hansl-400"}),N&&a.jsx(W,{className:"absolute right-2 top-1/2 -translate-y-1/2 w-3 h-3 animate-spin text-gray-400"})]})}),b&&f.length>0&&a.jsx("div",{className:"border-b border-gray-100",children:f.map(t=>{const r=b.trim().toUpperCase();let s;return s=r.startsWith("HS")&&t.soNumber?t.soNumber:r.startsWith("F")&&t.poNumber?t.poNumber:t.poNumber||t.soNumber||"",a.jsxs("div",{className:"px-2 py-1.5 hover:bg-gray-50 cursor-pointer text-[11px]",onClick:()=>mt(e.id,s),children:[a.jsxs("div",{className:"flex items-center justify-between gap-2",children:[a.jsxs("div",{className:"font-medium text-gray-900",children:[t.poNumber,t.soNumber&&a.jsxs("span",{className:"text-gray-400 ml-1",children:["(",t.soNumber,")"]})]}),a.jsx("button",{type:"button",onMouseDown:e=>e.preventDefault(),onClick:e=>{e.stopPropagation(),Z(t.id),X(!0)},className:"text-[9px] font-medium text-blue-600 hover:text-blue-800",children:"ÏÉÅÏÑ∏"})]}),t.vendorName&&a.jsx("div",{className:"text-[9px] text-gray-500",children:t.vendorName})]},t.id)})}),u.length>0&&a.jsx("div",{children:u.map((t,r)=>{const s=et(t),n=ut(t),i=t===m;return a.jsx("div",{onClick:()=>mt(e.id,t),className:"px-2 py-1.5 hover:bg-gray-100 cursor-pointer text-[11px] font-medium "+(i?"bg-gray-100 text-gray-900 font-semibold":"text-gray-700"),style:{fontSize:"11px"},children:a.jsxs("div",{className:"flex items-center justify-between gap-2",children:[a.jsxs("div",{children:[t,s&&a.jsxs("span",{className:"text-gray-400 ml-1",children:["(",s,")"]}),i&&a.jsx("span",{className:"text-orange-500 ml-1",children:"Ï∂îÏ≤ú"})]}),n&&a.jsx("button",{type:"button",onMouseDown:e=>e.preventDefault(),onClick:e=>{e.stopPropagation(),Z(n),X(!0)},className:"text-[9px] font-medium text-blue-600 hover:text-blue-800",children:"ÏÉÅÏÑ∏"})]})},`${t}-${r}`)})})]})]})}),a.jsx("td",{className:"p-1",children:S.length>0?a.jsxs("div",{className:"relative",children:[a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsxs("button",{onClick:()=>{bt(`item-${e.id}`)},className:"inline-flex items-center gap-1 px-1.5 h-5 text-[10px] font-normal bg-white border border-gray-300 business-radius hover:bg-gray-50 text-gray-700 whitespace-nowrap",style:{fontSize:"11px"},children:[a.jsx("span",{children:_t(r)||"ÏÑ†ÌÉù"}),a.jsx(y,{className:"w-3 h-3 flex-shrink-0"})]}),r&&a.jsx("button",{onClick:()=>xt(e.id,null),className:"text-gray-400 hover:text-red-500 flex-shrink-0",title:"Îß§Ïπ≠ Ìï¥Ï†ú",children:a.jsx(B,{className:"w-3 h-3"})})]}),F.has(`item-${e.id}`)&&a.jsx("div",{className:"absolute left-0 top-full mt-1 z-20 bg-white border border-gray-200 rounded-md shadow-lg w-[280px] max-h-[200px] overflow-auto",children:C.map(({candidate:t,score:r},s)=>a.jsxs("div",{onClick:()=>{xt(e.id,t)},className:"px-2 py-1.5 hover:bg-gray-100 cursor-pointer",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("p",{className:"text-[11px] font-normal text-gray-900",style:{fontSize:"11px"},children:_t(t)}),a.jsxs("span",{className:"text-[10px] px-1.5 py-0.5 rounded "+(r>=80?"bg-green-100 text-green-700":r>=50?"bg-yellow-100 text-yellow-700":"bg-gray-100 text-gray-600"),children:[Math.round(r),"%"]})]}),a.jsxs("p",{className:"text-[10px] text-gray-500",children:["ÏöîÏ≤≠/Ïã§Ï†ú: ",t.quantity??"-"," / ",t.received_quantity??"-"]})]},s))})]}):a.jsx("span",{className:"text-[11px] text-gray-400",style:{fontSize:"11px"},children:"ÌõÑÎ≥¥ ÏóÜÏùå"})}),a.jsx("td",{className:"p-1 text-right",children:a.jsxs("span",{className:"text-[11px] text-gray-700",style:{fontSize:"11px"},children:[r?.quantity??"-"," / ",r?.received_quantity??"-"]})}),a.jsx("td",{className:"p-1 text-right",children:a.jsx("span",{className:"text-[11px] text-gray-700",style:{fontSize:"11px"},children:r?ht(r.unit_price):"-"})}),a.jsx("td",{className:"border-r-2 border-gray-300 p-1 text-right",children:a.jsx("span",{className:"text-[11px] font-bold text-gray-900",style:{fontSize:"11px",fontWeight:700},children:r?ht(r.amount):"-"})}),R&&a.jsx("td",{className:"border-r-2 border-gray-300 px-2 py-1 text-center bg-blue-50/30 cursor-pointer hover:bg-blue-100/50 transition-colors",rowSpan:I,style:{verticalAlign:"middle"},onClick:()=>se(!0),title:"ÌÅ¥Î¶≠ÌïòÏó¨ ÏÉÅÏÑ∏ ÎÇ¥Ïó≠ Î≥¥Í∏∞",children:a.jsxs("div",{className:"flex flex-col items-center justify-center",children:[a.jsx("span",{className:"text-[11px] font-bold "+(P?"text-green-600":"text-gray-500"),children:P?"Î∞úÏ£º/ÏàòÏ£º Î≤àÌò∏ ÏùºÏπò":"Î∞úÏ£º/ÏàòÏ£º Î≤àÌò∏ Î∂àÏùºÏπò"}),a.jsx("span",{className:"text-[8px] text-blue-500 underline mt-0.5",children:"ÏÉÅÏÑ∏Î≥¥Í∏∞"})]})}),a.jsx("td",{className:"p-1 whitespace-nowrap",children:a.jsx("input",{type:"text",value:nt(e,"item_name"),onChange:t=>st(e.id,"item_name",t.target.value),className:"min-w-[180px] w-auto px-1 h-5 !text-[10px] !font-medium text-gray-900 border business-radius focus:outline-none focus:ring-1 focus:ring-blue-400 "+(it(e,"item_name")?"border-orange-400 bg-orange-50":"border-gray-200 bg-white"),style:{fontSize:"11px",fontWeight:500,width:`${Math.max(180,8*nt(e,"item_name").length)}px`},title:it(e,"item_name")?`ÏõêÎ≥∏: ${e.extracted_item_name}`:void 0})}),a.jsx("td",{className:"p-1 text-right w-16",children:a.jsx("input",{type:"number",value:nt(e,"quantity"),onChange:t=>st(e.id,"quantity",t.target.value?Number(t.target.value):0),className:"w-14 px-1 h-5 !text-[10px] !font-medium text-gray-900 text-right border business-radius focus:outline-none focus:ring-1 focus:ring-blue-400 "+(it(e,"quantity")?"border-orange-400 bg-orange-50":"border-gray-200 bg-white"),style:{fontSize:"11px",fontWeight:500},title:it(e,"quantity")?`ÏõêÎ≥∏: ${e.extracted_quantity}`:void 0})}),a.jsx("td",{className:"p-1 text-right w-20",children:a.jsx("input",{type:"number",value:nt(e,"unit_price"),onChange:t=>st(e.id,"unit_price",t.target.value?Number(t.target.value):0),className:"w-16 px-1 h-5 !text-[10px] !font-medium text-gray-900 text-right border business-radius focus:outline-none focus:ring-1 focus:ring-blue-400 "+(it(e,"unit_price")?"border-orange-400 bg-orange-50":"border-gray-200 bg-white"),style:{fontSize:"11px",fontWeight:500},title:it(e,"unit_price")?`ÏõêÎ≥∏: ${e.extracted_unit_price}`:void 0})}),a.jsx("td",{className:"p-1 text-right w-24",children:a.jsx("input",{type:"number",value:nt(e,"amount"),onChange:t=>st(e.id,"amount",t.target.value?Number(t.target.value):0),className:"w-20 px-1 h-5 !text-[10px] !font-bold text-gray-900 text-right border business-radius focus:outline-none focus:ring-1 focus:ring-blue-400 "+(it(e,"amount")?"border-orange-400 bg-orange-50":"border-gray-200 bg-white"),style:{fontSize:"11px",fontWeight:700},title:it(e,"amount")?`ÏõêÎ≥∏: ${e.extracted_amount}`:void 0})}),!Ve&&a.jsx("td",{className:"p-1 whitespace-nowrap",children:a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx("input",{type:"text",value:nt(e,"po_number"),onChange:t=>{const r=t.target.value;ct(r),st(e.id,"po_number",r)},className:"px-1.5 h-5 text-[10px] font-medium bg-white border business-radius focus:outline-none focus:ring-1 focus:ring-gray-400 text-gray-700 "+(it(e,"po_number")?"border-orange-400 bg-orange-50":"border-gray-300"),style:{fontSize:"11px",fontWeight:500},title:it(e,"po_number")?`ÏõêÎ≥∏: ${e.extracted_po_number}`:void 0}),(()=>{const t=nt(e,"po_number"),r=tt(t);return r?a.jsx("span",{className:"text-gray-400 text-[10px] font-normal",style:{fontSize:"11px"},children:r}):null})()]})})]},e.id)}),a.jsxs("tr",{className:"bg-gray-50 font-medium border-t border-gray-100",children:[a.jsx("td",{colSpan:Ve?3:4,className:"p-1 text-right text-gray-600",children:"ÏãúÏä§ÌÖú Ìï©Í≥Ñ"}),a.jsx("td",{className:"border-r-2 border-gray-300 p-1 text-right text-gray-900",children:ht(Array.from(D.values()).filter(Boolean).reduce((e,t)=>e+(t?.amount||0),0))}),a.jsx("td",{className:"border-r-2 border-gray-300 p-1 bg-blue-50/50"}),a.jsxs("td",{colSpan:Ve?3:4,className:"p-1 text-right text-gray-600",children:["OCR Ìï©Í≥Ñ",Q.size>0&&a.jsx("span",{className:"ml-1 text-[9px] text-orange-600",children:"(ÏàòÏ†ïÎê®)"})]}),a.jsx("td",{className:"p-1 text-right text-gray-900",children:ht(g.items.reduce((e,t)=>{const r=Q.get(t.id);return e+(void 0!==r?.amount?r.amount:t.extracted_amount||0)},0))}),!Ve&&a.jsx("td",{className:"p-1"})]})]})]})})]}):a.jsx("div",{className:"text-center py-12",children:a.jsx("p",{className:"modal-subtitle",children:"Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§."})}),a.jsxs(_,{className:"border-t border-gray-100 pt-3 px-4 gap-2",children:[a.jsxs(n,{variant:"outline",onClick:async()=>{if(confirm("Ïù¥ Í±∞ÎûòÎ™ÖÏÑ∏ÏÑúÎ•º Í±∞Î∂ÄÌïòÏãúÍ≤†ÏäµÎãàÍπå?"))try{b(!0);const e=await k.rejectStatement(s.id);e.success?(f.success("Í±∞ÎûòÎ™ÖÏÑ∏ÏÑúÍ∞Ä Í±∞Î∂ÄÎêòÏóàÏäµÎãàÎã§."),o()):f.error(e.error||"Í±∞Î∂Ä Ï≤òÎ¶¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.")}catch(e){f.error("Í±∞Î∂Ä Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.")}finally{b(!1)}},disabled:m,className:"button-base h-8 text-[11px] text-red-500 border-red-200 hover:bg-red-50",children:[a.jsx(B,{className:"w-3.5 h-3.5 mr-1"}),"Í±∞Î∂Ä"]}),a.jsx(n,{variant:"outline",onClick:o,disabled:m,className:"button-base h-8 text-[11px]",children:"Îã´Í∏∞"}),a.jsx(n,{onClick:async()=>{if(g)try{b(!0),await(async()=>{if(!g)return;const e=[];if(g.items.forEach(t=>{const r=Q.get(t.id);if(r&&(void 0!==r.item_name&&r.item_name!==t.extracted_item_name&&e.push({statement_id:g.id,statement_item_id:t.id,original_text:t.extracted_item_name||"",corrected_text:r.item_name,field_type:"item_name"}),void 0!==r.quantity&&r.quantity!==t.extracted_quantity&&e.push({statement_id:g.id,statement_item_id:t.id,original_text:String(t.extracted_quantity??""),corrected_text:String(r.quantity),field_type:"quantity"}),void 0!==r.unit_price&&r.unit_price!==t.extracted_unit_price&&e.push({statement_id:g.id,statement_item_id:t.id,original_text:String(t.extracted_unit_price??""),corrected_text:String(r.unit_price),field_type:"unit_price"}),void 0!==r.amount&&r.amount!==t.extracted_amount&&e.push({statement_id:g.id,statement_item_id:t.id,original_text:String(t.extracted_amount??""),corrected_text:String(r.amount),field_type:"amount"}),void 0!==r.po_number)){const a=t.extracted_po_number?q(t.extracted_po_number):"";r.po_number!==a&&e.push({statement_id:g.id,statement_item_id:t.id,original_text:a,corrected_text:r.po_number,field_type:"po_number"})}}),e.length>0){for(const t of e)await k.saveCorrection(t);f.success(`${e.length}Í±¥Ïùò OCR ÏàòÏ†ïÏÇ¨Ìï≠Ïù¥ ÌïôÏäµ Îç∞Ïù¥ÌÑ∞Î°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.`)}})();const e=Ye(g.statement_date),t=Ye(Le);if(t!==e){const{error:e}=await Ke.from("transaction_statements").update({statement_date:t||null}).eq("id",s.id);if(e)throw new Error(e.message)}const r=g.items.map(e=>{const t=D.get(e.id),r=Q.get(e.id),a=void 0!==r?.quantity?r.quantity:e.extracted_quantity,s=void 0!==r?.unit_price?r.unit_price:e.extracted_unit_price,n=void 0!==r?.amount?r.amount:e.extracted_amount;return{itemId:e.id,matched_purchase_id:t?.purchase_id,matched_item_id:t?.item_id,confirmed_quantity:a,confirmed_unit_price:s,confirmed_amount:n}}),a=await k.confirmStatement({statementId:s.id,items:r},w);a.success?(f.success("Í±∞ÎûòÎ™ÖÏÑ∏ÏÑúÍ∞Ä ÌôïÏ†ïÎêòÏóàÏäµÎãàÎã§."),c()):f.error(a.error||"ÌôïÏ†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.")}catch(e){f.error("ÌôïÏ†ï Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.")}finally{b(!1)}},disabled:m||!g,className:"button-base h-8 text-[11px] bg-hansl-600 hover:bg-hansl-700 text-white",children:m?a.jsxs(a.Fragment,{children:[a.jsx(W,{className:"w-3.5 h-3.5 mr-1 animate-spin"}),"Ï≤òÎ¶¨ Ï§ë..."]}):a.jsxs(a.Fragment,{children:[a.jsx(M,{className:"w-3.5 h-3.5 mr-1"}),"ÌôïÏ†ï"]})})]})]})}),te&&a.jsx(u,{open:te.isOpen,onOpenChange:()=>re(null),children:a.jsxs(p,{className:"max-w-md",children:[a.jsx(x,{children:a.jsx(h,{className:"text-[14px] font-semibold text-gray-800",children:"Îß§Ïπ≠ ÏÉÅÏÑ∏ Ï†ïÎ≥¥"})}),a.jsxs("div",{className:"space-y-4 py-2",children:[a.jsxs("div",{className:"flex items-center justify-center",children:[(e=>{const t=void 0;switch(e){case"high":return a.jsxs("span",{className:"badge-stats bg-green-500 text-white ",onClick:t,title:"ÌÅ¥Î¶≠ÌïòÏó¨ ÏÉÅÏÑ∏ Î≥¥Í∏∞",children:[a.jsx(R,{className:"w-3 h-3"}),"ÎÜíÏùå"]});case"med":return a.jsx("span",{className:"badge-stats bg-yellow-500 text-white ",onClick:t,title:"ÌÅ¥Î¶≠ÌïòÏó¨ ÏÉÅÏÑ∏ Î≥¥Í∏∞",children:"Î≥¥ÌÜµ"});case"low":return a.jsx("span",{className:"badge-stats bg-orange-500 text-white ",onClick:t,title:"ÌÅ¥Î¶≠ÌïòÏó¨ ÏÉÅÏÑ∏ Î≥¥Í∏∞",children:"ÎÇÆÏùå"});case"unmatched":return a.jsx("span",{className:"badge-stats bg-gray-500 text-white ",onClick:t,title:"ÌÅ¥Î¶≠ÌïòÏó¨ ÏÉÅÏÑ∏ Î≥¥Í∏∞",children:"ÎØ∏Îß§Ïπ≠"})}})(te.status),a.jsxs("span",{className:"ml-2 text-[12px] text-gray-600",children:["Ïú†ÏÇ¨ÎèÑ: ",te.similarity.toFixed(1),"%"]})]}),a.jsxs("div",{className:"bg-gray-50 rounded-lg p-3 space-y-2",children:[a.jsxs("div",{className:"flex items-start gap-2",children:[a.jsx("span",{className:"text-[11px] font-medium text-gray-500 w-20 shrink-0",children:"OCR ÌíàÎ™©:"}),a.jsx("span",{className:"text-[11px] text-gray-800 break-all",children:te.ocrItemName})]}),a.jsxs("div",{className:"flex items-start gap-2",children:[a.jsx("span",{className:"text-[11px] font-medium text-gray-500 w-20 shrink-0",children:"ÏãúÏä§ÌÖú ÌíàÎ™©:"}),a.jsx("span",{className:"text-[11px] text-gray-800 break-all",children:te.systemItemName})]}),te.systemSpec&&"-"!==te.systemSpec&&a.jsxs("div",{className:"flex items-start gap-2",children:[a.jsx("span",{className:"text-[11px] font-medium text-gray-500 w-20 shrink-0",children:"ÏãúÏä§ÌÖú Í∑úÍ≤©:"}),a.jsx("span",{className:"text-[11px] text-gray-800 break-all",children:te.systemSpec})]})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx("span",{className:"text-[11px] font-medium text-gray-600",children:"Îß§Ïπ≠ ÌåêÏ†ï Ïù¥Ïú†:"}),a.jsx("ul",{className:"space-y-1",children:te.reasons.map((e,t)=>a.jsx("li",{className:"text-[11px] text-gray-700 pl-2",children:e},t))})]})]}),a.jsx(_,{children:a.jsx(n,{variant:"outline",size:"sm",onClick:()=>re(null),className:"text-[11px]",children:"Îã´Í∏∞"})})]})}),a.jsx(u,{open:ae,onOpenChange:se,children:a.jsxs(p,{className:"max-w-lg",children:[a.jsx(x,{children:a.jsx(h,{className:"text-[14px] font-semibold text-gray-800",children:"Îß§Ïπ≠ ÏÉÅÏÑ∏ ÎÇ¥Ïó≠"})}),a.jsx("div",{className:"space-y-4 py-2",children:(()=>{const e=Qe.find(e=>e.poNumber===$||e.salesOrderNumber===$),t=Math.min(100,e?.displayScore??e?.setMatchScore??0),r=e?.matchedItemCount??0,s=g?.items.length??0,n=$?q($):"",i=$?et($):void 0,o=i?q(i):"",c=(g?.items??[]).map(e=>nt(e,"po_number")).filter(Boolean).map(e=>q(e)),d=!!n&&c.some(e=>e===n||o&&e===o),l=(g?.items??[]).filter(e=>{const t=D.get(e.id);if(!t)return!1;return K(nt(e,"item_name")||"",t.item_name,t.specification)>=40}).length,m=(g?.items??[]).filter(e=>{const t=D.get(e.id);if(!t)return!1;const r=nt(e,"quantity");return V("number"==typeof r?r:""!==r?Number(r):void 0,t.quantity)}).length,u=s>0&&l===s,p=s>0&&m===s;return a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"flex items-center justify-center gap-3 p-4 bg-gray-50 rounded-lg",children:[a.jsxs("span",{className:"text-3xl font-bold "+(t>=80?"text-green-600":t>=50?"text-yellow-600":"text-gray-500"),children:[t,"%"]}),a.jsxs("div",{className:"text-left",children:[a.jsxs("p",{className:"text-[12px] font-medium text-gray-700",children:["Î∞úÏ£ºÎ≤àÌò∏: ",$||"ÎØ∏ÏÑ†ÌÉù"]}),a.jsxs("p",{className:"text-[11px] text-gray-500",children:[r,"/",s,"Í∞ú ÌíàÎ™© Îß§Ïπ≠Îê®"]})]})]}),a.jsxs("div",{className:"grid grid-cols-1 gap-2 rounded-lg border border-gray-200 p-3",children:[a.jsxs("div",{className:"flex items-center justify-between text-[11px]",children:[a.jsx("span",{className:"text-gray-600",children:"Î∞úÏ£º/ÏàòÏ£ºÎ≤àÌò∏ Îß§Ïπ≠"}),a.jsx("span",{className:"font-medium "+(d?"text-green-600":"text-red-600"),children:d?"‚úÖ ÏùºÏπò":"‚ùå Î∂àÏùºÏπò"})]}),a.jsxs("div",{className:"flex items-center justify-between text-[11px]",children:[a.jsx("span",{className:"text-gray-600",children:"ÌíàÎ™©Î™Ö Îß§Ïπ≠"}),a.jsx("span",{className:"font-medium "+(u?"text-green-600":"text-red-600"),children:u?`‚úÖ Î™®Îëê ÏùºÏπò (${l}/${s})`:`‚ùå Î∂àÏùºÏπò (${l}/${s})`})]}),a.jsxs("div",{className:"flex items-center justify-between text-[11px]",children:[a.jsx("span",{className:"text-gray-600",children:"ÏàòÎüâ Îß§Ïπ≠"}),a.jsx("span",{className:"font-medium "+(p?"text-green-600":"text-red-600"),children:p?`‚úÖ Î™®Îëê ÏùºÏπò (${m}/${s})`:`‚ùå Î∂àÏùºÏπò (${m}/${s})`})]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("p",{className:"text-[11px] font-semibold text-gray-600",children:"ÌíàÎ™©Î≥Ñ Îß§Ïπ≠ ÏÉÅÏÑ∏:"}),a.jsx("div",{className:"max-h-[250px] overflow-y-auto space-y-2",children:g?.items.map(e=>{const t=D.get(e.id),r=t?K(nt(e,"item_name")||"",t.item_name,t.specification):0,s=r>=40,n=nt(e,"quantity"),i="number"==typeof n?n:""!==n?Number(n):void 0,o=t?.quantity,c=V(i,o),d=(m=o,null==(l=i)||null==m?"mismatch":l===m?"exact":l<=m?"partial":"mismatch");var l,m;return a.jsxs("div",{className:"p-2 rounded-lg border "+(s&&c?"bg-green-50 border-green-200":s?"bg-yellow-50 border-yellow-200":"bg-gray-50 border-gray-200"),children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsx("p",{className:"text-[11px] font-medium text-gray-800 truncate",children:e.extracted_item_name||"-"}),a.jsxs("p",{className:"text-[10px] text-gray-500",children:["‚Üí ",t?.item_name||"ÎØ∏Îß§Ïπ≠"]})]}),a.jsx("span",{className:"text-[10px] px-2 py-0.5 rounded font-medium ml-2 "+(r>=85?"bg-green-100 text-green-700":r>=60?"bg-yellow-100 text-yellow-700":r>=40?"bg-orange-100 text-orange-700":"bg-red-100 text-red-600"),children:s?`${Math.round(r)}%`:"ÎØ∏Îß§Ïπ≠"})]}),s&&a.jsxs("div",{className:"flex items-center gap-2 mt-1.5 pt-1.5 border-t border-gray-100",children:[a.jsx("span",{className:"text-[10px] text-gray-500",children:"ÏàòÎüâ:"}),a.jsxs("span",{className:"text-[10px] font-medium text-gray-700",children:["OCR ",i??"-","Í∞ú"]}),a.jsx("span",{className:"text-[10px] text-gray-400",children:"vs"}),a.jsxs("span",{className:"text-[10px] font-medium text-gray-700",children:["ÏãúÏä§ÌÖú ",o??"-","Í∞ú"]}),a.jsx("span",{className:"text-[9px] px-1.5 py-0.5 rounded "+(c?"bg-green-100 text-green-700":"partial"===d?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"),children:c?"‚úÖ ÏùºÏπò":"partial"===d?"‚ö†Ô∏è Î∂ÄÎ∂ÑÏûÖÍ≥†":"‚ùå Î∂àÏùºÏπò"})]})]},e.id)})})]})]})})()}),a.jsx(_,{children:a.jsx(n,{variant:"outline",size:"sm",onClick:()=>se(!1),className:"text-[11px]",children:"Îã´Í∏∞"})})]})}),a.jsx(G,{isOpen:j,imageUrl:s.image_url,onClose:()=>v(!1)}),F.has("global-po")&&i.createPortal(a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"fixed inset-0 z-[100]",style:{pointerEvents:"auto"},onClick:()=>bt("global-po")}),a.jsxs("div",{className:"fixed z-[101] bg-white border border-gray-200 rounded-lg shadow-xl min-w-[280px] max-h-[350px] overflow-y-auto",style:{top:U.top,left:U.left,pointerEvents:"auto"},onClick:e=>e.stopPropagation(),children:[a.jsx("div",{className:"sticky top-0 bg-gray-50 px-3 py-2 border-b border-gray-100 rounded-t-lg",children:a.jsx("span",{className:"text-[10px] font-semibold text-gray-600",children:"Î∞úÏ£ºÎ≤àÌò∏ ÏÑ†ÌÉù"})}),Qe.map((e,t)=>{const r=e.poNumber||e.salesOrderNumber||"",s=$===r,n=Ge?.bestMatch?.purchase_order_number===e.poNumber||Ge?.bestMatch?.sales_order_number===e.salesOrderNumber;return a.jsxs("div",{onClick:e=>{e.stopPropagation(),ot(r),bt("global-po")},className:`p-2.5 cursor-pointer border-b border-gray-50 last:border-0 transition-colors ${s?"bg-blue-50":"hover:bg-gray-50"} ${n?"ring-1 ring-inset ring-green-400":""}`,children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("p",{className:"text-[12px] font-medium text-gray-900",children:[e.poNumber||e.salesOrderNumber,e.poNumber&&e.salesOrderNumber&&a.jsxs("span",{className:"text-gray-500 font-normal",children:[" (",e.salesOrderNumber,")"]})]}),(void 0!==e.displayScore||void 0!==e.setMatchScore)&&a.jsxs("span",{className:"text-[10px] px-1.5 py-0.5 rounded font-medium "+((e.displayScore??e.setMatchScore??0)>=80?"bg-green-100 text-green-700":(e.displayScore??e.setMatchScore??0)>=50?"bg-yellow-100 text-yellow-700":"bg-gray-100 text-gray-600"),children:[Math.min(100,e.displayScore??e.setMatchScore??0),"%"]})]}),a.jsxs("p",{className:"text-[10px] text-gray-500 mt-0.5",children:[void 0!==e.matchedItemCount?`${e.matchedItemCount}/${g?.items.length||0}Í∞ú Îß§Ïπ≠`:`${e.itemCount}Í∞ú ÌíàÎ™©`," ¬∑ ",e.vendorName||"Í±∞ÎûòÏ≤ò ÎØ∏ÏÉÅ"]}),void 0!==e.quantityMatchedCount&&void 0!==e.matchedItemCount&&e.matchedItemCount>0&&a.jsx("p",{className:"text-[9px] mt-0.5 "+(0===e.quantityMismatchedCount?"text-green-600":"text-orange-600"),children:0===e.quantityMismatchedCount?"‚úÖ ÏàòÎüâ Î™®Îëê ÏùºÏπò":`‚ö†Ô∏è ÏàòÎüâ ${e.quantityMismatchedCount}Í∞ú Î∂àÏùºÏπò`}),n&&a.jsx("p",{className:"text-[9px] text-green-600 font-medium mt-0.5",children:"‚úÖ ÏÑ∏Ìä∏ Îß§Ïπ≠ Ï∂îÏ≤ú"})]},t)})]})]}),document.body),Y&&a.jsx(O,{purchaseId:Y,isOpen:J,onClose:()=>{X(!1),Z(null)},activeTab:"receipt"})]}):null}function Y(){const[e,i]=t.useState([]),[u,p]=t.useState(!0),[x,h]=t.useState(""),[_,y]=t.useState("all"),[q,$]=t.useState(""),[I,E]=t.useState(0),[z,R]=t.useState(!1),[L,H]=t.useState(!1),[J,K]=t.useState(null),[V,Y]=t.useState(!1),[Z,Q]=t.useState(!1),[ee,te]=t.useState(""),[re,ae]=t.useState(new Set),[se,ne]=t.useState(!1),[ie,oe]=t.useState(null),[ce,de]=t.useState({isOpen:!1,statement:null,position:{top:0,left:0}}),le=t.useCallback(async()=>{try{p(!0);const e=await k.getStatements({status:"all"!==_?_:void 0,dateFrom:q||void 0,search:x||void 0,limit:50});e.success?(i(e.data||[]),E(e.count||0)):f.error(e.error||"Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.")}catch(e){f.error("Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.")}finally{p(!1)}},[_,q,x]);t.useEffect(()=>{le()},[le]);const me=t.useRef(r());t.useEffect(()=>{const e=me.current,t=e.channel("transaction-statements-changes").on("postgres_changes",{event:"*",schema:"public",table:"transaction_statements"},e=>{if("UPDATE"===e.eventType){const t=e.new?.status,r=e.old?.status;t!==r&&le()}else"INSERT"!==e.eventType&&"DELETE"!==e.eventType||le()}).subscribe();return()=>{e.removeChannel(t)}},[le]);const ue=e=>{const t="inline-flex items-center gap-1 business-radius-badge px-2 py-0.5 text-[10px] font-medium leading-tight";switch(e){case"pending":return a.jsxs("span",{className:`${t} bg-gray-100 text-gray-600 border border-gray-200`,children:[a.jsx(T,{className:"w-3 h-3"}),"ÎåÄÍ∏∞Ï§ë"]});case"processing":return a.jsxs("span",{className:`${t} bg-blue-50 text-blue-600 border border-blue-200`,children:[a.jsx(W,{className:"w-3 h-3 animate-spin"}),"Ï≤òÎ¶¨Ï§ë"]});case"extracted":return a.jsxs("span",{className:`${t} bg-yellow-50 text-yellow-600 border border-yellow-200`,children:[a.jsx(c,{className:"w-3 h-3"}),"ÌôïÏù∏ÌïÑÏöî"]});case"confirmed":return a.jsxs("span",{className:`${t} bg-green-50 text-green-600 border border-green-200`,children:[a.jsx(M,{className:"w-3 h-3"}),"ÌôïÏ†ïÎê®"]});case"rejected":return a.jsxs("span",{className:`${t} bg-red-50 text-red-600 border border-red-200`,children:[a.jsx(B,{className:"w-3 h-3"}),"Í±∞Î∂ÄÎê®"]});default:return a.jsx("span",{className:`${t} bg-gray-100 text-gray-600`,children:e})}},pe=(e,t)=>{if(K(e),"extracted"===e.status)Y(!0);else if("confirmed"===e.status&&e.matched_purchases&&e.matched_purchases.length>0)if(1===e.matched_purchases.length)oe(e.matched_purchases[0].purchase_id),ne(!0);else{const r=t?.currentTarget?.getBoundingClientRect();de({isOpen:!0,statement:e,position:{top:r?r.bottom+window.scrollY:0,left:r?r.left+window.scrollX:0}})}else"confirmed"!==e.status&&"pending"!==e.status||(te(e.image_url),Q(!0))},xe=()=>{de({isOpen:!1,statement:null,position:{top:0,left:0}})},he=(e,t)=>{e.stopPropagation(),te(t),Q(!0)},_e=()=>{Y(!1),K(null),le()},be=e=>e?new Date(e).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"}):"-",ge=e=>null==e?"-":e.toLocaleString("ko-KR")+"Ïõê";return a.jsxs("div",{className:"w-full",children:[a.jsx("div",{className:"mb-4",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"page-title",children:"Í±∞ÎûòÎ™ÖÏÑ∏ÏÑú ÌôïÏù∏"}),a.jsx("p",{className:"page-subtitle",style:{marginTop:"-2px",marginBottom:"-4px"},children:"Transaction Statement Verification"})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs(n,{onClick:()=>H(!0),className:"!h-auto button-base bg-hansl-600 hover:bg-hansl-700 text-white",children:[a.jsx(b,{className:"w-3.5 h-3.5"}),a.jsx("span",{className:"hidden sm:inline",children:"ÏóÖÎ°úÎìú"})]}),a.jsx(n,{variant:"outline",onClick:le,disabled:u,className:"!h-auto button-base",children:a.jsx(F,{className:"w-3.5 h-3.5 "+(u?"animate-spin":"")})})]})]})}),a.jsxs("div",{className:"mb-3",children:[a.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[a.jsxs("div",{className:"relative min-w-[140px] max-w-[200px]",children:[a.jsx(P,{className:"absolute left-1.5 top-1/2 transform -translate-y-1/2 w-2.5 h-2.5 text-gray-400"}),a.jsx(g,{placeholder:"Í±∞ÎûòÏ≤òÎ™Ö, ÌååÏùºÎ™Ö Í≤ÄÏÉâ...",value:x,onChange:e=>h(e.target.value),className:"!h-auto !py-px !pr-1.5 !pl-5 !text-[11px] !min-h-[20px] business-radius-input border border-gray-300 bg-white text-gray-700"})]}),a.jsxs(N,{value:_,onValueChange:y,children:[a.jsx(j,{className:"!h-auto !py-[1px] !px-2 !text-[12px] !min-h-[22px] w-[100px] business-radius-input border border-gray-300 bg-white text-gray-700 [&>svg]:h-3 [&>svg]:w-3",children:a.jsx(v,{placeholder:"ÏÉÅÌÉú"})}),a.jsxs(w,{className:"min-w-[100px]",children:[a.jsx(S,{value:"all",className:"text-[12px] py-1.5",children:"Ï†ÑÏ≤¥ ÏÉÅÌÉú"}),a.jsx(S,{value:"pending",className:"text-[12px] py-1.5",children:"ÎåÄÍ∏∞Ï§ë"}),a.jsx(S,{value:"extracted",className:"text-[12px] py-1.5",children:"ÌôïÏù∏ÌïÑÏöî"}),a.jsx(S,{value:"confirmed",className:"text-[12px] py-1.5",children:"ÌôïÏ†ïÎê®"}),a.jsx(S,{value:"rejected",className:"text-[12px] py-1.5",children:"Í±∞Î∂ÄÎê®"})]})]}),a.jsxs(n,{variant:"outline",onClick:()=>R(!z),className:"!h-auto button-base border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 "+(z?"bg-hansl-50 border-hansl-300 text-hansl-700":""),children:[a.jsx(U,{className:"w-3.5 h-3.5 mr-1"}),a.jsx("span",{className:"button-text",children:"ÌïÑÌÑ∞"})]}),a.jsxs("span",{className:"badge-stats bg-gray-100 text-gray-600",children:["Ï¥ù ",I,"Í±¥"]})]}),z&&a.jsx("div",{className:"mt-2 p-3 bg-gray-50 business-radius-card border border-gray-200",children:a.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("label",{className:"text-[12px] font-medium text-gray-500",children:"ÏóÖÎ°úÎìú ÎÇ†Ïßú"}),a.jsx(g,{type:"date",value:q,onChange:e=>$(e.target.value),className:"!h-auto !py-[2px] !px-2.5 !text-[12px] !min-h-[24px] w-[140px] business-radius-input border border-gray-300 bg-white text-gray-700"})]}),a.jsxs(n,{variant:"outline",onClick:()=>{h(""),y("all"),$("")},className:"!h-auto button-base border border-gray-300 bg-white text-blue-600 hover:bg-blue-50 hover:border-blue-300",children:["‚Üª ",a.jsx("span",{className:"button-text text-blue-600",children:"Ï¥àÍ∏∞Ìôî"})]})]})})]}),a.jsx(d,{className:"overflow-hidden border border-gray-200 business-radius-card",children:a.jsx(l,{className:"p-0",children:u?a.jsxs("div",{className:"flex items-center justify-center py-12",children:[a.jsx("div",{className:"w-6 h-6 border-2 border-hansl-500 border-t-transparent rounded-full animate-spin"}),a.jsx("span",{className:"ml-3 text-[11px] text-gray-500",children:"Î°úÎî© Ï§ë..."})]}):0===e.length?a.jsxs("div",{className:"text-center py-12",children:[a.jsx(o,{className:"w-10 h-10 text-gray-300 mx-auto mb-3"}),a.jsx("h3",{className:"text-[12px] font-medium text-gray-700 mb-1",children:"Í±∞ÎûòÎ™ÖÏÑ∏ÏÑúÍ∞Ä ÏóÜÏäµÎãàÎã§"}),a.jsx("p",{className:"text-[11px] text-gray-500",children:"ÏóÖÎ°úÎìúÎêú Í±∞ÎûòÎ™ÖÏÑ∏ÏÑúÍ∞Ä ÏóÜÍ±∞ÎÇò Í≤ÄÏÉâ Ï°∞Í±¥Ïóê ÎßûÎäî Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§."})]}):a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"hidden md:block overflow-x-auto",children:a.jsxs("table",{className:"w-full min-w-fit",children:[a.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:a.jsxs("tr",{children:[a.jsx("th",{className:"px-3 py-2.5 text-center text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:"ÏÉÅÌÉú"}),a.jsx("th",{className:"px-3 py-2.5 text-center text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:"ÏóÖÎ°úÎìúÏùº"}),a.jsx("th",{className:"px-3 py-2.5 text-center text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:"Î™ÖÏÑ∏ÏÑúÏùº"}),a.jsx("th",{className:"px-3 py-2.5 text-left text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:"Í±∞ÎûòÏ≤òÎ™Ö"}),a.jsx("th",{className:"px-3 py-2.5 text-left text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:"ÌååÏùºÎ™Ö"}),a.jsx("th",{className:"px-3 py-2.5 text-right text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:"Ìï©Í≥ÑÍ∏àÏï°"}),a.jsx("th",{className:"px-3 py-2.5 text-center text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:"Îì±Î°ùÏûê"}),a.jsx("th",{className:"px-3 py-2.5 text-center text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:"ÌôïÏ†ïÏûê"}),a.jsx("th",{className:"px-3 py-2.5 text-center text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:"Ïï°ÏÖò"})]})}),a.jsx("tbody",{className:"bg-white divide-y divide-gray-100",children:e.map(e=>a.jsxs("tr",{className:"hover:bg-gray-50 transition-colors cursor-pointer",onClick:t=>pe(e,t),children:[a.jsx("td",{className:"px-3 py-2.5 text-center",children:re.has(e.id)?ue("processing"):ue(e.status)}),a.jsx("td",{className:"px-3 py-2.5 text-[11px] text-center text-gray-600",children:be(e.uploaded_at)}),a.jsx("td",{className:"px-3 py-2.5 text-[11px] text-center text-gray-600",children:e.statement_date?be(e.statement_date):"-"}),a.jsx("td",{className:"px-3 py-2.5 text-[11px] font-medium text-gray-900",children:e.vendor_name||"-"}),a.jsx("td",{className:"px-3 py-2.5 text-[11px] text-gray-700 max-w-[180px] truncate",children:e.file_name||"-"}),a.jsx("td",{className:"px-3 py-2.5 text-[11px] font-medium text-right text-gray-900",children:ge(e.grand_total)}),a.jsx("td",{className:"px-3 py-2.5 text-[11px] text-center text-gray-600",children:e.uploaded_by_name||"-"}),a.jsx("td",{className:"px-3 py-2.5 text-[11px] text-center text-gray-600",children:e.confirmed_by_name||"-"}),a.jsx("td",{className:"px-3 py-2.5 text-center",children:a.jsxs("div",{className:"flex items-center justify-center gap-1",children:[a.jsx("button",{onClick:t=>he(t,e.image_url),className:"p-1.5 rounded-md hover:bg-gray-100 text-gray-500 hover:text-gray-700 transition-colors",title:"Ïù¥ÎØ∏ÏßÄ Î≥¥Í∏∞",children:a.jsx(C,{className:"w-3.5 h-3.5"})}),a.jsx("button",{onClick:t=>(async(e,t)=>{if(e.stopPropagation(),confirm(`"${t.file_name||"Ïù¥ Í±∞ÎûòÎ™ÖÏÑ∏ÏÑú"}"Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`))try{const e=await k.deleteStatement(t.id);e.success?(f.success("ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§."),le()):f.error(e.error||"ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.")}catch(r){f.error("ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.")}})(t,e),className:"p-1.5 rounded-md hover:bg-red-50 text-red-400 hover:text-red-600 transition-colors",title:"ÏÇ≠Ï†ú",children:a.jsx(m,{className:"w-3.5 h-3.5"})})]})})]},e.id))})]})}),a.jsx("div",{className:"md:hidden divide-y divide-gray-100",children:e.map(e=>a.jsxs("div",{className:"p-3 hover:bg-gray-50 transition-colors cursor-pointer",onClick:t=>pe(e,t),children:[a.jsxs("div",{className:"flex items-start justify-between mb-2",children:[re.has(e.id)?ue("processing"):ue(e.status),a.jsx("span",{className:"text-[10px] text-gray-400",children:be(e.uploaded_at)})]}),a.jsxs("div",{className:"mb-2",children:[a.jsx("p",{className:"text-[11px] font-medium text-gray-900",children:e.vendor_name||"Í±∞ÎûòÏ≤ò ÎØ∏ÌôïÏù∏"}),a.jsx("p",{className:"text-[10px] text-gray-500 truncate",children:e.file_name})]}),e.grand_total&&a.jsx("p",{className:"text-[12px] font-bold text-gray-900",children:ge(e.grand_total)}),a.jsx("div",{className:"flex items-center justify-end gap-2 mt-2 pt-2 border-t border-gray-100",children:a.jsxs("button",{onClick:t=>he(t,e.image_url),className:"button-base px-2 py-1 text-[10px] border border-gray-200 text-gray-600 hover:bg-gray-50",children:[a.jsx(C,{className:"w-3 h-3 mr-1"}),"Î≥¥Í∏∞"]})})]},e.id))})]})})}),a.jsx(A,{isOpen:L,onClose:()=>H(!1),onSuccess:async(e,t)=>{H(!1),await le(),ae(t=>new Set(t).add(e));try{f.loading("OCR Ï∂îÏ∂ú Ï§ë... (ÏïΩ 10~30Ï¥à ÏÜåÏöî)",{id:`extraction-${e}`});const r=await k.extractStatementData(e,t);r.success?(f.success("OCR Ï∂îÏ∂úÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§. Í≤∞Í≥ºÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.",{id:`extraction-${e}`}),le(),r.data&&(K(r.data),Y(!0))):(f.error(r.error||"OCR Ï∂îÏ∂úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.",{id:`extraction-${e}`}),le())}catch(r){f.error("OCR Ï∂îÏ∂ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.",{id:`extraction-${e}`}),le()}finally{ae(t=>{const r=new Set(t);return r.delete(e),r})}}}),J&&a.jsx(X,{isOpen:V,statement:J,onClose:_e,onConfirm:_e}),a.jsx(G,{isOpen:Z,imageUrl:ee,onClose:()=>{Q(!1),te("")}}),ce.isOpen&&ce.statement&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"fixed inset-0 z-40",onClick:xe}),a.jsxs("div",{className:"fixed z-50 bg-white border border-gray-200 rounded-lg shadow-lg min-w-[280px] max-w-[360px]",style:{top:ce.position.top+4,left:ce.position.left},children:[a.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-b border-gray-100 bg-gray-50 rounded-t-lg",children:[a.jsxs("span",{className:"text-[11px] font-semibold text-gray-700",children:["Ïó∞Í≤∞Îêú Î∞úÏ£º (",ce.statement.matched_purchases?.length||0,"Í±¥)"]}),a.jsx("button",{onClick:xe,className:"p-0.5 hover:bg-gray-200 rounded",children:a.jsx(s,{className:"w-3.5 h-3.5 text-gray-500"})})]}),a.jsx("div",{className:"max-h-[300px] overflow-auto",children:ce.statement.matched_purchases?.map((e,t)=>a.jsxs("div",{onClick:()=>{return t=e.purchase_id,de({isOpen:!1,statement:null,position:{top:0,left:0}}),oe(t),void ne(!0);var t},className:"flex items-center justify-between px-3 py-2.5 hover:bg-blue-50 cursor-pointer border-b border-gray-50 last:border-0 transition-colors",children:[a.jsxs("div",{className:"flex-1",children:[a.jsx("p",{className:"text-[12px] font-medium text-gray-900",children:e.purchase_order_number||e.sales_order_number||`Î∞úÏ£º #${e.purchase_id}`}),e.sales_order_number&&e.purchase_order_number&&a.jsxs("p",{className:"text-[10px] text-gray-500",children:["ÏàòÏ£º: ",e.sales_order_number]})]}),a.jsxs("div",{className:"flex items-center gap-1 text-blue-600",children:[a.jsx("span",{className:"text-[10px]",children:"ÏÉÅÏÑ∏Î≥¥Í∏∞"}),a.jsx(D,{className:"w-3.5 h-3.5"})]})]},e.purchase_id))})]})]}),ie&&a.jsx(O,{purchaseId:ie,isOpen:se,onClose:()=>{ne(!1),oe(null)},activeTab:"all"})]})}export{Y as default};
//# sourceMappingURL=TransactionStatementMain-CmDqtFxN.js.map
