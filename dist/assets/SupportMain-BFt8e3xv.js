import{e,r as s,j as a,z as t,B as r,X as n,s as l,c as i,M as c,w as d,g as o}from"./index-B10MXRio.js";import{C as m,a as u,b as x,c as h,S as p,T as g}from"./card-QP279vC5.js";import{I as b,D as y,a as j,b as f,c as v}from"./dialog-Cmrbb0S0.js";import{T as N}from"./textarea-G-k_AwYk.js";import{S as _,a as w,b as q,c as k,d as S,C}from"./select-B45xlmY8.js";import{t as M}from"./index-DZIVtcIE.js";import{A as I,a as $,b as D,c as P,d as T,e as z,f as F,g as R}from"./alert-dialog-DFyj34AT.js";import{C as L,k as E,f as H,a as A}from"./react-select.esm-BxbvKx2J.js";import{P as O,a as B,b as V}from"./popover-xpcMj7oI.js";import{C as Y}from"./calendar-py_FtKCX.js";import{C as K,d as U,P as W}from"./PurchaseDetailModal-BFXKDRQv.js";import{a as G,C as J}from"./chevron-right-1OPWKzlh.js";import{L as Q}from"./loader-circle-Cbf0y8en.js";import{E as X}from"./eye-DcyRlawH.js";import{S as Z}from"./save-DWxtgCsS.js";import"./check-DhkQyFTZ.js";import"./helpers-CmqE03mo.js";import"./credit-card-5JoV3nOJ.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ee=e("image-plus",[["path",{d:"M16 5h6",key:"1vod17"}],["path",{d:"M19 2v6",key:"4bpg5p"}],["path",{d:"M21 11.5V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7.5",key:"1ue2ih"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}]]),se=e("send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]);function ae({className:e,date:l,onDateChange:i,placeholder:c="기간을 선택하세요",disabled:d=!1,...o}){const[m,u]=s.useState(!1),x=e=>{if(!e?.from)return c;const s=e=>e.toLocaleDateString("ko-KR",{year:"numeric",month:"long",day:"numeric"});if(e.from&&e.to){if(e.from.getFullYear()===e.to.getFullYear()&&e.from.getMonth()===e.to.getMonth()){return`${e.from.getFullYear()}년 ${e.from.toLocaleDateString("ko-KR",{month:"long"})} ${e.from.getDate()}일 - ${e.to.getDate()}일`}return`${s(e.from)} - ${s(e.to)}`}return s(e.from)};return a.jsx("div",{className:t("grid gap-2",e),...o,children:a.jsxs(O,{open:m,onOpenChange:u,children:[a.jsx(B,{asChild:!0,children:a.jsxs(r,{id:"date",variant:"outline",className:t("w-full justify-start text-left font-normal h-9 text-sm border-gray-200 hover:border-gray-300 hover:bg-gray-50 transition-colors",!l&&"text-gray-500",l&&"text-gray-900"),disabled:d,children:[a.jsx(Y,{className:"mr-2 h-4 w-4 text-gray-400"}),a.jsx("span",{className:"truncate",children:x(l)}),l&&a.jsx(n,{className:"ml-auto h-4 w-4 text-gray-400 hover:text-gray-600 transition-colors",onClick:e=>{e.stopPropagation(),i?.(void 0),u(!1)}})]})}),a.jsx(V,{className:"w-auto p-0 shadow-lg border border-gray-200",align:"start",children:a.jsxs("div",{className:"bg-white rounded-lg overflow-hidden",children:[a.jsxs("div",{className:"bg-gray-50 border-b border-gray-100 px-4 py-3",children:[a.jsx("h4",{className:"text-sm font-medium text-gray-900",children:"기간 선택"}),a.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"시작일과 종료일을 선택하세요"})]}),a.jsx("div",{className:"p-4",children:a.jsx(L,{initialFocus:!0,mode:"range",defaultMonth:l?.from,selected:l,onSelect:e=>{i?.(e),e?.from&&e?.to&&u(!1)},numberOfMonths:2,disabled:d,locale:E,className:"rounded-md",classNames:{months:"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",month:"space-y-4",caption:"flex justify-center pt-1 relative items-center text-sm font-medium",caption_label:"text-sm font-medium text-gray-900",nav:"space-x-1 flex items-center",nav_button:"inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none border border-input bg-background hover:bg-accent hover:text-accent-foreground h-7 w-7",nav_button_previous:"absolute left-1",nav_button_next:"absolute right-1",table:"w-full border-collapse space-y-1",head_row:"flex",head_cell:"text-gray-500 rounded-md w-9 font-normal text-[0.8rem]",row:"flex w-full mt-2",cell:"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20",day:"inline-flex items-center justify-center rounded-md text-sm font-normal ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 aria-selected:opacity-100 h-9 w-9 hover:bg-gray-100 hover:text-gray-900 text-gray-900",day_range_start:"day-range-start bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",day_range_end:"day-range-end bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",day_selected:"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",day_today:"bg-accent text-accent-foreground font-semibold",outside:"!text-gray-400 !opacity-40 hover:!text-gray-500 hover:bg-gray-50 aria-selected:bg-accent/50 aria-selected:text-muted-foreground aria-selected:opacity-30",day_disabled:"!text-gray-400 !opacity-40",day_range_middle:"aria-selected:bg-accent aria-selected:text-accent-foreground",day_hidden:"invisible"}})}),l&&a.jsx("div",{className:"bg-gray-50 border-t border-gray-100 px-4 py-3",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("span",{className:"text-xs text-gray-600",children:["선택된 기간: ",x(l)]}),a.jsx(r,{variant:"ghost",size:"sm",onClick:()=>{i?.(void 0),u(!1)},className:"h-6 px-2 text-xs",children:"지우기"})]})})]})})]})})}function te(){const[e,t]=s.useState(""),[L,E]=s.useState(""),[O,B]=s.useState(""),[V,Y]=s.useState(!1),[te,re]=s.useState([]),[ne,le]=s.useState(!1),ie=s.useRef(null),[ce,de]=s.useState(!1),[oe,me]=s.useState(),[ue,xe]=s.useState([]),[he,pe]=s.useState(null),[ge,be]=s.useState(!1),[ye,je]=s.useState(1),[fe,ve]=s.useState(null),[Ne,_e]=s.useState([]),[we,qe]=s.useState(null),[ke,Se]=s.useState(""),[Ce,Me]=s.useState(""),[Ie,$e]=s.useState([]),[De,Pe]=s.useState(!0),[Te,ze]=s.useState(null),[Fe,Re]=s.useState(!1),[Le,Ee]=s.useState(null),[He,Ae]=s.useState(!1),[Oe,Be]=s.useState(null),[Ve,Ye]=s.useState(null),[Ke,Ue]=s.useState(!1),[We,Ge]=s.useState(null),[Je,Qe]=s.useState(!1),[Xe,Ze]=s.useState(null),[es,ss]=s.useState(!1),[as,ts]=s.useState("발주내역이 삭제 되었거나 없습니다."),[rs,ns]=s.useState([]),[ls,is]=s.useState(!1),[cs,ds]=s.useState(!1),[os,ms]=s.useState(""),[us,xs]=s.useState(!1),hs=s.useRef(null),ps=s.useRef(null),gs=s.useRef(null),bs=s.useRef(!1),ys=s.useRef(new Map);s.useEffect(()=>{js()},[]),s.useEffect(()=>{if(null===we)return;const e=l.subscribeToInquiries(e=>{const s=e?.eventType,a=e?.new,t=e?.old;if("DELETE"===s){const e=t?.id;if(!e)return;return _e(s=>s.filter(s=>s.id!==e)),void(Te===e&&ze(null))}const r=a;r?.id&&_e(e=>{const s=!!(a=r)&&(!!we||!!Ce&&a.user_id===Ce);var a;const t=e.findIndex(e=>e.id===r.id);if(!s){if(-1===t)return e;return e.filter(e=>e.id!==r.id)}const n=[...e];return t>=0?n[t]=r:n.unshift(r),n.sort((e,s)=>{const a=e.created_at?new Date(e.created_at).getTime():0;return(s.created_at?new Date(s.created_at).getTime():0)-a}),n})});return()=>{e.unsubscribe()}},[we,Ce]);const js=async()=>{const e=i(),{data:{user:s}}=await e.auth.getUser();if(!s)return;Se(s.email||""),Me(s.id);const{data:a}=await e.from("employees").select("purchase_role").eq("email",s.email).single();if(a){const e=Array.isArray(a.purchase_role)?a.purchase_role:a.purchase_role?.split(",").map(e=>e.trim())||[];$e(e);const s=e.includes("app_admin");qe(s),fs(s)}},fs=async e=>{Pe(!0);const s=e?await l.getAllInquiries():await l.getMyInquiries();s.success?_e(s.data):M.error(s.error||"문의 목록 로드 실패"),Pe(!1)},vs=async()=>{if(null===we)return;Pe(!0);const e=we?await l.getAllInquiries():await l.getMyInquiries();e.success?_e(e.data):M.error(e.error||"문의 목록 로드 실패"),Pe(!1)};s.useEffect(()=>{"modify"===e||"delete"===e?de(!0):(de(!1),pe(null))},[e]);const Ns=Math.ceil(ue.length/5),_s=5*(ye-1),ws=_s+5,qs=ue.slice(_s,ws),ks=async(e,s,a)=>{if("resolved"===s){const s=await l.resolveInquiry(e);s.success?(M.success("문의가 완료 처리되었습니다."),vs()):M.error(s.error||"완료 처리 실패")}else{const a=await l.updateInquiryStatus(e,s);a.success?(M.success("상태가 업데이트되었습니다."),vs()):M.error(a.error||"상태 업데이트 실패")}},Ss=Ne.find(e=>e.id===Te)||null;s.useEffect(()=>{if(!Ss?.id)return;const e=Ss.id;let s=!1;bs.current=!0;const a=ys.current.get(e);a&&a.length>0?(ns(a),is(!1),ds(!0)):(ns([]),is(!0),ds(!1));const t=async()=>{(ys.current.get(e)?.length??0)>0?ds(!0):is(!0);const a=await l.getInquiryMessages(e);if(!s)if(a.success){const s=hs.current,t=s?.scrollTop??0,r=gs.current!==e;gs.current=e;const n=!!r||(!s||s.scrollHeight-s.scrollTop-s.clientHeight<80);ps.current={atBottom:n,prevTop:t},ns(a.data),ys.current.set(e,a.data),is(!1),ds(!1)}else M.error(a.error||"대화 내용을 불러오지 못했습니다."),is(!1),ds(!1)};t(),(async()=>{if(we)return;if(!ke)return;const s=i();await s.from("notifications").update({is_read:!0,read_at:(new Date).toISOString()}).eq("user_email",ke).eq("is_read",!1).in("type",["inquiry_message","inquiry_resolved"]).eq("data->>inquiryId",String(e))})();const r=l.subscribeToInquiryMessages(e,()=>{t()});return()=>{s=!0,r.unsubscribe()}},[Ss?.id,we,ke]),s.useLayoutEffect(()=>{if(!Ss?.id)return;const e=hs.current;if(e)if(bs.current)e.scrollTop=e.scrollHeight,(rs.length>0||!ls)&&(bs.current=!1);else{const s=ps.current;if(!s)return;s.atBottom?e.scrollTop=e.scrollHeight:e.scrollTop=s.prevTop}},[Ss?.id,rs,ls]);const Cs=async e=>{try{if(e.purchase_request_id)return Ge(e.purchase_request_id),void Ue(!0);const s=e.purchase_order_number?.trim();if(!s)return ts("발주내역이 삭제 되었거나 없습니다."),void ss(!0);const a=i(),{data:t,error:r}=await a.from("purchase_requests").select("id").eq("purchase_order_number",s).limit(1).maybeSingle();if(r)throw r;if(!t?.id)return ts("발주내역이 삭제 되었거나 없습니다."),void ss(!0);Ge(t.id),Ue(!0)}catch(s){ts("발주내역이 삭제 되었거나 없습니다."),ss(!0)}},Ms=()=>{Be(null),Ye(null)},Is=e=>{switch(e){case"open":return a.jsx("span",{className:"badge-stats bg-yellow-100 text-yellow-800",children:"대기"});case"in_progress":return a.jsx("span",{className:"badge-stats bg-blue-100 text-blue-800",children:"처리중"});case"resolved":return a.jsx("span",{className:"badge-stats bg-green-100 text-green-800",children:"완료"});case"closed":return a.jsx("span",{className:"badge-stats bg-gray-100 text-gray-800",children:"종료"});default:return a.jsx("span",{className:"badge-stats border border-gray-300 bg-white text-gray-600",children:"-"})}},$s=e=>{switch(e){case"bug":return"오류 신고";case"modify":return"수정 요청";case"delete":return"삭제 요청";case"other":return"기타 문의";default:return e}};return null===we?a.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"}),a.jsx("p",{className:"text-gray-600",children:"권한 확인 중..."})]})}):a.jsxs("div",{className:"min-h-screen bg-gray-50",children:[a.jsxs("div",{className:"w-full",children:[a.jsxs("div",{className:"mb-4",children:[a.jsx("h1",{className:"page-title text-gray-900",children:"문의하기"}),a.jsx("p",{className:"page-subtitle text-gray-600 mt-1",children:we?"모든 문의를 관리하고 답변할 수 있습니다":"시스템 사용 중 궁금하신 점이나 개선사항을 알려주세요"})]}),a.jsxs("div",{className:""+(we?"max-w-4xl":"grid grid-cols-1 xl:grid-cols-2 gap-4"),children:[!we&&a.jsxs(m,{children:[a.jsx(u,{children:a.jsxs(x,{className:"flex items-center gap-2",children:[a.jsx(c,{className:"w-5 h-5"}),"문의 내용"]})}),a.jsx(h,{children:a.jsxs("form",{onSubmit:async s=>{if(s.preventDefault(),!e||!L||!O)return void M.error("모든 필드를 입력해주세요.");if(("modify"===e||"delete"===e)&&!he)return void M.error("수정/삭제할 발주요청을 선택해주세요.");Y(!0);let a=O,r="";if(he){const e=(he.purchase_request_items||[]).map(e=>`- ${e.item_name} (${e.specification}) ${e.quantity}개`).join("\n"),s=he.purchase_order_number||"(승인대기)";r=`발주번호: ${he.purchase_order_number}\n업체: ${he.vendor_name}\n요청자: ${he.requester_name}\n요청일: ${he.request_date}\n품목:\n${e}`,r=`발주번호: ${s}\n업체: ${he.vendor_name}\n요청자: ${he.requester_name}\n요청일: ${he.request_date||he.created_at||"-"}\n품목:\n${e}`,a=`${O}\n\n[관련 발주 정보]\n${r}`}const n=await l.createInquiry({inquiry_type:e,subject:L,message:a,purchase_request_id:he?.id,purchase_info:r,purchase_order_number:he?.purchase_order_number,attachments:te});if(n.success){M.success("문의가 접수되었습니다.");const e=n.inquiryId;t(""),E(""),B(""),pe(null),xe([]),me(void 0),re([]),vs(),e&&ze(e)}else M.error(n.error||"문의 접수에 실패했습니다.");Y(!1)},className:"space-y-4",children:[a.jsxs("div",{children:[a.jsxs("label",{className:"block modal-label text-gray-700 mb-1",children:["문의 유형 ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsxs(_,{value:e,onValueChange:t,children:[a.jsx(w,{children:a.jsx(q,{placeholder:"문의 유형을 선택해주세요"})}),a.jsxs(k,{children:[a.jsx(S,{value:"bug",children:"오류 신고"}),a.jsx(S,{value:"modify",children:"수정 요청"}),a.jsx(S,{value:"delete",children:"삭제 요청"}),a.jsx(S,{value:"other",children:"기타 문의"})]})]})]}),ce&&a.jsxs("div",{className:"space-y-3 p-4 bg-blue-50 rounded-lg border border-blue-200",children:[a.jsx("div",{className:"modal-label text-blue-900",children:"수정/삭제할 발주요청 선택"}),a.jsxs("div",{children:[a.jsx("label",{className:"modal-label text-gray-600 mb-2 block",children:"기간 선택"}),a.jsx(ae,{date:oe,onDateChange:me,placeholder:"발주요청 기간을 선택하세요",className:"w-full"})]}),a.jsx(r,{type:"button",onClick:async()=>{be(!0),je(1);const e=oe?.from?oe.from.toISOString().split("T")[0]:void 0,s=oe?.to?oe.to.toISOString().split("T")[0]:void 0,a=await l.getMyPurchaseRequests(e,s);a.success?xe(a.data):M.error(a.error||"발주요청 조회 실패"),be(!1)},disabled:ge,className:"w-full h-9",variant:"outline",children:ge?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"w-4 h-4 border-2 border-gray-600 border-t-transparent rounded-full animate-spin mr-2"}),"검색 중..."]}):a.jsxs(a.Fragment,{children:[a.jsx(p,{className:"w-4 h-4 mr-2"}),"발주요청 검색"]})}),ue.length>0&&a.jsxs("div",{className:"space-y-3",children:[a.jsxs("div",{className:"modal-label text-gray-600",children:["발주요청 선택 (총 ",ue.length,"건)"]}),a.jsx("div",{className:"space-y-1",children:qs.map(e=>a.jsxs("div",{className:"border rounded overflow-hidden",children:[a.jsx("div",{onClick:()=>pe(e),className:"px-3 py-2 cursor-pointer transition-all badge-text "+(he?.id===e.id?"border-blue-500 bg-blue-50":"hover:bg-gray-50"),children:a.jsxs("div",{className:"flex items-center justify-between gap-2",children:[a.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[a.jsx("span",{className:"modal-value whitespace-nowrap",children:e.purchase_order_number||"(승인대기)"}),e.final_manager_status&&"approved"!==e.final_manager_status&&a.jsx("span",{className:"badge-stats whitespace-nowrap "+("rejected"===e.final_manager_status||"rejected"===e.middle_manager_status?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"),children:"rejected"===e.final_manager_status||"rejected"===e.middle_manager_status?"반려":"승인대기"}),a.jsx("span",{className:"text-gray-600 truncate",children:e.vendor_name}),a.jsxs("span",{className:"text-gray-500",children:[e.purchase_request_items?.[0]?.item_name||"품목 없음",e.purchase_request_items?.length>1&&a.jsx("span",{className:"modal-value text-blue-600",children:` 외 ${e.purchase_request_items.length-1}건`})]}),a.jsx("span",{className:"text-gray-400 whitespace-nowrap ml-auto",children:(e.request_date||e.created_at)&&H(new Date(e.request_date||e.created_at),"MM/dd")})]}),a.jsxs("div",{className:"flex items-center gap-1",children:[he?.id===e.id&&a.jsx(K,{className:"w-4 h-4 text-blue-500 flex-shrink-0"}),e.purchase_request_items?.length>1&&a.jsx("button",{type:"button",onClick:s=>{s.stopPropagation(),ve(fe===e.id?null:e.id)},className:"p-1 hover:bg-gray-200 rounded",children:fe===e.id?a.jsx(C,{className:"w-4 h-4"}):a.jsx(G,{className:"w-4 h-4"})})]})]})}),fe===e.id&&e.purchase_request_items?.length>0&&a.jsx("div",{className:"px-3 py-2 bg-gray-50 border-t badge-text",children:a.jsxs("div",{className:"space-y-1",children:[a.jsx("div",{className:"modal-value text-gray-700 mb-1",children:"품목 상세"}),e.purchase_request_items.map((e,s)=>a.jsxs("div",{className:"flex items-center gap-2 text-gray-600 pl-2",children:[a.jsxs("span",{className:"text-gray-400",children:[s+1,"."]}),a.jsx("span",{children:e.item_name}),e.specification&&a.jsxs("span",{className:"text-gray-500",children:["(",e.specification,")"]}),a.jsxs("span",{className:"text-gray-500",children:["- ",e.quantity,"개"]})]},s))]})})]},e.id))}),Ns>1&&a.jsxs("div",{className:"flex justify-center items-center gap-1 pt-2",children:[a.jsx(r,{type:"button",variant:"outline",size:"sm",onClick:()=>je(Math.max(1,ye-1)),disabled:1===ye,className:"h-8 w-8 p-0",children:a.jsx(A,{className:"w-4 h-4"})}),Array.from({length:Ns},(e,s)=>s+1).map(e=>a.jsx(r,{type:"button",variant:ye===e?"default":"outline",size:"sm",onClick:()=>je(e),className:"h-8 w-8 p-0",children:e},e)),a.jsx(r,{type:"button",variant:"outline",size:"sm",onClick:()=>je(Math.min(Ns,ye+1)),disabled:ye===Ns,className:"h-8 w-8 p-0",children:a.jsx(J,{className:"w-4 h-4"})})]})]})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"block modal-label text-gray-700 mb-1",children:["제목 ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx(b,{value:L,onChange:e=>E(e.target.value),placeholder:"문의 제목을 입력해주세요",maxLength:100})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"block modal-label text-gray-700 mb-1",children:["내용 ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx(N,{value:O,onChange:e=>B(e.target.value),placeholder:"문의 내용을 자세히 입력해주세요",rows:6,maxLength:1e3}),a.jsxs("p",{className:"badge-text text-gray-500 mt-1",children:[O.length,"/1000"]})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"block modal-label text-gray-700 mb-2",children:["사진 첨부 ",a.jsx("span",{className:"badge-text text-gray-400",children:"(선택, 최대 5개)"})]}),te.length>0&&a.jsx("div",{className:"flex flex-wrap gap-2 mb-3",children:te.map((e,s)=>a.jsxs("div",{className:"relative group",children:[a.jsx("img",{src:e.url,alt:e.name,className:"w-20 h-20 object-cover rounded-lg border border-gray-200"}),a.jsx("button",{type:"button",onClick:()=>(async e=>{const s=te[e];await l.deleteAttachment(s.path),re(s=>s.filter((s,a)=>a!==e)),M.success("첨부파일이 삭제되었습니다.")})(s),className:"absolute -top-2 -right-2 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity",title:"삭제",children:a.jsx(n,{className:"w-3 h-3"})}),a.jsx("p",{className:"text-[10px] text-gray-500 mt-1 truncate w-20 text-center",children:e.name})]},s))}),te.length<5&&a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("input",{ref:ie,type:"file",accept:"image/*",onChange:async e=>{const s=e.target.files;if(!s||0===s.length)return;if(te.length>=5)return void M.error("첨부파일은 최대 5개까지 가능합니다.");const a=s[0];if(a.size>5242880)return void M.error("파일 크기는 5MB 이하만 가능합니다.");if(!a.type.startsWith("image/"))return void M.error("이미지 파일만 첨부 가능합니다.");le(!0);const t=await l.uploadAttachment(a);t.success&&t.data?(re(e=>[...e,t.data]),M.success("이미지가 첨부되었습니다.")):M.error(t.error||"이미지 업로드 실패"),le(!1),ie.current&&(ie.current.value="")},className:"hidden"}),a.jsx("button",{type:"button",onClick:()=>ie.current?.click(),disabled:ne,className:"button-action-secondary disabled:opacity-50 disabled:cursor-not-allowed",children:ne?a.jsxs(a.Fragment,{children:[a.jsx(Q,{className:"w-3.5 h-3.5 animate-spin"}),"업로드 중..."]}):a.jsxs(a.Fragment,{children:[a.jsx(ee,{className:"w-3.5 h-3.5"}),"사진 추가"]})}),a.jsxs("span",{className:"badge-text text-gray-400",children:[te.length,"/5"]})]})]}),a.jsx(r,{type:"submit",className:"w-full",disabled:V||ne,children:V?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}),"전송 중..."]}):a.jsxs(a.Fragment,{children:[a.jsx(se,{className:"w-4 h-4 mr-2"}),"문의 보내기"]})})]})})]}),a.jsxs(m,{children:[a.jsx(u,{children:a.jsxs(x,{className:"flex items-center justify-between",children:[a.jsxs("span",{className:"flex items-center gap-2",children:[a.jsx(d,{className:"w-5 h-5 text-orange-500"}),we?"전체 문의 목록":"내 문의 내역"]}),a.jsxs("span",{className:"badge-stats border border-gray-300 bg-white text-gray-600",children:[Ne.length,"건"]})]})}),a.jsx(h,{children:De?a.jsx("div",{className:"flex items-center justify-center py-8",children:a.jsx("div",{className:"w-6 h-6 border-2 border-gray-300 border-t-transparent rounded-full animate-spin"})}):0===Ne.length?a.jsxs("div",{className:"text-center py-8 text-gray-500",children:[a.jsx(c,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),a.jsx("p",{className:"text-sm",children:"문의 내역이 없습니다"})]}):a.jsx("div",{className:"space-y-1 max-h-[600px] overflow-y-auto",children:Ne.map(e=>a.jsxs("div",{className:"border rounded overflow-hidden",children:[a.jsx("div",{className:"px-3 py-2 hover:bg-gray-50 transition-colors cursor-pointer",onClick:()=>{ze(Te===e.id?null:e.id)},children:a.jsxs("div",{className:"flex items-center justify-between gap-2",children:[a.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[a.jsx("span",{className:"badge-stats border border-gray-300 bg-white text-gray-600 whitespace-nowrap",children:$s(e.inquiry_type)}),Is(e.status),a.jsx("span",{className:"modal-label truncate",children:e.subject}),we&&a.jsx("span",{className:"badge-text text-gray-500",children:e.user_name||e.user_email}),e.purchase_order_number&&a.jsxs("button",{type:"button",className:"badge-text text-blue-600 hover:underline",onClick:s=>{s.stopPropagation(),Cs(e)},title:"발주 상세 열기",children:["[",e.purchase_order_number,"]"]}),a.jsx("span",{className:"badge-text text-gray-400 ml-auto whitespace-nowrap",children:e.created_at&&H(new Date(e.created_at),"MM/dd HH:mm")})]}),a.jsxs("div",{className:"flex items-center gap-1",children:[we&&"open"===e.status&&a.jsx("button",{type:"button",onClick:s=>{s.stopPropagation(),ks(e.id,"in_progress")},className:"badge-stats border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 hover:border-gray-400",children:"처리중"}),we&&("open"===e.status||"in_progress"===e.status)&&a.jsx("button",{type:"button",onClick:s=>{s.stopPropagation(),ks(e.id,"resolved")},className:"badge-stats bg-green-500 text-white hover:bg-green-600",children:"완료"}),(we||"open"===e.status&&!e.resolution_note&&e.user_email===ke)&&a.jsx(r,{size:"sm",variant:"ghost",onClick:s=>{s.stopPropagation(),(async e=>{if(!confirm("정말로 이 문의를 삭제하시겠습니까?\n삭제된 문의는 복구할 수 없습니다."))return;const s=await l.deleteInquiry(e);s.success?(M.success("문의가 삭제되었습니다."),vs()):M.error(s.error||"문의 삭제 실패")})(e.id)},className:"h-6 w-6 p-0 hover:bg-red-50",title:"문의 삭제",children:a.jsx(g,{className:"w-3 h-3 text-red-600"})}),a.jsx("button",{type:"button",className:"p-1 hover:bg-gray-200 rounded",children:Te===e.id?a.jsx(C,{className:"w-4 h-4"}):a.jsx(G,{className:"w-4 h-4"})})]})]})}),Te===e.id&&a.jsx("div",{className:"px-3 py-3 bg-gray-50 border-t text-sm",children:a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{children:[a.jsx("span",{className:"modal-value text-gray-700",children:"내용:"}),a.jsx("p",{className:"text-gray-600 mt-1 whitespace-pre-wrap",children:e.message})]}),e.purchase_order_number&&a.jsxs("div",{children:[a.jsx("span",{className:"modal-value text-gray-700",children:"관련 발주번호:"}),a.jsx("button",{type:"button",className:"text-blue-600 ml-2 hover:underline",onClick:s=>{s.stopPropagation(),Cs(e)},title:"발주 상세 열기",children:e.purchase_order_number})]}),e.handled_by&&a.jsxs("div",{children:[a.jsx("span",{className:"modal-value text-gray-700",children:"처리자:"}),a.jsxs("span",{className:"text-green-600 ml-2",children:[e.handled_by,e.processed_at&&` (${H(new Date(e.processed_at),"yyyy-MM-dd HH:mm")})`]})]}),e.attachments&&e.attachments.length>0&&a.jsxs("div",{children:[a.jsx("span",{className:"modal-value text-gray-700",children:"첨부 이미지:"}),a.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:e.attachments.map((e,s)=>a.jsx("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",className:"block",onClick:e=>e.stopPropagation(),children:a.jsx("img",{src:e.url,alt:e.name,className:"w-24 h-24 object-cover rounded-lg border border-gray-200 hover:border-blue-400 transition-colors cursor-pointer"})},s))})]}),a.jsxs("div",{className:"mt-3 border-t pt-3",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("div",{className:"modal-value text-gray-800",children:"대화"}),we&&"resolved"!==e.status&&"closed"!==e.status&&a.jsx("button",{type:"button",onClick:e=>{e.stopPropagation(),(async()=>{if(!Ss?.id)return;const e=await l.resolveInquiry(Ss.id);e.success?(M.success("문의가 완료 처리되었습니다."),ms(""),ze(null),vs()):M.error(e.error||"완료 처리 실패")})()},className:"button-action-success",children:"완료"})]}),a.jsxs("div",{className:"mt-2 border rounded-lg bg-white relative",children:[cs&&a.jsx("div",{className:"absolute top-2 right-2 text-[11px] text-gray-400 bg-white/80 backdrop-blur px-2 py-1 rounded border pointer-events-none","aria-hidden":"true",children:"업데이트 중…"}),a.jsx("div",{ref:hs,className:"max-h-[260px] overflow-y-auto p-3 space-y-2",children:ls&&0===rs.length?a.jsx("div",{className:"flex items-center justify-center py-8",children:a.jsx("div",{className:"w-6 h-6 border-2 border-gray-300 border-t-transparent rounded-full animate-spin"})}):0===rs.length?a.jsx("div",{className:"text-center text-gray-500 py-8",children:"대화 내용이 없습니다."}):rs.map(e=>{const s="system"===e.sender_role,t=!s&&e.sender_email===ke;return a.jsx("div",{className:s?"text-center":"flex "+(t?"justify-end":"justify-start"),children:a.jsxs("div",{className:s?"inline-block text-xs text-gray-500 px-3 py-1 rounded-full bg-gray-50 border":"max-w-[80%] rounded-lg px-3 py-2 "+(t?"bg-blue-600 text-white":"bg-gray-50 border text-gray-800"),children:[!s&&a.jsxs("div",{className:"text-[11px] mb-1 "+(t?"text-white/80":"text-gray-500"),children:["admin"===e.sender_role?"관리자":"문의자",e.created_at&&` · ${H(new Date(e.created_at),"MM/dd HH:mm")}`]}),a.jsx("div",{className:"whitespace-pre-wrap text-sm",children:e.message}),e.attachments&&e.attachments.length>0&&a.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:e.attachments.map((e,s)=>a.jsx("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",className:"block",onClick:e=>e.stopPropagation(),children:a.jsx("img",{src:e.url,alt:e.name,className:"w-20 h-20 object-cover rounded border"})},s))})]})},e.id)})}),a.jsx("div",{className:"border-t p-2",children:"resolved"===e.status||"closed"===e.status?a.jsx("div",{className:"text-sm text-gray-500 text-center py-1",children:"완료된 문의입니다. 추가 대화가 필요하면 새 문의를 등록해주세요."}):a.jsxs("div",{className:"flex items-end gap-2",children:[a.jsx(N,{value:os,onChange:e=>ms(e.target.value),placeholder:"메시지를 입력하세요",rows:2,maxLength:1e3,disabled:us,onClick:e=>e.stopPropagation()}),a.jsx("button",{type:"button",onClick:e=>{e.stopPropagation(),(async()=>{if(!Ss?.id)return;if(!os.trim())return void M.error("메시지를 입력해주세요.");if("resolved"===Ss.status||"closed"===Ss.status)return void M.error("완료된 문의에는 메시지를 보낼 수 없습니다.");xs(!0);const e=await l.sendInquiryMessage({inquiryId:Ss.id,message:os.trim(),senderRole:we?"admin":"user"});e.success?ms(""):M.error(e.error||"메시지 전송 실패"),xs(!1)})()},disabled:us||!os.trim(),className:"button-action-primary disabled:opacity-50 disabled:cursor-not-allowed",children:us?"전송중":"전송"})]})})]})]})]})})]},e.id))})})]})]})]}),a.jsx(y,{open:Fe,onOpenChange:Re,children:a.jsxs(j,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[a.jsx(f,{children:a.jsxs(v,{className:"flex items-center justify-between text-lg",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{children:"발주요청 상세"}),Le?.purchase_order_number&&a.jsx("span",{className:"badge-stats border border-gray-300 bg-white text-gray-600 font-normal",children:Le.purchase_order_number})]}),we&&Le&&a.jsxs(r,{variant:"destructive",size:"sm",onClick:async()=>{if(!Le?.id)return;if(!confirm("이 발주요청 전체를 삭제하시겠습니까?\n모든 품목이 함께 삭제됩니다."))return;const e=await l.deletePurchaseRequest(Le.id);if(e.success){o(Le.id);M.success("발주요청이 삭제되었습니다."),Re(!1),Ee(null),vs()}else M.error(e.error||"발주요청 삭제 실패")},className:"h-8 px-3",children:[a.jsx(g,{className:"w-4 h-4 mr-1"}),"전체 삭제"]})]})}),He?a.jsx("div",{className:"flex items-center justify-center py-8",children:a.jsx("div",{className:"w-6 h-6 border-2 border-gray-300 border-t-transparent rounded-full animate-spin"})}):Le&&a.jsxs("div",{className:"space-y-6",children:[a.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 p-4 bg-gray-50 rounded-lg",children:[a.jsxs("div",{children:[a.jsx("span",{className:"badge-text text-gray-500 uppercase tracking-wider",children:"발주번호"}),a.jsx("p",{className:"font-semibold text-sm mt-1",children:Le.purchase_order_number||"N/A"})]}),a.jsxs("div",{children:[a.jsx("span",{className:"badge-text text-gray-500 uppercase tracking-wider",children:"업체명"}),a.jsx("p",{className:"font-semibold text-sm mt-1",children:Le.vendor_name})]}),a.jsxs("div",{children:[a.jsx("span",{className:"badge-text text-gray-500 uppercase tracking-wider",children:"요청자"}),a.jsx("p",{className:"font-semibold text-sm mt-1",children:Le.requester_name})]}),a.jsxs("div",{children:[a.jsx("span",{className:"badge-text text-gray-500 uppercase tracking-wider",children:"요청일"}),a.jsx("p",{className:"font-semibold text-sm mt-1",children:Le.request_date&&H(new Date(Le.request_date),"yyyy-MM-dd")})]})]}),a.jsxs("div",{children:[a.jsx("h3",{className:"font-semibold text-base mb-3",children:"품목 상세"}),a.jsx("div",{className:"border rounded-lg overflow-x-auto",children:a.jsxs("table",{className:"w-full",children:[a.jsx("thead",{className:"bg-gray-50 border-b",children:a.jsxs("tr",{children:[a.jsx("th",{className:"text-left badge-text modal-value text-gray-700 px-3 py-3 w-12",children:"번호"}),a.jsx("th",{className:"text-left badge-text modal-value text-gray-700 px-3 py-3 min-w-[180px]",children:"품명"}),a.jsx("th",{className:"text-left badge-text modal-value text-gray-700 px-3 py-3 min-w-[150px]",children:"규격"}),a.jsx("th",{className:"text-center badge-text modal-value text-gray-700 px-3 py-3 w-20",children:"수량"}),a.jsx("th",{className:"text-right badge-text modal-value text-gray-700 px-3 py-3 w-28",children:"단가"}),a.jsx("th",{className:"text-right badge-text modal-value text-gray-700 px-3 py-3 w-32",children:"금액"}),a.jsx("th",{className:"text-left badge-text modal-value text-gray-700 px-3 py-3 min-w-[150px]",children:"비고"}),a.jsx("th",{className:"text-center badge-text modal-value text-gray-700 px-3 py-3 w-16",children:"링크"}),we&&a.jsx("th",{className:"text-center badge-text modal-value text-gray-700 px-3 py-3 w-24",children:"작업"})]})}),a.jsx("tbody",{className:"divide-y divide-gray-200",children:Le.purchase_request_items?.map((e,s)=>a.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[a.jsx("td",{className:"text-sm px-3 py-3 text-center modal-value text-gray-600",children:e.line_number||s+1}),a.jsx("td",{className:"text-sm px-3 py-3",children:Oe===e.id?a.jsx(b,{value:Ve?.item_name||"",onChange:e=>Ye({...Ve,item_name:e.target.value}),className:"h-9 text-sm w-full",autoFocus:!0}):a.jsx("span",{className:"modal-value text-gray-900",children:e.item_name})}),a.jsx("td",{className:"text-sm px-3 py-3",children:Oe===e.id?a.jsx(b,{value:Ve?.specification||"",onChange:e=>Ye({...Ve,specification:e.target.value}),className:"h-9 text-sm w-full"}):a.jsx("span",{className:"text-gray-600",children:e.specification||"-"})}),a.jsx("td",{className:"text-sm text-center px-3 py-3",children:Oe===e.id?a.jsx(b,{type:"number",value:Ve?.quantity||"",onChange:e=>Ye({...Ve,quantity:parseInt(e.target.value)}),className:"h-9 text-sm text-center w-full"}):a.jsx("span",{className:"modal-value",children:e.quantity})}),a.jsx("td",{className:"text-sm text-right px-3 py-3",children:Oe===e.id?a.jsx(b,{type:"number",value:Ve?.unit_price_value||"",onChange:e=>Ye({...Ve,unit_price_value:parseInt(e.target.value)}),className:"h-9 text-sm text-right w-full"}):a.jsx("span",{className:"modal-value",children:e.unit_price_value?`${parseFloat(e.unit_price_value).toLocaleString()}`:"-"})}),a.jsx("td",{className:"text-sm text-right px-3 py-3",children:Oe===e.id?a.jsx("span",{className:"font-semibold text-blue-600",children:((Ve?.quantity||0)*(Ve?.unit_price_value||0)).toLocaleString()}):a.jsx("span",{className:"font-semibold text-blue-600",children:e.amount_value?`${parseFloat(e.amount_value).toLocaleString()}`:"-"})}),a.jsx("td",{className:"text-sm px-3 py-3",children:Oe===e.id?a.jsx(N,{value:Ve?.remark||"",onChange:e=>Ye({...Ve,remark:e.target.value}),className:"h-9 text-sm w-full resize-none",rows:1}):a.jsx("span",{className:"text-gray-600 badge-text",children:e.remark||"-"})}),a.jsx("td",{className:"text-sm text-center px-3 py-3",children:e.link?a.jsx("a",{href:e.link,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center justify-center w-8 h-8 rounded hover:bg-blue-50 text-blue-600",children:a.jsx(X,{className:"w-4 h-4"})}):a.jsx("span",{className:"text-gray-400",children:"-"})}),we&&a.jsx("td",{className:"text-sm text-center px-3 py-3",children:Oe===e.id?a.jsxs("div",{className:"flex justify-center gap-1",children:[a.jsxs(r,{size:"sm",onClick:()=>(async e=>{if(!Ve)return;const s=(Ve.quantity||0)*(Ve.unit_price_value||0),a=await l.updatePurchaseRequestItem(e,{item_name:Ve.item_name,specification:Ve.specification,quantity:Ve.quantity,unit_price_value:Ve.unit_price_value,amount_value:s,remark:Ve.remark});a.success?(M.success("품목이 수정되었습니다."),Ms()):M.error(a.error||"품목 수정 실패")})(e.id),className:"h-8 px-2 bg-green-600 hover:bg-green-700",children:[a.jsx(Z,{className:"w-4 h-4 mr-1"}),"저장"]}),a.jsx(r,{size:"sm",variant:"outline",onClick:Ms,className:"h-8 px-2",children:"취소"})]}):a.jsxs("div",{className:"flex justify-center gap-1",children:[a.jsx(r,{size:"sm",variant:"ghost",onClick:()=>(e=>{Be(e.id),Ye({item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,remark:e.remark})})(e),className:"h-8 w-8 p-0 hover:bg-blue-50",children:a.jsx(U,{className:"w-4 h-4 text-blue-600"})}),a.jsx(r,{size:"sm",variant:"ghost",onClick:()=>(async e=>{if(!confirm("이 품목을 삭제하시겠습니까?"))return;const s=await l.deletePurchaseRequestItem(e);s.success?M.success("품목이 삭제되었습니다."):M.error(s.error||"품목 삭제 실패")})(e.id),className:"h-8 w-8 p-0 hover:bg-red-50",children:a.jsx(g,{className:"w-4 h-4 text-red-600"})})]})})]},e.id))}),a.jsx("tfoot",{className:"bg-gray-50 border-t-2",children:a.jsxs("tr",{children:[a.jsx("td",{colSpan:5,className:"text-sm font-semibold text-right px-3 py-3",children:"합계"}),a.jsx("td",{className:"text-sm font-bold text-right px-3 py-3 text-blue-600",children:Le.purchase_request_items?.reduce((e,s)=>e+(parseFloat(s.amount_value)||0),0).toLocaleString()}),a.jsx("td",{colSpan:we?3:2,className:"px-3 py-3"})]})})]})})]}),Le.notes&&a.jsxs("div",{children:[a.jsx("h3",{className:"modal-value mb-2",children:"비고"}),a.jsx("p",{className:"page-subtitle text-gray-600 p-3 bg-gray-50 rounded-lg",children:Le.notes})]})]})]})}),a.jsx(W,{purchaseId:We,isOpen:Ke,onClose:()=>{Ue(!1),Ge(null)},currentUserRoles:Ie,activeTab:"done",onDelete:e=>{Ze(e),Qe(!0)}}),a.jsx(I,{open:Je,onOpenChange:e=>{Qe(e),e||Ze(null)},children:a.jsxs($,{children:[a.jsxs(D,{children:[a.jsx(P,{children:"발주요청 내역 삭제"}),a.jsxs(T,{children:["발주요청번호 ",a.jsx("strong",{children:Xe?.purchase_order_number||"알 수 없음"}),"를 삭제하시겠습니까?",a.jsx("br",{}),"이 작업은 되돌릴 수 없습니다."]})]}),a.jsxs(z,{children:[a.jsx(F,{children:"취소"}),a.jsx(R,{onClick:async()=>{if(!Xe?.id)return void M.error("삭제할 발주 정보가 없습니다.");const e=i();try{const s="string"==typeof Xe.id?parseInt(Xe.id,10):Xe.id;if(!s||Number.isNaN(s))return void M.error("발주 ID가 올바르지 않습니다.");const{error:a}=await e.from("support_inquires").update({purchase_request_id:null}).eq("purchase_request_id",s);if(a)throw a;const{error:t}=await e.from("purchase_request_items").delete().eq("purchase_request_id",s);if(t)throw t;const{error:r}=await e.from("purchase_requests").delete().eq("id",s);if(r)throw r;o(s),M.success("발주요청이 삭제되었습니다. (문의 기록은 보존됩니다)"),Qe(!1),Ze(null),Ue(!1),Ge(null),vs()}catch(s){M.error(s instanceof Error?s.message:"삭제 중 오류가 발생했습니다.")}finally{Qe(!1),Ze(null)}},className:"bg-red-600 hover:bg-red-700",children:"삭제"})]})]})}),a.jsx(y,{open:es,onOpenChange:ss,children:a.jsx(j,{showCloseButton:!1,maxWidth:"sm:max-w-md",className:"p-0 overflow-hidden",children:a.jsxs("div",{className:"px-8 py-10 text-center",children:[a.jsx("div",{className:"text-xl font-semibold text-gray-900",children:"안내"}),a.jsx("div",{className:"mt-4 text-base text-gray-700 whitespace-pre-wrap",children:as}),a.jsx("div",{className:"mt-6 text-sm text-gray-400",children:"화면을 클릭하거나 ESC로 닫을 수 있습니다."})]})})})]})}export{te as default};
//# sourceMappingURL=SupportMain-BFt8e3xv.js.map
