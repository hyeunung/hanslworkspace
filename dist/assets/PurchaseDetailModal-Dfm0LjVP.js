import{e,r as t,R as n,a3 as a,j as r,B as i,c as s,l as c,a5 as o,a6 as l,a7 as d,a8 as u,a9 as m,d as p,u as h,t as _,X as g,a0 as v,x as f,a4 as x,P as b,aa as y,ab as w,s as N,g as j,ac as S,ad as q,ae as C}from"./index-DrqQlCVT.js";import{d as k,b as D}from"./helpers-CmqE03mo.js";import{C as I,k as M,D as $,f as R,S as E}from"./react-select.esm-DFCD9Rye.js";import{I as T,P as O,D as W,a as L,b as P,c as A}from"./dialog-fluIBauW.js";import{P as F,a as z,b as U,S as B}from"./popover-E2meXePq.js";import{T as K}from"./textarea-CHFRZlLk.js";import{S as V,a as H,b as Q,c as Y,d as X}from"./select-BQmBKrZL.js";import{t as J}from"./index-DGuzWzbi.js";import{C as G}from"./calendar-GTKHDdhM.js";import{C as Z}from"./check-DeHJinkF.js";import{C as ee}from"./credit-card-BB-Wxf8u.js";import{T as te}from"./card-L_k0GxTM.js";import{L as ne}from"./loader-circle-DkDjzmNZ.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ae=e("circle-check-big",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]),re=e("dollar-sign",[["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}],["path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6",key:"1b0p4s"}]]),ie=e("grip-vertical",[["circle",{cx:"9",cy:"12",r:"1",key:"1vctgf"}],["circle",{cx:"9",cy:"5",r:"1",key:"hp0tcf"}],["circle",{cx:"9",cy:"19",r:"1",key:"fkjjf6"}],["circle",{cx:"15",cy:"12",r:"1",key:"1tmaij"}],["circle",{cx:"15",cy:"5",r:"1",key:"19l28e"}],["circle",{cx:"15",cy:"19",r:"1",key:"f4zoj3"}]]),se=e("image",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]]),ce=e("message-square-plus",[["path",{d:"M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z",key:"18887p"}],["path",{d:"M12 8v6",key:"1ib9pf"}],["path",{d:"M9 11h6",key:"1fldmi"}]]),oe=e("pen",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]]),le=e("truck",[["path",{d:"M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2",key:"wrbu53"}],["path",{d:"M15 18H9",key:"1lyqi6"}],["path",{d:"M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14",key:"lysw3i"}],["circle",{cx:"17",cy:"18",r:"2",key:"332jqn"}],["circle",{cx:"7",cy:"18",r:"2",key:"19iecd"}]]);const de="undefined"!=typeof window&&void 0!==window.document&&void 0!==window.document.createElement;function ue(e){const t=Object.prototype.toString.call(e);return"[object Window]"===t||"[object global]"===t}function me(e){return"nodeType"in e}function pe(e){var t,n;return e?ue(e)?e:me(e)&&null!=(t=null==(n=e.ownerDocument)?void 0:n.defaultView)?t:window:window}function he(e){const{Document:t}=pe(e);return e instanceof t}function _e(e){return!ue(e)&&e instanceof pe(e).HTMLElement}function ge(e){return e instanceof pe(e).SVGElement}function ve(e){return e?ue(e)?e.document:me(e)?he(e)?e:_e(e)||ge(e)?e.ownerDocument:document:document:document}const fe=de?t.useLayoutEffect:t.useEffect;function xe(e){const n=t.useRef(e);return fe(()=>{n.current=e}),t.useCallback(function(){for(var e=arguments.length,t=new Array(e),a=0;a<e;a++)t[a]=arguments[a];return null==n.current?void 0:n.current(...t)},[])}function be(e,n){void 0===n&&(n=[e]);const a=t.useRef(e);return fe(()=>{a.current!==e&&(a.current=e)},n),a}function ye(e,n){const a=t.useRef();return t.useMemo(()=>{const t=e(a.current);return a.current=t,t},[...n])}function we(e){const n=xe(e),a=t.useRef(null),r=t.useCallback(e=>{e!==a.current&&(null==n||n(e,a.current)),a.current=e},[]);return[a,r]}function Ne(e){const n=t.useRef();return t.useEffect(()=>{n.current=e},[e]),n.current}let je={};function Se(e,n){return t.useMemo(()=>{if(n)return n;const t=null==je[e]?0:je[e]+1;return je[e]=t,e+"-"+t},[e,n])}function qe(e){return function(t){for(var n=arguments.length,a=new Array(n>1?n-1:0),r=1;r<n;r++)a[r-1]=arguments[r];return a.reduce((t,n)=>{const a=Object.entries(n);for(const[r,i]of a){const n=t[r];null!=n&&(t[r]=n+e*i)}return t},{...t})}}const Ce=qe(1),ke=qe(-1);function De(e){if(!e)return!1;const{KeyboardEvent:t}=pe(e.target);return t&&e instanceof t}function Ie(e){if(function(e){if(!e)return!1;const{TouchEvent:t}=pe(e.target);return t&&e instanceof t}(e)){if(e.touches&&e.touches.length){const{clientX:t,clientY:n}=e.touches[0];return{x:t,y:n}}if(e.changedTouches&&e.changedTouches.length){const{clientX:t,clientY:n}=e.changedTouches[0];return{x:t,y:n}}}return function(e){return"clientX"in e&&"clientY"in e}(e)?{x:e.clientX,y:e.clientY}:null}const Me=Object.freeze({Translate:{toString(e){if(!e)return;const{x:t,y:n}=e;return"translate3d("+(t?Math.round(t):0)+"px, "+(n?Math.round(n):0)+"px, 0)"}},Scale:{toString(e){if(!e)return;const{scaleX:t,scaleY:n}=e;return"scaleX("+t+") scaleY("+n+")"}},Transform:{toString(e){if(e)return[Me.Translate.toString(e),Me.Scale.toString(e)].join(" ")}},Transition:{toString(e){let{property:t,duration:n,easing:a}=e;return t+" "+n+"ms "+a}}}),$e="a,frame,iframe,input:not([type=hidden]):not(:disabled),select:not(:disabled),textarea:not(:disabled),button:not(:disabled),*[tabindex]";function Re(e){return e.matches($e)?e:e.querySelector($e)}const Ee={display:"none"};function Te(e){let{id:t,value:a}=e;return n.createElement("div",{id:t,style:Ee},a)}function Oe(e){let{id:t,announcement:a,ariaLiveType:r="assertive"}=e;return n.createElement("div",{id:t,style:{position:"fixed",top:0,left:0,width:1,height:1,margin:-1,border:0,padding:0,overflow:"hidden",clip:"rect(0 0 0 0)",clipPath:"inset(100%)",whiteSpace:"nowrap"},role:"status","aria-live":r,"aria-atomic":!0},a)}const We=t.createContext(null);const Le={draggable:"\n    To pick up a draggable item, press the space bar.\n    While dragging, use the arrow keys to move the item.\n    Press space again to drop the item in its new position, or press escape to cancel.\n  "},Pe={onDragStart(e){let{active:t}=e;return"Picked up draggable item "+t.id+"."},onDragOver(e){let{active:t,over:n}=e;return n?"Draggable item "+t.id+" was moved over droppable area "+n.id+".":"Draggable item "+t.id+" is no longer over a droppable area."},onDragEnd(e){let{active:t,over:n}=e;return n?"Draggable item "+t.id+" was dropped over droppable area "+n.id:"Draggable item "+t.id+" was dropped."},onDragCancel(e){let{active:t}=e;return"Dragging was cancelled. Draggable item "+t.id+" was dropped."}};function Ae(e){let{announcements:r=Pe,container:i,hiddenTextDescribedById:s,screenReaderInstructions:c=Le}=e;const{announce:o,announcement:l}=function(){const[e,n]=t.useState("");return{announce:t.useCallback(e=>{null!=e&&n(e)},[]),announcement:e}}(),d=Se("DndLiveRegion"),[u,m]=t.useState(!1);if(t.useEffect(()=>{m(!0)},[]),function(e){const n=t.useContext(We);t.useEffect(()=>{if(!n)throw new Error("useDndMonitor must be used within a children of <DndContext>");return n(e)},[e,n])}(t.useMemo(()=>({onDragStart(e){let{active:t}=e;o(r.onDragStart({active:t}))},onDragMove(e){let{active:t,over:n}=e;r.onDragMove&&o(r.onDragMove({active:t,over:n}))},onDragOver(e){let{active:t,over:n}=e;o(r.onDragOver({active:t,over:n}))},onDragEnd(e){let{active:t,over:n}=e;o(r.onDragEnd({active:t,over:n}))},onDragCancel(e){let{active:t,over:n}=e;o(r.onDragCancel({active:t,over:n}))}}),[o,r])),!u)return null;const p=n.createElement(n.Fragment,null,n.createElement(Te,{id:s,value:c.draggable}),n.createElement(Oe,{id:d,announcement:l}));return i?a.createPortal(p,i):p}var Fe,ze;function Ue(){}(ze=Fe||(Fe={})).DragStart="dragStart",ze.DragMove="dragMove",ze.DragEnd="dragEnd",ze.DragCancel="dragCancel",ze.DragOver="dragOver",ze.RegisterDroppable="registerDroppable",ze.SetDroppableDisabled="setDroppableDisabled",ze.UnregisterDroppable="unregisterDroppable";const Be=Object.freeze({x:0,y:0});function Ke(e,t){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}function Ve(e,t){let{data:{value:n}}=e,{data:{value:a}}=t;return n-a}function He(e,t){let{data:{value:n}}=e,{data:{value:a}}=t;return a-n}function Qe(e,t,n){return void 0===t&&(t=e.left),void 0===n&&(n=e.top),{x:t+.5*e.width,y:n+.5*e.height}}const Ye=e=>{let{collisionRect:t,droppableRects:n,droppableContainers:a}=e;const r=Qe(t,t.left,t.top),i=[];for(const s of a){const{id:e}=s,t=n.get(e);if(t){const n=Ke(Qe(t),r);i.push({id:e,data:{droppableContainer:s,value:n}})}}return i.sort(Ve)};function Xe(e,t){const n=Math.max(t.top,e.top),a=Math.max(t.left,e.left),r=Math.min(t.left+t.width,e.left+e.width),i=Math.min(t.top+t.height,e.top+e.height),s=r-a,c=i-n;if(a<r&&n<i){const n=t.width*t.height,a=e.width*e.height,r=s*c;return Number((r/(n+a-r)).toFixed(4))}return 0}const Je=e=>{let{collisionRect:t,droppableRects:n,droppableContainers:a}=e;const r=[];for(const i of a){const{id:e}=i,a=n.get(e);if(a){const n=Xe(a,t);n>0&&r.push({id:e,data:{droppableContainer:i,value:n}})}}return r.sort(He)};function Ge(e,t){return e&&t?{x:e.left-t.left,y:e.top-t.top}:Be}function Ze(e){return function(t){for(var n=arguments.length,a=new Array(n>1?n-1:0),r=1;r<n;r++)a[r-1]=arguments[r];return a.reduce((t,n)=>({...t,top:t.top+e*n.y,bottom:t.bottom+e*n.y,left:t.left+e*n.x,right:t.right+e*n.x}),{...t})}}const et=Ze(1);const tt={ignoreTransform:!1};function nt(e,t){void 0===t&&(t=tt);let n=e.getBoundingClientRect();if(t.ignoreTransform){const{transform:t,transformOrigin:a}=pe(e).getComputedStyle(e);t&&(n=function(e,t,n){const a=function(e){if(e.startsWith("matrix3d(")){const t=e.slice(9,-1).split(/, /);return{x:+t[12],y:+t[13],scaleX:+t[0],scaleY:+t[5]}}if(e.startsWith("matrix(")){const t=e.slice(7,-1).split(/, /);return{x:+t[4],y:+t[5],scaleX:+t[0],scaleY:+t[3]}}return null}(t);if(!a)return e;const{scaleX:r,scaleY:i,x:s,y:c}=a,o=e.left-s-(1-r)*parseFloat(n),l=e.top-c-(1-i)*parseFloat(n.slice(n.indexOf(" ")+1)),d=r?e.width/r:e.width,u=i?e.height/i:e.height;return{width:d,height:u,top:l,right:o+d,bottom:l+u,left:o}}(n,t,a))}const{top:a,left:r,width:i,height:s,bottom:c,right:o}=n;return{top:a,left:r,width:i,height:s,bottom:c,right:o}}function at(e){return nt(e,{ignoreTransform:!0})}function rt(e,t){const n=[];return e?function a(r){if(null!=t&&n.length>=t)return n;if(!r)return n;if(he(r)&&null!=r.scrollingElement&&!n.includes(r.scrollingElement))return n.push(r.scrollingElement),n;if(!_e(r)||ge(r))return n;if(n.includes(r))return n;const i=pe(e).getComputedStyle(r);return r!==e&&function(e,t){void 0===t&&(t=pe(e).getComputedStyle(e));const n=/(auto|scroll|overlay)/;return["overflow","overflowX","overflowY"].some(e=>{const a=t[e];return"string"==typeof a&&n.test(a)})}(r,i)&&n.push(r),function(e,t){return void 0===t&&(t=pe(e).getComputedStyle(e)),"fixed"===t.position}(r,i)?n:a(r.parentNode)}(e):n}function it(e){const[t]=rt(e,1);return null!=t?t:null}function st(e){return de&&e?ue(e)?e:me(e)?he(e)||e===ve(e).scrollingElement?window:_e(e)?e:null:null:null}function ct(e){return ue(e)?e.scrollX:e.scrollLeft}function ot(e){return ue(e)?e.scrollY:e.scrollTop}function lt(e){return{x:ct(e),y:ot(e)}}var dt,ut;function mt(e){return!(!de||!e)&&e===document.scrollingElement}function pt(e){const t={x:0,y:0},n=mt(e)?{height:window.innerHeight,width:window.innerWidth}:{height:e.clientHeight,width:e.clientWidth},a={x:e.scrollWidth-n.width,y:e.scrollHeight-n.height};return{isTop:e.scrollTop<=t.y,isLeft:e.scrollLeft<=t.x,isBottom:e.scrollTop>=a.y,isRight:e.scrollLeft>=a.x,maxScroll:a,minScroll:t}}(ut=dt||(dt={}))[ut.Forward=1]="Forward",ut[ut.Backward=-1]="Backward";const ht={x:.2,y:.2};function _t(e,t,n,a,r){let{top:i,left:s,right:c,bottom:o}=n;void 0===a&&(a=10),void 0===r&&(r=ht);const{isTop:l,isBottom:d,isLeft:u,isRight:m}=pt(e),p={x:0,y:0},h={x:0,y:0},_=t.height*r.y,g=t.width*r.x;return!l&&i<=t.top+_?(p.y=dt.Backward,h.y=a*Math.abs((t.top+_-i)/_)):!d&&o>=t.bottom-_&&(p.y=dt.Forward,h.y=a*Math.abs((t.bottom-_-o)/_)),!m&&c>=t.right-g?(p.x=dt.Forward,h.x=a*Math.abs((t.right-g-c)/g)):!u&&s<=t.left+g&&(p.x=dt.Backward,h.x=a*Math.abs((t.left+g-s)/g)),{direction:p,speed:h}}function gt(e){if(e===document.scrollingElement){const{innerWidth:e,innerHeight:t}=window;return{top:0,left:0,right:e,bottom:t,width:e,height:t}}const{top:t,left:n,right:a,bottom:r}=e.getBoundingClientRect();return{top:t,left:n,right:a,bottom:r,width:e.clientWidth,height:e.clientHeight}}function vt(e){return e.reduce((e,t)=>Ce(e,lt(t)),Be)}const ft=[["x",["left","right"],function(e){return e.reduce((e,t)=>e+ct(t),0)}],["y",["top","bottom"],function(e){return e.reduce((e,t)=>e+ot(t),0)}]];class xt{constructor(e,t){this.rect=void 0,this.width=void 0,this.height=void 0,this.top=void 0,this.bottom=void 0,this.right=void 0,this.left=void 0;const n=rt(t),a=vt(n);this.rect={...e},this.width=e.width,this.height=e.height;for(const[r,i,s]of ft)for(const e of i)Object.defineProperty(this,e,{get:()=>{const t=s(n),i=a[r]-t;return this.rect[e]+i},enumerable:!0});Object.defineProperty(this,"rect",{enumerable:!1})}}class bt{constructor(e){this.target=void 0,this.listeners=[],this.removeAll=()=>{this.listeners.forEach(e=>{var t;return null==(t=this.target)?void 0:t.removeEventListener(...e)})},this.target=e}add(e,t,n){var a;null==(a=this.target)||a.addEventListener(e,t,n),this.listeners.push([e,t,n])}}function yt(e,t){const n=Math.abs(e.x),a=Math.abs(e.y);return"number"==typeof t?Math.sqrt(n**2+a**2)>t:"x"in t&&"y"in t?n>t.x&&a>t.y:"x"in t?n>t.x:"y"in t&&a>t.y}var wt,Nt,jt,St;function qt(e){e.preventDefault()}function Ct(e){e.stopPropagation()}(Nt=wt||(wt={})).Click="click",Nt.DragStart="dragstart",Nt.Keydown="keydown",Nt.ContextMenu="contextmenu",Nt.Resize="resize",Nt.SelectionChange="selectionchange",Nt.VisibilityChange="visibilitychange",(St=jt||(jt={})).Space="Space",St.Down="ArrowDown",St.Right="ArrowRight",St.Left="ArrowLeft",St.Up="ArrowUp",St.Esc="Escape",St.Enter="Enter",St.Tab="Tab";const kt={start:[jt.Space,jt.Enter],cancel:[jt.Esc],end:[jt.Space,jt.Enter,jt.Tab]},Dt=(e,t)=>{let{currentCoordinates:n}=t;switch(e.code){case jt.Right:return{...n,x:n.x+25};case jt.Left:return{...n,x:n.x-25};case jt.Down:return{...n,y:n.y+25};case jt.Up:return{...n,y:n.y-25}}};class It{constructor(e){this.props=void 0,this.autoScrollEnabled=!1,this.referenceCoordinates=void 0,this.listeners=void 0,this.windowListeners=void 0,this.props=e;const{event:{target:t}}=e;this.props=e,this.listeners=new bt(ve(t)),this.windowListeners=new bt(pe(t)),this.handleKeyDown=this.handleKeyDown.bind(this),this.handleCancel=this.handleCancel.bind(this),this.attach()}attach(){this.handleStart(),this.windowListeners.add(wt.Resize,this.handleCancel),this.windowListeners.add(wt.VisibilityChange,this.handleCancel),setTimeout(()=>this.listeners.add(wt.Keydown,this.handleKeyDown))}handleStart(){const{activeNode:e,onStart:t}=this.props,n=e.node.current;n&&function(e,t){if(void 0===t&&(t=nt),!e)return;const{top:n,left:a,bottom:r,right:i}=t(e);it(e)&&(r<=0||i<=0||n>=window.innerHeight||a>=window.innerWidth)&&e.scrollIntoView({block:"center",inline:"center"})}(n),t(Be)}handleKeyDown(e){if(De(e)){const{active:t,context:n,options:a}=this.props,{keyboardCodes:r=kt,coordinateGetter:i=Dt,scrollBehavior:s="smooth"}=a,{code:c}=e;if(r.end.includes(c))return void this.handleEnd(e);if(r.cancel.includes(c))return void this.handleCancel(e);const{collisionRect:o}=n.current,l=o?{x:o.left,y:o.top}:Be;this.referenceCoordinates||(this.referenceCoordinates=l);const d=i(e,{active:t,context:n.current,currentCoordinates:l});if(d){const t=ke(d,l),a={x:0,y:0},{scrollableAncestors:r}=n.current;for(const n of r){const r=e.code,{isTop:i,isRight:c,isLeft:o,isBottom:l,maxScroll:u,minScroll:m}=pt(n),p=gt(n),h={x:Math.min(r===jt.Right?p.right-p.width/2:p.right,Math.max(r===jt.Right?p.left:p.left+p.width/2,d.x)),y:Math.min(r===jt.Down?p.bottom-p.height/2:p.bottom,Math.max(r===jt.Down?p.top:p.top+p.height/2,d.y))},_=r===jt.Right&&!c||r===jt.Left&&!o,g=r===jt.Down&&!l||r===jt.Up&&!i;if(_&&h.x!==d.x){const e=n.scrollLeft+t.x,i=r===jt.Right&&e<=u.x||r===jt.Left&&e>=m.x;if(i&&!t.y)return void n.scrollTo({left:e,behavior:s});a.x=i?n.scrollLeft-e:r===jt.Right?n.scrollLeft-u.x:n.scrollLeft-m.x,a.x&&n.scrollBy({left:-a.x,behavior:s});break}if(g&&h.y!==d.y){const e=n.scrollTop+t.y,i=r===jt.Down&&e<=u.y||r===jt.Up&&e>=m.y;if(i&&!t.x)return void n.scrollTo({top:e,behavior:s});a.y=i?n.scrollTop-e:r===jt.Down?n.scrollTop-u.y:n.scrollTop-m.y,a.y&&n.scrollBy({top:-a.y,behavior:s});break}}this.handleMove(e,Ce(ke(d,this.referenceCoordinates),a))}}}handleMove(e,t){const{onMove:n}=this.props;e.preventDefault(),n(t)}handleEnd(e){const{onEnd:t}=this.props;e.preventDefault(),this.detach(),t()}handleCancel(e){const{onCancel:t}=this.props;e.preventDefault(),this.detach(),t()}detach(){this.listeners.removeAll(),this.windowListeners.removeAll()}}function Mt(e){return Boolean(e&&"distance"in e)}function $t(e){return Boolean(e&&"delay"in e)}It.activators=[{eventName:"onKeyDown",handler:(e,t,n)=>{let{keyboardCodes:a=kt,onActivation:r}=t,{active:i}=n;const{code:s}=e.nativeEvent;if(a.start.includes(s)){const t=i.activatorNode.current;return(!t||e.target===t)&&(e.preventDefault(),null==r||r({event:e.nativeEvent}),!0)}return!1}}];class Rt{constructor(e,t,n){var a;void 0===n&&(n=function(e){const{EventTarget:t}=pe(e);return e instanceof t?e:ve(e)}(e.event.target)),this.props=void 0,this.events=void 0,this.autoScrollEnabled=!0,this.document=void 0,this.activated=!1,this.initialCoordinates=void 0,this.timeoutId=null,this.listeners=void 0,this.documentListeners=void 0,this.windowListeners=void 0,this.props=e,this.events=t;const{event:r}=e,{target:i}=r;this.props=e,this.events=t,this.document=ve(i),this.documentListeners=new bt(this.document),this.listeners=new bt(n),this.windowListeners=new bt(pe(i)),this.initialCoordinates=null!=(a=Ie(r))?a:Be,this.handleStart=this.handleStart.bind(this),this.handleMove=this.handleMove.bind(this),this.handleEnd=this.handleEnd.bind(this),this.handleCancel=this.handleCancel.bind(this),this.handleKeydown=this.handleKeydown.bind(this),this.removeTextSelection=this.removeTextSelection.bind(this),this.attach()}attach(){const{events:e,props:{options:{activationConstraint:t,bypassActivationConstraint:n}}}=this;if(this.listeners.add(e.move.name,this.handleMove,{passive:!1}),this.listeners.add(e.end.name,this.handleEnd),e.cancel&&this.listeners.add(e.cancel.name,this.handleCancel),this.windowListeners.add(wt.Resize,this.handleCancel),this.windowListeners.add(wt.DragStart,qt),this.windowListeners.add(wt.VisibilityChange,this.handleCancel),this.windowListeners.add(wt.ContextMenu,qt),this.documentListeners.add(wt.Keydown,this.handleKeydown),t){if(null!=n&&n({event:this.props.event,activeNode:this.props.activeNode,options:this.props.options}))return this.handleStart();if($t(t))return this.timeoutId=setTimeout(this.handleStart,t.delay),void this.handlePending(t);if(Mt(t))return void this.handlePending(t)}this.handleStart()}detach(){this.listeners.removeAll(),this.windowListeners.removeAll(),setTimeout(this.documentListeners.removeAll,50),null!==this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}handlePending(e,t){const{active:n,onPending:a}=this.props;a(n,e,this.initialCoordinates,t)}handleStart(){const{initialCoordinates:e}=this,{onStart:t}=this.props;e&&(this.activated=!0,this.documentListeners.add(wt.Click,Ct,{capture:!0}),this.removeTextSelection(),this.documentListeners.add(wt.SelectionChange,this.removeTextSelection),t(e))}handleMove(e){var t;const{activated:n,initialCoordinates:a,props:r}=this,{onMove:i,options:{activationConstraint:s}}=r;if(!a)return;const c=null!=(t=Ie(e))?t:Be,o=ke(a,c);if(!n&&s){if(Mt(s)){if(null!=s.tolerance&&yt(o,s.tolerance))return this.handleCancel();if(yt(o,s.distance))return this.handleStart()}return $t(s)&&yt(o,s.tolerance)?this.handleCancel():void this.handlePending(s,o)}e.cancelable&&e.preventDefault(),i(c)}handleEnd(){const{onAbort:e,onEnd:t}=this.props;this.detach(),this.activated||e(this.props.active),t()}handleCancel(){const{onAbort:e,onCancel:t}=this.props;this.detach(),this.activated||e(this.props.active),t()}handleKeydown(e){e.code===jt.Esc&&this.handleCancel()}removeTextSelection(){var e;null==(e=this.document.getSelection())||e.removeAllRanges()}}const Et={cancel:{name:"pointercancel"},move:{name:"pointermove"},end:{name:"pointerup"}};class Tt extends Rt{constructor(e){const{event:t}=e,n=ve(t.target);super(e,Et,n)}}Tt.activators=[{eventName:"onPointerDown",handler:(e,t)=>{let{nativeEvent:n}=e,{onActivation:a}=t;return!(!n.isPrimary||0!==n.button)&&(null==a||a({event:n}),!0)}}];const Ot={move:{name:"mousemove"},end:{name:"mouseup"}};var Wt,Lt;(Lt=Wt||(Wt={}))[Lt.RightClick=2]="RightClick";(class extends Rt{constructor(e){super(e,Ot,ve(e.event.target))}}).activators=[{eventName:"onMouseDown",handler:(e,t)=>{let{nativeEvent:n}=e,{onActivation:a}=t;return n.button!==Wt.RightClick&&(null==a||a({event:n}),!0)}}];const Pt={cancel:{name:"touchcancel"},move:{name:"touchmove"},end:{name:"touchend"}};var At,Ft,zt,Ut;function Bt(e){let{acceleration:n,activator:a=At.Pointer,canScroll:r,draggingRect:i,enabled:s,interval:c=5,order:o=zt.TreeOrder,pointerCoordinates:l,scrollableAncestors:d,scrollableAncestorRects:u,delta:m,threshold:p}=e;const h=function(e){let{delta:t,disabled:n}=e;const a=Ne(t);return ye(e=>{if(n||!a||!e)return Kt;const r={x:Math.sign(t.x-a.x),y:Math.sign(t.y-a.y)};return{x:{[dt.Backward]:e.x[dt.Backward]||-1===r.x,[dt.Forward]:e.x[dt.Forward]||1===r.x},y:{[dt.Backward]:e.y[dt.Backward]||-1===r.y,[dt.Forward]:e.y[dt.Forward]||1===r.y}}},[n,t,a])}({delta:m,disabled:!s}),[_,g]=function(){const e=t.useRef(null);return[t.useCallback((t,n)=>{e.current=setInterval(t,n)},[]),t.useCallback(()=>{null!==e.current&&(clearInterval(e.current),e.current=null)},[])]}(),v=t.useRef({x:0,y:0}),f=t.useRef({x:0,y:0}),x=t.useMemo(()=>{switch(a){case At.Pointer:return l?{top:l.y,bottom:l.y,left:l.x,right:l.x}:null;case At.DraggableRect:return i}},[a,i,l]),b=t.useRef(null),y=t.useCallback(()=>{const e=b.current;if(!e)return;const t=v.current.x*f.current.x,n=v.current.y*f.current.y;e.scrollBy(t,n)},[]),w=t.useMemo(()=>o===zt.TreeOrder?[...d].reverse():d,[o,d]);t.useEffect(()=>{if(s&&d.length&&x){for(const e of w){if(!1===(null==r?void 0:r(e)))continue;const t=d.indexOf(e),a=u[t];if(!a)continue;const{direction:i,speed:s}=_t(e,a,x,n,p);for(const e of["x","y"])h[e][i[e]]||(s[e]=0,i[e]=0);if(s.x>0||s.y>0)return g(),b.current=e,_(y,c),v.current=s,void(f.current=i)}v.current={x:0,y:0},f.current={x:0,y:0},g()}else g()},[n,y,r,g,s,c,JSON.stringify(x),JSON.stringify(h),_,d,w,u,JSON.stringify(p)])}(class extends Rt{constructor(e){super(e,Pt)}static setup(){return window.addEventListener(Pt.move.name,e,{capture:!1,passive:!1}),function(){window.removeEventListener(Pt.move.name,e)};function e(){}}}).activators=[{eventName:"onTouchStart",handler:(e,t)=>{let{nativeEvent:n}=e,{onActivation:a}=t;const{touches:r}=n;return!(r.length>1)&&(null==a||a({event:n}),!0)}}],(Ft=At||(At={}))[Ft.Pointer=0]="Pointer",Ft[Ft.DraggableRect=1]="DraggableRect",(Ut=zt||(zt={}))[Ut.TreeOrder=0]="TreeOrder",Ut[Ut.ReversedTreeOrder=1]="ReversedTreeOrder";const Kt={x:{[dt.Backward]:!1,[dt.Forward]:!1},y:{[dt.Backward]:!1,[dt.Forward]:!1}};var Vt,Ht,Qt;(Ht=Vt||(Vt={}))[Ht.Always=0]="Always",Ht[Ht.BeforeDragging=1]="BeforeDragging",Ht[Ht.WhileDragging=2]="WhileDragging",(Qt||(Qt={})).Optimized="optimized";const Yt=new Map;function Xt(e,t){return ye(n=>e?n||("function"==typeof t?t(e):e):null,[t,e])}function Jt(e){let{callback:n,disabled:a}=e;const r=xe(n),i=t.useMemo(()=>{if(a||"undefined"==typeof window||void 0===window.ResizeObserver)return;const{ResizeObserver:e}=window;return new e(r)},[a]);return t.useEffect(()=>()=>null==i?void 0:i.disconnect(),[i]),i}function Gt(e){return new xt(nt(e),e)}function Zt(e,n,a){void 0===n&&(n=Gt);const[r,i]=t.useState(null);function s(){i(t=>{if(!e)return null;var r;if(!1===e.isConnected)return null!=(r=null!=t?t:a)?r:null;const i=n(e);return JSON.stringify(t)===JSON.stringify(i)?t:i})}const c=function(e){let{callback:n,disabled:a}=e;const r=xe(n),i=t.useMemo(()=>{if(a||"undefined"==typeof window||void 0===window.MutationObserver)return;const{MutationObserver:e}=window;return new e(r)},[r,a]);return t.useEffect(()=>()=>null==i?void 0:i.disconnect(),[i]),i}({callback(t){if(e)for(const n of t){const{type:t,target:a}=n;if("childList"===t&&a instanceof HTMLElement&&a.contains(e)){s();break}}}}),o=Jt({callback:s});return fe(()=>{s(),e?(null==o||o.observe(e),null==c||c.observe(document.body,{childList:!0,subtree:!0})):(null==o||o.disconnect(),null==c||c.disconnect())},[e]),r}const en=[];function tn(e,n){void 0===n&&(n=[]);const a=t.useRef(null);return t.useEffect(()=>{a.current=null},n),t.useEffect(()=>{const t=e!==Be;t&&!a.current&&(a.current=e),!t&&a.current&&(a.current=null)},[e]),a.current?ke(e,a.current):Be}function nn(e){return t.useMemo(()=>e?function(e){const t=e.innerWidth,n=e.innerHeight;return{top:0,left:0,right:t,bottom:n,width:t,height:n}}(e):null,[e])}const an=[];function rn(e){let{measure:n}=e;const[a,r]=t.useState(null),i=Jt({callback:t.useCallback(e=>{for(const{target:t}of e)if(_e(t)){r(e=>{const a=n(t);return e?{...e,width:a.width,height:a.height}:a});break}},[n])}),s=t.useCallback(e=>{const t=function(e){if(!e)return null;if(e.children.length>1)return e;const t=e.children[0];return _e(t)?t:e}(e);null==i||i.disconnect(),t&&(null==i||i.observe(t)),r(t?n(t):null)},[n,i]),[c,o]=we(s);return t.useMemo(()=>({nodeRef:c,rect:a,setRef:o}),[a,c,o])}const sn=[{sensor:Tt,options:{}},{sensor:It,options:{}}],cn={current:{}},on={draggable:{measure:at},droppable:{measure:at,strategy:Vt.WhileDragging,frequency:Qt.Optimized},dragOverlay:{measure:nt}};class ln extends Map{get(e){var t;return null!=e&&null!=(t=super.get(e))?t:void 0}toArray(){return Array.from(this.values())}getEnabled(){return this.toArray().filter(e=>{let{disabled:t}=e;return!t})}getNodeFor(e){var t,n;return null!=(t=null==(n=this.get(e))?void 0:n.node.current)?t:void 0}}const dn={activatorEvent:null,active:null,activeNode:null,activeNodeRect:null,collisions:null,containerNodeRect:null,draggableNodes:new Map,droppableRects:new Map,droppableContainers:new ln,over:null,dragOverlay:{nodeRef:{current:null},rect:null,setRef:Ue},scrollableAncestors:[],scrollableAncestorRects:[],measuringConfiguration:on,measureDroppableContainers:Ue,windowRect:null,measuringScheduled:!1},un={activatorEvent:null,activators:[],active:null,activeNodeRect:null,ariaDescribedById:{draggable:""},dispatch:Ue,draggableNodes:new Map,over:null,measureDroppableContainers:Ue},mn=t.createContext(un),pn=t.createContext(dn);function hn(){return{draggable:{active:null,initialCoordinates:{x:0,y:0},nodes:new Map,translate:{x:0,y:0}},droppable:{containers:new ln}}}function _n(e,t){switch(t.type){case Fe.DragStart:return{...e,draggable:{...e.draggable,initialCoordinates:t.initialCoordinates,active:t.active}};case Fe.DragMove:return null==e.draggable.active?e:{...e,draggable:{...e.draggable,translate:{x:t.coordinates.x-e.draggable.initialCoordinates.x,y:t.coordinates.y-e.draggable.initialCoordinates.y}}};case Fe.DragEnd:case Fe.DragCancel:return{...e,draggable:{...e.draggable,active:null,initialCoordinates:{x:0,y:0},translate:{x:0,y:0}}};case Fe.RegisterDroppable:{const{element:n}=t,{id:a}=n,r=new ln(e.droppable.containers);return r.set(a,n),{...e,droppable:{...e.droppable,containers:r}}}case Fe.SetDroppableDisabled:{const{id:n,key:a,disabled:r}=t,i=e.droppable.containers.get(n);if(!i||a!==i.key)return e;const s=new ln(e.droppable.containers);return s.set(n,{...i,disabled:r}),{...e,droppable:{...e.droppable,containers:s}}}case Fe.UnregisterDroppable:{const{id:n,key:a}=t,r=e.droppable.containers.get(n);if(!r||a!==r.key)return e;const i=new ln(e.droppable.containers);return i.delete(n),{...e,droppable:{...e.droppable,containers:i}}}default:return e}}function gn(e){let{disabled:n}=e;const{active:a,activatorEvent:r,draggableNodes:i}=t.useContext(mn),s=Ne(r),c=Ne(null==a?void 0:a.id);return t.useEffect(()=>{if(!n&&!r&&s&&null!=c){if(!De(s))return;if(document.activeElement===s.target)return;const e=i.get(c);if(!e)return;const{activatorNode:t,node:n}=e;if(!t.current&&!n.current)return;requestAnimationFrame(()=>{for(const e of[t.current,n.current]){if(!e)continue;const t=Re(e);if(t){t.focus();break}}})}},[r,n,i,c,s]),null}const vn=t.createContext({...Be,scaleX:1,scaleY:1});var fn,xn;(xn=fn||(fn={}))[xn.Uninitialized=0]="Uninitialized",xn[xn.Initializing=1]="Initializing",xn[xn.Initialized=2]="Initialized";const bn=t.memo(function(e){var r,i,s,c;let{id:o,accessibility:l,autoScroll:d=!0,children:u,sensors:m=sn,collisionDetection:p=Je,measuring:h,modifiers:_,...g}=e;const v=t.useReducer(_n,void 0,hn),[f,x]=v,[b,y]=function(){const[e]=t.useState(()=>new Set),n=t.useCallback(t=>(e.add(t),()=>e.delete(t)),[e]);return[t.useCallback(t=>{let{type:n,event:a}=t;e.forEach(e=>{var t;return null==(t=e[n])?void 0:t.call(e,a)})},[e]),n]}(),[w,N]=t.useState(fn.Uninitialized),j=w===fn.Initialized,{draggable:{active:S,nodes:q,translate:C},droppable:{containers:k}}=f,D=null!=S?q.get(S):null,I=t.useRef({initial:null,translated:null}),M=t.useMemo(()=>{var e;return null!=S?{id:S,data:null!=(e=null==D?void 0:D.data)?e:cn,rect:I}:null},[S,D]),$=t.useRef(null),[R,E]=t.useState(null),[T,O]=t.useState(null),W=be(g,Object.values(g)),L=Se("DndDescribedBy",o),P=t.useMemo(()=>k.getEnabled(),[k]),A=(F=h,t.useMemo(()=>({draggable:{...on.draggable,...null==F?void 0:F.draggable},droppable:{...on.droppable,...null==F?void 0:F.droppable},dragOverlay:{...on.dragOverlay,...null==F?void 0:F.dragOverlay}}),[null==F?void 0:F.draggable,null==F?void 0:F.droppable,null==F?void 0:F.dragOverlay]));var F;const{droppableRects:z,measureDroppableContainers:U,measuringScheduled:B}=function(e,n){let{dragging:a,dependencies:r,config:i}=n;const[s,c]=t.useState(null),{frequency:o,measure:l,strategy:d}=i,u=t.useRef(e),m=function(){switch(d){case Vt.Always:return!1;case Vt.BeforeDragging:return a;default:return!a}}(),p=be(m),h=t.useCallback(function(e){void 0===e&&(e=[]),p.current||c(t=>null===t?e:t.concat(e.filter(e=>!t.includes(e))))},[p]),_=t.useRef(null),g=ye(t=>{if(m&&!a)return Yt;if(!t||t===Yt||u.current!==e||null!=s){const t=new Map;for(let n of e){if(!n)continue;if(s&&s.length>0&&!s.includes(n.id)&&n.rect.current){t.set(n.id,n.rect.current);continue}const e=n.node.current,a=e?new xt(l(e),e):null;n.rect.current=a,a&&t.set(n.id,a)}return t}return t},[e,s,a,m,l]);return t.useEffect(()=>{u.current=e},[e]),t.useEffect(()=>{m||h()},[a,m]),t.useEffect(()=>{s&&s.length>0&&c(null)},[JSON.stringify(s)]),t.useEffect(()=>{m||"number"!=typeof o||null!==_.current||(_.current=setTimeout(()=>{h(),_.current=null},o))},[o,m,h,...r]),{droppableRects:g,measureDroppableContainers:h,measuringScheduled:null!=s}}(P,{dragging:j,dependencies:[C.x,C.y],config:A.droppable}),K=function(e,t){const n=null!=t?e.get(t):void 0,a=n?n.node.current:null;return ye(e=>{var n;return null==t?null:null!=(n=null!=a?a:e)?n:null},[a,t])}(q,S),V=t.useMemo(()=>T?Ie(T):null,[T]),H=function(){const e=!1===(null==R?void 0:R.autoScrollEnabled),t="object"==typeof d?!1===d.enabled:!1===d,n=j&&!e&&!t;if("object"==typeof d)return{...d,enabled:n};return{enabled:n}}(),Q=function(e,t){return Xt(e,t)}(K,A.draggable.measure);!function(e){let{activeNode:n,measure:a,initialRect:r,config:i=!0}=e;const s=t.useRef(!1),{x:c,y:o}="boolean"==typeof i?{x:i,y:i}:i;fe(()=>{if(!c&&!o||!n)return void(s.current=!1);if(s.current||!r)return;const e=null==n?void 0:n.node.current;if(!e||!1===e.isConnected)return;const t=Ge(a(e),r);if(c||(t.x=0),o||(t.y=0),s.current=!0,Math.abs(t.x)>0||Math.abs(t.y)>0){const n=it(e);n&&n.scrollBy({top:t.y,left:t.x})}},[n,c,o,r,a])}({activeNode:null!=S?q.get(S):null,config:H.layoutShiftCompensation,initialRect:Q,measure:A.draggable.measure});const Y=Zt(K,A.draggable.measure,Q),X=Zt(K?K.parentElement:null),J=t.useRef({activatorEvent:null,active:null,activeNode:K,collisionRect:null,collisions:null,droppableRects:z,draggableNodes:q,draggingNode:null,draggingNodeRect:null,droppableContainers:k,over:null,scrollableAncestors:[],scrollAdjustedTranslate:null}),G=k.getNodeFor(null==(r=J.current.over)?void 0:r.id),Z=rn({measure:A.dragOverlay.measure}),ee=null!=(i=Z.nodeRef.current)?i:K,te=j?null!=(s=Z.rect)?s:Y:null,ne=Boolean(Z.nodeRef.current&&Z.rect),ae=Ge(re=ne?null:Y,Xt(re));var re;const ie=nn(ee?pe(ee):null),se=function(e){const n=t.useRef(e),a=ye(t=>e?t&&t!==en&&e&&n.current&&e.parentNode===n.current.parentNode?t:rt(e):en,[e]);return t.useEffect(()=>{n.current=e},[e]),a}(j?null!=G?G:K:null),ce=function(e,n){void 0===n&&(n=nt);const[a]=e,r=nn(a?pe(a):null),[i,s]=t.useState(an);function c(){s(()=>e.length?e.map(e=>mt(e)?r:new xt(n(e),e)):an)}const o=Jt({callback:c});return fe(()=>{null==o||o.disconnect(),c(),e.forEach(e=>null==o?void 0:o.observe(e))},[e]),i}(se),oe=function(e,t){let{transform:n,...a}=t;return null!=e&&e.length?e.reduce((e,t)=>t({transform:e,...a}),n):n}(_,{transform:{x:C.x-ae.x,y:C.y-ae.y,scaleX:1,scaleY:1},activatorEvent:T,active:M,activeNodeRect:Y,containerNodeRect:X,draggingNodeRect:te,over:J.current.over,overlayNodeRect:Z.rect,scrollableAncestors:se,scrollableAncestorRects:ce,windowRect:ie}),le=V?Ce(V,C):null,ue=function(e){const[n,a]=t.useState(null),r=t.useRef(e),i=t.useCallback(e=>{const t=st(e.target);t&&a(e=>e?(e.set(t,lt(t)),new Map(e)):null)},[]);return t.useEffect(()=>{const t=r.current;if(e!==t){n(t);const s=e.map(e=>{const t=st(e);return t?(t.addEventListener("scroll",i,{passive:!0}),[t,lt(t)]):null}).filter(e=>null!=e);a(s.length?new Map(s):null),r.current=e}return()=>{n(e),n(t)};function n(e){e.forEach(e=>{const t=st(e);null==t||t.removeEventListener("scroll",i)})}},[i,e]),t.useMemo(()=>e.length?n?Array.from(n.values()).reduce((e,t)=>Ce(e,t),Be):vt(e):Be,[e,n])}(se),me=tn(ue),he=tn(ue,[Y]),_e=Ce(oe,me),ge=te?et(te,oe):null,ve=M&&ge?p({active:M,collisionRect:ge,droppableRects:z,droppableContainers:P,pointerCoordinates:le}):null,xe=function(e,t){if(!e||0===e.length)return null;const[n]=e;return n[t]}(ve,"id"),[we,Ne]=t.useState(null),je=function(e,t,n){return{...e,scaleX:t&&n?t.width/n.width:1,scaleY:t&&n?t.height/n.height:1}}(ne?oe:Ce(oe,he),null!=(c=null==we?void 0:we.rect)?c:null,Y),qe=t.useRef(null),ke=t.useCallback((e,t)=>{let{sensor:n,options:r}=t;if(null==$.current)return;const i=q.get($.current);if(!i)return;const s=e.nativeEvent,c=new n({active:$.current,activeNode:i,event:s,options:r,context:J,onAbort(e){if(!q.get(e))return;const{onDragAbort:t}=W.current,n={id:e};null==t||t(n),b({type:"onDragAbort",event:n})},onPending(e,t,n,a){if(!q.get(e))return;const{onDragPending:r}=W.current,i={id:e,constraint:t,initialCoordinates:n,offset:a};null==r||r(i),b({type:"onDragPending",event:i})},onStart(e){const t=$.current;if(null==t)return;const n=q.get(t);if(!n)return;const{onDragStart:r}=W.current,i={activatorEvent:s,active:{id:t,data:n.data,rect:I}};a.unstable_batchedUpdates(()=>{null==r||r(i),N(fn.Initializing),x({type:Fe.DragStart,initialCoordinates:e,active:t}),b({type:"onDragStart",event:i}),E(qe.current),O(s)})},onMove(e){x({type:Fe.DragMove,coordinates:e})},onEnd:o(Fe.DragEnd),onCancel:o(Fe.DragCancel)});function o(e){return async function(){const{active:t,collisions:n,over:r,scrollAdjustedTranslate:i}=J.current;let c=null;if(t&&i){const{cancelDrop:a}=W.current;if(c={activatorEvent:s,active:t,collisions:n,delta:i,over:r},e===Fe.DragEnd&&"function"==typeof a){await Promise.resolve(a(c))&&(e=Fe.DragCancel)}}$.current=null,a.unstable_batchedUpdates(()=>{x({type:e}),N(fn.Uninitialized),Ne(null),E(null),O(null),qe.current=null;const t=e===Fe.DragEnd?"onDragEnd":"onDragCancel";if(c){const e=W.current[t];null==e||e(c),b({type:t,event:c})}})}}qe.current=c},[q]),De=function(e,n){return t.useMemo(()=>e.reduce((e,t)=>{const{sensor:a}=t;return[...e,...a.activators.map(e=>({eventName:e.eventName,handler:n(e.handler,t)}))]},[]),[e,n])}(m,t.useCallback((e,t)=>(n,a)=>{const r=n.nativeEvent,i=q.get(a);if(null!==$.current||!i||r.dndKit||r.defaultPrevented)return;const s={active:i};!0===e(n,t.options,s)&&(r.dndKit={capturedBy:t.sensor},$.current=a,ke(n,t))},[q,ke]));!function(e){t.useEffect(()=>{if(!de)return;const t=e.map(e=>{let{sensor:t}=e;return null==t.setup?void 0:t.setup()});return()=>{for(const e of t)null==e||e()}},e.map(e=>{let{sensor:t}=e;return t}))}(m),fe(()=>{Y&&w===fn.Initializing&&N(fn.Initialized)},[Y,w]),t.useEffect(()=>{const{onDragMove:e}=W.current,{active:t,activatorEvent:n,collisions:r,over:i}=J.current;if(!t||!n)return;const s={active:t,activatorEvent:n,collisions:r,delta:{x:_e.x,y:_e.y},over:i};a.unstable_batchedUpdates(()=>{null==e||e(s),b({type:"onDragMove",event:s})})},[_e.x,_e.y]),t.useEffect(()=>{const{active:e,activatorEvent:t,collisions:n,droppableContainers:r,scrollAdjustedTranslate:i}=J.current;if(!e||null==$.current||!t||!i)return;const{onDragOver:s}=W.current,c=r.get(xe),o=c&&c.rect.current?{id:c.id,rect:c.rect.current,data:c.data,disabled:c.disabled}:null,l={active:e,activatorEvent:t,collisions:n,delta:{x:i.x,y:i.y},over:o};a.unstable_batchedUpdates(()=>{Ne(o),null==s||s(l),b({type:"onDragOver",event:l})})},[xe]),fe(()=>{J.current={activatorEvent:T,active:M,activeNode:K,collisionRect:ge,collisions:ve,droppableRects:z,draggableNodes:q,draggingNode:ee,draggingNodeRect:te,droppableContainers:k,over:we,scrollableAncestors:se,scrollAdjustedTranslate:_e},I.current={initial:te,translated:ge}},[M,K,ve,ge,q,ee,te,z,k,we,se,_e]),Bt({...H,delta:C,draggingRect:ge,pointerCoordinates:le,scrollableAncestors:se,scrollableAncestorRects:ce});const Me=t.useMemo(()=>({active:M,activeNode:K,activeNodeRect:Y,activatorEvent:T,collisions:ve,containerNodeRect:X,dragOverlay:Z,draggableNodes:q,droppableContainers:k,droppableRects:z,over:we,measureDroppableContainers:U,scrollableAncestors:se,scrollableAncestorRects:ce,measuringConfiguration:A,measuringScheduled:B,windowRect:ie}),[M,K,Y,T,ve,X,Z,q,k,z,we,U,se,ce,A,B,ie]),$e=t.useMemo(()=>({activatorEvent:T,activators:De,active:M,activeNodeRect:Y,ariaDescribedById:{draggable:L},dispatch:x,draggableNodes:q,over:we,measureDroppableContainers:U}),[T,De,M,Y,x,L,q,we,U]);return n.createElement(We.Provider,{value:y},n.createElement(mn.Provider,{value:$e},n.createElement(pn.Provider,{value:Me},n.createElement(vn.Provider,{value:je},u)),n.createElement(gn,{disabled:!1===(null==l?void 0:l.restoreFocus)})),n.createElement(Ae,{...l,hiddenTextDescribedById:L}))}),yn=t.createContext(null),wn="button";function Nn(e){let{id:n,data:a,disabled:r=!1,attributes:i}=e;const s=Se("Draggable"),{activators:c,activatorEvent:o,active:l,activeNodeRect:d,ariaDescribedById:u,draggableNodes:m,over:p}=t.useContext(mn),{role:h=wn,roleDescription:_="draggable",tabIndex:g=0}=null!=i?i:{},v=(null==l?void 0:l.id)===n,f=t.useContext(v?vn:yn),[x,b]=we(),[y,w]=we(),N=function(e,n){return t.useMemo(()=>e.reduce((e,t)=>{let{eventName:a,handler:r}=t;return e[a]=e=>{r(e,n)},e},{}),[e,n])}(c,n),j=be(a);fe(()=>(m.set(n,{id:n,key:s,node:x,activatorNode:y,data:j}),()=>{const e=m.get(n);e&&e.key===s&&m.delete(n)}),[m,n]);return{active:l,activatorEvent:o,activeNodeRect:d,attributes:t.useMemo(()=>({role:h,tabIndex:g,"aria-disabled":r,"aria-pressed":!(!v||h!==wn)||void 0,"aria-roledescription":_,"aria-describedby":u.draggable}),[r,h,g,v,_,u.draggable]),isDragging:v,listeners:r?void 0:N,node:x,over:p,setNodeRef:b,setActivatorNodeRef:w,transform:f}}const jn={timeout:25};function Sn(e,t,n){const a=e.slice();return a.splice(n<0?a.length+n:n,0,a.splice(t,1)[0]),a}function qn(e,t){return e.reduce((e,n,a)=>{const r=t.get(n);return r&&(e[a]=r),e},Array(e.length))}function Cn(e){return null!==e&&e>=0}const kn=e=>{let{rects:t,activeIndex:n,overIndex:a,index:r}=e;const i=Sn(t,a,n),s=t[r],c=i[r];return c&&s?{x:c.left-s.left,y:c.top-s.top,scaleX:c.width/s.width,scaleY:c.height/s.height}:null},Dn={scaleX:1,scaleY:1},In=e=>{var t;let{activeIndex:n,activeNodeRect:a,index:r,rects:i,overIndex:s}=e;const c=null!=(t=i[n])?t:a;if(!c)return null;if(r===n){const e=i[s];return e?{x:0,y:n<s?e.top+e.height-(c.top+c.height):e.top-c.top,...Dn}:null}const o=function(e,t,n){const a=e[t],r=e[t-1],i=e[t+1];if(!a)return 0;if(n<t)return r?a.top-(r.top+r.height):i?i.top-(a.top+a.height):0;return i?i.top-(a.top+a.height):r?a.top-(r.top+r.height):0}(i,r,n);return r>n&&r<=s?{x:0,y:-c.height-o,...Dn}:r<n&&r>=s?{x:0,y:c.height+o,...Dn}:{x:0,y:0,...Dn}};const Mn="Sortable",$n=n.createContext({activeIndex:-1,containerId:Mn,disableTransforms:!1,items:[],overIndex:-1,useDragOverlay:!1,sortedRects:[],strategy:kn,disabled:{draggable:!1,droppable:!1}});function Rn(e){let{children:a,id:r,items:i,strategy:s=kn,disabled:c=!1}=e;const{active:o,dragOverlay:l,droppableRects:d,over:u,measureDroppableContainers:m}=t.useContext(pn),p=Se(Mn,r),h=Boolean(null!==l.rect),_=t.useMemo(()=>i.map(e=>"object"==typeof e&&"id"in e?e.id:e),[i]),g=null!=o,v=o?_.indexOf(o.id):-1,f=u?_.indexOf(u.id):-1,x=t.useRef(_),b=!function(e,t){if(e===t)return!0;if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}(_,x.current),y=-1!==f&&-1===v||b,w=function(e){return"boolean"==typeof e?{draggable:e,droppable:e}:e}(c);fe(()=>{b&&g&&m(_)},[b,_,g,m]),t.useEffect(()=>{x.current=_},[_]);const N=t.useMemo(()=>({activeIndex:v,containerId:p,disabled:w,disableTransforms:y,items:_,overIndex:f,useDragOverlay:h,sortedRects:qn(_,d),strategy:s}),[v,p,w.draggable,w.droppable,y,_,f,d,h,s]);return n.createElement($n.Provider,{value:N},a)}const En=e=>{let{id:t,items:n,activeIndex:a,overIndex:r}=e;return Sn(n,a,r).indexOf(t)},Tn=e=>{let{containerId:t,isSorting:n,wasDragging:a,index:r,items:i,newIndex:s,previousItems:c,previousContainerId:o,transition:l}=e;return!(!l||!a)&&((c===i||r!==s)&&(!!n||s!==r&&t===o))},On={duration:200,easing:"ease"},Wn="transform",Ln=Me.Transition.toString({property:Wn,duration:0,easing:"linear"}),Pn={roleDescription:"sortable"};function An(e){let{animateLayoutChanges:n=Tn,attributes:a,disabled:r,data:i,getNewIndex:s=En,id:c,strategy:o,resizeObserverConfig:l,transition:d=On}=e;const{items:u,containerId:m,activeIndex:p,disabled:h,disableTransforms:_,sortedRects:g,overIndex:v,useDragOverlay:f,strategy:x}=t.useContext($n),b=function(e,t){var n,a;if("boolean"==typeof e)return{draggable:e,droppable:!1};return{draggable:null!=(n=null==e?void 0:e.draggable)?n:t.draggable,droppable:null!=(a=null==e?void 0:e.droppable)?a:t.droppable}}(r,h),y=u.indexOf(c),w=t.useMemo(()=>({sortable:{containerId:m,index:y,items:u},...i}),[m,i,y,u]),N=t.useMemo(()=>u.slice(u.indexOf(c)),[u,c]),{rect:j,node:S,isOver:q,setNodeRef:C}=function(e){let{data:n,disabled:a=!1,id:r,resizeObserverConfig:i}=e;const s=Se("Droppable"),{active:c,dispatch:o,over:l,measureDroppableContainers:d}=t.useContext(mn),u=t.useRef({disabled:a}),m=t.useRef(!1),p=t.useRef(null),h=t.useRef(null),{disabled:_,updateMeasurementsFor:g,timeout:v}={...jn,...i},f=be(null!=g?g:r),x=Jt({callback:t.useCallback(()=>{m.current?(null!=h.current&&clearTimeout(h.current),h.current=setTimeout(()=>{d(Array.isArray(f.current)?f.current:[f.current]),h.current=null},v)):m.current=!0},[v]),disabled:_||!c}),b=t.useCallback((e,t)=>{x&&(t&&(x.unobserve(t),m.current=!1),e&&x.observe(e))},[x]),[y,w]=we(b),N=be(n);return t.useEffect(()=>{x&&y.current&&(x.disconnect(),m.current=!1,x.observe(y.current))},[y,x]),t.useEffect(()=>(o({type:Fe.RegisterDroppable,element:{id:r,key:s,disabled:a,node:y,rect:p,data:N}}),()=>o({type:Fe.UnregisterDroppable,key:s,id:r})),[r]),t.useEffect(()=>{a!==u.current.disabled&&(o({type:Fe.SetDroppableDisabled,id:r,key:s,disabled:a}),u.current.disabled=a)},[r,s,a,o]),{active:c,rect:p,isOver:(null==l?void 0:l.id)===r,node:y,over:l,setNodeRef:w}}({id:c,data:w,disabled:b.droppable,resizeObserverConfig:{updateMeasurementsFor:N,...l}}),{active:k,activatorEvent:D,activeNodeRect:I,attributes:M,setNodeRef:$,listeners:R,isDragging:E,over:T,setActivatorNodeRef:O,transform:W}=Nn({id:c,data:w,attributes:{...Pn,...a},disabled:b.draggable}),L=function(){for(var e=arguments.length,n=new Array(e),a=0;a<e;a++)n[a]=arguments[a];return t.useMemo(()=>e=>{n.forEach(t=>t(e))},n)}(C,$),P=Boolean(k),A=P&&!_&&Cn(p)&&Cn(v),F=!f&&E,z=F&&A?W:null,U=A?null!=z?z:(null!=o?o:x)({rects:g,activeNodeRect:I,activeIndex:p,overIndex:v,index:y}):null,B=Cn(p)&&Cn(v)?s({id:c,items:u,activeIndex:p,overIndex:v}):y,K=null==k?void 0:k.id,V=t.useRef({activeId:K,items:u,newIndex:B,containerId:m}),H=u!==V.current.items,Q=n({active:k,containerId:m,isDragging:E,isSorting:P,id:c,index:y,items:u,newIndex:V.current.newIndex,previousItems:V.current.items,previousContainerId:V.current.containerId,transition:d,wasDragging:null!=V.current.activeId}),Y=function(e){let{disabled:n,index:a,node:r,rect:i}=e;const[s,c]=t.useState(null),o=t.useRef(a);return fe(()=>{if(!n&&a!==o.current&&r.current){const e=i.current;if(e){const t=nt(r.current,{ignoreTransform:!0}),n={x:e.left-t.left,y:e.top-t.top,scaleX:e.width/t.width,scaleY:e.height/t.height};(n.x||n.y)&&c(n)}}a!==o.current&&(o.current=a)},[n,a,r,i]),t.useEffect(()=>{s&&c(null)},[s]),s}({disabled:!Q,index:y,node:S,rect:j});return t.useEffect(()=>{P&&V.current.newIndex!==B&&(V.current.newIndex=B),m!==V.current.containerId&&(V.current.containerId=m),u!==V.current.items&&(V.current.items=u)},[P,B,m,u]),t.useEffect(()=>{if(K===V.current.activeId)return;if(null!=K&&null==V.current.activeId)return void(V.current.activeId=K);const e=setTimeout(()=>{V.current.activeId=K},50);return()=>clearTimeout(e)},[K]),{active:k,activeIndex:p,attributes:M,data:w,rect:j,index:y,newIndex:B,items:u,isOver:q,isSorting:P,isDragging:E,listeners:R,node:S,overIndex:v,over:T,setNodeRef:L,setActivatorNodeRef:O,setDroppableNodeRef:C,setDraggableNodeRef:$,transform:null!=Y?Y:U,transition:function(){if(Y||H&&V.current.newIndex===y)return Ln;if(F&&!De(D)||!d)return;if(P||Q)return Me.Transition.toString({...d,property:Wn});return}()}}function Fn({children:e,onConfirm:n,disabled:a=!1,placeholder:s="날짜와 금액을 입력하세요",align:c="center",side:o="bottom",defaultDate:l,defaultAmount:d}){const[u,m]=t.useState(!1),[p,h]=t.useState(l),[_,g]=t.useState(d?.toString()||"");return r.jsxs(F,{open:u,onOpenChange:m,children:[r.jsx(z,{asChild:!0,disabled:a,children:e}),r.jsx(U,{className:"w-auto p-0 border-gray-200 shadow-lg",align:c,side:o,sideOffset:8,children:r.jsxs("div",{className:"bg-white business-radius-card p-3",children:[r.jsx("div",{className:"mb-2 px-1",children:r.jsx("div",{className:"modal-label text-gray-600 text-center",children:s})}),r.jsx(I,{mode:"single",selected:p,onSelect:h,locale:M,initialFocus:!0,className:"compact-calendar",disabled:!1,fromDate:new Date("2020-01-01"),toDate:new Date("2030-12-31"),defaultMonth:p||new Date,modifiers:{today:new Date},modifiersClassNames:{today:"bg-blue-500 text-white font-semibold cursor-pointer hover:bg-blue-600 rounded-md"}}),r.jsxs("div",{className:"mt-3 px-1",children:[r.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"지출금액"}),r.jsx(T,{type:"text",value:_,onChange:e=>{const t=e.target.value.replace(/[^0-9]/g,"");if(t){const e=parseInt(t,10);g(e.toLocaleString())}else g("")},placeholder:"금액을 입력하세요",className:"w-full"})]}),r.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[r.jsx(i,{variant:"outline",size:"sm",onClick:()=>m(!1),children:"취소"}),r.jsx(i,{size:"sm",onClick:()=>{if(!p)return;const e=parseFloat(_.replace(/,/g,""));isNaN(e)||e<=0||(n(p,e),m(!1),h(l),g(d?.toString()||""))},disabled:!p||!_||parseFloat(_.replace(/,/g,""))<=0,className:"button-base button-action-primary",children:"확인"})]})]})})]})}function zn({children:e,onConfirm:n,disabled:a=!1,placeholder:s="날짜와 실제입고수량을 입력하세요",align:c="center",side:o="bottom",defaultDate:l,defaultQuantity:d,maxQuantity:u,allowOverMaxQuantity:m=!1,hideQuantityInput:p=!1,quantityInfoText:h="요청입고수량과 동일한 수량으로 입력됩니다"}){const[_,g]=t.useState(!1),[v,f]=t.useState(l),[x,b]=t.useState(d?.toString()||"");return r.jsxs(F,{open:_,onOpenChange:g,children:[r.jsx(z,{asChild:!0,disabled:a,children:e}),r.jsx(U,{className:"w-auto p-0 border-gray-200 shadow-lg",align:c,side:o,sideOffset:8,children:r.jsxs("div",{className:"bg-white business-radius-card p-3",children:[r.jsx("div",{className:"mb-2 px-1",children:r.jsx("div",{className:"modal-label text-gray-600 text-center",children:s})}),p&&r.jsx("div",{className:"mb-2 px-1",children:r.jsxs("div",{className:"text-[10px] text-gray-500 text-center leading-tight",children:[r.jsx("div",{children:"요청입고수량과 동일한"}),r.jsx("div",{children:"수량으로 입력됩니다"})]})}),r.jsx(I,{mode:"single",selected:v,onSelect:f,locale:M,initialFocus:!0,className:"compact-calendar",disabled:!1,fromDate:new Date("2020-01-01"),toDate:new Date("2030-12-31"),defaultMonth:v||new Date,modifiers:{today:new Date},modifiersClassNames:{today:"bg-blue-500 text-white font-semibold cursor-pointer hover:bg-blue-600 rounded-md"}}),!p&&r.jsxs("div",{className:"mt-3 px-1",children:[r.jsxs("div",{className:"flex items-center justify-between mb-1 gap-2",children:[r.jsx("label",{className:"block text-xs font-medium text-gray-700",children:h?.includes("미입고")?"추가입고수량":"실제입고수량"}),void 0!==u&&r.jsx(i,{type:"button",variant:"outline",size:"sm",onClick:()=>{void 0!==u&&b(u.toString())},className:"h-6 px-2 text-[10px] border-gray-200 text-hansl-600",children:h?.includes("미입고")?"미입고 수량 전체":"요청수량과 동일"})]}),r.jsx(T,{type:"number",value:x,onChange:e=>{const t=e.target.value.replace(/[^0-9]/g,"");b(t)},placeholder:"수량을 입력하세요",className:"border-gray-200 rounded-lg text-center w-full !h-5 !px-1.5 !py-0.5 !text-[9px] font-normal text-gray-600 focus:border-blue-400",min:"0",max:m?void 0:u}),void 0!==u&&r.jsx("p",{className:"text-xs text-gray-500 mt-1",children:h?.includes("미입고")?h:`${m?"요청수량":"최대"}: ${u.toLocaleString()}`})]}),r.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[r.jsx(i,{variant:"outline",size:"sm",onClick:()=>g(!1),className:"button-base",children:"취소"}),r.jsx(i,{size:"sm",onClick:()=>{if(!v)return;if(p)return n(v,void 0),g(!1),f(l),void b(d?.toString()||"");const e=parseFloat(x.replace(/,/g,""));isNaN(e)||e<0||void 0!==u&&!m&&e>u||(n(v,e),g(!1),f(l),b(d?.toString()||""))},disabled:!v||!p&&(!x||parseFloat(x.replace(/,/g,""))<0||!m&&void 0!==u&&parseFloat(x.replace(/,/g,""))>u),className:"button-base button-action-primary",children:"확인"})]})]})})]})}function Un({config:e,currentUserName:n,canPerformAction:a,purchaseId:r,onUpdate:i,onBeforeUpdate:m,onOptimisticUpdate:p}){const h=s(),_=t.useCallback(async(t,s,d,u)=>{if(!a)return c.warn("❌ 권한 없음",{canPerformAction:a,currentUserName:n}),void J.error(("statement_received"===e.field?"거래명세서":"입고")+" 확인 권한이 없습니다.");const _="number"==typeof t?t:Number(t);if(Number.isNaN(_))return c.error("❌ 잘못된 ID",{itemId:t,numericId:_}),void J.error("유효하지 않은 항목 ID 입니다.");if(d){const t=`품목명: ${d.item_name||"-"}\n규격: ${d.specification||"-"}\n수량: ${d.quantity?.toLocaleString()||0}\n단가: ₩${d.unit_price_value?.toLocaleString()||0}\n합계: ₩${d.amount_value?.toLocaleString()||0}\n비고: ${d.remark||"-"}\n\n${e.confirmMessage.confirm}`;if(!window.confirm(t))return}m?.();try{let t;if("statement_received"===e.field)t={is_statement_received:!0,statement_received_date:k(s),statement_received_by_name:n};else if("actual_received"===e.field){const e=d?.quantity||0,a=d?.received_quantity||0,r=void 0!==u?u:e,i=a+r,{data:o}=await h.from("purchase_request_items").select("receipt_history").eq("id",_).single(),l=o?.receipt_history||[],m={seq:l.length+1,qty:r,date:k(s),by:n||"알수없음"},p=[...l,m],g=i>=e;t={actual_received_date:k(s),is_received:g,received_quantity:i,delivery_status:0===i?"pending":g?"received":"partial",receipt_history:p},c.debug("📦 분할 입고 처리:",{requestedQuantity:e,currentReceivedQuantity:a,newReceivedQuantity:r,totalReceivedQuantity:i,isFullyReceived:g,historyCount:p.length})}c.debug("📝 업데이트할 데이터:",t);const{data:a,error:m}=await h.from("purchase_request_items").update(t).eq("id",_).select();if(c.debug("📝 DB 업데이트 결과:",{data:a,error:m}),m)throw c.error("❌ DB 업데이트 실패",m),m;if(c.info("✅ DB 업데이트 성공",a),r)if("actual_received"===e.field){o(r,_,k(s),u)||c.warn("[useConfirmDateAction] 메모리 캐시 입고완료 업데이트 실패",{purchaseId:r,itemId:_})}else if("statement_received"===e.field){l(r,_,k(s),n||void 0)||c.warn("[useConfirmDateAction] 메모리 캐시 거래명세서 확인 업데이트 실패",{purchaseId:r,itemId:_})}p&&p({itemId:_,selectedDate:s,action:"confirm",receivedQuantity:void 0!==u?u:d?.received_quantity,itemInfo:d}),i&&i(),J.success(e.successMessage.confirm)}catch(g){c.error("❌ 전체 처리 실패",g),J.error(("statement_received"===e.field?"거래명세서":"입고")+" 확인 처리 중 오류가 발생했습니다.")}},[e,n,a,r,i,m,p,h]),g=t.useCallback(async(t,s)=>{if(!a)return c.warn("❌ 취소 권한 없음",{canPerformAction:a,currentUserName:n}),void J.error(("statement_received"===e.field?"거래명세서":"입고")+" 확인 권한이 없습니다.");const o="number"==typeof t?t:Number(t);if(Number.isNaN(o))J.error("유효하지 않은 항목 ID 입니다.");else{if(s){const t=`품목명: ${s.item_name||"-"}\n규격: ${s.specification||"-"}\n수량: ${s.quantity?.toLocaleString()||0}\n단가: ₩${s.unit_price_value?.toLocaleString()||0}\n합계: ₩${s.amount_value?.toLocaleString()||0}\n비고: ${s.remark||"-"}\n\n${e.confirmMessage.cancel}`;if(!window.confirm(t))return}m?.();try{let n;c.debug(`🔄 ${e.field} 확인 취소 시작`,{itemId:t,itemName:s?.item_name}),"statement_received"===e.field?n={is_statement_received:!1,statement_received_date:null,statement_received_by_name:null}:"actual_received"===e.field&&(n={actual_received_date:null,is_received:!1,received_quantity:0,delivery_status:"pending",receipt_history:[]}),c.debug("🔄 취소 업데이트할 데이터:",n);const{data:a,error:l}=await h.from("purchase_request_items").update(n).eq("id",o).select();if(c.debug("🔄 취소 DB 업데이트 결과:",{data:a,error:l}),l)throw c.error("❌ DB 업데이트 실패",l),l;if(c.info(`✅ ${e.field} 확인 취소 성공`,a),r)if("actual_received"===e.field){d(r,o)||c.warn("[useConfirmDateAction] 메모리 캐시 입고취소 업데이트 실패",{purchaseId:r,itemId:o})}else if("statement_received"===e.field){u(r,o)||c.warn("[useConfirmDateAction] 메모리 캐시 거래명세서 취소 업데이트 실패",{purchaseId:r,itemId:o})}p&&p({itemId:o,action:"cancel",itemInfo:s}),i&&i(),J.success(e.successMessage.cancel)}catch(l){c.error(`❌ ${e.field} 확인 취소 실패`,l),J.error(("statement_received"===e.field?"거래명세서":"입고")+" 확인 취소 중 오류가 발생했습니다.")}}},[e,a,r,i,m,p,h]),v=t.useCallback(t=>"statement_received"===e.field?t.is_statement_received:"actual_received"===e.field&&t.is_received,[e.field]),f=t.useCallback(t=>{if("actual_received"===e.field){const e=t.received_quantity||0,n=t.quantity||0;return e>0&&e<n}return!1},[e.field]),x=t.useCallback(e=>{const t=e.received_quantity||0,n=e.quantity||0;return Math.max(0,n-t)},[]),b=t.useCallback(t=>"statement_received"===e.field?t.statement_received_date:"actual_received"===e.field?t.actual_received_date:null,[e.field]),y=t.useCallback(t=>"statement_received"===e.field?t.statement_received_by_name:(e.field,null),[e.field]);return{config:e,handleConfirm:_,handleCancel:g,isCompleted:v,isPartiallyReceived:f,getRemainingQuantity:x,getCompletedDate:b,getCompletedByName:y}}jt.Down,jt.Right,jt.Up,jt.Left;const Bn=[{id:"statement_progress",label:"거래명세서",description:"거래명세서 수령 진행률",defaultVisible:!0},{id:"purchase_order_number",label:"발주번호",description:"발주요청 번호",defaultVisible:!0},{id:"payment_category",label:"결제종류",description:"결제 방식 (구매요청, 발주, 현장결제 등)",defaultVisible:!0},{id:"requester_name",label:"요청자",description:"발주를 요청한 사용자",defaultVisible:!0},{id:"request_date",label:"청구일",description:"발주 요청 날짜",defaultVisible:!0},{id:"utk_status",label:"UTK",description:"UTK 확인 상태",defaultVisible:!0},{id:"vendor_name",label:"업체",description:"공급업체명",defaultVisible:!0},{id:"contact_name",label:"담당자",description:"업체 담당자명",defaultVisible:!0},{id:"delivery_request_date",label:"입고요청일",description:"입고 요청 날짜",defaultVisible:!0},{id:"revised_delivery_date",label:"변경입고일",description:"수정된 입고 날짜",defaultVisible:!0},{id:"item_name",label:"품명",description:"구매 품목명",defaultVisible:!0},{id:"specification",label:"규격",description:"품목 규격 정보",defaultVisible:!0},{id:"quantity",label:"수량",description:"구매 수량",defaultVisible:!0},{id:"unit_price",label:"단가",description:"품목 단가",defaultVisible:!0},{id:"amount",label:"합계",description:"총 금액",defaultVisible:!0},{id:"remark",label:"비고",description:"추가 메모 사항",defaultVisible:!0},{id:"link",label:"링크",description:"관련 링크",defaultVisible:!0},{id:"project_vendor",label:"PJ업체",description:"프로젝트 업체",defaultVisible:!0},{id:"project_item",label:"PJ ITEM",description:"프로젝트 아이템",defaultVisible:!0},{id:"sales_order_number",label:"수주번호",description:"수주 번호",defaultVisible:!0},{id:"purchase_progress",label:"구매진행",description:"구매 진행률",defaultVisible:!0},{id:"receipt_progress",label:"입고진행",description:"입고 진행률",defaultVisible:!0}],Kn=Bn.reduce((e,t)=>(e[t.id]=t.defaultVisible,e),{});Bn.reduce((e,t)=>(e[t.id]=t,e),{});const Vn=["purchase_order_number","vendor_name","item_name","specification"],Hn=["statement_progress","utk_status","unit_price","amount"],Qn=["app_admin","ceo","final_approver","purchase_manager","lead buyer","accounting"],Yn=["app_admin","lead buyer","accounting"],Xn=[{title:"기본 정보",columns:["statement_progress","purchase_order_number","payment_category","requester_name","request_date","utk_status"]},{title:"업체 정보",columns:["vendor_name","contact_name","delivery_request_date","revised_delivery_date"]},{title:"품목 정보",columns:["item_name","specification","quantity","unit_price","amount","remark","link"]},{title:"프로젝트 정보",columns:["project_vendor","project_item","sales_order_number"]},{title:"진행 상태",columns:["purchase_progress","receipt_progress"]}];function Jn(e){if(!e)return e;const t=e.toUpperCase().replace(/\s+/g,""),n=t.match(/^(F\d{8})[_-](\d{1,3})$/);if(n){const[,e,t]=n;return`${e}_${t.padStart(3,"0")}`}if(t.startsWith("F")&&t.includes("-")&&!t.includes("_")){const e=t.match(/^(F\d{6,8})-(\d{1,3})$/);if(e){const[,t,n]=e;return`${t}_${n.padStart(3,"0")}`}return t.replace("-","_")}const a=t.match(/^(HS\d{6})-(\d{1,2})$/);if(a){const[,e,t]=a;return`${e}-${t.padStart(2,"0")}`}return t}const Gn=new class{constructor(){this.supabase=s()}async uploadStatement(e,t){try{const n=e.name.split(".").pop()?.toLowerCase()||"png",a=crypto.randomUUID(),r=`Transaction Statement/${`${a}.${n}`}`,{data:i,error:s}=await this.supabase.storage.from("receipt-images").upload(r,e,{contentType:e.type,upsert:!1});if(s)throw s;const{data:c}=this.supabase.storage.from("receipt-images").getPublicUrl(r),o=c.publicUrl,{data:{user:l}}=await this.supabase.auth.getUser(),{data:d,error:u}=await this.supabase.from("transaction_statements").insert({image_url:o,file_name:e.name,uploaded_by:l?.id,uploaded_by_name:t,status:"pending"}).select().single();if(u)throw new Error(`DB 저장 실패: ${u.message} (code: ${u.code})`);return{success:!0,data:{statementId:d.id,imageUrl:o}}}catch(n){return{success:!1,error:n instanceof Error?n.message:"업로드 중 오류가 발생했습니다."}}}async extractStatementData(e,t){try{await this.supabase.from("transaction_statements").update({status:"processing"}).eq("id",e);const{data:n,error:a}=await this.supabase.functions.invoke("ocr-transaction-statement",{body:{statementId:e,imageUrl:t}});if(a)throw a;if(!n.success)throw new Error(n.error||"OCR 추출 실패");return await this.getStatementWithItems(e)}catch(n){return{success:!1,error:n instanceof Error?n.message:"OCR 추출 중 오류가 발생했습니다."}}}async getStatements(e){try{let t=this.supabase.from("transaction_statements").select("\n          *,\n          items:transaction_statement_items(matched_purchase_id)\n        ",{count:"exact"}).order("uploaded_at",{ascending:!1});e?.status&&"all"!==e.status&&(t=t.eq("status",e.status)),e?.dateFrom&&(t=t.gte("uploaded_at",e.dateFrom)),e?.dateTo&&(t=t.lte("uploaded_at",e.dateTo+"T23:59:59")),e?.search&&(t=t.or(`vendor_name.ilike.%${e.search}%,file_name.ilike.%${e.search}%`)),e?.limit&&(t=t.limit(e.limit)),e?.offset&&(t=t.range(e.offset,e.offset+(e.limit||20)-1));const{data:n,count:a,error:r}=await t;if(r)throw r;const i=new Set;(n||[]).forEach(e=>{e.items?.forEach(e=>{e.matched_purchase_id&&i.add(e.matched_purchase_id)})});const s=new Map;if(i.size>0){const{data:e}=await this.supabase.from("purchase_requests").select("id, purchase_order_number, sales_order_number").in("id",Array.from(i));e?.forEach(e=>{s.set(e.id,{purchase_order_number:e.purchase_order_number,sales_order_number:e.sales_order_number})})}return{success:!0,data:(n||[]).map(e=>{const t=new Set;e.items?.forEach(e=>{e.matched_purchase_id&&t.add(e.matched_purchase_id)});const n=Array.from(t).map(e=>{const t=s.get(e);return{purchase_id:e,purchase_order_number:t?.purchase_order_number||"",sales_order_number:t?.sales_order_number}}),{items:a,...r}=e;return{...r,matched_purchase_id:n[0]?.purchase_id||null,matched_purchases:n}}),count:a||0}}catch(t){return{success:!1,error:t instanceof Error?t.message:"조회 중 오류가 발생했습니다."}}}async getStatementWithItems(e){try{const{data:t,error:n}=await this.supabase.from("transaction_statements").select("*").eq("id",e).single();if(n)throw n;const{data:a,error:r}=await this.supabase.from("transaction_statement_items").select("*").eq("statement_id",e).order("line_number",{ascending:!0});if(r)throw r;const i=t.vendor_name||"",s=await Promise.all((a||[]).map(async e=>{const t=await this.findMatchCandidates(e,i);let n,a;if(e.matched_purchase_id){const{data:t}=await this.supabase.from("purchase_requests").select("id, purchase_order_number, sales_order_number, vendor:vendors(vendor_name)").eq("id",e.matched_purchase_id).single();t&&(n={id:t.id,purchase_order_number:t.purchase_order_number||"",sales_order_number:t.sales_order_number,vendor_name:t.vendor?.vendor_name})}if(e.matched_item_id){const{data:t}=await this.supabase.from("purchase_request_items").select("id, item_name, specification, quantity, unit_price_value").eq("id",e.matched_item_id).single();t&&(a={id:t.id,item_name:t.item_name,specification:t.specification,quantity:t.quantity,unit_price_value:t.unit_price_value})}return{...e,match_candidates:t,matched_purchase:n,matched_item:a}}));return{success:!0,data:{...t,items:s}}}catch(t){return{success:!1,error:t instanceof Error?t.message:"조회 중 오류가 발생했습니다."}}}async findMatchCandidates(e,t){const n=new Map;try{const a=e.extracted_po_number||"",r=a?Jn(a):"",i=a.toUpperCase().match(/^(F)(\d{8})$/),s=a.toUpperCase().match(/^(HS)(\d{6})$/),c=!(!i&&!s),o=i?`F${i[2]}`:s?`HS${s[2]}`:"";if(r){const{data:a}=await this.supabase.from("purchase_requests").select("\n            id, \n            purchase_order_number, \n            sales_order_number,\n            vendor:vendors(vendor_name),\n            items:purchase_request_items(id, item_name, specification, quantity, unit_price_value)\n          ").or(`purchase_order_number.eq.${r},sales_order_number.eq.${r}`).limit(10);if(a)for(const r of a){const a=r.vendor?.vendor_name||"",i=t?this.calculateVendorSimilarity(t,a):100;if(!(i<50))for(const t of r.items||[]){const s=`${r.id}-${t.id}`,c=["발주/수주번호 일치"];let o=50;if(i>=90?(o+=10,c.push("거래처 일치")):i>=70&&(o+=5,c.push("거래처 유사")),e.extracted_item_name){const n=this.calculateItemMatchScore(e.extracted_item_name,t.item_name,t.specification);o+=.3*n.score,n.score>=80&&c.push("specification"===n.matchedField?"규격 일치":"품목명 일치")}e.extracted_quantity&&t.quantity&&(e.extracted_quantity===t.quantity?(o+=15,c.push(`수량 일치 (${e.extracted_quantity})`)):e.extracted_quantity<=t.quantity&&(o+=5,c.push(`수량 (요청:${t.quantity}, 입고:${e.extracted_quantity})`))),n.set(s,{purchase_id:r.id,purchase_order_number:r.purchase_order_number||"",sales_order_number:r.sales_order_number,item_id:t.id,item_name:t.item_name,specification:t.specification,quantity:t.quantity,unit_price:t.unit_price_value,vendor_name:a,score:o,match_reasons:c})}}}if(c&&o&&0===n.size){const{data:a}=await this.supabase.from("purchase_requests").select("\n            id, \n            purchase_order_number, \n            sales_order_number,\n            vendor:vendors(vendor_name),\n            items:purchase_request_items(id, item_name, specification, quantity, unit_price_value)\n          ").or(`purchase_order_number.ilike.${o}%,sales_order_number.ilike.${o}%`).limit(20);if(a)for(const r of a){const a=r.vendor?.vendor_name||"",i=t?this.calculateVendorSimilarity(t,a):100;if(!(i<50))for(const t of r.items||[]){const s=`${r.id}-${t.id}`;if(n.has(s))continue;const c=[`날짜 일치 (${o})`];let l=30;if(i>=90?(l+=20,c.push("거래처 일치")):i>=70&&(l+=10,c.push("거래처 유사")),e.extracted_item_name){const n=this.calculateItemMatchScore(e.extracted_item_name,t.item_name,t.specification);l+=.4*n.score,n.score>=80?c.push("specification"===n.matchedField?"규격 일치":"품목명 일치"):n.score>=50&&c.push("specification"===n.matchedField?"규격 유사":"품목명 유사")}e.extracted_quantity&&t.quantity&&(e.extracted_quantity===t.quantity?(l+=15,c.push(`수량 일치 (${e.extracted_quantity})`)):e.extracted_quantity<=t.quantity&&(l+=5,c.push(`수량 (요청:${t.quantity}, 입고:${e.extracted_quantity})`))),n.set(s,{purchase_id:r.id,purchase_order_number:r.purchase_order_number||"",sales_order_number:r.sales_order_number,item_id:t.id,item_name:t.item_name,specification:t.specification,quantity:t.quantity,unit_price:t.unit_price_value,vendor_name:a,score:l,match_reasons:c})}}}if(e.extracted_item_name){const a=e.extracted_item_name.trim(),i=[a,a.substring(0,Math.min(a.length,12)),a.substring(0,Math.min(a.length,8)),a.split(/\[|]|\s|_|-/)[0]].filter(e=>e&&e.length>=3),s=[...new Set(i)];for(const c of s){const{data:a}=await this.supabase.from("purchase_request_items").select("\n              id, \n              item_name, \n              specification, \n              quantity, \n              unit_price_value,\n              purchase:purchase_requests!inner(\n                id, \n                purchase_order_number, \n                sales_order_number,\n                vendor:vendors(vendor_name)\n              )\n            ").or(`item_name.ilike.%${c}%,specification.ilike.%${c}%`).limit(50);if(a&&a.length>0){for(const i of a){const a=`${i.purchase?.id}-${i.id}`;if(n.has(a))continue;const s=i.purchase?.vendor?.vendor_name||"",c=t?this.calculateVendorSimilarity(t,s):100;if(c<50)continue;const o=[];let l=0;c>=90?(l+=20,o.push("거래처 일치")):c>=70&&(l+=10,o.push("거래처 유사"));const d=this.calculateItemMatchScore(e.extracted_item_name,i.item_name,i.specification);d.score>=40&&(l+=.7*d.score,d.score>=85?o.push("specification"===d.matchedField?"규격 일치":"품목명 일치"):d.score>=50?o.push("specification"===d.matchedField?"규격 유사":"품목명 유사"):o.push("품목 부분일치")),e.extracted_quantity&&i.quantity&&(e.extracted_quantity===i.quantity?(l+=15,o.push(`수량 일치 (${e.extracted_quantity})`)):e.extracted_quantity<=i.quantity&&(l+=5,o.push(`수량 (요청:${i.quantity}, 입고:${e.extracted_quantity})`)));const u=i.purchase?.purchase_order_number||"",m=i.purchase?.sales_order_number||"";r&&u!==r&&m!==r&&o.push(`⚠️ OCR 오류 가능: ${r} → ${u||m}`),l>=15&&n.set(a,{purchase_id:i.purchase?.id,purchase_order_number:u,sales_order_number:m,item_id:i.id,item_name:i.item_name,specification:i.specification,quantity:i.quantity,unit_price:i.unit_price_value,vendor_name:i.purchase?.vendor?.vendor_name,score:l,match_reasons:o})}if(n.size>=5)break}}}const l=Array.from(n.values()).some(e=>e.score>=40);if((0===n.size||!l)&&t){const{data:a}=await this.supabase.from("vendors").select("id, vendor_name").limit(100);if(a){const i=a.filter(e=>this.calculateVendorSimilarity(t,e.vendor_name)>=70);if(i.length>0){const t=i.map(e=>e.id),a=new Date;a.setMonth(a.getMonth()-3);const{data:s}=await this.supabase.from("purchase_requests").select("\n                id, \n                purchase_order_number, \n                sales_order_number,\n                vendor:vendors(vendor_name),\n                items:purchase_request_items(id, item_name, specification, quantity, unit_price_value)\n              ").in("vendor_id",t).gte("created_at",a.toISOString()).order("created_at",{ascending:!1}).limit(30);if(s)for(const i of s){const t=i.vendor?.vendor_name||"";for(const a of i.items||[]){const s=`${i.id}-${a.id}`;if(n.has(s))continue;const c=["거래처 일치"];let o=20;if(e.extracted_item_name){const t=this.calculateItemMatchScore(e.extracted_item_name,a.item_name,a.specification);t.score>=40&&(o+=.5*t.score,t.score>=85?c.push("specification"===t.matchedField?"규격 일치":"품목명 일치"):t.score>=50&&c.push("specification"===t.matchedField?"규격 유사":"품목명 유사"))}e.extracted_quantity&&a.quantity&&(e.extracted_quantity===a.quantity?(o+=15,c.push(`수량 일치 (${e.extracted_quantity})`)):e.extracted_quantity<=a.quantity&&(o+=5,c.push(`수량 (요청:${a.quantity}, 입고:${e.extracted_quantity})`)));const l=i.purchase_order_number||"",d=i.sales_order_number||"";r&&c.push(`⚠️ OCR 오류 가능: ${r} → ${l||d}`),o>=15&&n.set(s,{purchase_id:i.id,purchase_order_number:l,sales_order_number:d,item_id:a.id,item_name:a.item_name,specification:a.specification,quantity:a.quantity,unit_price:a.unit_price_value,vendor_name:t,score:o,match_reasons:c})}}}}}const d=Array.from(n.values());return d.sort((e,t)=>t.score-e.score),d.length,d.slice(0,15)}catch(a){return[]}}calculateNameSimilarity(e,t){const n=e.toLowerCase().replace(/\s+/g,""),a=t.toLowerCase().replace(/\s+/g,"");if(!n||!a)return 0;if(n===a)return 100;if(n.includes(a)||a.includes(n))return 80;const r=Math.max(n.length,a.length),i=(r-this.levenshteinDistance(n,a))/r*100;return Math.round(i)}calculateItemMatchScore(e,t,n){if(!e)return{score:0,matchedField:"none"};const a=t?this.calculateNameSimilarity(e,t):0,r=n?this.calculateNameSimilarity(e,n):0;return a>=r?{score:a,matchedField:a>0?"item_name":"none"}:{score:r,matchedField:r>0?"specification":"none"}}calculateVendorSimilarity(e,t){if(!e||!t)return 0;const n=e=>e.toLowerCase().replace(/\(주\)|주식회사|㈜|주\)|주|co\.|co,|ltd\.|ltd|inc\.|inc|corp\.|corp|company|컴퍼니/gi,"").replace(/[^a-z0-9가-힣]/g,"").trim(),a=n(e),r=n(t);if(!a||!r)return 0;if(a===r)return 100;if(a.includes(r)||r.includes(a))return 90;const i={yg:["와이지","yg"],"와이지":["yg","와이지"],tech:["테크","텍","tech"],"테크":["tech","텍","테크"],"텍":["tech","테크","텍"],high:["하이","high"],"하이":["high","하이"],korea:["코리아","한국","korea"],"코리아":["korea","한국","코리아"],electric:["전기","일렉트릭","electric"],"전기":["electric","일렉트릭","전기"],steel:["스틸","철강","steel"],"스틸":["steel","철강","스틸"],metal:["메탈","금속","metal"],"메탈":["metal","금속","메탈"],system:["시스템","system"],"시스템":["system","시스템"],soft:["소프트","soft"],"소프트":["soft","소프트"],net:["넷","net"],"넷":["net","넷"],global:["글로벌","global"],"글로벌":["global","글로벌"],trade:["트레이드","무역","trade"],"트레이드":["trade","무역","트레이드"],international:["인터내셔널","international"],"인터내셔널":["international","인터내셔널"]};let s=a,c=r;for(const[d,u]of Object.entries(i)){if(a.includes(d)){for(const e of u)if(s=s.replace(d,e),s===r||r.includes(s)||s.includes(r))return 85;s=a}if(r.includes(d)){for(const e of u)if(c=c.replace(d,e),a===c||a.includes(c)||c.includes(a))return 85;c=r}}const o=Math.max(a.length,r.length),l=(o-this.levenshteinDistance(a,r))/o*100;return Math.round(l)}isVendorMatch(e,t,n=70){return this.calculateVendorSimilarity(e,t)>=n}levenshteinDistance(e,t){const n=e.length,a=t.length,r=Array(n+1).fill(null).map(()=>Array(a+1).fill(0));for(let i=0;i<=n;i++)r[i][0]=i;for(let i=0;i<=a;i++)r[0][i]=i;for(let i=1;i<=n;i++)for(let n=1;n<=a;n++)e[i-1]===t[n-1]?r[i][n]=r[i-1][n-1]:r[i][n]=Math.min(r[i-1][n-1],r[i-1][n],r[i][n-1])+1;return r[n][a]}calculateSimilarityScore(e,t){let n=0;if(e.extracted_item_name){n+=.4*this.calculateItemMatchScore(e.extracted_item_name,t.item_name||"",t.specification||"").score}if(e.extracted_specification){n+=.2*this.calculateItemMatchScore(e.extracted_specification,t.item_name||"",t.specification||"").score}if(e.extracted_quantity&&t.quantity){const a=Math.abs(e.extracted_quantity-t.quantity);0===a?n+=20:a<=.1*t.quantity?n+=15:a<=.2*t.quantity&&(n+=10)}if(e.extracted_unit_price&&t.unit_price_value){const a=Math.abs(e.extracted_unit_price-t.unit_price_value);0===a?n+=20:a<=.05*t.unit_price_value?n+=15:a<=.1*t.unit_price_value&&(n+=10)}return n}getMatchReasons(e,t,n){const a=[];if(e.extracted_item_name){const n=this.calculateItemMatchScore(e.extracted_item_name,t.item_name||"",t.specification||"");n.score>=90?a.push("specification"===n.matchedField?"규격 완전 일치":"품목명 완전 일치"):n.score>=70?a.push("specification"===n.matchedField?"규격 높은 유사도":"품목명 높은 유사도"):n.score>=50&&a.push("specification"===n.matchedField?"규격 부분 일치":"품목명 부분 일치")}return e.extracted_quantity&&t.quantity&&(e.extracted_quantity===t.quantity?a.push(`수량 일치 (${e.extracted_quantity})`):e.extracted_quantity<=t.quantity&&a.push(`수량 (요청:${t.quantity}, 입고:${e.extracted_quantity})`)),e.extracted_unit_price===t.unit_price_value&&a.push("단가 일치"),n>=70?a.push("높은 유사도"):n>=50&&a.push("보통 유사도"),a}async updateItemMatch(e,t,n,a="manual"){try{const{error:r}=await this.supabase.from("transaction_statement_items").update({matched_purchase_id:t,matched_item_id:n,match_method:a}).eq("id",e);if(r)throw r;return{success:!0}}catch(r){return{success:!1,error:r instanceof Error?r.message:"매칭 업데이트 중 오류가 발생했습니다."}}}async confirmStatement(e,t){try{const{data:{user:n}}=await this.supabase.auth.getUser();for(const t of e.items){const{error:e}=await this.supabase.from("transaction_statement_items").update({is_confirmed:!0,matched_purchase_id:t.matched_purchase_id,matched_item_id:t.matched_item_id,confirmed_quantity:t.confirmed_quantity,confirmed_unit_price:t.confirmed_unit_price,confirmed_amount:t.confirmed_amount,is_additional_item:t.is_additional_item||!1,parent_item_id:t.parent_item_id}).eq("id",t.itemId);if(e)throw e;const n=void 0!==t.confirmed_unit_price&&null!==t.confirmed_unit_price,a=void 0!==t.confirmed_amount&&null!==t.confirmed_amount;if(t.matched_item_id&&(n||a)){const e={};n&&(e.unit_price_value=t.confirmed_unit_price),a&&(e.amount_value=t.confirmed_amount);const{error:r}=await this.supabase.from("purchase_request_items").update(e).eq("id",t.matched_item_id)}if(t.is_additional_item&&t.matched_purchase_id&&!t.matched_item_id){const e=await this.getStatementItem(t.itemId);if(e){const{error:n}=await this.supabase.from("purchase_request_items").insert({purchase_request_id:t.matched_purchase_id,item_name:e.extracted_item_name||"추가 공정",specification:e.extracted_specification,quantity:t.confirmed_quantity||e.extracted_quantity||1,unit_price_value:t.confirmed_unit_price||e.extracted_unit_price,amount_value:t.confirmed_amount||e.extracted_amount,remark:"거래명세서에서 추가됨"})}}}const{error:a}=await this.supabase.from("transaction_statements").update({status:"confirmed",confirmed_at:(new Date).toISOString(),confirmed_by:n?.id,confirmed_by_name:t}).eq("id",e.statementId);if(a)throw a;return{success:!0}}catch(n){return{success:!1,error:n instanceof Error?n.message:"확정 중 오류가 발생했습니다."}}}async getStatementItem(e){const{data:t}=await this.supabase.from("transaction_statement_items").select("*").eq("id",e).single();return t}async rejectStatement(e){try{const{error:t}=await this.supabase.from("transaction_statements").update({status:"rejected"}).eq("id",e);if(t)throw t;return{success:!0}}catch(t){return{success:!1,error:t instanceof Error?t.message:"거부 처리 중 오류가 발생했습니다."}}}async deleteStatement(e){try{const{data:n}=await this.supabase.from("transaction_statements").select("image_url").eq("id",e).single(),{error:a}=await this.supabase.from("transaction_statements").delete().eq("id",e);if(a)throw a;if(n?.image_url)try{const e=n.image_url.split("/receipt-images/")[1];e&&await this.supabase.storage.from("receipt-images").remove([e])}catch(t){}return{success:!0}}catch(n){return{success:!1,error:n instanceof Error?n.message:"삭제 중 오류가 발생했습니다."}}}async findBestMatchingPurchaseOrderSet(e,t,n){try{const a=t?Jn(t):"",r=[];if(a){const{data:t}=await this.supabase.from("purchase_requests").select("\n            id, \n            purchase_order_number, \n            sales_order_number,\n            vendor:vendors(vendor_name),\n            items:purchase_request_items(id, item_name, specification, quantity, unit_price_value)\n          ").or(`purchase_order_number.eq.${a},sales_order_number.eq.${a}`).limit(5);if(t&&t.length>0)for(const a of t){const t=a.vendor?.vendor_name||"";if((n?this.calculateVendorSimilarity(n,t):100)<50)continue;const i=this.calculateSetMatchScore(e,a.items||[]);r.push({purchase_id:a.id,purchase_order_number:a.purchase_order_number||"",sales_order_number:a.sales_order_number,vendor_name:t,matchScore:i.score,matchedItemCount:i.matchedCount,totalItemCount:e.length,items:a.items||[],itemMatches:i.itemMatches})}}const i=r.length>0?r.reduce((e,t)=>e.matchScore>t.matchScore?e:t):null;if(i&&i.matchScore>=80)return{success:!0,data:{bestMatch:{...i,confidence:"high"},candidates:r.map(e=>({purchase_id:e.purchase_id,purchase_order_number:e.purchase_order_number,sales_order_number:e.sales_order_number,vendor_name:e.vendor_name,matchScore:e.matchScore,matchedItemCount:e.matchedItemCount}))}};const s=new Date;s.setMonth(s.getMonth()-3);const{data:c}=await this.supabase.from("purchase_requests").select("\n          id, \n          purchase_order_number, \n          sales_order_number,\n          vendor:vendors(vendor_name),\n          items:purchase_request_items(id, item_name, specification, quantity, unit_price_value)\n        ").gte("created_at",s.toISOString()).order("created_at",{ascending:!1}).limit(100);if(c)for(const t of c){if(r.some(e=>e.purchase_id===t.id))continue;const a=t.vendor?.vendor_name||"";if((n?this.calculateVendorSimilarity(n,a):100)<50)continue;const i=this.calculateSetMatchScore(e,t.items||[]);i.score>=40&&r.push({purchase_id:t.id,purchase_order_number:t.purchase_order_number||"",sales_order_number:t.sales_order_number,vendor_name:a,matchScore:i.score,matchedItemCount:i.matchedCount,totalItemCount:e.length,items:t.items||[],itemMatches:i.itemMatches})}r.sort((e,t)=>t.matchScore-e.matchScore);const o=r.length>0?r[0]:null;return{success:!0,data:{bestMatch:o?{...o,confidence:o.matchScore>=80?"high":o.matchScore>=50?"medium":"low"}:null,candidates:r.slice(0,10).map(e=>({purchase_id:e.purchase_id,purchase_order_number:e.purchase_order_number,sales_order_number:e.sales_order_number,vendor_name:e.vendor_name,matchScore:e.matchScore,matchedItemCount:e.matchedItemCount}))}}}catch(a){return{success:!1,error:a instanceof Error?a.message:"세트 매칭 중 오류가 발생했습니다."}}}calculateSetMatchScore(e,t){if(0===e.length||0===t.length)return{score:0,matchedCount:0,itemMatches:[]};const n=[],a=new Set;let r=0;for(const o of e){let e=null;for(const n of t){if(a.has(n.id))continue;const t=this.calculateItemMatchScore(o.extracted_item_name||"",n.item_name||"",n.specification||"");let r=0;o.extracted_quantity&&n.quantity&&(o.extracted_quantity===n.quantity?r=15:o.extracted_quantity<=n.quantity&&(r=5));const i=t.score+r;(!e||i>e.similarity)&&(e={id:n.id,name:n.item_name,similarity:i})}e&&e.similarity>=40&&(a.add(e.id),r+=e.similarity,n.push({ocrItemId:o.id,systemItemId:e.id,systemItemName:e.name,similarity:e.similarity}))}const i=n.length/e.length,s=n.length>0?r/n.length:0,c=Math.round(50*i+.5*s);return{score:Math.min(100,c),matchedCount:n.length,itemMatches:n}}async saveCorrection(e){try{const{data:{user:t}}=await this.supabase.auth.getUser(),{error:n}=await this.supabase.from("ocr_corrections").insert({statement_id:e.statement_id,statement_item_id:e.statement_item_id,original_text:e.original_text,corrected_text:e.corrected_text,field_type:e.field_type,corrected_by:t?.id});if(n)throw n;return{success:!0}}catch(t){return{success:!1,error:t instanceof Error?t.message:"교정 데이터 저장 중 오류가 발생했습니다."}}}async getStatementsByPurchaseId(e){try{const{data:t}=await this.supabase.from("transaction_statement_items").select("statement_id").eq("matched_purchase_id",e);if(!t||0===t.length)return{success:!0,data:[]};const n=[...new Set(t.map(e=>e.statement_id))],{data:a,error:r}=await this.supabase.from("transaction_statements").select("*").in("id",n).order("uploaded_at",{ascending:!1});if(r)throw r;return{success:!0,data:a||[]}}catch(t){return{success:!1,error:t instanceof Error?t.message:"조회 중 오류가 발생했습니다."}}}},Zn=({id:e,children:t})=>{const{attributes:n,listeners:a,setNodeRef:i,transform:s,transition:c,isDragging:o}=An({id:e}),l={transform:Me.Transform.toString(s),transition:c};return r.jsx(r.Fragment,{children:t({setNodeRef:i,attributes:n,listeners:a,isDragging:o,style:l})})};const ea=t.memo(function({purchaseId:e,isOpen:n,onClose:a,embedded:d=!1,currentUserRoles:u=[],activeTab:I,onRefresh:M,onOptimisticUpdate:de,onDelete:ue}){const{allPurchases:me,lastFetch:pe}=m(),[he,_e]=t.useState(!1),[ge,ve]=t.useState(null),[fe,xe]=t.useState(!1),[be,ye]=t.useState(null),[we,Ne]=t.useState([]),[je,Se]=t.useState([]),[qe,Ce]=t.useState([]),[ke,De]=t.useState(""),[Ie,Me]=t.useState([]),[$e,Re]=t.useState(null),[Ee,Te]=t.useState([]),[Oe,We]=t.useState(""),[Le,Pe]=t.useState(!1),[Ae,Fe]=t.useState(""),[ze,Ue]=t.useState(""),[Be,Ke]=t.useState(),[Ve,He]=t.useState([]),[Qe,Xe]=t.useState([]),[Je,Ge]=t.useState(!1),Ze=t.useRef(null),[et,tt]=t.useState(!1),[nt,at]=t.useState([]),rt=function(){for(var e=arguments.length,n=new Array(e),a=0;a<e;a++)n[a]=arguments[a];return t.useMemo(()=>[...n].filter(e=>null!=e),[...n])}((it=Tt,st={activationConstraint:{distance:4}},t.useMemo(()=>({sensor:it,options:null!=st?st:{}}),[it,st])));var it,st;const ct=t.useCallback((e,t)=>e?.stableKey?e.stableKey:null!=e?.id?`sk-item-${e.id}`:e?.tempId?`sk-tmp-${e.tempId}`:null!=e?.line_number?`sk-line-${e.line_number}-${t}`:`sk-idx-${t}`,[]),ot=t.useCallback((e=[])=>e.map((e,t)=>{const n={...e,tempId:e?.tempId??`tmp-${e?.id??e?.line_number??t}-${t}`};return{...n,stableKey:ct(n,t)}}),[ct]),lt=t.useCallback((e,t)=>e?.stableKey?e.stableKey:null!=e?.id?`item-${e.id}`:e?.tempId?`tmp-${e.tempId}`:null!=e?.line_number?`line-${e.line_number}-${t}`:`temp-${t}`,[]),dt=t.useCallback(e=>{const{active:t,over:n}=e;n&&t.id!==n.id&&Ne(e=>{const a=e.findIndex((e,n)=>lt(e,n)===t.id),r=e.findIndex((e,t)=>lt(e,t)===n.id);if(-1===a||-1===r)return e;return Sn(e,a,r).map((e,t)=>({...e,line_number:t+1,stableKey:e.stableKey??ct(e,t)}))})},[lt,ct]);t.useEffect(()=>{Le&&(Fe(""),Ue(""),Ke(void 0),He([]),Xe([]))},[Le]),t.useEffect(()=>{"quantity_change"===Ae&&0===Ve.length&&He([{id:ut(),itemId:"",newQuantity:""}]),"price_change"===Ae&&0===Qe.length&&Xe([{id:ut(),itemId:"",changeType:"unit_price",newValue:""}])},[Ae,Ve.length,Qe.length]);const ut=()=>`row-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,mt=t.useMemo(()=>ge?.purchase_request_items?[...ge.purchase_request_items].sort((e,t)=>(e.line_number??Number.MAX_SAFE_INTEGER)-(t.line_number??Number.MAX_SAFE_INTEGER)):[],[ge]),pt=t.useMemo(()=>mt.map(e=>({value:String(e.id),label:`${e.line_number?`${e.line_number}.`:""} ${e.item_name} (${e.specification||"-"})`.trim()})),[mt]),ht=[{value:"delivery_date_change",label:"입고일 변경 요청"},{value:"quantity_change",label:"수량 변경 요청"},{value:"price_change",label:"단가/합계 금액 변경 요청"},{value:"modify",label:"수정 요청"},{value:"delete",label:"삭제 요청"}],_t=[{value:"unit_price",label:"단가"},{value:"amount",label:"합계액"}],gt=e=>{if("undefined"==typeof document)return 7*e.length;Ze.current||(Ze.current=document.createElement("canvas"));const t=Ze.current.getContext("2d");return t?(t.font=(()=>{if("undefined"==typeof document)return'11px Pretendard, -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans KR", sans-serif';const e=window.getComputedStyle(document.body),t=e.fontFamily||'Pretendard, -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans KR", sans-serif';return`${e.fontWeight||"400"} 11px ${t}`})(),Math.ceil(t.measureText(e).width)):7*e.length},vt=(e,t=4,n=12)=>Math.max(e.length+t,n),ft=e=>e.reduce((e,t)=>{const n=t.label??"";return Math.max(e,gt(n))},0),xt="문의 유형을 선택해주세요",bt=vt(xt,3,14),yt=vt(ht.reduce((e,t)=>{const n=t.label||"";return n.length>e.length?n:e},xt),3,bt),wt="품목 선택/검색",Nt=((e,t)=>{const n=ft(e),a=Math.max(n,gt(t));return Math.ceil(a+24+30)})(pt,wt)+16,jt=((e,t)=>{const n=ft(e),a=Math.max(n,gt(t));return Math.ceil(a+24+30+14)})(pt,wt),St=(e,t)=>({control:e=>({...e,minHeight:"28px",height:"28px",fontSize:"11px",borderRadius:"8px",borderColor:"#e5e7eb",boxShadow:"none"}),container:t=>({...t,width:e?`${e}px`:t.width,maxWidth:"100%"}),valueContainer:e=>({...e,padding:"0 8px"}),input:e=>({...e,margin:0,padding:0,fontSize:"11px"}),indicatorsContainer:e=>({...e,height:"28px"}),option:e=>({...e,fontSize:"11px",whiteSpace:"nowrap",overflow:"visible",textOverflow:"clip"}),placeholder:e=>({...e,fontSize:"11px",color:"#9ca3af"}),singleValue:e=>({...e,fontSize:"11px",overflow:"visible",textOverflow:"clip",maxWidth:"none"}),menu:e=>({...e,width:t?`${t}px`:e.width,minWidth:t?`${t}px`:e.minWidth,maxWidth:t?`${t}px`:"90vw"}),menuList:e=>({...e,width:t?`${t}px`:e.width,minWidth:t?`${t}px`:e.minWidth,maxWidth:t?`${t}px`:e.maxWidth})}),qt=e=>{if(!e)return"";const t=Number(e);return Number.isFinite(t)?t.toLocaleString("ko-KR"):e},Ct=(e,t)=>{He(n=>n.map(n=>n.id===e?{...n,...t}:n))},kt=(e,t)=>{Xe(n=>n.map(n=>n.id===e?{...n,...t}:n))},Dt=t.useRef(fe);t.useEffect(()=>{Dt.current=fe},[fe]);const It=t.useRef(et);t.useEffect(()=>{It.current=et},[et]);const Mt=t.useRef(0),$t=t.useRef(0),Rt=t.useRef(!0),Et=t.useRef(!1);t.useEffect(()=>{if(!n||!e)return;const t=p(()=>{if(Rt.current)return void(Rt.current=!1);if(Dt.current)return;if(It.current)return;if(Mt.current&&Date.now()-Mt.current<3e4)return void c.debug("[PurchaseDetailModal] 저장 직후(30s) - Realtime 캐시 이벤트 무시");if(Et.current)return void c.debug("[PurchaseDetailModal] 업데이트 진행 중 - Realtime 이벤트 무시");const t=_(e);if(t){const e=t.items||t.purchase_request_items||[];ve(n=>{const a=n?.items||n?.purchase_request_items||[],r=0===e.length&&a.length>0?a:e;return 0===e.length&&0===a.length&&n?(c.debug("[PurchaseDetailModal] 캐시/현재 items 모두 비어있음 - 업데이트 스킵"),n):{...t,id:String(t.id),is_po_generated:!1,items:r,purchase_request_items:r}})}});return()=>t()},[n,e]);const Ot=t.useMemo(()=>{if(ge?.items&&ge.items.length>0)return ot(ge.items);if(ge?.purchase_request_items&&ge.purchase_request_items.length>0)return ot(ge.purchase_request_items);if(e&&me){const t=me.find(t=>t.id===e);if(t){const e=t.items&&t.items.length>0?t.items:t.purchase_request_items||[];return ot(e)}}return[]},[ge,e,me,pe,ot]),Wt=t.useMemo(()=>{if(fe)return we||[];return[...Ot||[]].sort((e,t)=>{const n=e?.line_number??999999,a=t?.line_number??999999;if(n!==a)return n-a;const r=e?.created_at?new Date(e.created_at).getTime():0,i=t?.created_at?new Date(t.created_at).getTime():0;if(r!==i)return r-i;const s=e?.id??0,c=t?.id??0;if(s!==c)return s-c;const o=e?.tempId??"",l=t?.tempId??"";return o<l?-1:o>l?1:0})},[fe,we,Ot]),Lt=t.useMemo(()=>(we||[]).map((e,t)=>lt(e,t)),[we,lt]);t.useMemo(()=>{if(Ie.length>0){const e=Ie.length>1?12*(Ie.length-1):0,t=24,n=Ie.reduce((e,t)=>e+t,0)+e+t;return Math.max(n,720)}const e=[120,200,70,90,100,150,80];"purchase"===I&&e.push(120),"receipt"!==I&&"done"!==I||e.push(120),"receipt"===I&&e.push(140),"done"===I&&e.push(100,80,110),fe&&e.push(110);const t=e.length>1?12*(e.length-1):0,n=e.reduce((e,t)=>e+t,0)+t+48;return Math.max(n,720)},[Ie,I,fe]);const Pt=t.useRef(null),At=s();t.useEffect(()=>{n&&(async()=>{try{const e="https://qvhbigvdfyvhoegkhvef.supabase.co";if(!e||e.includes("placeholder"))return void c.warn("Supabase 환경 변수가 설정되지 않음 - PurchaseDetailModal");const{data:{user:t}}=await At.auth.getUser();if(t){let{data:e}=await At.from("employees").select("*").eq("id",t.id).maybeSingle();if(!e&&t.email){const{data:n}=await At.from("employees").select("*").eq("email",t.email).maybeSingle();e=n}if(e?.name&&De(e.name),e?.purchase_role){let t=[];t=Array.isArray(e.purchase_role)?e.purchase_role.map(e=>String(e).trim()):String(e.purchase_role).split(",").map(e=>e.trim()).filter(e=>e.length>0),Ce(t)}}}catch(e){c.error("사용자 권한 로드 실패:",e)}})()},[n]),t.useEffect(()=>{n&&(async()=>{try{const{data:e,error:t}=await At.from("vendors").select("*").order("vendor_name",{ascending:!0});if(t)throw t;e&&Te(e)}catch(e){c.error("업체 목록 로드 실패:",e)}})()},[n]);const Ft=Array.isArray(u)&&u.length>0?u:qe,zt=Ft.includes("final_approver")||Ft.includes("app_admin")||Ft.includes("ceo"),Ut=Ft.includes("lead buyer"),Bt=zt||Ut,Kt=Ft.some(e=>Qn.includes(e)),Vt="발주"===ge?.payment_category&&("done"===I||"receipt"===I&&Ft.includes("lead buyer")),Ht="발주"===ge?.payment_category&&"done"===I,Qt="approved"===ge?.final_manager_status?zt:zt||ge?.requester_name===ke,Yt=Ft.includes("app_admin")||Ft.includes("lead buyer")||Ft.includes("lead buyer"),Xt=Ft.includes("app_admin")||ge?.requester_name===ke,Jt=Ft.includes("final_approver")||Ft.includes("app_admin")||Ft.includes("ceo"),Gt=ge?.requester_name===ke,Zt=Ft.includes("app_admin")||Ft.includes("lead buyer")||Ft.includes("accounting"),en=Ft.includes("app_admin")||Gt,tn=t.useCallback(async()=>{if(e)if(Dt.current||It.current)c.debug("[refreshModalData] 편집/저장 중 - DB 새로고침 스킵",{isEditing:Dt.current,isSaving:It.current});else try{const t=s(),{data:n,error:a}=await t.from("purchase_requests").select("\n          *,\n          vendors:vendor_id(id, vendor_name, is_active),\n          purchase_request_items(*),\n          contact:contact_id(id, contact_name, contact_email, contact_phone, position)\n        ").eq("id",e).single();if(a)throw a;let r=[];if(n&&n.vendor_id){const{data:e}=await t.from("vendor_contacts").select("id, contact_name, contact_email, contact_phone, position").eq("vendor_id",n.vendor_id).order("contact_name");if(e&&e.length>0){if(n.contact_id){const t=e.find(e=>e.id===n.contact_id),a=e.filter(e=>e.id!==n.contact_id);r=t?[t,...a]:e}else r=e;c.info("🔍 업체의 모든 담당자 로드:",{vendor_id:n.vendor_id,contact_id:n.contact_id,allContacts_count:e.length,vendorContacts:r})}}else n&&n.contact&&(r=[n.contact]);if(n){const e=ot((n.purchase_request_items||[]).sort((e,t)=>(e.line_number||999999)-(t.line_number||999999))),t=e.map(e=>({id:e.id,item_name:e.item_name,amount_value:e.amount_value,unit_price_value:e.unit_price_value,quantity:e.quantity}));c.info("🔍 [refreshModalData] DB에서 가져온 품목 데이터:",{itemsData:t}),t.forEach(e=>{0===e.amount_value&&null!=e.unit_price_value&&0!==e.unit_price_value&&c.warn("⚠️ [refreshModalData] 합계금액이 0인데 단가가 있는 품목:",{itemId:e.id,item_name:e.item_name,amount_value:e.amount_value,unit_price_value:e.unit_price_value,quantity:e.quantity,calculated_amount:(e.quantity||0)*(e.unit_price_value||0)})});const a={...n,items:e,vendor:n.vendors||null,vendor_contacts:r,contact_id:n.contact_id,contact_name:r[0]?.contact_name||n.contact?.contact_name||null};ve({...a,items:e}),ye(a),Ne(e),c.info("🔍 refreshModalData DB에서 로드 완료:",{vendor_contacts:a.vendor_contacts,vendorContacts_from_query:r,purchase_updated:!0,vendor_id:n.vendor_id,has_vendor_contacts:r&&r.length>0}),c.debug("refreshModalData - DB에서 가져온 데이터:",{vendor_id:n.vendor_id,vendor_contacts:r,purchaseData_full:a,"담당자이름":r?.[0]?.contact_name||"없음"})}}catch(t){c.error("모달 데이터 새로고침 실패",t)}},[e]),nn=t.useCallback(async()=>{Et.current=!0;try{await tn()}finally{setTimeout(()=>{Et.current=!1},3e3)}},[tn]),an=t.useCallback(async()=>{if(!ge)return;if(!Zt||!Kt)return;const e=!(ge.is_utk_checked||!1),t=e?`발주번호: ${ge.purchase_order_number}\n\nUTK 확인 처리하시겠습니까?`:`발주번호: ${ge.purchase_order_number}\n\nUTK 확인을 취소하시겠습니까?`;if(window.confirm(t))try{const t=s(),{error:n}=await t.from("purchase_requests").update({is_utk_checked:e}).eq("id",ge.id);if(n)return c.error("UTK 확인 DB 업데이트 실패",{error:n,purchaseId:ge.id}),void J.error("UTK 확인 처리 중 오류가 발생했습니다.");ve(t=>t?{...t,is_utk_checked:e,updated_at:(new Date).toISOString()}:null),ge.id&&h(ge.id,t=>({...t,is_utk_checked:e})),J.success(e?"UTK 확인이 완료되었습니다.":"UTK 확인이 취소되었습니다."),await nn();const a=M?.(!0,{silent:!0});a instanceof Promise&&await a}catch(n){c.error("UTK 확인 처리 중 오류",n),J.error("UTK 확인 처리 중 오류가 발생했습니다.")}},[ge,Zt,Kt,M,nn]);t.useEffect(()=>{if(!e||!me||!ge)return;if(fe||et)return;const t=me.find(t=>t.id===e);if(t){const e=ot(t.items&&t.items.length>0?t.items:t.purchase_request_items||[]),n={...ge,...t,id:String(t.id),items:e,purchase_request_items:e};ve(n),ye(n),Ne(e.length>0?e:[])}},[me,pe,fe,et]),t.useEffect(()=>{if(!n||!e||!me)return;if(fe||et)return;const t=me.find(t=>t.id===e);if(t){const e=ot(t.items&&t.items.length>0?t.items:t.purchase_request_items||[]),n={...t,id:String(t.id),is_po_generated:!1,items:e,purchase_request_items:e,vendor:{id:t.vendor_id,vendor_name:t.vendor_name||"알 수 없음",is_active:!0,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()},vendor_contacts:[]};ve(n),ye(n),Ne(e.length>0?e:[])}},[n,e,me,fe,et]);const[rn,sn]=t.useState(!0),cn=e?Number(e):ge?Number(ge.id):NaN,on=t.useCallback(({itemId:e,selectedDate:t,action:n,receivedQuantity:a})=>{const r=String(e),i=(new Date).toISOString(),s=t?k(t):void 0,c=e=>e?e.map(e=>String(e.id)!==r?e:"confirm"===n?{...e,is_received:!0,actual_received_date:s,received_at:i,received_quantity:void 0!==a?a:e.received_quantity}:{...e,is_received:!1,actual_received_date:void 0,received_at:void 0,received_quantity:void 0}):e;ve(e=>{if(!e)return e;const t=c(e.items)||[],n=c(e.purchase_request_items)||[],a=t.length,r=t.filter(e=>e.is_received).length,s=a>0&&r===a;return{...e,items:t,purchase_request_items:n,is_received:s,received_at:s?e.received_at||i:void 0,updated_at:(new Date).toISOString()}}),ye(e=>{if(!e)return e;const t=c(e.items)||[],n=c(e.purchase_request_items)||[];return{...e,items:t,purchase_request_items:n}}),Ne(e=>e&&0!==e.length?e.map(e=>e.id&&String(e.id)===r?"confirm"===n?{...e,is_received:!0,actual_received_date:s,received_at:i,received_quantity:void 0!==a?a:e.received_quantity}:{...e,is_received:!1,actual_received_date:void 0,received_at:void 0,received_quantity:void 0}:e):e),Number.isNaN(cn)||de?.(cn,e=>{const t=c(e.items)||e.items||[],n=c(e.purchase_request_items)||e.purchase_request_items||[],a=t.length||e.items?.length||0,r=t.filter(e=>e.is_received).length,s=a>0&&r===a;return{...e,items:t,purchase_request_items:n,is_received:s,received_at:s?e.received_at||i:void 0,updated_at:(new Date).toISOString()}})},[de,cn]),ln=t.useCallback(({itemId:e,selectedDate:t,action:n})=>{const a=String(e),r=t?k(t):void 0;let i=!1,o=null;if(ve(e=>{if(!e)return e;const t=(e.items||[]).map(e=>String(e.id)!==a?e:"confirm"===n?{...e,is_statement_received:!0,statement_received_date:r,statement_received_by_name:ke}:{...e,is_statement_received:!1,statement_received_date:null,statement_received_by_name:null});return i=t.length>0&&t.every(e=>e.is_statement_received),o=i?r||e.statement_received_at||(new Date).toISOString():null,{...e,items:t,is_statement_received:i,statement_received_at:o}}),ye(e=>{if(!e)return e;const t=(e.items||[]).map(e=>String(e.id)!==a?e:"confirm"===n?{...e,is_statement_received:!0,statement_received_date:r,statement_received_by_name:ke}:{...e,is_statement_received:!1,statement_received_date:null,statement_received_by_name:null});return{...e,items:t,is_statement_received:i,statement_received_at:o}}),Ne(e=>e?e.map(e=>String(e.id)!==a?e:"confirm"===n?{...e,is_statement_received:!0,statement_received_date:r,statement_received_by_name:ke}:{...e,is_statement_received:!1,statement_received_date:null,statement_received_by_name:null}):e),Number.isNaN(cn)||de?.(cn,e=>{const t=(e.items||[]).map(e=>String(e.id)!==a?e:"confirm"===n?{...e,is_statement_received:!0,statement_received_date:r,statement_received_by_name:ke}:{...e,is_statement_received:!1,statement_received_date:null,statement_received_by_name:null}),i=t.length>0&&t.every(e=>e.is_statement_received);return{...e,items:t,is_statement_received:i}}),ge&&void 0!==i){s().from("purchase_requests").update({is_statement_received:i,statement_received_at:o}).eq("id",ge.id).then(({error:e})=>{e&&c.error("거래명세서 확인 purchase_requests 업데이트 실패",e)})}},[ke,de,cn,ge]),dn=t.useCallback(()=>{Et.current=!0,c.debug("[PurchaseDetailModal] 업데이트 시작 - Realtime 이벤트 무시 활성화")},[]),un=Un({config:{field:"statement_received",confirmMessage:{confirm:"거래명세서 확인을 처리하시겠습니까?",cancel:"거래명세서 확인을 취소하시겠습니까?"},successMessage:{confirm:"거래명세서 확인이 완료되었습니다.",cancel:"거래명세서 확인이 취소되었습니다."},completedText:"✓ 완료",waitingText:"대기"},currentUserName:ke,canPerformAction:Zt,purchaseId:ge?.id,onBeforeUpdate:dn,onUpdate:nn,onOptimisticUpdate:ln}),mn=Un({config:{field:"actual_received",confirmMessage:{confirm:"실제 입고 처리를 진행하시겠습니까?",cancel:"실제 입고 처리를 취소하시겠습니까?"},successMessage:{confirm:"실제 입고 처리가 완료되었습니다.",cancel:"실제 입고 처리가 취소되었습니다."},completedText:"입고완료",waitingText:"입고대기"},currentUserName:ke,canPerformAction:en,purchaseId:ge?.id,onBeforeUpdate:dn,onUpdate:nn,onOptimisticUpdate:on}),pn=Ft.includes("middle_manager")||Ft.includes("app_admin")||Ft.includes("ceo"),hn=Ft.includes("final_approver")||Ft.includes("app_admin")||Ft.includes("ceo"),_n="inline-flex items-center gap-1 business-radius-badge !h-auto !min-h-0 !px-2.5 !py-0.5 badge-text leading-tight",gn="inline-flex items-center gap-1 business-radius-badge px-2.5 py-0.5 badge-text leading-tight";t.useEffect(()=>{if(e&&n){const t=_(e);if(t){const e={...t,id:String(t.id),is_po_generated:!1,vendor:t.vendor||(t.vendor_id?{id:t.vendor_id,vendor_name:t.vendor_name||"알 수 없음",is_active:!0,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}:null),vendor_contacts:t.vendor_contacts||[]};ve(e),ye(e),Ne(t.items||[])}else Nn(e.toString());xe(!1),vn(e)}},[e,n]);const vn=async e=>{try{const t=await Gn.getStatementsByPurchaseId(e);t.success&&t.data&&at(t.data)}catch(t){at([])}},fn=t.useCallback(()=>{const e=ge?.items&&ge.items.length>0?ge.items:ge?.purchase_request_items&&ge.purchase_request_items.length>0?ge.purchase_request_items:[];if(0===e.length)return[];const t=[{key:"line_number",minWidth:32,maxWidth:32,baseWidth:32,isFixed:!0},{key:"item_name",minWidth:80,maxWidth:500,baseWidth:80},{key:"specification",minWidth:80,maxWidth:200,baseWidth:150,isFixed:!1},{key:"quantity",minWidth:70,maxWidth:120,baseWidth:70},{key:"unit_price",minWidth:90,maxWidth:150,baseWidth:90},{key:"total_price",minWidth:100,maxWidth:180,baseWidth:100}];"발주"===ge?.payment_category&&t.push({key:"tax_amount",minWidth:80,maxWidth:150,baseWidth:80}),t.push({key:"link",minWidth:60,maxWidth:80,baseWidth:60,isFixed:!0}),t.push({key:"remarks",minWidth:150,maxWidth:150,baseWidth:150,isFixed:!0}),"pending"!==I&&t.push({key:"status",minWidth:70,maxWidth:100,baseWidth:70}),"receipt"===I&&(t.push({key:"actual_receipt_date",minWidth:100,maxWidth:160,baseWidth:100,isFixed:!1}),Vt&&t.push({key:"transaction_confirm",minWidth:85,maxWidth:120,baseWidth:85,isFixed:!1},{key:"accounting_date",minWidth:70,maxWidth:70,baseWidth:70,isFixed:!0})),"done"===I&&"발주"===ge?.payment_category&&t.push({key:"transaction_confirm",minWidth:85,maxWidth:120,baseWidth:85,isFixed:!1},{key:"accounting_date",minWidth:70,maxWidth:70,baseWidth:70,isFixed:!0},{key:"expenditure_info",minWidth:90,maxWidth:150,baseWidth:90,isFixed:!1});const n=t.map((t,n)=>{let a=4;const r=(()=>{const e="purchase"===I?"구매상태":"receipt"===I||"done"===I?"입고상태":"상태",t="receipt"===I||"done"===I?"요청/실제 입고수량":"요청수량",n="pending"===I?["#","품목명","규격",t,"단가","합계","발주"===ge?.payment_category?"세액":null,"비고"].filter(e=>null!==e):["#","품목명","규격",t,"단가","합계","발주"===ge?.payment_category?"세액":null,"비고",e].filter(e=>null!==e);if("receipt"===I){const e=[...n,"실제입고일"];return Vt&&e.push("거래명세서 확인","회계상 입고일"),e}if("done"===I){const e=[...n];return Vt&&(e.push("거래명세서 확인","회계상 입고일"),Ht&&e.push("지출정보")),e}return n})();if(r[n]&&(a=Math.max(a,r[n].length)),e.forEach(e=>{let n="";switch(t.key){case"line_number":n=e.line_number?.toString()||"";break;case"item_name":n=e.item_name||"";break;case"specification":n=e.specification||"";break;case"quantity":if("receipt"===I||"done"===I){const t=e.quantity||0,a=e.received_quantity??0;n=t>=100||a>=100?`${t}`:`${t}/${a}`}else n=e.quantity?.toString()||"";break;case"unit_price":n=null!=e.unit_price_value?e.unit_price_value.toLocaleString():"";break;case"total_price":n=null!=e.amount_value?e.amount_value.toLocaleString():null!=e.quantity&&null!=e.unit_price_value?(Number(e.quantity)*Number(e.unit_price_value)).toLocaleString():"";break;case"tax_amount":n=null!=e.tax_amount_value?e.tax_amount_value.toLocaleString():"";break;case"remarks":n=e.remark||"";break;case"status":n=xn(e)||"";break;case"actual_receipt_date":n=e.actual_received_date?D(e.actual_received_date):"";break;case"transaction_confirm":n=e.is_statement_received?"확인완료":"미확인";break;case"accounting_date":n=e.statement_received_date?D(e.statement_received_date):"";break;case"expenditure_info":n=e.expenditure_date&&null!==e.expenditure_amount&&void 0!==e.expenditure_amount?"2025. 11. 25.":"지출입력"}const r=n.split("").reduce((e,t)=>e+(/[가-힣]/.test(t)?1.5:1),0);a=Math.max(a,Math.ceil(r))}),t.isFixed)return t.baseWidth;let i=Math.max(t.minWidth,Math.min(t.maxWidth,7*a+20));return"expenditure_info"===t.key&&(i=110),i});return Me(n),n},[ge,I,Vt,Ht]),xn=e=>"purchase"===I?e.is_payment_completed?"구매완료":"구매요청":"receipt"===I?e.is_received?"입고":"입고대기":e.is_payment_completed?"구매완료":"구매요청",yn=()=>{if(Ie.length>0){return Ie.map(e=>`${e}px`).join(" ")}const e=["32px","minmax(80px, 1fr)","200px","70px","90px","100px"];if("발주"===ge?.payment_category&&e.push("100px"),e.push("60px"),e.push("150px"),"pending"!==I&&e.push("80px"),"receipt"===I){const t=[...e,"100px"];return Vt&&t.push("100px","80px"),t.join(" ")}if("done"===I){const t=[...e];return Vt&&(t.push("100px","80px"),Ht&&t.push("110px")),t.join(" ")}return e.join(" ")};t.useEffect(()=>{const e=ge?.items&&ge.items.length>0||ge?.purchase_request_items&&ge.purchase_request_items.length>0;ge&&e&&!fe&&requestAnimationFrame(()=>{fn()})},[ge,fe,I,fn]);const wn=e=>{if(e&&!fe){ye(ge);const e=[...Ot||[]].sort((e,t)=>(e?.line_number??999999)-(t?.line_number??999999));Ne(e),Se([]),fn()}xe(e)},Nn=async e=>{try{const t=_(e);if(t){const e={...t,id:String(t.id),is_po_generated:!1,vendor:t.vendor||(t.vendor_id?{id:t.vendor_id,vendor_name:t.vendor_name||"알 수 없음",is_active:!0,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}:null),vendor_contacts:t.vendor_contacts||[]};return ve({...e,items:ot(t.items||e.items||[])}),ye(e),void Ne(ot(t.items||[]))}_e(!0);const n=s(),{data:a,error:r}=await n.from("purchase_requests").select("\n          *,\n          vendors:vendor_id(id, vendor_name, is_active),\n          purchase_request_items(*),\n          contact:contact_id(id, contact_name, contact_email, contact_phone, position)\n        ").eq("id",e).single();if(r)throw r;let i=[];if(a&&a.vendor_id){const{data:e}=await n.from("vendor_contacts").select("id, contact_name, contact_email, contact_phone, position").eq("vendor_id",a.vendor_id).order("contact_name");if(e&&e.length>0){if(a.contact_id){const t=e.find(e=>e.id===a.contact_id),n=e.filter(e=>e.id!==a.contact_id);i=t?[t,...n]:e}else i=e;c.info("🔍 loadPurchaseDetail - 업체의 모든 담당자 로드:",{vendor_id:a.vendor_id,contact_id:a.contact_id,allContacts_count:e.length,vendorContacts:i})}}else a&&a.contact&&(i=[a.contact]);if(a){const e=ot((a.purchase_request_items||[]).sort((e,t)=>(e.line_number||999999)-(t.line_number||999999))),t={...a,items:e,vendor:a.vendors||null,vendor_contacts:i,contact_id:a.contact_id,contact_name:i[0]?.contact_name||a.contact?.contact_name||null};ve({...t,items:e}),ye(t),Ne(e)}}catch(t){c.error("[PurchaseDetailModal] 발주 상세 로드 실패:",t),J.error("발주 상세 정보를 불러오는데 실패했습니다.")}finally{_e(!1)}},jn=(e,t=0)=>{if(null==e)return t;if("string"==typeof e){const n=e.trim();if(""===n)return t;const a=n.replace(/,/g,""),r=Number(a);return Number.isNaN(r)?t:r}const n=Number(e);return Number.isNaN(n)?t:n},qn=e=>new Intl.NumberFormat("ko-KR").format(e),Cn=e=>"USD"===e?"USD":"KRW",kn=()=>Cn(fe?be?.currency:ge?.currency),Dn=e=>Cn(e?.unit_price_currency??e?.amount_currency??e?.tax_amount_currency??kn()),Mn=(e,t)=>`${(e=>"USD"===Cn(e)?"$":"₩")(t)}${qn(e)}`,$n=(e,t)=>Promise.race([Promise.resolve(e),new Promise((e,n)=>setTimeout(()=>n(new Error(`작업이 ${t}ms 내에 완료되지 않았습니다.`)),t))]),En=(e,t,n)=>{const a=[...we];if("quantity"===t||"unit_price_value"===t){if(a[e]?.is_amount_manual)return a[e]={...a[e],[t]:n},void Ne(a);const r="quantity"===t?n:a[e].quantity,i="unit_price_value"===t?n:a[e].unit_price_value;if(null!=i&&void 0!==i&&""!==i&&0!==i&&(null!=r&&void 0!==r&&0!==r)){const s=(r||0)*(i||0),c="발주"===ge?.payment_category?Math.round(.1*s):0;a[e]={...a[e],[t]:n,amount_value:s,tax_amount_value:c}}else a[e]={...a[e],[t]:n}}else if("amount_value"===t){let t=0;if(""!==n&&null!=n&&void 0!==n){const e=Number(n);Number.isNaN(e)||(t=e)}const r="발주"===ge?.payment_category?Math.round(.1*t):0;a[e]={...a[e],is_amount_manual:!0,amount_value:t,tax_amount_value:r}}else a[e]={...a[e],[t]:n};Ne(a)},Tn=async(e,t)=>{if(!Yt)return c.warn("[handlePaymentToggle] 권한 없음",{canPurchase:Yt,currentUserRoles:u}),void J.error("구매완료 처리 권한이 없습니다.");const n=String(e),a="number"==typeof e?e:Number(e);if(Number.isNaN(a))return c.error("[handlePaymentToggle] 잘못된 ID",{itemId:e,numericId:a}),void J.error("유효하지 않은 항목 ID 입니다.");if(!ge)return;const r=ge.items&&ge.items.length>0?ge.items:[],i=ge.purchase_request_items&&ge.purchase_request_items.length>0?ge.purchase_request_items:[],s=(r.length>0?r:i).find(e=>String(e.id)===n);if(!s)return;const o=`품명: ${s.item_name}\n규격: ${s.specification||"미입력"}\n수량: ${s.quantity?.toLocaleString()||0}${s.unit||""}\n단가: ₩${s.unit_price_value?.toLocaleString()||0}\n합계: ₩${s.amount_value?.toLocaleString()||0}`,l=t?`다음 품목을 구매완료 처리하시겠습니까?\n\n${o}`:`다음 품목의 구매완료를 취소하시겠습니까?\n\n${o}`;if(window.confirm(l))try{const{error:e}=await At.from("purchase_request_items").update({is_payment_completed:t,payment_completed_at:t?(new Date).toISOString():null}).eq("id",a);if(e)throw e;if(ge){(t?y(ge.id,a):q(ge.id,a))||c.warn("[PurchaseDetailModal] 메모리 캐시 품목 업데이트 실패",{purchaseId:ge.id,itemId:a,isCompleted:t})}if(ve(e=>{if(!e)return null;const a=e.items&&e.items.length>0?e.items:[],r=e.purchase_request_items&&e.purchase_request_items.length>0?e.purchase_request_items:[],i=(a.length>0?a:r).map(e=>String(e.id)===n?{...e,is_payment_completed:t,payment_completed_at:t?(new Date).toISOString():null}:e);return{...e,items:e.items?i:e.items,purchase_request_items:e.purchase_request_items?i:e.purchase_request_items}}),ge){const e=Number(ge.id);Number.isNaN(e)||de?.(e,e=>{const a=(e.items||[]).map(e=>String(e.id)===n?{...e,is_payment_completed:t}:e),r=a.length||e.items?.length||0,i=a.filter(e=>e.is_payment_completed).length,s=r>0&&i===r;return{...e,items:a,is_payment_completed:s,payment_completed_at:s?(new Date).toISOString():null,payment_completed_by_name:s&&ke||e.payment_completed_by_name}})}J.success(t?"구매완료 처리되었습니다.":"구매완료가 취소되었습니다."),await nn();const r=M?.(!0,{silent:!0});r instanceof Promise&&await r}catch(d){J.error("구매완료 처리 중 오류가 발생했습니다.")}},On=async(e,t,n)=>{if(Et.current=!0,!Xt)return J.error("입고 처리 권한이 없습니다."),void(Et.current=!1);const a=String(e),r="number"==typeof e?e:Number(e);if(Number.isNaN(r))return void J.error("유효하지 않은 항목 ID 입니다.");const i=ge?.items?.find(e=>String(e.id)===a)||ge?.purchase_request_items?.find(e=>String(e.id)===a),s=i?.quantity||0,l=void 0!==n?n:s,d=(i?.received_quantity||0)+l,u=d>s,m=u?d:s,p=d>=m,h=0===d?"pending":p?"received":"partial",_=i?.receipt_history||[],g={seq:_.length+1,qty:l,date:k(t),by:ke||"알수없음"},v=[..._,g],f=ge?Number(ge.id):NaN,x=u?{quantity:m}:{};try{const{error:e}=await At.from("purchase_request_items").update({is_received:p,delivery_status:h,received_at:(new Date).toISOString(),actual_received_date:k(t),received_quantity:d,receipt_history:v,...u?{quantity:m}:{}}).eq("id",r);if(e)throw e;if(ge){o(ge.id,r,k(t),d)||c.warn("[PurchaseDetailModal] 메모리 캐시 개별 품목 입고완료 업데이트 실패",{purchaseId:ge.id,itemId:r})}ve(e=>{if(!e)return null;const n=e.items?.map(e=>String(e.id)===a?{...e,...x,is_received:p,delivery_status:h,received_at:(new Date).toISOString(),actual_received_date:k(t),received_quantity:d,receipt_history:v}:e),r=e.purchase_request_items?.map(e=>String(e.id)===a?{...e,...x,is_received:p,delivery_status:h,received_at:(new Date).toISOString(),actual_received_date:k(t),received_quantity:d,receipt_history:v}:e);return{...e,items:n,purchase_request_items:r,updated_at:(new Date).toISOString()}}),Number.isNaN(f)||de?.(f,e=>{const n=(e.items||[]).map(e=>String(e.id)===a?{...e,...x,is_received:p,delivery_status:h,actual_received_date:k(t),received_quantity:d,receipt_history:v}:e),r=n.length||e.items?.length||0,i=n.filter(e=>e.is_received).length,s=r>0&&i===r;return{...e,items:n,is_received:s,received_at:s?(new Date).toISOString():e.received_at}});const n=ge?.items?.find(e=>String(e.id)===a);J.success(`"${n?.item_name}" 품목이 입고완료 처리되었습니다.`),await nn();const i=M?.(!0,{silent:!0});i instanceof Promise&&await i}catch(b){J.error("입고완료 처리 중 오류가 발생했습니다.")}},Wn=async e=>{if(!ge)return;const t="middle"===e?"1차 승인":"최종 승인",n=`발주번호: ${ge.purchase_order_number}\n\n${t}을 진행하시겠습니까?`;if(window.confirm(n))try{const t="middle"===e?{middle_manager_status:"approved"}:{final_manager_status:"approved"},{error:n}=await At.from("purchase_requests").update(t).eq("id",ge.id);if(n)throw n;if(ve("middle"===e?e=>e?{...e,middle_manager_status:"approved"}:null:e=>e?{...e,final_manager_status:"approved"}:null),h(String(ge.id),t=>({...t,..."middle"===e?{middle_manager_status:"approved"}:{final_manager_status:"approved"}})),ge&&de){const t=Number(ge.id);Number.isNaN(t)||de(t,t=>"middle"===e?{...t,middle_manager_status:"approved"}:{...t,final_manager_status:"approved"})}J.success(("middle"===e?"중간":"최종")+" 승인이 완료되었습니다."),await nn();const a=M?.(!0,{silent:!0});a instanceof Promise&&await a}catch(a){J.error("승인 처리 중 오류가 발생했습니다.")}},Ln=async(e,t,n)=>{if(!ge||!Zt)return void J.error("지출 정보 입력 권한이 없습니다.");const a=String(e),r="number"==typeof e?e:Number(e);if(Number.isNaN(r))return void c.error("유효하지 않은 itemId",{itemId:e});const i=ge.items?.find(e=>String(e.id)===a);if(!i)return;const s=ge?Number(ge.id):NaN;try{Number.isNaN(s)||de?.(s,e=>{const r=(e.items||[]).map(e=>String(e.id)===a?{...e,expenditure_date:k(t),expenditure_amount:n}:e);return{...e,items:r}}),ve(e=>{if(!e)return null;const r=(e.items||e.purchase_request_items||[]).map(e=>String(e.id)===a?{...e,expenditure_date:k(t),expenditure_amount:n}:e),i=r.reduce((e,t)=>e+(t.expenditure_amount||0),0);return{...e,items:r,purchase_request_items:r,total_expenditure_amount:i,updated_at:(new Date).toISOString()}});const{error:e}=await At.from("purchase_request_items").update({expenditure_date:k(t),expenditure_amount:n}).eq("id",r);if(e)throw c.error("지출 정보 DB 업데이트 실패",{error:e,itemId:r}),e;const o=(ge.items||ge.purchase_request_items||[]).reduce((e,t)=>String(t.id)===a?e+n:e+(t.expenditure_amount||0),0);if(await At.from("purchase_requests").update({total_expenditure_amount:o}).eq("id",s),ge?.id){C(ge.id,r,k(t),n)||c.warn("[PurchaseDetailModal] 메모리 캐시 지출 정보 업데이트 실패",{purchaseId:ge.id,itemId:r})}J.success(`"${i.item_name}" 품목의 지출 정보가 저장되었습니다.`),await nn();const l=M?.(!0,{silent:!0});l instanceof Promise&&await l}catch(o){c.error("지출 정보 입력 중 오류",o),J.error("지출 정보 입력 중 오류가 발생했습니다.")}},Pn=(e,t,n,a)=>{const s=a||e?.stableKey||lt(e,t),c={className:`px-2 sm:px-3 py-1 border-b border-gray-50 hover:bg-gray-50/50 relative overflow-visible w-fit ${fe?"pl-7 sm:pl-8":""} ${n?.isDragging?"shadow-lg ring-2 ring-blue-200 bg-white":""}`,key:s};return n?.setNodeRef&&(c.ref=n.setNodeRef),n?.style&&(c.style=n.style),r.jsxs("div",{...c,children:[fe&&n&&r.jsx("button",{className:"absolute left-1 top-2 sm:top-3 text-gray-400 hover:text-gray-600 p-1 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-200",...n.attributes,...n.listeners,"aria-label":"드래그하여 품목 순서 변경",children:r.jsx(ie,{className:"w-3.5 h-3.5"})}),r.jsxs("div",{className:"hidden sm:grid items-center gap-1 overflow-visible w-fit",style:{gridTemplateColumns:yn()},children:[r.jsx("div",{className:"flex justify-center items-center text-[11px] text-gray-500 font-medium -ml-2 sm:-ml-3",children:e.line_number||t+1}),r.jsx("div",{className:"min-w-0 relative overflow-visible flex items-center",children:fe?r.jsx(T,{value:e.item_name,onChange:e=>En(t,"item_name",e.target.value),onFocus:()=>Re(`item_name_${t}`),onBlur:()=>Re(null),className:"modal-label border-gray-200 rounded-lg w-full !px-1.5 !py-0.5 !text-[10px] focus:border-blue-400 transition-all duration-200 "+($e===`item_name_${t}`?"!h-auto !min-h-[20px] !absolute !z-[9999] !bg-white !shadow-lg !left-0 !right-0 !-translate-y-1/2 !top-1/2 !whitespace-normal":"!h-5 !truncate"),placeholder:"품목명"}):r.jsx("div",{className:"modal-value",style:{whiteSpace:"normal",wordBreak:"break-all",overflowWrap:"break-word",hyphens:"none",WebkitHyphens:"none",MozHyphens:"none",msHyphens:"none",lineHeight:"1.4",maxHeight:"2.8em",overflow:"hidden",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical"},title:e.item_name||"품목명 없음",children:e.item_name||"품목명 없음"})}),r.jsx("div",{className:"min-w-0 relative overflow-visible flex items-center w-full",children:fe?r.jsx(T,{value:e.specification,onChange:e=>En(t,"specification",e.target.value),onFocus:()=>Re(`specification_${t}`),onBlur:()=>Re(null),className:"modal-label border-gray-200 rounded-lg w-full !px-1.5 !py-0.5 !text-[10px] focus:border-blue-400 transition-all duration-200 "+($e===`specification_${t}`?"!h-auto !min-h-[20px] !absolute !z-[9999] !bg-white !shadow-lg !left-0 !right-0 !-translate-y-1/2 !top-1/2 !whitespace-normal":"!h-5 !truncate"),placeholder:"규격"}):r.jsx("div",{className:"text-[11px] text-gray-600 font-medium",style:{whiteSpace:"normal",wordBreak:"break-all",overflowWrap:"break-word",hyphens:"none",WebkitHyphens:"none",MozHyphens:"none",msHyphens:"none",lineHeight:"1.4",maxHeight:"2.8em",overflow:"hidden",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical"},title:e.specification||"-",children:e.specification||"-"})}),r.jsx("div",{className:"text-center min-w-0 flex items-center justify-center",children:fe?"receipt"===I||"done"===I?r.jsxs("div",{className:"flex flex-col items-center gap-0.5 w-full",children:[r.jsx(T,{type:"number",value:e.quantity,onChange:e=>En(t,"quantity",Number(e.target.value)),className:"border-gray-200 rounded-lg text-center w-full !h-5 !px-1.5 !py-0.5 !text-[9px] font-normal text-gray-600 focus:border-blue-400",placeholder:"요청수량",max:"99999",disabled:Ut&&!zt}),r.jsxs("div",{className:"flex items-center gap-0.5 w-full",children:[r.jsx("span",{className:"text-[9px] text-gray-500",children:"/"}),r.jsx(T,{type:"number",value:e.received_quantity??"",onChange:e=>En(t,"received_quantity",e.target.value?Number(e.target.value):null),className:"border-gray-200 rounded-lg text-center flex-1 !h-5 !px-1.5 !py-0.5 !text-[9px] font-normal text-gray-600 focus:border-blue-400",placeholder:"실제입고",max:"99999",disabled:Ut&&!zt})]})]}):r.jsx(T,{type:"number",value:e.quantity,onChange:e=>En(t,"quantity",Number(e.target.value)),className:"border-gray-200 rounded-lg text-center w-full !h-5 !px-1.5 !py-0.5 !text-[9px] font-normal text-gray-600 focus:border-blue-400",placeholder:"수량",max:"99999",disabled:Ut&&!zt}):"receipt"===I||"done"===I?(()=>{const t=e.quantity||0,n=e.received_quantity??0,a=n>0;return t>=100||n>=100?r.jsxs("div",{className:"flex flex-col items-center leading-tight",children:[r.jsx("div",{className:"modal-subtitle "+(a?"text-gray-400":""),children:t}),r.jsxs("div",{className:"modal-subtitle "+(a?"":"text-gray-400"),children:["/",n]})]}):r.jsxs("span",{className:"modal-subtitle",children:[r.jsx("span",{className:a?"text-gray-400":"",children:t}),r.jsxs("span",{className:a?"":"text-gray-400",children:["/",n]})]})})():r.jsx("span",{className:"modal-subtitle",children:e.quantity||0})}),r.jsx("div",{className:"text-right min-w-0 flex items-center justify-end",children:fe?r.jsx(T,{type:"number",value:e.unit_price_value??0,onChange:e=>En(t,"unit_price_value",Number(e.target.value)),onWheel:e=>e.currentTarget.blur(),className:"border-gray-200 rounded-lg text-right w-full !h-5 !px-1.5 !py-0.5 !text-[9px] font-normal text-gray-600 focus:border-blue-400",placeholder:"단가",max:"100000000000"}):r.jsx("span",{className:"modal-subtitle",children:"done"!==I||Kt?Mn(e.unit_price_value??0,Dn(e)):"-"})}),r.jsx("div",{className:"text-right min-w-0 flex items-center justify-end",children:fe?r.jsx(T,{type:"number",value:e.amount_value||0,onChange:e=>En(t,"amount_value",Number(e.target.value)),onWheel:e=>e.currentTarget.blur(),className:"border-gray-200 rounded-lg w-full !h-6 !px-1.5 !py-0.5 !text-[10px] font-normal text-gray-600 focus:border-blue-400 text-right",placeholder:"합계"}):r.jsx("span",{className:"modal-value",children:"done"!==I||Kt?Mn(e.amount_value||0,Dn(e)):"-"})}),"발주"===ge?.payment_category&&r.jsx("div",{className:"text-right min-w-0 flex items-center justify-end",children:r.jsx("span",{className:fe?"modal-subtitle":"modal-value",children:"done"!==I||Kt?Mn(e.tax_amount_value||0,Dn(e)):"-"})}),r.jsx("div",{className:"text-center min-w-0 flex items-center justify-center",children:fe?r.jsx(T,{value:e.link||"",onChange:e=>En(t,"link",e.target.value),className:"border-gray-200 rounded-lg text-center w-full !h-5 !px-1.5 !py-0.5 !text-[9px] font-normal text-gray-600 focus:border-blue-400",placeholder:"링크(URL)"}):e.link?r.jsx("a",{href:e.link,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:text-blue-800 underline text-[11px]",onClick:e=>e.stopPropagation(),children:"링크"}):r.jsx("span",{className:"text-gray-400 text-[11px]",children:"-"})}),r.jsx("div",{className:"min-w-0 flex justify-center items-center text-center relative overflow-visible",style:{width:"150px",maxWidth:"150px",minWidth:"150px"},children:fe?r.jsx(T,{value:e.remark||"",disabled:!zt&&!Ut,onChange:e=>En(t,"remark",e.target.value),onFocus:()=>Re(`remark_${t}`),onBlur:()=>Re(null),className:"modal-label border-gray-200 rounded-lg text-center w-full !px-1.5 !py-0.5 !text-[10px] focus:border-blue-400 transition-all duration-200 "+($e===`remark_${t}`?"!h-auto !min-h-[20px] !absolute !z-[9999] !bg-white !shadow-lg !left-0 !right-0 !-translate-y-1/2 !top-1/2 !whitespace-normal !text-left":"!h-5 !truncate"),placeholder:"비고"}):r.jsx("div",{className:"text-[11px] text-gray-600 font-medium",style:{width:"150px",maxWidth:"150px",minWidth:"150px",boxSizing:"border-box",whiteSpace:"normal",wordBreak:"break-all",overflowWrap:"break-word",hyphens:"none",WebkitHyphens:"none",MozHyphens:"none",msHyphens:"none",lineHeight:"1.4",maxHeight:"2.8em",overflow:"hidden",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical"},title:e.remark||"-",children:e.remark||"-"})}),"pending"!==I&&r.jsx("div",{className:"text-center flex justify-center items-center",children:fe?r.jsx(i,{size:"sm",variant:"ghost",onClick:()=>(e=>{const t=we[e];t.id&&Se([...je,t.id]);const n=we.filter((t,n)=>n!==e).sort((e,t)=>(e.line_number||999999)-(t.line_number||999999)).map((e,t)=>({...e,line_number:t+1,stableKey:e.stableKey??ct(e,t)}));Ne(n)})(t),className:"text-red-600 hover:bg-red-50 rounded-lg p-1 h-6 w-6",disabled:Ut&&!zt,children:r.jsx(te,{className:"w-3 h-3"})}):r.jsxs(r.Fragment,{children:["purchase"===I&&r.jsx("div",{className:"flex flex-col items-center gap-1",children:r.jsx("div",{className:"flex justify-center",children:Yt?r.jsx("button",{onClick:()=>Tn(e.id,!e.is_payment_completed),className:""+(e.is_payment_completed?"button-toggle-active bg-orange-500 hover:bg-orange-600 text-white":"button-toggle-inactive"),children:e.is_payment_completed?"구매완료":"구매대기"}):r.jsx("span",{className:""+(e.is_payment_completed?"button-toggle-active bg-orange-500 text-white":"button-waiting-inactive"),children:e.is_payment_completed?"구매완료":"구매대기"})})}),"receipt"===I&&r.jsx("div",{className:"flex justify-center",children:Xt?mn.isCompleted(e)?r.jsx("button",{onClick:()=>{mn.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-action-primary",children:mn.config.completedText}):mn.isPartiallyReceived(e)?r.jsx(zn,{onConfirm:(t,n)=>{On(e.id,t,n)},placeholder:"추가 입고수량을 입력하세요",align:"center",side:"bottom",maxQuantity:mn.getRemainingQuantity(e),quantityInfoText:`미입고: ${mn.getRemainingQuantity(e)}개`,allowOverMaxQuantity:!0,children:r.jsx("button",{className:"button-base bg-blue-300 hover:bg-blue-400 text-white",children:"부분입고"})}):r.jsx(zn,{onConfirm:(t,n)=>{On(e.id,t,n)},placeholder:"날짜와 실제입고수량을 입력하세요",align:"center",side:"bottom",defaultQuantity:e.received_quantity??void 0,maxQuantity:e.quantity,allowOverMaxQuantity:!0,children:r.jsx("button",{className:"button-toggle-inactive",children:mn.config.waitingText})}):r.jsx("span",{className:""+(mn.isCompleted(e)?"button-action-primary":mn.isPartiallyReceived(e)?"button-base bg-blue-300 text-white":"button-waiting-inactive"),children:mn.isCompleted(e)?mn.config.completedText:mn.isPartiallyReceived(e)?"부분입고":mn.config.waitingText})}),"done"===I&&r.jsx("div",{className:"flex justify-center",children:Xt?mn.isCompleted(e)?r.jsx("button",{onClick:()=>{mn.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-base bg-blue-500 hover:bg-blue-600 text-white",children:mn.config.completedText}):mn.isPartiallyReceived(e)?r.jsx(zn,{onConfirm:(t,n)=>{On(e.id,t,n)},placeholder:"추가 입고수량을 입력하세요",align:"center",side:"bottom",maxQuantity:mn.getRemainingQuantity(e),quantityInfoText:`미입고: ${mn.getRemainingQuantity(e)}개`,allowOverMaxQuantity:!0,children:r.jsx("button",{className:"button-base bg-blue-300 hover:bg-blue-400 text-white",children:"부분입고"})}):r.jsx($,{onDateSelect:t=>{mn.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"실제 입고된 날짜를 선택하세요",align:"center",side:"bottom",children:r.jsx("button",{className:"button-base border border-gray-300 text-gray-600 bg-white hover:bg-gray-50",children:mn.config.waitingText})}):r.jsx("span",{className:"button-base "+(mn.isCompleted(e)?"bg-blue-500 hover:bg-blue-600 text-white":mn.isPartiallyReceived(e)?"bg-blue-300 text-white":"border border-gray-300 text-gray-600 bg-white hover:bg-gray-50"),children:mn.isCompleted(e)?"입고완료":mn.isPartiallyReceived(e)?"부분입고":"입고대기"})}),"purchase"!==I&&"receipt"!==I&&"done"!==I&&r.jsx("div",{className:"flex justify-center",children:r.jsx("span",{className:"badge-text",children:"-"})})]})}),"receipt"===I&&r.jsx("div",{className:"text-center flex justify-center items-center pl-2",children:mn.getCompletedDate(e)?r.jsx("div",{className:"modal-subtitle text-green-700",children:new Date(mn.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})}):r.jsx("span",{className:"modal-subtitle text-gray-400",children:"-"})}),Vt&&r.jsx("div",{className:"text-center flex justify-center items-center",children:Zt?un.isCompleted(e)?r.jsx("button",{onClick:()=>{un.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-action-primary hover:bg-green-600",title:"클릭하여 거래명세서 확인 취소",children:un.config.completedText}):r.jsx($,{onDateSelect:t=>{un.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"회계상 입고일을 선택하세요",align:"center",side:"bottom",children:r.jsx("button",{className:"button-toggle-inactive",onClick:()=>{},children:un.config.waitingText})}):r.jsx("span",{className:""+(un.isCompleted(e)?"button-action-primary":"button-waiting-inactive"),children:un.isCompleted(e)?un.config.completedText:un.config.waitingText})}),Vt&&r.jsx("div",{className:"text-center flex justify-center items-center",children:un.getCompletedDate(e)?r.jsx("div",{className:"modal-subtitle text-blue-700",children:new Date(un.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})}):r.jsx("span",{className:"modal-subtitle text-gray-400",children:"-"})}),Ht&&r.jsx("div",{className:"text-center flex justify-center items-center",children:(()=>{const t=!!e.expenditure_date,n=null!==e.expenditure_amount&&void 0!==e.expenditure_amount;return Zt?t?r.jsxs("div",{className:"w-full px-1 leading-none",children:[r.jsx("div",{className:"text-blue-700 text-[9px] leading-[1.1] font-normal",children:(()=>{const t=new Date(e.expenditure_date);return`${t.getFullYear().toString().slice(-2)}.${(t.getMonth()+1).toString().padStart(2,"0")}.${t.getDate().toString().padStart(2,"0")}`})()}),r.jsx("div",{className:"text-gray-700 text-[9px] leading-[1.1] font-normal",children:Kt?n?`₩${Number(e.expenditure_amount).toLocaleString()}`:"":"-"})]}):r.jsx(Fn,{onConfirm:(t,n)=>Ln(e.id,t,n),placeholder:"지출 날짜와 금액을 입력하세요",align:"center",side:"bottom",children:r.jsx("button",{className:"button-toggle-inactive",children:"지출입력"})}):t?r.jsxs("div",{className:"w-full px-1 leading-none",children:[r.jsx("div",{className:"text-blue-700 text-[9px] leading-[1.1] font-normal",children:(()=>{const t=new Date(e.expenditure_date);return`${t.getFullYear().toString().slice(-2)}.${(t.getMonth()+1).toString().padStart(2,"0")}.${t.getDate().toString().padStart(2,"0")}`})()}),r.jsx("div",{className:"text-gray-700 text-[9px] leading-[1.1] font-normal",children:Kt?n?`₩${Number(e.expenditure_amount).toLocaleString()}`:"":"-"})]}):r.jsx("span",{className:"modal-subtitle text-gray-400",children:"-"})})()})]}),r.jsxs("div",{className:"block sm:hidden space-y-2",children:[r.jsxs("div",{className:"flex justify-between items-start",children:[r.jsxs("div",{className:"flex-1 min-w-0 relative",children:[fe?r.jsx(T,{value:e.item_name,onChange:e=>En(t,"item_name",e.target.value),onFocus:()=>Re(`m_item_name_${t}`),onBlur:()=>Re(null),className:"modal-label border-gray-200 rounded-lg w-full !px-1.5 !py-0.5 !text-[10px] focus:border-blue-400 transition-all duration-200 "+($e===`m_item_name_${t}`?"!h-auto !min-h-[20px] !absolute !z-[9999] !bg-white !shadow-lg !left-0 !right-0 !-translate-y-1/2 !top-1/2 !whitespace-normal":"!h-5 !truncate"),placeholder:"품목명"}):r.jsx("div",{className:"modal-value font-medium",children:e.item_name||"품목명 없음"}),fe?r.jsx(T,{value:e.specification,onChange:e=>En(t,"specification",e.target.value),onFocus:()=>Re(`m_specification_${t}`),onBlur:()=>Re(null),className:"modal-label border-gray-200 rounded-lg mt-1 w-full !px-1.5 !py-0.5 !text-[10px] focus:border-blue-400 transition-all duration-200 "+($e===`m_specification_${t}`?"!h-auto !min-h-[20px] !absolute !z-[9999] !bg-white !shadow-lg !left-0 !right-0 !-translate-y-1/2 !top-1/2 !whitespace-normal !w-full":"!h-5 !truncate"),placeholder:"규격"}):r.jsx("div",{className:"modal-subtitle text-gray-500",children:e.specification||"-"})]}),r.jsxs("div",{className:"ml-3 text-right flex-shrink-0",children:[fe?r.jsx(T,{type:"number",value:e.amount_value||0,onChange:e=>En(t,"amount_value",Number(e.target.value)),onWheel:e=>e.currentTarget.blur(),className:"border-gray-200 rounded-lg w-24 !h-6 !px-1.5 !py-0.5 !text-[10px] font-normal text-gray-600 focus:border-blue-400 text-right",placeholder:"합계"}):r.jsx("div",{className:"modal-value font-semibold",children:Mn(e.amount_value||0,Dn(e))}),r.jsxs("div",{className:"text-[10px] text-gray-500 mt-0.5",children:["done"!==I||Kt?`${Mn(e.unit_price_value||0,Dn(e))}`:"-"," / 단가"]})]})]}),r.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[r.jsxs("div",{children:[r.jsx("span",{className:"text-gray-500 text-xs",children:"수량"}),fe?"receipt"===I||"done"===I?r.jsxs("div",{className:"grid grid-cols-2 gap-1 mt-1",children:[r.jsx(T,{type:"number",value:e.quantity,onChange:e=>En(t,"quantity",Number(e.target.value)),className:"border-gray-200 rounded-lg text-center w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"요청수량",max:"99999"}),r.jsx(T,{type:"number",value:e.received_quantity??"",onChange:e=>En(t,"received_quantity",e.target.value?Number(e.target.value):null),className:"border-gray-200 rounded-lg text-center w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"실제입고",max:"99999"})]}):r.jsx(T,{type:"number",value:e.quantity,onChange:e=>En(t,"quantity",Number(e.target.value)),className:"border-gray-200 rounded-lg text-center w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400 mt-1",placeholder:"수량",max:"99999"}):r.jsx("div",{className:"modal-subtitle mt-1",children:"receipt"===I||"done"===I?r.jsxs(r.Fragment,{children:[r.jsx("span",{className:"text-gray-500",children:e.quantity||0}),r.jsxs("span",{className:"text-gray-400",children:["/",e.received_quantity??0]})]}):e.quantity||0})]}),r.jsxs("div",{children:[r.jsx("span",{className:"text-gray-500 text-xs",children:"링크"}),r.jsx("div",{className:"mt-1",children:fe?r.jsx(T,{value:e.link||"",onChange:e=>En(t,"link",e.target.value),className:"border-gray-200 rounded-lg text-center w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"링크(URL)"}):e.link?r.jsx("a",{href:e.link,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:text-blue-800 underline text-[11px] break-all",onClick:e=>e.stopPropagation(),children:e.link}):r.jsx("span",{className:"text-gray-400 text-[11px]",children:"-"})})]})]}),r.jsxs("div",{className:"grid grid-cols-2 gap-2 items-center",children:[r.jsxs("div",{children:[r.jsx("span",{className:"text-gray-500 text-xs",children:"상태"}),r.jsx("div",{className:"mt-1",children:"pending"===I?r.jsx("span",{className:"text-xs text-gray-400",children:"-"}):r.jsxs(r.Fragment,{children:["purchase"===I&&r.jsx("div",{className:"flex items-center gap-2",children:Yt?r.jsx("button",{onClick:()=>Tn(e.id,!e.is_payment_completed),className:"text-xs px-2 py-1 rounded "+(e.is_payment_completed?"button-action-primary":"bg-gray-100 text-gray-600"),children:e.is_payment_completed?"구매완료":"구매대기"}):r.jsx("span",{className:"text-xs px-2 py-1 rounded "+(e.is_payment_completed?"button-action-primary":"bg-gray-100 text-gray-400"),children:e.is_payment_completed?"구매완료":"구매대기"})}),"receipt"===I&&r.jsx("div",{className:"flex items-center gap-2",children:Xt?mn.isCompleted(e)?r.jsx("button",{onClick:()=>{mn.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"text-xs px-2 py-1 rounded button-action-primary",children:mn.config.completedText}):r.jsx($,{onDateSelect:t=>{mn.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"실제 입고된 날짜를 선택하세요",align:"center",side:"bottom",children:r.jsx("button",{className:"text-xs px-2 py-1 rounded bg-gray-100 text-gray-600",children:mn.config.waitingText})}):r.jsx("span",{className:"text-xs px-2 py-1 rounded "+(mn.isCompleted(e)?"button-action-primary":"bg-gray-100 text-gray-400"),children:mn.isCompleted(e)?mn.config.completedText:mn.config.waitingText})}),"done"===I&&r.jsx(r.Fragment,{children:r.jsx("span",{className:"button-base "+(mn.isCompleted(e)?"bg-green-500 text-white":"border border-gray-300 text-gray-600 bg-white"),children:mn.isCompleted(e)?"입고완료":"입고대기"})}),"purchase"!==I&&"receipt"!==I&&"done"!==I&&r.jsx("span",{className:"text-xs text-gray-400",children:"-"})]})})]}),(e.remark||fe)&&r.jsxs("div",{children:[r.jsx("span",{className:"text-gray-500 text-xs",children:"비고:"}),fe?r.jsx(T,{value:e.remark||"",onChange:e=>En(t,"remark",e.target.value),className:"modal-label border-gray-200 rounded-lg mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"비고"}):r.jsx("div",{className:"modal-subtitle text-gray-500 mt-1",children:e.remark||"-"})]})]}),!fe&&"receipt"===I&&mn.getCompletedDate(e)&&r.jsxs("div",{children:[r.jsx("span",{className:"text-gray-500 text-xs",children:"실제입고일:"}),r.jsxs("div",{className:"mt-1",children:[r.jsx("div",{className:"modal-subtitle text-green-700",children:new Date(mn.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})}),r.jsx("div",{className:"text-[9px] text-gray-500",children:new Date(mn.getCompletedDate(e)).toLocaleTimeString("ko-KR",{hour:"2-digit",minute:"2-digit"})})]})]}),!fe&&Vt&&r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("span",{className:"text-gray-500 text-xs",children:"거래명세서 확인:"}),r.jsx("div",{className:"flex items-center gap-2",children:Zt?un.isCompleted(e)?r.jsx("button",{onClick:()=>{un.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"text-xs px-2 py-1 rounded button-action-primary",children:un.config.completedText}):r.jsx($,{onDateSelect:t=>{un.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"회계상 입고일을 선택하세요",align:"center",side:"bottom",children:r.jsx("button",{className:"text-xs px-2 py-1 rounded bg-gray-100 text-gray-600",children:un.config.waitingText})}):r.jsx("span",{className:"text-xs px-2 py-1 rounded "+(un.isCompleted(e)?"button-action-primary":"bg-gray-100 text-gray-400"),children:un.isCompleted(e)?un.config.completedText:un.config.waitingText})})]}),!fe&&Vt&&un.getCompletedDate(e)&&r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("span",{className:"text-gray-500 text-xs",children:"회계상 입고일:"}),r.jsx("span",{className:"modal-subtitle text-blue-700",children:new Date(un.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})})]}),!fe&&Ht&&r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("span",{className:"text-gray-500 text-xs",children:"지출정보:"}),r.jsx("div",{className:"text-right",children:e.expenditure_date?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"text-blue-700 text-[11px]",children:(()=>{const t=new Date(e.expenditure_date);return`${t.getFullYear().toString().slice(-2)}.${(t.getMonth()+1).toString().padStart(2,"0")}.${t.getDate().toString().padStart(2,"0")}`})()}),r.jsx("div",{className:"text-gray-700 text-[11px]",children:Kt?null!==e.expenditure_amount&&void 0!==e.expenditure_amount?`₩${Number(e.expenditure_amount).toLocaleString()}`:"":"-"})]}):r.jsx("span",{className:"text-gray-400 text-[11px]",children:"-"})})]})]})]})},An=r.jsx("div",{className:"space-y-1 sm:space-y-4",children:he?r.jsx("div",{className:"flex items-center justify-center py-12",children:r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-hansl-600"})}):ge?r.jsxs("div",{children:[r.jsx("div",{className:"bg-gray-50 rounded-lg p-2 sm:p-3 mb-1 sm:mb-2 border border-gray-100",children:r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 items-center gap-3 sm:gap-0",children:[r.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-4",children:[r.jsxs("div",{className:"flex items-center gap-3",children:[(()=>{if(!ge)return null;if(ge.payment_category){const e=ge.payment_category.trim();return"발주"===e?r.jsx("span",{className:"badge-stats bg-green-500 text-white",children:"발주"}):"구매요청"===e?r.jsx("span",{className:"badge-stats bg-blue-500 text-white",children:"구매요청"}):"현장결제"===e?r.jsx("span",{className:"badge-stats bg-gray-500 text-white",children:"현장결제"}):r.jsx("span",{className:"badge-stats bg-blue-500 text-white",children:e})}return r.jsx("span",{className:"badge-stats bg-blue-500 text-white",children:"구매요청"})})(),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("span",{className:"modal-label",children:"요청자:"}),r.jsx("span",{className:"modal-value",children:ge.requester_name})]})]}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(G,{className:"w-3 h-3 text-gray-500"}),r.jsxs("span",{className:"modal-subtitle",children:["청구일: ",D(ge.request_date)]})]})]}),r.jsxs("div",{className:"flex items-center justify-center gap-2 sm:gap-3 flex-wrap",children:[pn&&"pending"===ge.middle_manager_status&&r.jsx(i,{size:"sm",variant:"outline",onClick:()=>Wn("middle"),className:`${_n} border border-gray-400 bg-white hover:bg-gray-50 hover:border-gray-500`,children:"1차 승인 대기"}),"approved"===ge.middle_manager_status&&r.jsxs("div",{className:"button-approved badge-text shadow-sm",children:[r.jsx(Z,{className:"w-3 h-3"}),"1차 승인완료"]}),"rejected"===ge.middle_manager_status&&r.jsxs("div",{className:"button-rejected badge-text",children:[r.jsx(g,{className:"w-3 h-3"}),"1차 반려"]}),"pending"===ge.middle_manager_status&&!pn&&r.jsx("div",{className:`${gn} border border-gray-300 text-gray-600 bg-white`,children:"1차 승인대기"}),hn&&"approved"===ge.middle_manager_status&&"pending"===ge.final_manager_status&&r.jsxs(i,{size:"sm",variant:"outline",onClick:()=>Wn("final"),className:`${_n} border border-gray-400 bg-white hover:bg-gray-50 hover:border-gray-500`,children:[r.jsx(Z,{className:"w-3 h-3"}),"최종 승인"]}),"approved"===ge.final_manager_status&&r.jsxs("div",{className:"button-approved badge-text",children:[r.jsx(Z,{className:"w-3 h-3"}),"최종 승인완료"]}),"rejected"===ge.final_manager_status&&r.jsxs("div",{className:"button-rejected badge-text",children:[r.jsx(g,{className:"w-3 h-3"}),"최종 반려"]}),"approved"!==ge.middle_manager_status&&"pending"===ge.final_manager_status&&r.jsx("div",{className:`${gn} border border-gray-300 text-gray-600 bg-white`,children:"최종 승인대기"})]}),r.jsx("div",{})]})}),r.jsxs("div",{className:"flex flex-col lg:flex-row gap-3 sm:gap-6",children:[r.jsxs("div",{className:"lg:w-80 lg:flex-shrink-0 space-y-1 sm:space-y-4 relative",children:[r.jsxs("div",{className:"bg-white rounded-lg p-2 sm:p-3 border border-gray-100 shadow-sm",children:[r.jsx("div",{className:"mb-3",children:r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("h3",{className:"modal-section-title flex items-center",children:[r.jsx(v,{className:"w-4 h-4 mr-2 text-gray-600"}),ge?.purchase_order_number||"PO번호 없음"]}),Zt&&Kt&&("done"===I||"receipt"===I)&&r.jsxs("button",{onClick:an,className:"button-base text-xs px-2 py-1 flex items-center "+(ge?.is_utk_checked?"button-toggle-active bg-orange-500 hover:bg-orange-600 text-white":"button-toggle-inactive"),title:ge?.is_utk_checked?"UTK 확인 취소":"UTK 확인",children:[r.jsx(ae,{className:"w-3 h-3 mr-1"}),"UTK ",ge?.is_utk_checked?"완료":"확인"]})]})}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[r.jsxs("div",{className:"w-32",children:[r.jsx("span",{className:"modal-label",children:"발주서 종류"}),fe?r.jsx(T,{value:be?.request_type||"",onChange:e=>ye(t=>t?{...t,request_type:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"일반",disabled:Ut&&!zt}):r.jsx("p",{className:"modal-value",children:ge.request_type||"일반"})]}),r.jsxs("div",{className:"w-32",children:[r.jsx("span",{className:"modal-label",children:"결제 종류"}),fe?r.jsx(T,{value:be?.payment_category||"",onChange:e=>ye(t=>t?{...t,payment_category:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"발주/구매요청/현장결제",disabled:Ut&&!zt}):r.jsx("p",{className:"modal-value",children:ge.payment_category||"-"})]})]}),r.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[r.jsxs("div",{className:"w-32",children:[r.jsx("span",{className:"modal-label",children:"입고 요청일"}),fe?r.jsx($,{onDateSelect:e=>{ye(t=>t?{...t,delivery_request_date:R(e,"yyyy-MM-dd")}:null)},placeholder:"입고 요청일을 선택하세요",align:"start",side:"bottom",children:r.jsxs(i,{variant:"outline",className:"mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] justify-start text-left font-normal business-radius-input",disabled:Ut&&!zt,children:[r.jsx(G,{className:"mr-1 h-3 w-3"}),be?.delivery_request_date?D(be.delivery_request_date):"날짜 선택"]})}):r.jsx("p",{className:"modal-subtitle",children:D(ge.delivery_request_date)})]}),r.jsxs("div",{className:"w-32",children:[r.jsx("span",{className:"modal-label text-orange-500",children:"변경 입고일"}),fe?r.jsx($,{onDateSelect:e=>{ye(t=>t?{...t,revised_delivery_request_date:R(e,"yyyy-MM-dd")}:null)},placeholder:"변경 입고일을 선택하세요",align:"start",side:"bottom",children:r.jsxs(i,{variant:"outline",className:"mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] justify-start text-left font-normal business-radius-input",disabled:Ut&&!zt,children:[r.jsx(G,{className:"mr-1 h-3 w-3"}),be?.revised_delivery_request_date?D(be.revised_delivery_request_date):"날짜 선택"]})}):r.jsx("p",{className:"modal-subtitle text-orange-700",children:ge.revised_delivery_request_date?D(ge.revised_delivery_request_date):"미설정"})]})]})]})]}),r.jsxs("div",{className:"bg-white rounded-lg p-2 sm:p-3 border border-gray-100 shadow-sm",children:[r.jsxs("h3",{className:"modal-section-title mb-3 flex items-center",children:[r.jsx(f,{className:"w-4 h-4 mr-2 text-gray-600"}),"업체 정보"]}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[r.jsxs("div",{className:"w-32",children:[r.jsx("span",{className:"modal-label",children:"업체명"}),fe?r.jsx(E,{options:Ee.map(e=>({value:e.id.toString(),label:e.vendor_name})),value:be?.vendor_id?{value:be.vendor_id.toString(),label:be.vendor_name||Ee.find(e=>e.id===be.vendor_id)?.vendor_name||""}:null,isDisabled:Ut&&!zt,onChange:e=>{if(c.info("ReactSelect onChange:",{option:e}),e){const t=Ee.find(t=>t.id.toString()===e.value);if(c.info("Selected vendor:",{selectedVendor:t}),t){s().from("vendor_contacts").select("id, contact_name, contact_email, contact_phone, position").eq("vendor_id",t.id).then(({data:e,error:n})=>{n&&c.error("담당자 목록 로드 오류:",n),c.info("🔍 업체 변경 - 담당자 목록 로드:",{vendor_id:t.id,vendor_name:t.vendor_name,contactsData:e,contactsCount:e?.length||0}),c.debug("업체 변경 - 담당자 목록:",e),ye(n=>{const a=n?{...n,vendor_id:t.id,vendor_name:t.vendor_name,vendor:t,vendor_contacts:Array.isArray(e)?e:[],contact_id:void 0,contact_name:void 0}:null;return c.info("🔍 업체 변경 - editedPurchase 업데이트 완료:",{vendor_id:t.id,vendor_name:t.vendor_name,contactsData:e,updated_vendor_contacts:a?.vendor_contacts,updated_full:a}),c.debug("업체 변경 - editedPurchase 전체:",{updated:a}),a})})}}else ye(e=>e?{...e,vendor_id:void 0,vendor_name:"",vendor:void 0,vendor_contacts:[],contact_id:void 0,contact_name:void 0}:null)},placeholder:"업체 선택",isClearable:!0,isSearchable:!0,menuPortalTarget:document.body,styles:{control:e=>({...e,minHeight:"20px",height:"20px",fontSize:"10px",borderRadius:"8px",borderColor:"#e5e7eb",borderWidth:"1px",backgroundColor:"#ffffff",boxShadow:"none",paddingLeft:"6px",paddingRight:"6px","&:hover":{borderColor:"#e5e7eb"},"&:focus-within":{borderColor:"#60a5fa",boxShadow:"none",outline:"none"}}),valueContainer:e=>({...e,height:"18px",padding:"0 2px",margin:"0"}),input:e=>({...e,margin:"0",padding:"0",fontSize:"10px"}),indicatorsContainer:e=>({...e,height:"18px",padding:"0"}),indicatorSeparator:()=>({display:"none"}),dropdownIndicator:e=>({...e,padding:"0 2px",svg:{width:"12px",height:"12px"}}),clearIndicator:e=>({...e,padding:"0 2px",svg:{width:"12px",height:"12px"}}),option:e=>({...e,fontSize:"10px",padding:"4px 8px"}),menuPortal:e=>({...e,zIndex:9999})},classNamePrefix:"vendor-select"}):r.jsx("p",{className:"modal-value",children:ge.vendor?.vendor_name||"-"})]}),r.jsxs("div",{className:"w-32",children:[r.jsx("span",{className:"modal-label",children:"업체 담당자"}),fe?be?.vendor_id?r.jsx(E,{isDisabled:Ut&&!zt,options:(()=>{const e=Array.isArray(be.vendor_contacts)?be.vendor_contacts:[],t=e.filter((e,t,n)=>n.findIndex(t=>t.id===e.id)===t),n=t.filter((e,t,n)=>n.findIndex(t=>t.contact_name===e.contact_name)===t),a=n.map(e=>({value:e.id.toString(),label:e.contact_name||""}))||[];return c.info("🔍 담당자 드롭다운 옵션:",{vendor_id:be.vendor_id,vendor_contacts_raw:be.vendor_contacts,vendor_contacts_count:e.length,unique_by_id_count:t.length,final_unique_count:n.length,options:a}),c.debug("담당자 드롭다운 옵션:",{options:a}),a})(),value:(()=>{const e=(Array.isArray(be.vendor_contacts)?be.vendor_contacts:[])[0];return e?.id?{value:e.id.toString(),label:e.contact_name||""}:null})(),onChange:e=>{if(c.info("🔍 담당자 선택 변경:",{option:e}),e){const t=Array.isArray(be.vendor_contacts)?be.vendor_contacts:[],n=t.find(t=>t.id.toString()===e.value);n&&ye(e=>e?{...e,contact_id:n.id,contact_name:n.contact_name,vendor_contacts:[n,...t.filter(e=>e.id!==n.id)]}:null)}else ye(e=>e?{...e,contact_id:void 0,contact_name:void 0,vendor_contacts:Array.isArray(be.vendor_contacts)?be.vendor_contacts:[]}:null)},placeholder:"담당자를 선택하세요",isClearable:!0,isSearchable:!0,noOptionsMessage:()=>"담당자가 없습니다",menuPortalTarget:document.body,styles:{control:e=>({...e,minHeight:"20px",height:"20px",fontSize:"10px",borderRadius:"8px",borderColor:"#e5e7eb",borderWidth:"1px",backgroundColor:"#ffffff",boxShadow:"none",paddingLeft:"6px",paddingRight:"6px","&:hover":{borderColor:"#e5e7eb"},"&:focus-within":{borderColor:"#60a5fa",boxShadow:"none",outline:"none"}}),valueContainer:e=>({...e,height:"18px",padding:"0 2px",margin:"0"}),input:e=>({...e,margin:"0",padding:"0",fontSize:"10px"}),indicatorsContainer:e=>({...e,height:"18px",padding:"0"}),indicatorSeparator:()=>({display:"none"}),dropdownIndicator:e=>({...e,padding:"0 2px",svg:{width:"12px",height:"12px"}}),clearIndicator:e=>({...e,padding:"0 2px",svg:{width:"12px",height:"12px"}}),option:e=>({...e,fontSize:"10px",padding:"4px 8px"}),menuPortal:e=>({...e,zIndex:9999})},classNamePrefix:"contact-select"}):r.jsx(T,{value:"",disabled:!0,className:"mt-1 rounded-lg border-gray-200 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"업체를 먼저 선택하세요"}):r.jsx("p",{className:"modal-value",children:(()=>{const e=Array.isArray(ge.vendor_contacts)?ge.vendor_contacts:[],t=ge.contact_name||e[0]?.contact_name||"-";return c.info("🔍 vendor_contacts display 렌더링:",{purchase_id:ge?.id,vendor_id:ge?.vendor_id,contact_id:ge?.contact_id,vendor_contacts:ge.vendor_contacts,purchase_contact_name:ge.contact_name,contactName:t,purchase_full:ge}),c.debug("vendor_contacts display 렌더링:",{purchase_id:ge?.id,vendor_id:ge?.vendor_id,contact_id:ge?.contact_id,vendor_contacts:ge.vendor_contacts,purchase_contact_name:ge.contact_name,contactName:t}),t})()})]})]}),r.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[r.jsxs("div",{className:"w-32",children:[r.jsx("span",{className:"modal-label",children:"PJ업체"}),fe?r.jsx(T,{value:be?.project_vendor||"",onChange:e=>ye(t=>t?{...t,project_vendor:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"입력",disabled:Ut&&!zt}):r.jsx("p",{className:"modal-value",children:ge.project_vendor||"-"})]}),r.jsxs("div",{className:"w-32",children:[r.jsx("span",{className:"modal-label",children:"Item"}),fe?r.jsx(T,{value:be?.project_item||"",onChange:e=>ye(t=>t?{...t,project_item:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"입력",disabled:Ut&&!zt}):r.jsx("p",{className:"modal-subtitle break-all whitespace-pre-wrap",style:{whiteSpace:"pre-wrap",wordBreak:"break-all"},children:ge.project_item||"-"})]})]}),r.jsx("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:r.jsxs("div",{className:"w-32",children:[r.jsx("span",{className:"modal-label",children:"수주번호"}),fe?r.jsx(T,{value:be?.sales_order_number||"",onChange:e=>ye(t=>t?{...t,sales_order_number:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"입력",disabled:Ut&&!zt}):r.jsx("p",{className:"modal-subtitle",children:ge.sales_order_number||"-"})]})})]})]}),nt.length>0&&r.jsxs("div",{className:"bg-white rounded-lg p-2 sm:p-3 border border-gray-100 shadow-sm mt-3",children:[r.jsx("div",{className:"mb-2",children:r.jsxs("h3",{className:"modal-section-title flex items-center",children:[r.jsx(x,{className:"w-4 h-4 mr-2 text-gray-600"}),"연결된 거래명세서",r.jsxs("span",{className:"ml-2 badge-stats bg-green-500 text-white text-[10px]",children:[nt.length,"건"]})]})}),r.jsx("div",{className:"space-y-2",children:nt.map(e=>r.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors",onClick:()=>(e=>{const t=(window.screen.width-1e3)/2,n=(window.screen.height-800)/2;window.open(e,"_blank",`width=1000,height=800,left=${t},top=${n},scrollbars=yes,resizable=yes`)})(e.image_url),children:[r.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[r.jsx(se,{className:"w-4 h-4 text-gray-400 flex-shrink-0"}),r.jsxs("div",{className:"min-w-0",children:[r.jsx("p",{className:"text-xs font-medium text-gray-900 truncate",children:e.vendor_name||e.file_name||"거래명세서"}),r.jsxs("p",{className:"text-[10px] text-gray-500",children:[e.statement_date?D(e.statement_date):D(e.uploaded_at),e.grand_total&&r.jsxs("span",{className:"ml-2 text-gray-700",children:[e.grand_total.toLocaleString(),"원"]})]})]})]}),r.jsx(i,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 flex-shrink-0",title:"이미지 보기",children:r.jsx(se,{className:"w-3 h-3"})})]},e.id))})]})]}),r.jsx("div",{className:"w-full min-w-0 xl:w-fit relative",children:r.jsxs("div",{className:"bg-white rounded-lg border border-gray-100 shadow-sm overflow-hidden",children:[r.jsxs("div",{className:"p-2 sm:p-3 bg-gray-50 border-b border-gray-100 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-0",children:[r.jsxs("h3",{className:"modal-section-title flex items-center",children:[r.jsx(b,{className:"w-4 h-4 mr-2 text-gray-600"}),"품목 리스트",r.jsxs("span",{className:"ml-2 badge-stats bg-gray-500 text-white",children:[Ot?.length||0,"개"]}),fe?r.jsx(E,{isDisabled:Ut&&!zt,options:[{value:"KRW",label:"KRW"},{value:"USD",label:"USD"},{value:"EUR",label:"EUR"},{value:"JPY",label:"JPY"},{value:"CNY",label:"CNY"}],value:be?.currency?{value:be.currency,label:be.currency}:{value:"KRW",label:"KRW"},onChange:e=>{e&&ye(t=>t?{...t,currency:e.value}:null)},menuPortalTarget:document.body,styles:{control:e=>({...e,minHeight:"20px",height:"20px",width:"75px",fontSize:"10px",borderRadius:"8px",borderColor:"#e5e7eb",marginLeft:"8px"}),valueContainer:e=>({...e,padding:"0 6px",height:"20px"}),singleValue:e=>({...e,margin:0,position:"absolute",top:"50%",transform:"translateY(-50%)"}),input:e=>({...e,margin:0,padding:0}),indicatorsContainer:e=>({...e,height:"20px"}),indicatorSeparator:()=>({display:"none"}),dropdownIndicator:e=>({...e,padding:"0 4px"}),option:e=>({...e,fontSize:"10px",padding:"4px 8px"}),menuPortal:e=>({...e,zIndex:9999})}}):r.jsx("span",{className:"ml-2 badge-stats bg-blue-500 text-white",children:ge.currency||"KRW"})]}),!fe&&r.jsxs(r.Fragment,{children:["purchase"===I&&Yt&&r.jsxs(i,{size:"sm",onClick:async()=>{if(!ge||!Yt)return;const e=`발주번호: ${ge.purchase_order_number}\n\n전체 구매완료 처리하시겠습니까?`;if(window.confirm(e)){ge&&Number(ge.id);try{const e=ge.purchase_request_items||[],t=e.filter(e=>!e.is_payment_completed);if(0===t.length)return void J.info("모든 품목이 이미 구매완료되었습니다.");c.info(`전체 구매완료 처리: ${t.length}개 품목 (총 ${e.length}개 중)`);for(const a of t){const e={is_payment_completed:!0,payment_completed_at:(new Date).toISOString()},{error:t}=await At.from("purchase_request_items").update(e).eq("id",a.id);if(t)throw t;y(ge.id,a.id)||c.warn("[PurchaseDetailModal] 메모리 캐시 개별 품목 구매완료 업데이트 실패",{purchaseId:ge.id,itemId:a.id})}J.success(`${t.length}개 품목이 구매완료 처리되었습니다.`),await nn();const n=M?.(!0,{silent:!0});n instanceof Promise&&await n}catch(t){c.error("전체 구매완료 처리 오류",t),J.error("구매완료 처리 중 오류가 발생했습니다.")}}},className:"button-base bg-orange-500 hover:bg-orange-600 text-white",children:[r.jsx(ee,{className:"w-3 h-3 mr-1"}),"전체 구매완료"]}),"receipt"===I&&Xt&&r.jsx(zn,{onConfirm:async(e,t)=>{if(!ge||!Xt)return;const n=`발주번호: ${ge.purchase_order_number}\n\n전체 입고완료 처리하시겠습니까?`;if(!window.confirm(n))return;const a=ge?Number(ge.id):NaN;try{const n=ge.purchase_request_items||[],r=n.filter(e=>!e.is_received),i=()=>{Number.isNaN(a)||de?.(a,n=>{const a=(n.items||[]).map(n=>r.find(e=>String(e.id)===String(n.id))?{...n,is_received:!0,actual_received_date:n.actual_received_date||k(e),received_quantity:void 0!==t?t:n.quantity}:n),i=(n.purchase_request_items||[]).map(n=>r.find(e=>String(e.id)===String(n.id))?{...n,is_received:!0,actual_received_date:n.actual_received_date||k(e),received_quantity:void 0!==t?t:n.quantity}:n);return{...n,items:a,purchase_request_items:i,is_received:!0,received_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}})};if(0===r.length)return void J.info("모든 품목이 이미 입고완료되었습니다.");c.info(`전체 입고완료 처리: ${r.length}개 품목 (총 ${n.length}개 중)`),i(),ve(n=>{if(!n)return null;const a=n.items?.map(n=>r.find(e=>String(e.id)===String(n.id))?{...n,is_received:!0,received_at:(new Date).toISOString(),actual_received_date:k(e),received_quantity:void 0!==t?t:n.quantity}:n)||[],i=n.purchase_request_items?.map(n=>r.find(e=>String(e.id)===String(n.id))?{...n,is_received:!0,received_at:(new Date).toISOString(),actual_received_date:k(e),received_quantity:void 0!==t?t:n.quantity}:n)||[],s=a.length,c=a.filter(e=>e.is_received).length,o=s>0&&c===s;return{...n,items:a,purchase_request_items:i,is_received:o,received_at:o?(new Date).toISOString():n.received_at,updated_at:(new Date).toISOString()}});for(const a of r){const n={actual_received_date:k(e),is_received:!0,received_quantity:void 0!==t?t:a.quantity},{error:r}=await At.from("purchase_request_items").update(n).eq("id",a.id);if(r)throw r;const i=void 0!==t?t:a.quantity;o(ge.id,a.id,k(e),i)||c.warn("[PurchaseDetailModal] 메모리 캐시 개별 품목 입고완료 업데이트 실패",{purchaseId:ge.id,itemId:a.id})}J.success(`${r.length}개 품목이 입고완료 처리되었습니다.`),await nn();const s=M?.(!0,{silent:!0});s instanceof Promise&&await s}catch(r){c.error("전체 입고완료 처리 오류",r),J.error("입고완료 처리 중 오류가 발생했습니다.")}},placeholder:"입고일을 선택하세요",align:"end",side:"bottom",hideQuantityInput:!0,quantityInfoText:"요청입고수량과 동일한 수량으로 입력됩니다",children:r.jsxs(i,{size:"sm",className:"button-base button-action-primary",children:[r.jsx(le,{className:"w-3 h-3 mr-1"}),"전체 입고완료"]})}),Vt&&Zt&&Kt&&r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx($,{onDateSelect:async e=>{if(!ge||!Zt)return;e.toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"});const t=`발주번호: ${ge.purchase_order_number}\n\n전체 거래명세서 확인 처리하시겠습니까?`;if(!window.confirm(t))return;const n=k(e);ge&&Number(ge.id);try{const e=ge.purchase_request_items||[],t=e.filter(e=>!e.is_statement_received);if(0===t.length)return void J.info("모든 품목의 거래명세서가 이미 확인되었습니다.");c.info(`전체 거래명세서 확인 처리: ${t.length}개 품목 (총 ${e.length}개 중)`);for(const r of t){const e={is_statement_received:!0,statement_received_date:n,statement_received_by_name:ke||null},{error:t}=await At.from("purchase_request_items").update(e).eq("id",r.id);if(t)throw t;l(ge.id,r.id,n,ke||void 0)||c.warn("[PurchaseDetailModal] 메모리 캐시 개별 품목 거래명세서 확인 업데이트 실패",{purchaseId:ge.id,itemId:r.id})}J.success(`${t.length}개 품목의 거래명세서 확인이 완료되었습니다.`),await nn();const a=M?.(!0,{silent:!0});a instanceof Promise&&await a}catch(a){c.error("전체 거래명세서 확인 처리 오류",a),J.error("거래명세서 확인 처리 중 오류가 발생했습니다.")}},placeholder:"전체 회계상 입고일을 선택하세요",align:"end",side:"bottom",children:r.jsxs(i,{size:"sm",className:"button-base button-action-primary",children:[r.jsx(v,{className:"w-3 h-3 mr-1"}),"거래명세서 확인"]})}),"done"===I&&"발주"===ge.payment_category&&r.jsx(Fn,{onConfirm:async(e,t)=>{if(!ge||!Zt)return void J.error("지출 정보 입력 권한이 없습니다.");const n=`발주번호: ${ge.purchase_order_number}\n\n일괄 지출 정보를 입력하시겠습니까?\n날짜: ${e.toLocaleDateString("ko-KR")}\n총 금액: ${t.toLocaleString()}원\n\n* 주의: 기존에 입력된 개별 품목의 지출 정보가 모두 초기화되고, 입력하신 총 금액으로 설정됩니다.`;if(!window.confirm(n))return;const a=ge?Number(ge.id):NaN;try{Number.isNaN(a)||de?.(a,n=>{const a=(n.items||[]).map(t=>({...t,expenditure_date:k(e),expenditure_amount:null}));return{...n,items:a,total_expenditure_amount:t}});const n=ge.items||ge.purchase_request_items||[];if(0===n.length)return void J.error("품목이 없습니다.");ve(n=>{if(!n)return null;const a=(n.items||n.purchase_request_items||[]).map(t=>({...t,expenditure_date:k(e),expenditure_amount:null}));return{...n,items:a,purchase_request_items:a,total_expenditure_amount:t,updated_at:(new Date).toISOString()}});const{error:r}=await At.from("purchase_request_items").update({expenditure_date:k(e),expenditure_amount:null}).in("id",n.map(e=>e.id));if(r)throw c.error("일괄 지출 정보 아이템 DB 업데이트 실패",{error:r}),r;const{error:i}=await At.from("purchase_requests").update({total_expenditure_amount:t}).eq("id",a);if(i)throw c.error("일괄 지출 정보 총액 DB 업데이트 실패",{error:i}),i;w(ge.id,k(e),t),J.success("일괄 지출 정보가 입력되었습니다.")}catch(r){c.error("일괄 지출 정보 입력 중 오류",r),J.error("일괄 지출 정보 입력 중 오류가 발생했습니다.")}},placeholder:"일괄 지출 날짜와 금액을 입력하세요",align:"end",side:"bottom",children:r.jsxs(i,{size:"sm",className:"button-base button-action-primary",children:[r.jsx(re,{className:"w-3 h-3 mr-1"}),"일괄지출"]})})]})]})]}),r.jsx("div",{className:"block sm:hidden bg-gray-50 px-2 py-1 border-b border-gray-100",children:r.jsx("div",{className:"text-xs font-medium text-gray-600",children:"품목 목록 (터치하여 스크롤)"})}),r.jsx("div",{className:"max-h-[50vh] sm:max-h-[40vh] overflow-y-auto overflow-x-hidden sm:overflow-x-auto w-full",children:r.jsxs("div",{className:"min-w-max",children:[r.jsx("div",{className:"bg-gray-50 px-2 sm:px-3 py-1 border-b border-gray-100 sticky top-0 z-20 min-w-max "+(fe?"pl-7 sm:pl-8":""),children:r.jsxs("div",{ref:Pt,className:"hidden sm:grid gap-1 modal-label min-w-max",style:{gridTemplateColumns:yn()},children:[r.jsx("div",{className:"text-center -ml-2 sm:-ml-3",children:"#"}),r.jsx("div",{children:"품목명"}),r.jsx("div",{children:"규격"}),r.jsx("div",{className:"text-center",children:"receipt"!==I&&"done"!==I||fe?"요청수량":r.jsxs("div",{className:"flex flex-col items-center leading-tight",children:[r.jsx("div",{className:"text-[9px]",children:"요청/실제"}),r.jsx("div",{className:"text-[10px]",children:"입고수량"})]})}),r.jsx("div",{className:"text-right",children:"단가"}),r.jsx("div",{className:"text-right",children:"합계"}),"발주"===ge.payment_category&&r.jsx("div",{className:"text-right",children:"세액"}),r.jsx("div",{className:"text-center",children:"링크"}),r.jsx("div",{className:"text-center",children:"비고"}),"pending"!==I&&(fe?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"text-center",children:"삭제"}),"receipt"===I&&r.jsx(r.Fragment,{children:r.jsx("div",{className:"text-center",children:"실제입고일"})}),Vt&&r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"text-center",children:"거래명세서 확인"}),r.jsx("div",{className:"text-center",children:"회계상 입고일"}),Ht&&r.jsx("div",{className:"text-center",children:"지출정보"})]})]}):r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"text-center",children:"purchase"===I?"구매상태":"receipt"===I||"done"===I?"입고상태":"상태"}),"receipt"===I&&r.jsx(r.Fragment,{children:r.jsx("div",{className:"text-center",children:"실제입고일"})}),Vt&&r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"text-center",children:"거래명세서 확인"}),r.jsx("div",{className:"text-center",children:"회계상 입고일"}),Ht&&r.jsx("div",{className:"text-center",children:"지출정보"})]})]}))]})}),r.jsxs("div",{className:"pb-0",children:[fe&&r.jsx(bn,{sensors:rt,collisionDetection:Ye,onDragEnd:dt,children:r.jsx(Rn,{items:Lt,strategy:In,children:(we||[]).map((e,t)=>r.jsx(Zn,{id:lt(e,t),children:n=>Pn(e,t,n,lt(e,t))},lt(e,t)))})}),!fe&&r.jsx("div",{className:"divide-y divide-gray-100 overflow-visible min-w-max",children:Wt?.map((e,t)=>Pn(e,t,void 0,lt(e,t)))})]}),r.jsx("div",{className:"hidden sm:block sticky bottom-0 z-20 bg-gray-50 border-t border-gray-100",children:r.jsxs("div",{className:"px-2 sm:px-3",children:[r.jsxs("div",{className:"sm:grid items-center gap-1 py-2 min-w-max",style:{gridTemplateColumns:yn()},children:[r.jsx("div",{className:"-ml-2 sm:-ml-3"}),r.jsx("div",{}),r.jsx("div",{}),r.jsx("div",{}),r.jsx("div",{className:"text-right flex items-center justify-end",children:r.jsx("span",{className:"text-[11px] text-gray-600 font-medium",children:"공급가액"})}),r.jsx("div",{className:"text-right flex items-center justify-end",children:r.jsx("span",{className:"text-[12px] font-bold text-gray-900",children:"done"!==I||Kt?`${"USD"===(fe?be?.currency:ge.currency)?"$":"₩"}${qn(Wt?.reduce((e,t)=>e+(t.amount_value||0),0)||0)}`:"-"})}),"발주"===ge.payment_category&&r.jsx("div",{className:"text-right flex items-center justify-end",children:r.jsx("span",{className:"text-[12px] font-bold text-gray-900",children:"done"!==I||Kt?`${"USD"===(fe?be?.currency:ge.currency)?"$":"₩"}${qn(Wt?.reduce((e,t)=>e+(t.tax_amount_value||0),0)||0)}`:"-"})}),r.jsx("div",{}),r.jsx("div",{}),"pending"!==I&&(fe?r.jsx("div",{}):r.jsx("div",{className:"done"===I&&"발주"===ge.payment_category?"text-right flex items-center justify-end":"",children:"done"===I&&"발주"===ge.payment_category&&r.jsx("span",{className:"text-[11px] text-gray-600 font-medium",children:"지출총합"})})),"receipt"===I&&r.jsx("div",{}),"done"===I&&r.jsx(r.Fragment,{children:"발주"===ge.payment_category&&r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"text-right flex items-center justify-end",children:r.jsx("div",{className:"text-[12px] font-bold text-blue-700",children:Kt?`₩${qn(ge.total_expenditure_amount??((fe?we:Ot)?.reduce((e,t)=>e+(Number(t.expenditure_amount)||0),0)||0))}`:"-"})}),r.jsx("div",{}),r.jsx("div",{})]})})]}),"발주"===ge.payment_category&&r.jsxs("div",{className:"sm:grid items-center gap-1 py-2 min-w-max border-t border-gray-300",style:{gridTemplateColumns:yn()},children:[r.jsx("div",{className:"-ml-2 sm:-ml-3"}),r.jsx("div",{}),r.jsx("div",{}),r.jsx("div",{}),r.jsx("div",{}),r.jsx("div",{className:"text-right flex items-center justify-end",children:r.jsx("span",{className:"text-[11px] text-gray-600 font-medium",children:"총액"})}),r.jsx("div",{className:"text-right flex items-center justify-end",children:r.jsx("span",{className:"text-[12px] font-bold text-blue-600",children:"done"!==I||Kt?Mn((fe?we:Ot)?.reduce((e,t)=>e+(t.amount_value||0)+(t.tax_amount_value||0),0)||0,kn()):"-"})}),r.jsx("div",{}),r.jsx("div",{}),r.jsx("div",{}),"receipt"===I&&r.jsx("div",{}),"done"===I&&"발주"===ge.payment_category&&r.jsxs(r.Fragment,{children:[r.jsx("div",{}),r.jsx("div",{}),r.jsx("div",{})]})]})]})})]})}),r.jsx("div",{className:"bg-gray-50 px-2 sm:px-3 border-t border-gray-100",children:r.jsxs("div",{className:"block sm:hidden py-2 space-y-1",children:[r.jsxs("div",{className:"flex justify-between items-center",children:[r.jsx("span",{className:"text-[12px] text-gray-500",children:"합계 총액"}),r.jsx("span",{className:"text-[13px] font-bold text-gray-900",children:"done"!==I||Kt?Mn((fe?we:Ot)?.reduce((e,t)=>e+(t.amount_value||0),0)||0,kn()):"-"})]}),"발주"===ge.payment_category&&r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"flex justify-between items-center",children:[r.jsx("span",{className:"text-[12px] text-gray-500",children:"세액 총액"}),r.jsx("span",{className:"text-[13px] font-bold text-gray-900",children:"done"!==I||Kt?Mn((fe?we:Ot)?.reduce((e,t)=>e+(t.tax_amount_value||0),0)||0,kn()):"-"})]}),r.jsxs("div",{className:"flex justify-between items-center border-t pt-1",children:[r.jsx("span",{className:"text-[12px] text-gray-500",children:"합계+세액"}),r.jsx("span",{className:"text-[13px] font-bold text-blue-600",children:"done"!==I||Kt?Mn((fe?we:Ot)?.reduce((e,t)=>e+(t.amount_value||0)+(t.tax_amount_value||0),0)||0,kn()):"-"})]})]}),"done"===I&&"발주"===ge.payment_category&&r.jsxs("div",{className:"flex justify-between items-center border-t pt-1",children:[r.jsx("span",{className:"text-[12px] text-gray-500",children:"지출 총합"}),r.jsx("span",{className:"text-[13px] font-bold text-blue-700",children:Kt?`₩${qn(ge.total_expenditure_amount??((fe?we:Ot)?.reduce((e,t)=>e+(Number(t.expenditure_amount)||0),0)||0))}`:"-"})]})]})}),fe&&r.jsx("div",{className:"p-2 sm:p-3 border-t border-gray-100",children:r.jsxs(i,{type:"button",size:"sm",variant:"outline",onClick:e=>{if(e?.preventDefault?.(),e?.stopPropagation?.(),!fe)return;const t=Date.now();t-$t.current<350?c.warn("[PurchaseDetailModal] handleAddItem 중복 호출 차단",{deltaMs:t-$t.current}):($t.current=t,Ne(e=>{const n=e||[],a={item_name:"",specification:"",quantity:1,unit_price_value:0,amount_value:0,remark:"",line_number:n.reduce((e,t)=>{const n=t.line_number||0;return n>e?n:e},0)+1,tempId:`tmp-new-${t}-${Math.random()}`};return[...n,a].sort((e,t)=>(e.line_number||999999)-(t.line_number||999999)).map((e,t)=>({...e,line_number:t+1,stableKey:e.stableKey??ct(e,t)}))}))},className:"w-full rounded-lg border-dashed border-2 border-gray-300 hover:border-gray-400 py-2 badge-text",children:[r.jsx(O,{className:"w-4 h-4 mr-1"}),"항목 추가"]})})]})})]})]}):r.jsx("div",{className:"text-center py-12",children:he?r.jsxs("div",{className:"flex items-center justify-center gap-2",children:[r.jsx("div",{className:"w-5 h-5 border-2 border-gray-300 border-t-transparent rounded-full animate-spin"}),r.jsx("span",{className:"modal-subtitle",children:"불러오는 중..."})]}):r.jsxs("div",{className:"space-y-3",children:[r.jsx("span",{className:"modal-subtitle",children:"발주내역이 삭제 되었거나 없습니다."}),!d&&r.jsx("div",{children:r.jsx(i,{size:"sm",variant:"outline",onClick:a,className:"button-base button-action-secondary",children:"닫기"})})]})})});return d?An:r.jsx(r.Fragment,{children:r.jsx(W,{open:n,onOpenChange:a,children:r.jsxs(L,{className:"overflow-hidden bg-white rounded-lg shadow-sm border-0 w-full sm:w-auto max-w-[calc(100vw-48px)] sm:max-w-[calc(100vw-80px)] lg:max-w-[90vw] xl:max-w-[85vw] h-[95vh] sm:h-auto sm:max-h-[90vh] lg:max-h-[85vh] sm:rounded-lg flex flex-col",showCloseButton:!1,children:[r.jsx(P,{className:"sr-only",children:r.jsx(A,{children:"발주 상세 정보"})}),r.jsxs("div",{className:"relative px-3 sm:px-6 pt-0 sm:pt-3 lg:pt-4 pb-0 sm:pb-2 lg:pb-3 flex-shrink-0",children:[r.jsxs("div",{className:"absolute right-3 sm:right-6 top-3 sm:top-3 lg:top-4 flex items-center gap-2 z-10",children:[!fe&&Bt&&r.jsxs(i,{size:"sm",variant:"outline",onClick:()=>wn(!0),className:"button-base button-action-secondary h-8 text-xs px-3",children:[r.jsx(oe,{className:"w-3.5 h-3.5 mr-1.5"}),"수정"]}),!fe&&Qt&&ue&&r.jsxs(i,{size:"sm",variant:"outline",onClick:()=>{ge&&ue(ge)},className:"button-base button-action-danger h-8 text-xs px-3",children:[r.jsx(te,{className:"w-3.5 h-3.5 mr-1.5"}),"삭제"]}),!Jt&&!fe&&r.jsxs(F,{open:Le,onOpenChange:e=>{Pe(e)},children:[r.jsx(z,{asChild:!0,children:r.jsxs(i,{variant:"outline",size:"sm",className:"button-base button-action-secondary h-8 text-xs px-3 gap-1.5",title:"수정 요청",children:[r.jsx(ce,{className:"w-3.5 h-3.5 text-gray-500"}),r.jsx("span",{children:"수정 요청"})]})}),r.jsx(U,{className:"w-[680px] max-w-[95vw] p-4",align:"end",onOpenAutoFocus:e=>e.preventDefault(),children:r.jsxs("div",{onWheel:e=>{e.currentTarget.scrollHeight>e.currentTarget.clientHeight&&(e.preventDefault(),e.stopPropagation(),e.currentTarget.scrollTop+=e.deltaY)},className:"space-y-4 max-h-[70vh] overflow-y-auto pr-1",children:[r.jsxs("div",{className:"space-y-1",children:[r.jsx("h4",{className:"modal-section-title text-gray-900",children:"수정 요청"}),r.jsx("p",{className:"card-description text-gray-500",children:"해당 발주서에 대한 요청 사항을 선택해주세요."})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"modal-label text-gray-600",children:"문의 유형 *"}),r.jsxs(V,{value:Ae,onValueChange:Fe,children:[r.jsx(H,{size:"sm",className:"button-base business-radius-input border border-gray-300 bg-white text-gray-700 w-auto !h-7 !px-2.5 !text-[11px]",style:{width:`${bt}em`,maxWidth:"100%"},children:r.jsx(Q,{placeholder:xt})}),r.jsx(Y,{className:"text-[11px] business-radius-card",style:{minWidth:`${yt}em`},children:ht.map(e=>r.jsx(X,{className:"text-[11px] py-1.5",value:e.value,children:e.label},e.value))})]})]}),r.jsxs("div",{className:"space-y-2 p-3 bg-gray-50 business-radius-card border border-gray-200",children:[r.jsx("div",{className:"modal-section-title text-gray-900",children:"발주요청 정보"}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("span",{className:"card-title",children:ge?.purchase_order_number||"(승인대기)"}),r.jsx("span",{className:"card-subtitle",children:ge?.vendor_name}),r.jsx("span",{className:"card-date",children:(ge?.request_date||ge?.created_at)&&R(new Date(ge.request_date||ge.created_at),"MM/dd")})]}),mt.length>0&&r.jsxs("div",{className:"mt-2 space-y-1",children:[r.jsx("div",{className:"modal-label text-gray-600",children:"품목 상세"}),mt.map((e,t)=>r.jsxs("div",{className:"flex items-center gap-2 pl-2",children:[r.jsxs("span",{className:"card-description text-gray-400",children:[e.line_number??t+1,"."]}),r.jsx("span",{className:"card-description",children:e.item_name}),e.specification&&r.jsxs("span",{className:"card-description text-gray-500",children:["(",e.specification,")"]}),r.jsxs("span",{className:"card-description text-gray-500",children:["- ",e.quantity,"개"]})]},e.id||t))]})]}),"delivery_date_change"===Ae&&r.jsxs("div",{className:"space-y-3 p-3 bg-gray-50 business-radius-card border border-gray-200",children:[r.jsx("div",{className:"modal-section-title text-gray-900",children:"입고일 변경 요청"}),r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[r.jsxs("div",{children:[r.jsx("label",{className:"modal-label text-gray-600 mb-1 block",children:"현재 입고요청일"}),r.jsx("div",{className:"modal-value text-gray-700",children:ge?.delivery_request_date?R(new Date(ge.delivery_request_date),"yyyy-MM-dd"):"-"})]}),r.jsxs("div",{children:[r.jsx("label",{className:"modal-label text-gray-600 mb-1 block",children:"변경 입고일"}),r.jsx($,{onDateSelect:Ke,placeholder:"변경 입고일을 선택하세요",align:"start",side:"bottom",children:r.jsxs(i,{type:"button",variant:"outline",className:"button-base justify-start border border-gray-300 bg-white text-gray-700 business-radius-input",children:[r.jsx(G,{className:"mr-2 h-3.5 w-3.5"}),Be?R(Be,"yyyy-MM-dd"):"날짜 선택"]})})]})]})]}),"quantity_change"===Ae&&r.jsxs("div",{className:"space-y-3 p-3 bg-gray-50 business-radius-card border border-gray-200",children:[r.jsx("div",{className:"modal-section-title text-gray-900",children:"수량 변경 요청"}),r.jsx("div",{className:"space-y-2",children:Ve.map(e=>{const t=mt.find(t=>String(t.id)===e.itemId);return r.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2",children:[r.jsx("div",{className:"flex-1",children:r.jsx(E,{value:pt.find(t=>t.value===e.itemId)||null,onChange:t=>Ct(e.id,{itemId:t?.value||""}),options:pt,placeholder:"품목 선택/검색",isSearchable:!0,noOptionsMessage:()=>"일치하는 품목이 없습니다",filterOption:(e,t)=>e.label.toLowerCase().includes(t.toLowerCase()),styles:St(Nt,jt)})}),r.jsx("div",{className:"badge-text text-gray-600 sm:w-24 text-right",children:"변경 수량 :"}),r.jsx(T,{type:"number",value:e.newQuantity,onChange:t=>Ct(e.id,{newQuantity:t.target.value}),placeholder:`입고 수량 : ${t?.quantity??"-"}`,className:"sm:w-28 business-radius-input h-7 !text-[11px] !leading-tight",min:0}),r.jsxs("button",{type:"button",onClick:()=>{return t=e.id,void He(e=>e.filter(e=>e.id!==t));var t},className:"button-action-danger",children:[r.jsx(te,{className:"w-3.5 h-3.5 mr-1"}),"삭제"]})]},e.id)})}),r.jsxs("button",{type:"button",onClick:()=>{He(e=>[...e,{id:ut(),itemId:"",newQuantity:""}])},className:"button-action-secondary",children:[r.jsx(O,{className:"w-3.5 h-3.5 mr-1"}),"품목 추가"]})]}),"price_change"===Ae&&r.jsxs("div",{className:"space-y-3 p-3 bg-gray-50 business-radius-card border border-gray-200",children:[r.jsx("div",{className:"modal-section-title text-gray-900",children:"단가/합계 금액 변경 요청"}),r.jsx("div",{className:"space-y-2",children:Qe.map(e=>{const t=mt.find(t=>String(t.id)===e.itemId),n=Number(t?.unit_price_value??t?.unit_price??0),a=Number(t?.amount_value??n*(t?.quantity??0)),i=t?n.toLocaleString("ko-KR"):"-",s=t?a.toLocaleString("ko-KR"):"-",c="amount"===e.changeType?`현재 합계액: ${s}`:`현재 단가: ${i}`;return r.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center gap-2",children:[r.jsx("div",{className:"flex-1",children:r.jsx(E,{value:pt.find(t=>t.value===e.itemId)||null,onChange:t=>kt(e.id,{itemId:t?.value||""}),options:pt,placeholder:"품목 선택/검색",isSearchable:!0,noOptionsMessage:()=>"일치하는 품목이 없습니다",filterOption:(e,t)=>e.label.toLowerCase().includes(t.toLowerCase()),styles:St(Nt,jt)})}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("span",{className:"badge-text text-gray-600",children:"변경 요청"}),r.jsxs(V,{value:e.changeType,onValueChange:t=>kt(e.id,{changeType:t,newValue:""}),children:[r.jsx(H,{size:"sm",className:"button-base business-radius-input border border-gray-300 bg-white text-gray-700 w-auto !h-7 !px-2.5 !text-[11px]",children:r.jsx(Q,{})}),r.jsx(Y,{className:"text-[11px] business-radius-card",children:_t.map(e=>r.jsx(X,{className:"text-[11px] py-1.5",value:e.value,children:e.label},e.value))})]})]}),r.jsx(T,{type:"text",inputMode:"numeric",value:qt(e.newValue),onChange:t=>{return kt(e.id,{newValue:(n=t.target.value,n.replace(/[^\d]/g,""))});var n},placeholder:c,className:"lg:w-40 business-radius-input h-7 !text-[11px] !leading-tight",min:0}),r.jsxs("button",{type:"button",onClick:()=>{return t=e.id,void Xe(e=>e.filter(e=>e.id!==t));var t},className:"button-action-danger",children:[r.jsx(te,{className:"w-3.5 h-3.5 mr-1"}),"삭제"]})]},e.id)})}),r.jsxs("button",{type:"button",onClick:()=>{Xe(e=>[...e,{id:ut(),itemId:"",changeType:"unit_price",newValue:""}])},className:"button-action-secondary",children:[r.jsx(O,{className:"w-3.5 h-3.5 mr-1"}),"품목 추가"]})]}),r.jsxs("div",{children:[r.jsxs("label",{className:"block modal-label text-gray-700 mb-1",children:["내용 ",r.jsx("span",{className:"text-red-500",children:"*"})]}),r.jsx("div",{className:"relative",onWheel:e=>e.stopPropagation(),children:r.jsx(K,{value:ze,onChange:e=>Ue(e.target.value),className:"business-radius-input min-h-20 text-[11px]",placeholder:"문의 내용을 자세히 입력해주세요"})})]}),r.jsxs("div",{className:"flex justify-end gap-2",children:[r.jsx(i,{variant:"outline",size:"sm",onClick:()=>Pe(!1),className:"button-base border border-gray-300 bg-white text-gray-700",children:"취소"}),r.jsx(i,{size:"sm",onClick:async()=>{if(Ae&&ze.trim())if(ge){Ge(!0);try{const e=(e=>{switch(e){case"delivery_date_change":return"입고일 변경 요청";case"quantity_change":return"수량 변경 요청";case"price_change":return"단가/합계 금액 변경 요청";case"modify":return"수정 요청";case"delete":return"삭제 요청";default:return e}})(Ae)||Ae;let t=null;const n=[];if("delivery_date_change"===Ae){if(!Be)return J.error("변경 입고일을 입력해주세요."),void Ge(!1);const e=ge.delivery_request_date?R(new Date(ge.delivery_request_date),"yyyy-MM-dd"):"-",a=R(Be,"yyyy-MM-dd");t={requested_date:a,current_date:ge.delivery_request_date||null},n.push(`현재 입고요청일: ${e}`),n.push(`변경 입고일: ${a}`)}if("quantity_change"===Ae){const e=Ve.filter(e=>e.itemId||e.newQuantity.trim());if(0===e.length)return J.error("수량 변경할 품목을 추가해주세요."),void Ge(!1);const a=[];for(const t of e){if(!t.itemId||!t.newQuantity.trim())return J.error("수량 변경 항목을 모두 입력해주세요."),void Ge(!1);const e=Number(t.newQuantity);if(!Number.isFinite(e))return J.error("변경 수량이 올바르지 않습니다."),void Ge(!1);const r=mt.find(e=>String(e.id)===t.itemId);if(!r)return J.error("선택한 품목을 찾을 수 없습니다."),void Ge(!1);a.push({item_id:String(r.id),line_number:r.line_number??null,item_name:r.item_name,specification:r.specification??null,current_quantity:r.quantity??null,new_quantity:e}),n.push(`${r.line_number??"-"}번 ${r.item_name} (${r.specification||"-"}) ${r.quantity??0} → ${e}`)}t={items:a}}if("price_change"===Ae){const e=Qe.filter(e=>e.itemId||e.newValue.trim());if(0===e.length)return J.error("단가/합계 금액 변경할 품목을 추가해주세요."),void Ge(!1);const a=[];for(const t of e){if(!t.itemId||!t.newValue.trim())return J.error("단가/합계 금액 변경 항목을 모두 입력해주세요."),void Ge(!1);const e=Number(t.newValue);if(!Number.isFinite(e))return J.error("변경 값이 올바르지 않습니다."),void Ge(!1);const r=mt.find(e=>String(e.id)===t.itemId);if(!r)return J.error("선택한 품목을 찾을 수 없습니다."),void Ge(!1);const i=Number(r.unit_price_value??r.unit_price??0),s=Number(r.amount_value??i*(r.quantity??0)),c=Number(r.quantity??0);if("amount"===t.changeType){const t=e,o=c>0?t/c:0;a.push({item_id:String(r.id),line_number:r.line_number??null,item_name:r.item_name,specification:r.specification??null,change_type:"amount",current_unit_price:i,new_unit_price:o,current_amount:s,new_amount:t}),n.push(`${r.line_number??"-"}번 ${r.item_name} (${r.specification||"-"}) 합계 ${s.toLocaleString("ko-KR")} → ${t.toLocaleString("ko-KR")}`)}else{const t=e,o=c*t;a.push({item_id:String(r.id),line_number:r.line_number??null,item_name:r.item_name,specification:r.specification??null,change_type:"unit_price",current_unit_price:i,new_unit_price:t,current_amount:s,new_amount:o}),n.push(`${r.line_number??"-"}번 ${r.item_name} (${r.specification||"-"}) 단가 ${i.toLocaleString("ko-KR")} → ${t.toLocaleString("ko-KR")} 합계 ${s.toLocaleString("ko-KR")} → ${o.toLocaleString("ko-KR")}`)}}t={items:a}}"delete"===Ae&&(t={reason:ze.trim()});let a="";const r=mt.map((e,t)=>`- ${e.line_number??t+1}. ${e.item_name} (${e.specification||"-"}) ${e.quantity}개`).join("\n");a=`발주번호: ${ge.purchase_order_number||"(승인대기)"}\n업체: ${ge.vendor_name}\n요청자: ${ge.requester_name}\n요청일: ${ge.request_date||ge.created_at||"-"}\n품목:\n${r}`;const i=[ze.trim()];n.length>0&&i.push(`[요청 상세]\n${n.join("\n")}`),a&&i.push(`[관련 발주 정보]\n${a}`);const s=i.join("\n\n"),c=Number(ge.id),o=Number.isFinite(c)?c:void 0,l=await N.createInquiry({inquiry_type:Ae,subject:e,message:s,purchase_request_id:o,purchase_info:a,purchase_order_number:ge.purchase_order_number,attachments:[],inquiry_payload:t});l.success?(J.success("수정 요청이 전송되었습니다."),Pe(!1),Fe(""),Ue(""),Ke(void 0),He([]),Xe([])):J.error(l.error||"수정 요청 전송 중 오류가 발생했습니다.")}catch(e){c.error("수정 요청 전송 실패",e),J.error("수정 요청 전송 중 오류가 발생했습니다.")}finally{Ge(!1)}}else J.error("발주요청 정보를 찾을 수 없습니다.");else J.error("모든 필드를 입력해주세요.")},disabled:Je,className:"button-base bg-blue-500 hover:bg-blue-600 text-white",children:Je?"전송 중...":"요청 전송"})]})]})})]}),r.jsx("button",{onClick:a,className:"button-base button-action-secondary w-8 h-8 rounded-full flex items-center justify-center",children:r.jsx(g,{className:"w-4 h-4 text-gray-500"})})]}),r.jsx("div",{className:"pr-8 sm:pr-16",children:r.jsxs("div",{className:"flex items-start gap-4 mb-0 sm:mb-3",children:[r.jsx("div",{className:"min-w-0 flex-1",children:r.jsx("h1",{className:"page-title mb-0 sm:mb-1",children:"발주 기본정보"})}),r.jsx("div",{className:"flex items-center gap-3",children:fe&&r.jsxs(r.Fragment,{children:[r.jsxs(i,{size:"sm",variant:"outline",onClick:()=>{wn(!1),ye(ge),Ne(ge?.items||[]),Se([])},className:"button-base button-action-secondary",children:[r.jsx(g,{className:"w-4 h-4 mr-2"}),"취소"]}),r.jsx(i,{size:"sm",onClick:async()=>{if(ge&&be){Mt.current=Date.now(),It.current=!0,tt(!0),c.debug("[handleSave] 저장 시작");try{const r=s(),i=2e4;c.debug("[handleSave] Step 1: 발주 기본 정보 업데이트 시작");const o=we.reduce((e,t)=>e+(t.amount_value||0),0);let l=null;be.contact_id?l=be.contact_id:Array.isArray(be.vendor_contacts)&&be.vendor_contacts.length>0&&(l=be.vendor_contacts[0].id||null);const d=await $n(r.from("purchase_requests").update({purchase_order_number:be.purchase_order_number||null,requester_name:be.requester_name||null,vendor_id:be.vendor_id||null,vendor_name:be.vendor_name||null,contact_id:l,delivery_request_date:be.delivery_request_date||null,revised_delivery_request_date:be.revised_delivery_request_date||null,payment_category:be.payment_category||null,project_vendor:be.project_vendor||null,project_item:be.project_item||null,sales_order_number:be.sales_order_number||null,total_amount:Number(o),updated_at:(new Date).toISOString()}).eq("id",ge.id),i),u=d?.error;if(u)throw c.error("Purchase update error:",u),u;c.debug("[handleSave] Step 1 완료"),c.debug("[handleSave] Step 2: 담당자 정보 업데이트 시작");let m=null;try{if(be.vendor_id&&Array.isArray(be.vendor_contacts)&&be.vendor_contacts.length>0){const e=be.vendor_contacts[0];if(e.id){m=e.id;const{error:t}=await r.from("vendor_contacts").update({contact_name:e.contact_name||"",contact_email:e.contact_email||"",contact_phone:e.contact_phone||"",position:e.position||""}).eq("id",e.id);t?c.error("담당자 업데이트 오류:",t):ve(t=>t?{...t,vendor_contacts:[e],contact_id:e.id,contact_name:e.contact_name}:null)}else if(e.contact_name){const{data:t,error:n}=await r.from("vendor_contacts").insert({vendor_id:be.vendor_id,contact_name:e.contact_name,contact_email:e.contact_email||"",contact_phone:e.contact_phone||"",position:e.position||""}).select().single();if(n)c.error("담당자 생성 오류:",n);else if(t){m=t.id,be.vendor_contacts=[t],ve(e=>e?{...e,vendor_contacts:[t],contact_id:t.id,contact_name:t.contact_name}:null);const{error:e}=await r.from("purchase_requests").update({contact_id:t.id}).eq("id",ge.id);e&&c.error("purchase_requests contact_id 업데이트 오류:",e)}}}}catch(e){c.warn("⚠️ [handleSave] 담당자 정보 업데이트 실패 (무시하고 계속)",{error:e})}if(c.debug("[handleSave] Step 2 완료"),c.debug("[handleSave] Step 3: 삭제된 항목 처리 시작"),je.length>0){const e=await $n(r.from("purchase_request_items").delete().in("id",je),i),t=e?.error;if(t)throw c.error("품목 삭제 에러:",t),t}if(c.debug("[handleSave] Step 3 완료"),0===we.length){c.info("🚀 모든 품목이 삭제되어 발주기본정보도 삭제합니다",{purchaseId:ge.id,deletedItemIds:je});const{error:e}=await r.from("purchase_requests").delete().eq("id",ge.id);if(e)throw c.error("발주기본정보 삭제 실패",e),e;const t=Number(ge.id);if(!Number.isNaN(t)){j(t)?c.info("✅ [handleSave] 발주기본정보 삭제 메모리 캐시 업데이트 성공",{purchaseId:t}):c.warn("[handleSave] 발주기본정보 삭제 메모리 캐시 업데이트 실패",{purchaseId:t})}J.success("모든 품목이 삭제되어 발주요청이 삭제되었습니다."),wn(!1),Se([]),a();const n=M?.(!0,{silent:!1});return void(n instanceof Promise&&await n)}c.debug(`[handleSave] Step 4: 아이템 저장 시작, 총 ${we.length}개`);for(let e=0;e<we.length;e++){const t=we[e],n=6e4;if(!t.item_name||!t.item_name.trim())throw new Error("품목명은 필수입니다.");(!t.quantity||t.quantity<=0)&&(t.quantity=1);const a=jn(t.unit_price_value,0),i=jn(t.amount_value,0);if(a<0)throw new Error("단가는 0 이상이어야 합니다.");if(i<0)throw new Error("합계는 0 이상이어야 합니다.");const s=t.id?Number(t.id):null,o=s&&!Number.isNaN(s)&&s>0,l=jn(t.unit_price_value,0),d=jn(t.amount_value,0);if(o){const a=await $n(r.from("purchase_request_items").update({item_name:t.item_name.trim(),specification:t.specification||null,quantity:jn(t.quantity,1),received_quantity:null!=t.received_quantity?jn(t.received_quantity):null,unit_price_value:l,unit_price_currency:ge.currency||"KRW",amount_value:d,amount_currency:ge.currency||"KRW",remark:t.remark||null,link:t.link&&String(t.link).trim()?String(t.link).trim():null,updated_at:(new Date).toISOString()}).eq("id",s),n),i=a?.error;if(i)throw c.error("기존 항목 업데이트 오류",i),i;c.debug(`[handleSave] 아이템 ${e+1} 업데이트 완료`)}else{const a={purchase_request_id:ge.id,item_name:t.item_name.trim(),specification:t.specification||null,quantity:jn(t.quantity,1),received_quantity:null!=t.received_quantity?jn(t.received_quantity):null,unit_price_value:l,unit_price_currency:ge.currency||"KRW",amount_value:d,amount_currency:ge.currency||"KRW",remark:t.remark||null,link:t.link&&String(t.link).trim()?String(t.link).trim():null,line_number:t.line_number||we.indexOf(t)+1,created_at:(new Date).toISOString()},i=await $n(r.from("purchase_request_items").insert(a),n),s=i?.error;if(s)throw c.error("새 항목 생성 오류",s),s;c.debug(`[handleSave] 아이템 ${e+1} 삽입 완료`)}}c.debug("[handleSave] Step 4 완료: 모든 아이템 저장됨");const p=ge?Number(ge.id):NaN,_=be||ge;try{!Number.isNaN(p)&&je.length>0&&je.forEach(e=>{try{S(p,e)||c.warn("[handleSave] 개별 품목 삭제 메모리 캐시 업데이트 실패",{purchaseId:p,itemId:e})}catch(t){c.warn("⚠️ [handleSave] 개별 품목 삭제 메모리 캐시 업데이트 중 에러 (무시)",{error:t})}})}catch(t){c.warn("⚠️ [handleSave] 메모리 캐시 삭제 처리 중 에러 (무시하고 계속)",{error:t})}try{if(!Number.isNaN(p)){h(p,e=>{const t=we.reduce((e,t)=>e+(t.amount_value||0),0);return{...e,purchase_order_number:_?.purchase_order_number||e.purchase_order_number,requester_name:_?.requester_name||e.requester_name,vendor_id:_?.vendor_id||e.vendor_id,vendor_name:_?.vendor_name||e.vendor_name,vendor:_?.vendor||e.vendor,vendor_contacts:_?.vendor_contacts||e.vendor_contacts,delivery_request_date:_?.delivery_request_date||e.delivery_request_date,revised_delivery_request_date:_?.revised_delivery_request_date||e.revised_delivery_request_date,payment_category:_?.payment_category||e.payment_category,project_vendor:_?.project_vendor||e.project_vendor,project_item:_?.project_item||e.project_item,total_amount:t,items:we,purchase_request_items:we,updated_at:(new Date).toISOString()}})}}catch(t){c.warn("⚠️ [handleSave] 메모리 캐시 업데이트 중 에러 (무시하고 계속)",{error:t})}try{const e=()=>{!Number.isNaN(p)&&de&&de(p,e=>{const t=we,n=t.reduce((e,t)=>e+(t.amount_value||0),0);return{...e,purchase_order_number:_?.purchase_order_number||e.purchase_order_number,requester_name:_?.requester_name||e.requester_name,vendor_id:_?.vendor_id||e.vendor_id,vendor_name:_?.vendor_name||e.vendor_name,vendor:_?.vendor||e.vendor,vendor_contacts:_?.vendor_contacts||e.vendor_contacts,delivery_request_date:_?.delivery_request_date||e.delivery_request_date,revised_delivery_request_date:_?.revised_delivery_request_date||e.revised_delivery_request_date,payment_category:_?.payment_category||e.payment_category,project_vendor:_?.project_vendor||e.project_vendor,project_item:_?.project_item||e.project_item,total_amount:n,items:t,purchase_request_items:t,updated_at:(new Date).toISOString()}})};c.debug("[handleSave] Step 5 - UI 업데이트 시작"),e(),c.debug("[handleSave] Step 5 완료 - 저장 성공!")}catch(n){c.warn("⚠️ [handleSave] OptimisticUpdate 중 에러 (무시하고 계속)",{error:n})}c.debug("[handleSave] Step 5 완료: UI 업데이트됨"),J.success("발주 내역이 성공적으로 저장되었습니다."),wn(!1),Se([]),c.debug("[handleSave] 저장 완료! 로딩 해제"),tt(!1),nn().catch(e=>{c.warn("⚠️ [handleSave] 백그라운드 새로고침 실패",{error:e});const t=e instanceof Error?e.message:String(e);J.error(`저장 후 새로고침 실패: ${t}`,{duration:5e3})});const g=M?.(!0,{silent:!0});g instanceof Promise&&g.catch(e=>{c.warn("⚠️ [handleSave] 백그라운드 onRefresh 실패 (무시)",{error:e})})}catch(r){c.error("[handleSave] 저장 실패:",r);const e=r instanceof Error?r.message:"알 수 없는 오류가 발생했습니다";J.error(`저장 실패: ${e}`,{duration:5e3})}finally{c.debug("[handleSave] finally 블록 실행 - 로딩 해제"),It.current=!1,tt(!1)}}else J.error("저장할 데이터가 없습니다.")},disabled:et,className:"button-base button-action-primary",children:et?r.jsxs(r.Fragment,{children:[r.jsx(ne,{className:"w-4 h-4 mr-2 animate-spin"}),"저장 중..."]}):r.jsxs(r.Fragment,{children:[r.jsx(B,{className:"w-4 h-4 mr-2"}),"저장"]})})]})})]})})]}),r.jsx("div",{className:"overflow-y-auto flex-1 px-3 sm:px-6 pb-1 sm:pb-6 mt-0",children:An})]})})})}),ta=Object.freeze(Object.defineProperty({__proto__:null,default:ea},Symbol.toStringTag,{value:"Module"}));export{Qn as A,ae as C,Kn as D,se as I,ce as M,ea as P,Vn as R,le as T,Yn as U,Xn as a,Hn as b,re as c,oe as d,ta as e,Jn as n,Gn as t,Un as u};
//# sourceMappingURL=PurchaseDetailModal-Dfm0LjVP.js.map
