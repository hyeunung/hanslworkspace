import{e,r as t,j as a,y as s,B as r,X as i,h as n,a as l,s as c,c as d,M as o,v as u,u as m,Y as p,g as h}from"./index-B0Z5MnAS.js";import{C as x,a as g,b as y,c as b,T as f}from"./card-DiB0REAv.js";import{I as j,P as v,D as _,a as N,b as w,c as S}from"./dialog--kOuIgim.js";import{T as q}from"./textarea-Dn4yCueS.js";import{S as I,a as C,b as k,c as $,d as M,C as T,e as D}from"./select-8KM9ypKG.js";import{t as O}from"./index-BQP85Djl.js";import{A as P,a as L,b as R,c as H,d as E,e as F,f as A,g as V}from"./alert-dialog-D7F2udKn.js";import{C as W,k as J,f as K,S as z,D as Q}from"./react-select.esm-Bd0zJfi6.js";import{P as B,a as U,b as Y,S as G}from"./popover-Bmpot88L.js";import{C as X}from"./calendar-CYC9nkAE.js";import{d as Z,P as ee}from"./PurchaseDetailModal-DggLc1zo.js";import{L as te}from"./loader-circle-BY4In_E_.js";import{E as ae}from"./eye-Dj0K8_3c.js";import"./index-BMP07oTF.js";import"./check-C6COEVnU.js";import"./helpers-CmqE03mo.js";import"./credit-card-SeSUYp_L.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const se=e("image-plus",[["path",{d:"M16 5h6",key:"1vod17"}],["path",{d:"M19 2v6",key:"4bpg5p"}],["path",{d:"M21 11.5V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7.5",key:"1ue2ih"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}]]),re=e("send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]);function ie({className:e,date:n,onDateChange:l,placeholder:c="기간을 선택하세요",disabled:d=!1,triggerClassName:o,...u}){const[m,p]=t.useState(!1),h=e=>{if(!e?.from)return c;const t=e=>e.toLocaleDateString("ko-KR",{year:"numeric",month:"long",day:"numeric"});if(e.from&&e.to){if(e.from.getFullYear()===e.to.getFullYear()&&e.from.getMonth()===e.to.getMonth()){return`${e.from.getFullYear()}년 ${e.from.toLocaleDateString("ko-KR",{month:"long"})} ${e.from.getDate()}일 - ${e.to.getDate()}일`}return`${t(e.from)} - ${t(e.to)}`}return t(e.from)};return a.jsx("div",{className:s("grid gap-2",e),...u,children:a.jsxs(B,{open:m,onOpenChange:p,children:[a.jsx(U,{asChild:!0,children:a.jsxs(r,{id:"date",className:s("button-base w-full justify-start text-left font-normal border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 transition-colors",!n&&"text-gray-500",n&&"text-gray-900",o),disabled:d,children:[a.jsx(X,{className:"mr-2 h-4 w-4 text-gray-400"}),a.jsx("span",{className:"truncate",children:h(n)}),n&&a.jsx(i,{className:"ml-auto h-4 w-4 text-gray-400 hover:text-gray-600 transition-colors",onClick:e=>{e.stopPropagation(),l?.(void 0),p(!1)}})]})}),a.jsx(Y,{className:"w-auto p-0 shadow-lg border border-gray-200 business-radius-card",align:"start",children:a.jsxs("div",{className:"bg-white business-radius-card overflow-hidden",children:[a.jsxs("div",{className:"bg-gray-50 border-b border-gray-100 px-4 py-3",children:[a.jsx("h4",{className:"text-[11px] font-semibold text-gray-900",children:"기간 선택"}),a.jsx("p",{className:"text-[10px] text-gray-500 mt-1",children:"시작일과 종료일을 선택하세요"})]}),a.jsx("div",{className:"p-4",children:a.jsx(W,{initialFocus:!0,mode:"range",defaultMonth:n?.from,selected:n,onSelect:e=>{l?.(e),e?.from&&e?.to&&p(!1)},numberOfMonths:2,disabled:d,locale:J,className:"business-radius-card",classNames:{months:"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",month:"space-y-4",caption:"flex justify-center pt-1 relative items-center text-[11px] font-medium",caption_label:"text-[11px] font-medium text-gray-900",nav:"space-x-1 flex items-center",nav_button:"inline-flex items-center justify-center rounded-md text-[11px] font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none border border-input bg-background hover:bg-accent hover:text-accent-foreground h-6 w-6",nav_button_previous:"absolute left-1",nav_button_next:"absolute right-1",table:"w-full border-collapse space-y-1",head_row:"flex",head_cell:"text-gray-500 rounded-md w-7 font-normal text-[10px]",row:"flex w-full mt-2",cell:"h-7 w-7 text-center text-[11px] p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20",day:"inline-flex items-center justify-center rounded-md text-[11px] font-normal ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 aria-selected:opacity-100 h-7 w-7 hover:bg-gray-100 hover:text-gray-900 text-gray-900",day_range_start:"day-range-start bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",day_range_end:"day-range-end bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",day_selected:"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",day_today:"bg-accent text-accent-foreground font-semibold",outside:"!text-gray-400 !opacity-40 hover:!text-gray-500 hover:bg-gray-50 aria-selected:bg-accent/50 aria-selected:text-muted-foreground aria-selected:opacity-30",day_disabled:"!text-gray-400 !opacity-40",day_range_middle:"aria-selected:bg-accent aria-selected:text-accent-foreground",day_hidden:"invisible"}})}),n&&a.jsx("div",{className:"bg-gray-50 border-t border-gray-100 px-4 py-3",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("span",{className:"badge-text text-gray-600",children:["선택된 기간: ",h(n)]}),a.jsx(r,{onClick:()=>{l?.(void 0),p(!1)},className:"button-action-secondary",children:"지우기"})]})})]})})]})})}function ne(){const e=n(),s=l(),[W,J]=t.useState(""),[B,U]=t.useState(""),[Y,ne]=t.useState(!1),[le,ce]=t.useState([]),[de,oe]=t.useState(!1),ue=t.useRef(null),me=t.useRef(null),[pe,he]=t.useState(!1),[xe,ge]=t.useState(),[ye,be]=t.useState([]),[fe,je]=t.useState(null),[ve,_e]=t.useState(!1),[Ne,we]=t.useState(),[Se,qe]=t.useState([]),[Ie,Ce]=t.useState([]),ke=["modify","delete","delivery_date_change","quantity_change","price_change"],$e="delete"===W?"삭제할 발주요청 선택":"발주요청 선택",Me="delete"===W?"삭제 사유":"내용",[Te,De]=t.useState(null),[Oe,Pe]=t.useState(null),[Le,Re]=t.useState(null),[He,Ee]=t.useState(null),Fe=()=>`row-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,[Ae,Ve]=t.useState([]),[We,Je]=t.useState(null),[Ke,ze]=t.useState(""),[Qe,Be]=t.useState(""),[Ue,Ye]=t.useState([]),[Ge,Xe]=t.useState(!0),[Ze,et]=t.useState(null),[tt,at]=t.useState(!1),[st,rt]=t.useState(null),[it,nt]=t.useState(!1),[lt,ct]=t.useState(null),[dt,ot]=t.useState(null),[ut,mt]=t.useState(!1),[pt,ht]=t.useState(null),[xt,gt]=t.useState(!1),[yt,bt]=t.useState(null),[ft,jt]=t.useState(!1),[vt,_t]=t.useState("발주내역이 삭제 되었거나 없습니다."),[Nt,wt]=t.useState([]),[St,qt]=t.useState(!1),[It,Ct]=t.useState(!1),[kt,$t]=t.useState(""),[Mt,Tt]=t.useState(!1),Dt=t.useRef(null),Ot=t.useRef(null),Pt=t.useRef(null),Lt=t.useRef(!1),Rt=t.useRef(new Map);t.useEffect(()=>{Ht()},[]),t.useEffect(()=>{if(null===We)return;const e=c.subscribeToInquiries(e=>{const t=e?.eventType,a=e?.new,s=e?.old;if("DELETE"===t){const e=s?.id;if(!e)return;return Ve(t=>t.filter(t=>t.id!==e)),void(Ze===e&&et(null))}const r=a;r?.id&&Ve(e=>{const t=!!(a=r)&&(!!We||!!Qe&&a.user_id===Qe);var a;const s=e.findIndex(e=>e.id===r.id);if(!t){if(-1===s)return e;return e.filter(e=>e.id!==r.id)}const i=[...e];return s>=0?i[s]=r:i.unshift(r),i.sort((e,t)=>{const a=e.created_at?new Date(e.created_at).getTime():0;return(t.created_at?new Date(t.created_at).getTime():0)-a}),i})});return()=>{e.unsubscribe()}},[We,Qe]);const Ht=async()=>{const e=d(),{data:{user:t}}=await e.auth.getUser();if(!t)return;ze(t.email||""),Be(t.id);const{data:a}=await e.from("employees").select("purchase_role").eq("email",t.email).single();if(a){const e=Array.isArray(a.purchase_role)?a.purchase_role:a.purchase_role?.split(",").map(e=>e.trim())||[];Ye(e);const t=e.includes("app_admin");Je(t),Et(t)}},Et=async e=>{Xe(!0);const t=e?await c.getAllInquiries():await c.getMyInquiries();t.success?Ve(t.data):O.error(t.error||"문의 목록 로드 실패"),Xe(!1)},Ft=async()=>{if(null===We)return;Xe(!0);const e=We?await c.getAllInquiries():await c.getMyInquiries();e.success?Ve(e.data):O.error(e.error||"문의 목록 로드 실패"),Xe(!1)};t.useEffect(()=>{ke.includes(W)?he(!0):(he(!1),je(null)),we(void 0),qe([]),Ce([])},[W]),t.useEffect(()=>{const t=new URLSearchParams(e.search),a=t.get("type"),s=t.get("purchaseId"),r=t.get("source"),i=t.get("returnTo");if(i&&Ee(i),r&&Re(r),"delivery-warning"===r&&"delivery_date_change"===a?(De("delivery_date_change"),J("delivery_date_change")):De(null),s){const e=Number(s);Pe(Number.isFinite(e)?e:null)}else Pe(null)},[e.search]),t.useEffect(()=>{(async()=>{if(!Oe)return;if("delivery_date_change"===Te&&"delivery_date_change"!==W)return;const e=await c.getPurchaseRequestDetail(String(Oe));e.success&&e.data?(je(e.data),be([e.data]),we(void 0),qe([]),Ce([])):O.error(e.error||"발주요청 정보를 불러오지 못했습니다.")})()},[Oe,Te,W]),t.useEffect(()=>{we(void 0),qe([]),Ce([])},[fe?.id]),t.useEffect(()=>{"quantity_change"===W&&0===Se.length&&qe([{id:Fe(),itemId:"",newQuantity:""}]),"price_change"===W&&0===Ie.length&&Ce([{id:Fe(),itemId:"",changeType:"unit_price",newValue:""}])},[W,Se.length,Ie.length]),t.useEffect(()=>{pe&&xe?.from&&xe?.to&&At()},[pe,xe?.from,xe?.to]);const At=async()=>{_e(!0);const e=xe?.from?xe.from.toISOString().split("T")[0]:void 0,t=xe?.to?xe.to.toISOString().split("T")[0]:void 0,a=await c.getMyPurchaseRequests(e,t);a.success?be(a.data):O.error(a.error||"발주요청 조회 실패"),_e(!1)};t.useEffect(()=>{if(!xe){const e=new Date,t=new Date;t.setMonth(t.getMonth()-2),ge({from:t,to:e})}},[xe]);const Vt=[...ye].sort((e,t)=>{const a=e.request_date||e.created_at,s=t.request_date||t.created_at,r=a?new Date(a).getTime():0;return(s?new Date(s).getTime():0)-r}).map(e=>{const t=e.purchase_order_number||"(승인대기)",a=e.vendor_name||"",s=e.purchase_request_items?.[0]?.item_name||"품목 없음",r=`${t} · ${a} · ${s}${e.purchase_request_items?.length>1?` 외 ${e.purchase_request_items.length-1}건`:""}`.trim(),i=`${t} ${a} ${e.requester_name||""} ${s}`.toLowerCase();return{value:String(e.id),label:r,data:e,searchText:i}}),Wt=[{value:"delivery_date_change",label:"입고일 변경 요청"},{value:"quantity_change",label:"수량 변경 요청"},{value:"price_change",label:"단가/합계 금액 변경 요청"},{value:"bug",label:"오류 신고"},{value:"modify",label:"수정 요청"},{value:"delete",label:"삭제 요청"},{value:"other",label:"기타 문의"}],Jt=Array.isArray(fe?.purchase_request_items)?[...fe.purchase_request_items].sort((e,t)=>(e.line_number??Number.MAX_SAFE_INTEGER)-(t.line_number??Number.MAX_SAFE_INTEGER)):[],Kt=Jt.map(e=>({value:String(e.id),label:`${e.line_number?`${e.line_number}.`:""} ${e.item_name} (${e.specification||"-"})`.trim()})),zt=e=>{if("undefined"==typeof document)return 7*e.length;me.current||(me.current=document.createElement("canvas"));const t=me.current.getContext("2d");return t?(t.font=(()=>{if("undefined"==typeof document)return'11px Pretendard, -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans KR", sans-serif';const e=window.getComputedStyle(document.body),t=e.fontFamily||'Pretendard, -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans KR", sans-serif';return`${e.fontWeight||"400"} 11px ${t}`})(),Math.ceil(t.measureText(e).width)):7*e.length},Qt=(e,t=4,a=12)=>Math.max(e.length+t,a),Bt=e=>e.reduce((e,t)=>{const a=t.label??"";return Math.max(e,zt(a))},0),Ut=(e,t)=>{const a=Bt(e),s=Math.max(a,zt(t));return Math.ceil(s+24+30)},Yt=(e,t)=>{const a=Bt(e),s=Math.max(a,zt(t));return Math.ceil(s+24+30+14)},Gt="문의 유형을 선택해주세요",Xt=Qt(Gt,3,14),Zt=Qt(Wt.reduce((e,t)=>{const a=t.label||"";return a.length>e.length?a:e},Gt),3,Xt),ea="발주번호 선택/검색",ta=Ut(Vt,ea),aa=Yt(Vt,ea),sa="품목 선택/검색",ra=Ut(Kt,sa)+16,ia=Yt(Kt,sa),na=[{value:"unit_price",label:"단가"},{value:"amount",label:"합계액"}],la=e=>{if(!e)return"";const t=Number(e);return Number.isFinite(t)?t.toLocaleString("ko-KR"):e},ca=Math.max(19,22),da=(e,t)=>({control:e=>({...e,minHeight:"28px",height:"28px",fontSize:"11px",borderRadius:"8px",borderColor:"#e5e7eb",boxShadow:"none"}),container:t=>({...t,width:e?`${e}px`:t.width,maxWidth:"100%"}),valueContainer:e=>({...e,padding:"0 8px"}),input:e=>({...e,margin:0,padding:0,fontSize:"11px"}),indicatorsContainer:e=>({...e,height:"28px"}),option:e=>({...e,fontSize:"11px",whiteSpace:"nowrap",overflow:"visible",textOverflow:"clip"}),placeholder:e=>({...e,fontSize:"11px",color:"#9ca3af"}),singleValue:e=>({...e,fontSize:"11px",overflow:"visible",textOverflow:"clip",maxWidth:"none"}),menu:e=>({...e,width:t?`${t}px`:e.width,minWidth:t?`${t}px`:e.minWidth,maxWidth:t?`${t}px`:"90vw"}),menuList:e=>({...e,width:t?`${t}px`:e.width,minWidth:t?`${t}px`:e.minWidth,maxWidth:t?`${t}px`:e.maxWidth})}),oa=(e,t)=>{qe(a=>a.map(a=>a.id===e?{...a,...t}:a))},ua=(e,t)=>{Ce(a=>a.map(a=>a.id===e?{...a,...t}:a))},ma=async(e,t,a)=>{if("resolved"===t){const t=await c.resolveInquiry(e);t.success?(O.success("문의가 완료 처리되었습니다."),Ft()):O.error(t.error||"완료 처리 실패")}else{const a=await c.updateInquiryStatus(e,t);a.success?(O.success("상태가 업데이트되었습니다."),Ft()):O.error(a.error||"상태 업데이트 실패")}},pa=Ae.find(e=>e.id===Ze)||null;t.useEffect(()=>{if(!pa?.id)return;const e=pa.id;let t=!1;Lt.current=!0;const a=Rt.current.get(e);a&&a.length>0?(wt(a),qt(!1),Ct(!0)):(wt([]),qt(!0),Ct(!1));const s=async()=>{(Rt.current.get(e)?.length??0)>0?Ct(!0):qt(!0);const a=await c.getInquiryMessages(e);if(!t)if(a.success){const t=Dt.current,s=t?.scrollTop??0,r=Pt.current!==e;Pt.current=e;const i=!!r||(!t||t.scrollHeight-t.scrollTop-t.clientHeight<80);Ot.current={atBottom:i,prevTop:s},wt(a.data),Rt.current.set(e,a.data),qt(!1),Ct(!1)}else O.error(a.error||"대화 내용을 불러오지 못했습니다."),qt(!1),Ct(!1)};s(),(async()=>{if(We)return;if(!Ke)return;const t=d();await t.from("notifications").update({is_read:!0,read_at:(new Date).toISOString()}).eq("user_email",Ke).eq("is_read",!1).in("type",["inquiry_message","inquiry_resolved"]).eq("data->>inquiryId",String(e))})();const r=c.subscribeToInquiryMessages(e,()=>{s()});return()=>{t=!0,r.unsubscribe()}},[pa?.id,We,Ke]),t.useLayoutEffect(()=>{if(!pa?.id)return;const e=Dt.current;if(e)if(Lt.current)e.scrollTop=e.scrollHeight,(Nt.length>0||!St)&&(Lt.current=!1);else{const t=Ot.current;if(!t)return;t.atBottom?e.scrollTop=e.scrollHeight:e.scrollTop=t.prevTop}},[pa?.id,Nt,St]);const ha=()=>{ct(null),ot(null)},xa=e=>{switch(e){case"open":return a.jsx("span",{className:"badge-stats bg-yellow-100 text-yellow-800",children:"대기"});case"in_progress":return a.jsx("span",{className:"badge-stats bg-blue-100 text-blue-800",children:"처리중"});case"resolved":return a.jsx("span",{className:"badge-stats bg-green-100 text-green-800",children:"완료"});case"closed":return a.jsx("span",{className:"badge-stats bg-gray-100 text-gray-800",children:"종료"});default:return a.jsx("span",{className:"badge-stats border border-gray-300 bg-white text-gray-600",children:"-"})}},ga=e=>{switch(e){case"bug":return"오류 신고";case"modify":return"수정 요청";case"delivery_date_change":return"입고일 변경 요청";case"quantity_change":return"수량 변경 요청";case"price_change":return"단가/합계 금액 변경 요청";case"delete":return"삭제 요청";case"annual_leave":return"연차 문의";case"attendance":return"근태 문의";case"other":return"기타 문의";default:return e}},ya=e=>{const t=e.inquiry_payload;if(!t||"object"!=typeof t)return null;if("delivery_date_change"===e.inquiry_type)return a.jsxs("div",{children:[a.jsx("span",{className:"modal-value text-gray-700",children:"입고일 변경 요청:"}),a.jsxs("div",{className:"mt-1 text-gray-600",children:[a.jsxs("div",{children:["현재 입고요청일: ",t.current_date||"-"]}),a.jsxs("div",{children:["변경 입고일: ",t.requested_date||"-"]})]})]});if("quantity_change"===e.inquiry_type){const e=Array.isArray(t.items)?t.items:[];return 0===e.length?null:a.jsxs("div",{children:[a.jsx("span",{className:"modal-value text-gray-700",children:"수량 변경 요청:"}),a.jsx("div",{className:"mt-1 text-gray-600 space-y-1",children:e.map((e,t)=>a.jsxs("div",{children:[e.line_number??"-","번 ",e.item_name," (",e.specification||"-",") ",e.current_quantity??"-"," → ",e.new_quantity]},`${e.item_id}-${t}`))})]})}if("price_change"===e.inquiry_type){const e=Array.isArray(t.items)?t.items:[];return 0===e.length?null:a.jsxs("div",{children:[a.jsx("span",{className:"modal-value text-gray-700",children:"단가/합계 금액 변경 요청:"}),a.jsx("div",{className:"mt-1 text-gray-600 space-y-1",children:e.map((e,t)=>a.jsxs("div",{children:[e.line_number??"-","번 ",e.item_name," (",e.specification||"-",")"," ","amount"===e.change_type?`합계 ${e.current_amount??"-"} → ${e.new_amount??"-"}`:`단가 ${e.current_unit_price??"-"} → ${e.new_unit_price??"-"} 합계 ${e.current_amount??"-"} → ${e.new_amount??"-"}`]},`${e.item_id}-${t}`))})]})}return"delete"===e.inquiry_type&&t.reason?a.jsxs("div",{children:[a.jsx("span",{className:"modal-value text-gray-700",children:"삭제 사유:"}),a.jsx("p",{className:"text-gray-600 mt-1 whitespace-pre-wrap",children:t.reason})]}):null};return null===We?a.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"}),a.jsx("p",{className:"text-gray-600",children:"권한 확인 중..."})]})}):a.jsxs("div",{className:"min-h-screen bg-gray-50",children:[a.jsxs("div",{className:"w-full max-w-none mx-0 px-3 sm:px-4 lg:px-5 pb-6",children:[a.jsxs("div",{className:"mb-4",children:[a.jsx("h1",{className:"page-title text-gray-900",children:"문의하기"}),a.jsx("p",{className:"page-subtitle text-gray-600 mt-1",children:We?"모든 문의를 관리하고 답변할 수 있습니다":"시스템 사용 중 궁금하신 점이나 개선사항을 알려주세요"})]}),a.jsxs("div",{className:""+(We?"w-full":"grid grid-cols-1 xl:grid-cols-2 gap-4"),children:[!We&&a.jsxs(x,{className:"business-radius-card border border-gray-200 shadow-sm",children:[a.jsx(g,{className:"pb-3 pt-4 px-4",children:a.jsxs(y,{className:"section-title flex items-center gap-2 text-gray-900",children:[a.jsx(o,{className:"w-4 h-4 text-gray-600"}),"문의 내용"]})}),a.jsx(b,{className:"px-4 pb-4",children:a.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SupportMain.tsx:handleSubmit:start",message:"submit_start",data:{inquiryType:W,messageLength:B.length,loading:Y,uploadingImage:de,selectedPurchaseId:fe?.id??null,showPurchaseSelect:pe},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"H1"})}).catch(()=>{}),!W||!B)return fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SupportMain.tsx:handleSubmit:validation",message:"missing_required",data:{inquiryType:W,hasMessage:!!B},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"H2"})}).catch(()=>{}),void O.error("모든 필드를 입력해주세요.");const t=ke.includes(W);if(t&&!fe)return fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SupportMain.tsx:handleSubmit:validation",message:"missing_purchase",data:{inquiryType:W,requiresPurchase:t},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"H2"})}).catch(()=>{}),void O.error("발주요청을 선택해주세요.");ne(!0);const a=ga(W)||W;let r=B,i="",n=null;const l=[];if("delivery_date_change"===W){if(!Ne)return fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SupportMain.tsx:handleSubmit:validation",message:"missing_requested_delivery_date",data:{inquiryType:W},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"H2"})}).catch(()=>{}),O.error("변경 입고일을 입력해주세요."),void ne(!1);const e=fe?.delivery_request_date?K(new Date(fe.delivery_request_date),"yyyy-MM-dd"):"-",t=K(Ne,"yyyy-MM-dd");n={requested_date:t,current_date:fe?.delivery_request_date||null},l.push(`현재 입고요청일: ${e}`),l.push(`변경 입고일: ${t}`)}if("quantity_change"===W){const e=Se.filter(e=>e.itemId||e.newQuantity.trim());if(0===e.length)return fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SupportMain.tsx:handleSubmit:validation",message:"missing_quantity_rows",data:{inquiryType:W,rows:Se.length},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"H2"})}).catch(()=>{}),O.error("수량 변경할 품목을 추가해주세요."),void ne(!1);const t=[];for(const a of e){if(!a.itemId||!a.newQuantity.trim())return fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SupportMain.tsx:handleSubmit:validation",message:"invalid_quantity_row",data:{itemId:a.itemId,hasQuantity:!!a.newQuantity.trim()},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"H2"})}).catch(()=>{}),O.error("수량 변경 항목을 모두 입력해주세요."),void ne(!1);const e=Number(a.newQuantity);if(!Number.isFinite(e))return fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SupportMain.tsx:handleSubmit:validation",message:"invalid_quantity_value",data:{value:a.newQuantity},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"H2"})}).catch(()=>{}),O.error("변경 수량이 올바르지 않습니다."),void ne(!1);const s=Jt.find(e=>String(e.id)===a.itemId);if(!s)return fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SupportMain.tsx:handleSubmit:validation",message:"missing_target_item",data:{itemId:a.itemId},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"H2"})}).catch(()=>{}),O.error("선택한 품목을 찾을 수 없습니다."),void ne(!1);t.push({item_id:String(s.id),line_number:s.line_number??null,item_name:s.item_name,specification:s.specification??null,current_quantity:s.quantity??null,new_quantity:e}),l.push(`${s.line_number??"-"}번 ${s.item_name} (${s.specification||"-"}) ${s.quantity??0} → ${e}`)}n={items:t}}if("price_change"===W){const e=Ie.filter(e=>e.itemId||e.newValue.trim());if(0===e.length)return fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SupportMain.tsx:handleSubmit:validation",message:"missing_price_rows",data:{inquiryType:W,rows:Ie.length},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"H2"})}).catch(()=>{}),O.error("단가/합계 금액 변경할 품목을 추가해주세요."),void ne(!1);const t=[];for(const a of e){if(!a.itemId||!a.newValue.trim())return fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SupportMain.tsx:handleSubmit:validation",message:"invalid_price_row",data:{itemId:a.itemId,hasValue:!!a.newValue.trim(),changeType:a.changeType},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"H2"})}).catch(()=>{}),O.error("단가/합계 금액 변경 항목을 모두 입력해주세요."),void ne(!1);const e=Number(a.newValue);if(!Number.isFinite(e))return fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SupportMain.tsx:handleSubmit:validation",message:"invalid_price_value",data:{value:a.newValue,changeType:a.changeType},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"H2"})}).catch(()=>{}),O.error("변경 값이 올바르지 않습니다."),void ne(!1);const s=Jt.find(e=>String(e.id)===a.itemId);if(!s)return fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SupportMain.tsx:handleSubmit:validation",message:"missing_target_item_price",data:{itemId:a.itemId},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"H2"})}).catch(()=>{}),O.error("선택한 품목을 찾을 수 없습니다."),void ne(!1);const r=Number(s.unit_price_value??s.unit_price??0),i=Number(s.amount_value??r*(s.quantity??0)),n=Number(s.quantity??0);if("amount"===a.changeType){const a=e,c=n>0?a/n:0;t.push({item_id:String(s.id),line_number:s.line_number??null,item_name:s.item_name,specification:s.specification??null,change_type:"amount",current_unit_price:r,new_unit_price:c,current_amount:i,new_amount:a}),l.push(`${s.line_number??"-"}번 ${s.item_name} (${s.specification||"-"}) 합계 ${i.toLocaleString("ko-KR")} → ${a.toLocaleString("ko-KR")}`)}else{const a=e,c=n*a;t.push({item_id:String(s.id),line_number:s.line_number??null,item_name:s.item_name,specification:s.specification??null,change_type:"unit_price",current_unit_price:r,new_unit_price:a,current_amount:i,new_amount:c}),l.push(`${s.line_number??"-"}번 ${s.item_name} (${s.specification||"-"}) 단가 ${r.toLocaleString("ko-KR")} → ${a.toLocaleString("ko-KR")} 합계 ${i.toLocaleString("ko-KR")} → ${c.toLocaleString("ko-KR")}`)}}n={items:t}}if("delete"===W&&(n={reason:B.trim()}),fe){const e=(fe.purchase_request_items||[]).map((e,t)=>`- ${e.line_number??t+1}. ${e.item_name} (${e.specification||"-"}) ${e.quantity}개`).join("\n");i=`발주번호: ${fe.purchase_order_number||"(승인대기)"}\n업체: ${fe.vendor_name}\n요청자: ${fe.requester_name}\n요청일: ${fe.request_date||fe.created_at||"-"}\n품목:\n${e}`}const o=[B.trim()];l.length>0&&o.push(`[요청 상세]\n${l.join("\n")}`),i&&o.push(`[관련 발주 정보]\n${i}`),r=o.join("\n\n");const u=await c.createInquiry({inquiry_type:W,subject:a,message:r,purchase_request_id:fe?.id,purchase_info:i,purchase_order_number:fe?.purchase_order_number,attachments:le,inquiry_payload:n});if(fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SupportMain.tsx:handleSubmit:createInquiry",message:"submit_result",data:{success:u.success,error:u.error||null,inquiryId:u.inquiryId||null},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"H3"})}).catch(()=>{}),u.success){if("delivery-warning"===Le&&"delivery_date_change"===W&&fe?.id)try{const e=d(),t=(new Date).toISOString(),{data:{user:a}}=await e.auth.getUser(),s=a?.email||null;let r=null;if(s){const{data:t}=await e.from("employees").select("name").eq("email",s).maybeSingle();r=t?.name||null}const{error:i}=await e.from("purchase_requests").update({delivery_revision_requested:!0,delivery_revision_requested_at:t,delivery_revision_requested_by:r||s||"unknown"}).eq("id",fe.id);if(!i){m(fe.id,e=>({...e,delivery_revision_requested:!0,delivery_revision_requested_at:t,delivery_revision_requested_by:r||s||"unknown"}))&&p()}}catch{}O.success("문의가 접수되었습니다.");const e=u.inquiryId;Te||J(""),U(""),je(null),be([]),ge(void 0),ce([]),Ft(),e&&et(e),He&&He.startsWith("/")&&s(He)}else O.error(u.error||"문의 접수에 실패했습니다.");ne(!1)},className:"space-y-4",children:[a.jsxs("div",{children:[a.jsxs("label",{className:"block modal-label text-gray-700 mb-1",children:["문의 유형 ",a.jsx("span",{className:"text-red-500",children:"*"})]}),"delivery_date_change"===Te?a.jsx("div",{className:"button-base business-radius-input border border-gray-300 bg-white text-gray-700 inline-flex items-center !h-7 !px-2.5 !text-[11px]",children:"입고일 변경 요청"}):a.jsxs(I,{value:W,onValueChange:J,children:[a.jsx(C,{size:"sm",className:"button-base business-radius-input border border-gray-300 bg-white text-gray-700 w-auto !h-7 !px-2.5 !text-[11px]",style:{width:`${Xt}em`,maxWidth:"100%"},children:a.jsx(k,{placeholder:Gt})}),a.jsx($,{className:"text-[11px] business-radius-card",style:{minWidth:`${Zt}em`},children:Wt.map(e=>a.jsx(M,{className:"text-[11px] py-1.5",value:e.value,children:e.label},e.value))})]})]}),pe&&a.jsxs("div",{className:"space-y-3 p-4 bg-gray-50 business-radius-card border border-gray-200",children:[a.jsx("div",{className:"modal-section-title text-gray-900",children:$e}),"delivery_date_change"===Te&&Oe?a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"card-description text-gray-600",children:["이 화면은 ",a.jsx("span",{className:"font-medium",children:"입고일 변경 요청"})," 전용입니다."]}),fe?a.jsxs("div",{className:"px-3 py-2 bg-white border border-gray-200 business-radius-card",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"card-title",children:fe.purchase_order_number||"(승인대기)"}),a.jsx("span",{className:"card-subtitle",children:fe.vendor_name}),a.jsx("span",{className:"card-date",children:(fe.request_date||fe.created_at)&&K(new Date(fe.request_date||fe.created_at),"MM/dd")})]}),Jt.length>0&&a.jsxs("div",{className:"mt-2 space-y-1",children:[a.jsx("div",{className:"modal-label text-gray-600",children:"품목 상세"}),Jt.map((e,t)=>a.jsxs("div",{className:"flex items-center gap-2 pl-2",children:[a.jsxs("span",{className:"card-description text-gray-400",children:[e.line_number??t+1,"."]}),a.jsx("span",{className:"card-description",children:e.item_name}),e.specification&&a.jsxs("span",{className:"card-description text-gray-500",children:["(",e.specification,")"]}),a.jsxs("span",{className:"card-description text-gray-500",children:["- ",e.quantity,"개"]})]},e.id||t))]})]}):a.jsx("div",{className:"badge-text text-gray-500",children:"발주 정보를 불러오는 중…"})]}):a.jsxs(a.Fragment,{children:[a.jsxs("div",{children:[a.jsx("label",{className:"modal-label text-gray-600 mb-2 block",children:"기간 선택"}),a.jsx(ie,{date:xe,onDateChange:ge,placeholder:"발주요청 기간을 선택하세요",className:"inline-grid w-fit",style:{width:`${ca}em`,maxWidth:"100%"},triggerClassName:"button-base w-fit justify-start border border-gray-300 bg-white text-gray-700 business-radius-input"})]}),a.jsxs("div",{className:"space-y-3",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{className:"modal-label text-gray-600",children:["발주요청 선택 (총 ",ye.length,"건)"]}),ve&&a.jsx("span",{className:"badge-text text-gray-400",children:"조회 중…"})]}),a.jsx(z,{value:Vt.find(e=>e.value===String(fe?.id))||null,onChange:e=>je(e?.data||null),options:Vt,placeholder:"발주번호 선택/검색",isSearchable:!0,isLoading:ve,noOptionsMessage:()=>"일치하는 발주가 없습니다",filterOption:(e,t)=>{const a=t.toLowerCase(),s=e.label.toLowerCase(),r=e.data?.searchText||"";return s.includes(a)||r.includes(a)},styles:da(ta,aa)}),!ve&&0===ye.length&&a.jsx("div",{className:"card-description text-gray-500",children:"선택한 기간 내 발주요청이 없습니다."}),fe&&a.jsxs("div",{className:"px-3 py-2 bg-white border border-gray-200 business-radius-card",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"card-title",children:fe.purchase_order_number||"(승인대기)"}),a.jsx("span",{className:"card-subtitle",children:fe.vendor_name}),a.jsx("span",{className:"card-date",children:(fe.request_date||fe.created_at)&&K(new Date(fe.request_date||fe.created_at),"MM/dd")})]}),Jt.length>0&&a.jsxs("div",{className:"mt-2 space-y-1",children:[a.jsx("div",{className:"modal-label text-gray-600",children:"품목 상세"}),Jt.map((e,t)=>a.jsxs("div",{className:"flex items-center gap-2 pl-2",children:[a.jsxs("span",{className:"card-description text-gray-400",children:[e.line_number??t+1,"."]}),a.jsx("span",{className:"card-description",children:e.item_name}),e.specification&&a.jsxs("span",{className:"card-description text-gray-500",children:["(",e.specification,")"]}),a.jsxs("span",{className:"card-description text-gray-500",children:["- ",e.quantity,"개"]})]},e.id||t))]})]})]})]})]}),"delivery_date_change"===W&&a.jsxs("div",{className:"space-y-3 p-4 bg-gray-50 business-radius-card border border-gray-200",children:[a.jsx("div",{className:"modal-section-title text-gray-900",children:"입고일 변경 요청"}),a.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"modal-label text-gray-600 mb-1 block",children:"현재 입고요청일"}),a.jsx("div",{className:"modal-value text-gray-700",children:fe?.delivery_request_date?K(new Date(fe.delivery_request_date),"yyyy-MM-dd"):"-"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"modal-label text-gray-600 mb-1 block",children:"변경 입고일"}),a.jsx(Q,{onDateSelect:e=>we(e),placeholder:"변경 입고일 선택",align:"start",side:"bottom",children:a.jsxs(r,{type:"button",className:"button-base w-full justify-start border border-gray-300 bg-white text-gray-700 business-radius-input",disabled:!fe,children:[a.jsx(X,{className:"mr-2 h-4 w-4"}),Ne?K(Ne,"yyyy-MM-dd"):"날짜 선택"]})})]})]})]}),"quantity_change"===W&&a.jsxs("div",{className:"space-y-3 p-4 bg-gray-50 business-radius-card border border-gray-200",children:[a.jsx("div",{className:"modal-section-title text-gray-900",children:"수량 변경 요청"}),a.jsx("div",{className:"space-y-2",children:Se.map(e=>{const t=Jt.find(t=>String(t.id)===e.itemId);return a.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2",children:[a.jsx("div",{className:"flex-1",children:a.jsx(z,{value:Kt.find(t=>t.value===e.itemId)||null,onChange:t=>oa(e.id,{itemId:t?.value||""}),options:Kt,placeholder:"품목 선택/검색",isSearchable:!0,isDisabled:!fe,noOptionsMessage:()=>"일치하는 품목이 없습니다",filterOption:(e,t)=>e.label.toLowerCase().includes(t.toLowerCase()),styles:da(ra,ia)})}),a.jsx("div",{className:"badge-text text-gray-600 sm:w-24 text-right",children:"변경 수량 :"}),a.jsx(j,{type:"number",value:e.newQuantity,onChange:t=>oa(e.id,{newQuantity:t.target.value}),placeholder:`입고 수량 : ${t?.quantity??"-"}`,className:"sm:w-28 business-radius-input h-7 !text-[11px] !leading-tight",min:0,disabled:!fe}),a.jsxs("button",{type:"button",onClick:()=>{return t=e.id,void qe(e=>e.filter(e=>e.id!==t));var t},className:"button-action-danger",children:[a.jsx(f,{className:"w-3.5 h-3.5 mr-1"}),"삭제"]})]},e.id)})}),a.jsxs("button",{type:"button",onClick:()=>{qe(e=>[...e,{id:Fe(),itemId:"",newQuantity:""}])},className:"button-action-secondary",disabled:!fe,children:[a.jsx(v,{className:"w-3.5 h-3.5 mr-1"}),"품목 추가"]})]}),"price_change"===W&&a.jsxs("div",{className:"space-y-3 p-4 bg-gray-50 business-radius-card border border-gray-200",children:[a.jsx("div",{className:"modal-section-title text-gray-900",children:"단가/합계 금액 변경 요청"}),a.jsx("div",{className:"space-y-2",children:Ie.map(e=>{const t=Jt.find(t=>String(t.id)===e.itemId),s=Number(t?.unit_price_value??t?.unit_price??0),r=Number(t?.amount_value??s*(t?.quantity??0)),i=t?s.toLocaleString("ko-KR"):"-",n=t?r.toLocaleString("ko-KR"):"-",l="amount"===e.changeType?`현재 합계액: ${n}`:`현재 단가: ${i}`;return a.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center gap-2",children:[a.jsx("div",{className:"flex-1",children:a.jsx(z,{value:Kt.find(t=>t.value===e.itemId)||null,onChange:t=>ua(e.id,{itemId:t?.value||""}),options:Kt,placeholder:"품목 선택/검색",isSearchable:!0,isDisabled:!fe,noOptionsMessage:()=>"일치하는 품목이 없습니다",filterOption:(e,t)=>e.label.toLowerCase().includes(t.toLowerCase()),styles:da(ra,ia)})}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"badge-text text-gray-600",children:"변경 요청"}),a.jsxs(I,{value:e.changeType,onValueChange:t=>ua(e.id,{changeType:t,newValue:""}),disabled:!fe,children:[a.jsx(C,{size:"sm",className:"button-base business-radius-input border border-gray-300 bg-white text-gray-700 w-auto !h-7 !px-2.5 !text-[11px]",children:a.jsx(k,{})}),a.jsx($,{className:"text-[11px] business-radius-card",children:na.map(e=>a.jsx(M,{className:"text-[11px] py-1.5",value:e.value,children:e.label},e.value))})]})]}),a.jsx(j,{type:"text",inputMode:"numeric",value:la(e.newValue),onChange:t=>{return ua(e.id,{newValue:(a=t.target.value,a.replace(/[^\d]/g,""))});var a},placeholder:l,className:"lg:w-40 business-radius-input h-7 !text-[11px] !leading-tight",min:0,disabled:!fe}),a.jsxs("button",{type:"button",onClick:()=>{return t=e.id,void Ce(e=>e.filter(e=>e.id!==t));var t},className:"button-action-danger",children:[a.jsx(f,{className:"w-3.5 h-3.5 mr-1"}),"삭제"]})]},e.id)})}),a.jsxs("button",{type:"button",onClick:()=>{Ce(e=>[...e,{id:Fe(),itemId:"",changeType:"unit_price",newValue:""}])},className:"button-action-secondary",disabled:!fe,children:[a.jsx(v,{className:"w-3.5 h-3.5 mr-1"}),"품목 추가"]})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"block modal-label text-gray-700 mb-1",children:[Me," ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx(q,{value:B,onChange:e=>U(e.target.value),placeholder:"delete"===W?"삭제 사유를 입력해주세요":"문의 내용을 자세히 입력해주세요",rows:6,maxLength:1e3,className:"business-radius-input text-[11px]"}),a.jsxs("p",{className:"badge-text text-gray-500 mt-1",children:[B.length,"/1000"]})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"block modal-label text-gray-700 mb-2",children:["사진 첨부 ",a.jsx("span",{className:"badge-text text-gray-400",children:"(선택, 최대 5개)"})]}),le.length>0&&a.jsx("div",{className:"flex flex-wrap gap-2 mb-3",children:le.map((e,t)=>a.jsxs("div",{className:"relative group",children:[a.jsx("img",{src:e.url,alt:e.name,className:"w-20 h-20 object-cover business-radius-card border border-gray-200"}),a.jsx("button",{type:"button",onClick:()=>(async e=>{const t=le[e];await c.deleteAttachment(t.path),ce(t=>t.filter((t,a)=>a!==e)),O.success("첨부파일이 삭제되었습니다.")})(t),className:"button-base absolute -top-2 -right-2 bg-red-500 text-white business-radius-badge opacity-0 group-hover:opacity-100 transition-opacity",title:"삭제",children:a.jsx(i,{className:"w-3 h-3"})}),a.jsx("p",{className:"text-[10px] text-gray-500 mt-1 truncate w-20 text-center",children:e.name})]},t))}),le.length<5&&a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("input",{ref:ue,type:"file",accept:"image/*",onChange:async e=>{const t=e.target.files;if(!t||0===t.length)return;if(le.length>=5)return void O.error("첨부파일은 최대 5개까지 가능합니다.");const a=t[0];if(a.size>5242880)return void O.error("파일 크기는 5MB 이하만 가능합니다.");if(!a.type.startsWith("image/"))return void O.error("이미지 파일만 첨부 가능합니다.");oe(!0);const s=await c.uploadAttachment(a);s.success&&s.data?(ce(e=>[...e,s.data]),O.success("이미지가 첨부되었습니다.")):O.error(s.error||"이미지 업로드 실패"),oe(!1),ue.current&&(ue.current.value="")},className:"hidden"}),a.jsx("button",{type:"button",onClick:()=>ue.current?.click(),disabled:de,className:"button-action-secondary disabled:opacity-50 disabled:cursor-not-allowed",children:de?a.jsxs(a.Fragment,{children:[a.jsx(te,{className:"w-3.5 h-3.5 animate-spin"}),"업로드 중..."]}):a.jsxs(a.Fragment,{children:[a.jsx(se,{className:"w-3.5 h-3.5"}),"사진 추가"]})}),a.jsxs("span",{className:"badge-text text-gray-400",children:[le.length,"/5"]})]})]}),a.jsx("div",{className:"flex justify-end",children:a.jsx("button",{type:"submit",className:"button-action-primary",disabled:Y||de,onClick:()=>{fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SupportMain.tsx:submitButton:onClick",message:"submit_click",data:{disabled:Y||de},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"H1"})}).catch(()=>{})},children:Y?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}),"전송 중..."]}):a.jsxs(a.Fragment,{children:[a.jsx(re,{className:"w-4 h-4 mr-2"}),"문의 보내기"]})})})]})})]}),a.jsxs(x,{className:"business-radius-card border border-gray-200 shadow-sm",children:[a.jsx(g,{className:"pb-3 pt-4 px-4",children:a.jsxs(y,{className:"section-title flex items-center justify-between text-gray-900",children:[a.jsxs("span",{className:"flex items-center gap-2",children:[a.jsx(u,{className:"w-4 h-4 text-orange-500"}),We?"전체 문의 목록":"내 문의 내역"]}),a.jsxs("span",{className:"badge-stats border border-gray-300 bg-white text-gray-600",children:[Ae.length,"건"]})]})}),a.jsx(b,{className:"px-4 pb-4",children:Ge?a.jsx("div",{className:"flex items-center justify-center py-8",children:a.jsx("div",{className:"w-6 h-6 border-2 border-gray-300 border-t-transparent rounded-full animate-spin"})}):0===Ae.length?a.jsxs("div",{className:"text-center py-8 text-gray-500",children:[a.jsx(o,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),a.jsx("p",{className:"card-description text-gray-500",children:"문의 내역이 없습니다"})]}):a.jsx("div",{className:"space-y-2 max-h-[600px] overflow-y-auto",children:Ae.map(e=>a.jsxs("div",{className:"border border-gray-200 business-radius-card overflow-hidden bg-white",children:[a.jsx("div",{className:"px-4 py-1.5 hover:bg-gray-50 transition-colors cursor-pointer",onClick:()=>{et(Ze===e.id?null:e.id)},children:a.jsxs("div",{className:"flex items-center justify-between gap-2",children:[a.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0 flex-nowrap",children:[a.jsx("span",{className:"badge-stats border border-gray-300 bg-white text-gray-600 whitespace-nowrap flex-shrink-0",children:ga(e.inquiry_type)}),a.jsx("span",{className:"flex-shrink-0",children:xa(e.status)}),e.purchase_order_number?a.jsx("button",{type:"button",className:"card-title truncate flex-1 min-w-0 text-blue-600 hover:underline text-left",onClick:t=>{t.stopPropagation(),(async e=>{try{if(e.purchase_request_id)return ht(e.purchase_request_id),void mt(!0);const t=e.purchase_order_number?.trim();if(!t)return _t("발주내역이 삭제 되었거나 없습니다."),void jt(!0);const a=d(),{data:s,error:r}=await a.from("purchase_requests").select("id").eq("purchase_order_number",t).limit(1).maybeSingle();if(r)throw r;if(!s?.id)return _t("발주내역이 삭제 되었거나 없습니다."),void jt(!0);ht(s.id),mt(!0)}catch(t){_t("발주내역이 삭제 되었거나 없습니다."),jt(!0)}})(e)},title:"발주 상세 열기",children:e.purchase_order_number}):a.jsx("span",{className:"card-title truncate flex-1 min-w-0",children:e.subject}),We&&a.jsx("span",{className:"badge-text text-gray-500 whitespace-nowrap flex-shrink-0",children:e.user_name||e.user_email}),a.jsx("span",{className:"badge-text text-gray-400 ml-auto whitespace-nowrap flex-shrink-0",children:e.created_at&&K(new Date(e.created_at),"MM/dd HH:mm")})]}),a.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0",children:[We&&"open"===e.status&&a.jsx("button",{type:"button",onClick:t=>{t.stopPropagation(),ma(e.id,"in_progress")},className:"button-waiting-active",children:"처리중"}),We&&("open"===e.status||"in_progress"===e.status)&&a.jsx("button",{type:"button",onClick:t=>{t.stopPropagation(),ma(e.id,"resolved")},className:"button-action-success",children:"완료"}),(We||"open"===e.status&&!e.resolution_note&&e.user_email===Ke)&&a.jsx("button",{type:"button",onClick:t=>{t.stopPropagation(),(async e=>{if(!confirm("정말로 이 문의를 삭제하시겠습니까?\n삭제된 문의는 복구할 수 없습니다."))return;const t=await c.deleteInquiry(e);t.success?(O.success("문의가 삭제되었습니다."),Ft()):O.error(t.error||"문의 삭제 실패")})(e.id)},className:"button-base border border-red-200 bg-white text-red-600 hover:bg-red-50",title:"문의 삭제",children:a.jsx(f,{className:"w-3.5 h-3.5"})}),a.jsx("button",{type:"button",className:"button-action-secondary",children:Ze===e.id?a.jsx(T,{className:"w-4 h-4"}):a.jsx(D,{className:"w-4 h-4"})})]})]})}),Ze===e.id&&a.jsx("div",{className:"px-3 py-3 bg-gray-50 border-t",children:a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{children:[a.jsx("span",{className:"modal-value text-gray-700",children:"내용:"}),a.jsx("p",{className:"card-description text-gray-600 mt-1 whitespace-pre-wrap",children:e.message})]}),ya(e),e.handled_by&&a.jsxs("div",{children:[a.jsx("span",{className:"modal-value text-gray-700",children:"처리자:"}),a.jsxs("span",{className:"text-green-600 ml-2",children:[e.handled_by,e.processed_at&&` (${K(new Date(e.processed_at),"yyyy-MM-dd HH:mm")})`]})]}),e.attachments&&e.attachments.length>0&&a.jsxs("div",{children:[a.jsx("span",{className:"modal-value text-gray-700",children:"첨부 이미지:"}),a.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:e.attachments.map((e,t)=>a.jsx("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",className:"block",onClick:e=>e.stopPropagation(),children:a.jsx("img",{src:e.url,alt:e.name,className:"w-24 h-24 object-cover business-radius-card border border-gray-200 hover:border-blue-400 transition-colors cursor-pointer"})},t))})]}),a.jsxs("div",{className:"mt-3 border-t pt-3",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("div",{className:"modal-value text-gray-800",children:"대화"}),We&&"resolved"!==e.status&&"closed"!==e.status&&a.jsx("button",{type:"button",onClick:e=>{e.stopPropagation(),(async()=>{if(!pa?.id)return;const e=await c.resolveInquiry(pa.id);e.success?(O.success("문의가 완료 처리되었습니다."),$t(""),et(null),Ft()):O.error(e.error||"완료 처리 실패")})()},className:"button-action-success",children:"완료"})]}),a.jsxs("div",{className:"mt-2 border border-gray-200 business-radius-card bg-white relative",children:[It&&a.jsx("div",{className:"absolute top-2 right-2 badge-text text-gray-400 bg-white/80 backdrop-blur px-2 py-1 business-radius-badge border pointer-events-none","aria-hidden":"true",children:"업데이트 중…"}),a.jsx("div",{ref:Dt,className:"max-h-[260px] overflow-y-auto p-3 space-y-2",children:St&&0===Nt.length?a.jsx("div",{className:"flex items-center justify-center py-8",children:a.jsx("div",{className:"w-6 h-6 border-2 border-gray-300 border-t-transparent rounded-full animate-spin"})}):0===Nt.length?a.jsx("div",{className:"text-center text-gray-500 py-8 card-description",children:"대화 내용이 없습니다."}):Nt.map(e=>{const t="system"===e.sender_role,s=!t&&e.sender_email===Ke;return a.jsx("div",{className:t?"text-center":"flex "+(s?"justify-end":"justify-start"),children:a.jsxs("div",{className:t?"inline-block badge-text text-gray-500 px-3 py-1 business-radius-badge bg-gray-50 border":"max-w-[80%] business-radius-card px-3 py-2 "+(s?"bg-blue-600 text-white":"bg-gray-50 border text-gray-800"),children:[!t&&a.jsxs("div",{className:"badge-text mb-1 "+(s?"text-white/80":"text-gray-500"),children:["admin"===e.sender_role?"관리자":"문의자",e.created_at&&` · ${K(new Date(e.created_at),"MM/dd HH:mm")}`]}),a.jsx("div",{className:"whitespace-pre-wrap card-description",children:e.message}),e.attachments&&e.attachments.length>0&&a.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:e.attachments.map((e,t)=>a.jsx("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",className:"block",onClick:e=>e.stopPropagation(),children:a.jsx("img",{src:e.url,alt:e.name,className:"w-20 h-20 object-cover business-radius-card border"})},t))})]})},e.id)})}),a.jsx("div",{className:"border-t p-2",children:"resolved"===e.status||"closed"===e.status?a.jsx("div",{className:"card-description text-gray-500 text-center py-1",children:"완료된 문의입니다. 추가 대화가 필요하면 새 문의를 등록해주세요."}):a.jsxs("div",{className:"flex items-end gap-2",children:[a.jsx(q,{value:kt,onChange:e=>$t(e.target.value),placeholder:"메시지를 입력하세요",rows:2,maxLength:1e3,disabled:Mt,onClick:e=>e.stopPropagation(),className:"business-radius-input text-[11px]"}),a.jsx("button",{type:"button",onClick:e=>{e.stopPropagation(),(async()=>{if(!pa?.id)return;if(!kt.trim())return void O.error("메시지를 입력해주세요.");if("resolved"===pa.status||"closed"===pa.status)return void O.error("완료된 문의에는 메시지를 보낼 수 없습니다.");Tt(!0);const e=await c.sendInquiryMessage({inquiryId:pa.id,message:kt.trim(),senderRole:We?"admin":"user"});e.success?$t(""):O.error(e.error||"메시지 전송 실패"),Tt(!1)})()},disabled:Mt||!kt.trim(),className:"button-action-primary disabled:opacity-50 disabled:cursor-not-allowed",children:Mt?"전송중":"전송"})]})})]})]})]})})]},e.id))})})]})]})]}),a.jsx(_,{open:tt,onOpenChange:at,children:a.jsxs(N,{className:"max-w-6xl max-h-[90vh] overflow-y-auto business-radius-modal",children:[a.jsx(w,{children:a.jsxs(S,{className:"flex items-center justify-between modal-title text-gray-900",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{children:"발주요청 상세"}),st?.purchase_order_number&&a.jsx("span",{className:"badge-stats border border-gray-300 bg-white text-gray-600 font-normal",children:st.purchase_order_number})]}),We&&st&&a.jsxs(r,{onClick:async()=>{if(!st?.id)return;if(!confirm("이 발주요청 전체를 삭제하시겠습니까?\n모든 품목이 함께 삭제됩니다."))return;const e=await c.deletePurchaseRequest(st.id);if(e.success){h(st.id);O.success("발주요청이 삭제되었습니다."),at(!1),rt(null),Ft()}else O.error(e.error||"발주요청 삭제 실패")},className:"button-action-danger",children:[a.jsx(f,{className:"w-4 h-4 mr-1"}),"전체 삭제"]})]})}),it?a.jsx("div",{className:"flex items-center justify-center py-8",children:a.jsx("div",{className:"w-6 h-6 border-2 border-gray-300 border-t-transparent rounded-full animate-spin"})}):st&&a.jsxs("div",{className:"space-y-6",children:[a.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 p-4 bg-gray-50 border border-gray-200 business-radius-card",children:[a.jsxs("div",{children:[a.jsx("span",{className:"modal-label text-gray-500",children:"발주번호"}),a.jsx("p",{className:"modal-value mt-1",children:st.purchase_order_number||"N/A"})]}),a.jsxs("div",{children:[a.jsx("span",{className:"modal-label text-gray-500",children:"업체명"}),a.jsx("p",{className:"modal-value mt-1",children:st.vendor_name})]}),a.jsxs("div",{children:[a.jsx("span",{className:"modal-label text-gray-500",children:"요청자"}),a.jsx("p",{className:"modal-value mt-1",children:st.requester_name})]}),a.jsxs("div",{children:[a.jsx("span",{className:"modal-label text-gray-500",children:"요청일"}),a.jsx("p",{className:"modal-value mt-1",children:st.request_date&&K(new Date(st.request_date),"yyyy-MM-dd")})]})]}),a.jsxs("div",{children:[a.jsx("h3",{className:"modal-section-title mb-3",children:"품목 상세"}),a.jsx("div",{className:"border border-gray-200 business-radius-card overflow-x-auto",children:a.jsxs("table",{className:"w-full",children:[a.jsx("thead",{className:"bg-gray-50 border-b",children:a.jsxs("tr",{children:[a.jsx("th",{className:"text-left badge-text modal-value text-gray-700 px-3 py-3 w-12",children:"번호"}),a.jsx("th",{className:"text-left badge-text modal-value text-gray-700 px-3 py-3 min-w-[180px]",children:"품명"}),a.jsx("th",{className:"text-left badge-text modal-value text-gray-700 px-3 py-3 min-w-[150px]",children:"규격"}),a.jsx("th",{className:"text-center badge-text modal-value text-gray-700 px-3 py-3 w-20",children:"수량"}),a.jsx("th",{className:"text-right badge-text modal-value text-gray-700 px-3 py-3 w-28",children:"단가"}),a.jsx("th",{className:"text-right badge-text modal-value text-gray-700 px-3 py-3 w-32",children:"금액"}),a.jsx("th",{className:"text-left badge-text modal-value text-gray-700 px-3 py-3 min-w-[150px]",children:"비고"}),a.jsx("th",{className:"text-center badge-text modal-value text-gray-700 px-3 py-3 w-16",children:"링크"}),We&&a.jsx("th",{className:"text-center badge-text modal-value text-gray-700 px-3 py-3 w-24",children:"작업"})]})}),a.jsx("tbody",{className:"divide-y divide-gray-200",children:st.purchase_request_items?.map((e,t)=>a.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[a.jsx("td",{className:"px-3 py-3 text-center modal-value text-gray-600",children:e.line_number||t+1}),a.jsx("td",{className:"px-3 py-3",children:lt===e.id?a.jsx(j,{value:dt?.item_name||"",onChange:e=>ot({...dt,item_name:e.target.value}),className:"business-radius-input h-7 text-[11px] w-full",autoFocus:!0}):a.jsx("span",{className:"modal-value text-gray-900",children:e.item_name})}),a.jsx("td",{className:"px-3 py-3",children:lt===e.id?a.jsx(j,{value:dt?.specification||"",onChange:e=>ot({...dt,specification:e.target.value}),className:"business-radius-input h-7 text-[11px] w-full"}):a.jsx("span",{className:"text-gray-600",children:e.specification||"-"})}),a.jsx("td",{className:"text-center px-3 py-3",children:lt===e.id?a.jsx(j,{type:"number",value:dt?.quantity||"",onChange:e=>ot({...dt,quantity:parseInt(e.target.value)}),className:"business-radius-input h-7 text-[11px] text-center w-full"}):a.jsx("span",{className:"modal-value",children:e.quantity})}),a.jsx("td",{className:"text-right px-3 py-3",children:lt===e.id?a.jsx(j,{type:"number",value:dt?.unit_price_value||"",onChange:e=>ot({...dt,unit_price_value:parseInt(e.target.value)}),className:"business-radius-input h-7 text-[11px] text-right w-full"}):a.jsx("span",{className:"modal-value",children:e.unit_price_value?`${parseFloat(e.unit_price_value).toLocaleString()}`:"-"})}),a.jsx("td",{className:"text-right px-3 py-3",children:lt===e.id?a.jsx("span",{className:"font-semibold text-blue-600",children:((dt?.quantity||0)*(dt?.unit_price_value||0)).toLocaleString()}):a.jsx("span",{className:"font-semibold text-blue-600",children:e.amount_value?`${parseFloat(e.amount_value).toLocaleString()}`:"-"})}),a.jsx("td",{className:"px-3 py-3",children:lt===e.id?a.jsx(q,{value:dt?.remark||"",onChange:e=>ot({...dt,remark:e.target.value}),className:"business-radius-input h-7 text-[11px] w-full resize-none",rows:1}):a.jsx("span",{className:"text-gray-600 badge-text",children:e.remark||"-"})}),a.jsx("td",{className:"text-center px-3 py-3",children:e.link?a.jsx("a",{href:e.link,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center justify-center w-8 h-8 business-radius-badge hover:bg-blue-50 text-blue-600",children:a.jsx(ae,{className:"w-4 h-4"})}):a.jsx("span",{className:"text-gray-400",children:"-"})}),We&&a.jsx("td",{className:"text-center px-3 py-3",children:lt===e.id?a.jsxs("div",{className:"flex justify-center gap-1",children:[a.jsxs(r,{onClick:()=>(async e=>{if(!dt)return;const t=(dt.quantity||0)*(dt.unit_price_value||0),a=await c.updatePurchaseRequestItem(e,{item_name:dt.item_name,specification:dt.specification,quantity:dt.quantity,unit_price_value:dt.unit_price_value,amount_value:t,remark:dt.remark});a.success?(O.success("품목이 수정되었습니다."),ha()):O.error(a.error||"품목 수정 실패")})(e.id),className:"button-action-success",children:[a.jsx(G,{className:"w-4 h-4 mr-1"}),"저장"]}),a.jsx(r,{onClick:ha,className:"button-action-secondary",children:"취소"})]}):a.jsxs("div",{className:"flex justify-center gap-1",children:[a.jsx(r,{onClick:()=>(e=>{ct(e.id),ot({item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,remark:e.remark})})(e),className:"button-action-secondary",children:a.jsx(Z,{className:"w-4 h-4 text-blue-600"})}),a.jsx(r,{onClick:()=>(async e=>{if(!confirm("이 품목을 삭제하시겠습니까?"))return;const t=await c.deletePurchaseRequestItem(e);t.success?O.success("품목이 삭제되었습니다."):O.error(t.error||"품목 삭제 실패")})(e.id),className:"button-action-danger",children:a.jsx(f,{className:"w-4 h-4 text-red-600"})})]})})]},e.id))}),a.jsx("tfoot",{className:"bg-gray-50 border-t-2",children:a.jsxs("tr",{children:[a.jsx("td",{colSpan:5,className:"modal-value text-right px-3 py-3",children:"합계"}),a.jsx("td",{className:"modal-value text-right px-3 py-3 text-blue-600",children:st.purchase_request_items?.reduce((e,t)=>e+(parseFloat(t.amount_value)||0),0).toLocaleString()}),a.jsx("td",{colSpan:We?3:2,className:"px-3 py-3"})]})})]})})]}),st.notes&&a.jsxs("div",{children:[a.jsx("h3",{className:"modal-section-title mb-2",children:"비고"}),a.jsx("p",{className:"card-description text-gray-600 p-3 bg-gray-50 border border-gray-200 business-radius-card",children:st.notes})]})]})]})}),a.jsx(ee,{purchaseId:pt,isOpen:ut,onClose:()=>{mt(!1),ht(null)},currentUserRoles:Ue,activeTab:"done",onDelete:e=>{bt(e),gt(!0)}}),a.jsx(P,{open:xt,onOpenChange:e=>{gt(e),e||bt(null)},children:a.jsxs(L,{className:"business-radius-modal",children:[a.jsxs(R,{children:[a.jsx(H,{className:"modal-title",children:"발주요청 내역 삭제"}),a.jsxs(E,{children:["발주요청번호 ",a.jsx("strong",{children:yt?.purchase_order_number||"알 수 없음"}),"를 삭제하시겠습니까?",a.jsx("br",{}),"이 작업은 되돌릴 수 없습니다."]})]}),a.jsxs(F,{children:[a.jsx(A,{className:"button-action-secondary",children:"취소"}),a.jsx(V,{onClick:async()=>{if(!yt?.id)return void O.error("삭제할 발주 정보가 없습니다.");const e=d();try{const t="string"==typeof yt.id?parseInt(yt.id,10):yt.id;if(!t||Number.isNaN(t))return void O.error("발주 ID가 올바르지 않습니다.");const{error:a}=await e.from("support_inquires").update({purchase_request_id:null}).eq("purchase_request_id",t);if(a)throw a;const{error:s}=await e.from("purchase_request_items").delete().eq("purchase_request_id",t);if(s)throw s;const{error:r}=await e.from("purchase_requests").delete().eq("id",t);if(r)throw r;h(t),O.success("발주요청이 삭제되었습니다. (문의 기록은 보존됩니다)"),gt(!1),bt(null),mt(!1),ht(null),Ft()}catch(t){O.error(t instanceof Error?t.message:"삭제 중 오류가 발생했습니다.")}finally{gt(!1),bt(null)}},className:"button-action-danger",children:"삭제"})]})]})}),a.jsx(_,{open:ft,onOpenChange:jt,children:a.jsx(N,{showCloseButton:!1,maxWidth:"sm:max-w-md",className:"p-0 overflow-hidden business-radius-modal",children:a.jsxs("div",{className:"px-8 py-10 text-center",children:[a.jsx("div",{className:"modal-title text-gray-900",children:"안내"}),a.jsx("div",{className:"mt-4 modal-value text-gray-700 whitespace-pre-wrap",children:vt}),a.jsx("div",{className:"mt-6 badge-text text-gray-400",children:"화면을 클릭하거나 ESC로 닫을 수 있습니다."})]})})})]})}export{ne as default};
//# sourceMappingURL=SupportMain-BGvjtQ5m.js.map
