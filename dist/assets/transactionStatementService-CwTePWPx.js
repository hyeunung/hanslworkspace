import{e,c as t}from"./index-B0aFbCDa.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const a=e("circle-check-big",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]),r=e("image",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]]);function i(e){if(!e)return e;let t=e.toUpperCase().replace(/\s+/g,"");const a=t.match(/^(F\d{8})_(\d{1,3})$/);if(a){const[,e,t]=a;return`${e}_${t.padStart(3,"0")}`}const r=t.match(/^(HS\d{8})-(\d{1,2})$/);if(r){const[,e,t]=r;return`${e}-${t.padStart(2,"0")}`}return t}const s=new class{constructor(){this.supabase=t()}async uploadStatement(e,t){try{const a=e.name.split(".").pop()?.toLowerCase()||"png",r=crypto.randomUUID(),i=`Transaction Statement/${`${r}.${a}`}`,{data:s,error:n}=await this.supabase.storage.from("receipt-images").upload(i,e,{contentType:e.type,upsert:!1});if(n)throw n;const{data:c}=this.supabase.storage.from("receipt-images").getPublicUrl(i),o=c.publicUrl,{data:{user:u}}=await this.supabase.auth.getUser(),{data:m,error:d}=await this.supabase.from("transaction_statements").insert({image_url:o,file_name:e.name,uploaded_by:u?.id,uploaded_by_name:t,status:"pending"}).select().single();if(d)throw new Error(`DB 저장 실패: ${d.message} (code: ${d.code})`);return{success:!0,data:{statementId:m.id,imageUrl:o}}}catch(a){return{success:!1,error:a instanceof Error?a.message:"업로드 중 오류가 발생했습니다."}}}async extractStatementData(e,t){try{await this.supabase.from("transaction_statements").update({status:"processing"}).eq("id",e);const{data:a,error:r}=await this.supabase.functions.invoke("ocr-transaction-statement",{body:{statementId:e,imageUrl:t}});if(r)throw r;if(!a.success)throw new Error(a.error||"OCR 추출 실패");return await this.getStatementWithItems(e)}catch(a){return{success:!1,error:a instanceof Error?a.message:"OCR 추출 중 오류가 발생했습니다."}}}async getStatements(e){try{let t=this.supabase.from("transaction_statements").select("*",{count:"exact"}).order("uploaded_at",{ascending:!1});e?.status&&"all"!==e.status&&(t=t.eq("status",e.status)),e?.dateFrom&&(t=t.gte("uploaded_at",e.dateFrom)),e?.dateTo&&(t=t.lte("uploaded_at",e.dateTo+"T23:59:59")),e?.search&&(t=t.or(`vendor_name.ilike.%${e.search}%,file_name.ilike.%${e.search}%`)),e?.limit&&(t=t.limit(e.limit)),e?.offset&&(t=t.range(e.offset,e.offset+(e.limit||20)-1));const{data:a,count:r,error:i}=await t;if(i)throw i;return{success:!0,data:a||[],count:r||0}}catch(t){return{success:!1,error:t instanceof Error?t.message:"조회 중 오류가 발생했습니다."}}}async getStatementWithItems(e){try{const{data:t,error:a}=await this.supabase.from("transaction_statements").select("*").eq("id",e).single();if(a)throw a;const{data:r,error:i}=await this.supabase.from("transaction_statement_items").select("*").eq("statement_id",e).order("line_number",{ascending:!0});if(i)throw i;const s=t.vendor_name||"",n=await Promise.all((r||[]).map(async e=>{const t=await this.findMatchCandidates(e,s);let a,r;if(e.matched_purchase_id){const{data:t}=await this.supabase.from("purchase_requests").select("id, purchase_order_number, sales_order_number, vendor:vendors(vendor_name)").eq("id",e.matched_purchase_id).single();t&&(a={id:t.id,purchase_order_number:t.purchase_order_number||"",sales_order_number:t.sales_order_number,vendor_name:t.vendor?.vendor_name})}if(e.matched_item_id){const{data:t}=await this.supabase.from("purchase_request_items").select("id, item_name, specification, quantity, unit_price_value").eq("id",e.matched_item_id).single();t&&(r={id:t.id,item_name:t.item_name,specification:t.specification,quantity:t.quantity,unit_price_value:t.unit_price_value})}return{...e,match_candidates:t,matched_purchase:a,matched_item:r}}));return{success:!0,data:{...t,items:n}}}catch(t){return{success:!1,error:t instanceof Error?t.message:"조회 중 오류가 발생했습니다."}}}async findMatchCandidates(e,t){const a=new Map;try{const r=e.extracted_po_number||"",s=r?i(r):"",n=r.toUpperCase().match(/^(F)(\d{8})$/),c=r.toUpperCase().match(/^(HS)(\d{8})$/),o=!(!n&&!c),u=n?`F${n[2]}`:c?`HS${c[2]}`:"";if(s){const{data:r}=await this.supabase.from("purchase_requests").select("\n            id, \n            purchase_order_number, \n            sales_order_number,\n            vendor:vendors(vendor_name),\n            items:purchase_request_items(id, item_name, specification, quantity, unit_price_value)\n          ").or(`purchase_order_number.eq.${s},sales_order_number.eq.${s}`).limit(10);if(r)for(const i of r){const r=i.vendor?.vendor_name||"",s=t?this.calculateVendorSimilarity(t,r):100;if(!(s<50))for(const t of i.items||[]){const n=`${i.id}-${t.id}`,c=["발주/수주번호 일치"];let o=50;if(s>=90?(o+=10,c.push("거래처 일치")):s>=70&&(o+=5,c.push("거래처 유사")),e.extracted_item_name){const a=this.calculateItemMatchScore(e.extracted_item_name,t.item_name,t.specification);o+=.3*a.score,a.score>=80&&c.push("specification"===a.matchedField?"규격 일치":"품목명 일치")}e.extracted_quantity&&t.quantity&&(e.extracted_quantity===t.quantity?(o+=15,c.push(`수량 일치 (${e.extracted_quantity})`)):e.extracted_quantity<=t.quantity&&(o+=5,c.push(`수량 (요청:${t.quantity}, 입고:${e.extracted_quantity})`))),a.set(n,{purchase_id:i.id,purchase_order_number:i.purchase_order_number||"",sales_order_number:i.sales_order_number,item_id:t.id,item_name:t.item_name,specification:t.specification,quantity:t.quantity,unit_price:t.unit_price_value,vendor_name:r,score:o,match_reasons:c})}}}if(o&&u&&0===a.size){const{data:r}=await this.supabase.from("purchase_requests").select("\n            id, \n            purchase_order_number, \n            sales_order_number,\n            vendor:vendors(vendor_name),\n            items:purchase_request_items(id, item_name, specification, quantity, unit_price_value)\n          ").or(`purchase_order_number.ilike.${u}%,sales_order_number.ilike.${u}%`).limit(20);if(r)for(const i of r){const r=i.vendor?.vendor_name||"",s=t?this.calculateVendorSimilarity(t,r):100;if(!(s<50))for(const t of i.items||[]){const n=`${i.id}-${t.id}`;if(a.has(n))continue;const c=[`날짜 일치 (${u})`];let o=30;if(s>=90?(o+=20,c.push("거래처 일치")):s>=70&&(o+=10,c.push("거래처 유사")),e.extracted_item_name){const a=this.calculateItemMatchScore(e.extracted_item_name,t.item_name,t.specification);o+=.4*a.score,a.score>=80?c.push("specification"===a.matchedField?"규격 일치":"품목명 일치"):a.score>=50&&c.push("specification"===a.matchedField?"규격 유사":"품목명 유사")}e.extracted_quantity&&t.quantity&&(e.extracted_quantity===t.quantity?(o+=15,c.push(`수량 일치 (${e.extracted_quantity})`)):e.extracted_quantity<=t.quantity&&(o+=5,c.push(`수량 (요청:${t.quantity}, 입고:${e.extracted_quantity})`))),a.set(n,{purchase_id:i.id,purchase_order_number:i.purchase_order_number||"",sales_order_number:i.sales_order_number,item_id:t.id,item_name:t.item_name,specification:t.specification,quantity:t.quantity,unit_price:t.unit_price_value,vendor_name:r,score:o,match_reasons:c})}}}if(e.extracted_item_name){const r=e.extracted_item_name.trim(),i=[r,r.substring(0,Math.min(r.length,12)),r.substring(0,Math.min(r.length,8)),r.split(/[\[\]\s\-_]/)[0]].filter(e=>e&&e.length>=3),n=[...new Set(i)];for(const c of n){const{data:r}=await this.supabase.from("purchase_request_items").select("\n              id, \n              item_name, \n              specification, \n              quantity, \n              unit_price_value,\n              purchase:purchase_requests!inner(\n                id, \n                purchase_order_number, \n                sales_order_number,\n                vendor:vendors(vendor_name)\n              )\n            ").or(`item_name.ilike.%${c}%,specification.ilike.%${c}%`).limit(50);if(r&&r.length>0){for(const i of r){const r=`${i.purchase?.id}-${i.id}`;if(a.has(r))continue;const n=i.purchase?.vendor?.vendor_name||"",c=t?this.calculateVendorSimilarity(t,n):100;if(c<50)continue;const o=[];let u=0;c>=90?(u+=20,o.push("거래처 일치")):c>=70&&(u+=10,o.push("거래처 유사"));const m=this.calculateItemMatchScore(e.extracted_item_name,i.item_name,i.specification);m.score>=30&&(u+=.7*m.score,m.score>=80?o.push("specification"===m.matchedField?"규격 일치":"품목명 일치"):m.score>=50?o.push("specification"===m.matchedField?"규격 유사":"품목명 유사"):o.push("품목 부분일치")),e.extracted_quantity&&i.quantity&&(e.extracted_quantity===i.quantity?(u+=15,o.push(`수량 일치 (${e.extracted_quantity})`)):e.extracted_quantity<=i.quantity&&(u+=5,o.push(`수량 (요청:${i.quantity}, 입고:${e.extracted_quantity})`)));const d=i.purchase?.purchase_order_number||"",_=i.purchase?.sales_order_number||"";s&&d!==s&&_!==s&&o.push(`⚠️ OCR 오류 가능: ${s} → ${d||_}`),u>=15&&a.set(r,{purchase_id:i.purchase?.id,purchase_order_number:d,sales_order_number:_,item_id:i.id,item_name:i.item_name,specification:i.specification,quantity:i.quantity,unit_price:i.unit_price_value,vendor_name:i.purchase?.vendor?.vendor_name,score:u,match_reasons:o})}if(a.size>=5)break}}}const m=Array.from(a.values()).some(e=>e.score>=40);if((0===a.size||!m)&&t){const{data:r}=await this.supabase.from("vendors").select("id, vendor_name").limit(100);if(r){const i=r.filter(e=>this.calculateVendorSimilarity(t,e.vendor_name)>=70);if(i.length>0){const t=i.map(e=>e.id),r=new Date;r.setMonth(r.getMonth()-3);const{data:n}=await this.supabase.from("purchase_requests").select("\n                id, \n                purchase_order_number, \n                sales_order_number,\n                vendor:vendors(vendor_name),\n                items:purchase_request_items(id, item_name, specification, quantity, unit_price_value)\n              ").in("vendor_id",t).gte("created_at",r.toISOString()).order("created_at",{ascending:!1}).limit(30);if(n)for(const i of n){const t=i.vendor?.vendor_name||"";for(const r of i.items||[]){const n=`${i.id}-${r.id}`;if(a.has(n))continue;const c=["거래처 일치"];let o=20;if(e.extracted_item_name){const t=this.calculateItemMatchScore(e.extracted_item_name,r.item_name,r.specification);t.score>=30&&(o+=.5*t.score,t.score>=80?c.push("specification"===t.matchedField?"규격 일치":"품목명 일치"):t.score>=50&&c.push("specification"===t.matchedField?"규격 유사":"품목명 유사"))}e.extracted_quantity&&r.quantity&&(e.extracted_quantity===r.quantity?(o+=15,c.push(`수량 일치 (${e.extracted_quantity})`)):e.extracted_quantity<=r.quantity&&(o+=5,c.push(`수량 (요청:${r.quantity}, 입고:${e.extracted_quantity})`)));const u=i.purchase_order_number||"",m=i.sales_order_number||"";s&&c.push(`⚠️ OCR 오류 가능: ${s} → ${u||m}`),o>=15&&a.set(n,{purchase_id:i.id,purchase_order_number:u,sales_order_number:m,item_id:r.id,item_name:r.item_name,specification:r.specification,quantity:r.quantity,unit_price:r.unit_price_value,vendor_name:t,score:o,match_reasons:c})}}}}}const d=Array.from(a.values());return d.sort((e,t)=>t.score-e.score),d.length,d.slice(0,15)}catch(r){return[]}}calculateNameSimilarity(e,t){const a=e.toLowerCase().replace(/\s+/g,""),r=t.toLowerCase().replace(/\s+/g,"");if(!a||!r)return 0;if(a===r)return 100;if(a.includes(r)||r.includes(a))return 80;const i=Math.max(a.length,r.length),s=(i-this.levenshteinDistance(a,r))/i*100;return Math.round(s)}calculateItemMatchScore(e,t,a){if(!e)return{score:0,matchedField:"none"};const r=t?this.calculateNameSimilarity(e,t):0,i=a?this.calculateNameSimilarity(e,a):0;return r>=i?{score:r,matchedField:r>0?"item_name":"none"}:{score:i,matchedField:i>0?"specification":"none"}}calculateVendorSimilarity(e,t){if(!e||!t)return 0;const a=e=>e.toLowerCase().replace(/\(주\)|주식회사|㈜|주\)|주|co\.|co,|ltd\.|ltd|inc\.|inc|corp\.|corp|company|컴퍼니/gi,"").replace(/[^a-z0-9가-힣]/g,"").trim(),r=a(e),i=a(t);if(!r||!i)return 0;if(r===i)return 100;if(r.includes(i)||i.includes(r))return 90;const s={yg:["와이지","yg"],"와이지":["yg","와이지"],tech:["테크","텍","tech"],"테크":["tech","텍","테크"],"텍":["tech","테크","텍"],high:["하이","high"],"하이":["high","하이"],korea:["코리아","한국","korea"],"코리아":["korea","한국","코리아"],electric:["전기","일렉트릭","electric"],"전기":["electric","일렉트릭","전기"],steel:["스틸","철강","steel"],"스틸":["steel","철강","스틸"],metal:["메탈","금속","metal"],"메탈":["metal","금속","메탈"],system:["시스템","system"],"시스템":["system","시스템"],soft:["소프트","soft"],"소프트":["soft","소프트"],net:["넷","net"],"넷":["net","넷"],global:["글로벌","global"],"글로벌":["global","글로벌"],trade:["트레이드","무역","trade"],"트레이드":["trade","무역","트레이드"],international:["인터내셔널","international"],"인터내셔널":["international","인터내셔널"]};let n=r,c=i;for(const[m,d]of Object.entries(s)){if(r.includes(m)){for(const e of d)if(n=n.replace(m,e),n===i||i.includes(n)||n.includes(i))return 85;n=r}if(i.includes(m)){for(const e of d)if(c=c.replace(m,e),r===c||r.includes(c)||c.includes(r))return 85;c=i}}const o=Math.max(r.length,i.length),u=(o-this.levenshteinDistance(r,i))/o*100;return Math.round(u)}isVendorMatch(e,t,a=70){return this.calculateVendorSimilarity(e,t)>=a}levenshteinDistance(e,t){const a=e.length,r=t.length,i=Array(a+1).fill(null).map(()=>Array(r+1).fill(0));for(let s=0;s<=a;s++)i[s][0]=s;for(let s=0;s<=r;s++)i[0][s]=s;for(let s=1;s<=a;s++)for(let a=1;a<=r;a++)e[s-1]===t[a-1]?i[s][a]=i[s-1][a-1]:i[s][a]=Math.min(i[s-1][a-1],i[s-1][a],i[s][a-1])+1;return i[a][r]}calculateSimilarityScore(e,t){let a=0;if(e.extracted_item_name){a+=.4*this.calculateItemMatchScore(e.extracted_item_name,t.item_name||"",t.specification||"").score}if(e.extracted_specification){a+=.2*this.calculateItemMatchScore(e.extracted_specification,t.item_name||"",t.specification||"").score}if(e.extracted_quantity&&t.quantity){const r=Math.abs(e.extracted_quantity-t.quantity);0===r?a+=20:r<=.1*t.quantity?a+=15:r<=.2*t.quantity&&(a+=10)}if(e.extracted_unit_price&&t.unit_price_value){const r=Math.abs(e.extracted_unit_price-t.unit_price_value);0===r?a+=20:r<=.05*t.unit_price_value?a+=15:r<=.1*t.unit_price_value&&(a+=10)}return a}getMatchReasons(e,t,a){const r=[];if(e.extracted_item_name){const a=this.calculateItemMatchScore(e.extracted_item_name,t.item_name||"",t.specification||"");a.score>=90?r.push("specification"===a.matchedField?"규격 완전 일치":"품목명 완전 일치"):a.score>=70?r.push("specification"===a.matchedField?"규격 높은 유사도":"품목명 높은 유사도"):a.score>=50&&r.push("specification"===a.matchedField?"규격 부분 일치":"품목명 부분 일치")}return e.extracted_quantity&&t.quantity&&(e.extracted_quantity===t.quantity?r.push(`수량 일치 (${e.extracted_quantity})`):e.extracted_quantity<=t.quantity&&r.push(`수량 (요청:${t.quantity}, 입고:${e.extracted_quantity})`)),e.extracted_unit_price===t.unit_price_value&&r.push("단가 일치"),a>=70?r.push("높은 유사도"):a>=50&&r.push("보통 유사도"),r}async updateItemMatch(e,t,a,r="manual"){try{const{error:i}=await this.supabase.from("transaction_statement_items").update({matched_purchase_id:t,matched_item_id:a,match_method:r}).eq("id",e);if(i)throw i;return{success:!0}}catch(i){return{success:!1,error:i instanceof Error?i.message:"매칭 업데이트 중 오류가 발생했습니다."}}}async confirmStatement(e,t){try{const{data:{user:a}}=await this.supabase.auth.getUser();for(const t of e.items){const{error:e}=await this.supabase.from("transaction_statement_items").update({is_confirmed:!0,matched_purchase_id:t.matched_purchase_id,matched_item_id:t.matched_item_id,confirmed_quantity:t.confirmed_quantity,confirmed_unit_price:t.confirmed_unit_price,confirmed_amount:t.confirmed_amount,is_additional_item:t.is_additional_item||!1,parent_item_id:t.parent_item_id}).eq("id",t.itemId);if(e)throw e;if(t.matched_item_id&&void 0!==t.confirmed_unit_price){const{error:e}=await this.supabase.from("purchase_request_items").update({unit_price_value:t.confirmed_unit_price,amount_value:t.confirmed_amount}).eq("id",t.matched_item_id)}if(t.is_additional_item&&t.matched_purchase_id&&!t.matched_item_id){const e=await this.getStatementItem(t.itemId);if(e){const{error:a}=await this.supabase.from("purchase_request_items").insert({purchase_request_id:t.matched_purchase_id,item_name:e.extracted_item_name||"추가 공정",specification:e.extracted_specification,quantity:t.confirmed_quantity||e.extracted_quantity||1,unit_price_value:t.confirmed_unit_price||e.extracted_unit_price,amount_value:t.confirmed_amount||e.extracted_amount,remark:"거래명세서에서 추가됨"})}}}const{error:r}=await this.supabase.from("transaction_statements").update({status:"confirmed",confirmed_at:(new Date).toISOString(),confirmed_by:a?.id,confirmed_by_name:t}).eq("id",e.statementId);if(r)throw r;return{success:!0}}catch(a){return{success:!1,error:a instanceof Error?a.message:"확정 중 오류가 발생했습니다."}}}async getStatementItem(e){const{data:t}=await this.supabase.from("transaction_statement_items").select("*").eq("id",e).single();return t}async rejectStatement(e){try{const{error:t}=await this.supabase.from("transaction_statements").update({status:"rejected"}).eq("id",e);if(t)throw t;return{success:!0}}catch(t){return{success:!1,error:t instanceof Error?t.message:"거부 처리 중 오류가 발생했습니다."}}}async deleteStatement(e){try{const{data:a}=await this.supabase.from("transaction_statements").select("image_url").eq("id",e).single(),{error:r}=await this.supabase.from("transaction_statements").delete().eq("id",e);if(r)throw r;if(a?.image_url)try{const e=a.image_url.split("/receipt-images/")[1];e&&await this.supabase.storage.from("receipt-images").remove([e])}catch(t){}return{success:!0}}catch(a){return{success:!1,error:a instanceof Error?a.message:"삭제 중 오류가 발생했습니다."}}}async findBestMatchingPurchaseOrderSet(e,t,a){try{const r=t?i(t):"",s=[];if(r){const{data:t}=await this.supabase.from("purchase_requests").select("\n            id, \n            purchase_order_number, \n            sales_order_number,\n            vendor:vendors(vendor_name),\n            items:purchase_request_items(id, item_name, specification, quantity, unit_price_value)\n          ").or(`purchase_order_number.eq.${r},sales_order_number.eq.${r}`).limit(5);if(t&&t.length>0)for(const r of t){const t=r.vendor?.vendor_name||"";if((a?this.calculateVendorSimilarity(a,t):100)<50)continue;const i=this.calculateSetMatchScore(e,r.items||[]);s.push({purchase_id:r.id,purchase_order_number:r.purchase_order_number||"",sales_order_number:r.sales_order_number,vendor_name:t,matchScore:i.score,matchedItemCount:i.matchedCount,totalItemCount:e.length,items:r.items||[],itemMatches:i.itemMatches})}}const n=s.length>0?s.reduce((e,t)=>e.matchScore>t.matchScore?e:t):null;if(n&&n.matchScore>=80)return{success:!0,data:{bestMatch:{...n,confidence:"high"},candidates:s.map(e=>({purchase_id:e.purchase_id,purchase_order_number:e.purchase_order_number,sales_order_number:e.sales_order_number,vendor_name:e.vendor_name,matchScore:e.matchScore,matchedItemCount:e.matchedItemCount}))}};const c=new Date;c.setMonth(c.getMonth()-3);const{data:o}=await this.supabase.from("purchase_requests").select("\n          id, \n          purchase_order_number, \n          sales_order_number,\n          vendor:vendors(vendor_name),\n          items:purchase_request_items(id, item_name, specification, quantity, unit_price_value)\n        ").gte("created_at",c.toISOString()).order("created_at",{ascending:!1}).limit(100);if(o)for(const t of o){if(s.some(e=>e.purchase_id===t.id))continue;const r=t.vendor?.vendor_name||"";if((a?this.calculateVendorSimilarity(a,r):100)<50)continue;const i=this.calculateSetMatchScore(e,t.items||[]);i.score>=30&&s.push({purchase_id:t.id,purchase_order_number:t.purchase_order_number||"",sales_order_number:t.sales_order_number,vendor_name:r,matchScore:i.score,matchedItemCount:i.matchedCount,totalItemCount:e.length,items:t.items||[],itemMatches:i.itemMatches})}s.sort((e,t)=>t.matchScore-e.matchScore);const u=s.length>0?s[0]:null;return{success:!0,data:{bestMatch:u?{...u,confidence:u.matchScore>=80?"high":u.matchScore>=50?"medium":"low"}:null,candidates:s.slice(0,10).map(e=>({purchase_id:e.purchase_id,purchase_order_number:e.purchase_order_number,sales_order_number:e.sales_order_number,vendor_name:e.vendor_name,matchScore:e.matchScore,matchedItemCount:e.matchedItemCount}))}}}catch(r){return{success:!1,error:r instanceof Error?r.message:"세트 매칭 중 오류가 발생했습니다."}}}calculateSetMatchScore(e,t){if(0===e.length||0===t.length)return{score:0,matchedCount:0,itemMatches:[]};const a=[],r=new Set;let i=0;for(const o of e){let e=null;for(const a of t){if(r.has(a.id))continue;const t=this.calculateItemMatchScore(o.extracted_item_name||"",a.item_name||"",a.specification||"");let i=0;o.extracted_quantity&&a.quantity&&(o.extracted_quantity===a.quantity?i=15:o.extracted_quantity<=a.quantity&&(i=5));const s=t.score+i;(!e||s>e.similarity)&&(e={id:a.id,name:a.item_name,similarity:s})}e&&e.similarity>=40&&(r.add(e.id),i+=e.similarity,a.push({ocrItemId:o.id,systemItemId:e.id,systemItemName:e.name,similarity:e.similarity}))}const s=a.length/e.length,n=a.length>0?i/a.length:0,c=Math.round(50*s+.5*n);return{score:Math.min(100,c),matchedCount:a.length,itemMatches:a}}async saveCorrection(e){try{const{data:{user:t}}=await this.supabase.auth.getUser(),{error:a}=await this.supabase.from("ocr_corrections").insert({statement_id:e.statement_id,statement_item_id:e.statement_item_id,original_text:e.original_text,corrected_text:e.corrected_text,field_type:e.field_type,corrected_by:t?.id});if(a)throw a;return{success:!0}}catch(t){return{success:!1,error:t instanceof Error?t.message:"교정 데이터 저장 중 오류가 발생했습니다."}}}async getStatementsByPurchaseId(e){try{const{data:t}=await this.supabase.from("transaction_statement_items").select("statement_id").eq("matched_purchase_id",e);if(!t||0===t.length)return{success:!0,data:[]};const a=[...new Set(t.map(e=>e.statement_id))],{data:r,error:i}=await this.supabase.from("transaction_statements").select("*").in("id",a).order("uploaded_at",{ascending:!1});if(i)throw i;return{success:!0,data:r||[]}}catch(t){return{success:!1,error:t instanceof Error?t.message:"조회 중 오류가 발생했습니다."}}}};export{a as C,r as I,i as n,s as t};
//# sourceMappingURL=transactionStatementService-CwTePWPx.js.map
