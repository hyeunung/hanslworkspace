import{e,r as t,R as a,O as n,j as r,B as i,c as s,l as c,a7 as o,a8 as l,a9 as d,aa as u,ab as m,d as p,u as h,w as _,X as g,J as f,z as v,Q as x,P as b,ac as y,ad as w,s as N,g as j,ae as S,af as q,ag as k}from"./index-DsAL4iro.js";import{d as C,b as I}from"./helpers-CmqE03mo.js";import{C as D,k as M,D as $,f as R,S as E}from"./react-select.esm-xf0YyH9B.js";import{I as T,P as O,D as P,a as A,b as F,c as L}from"./dialog-B22Nto94.js";import{P as W,a as z,b as B,S as U}from"./popover-CdBmGBMH.js";import{T as K}from"./textarea-CLkwskUf.js";import{S as H,a as Q,b as V,c as X,d as J}from"./select-8avWESM0.js";import{t as Y}from"./index-Dz8943Z0.js";import{C as G}from"./calendar-TX1shQE9.js";import{C as Z}from"./check-B6iIntpq.js";import{C as ee}from"./credit-card-jVf85E50.js";import{T as te}from"./card-C_LMoGjm.js";import{L as ae}from"./loader-circle-FAMWboDr.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=e("circle-check-big",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]),re=e("dollar-sign",[["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}],["path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6",key:"1b0p4s"}]]),ie=e("grip-vertical",[["circle",{cx:"9",cy:"12",r:"1",key:"1vctgf"}],["circle",{cx:"9",cy:"5",r:"1",key:"hp0tcf"}],["circle",{cx:"9",cy:"19",r:"1",key:"fkjjf6"}],["circle",{cx:"15",cy:"12",r:"1",key:"1tmaij"}],["circle",{cx:"15",cy:"5",r:"1",key:"19l28e"}],["circle",{cx:"15",cy:"19",r:"1",key:"f4zoj3"}]]),se=e("image",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]]),ce=e("list-plus",[["path",{d:"M11 12H3",key:"51ecnj"}],["path",{d:"M16 6H3",key:"1wxfjs"}],["path",{d:"M16 18H3",key:"12xzn7"}],["path",{d:"M18 9v6",key:"1twb98"}],["path",{d:"M21 12h-6",key:"bt1uis"}]]),oe=e("message-square-plus",[["path",{d:"M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z",key:"18887p"}],["path",{d:"M12 8v6",key:"1ib9pf"}],["path",{d:"M9 11h6",key:"1fldmi"}]]),le=e("pen",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]]),de=e("truck",[["path",{d:"M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2",key:"wrbu53"}],["path",{d:"M15 18H9",key:"1lyqi6"}],["path",{d:"M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14",key:"lysw3i"}],["circle",{cx:"17",cy:"18",r:"2",key:"332jqn"}],["circle",{cx:"7",cy:"18",r:"2",key:"19iecd"}]]);const ue="undefined"!=typeof window&&void 0!==window.document&&void 0!==window.document.createElement;function me(e){const t=Object.prototype.toString.call(e);return"[object Window]"===t||"[object global]"===t}function pe(e){return"nodeType"in e}function he(e){var t,a;return e?me(e)?e:pe(e)&&null!=(t=null==(a=e.ownerDocument)?void 0:a.defaultView)?t:window:window}function _e(e){const{Document:t}=he(e);return e instanceof t}function ge(e){return!me(e)&&e instanceof he(e).HTMLElement}function fe(e){return e instanceof he(e).SVGElement}function ve(e){return e?me(e)?e.document:pe(e)?_e(e)?e:ge(e)||fe(e)?e.ownerDocument:document:document:document}const xe=ue?t.useLayoutEffect:t.useEffect;function be(e){const a=t.useRef(e);return xe(()=>{a.current=e}),t.useCallback(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return null==a.current?void 0:a.current(...t)},[])}function ye(e,a){void 0===a&&(a=[e]);const n=t.useRef(e);return xe(()=>{n.current!==e&&(n.current=e)},a),n}function we(e,a){const n=t.useRef();return t.useMemo(()=>{const t=e(n.current);return n.current=t,t},[...a])}function Ne(e){const a=be(e),n=t.useRef(null),r=t.useCallback(e=>{e!==n.current&&(null==a||a(e,n.current)),n.current=e},[]);return[n,r]}function je(e){const a=t.useRef();return t.useEffect(()=>{a.current=e},[e]),a.current}let Se={};function qe(e,a){return t.useMemo(()=>{if(a)return a;const t=null==Se[e]?0:Se[e]+1;return Se[e]=t,e+"-"+t},[e,a])}function ke(e){return function(t){for(var a=arguments.length,n=new Array(a>1?a-1:0),r=1;r<a;r++)n[r-1]=arguments[r];return n.reduce((t,a)=>{const n=Object.entries(a);for(const[r,i]of n){const a=t[r];null!=a&&(t[r]=a+e*i)}return t},{...t})}}const Ce=ke(1),Ie=ke(-1);function De(e){if(!e)return!1;const{KeyboardEvent:t}=he(e.target);return t&&e instanceof t}function Me(e){if(function(e){if(!e)return!1;const{TouchEvent:t}=he(e.target);return t&&e instanceof t}(e)){if(e.touches&&e.touches.length){const{clientX:t,clientY:a}=e.touches[0];return{x:t,y:a}}if(e.changedTouches&&e.changedTouches.length){const{clientX:t,clientY:a}=e.changedTouches[0];return{x:t,y:a}}}return function(e){return"clientX"in e&&"clientY"in e}(e)?{x:e.clientX,y:e.clientY}:null}const $e=Object.freeze({Translate:{toString(e){if(!e)return;const{x:t,y:a}=e;return"translate3d("+(t?Math.round(t):0)+"px, "+(a?Math.round(a):0)+"px, 0)"}},Scale:{toString(e){if(!e)return;const{scaleX:t,scaleY:a}=e;return"scaleX("+t+") scaleY("+a+")"}},Transform:{toString(e){if(e)return[$e.Translate.toString(e),$e.Scale.toString(e)].join(" ")}},Transition:{toString(e){let{property:t,duration:a,easing:n}=e;return t+" "+a+"ms "+n}}}),Re="a,frame,iframe,input:not([type=hidden]):not(:disabled),select:not(:disabled),textarea:not(:disabled),button:not(:disabled),*[tabindex]";function Ee(e){return e.matches(Re)?e:e.querySelector(Re)}const Te={display:"none"};function Oe(e){let{id:t,value:n}=e;return a.createElement("div",{id:t,style:Te},n)}function Pe(e){let{id:t,announcement:n,ariaLiveType:r="assertive"}=e;return a.createElement("div",{id:t,style:{position:"fixed",top:0,left:0,width:1,height:1,margin:-1,border:0,padding:0,overflow:"hidden",clip:"rect(0 0 0 0)",clipPath:"inset(100%)",whiteSpace:"nowrap"},role:"status","aria-live":r,"aria-atomic":!0},n)}const Ae=t.createContext(null);const Fe={draggable:"\n    To pick up a draggable item, press the space bar.\n    While dragging, use the arrow keys to move the item.\n    Press space again to drop the item in its new position, or press escape to cancel.\n  "},Le={onDragStart(e){let{active:t}=e;return"Picked up draggable item "+t.id+"."},onDragOver(e){let{active:t,over:a}=e;return a?"Draggable item "+t.id+" was moved over droppable area "+a.id+".":"Draggable item "+t.id+" is no longer over a droppable area."},onDragEnd(e){let{active:t,over:a}=e;return a?"Draggable item "+t.id+" was dropped over droppable area "+a.id:"Draggable item "+t.id+" was dropped."},onDragCancel(e){let{active:t}=e;return"Dragging was cancelled. Draggable item "+t.id+" was dropped."}};function We(e){let{announcements:r=Le,container:i,hiddenTextDescribedById:s,screenReaderInstructions:c=Fe}=e;const{announce:o,announcement:l}=function(){const[e,a]=t.useState("");return{announce:t.useCallback(e=>{null!=e&&a(e)},[]),announcement:e}}(),d=qe("DndLiveRegion"),[u,m]=t.useState(!1);if(t.useEffect(()=>{m(!0)},[]),function(e){const a=t.useContext(Ae);t.useEffect(()=>{if(!a)throw new Error("useDndMonitor must be used within a children of <DndContext>");return a(e)},[e,a])}(t.useMemo(()=>({onDragStart(e){let{active:t}=e;o(r.onDragStart({active:t}))},onDragMove(e){let{active:t,over:a}=e;r.onDragMove&&o(r.onDragMove({active:t,over:a}))},onDragOver(e){let{active:t,over:a}=e;o(r.onDragOver({active:t,over:a}))},onDragEnd(e){let{active:t,over:a}=e;o(r.onDragEnd({active:t,over:a}))},onDragCancel(e){let{active:t,over:a}=e;o(r.onDragCancel({active:t,over:a}))}}),[o,r])),!u)return null;const p=a.createElement(a.Fragment,null,a.createElement(Oe,{id:s,value:c.draggable}),a.createElement(Pe,{id:d,announcement:l}));return i?n.createPortal(p,i):p}var ze,Be;function Ue(){}(Be=ze||(ze={})).DragStart="dragStart",Be.DragMove="dragMove",Be.DragEnd="dragEnd",Be.DragCancel="dragCancel",Be.DragOver="dragOver",Be.RegisterDroppable="registerDroppable",Be.SetDroppableDisabled="setDroppableDisabled",Be.UnregisterDroppable="unregisterDroppable";const Ke=Object.freeze({x:0,y:0});function He(e,t){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}function Qe(e,t){let{data:{value:a}}=e,{data:{value:n}}=t;return a-n}function Ve(e,t){let{data:{value:a}}=e,{data:{value:n}}=t;return n-a}function Xe(e,t,a){return void 0===t&&(t=e.left),void 0===a&&(a=e.top),{x:t+.5*e.width,y:a+.5*e.height}}const Je=e=>{let{collisionRect:t,droppableRects:a,droppableContainers:n}=e;const r=Xe(t,t.left,t.top),i=[];for(const s of n){const{id:e}=s,t=a.get(e);if(t){const a=He(Xe(t),r);i.push({id:e,data:{droppableContainer:s,value:a}})}}return i.sort(Qe)};function Ye(e,t){const a=Math.max(t.top,e.top),n=Math.max(t.left,e.left),r=Math.min(t.left+t.width,e.left+e.width),i=Math.min(t.top+t.height,e.top+e.height),s=r-n,c=i-a;if(n<r&&a<i){const a=t.width*t.height,n=e.width*e.height,r=s*c;return Number((r/(a+n-r)).toFixed(4))}return 0}const Ge=e=>{let{collisionRect:t,droppableRects:a,droppableContainers:n}=e;const r=[];for(const i of n){const{id:e}=i,n=a.get(e);if(n){const a=Ye(n,t);a>0&&r.push({id:e,data:{droppableContainer:i,value:a}})}}return r.sort(Ve)};function Ze(e,t){return e&&t?{x:e.left-t.left,y:e.top-t.top}:Ke}function et(e){return function(t){for(var a=arguments.length,n=new Array(a>1?a-1:0),r=1;r<a;r++)n[r-1]=arguments[r];return n.reduce((t,a)=>({...t,top:t.top+e*a.y,bottom:t.bottom+e*a.y,left:t.left+e*a.x,right:t.right+e*a.x}),{...t})}}const tt=et(1);const at={ignoreTransform:!1};function nt(e,t){void 0===t&&(t=at);let a=e.getBoundingClientRect();if(t.ignoreTransform){const{transform:t,transformOrigin:n}=he(e).getComputedStyle(e);t&&(a=function(e,t,a){const n=function(e){if(e.startsWith("matrix3d(")){const t=e.slice(9,-1).split(/, /);return{x:+t[12],y:+t[13],scaleX:+t[0],scaleY:+t[5]}}if(e.startsWith("matrix(")){const t=e.slice(7,-1).split(/, /);return{x:+t[4],y:+t[5],scaleX:+t[0],scaleY:+t[3]}}return null}(t);if(!n)return e;const{scaleX:r,scaleY:i,x:s,y:c}=n,o=e.left-s-(1-r)*parseFloat(a),l=e.top-c-(1-i)*parseFloat(a.slice(a.indexOf(" ")+1)),d=r?e.width/r:e.width,u=i?e.height/i:e.height;return{width:d,height:u,top:l,right:o+d,bottom:l+u,left:o}}(a,t,n))}const{top:n,left:r,width:i,height:s,bottom:c,right:o}=a;return{top:n,left:r,width:i,height:s,bottom:c,right:o}}function rt(e){return nt(e,{ignoreTransform:!0})}function it(e,t){const a=[];return e?function n(r){if(null!=t&&a.length>=t)return a;if(!r)return a;if(_e(r)&&null!=r.scrollingElement&&!a.includes(r.scrollingElement))return a.push(r.scrollingElement),a;if(!ge(r)||fe(r))return a;if(a.includes(r))return a;const i=he(e).getComputedStyle(r);return r!==e&&function(e,t){void 0===t&&(t=he(e).getComputedStyle(e));const a=/(auto|scroll|overlay)/;return["overflow","overflowX","overflowY"].some(e=>{const n=t[e];return"string"==typeof n&&a.test(n)})}(r,i)&&a.push(r),function(e,t){return void 0===t&&(t=he(e).getComputedStyle(e)),"fixed"===t.position}(r,i)?a:n(r.parentNode)}(e):a}function st(e){const[t]=it(e,1);return null!=t?t:null}function ct(e){return ue&&e?me(e)?e:pe(e)?_e(e)||e===ve(e).scrollingElement?window:ge(e)?e:null:null:null}function ot(e){return me(e)?e.scrollX:e.scrollLeft}function lt(e){return me(e)?e.scrollY:e.scrollTop}function dt(e){return{x:ot(e),y:lt(e)}}var ut,mt;function pt(e){return!(!ue||!e)&&e===document.scrollingElement}function ht(e){const t={x:0,y:0},a=pt(e)?{height:window.innerHeight,width:window.innerWidth}:{height:e.clientHeight,width:e.clientWidth},n={x:e.scrollWidth-a.width,y:e.scrollHeight-a.height};return{isTop:e.scrollTop<=t.y,isLeft:e.scrollLeft<=t.x,isBottom:e.scrollTop>=n.y,isRight:e.scrollLeft>=n.x,maxScroll:n,minScroll:t}}(mt=ut||(ut={}))[mt.Forward=1]="Forward",mt[mt.Backward=-1]="Backward";const _t={x:.2,y:.2};function gt(e,t,a,n,r){let{top:i,left:s,right:c,bottom:o}=a;void 0===n&&(n=10),void 0===r&&(r=_t);const{isTop:l,isBottom:d,isLeft:u,isRight:m}=ht(e),p={x:0,y:0},h={x:0,y:0},_=t.height*r.y,g=t.width*r.x;return!l&&i<=t.top+_?(p.y=ut.Backward,h.y=n*Math.abs((t.top+_-i)/_)):!d&&o>=t.bottom-_&&(p.y=ut.Forward,h.y=n*Math.abs((t.bottom-_-o)/_)),!m&&c>=t.right-g?(p.x=ut.Forward,h.x=n*Math.abs((t.right-g-c)/g)):!u&&s<=t.left+g&&(p.x=ut.Backward,h.x=n*Math.abs((t.left+g-s)/g)),{direction:p,speed:h}}function ft(e){if(e===document.scrollingElement){const{innerWidth:e,innerHeight:t}=window;return{top:0,left:0,right:e,bottom:t,width:e,height:t}}const{top:t,left:a,right:n,bottom:r}=e.getBoundingClientRect();return{top:t,left:a,right:n,bottom:r,width:e.clientWidth,height:e.clientHeight}}function vt(e){return e.reduce((e,t)=>Ce(e,dt(t)),Ke)}const xt=[["x",["left","right"],function(e){return e.reduce((e,t)=>e+ot(t),0)}],["y",["top","bottom"],function(e){return e.reduce((e,t)=>e+lt(t),0)}]];class bt{constructor(e,t){this.rect=void 0,this.width=void 0,this.height=void 0,this.top=void 0,this.bottom=void 0,this.right=void 0,this.left=void 0;const a=it(t),n=vt(a);this.rect={...e},this.width=e.width,this.height=e.height;for(const[r,i,s]of xt)for(const e of i)Object.defineProperty(this,e,{get:()=>{const t=s(a),i=n[r]-t;return this.rect[e]+i},enumerable:!0});Object.defineProperty(this,"rect",{enumerable:!1})}}class yt{constructor(e){this.target=void 0,this.listeners=[],this.removeAll=()=>{this.listeners.forEach(e=>{var t;return null==(t=this.target)?void 0:t.removeEventListener(...e)})},this.target=e}add(e,t,a){var n;null==(n=this.target)||n.addEventListener(e,t,a),this.listeners.push([e,t,a])}}function wt(e,t){const a=Math.abs(e.x),n=Math.abs(e.y);return"number"==typeof t?Math.sqrt(a**2+n**2)>t:"x"in t&&"y"in t?a>t.x&&n>t.y:"x"in t?a>t.x:"y"in t&&n>t.y}var Nt,jt,St,qt;function kt(e){e.preventDefault()}function Ct(e){e.stopPropagation()}(jt=Nt||(Nt={})).Click="click",jt.DragStart="dragstart",jt.Keydown="keydown",jt.ContextMenu="contextmenu",jt.Resize="resize",jt.SelectionChange="selectionchange",jt.VisibilityChange="visibilitychange",(qt=St||(St={})).Space="Space",qt.Down="ArrowDown",qt.Right="ArrowRight",qt.Left="ArrowLeft",qt.Up="ArrowUp",qt.Esc="Escape",qt.Enter="Enter",qt.Tab="Tab";const It={start:[St.Space,St.Enter],cancel:[St.Esc],end:[St.Space,St.Enter,St.Tab]},Dt=(e,t)=>{let{currentCoordinates:a}=t;switch(e.code){case St.Right:return{...a,x:a.x+25};case St.Left:return{...a,x:a.x-25};case St.Down:return{...a,y:a.y+25};case St.Up:return{...a,y:a.y-25}}};class Mt{constructor(e){this.props=void 0,this.autoScrollEnabled=!1,this.referenceCoordinates=void 0,this.listeners=void 0,this.windowListeners=void 0,this.props=e;const{event:{target:t}}=e;this.props=e,this.listeners=new yt(ve(t)),this.windowListeners=new yt(he(t)),this.handleKeyDown=this.handleKeyDown.bind(this),this.handleCancel=this.handleCancel.bind(this),this.attach()}attach(){this.handleStart(),this.windowListeners.add(Nt.Resize,this.handleCancel),this.windowListeners.add(Nt.VisibilityChange,this.handleCancel),setTimeout(()=>this.listeners.add(Nt.Keydown,this.handleKeyDown))}handleStart(){const{activeNode:e,onStart:t}=this.props,a=e.node.current;a&&function(e,t){if(void 0===t&&(t=nt),!e)return;const{top:a,left:n,bottom:r,right:i}=t(e);st(e)&&(r<=0||i<=0||a>=window.innerHeight||n>=window.innerWidth)&&e.scrollIntoView({block:"center",inline:"center"})}(a),t(Ke)}handleKeyDown(e){if(De(e)){const{active:t,context:a,options:n}=this.props,{keyboardCodes:r=It,coordinateGetter:i=Dt,scrollBehavior:s="smooth"}=n,{code:c}=e;if(r.end.includes(c))return void this.handleEnd(e);if(r.cancel.includes(c))return void this.handleCancel(e);const{collisionRect:o}=a.current,l=o?{x:o.left,y:o.top}:Ke;this.referenceCoordinates||(this.referenceCoordinates=l);const d=i(e,{active:t,context:a.current,currentCoordinates:l});if(d){const t=Ie(d,l),n={x:0,y:0},{scrollableAncestors:r}=a.current;for(const a of r){const r=e.code,{isTop:i,isRight:c,isLeft:o,isBottom:l,maxScroll:u,minScroll:m}=ht(a),p=ft(a),h={x:Math.min(r===St.Right?p.right-p.width/2:p.right,Math.max(r===St.Right?p.left:p.left+p.width/2,d.x)),y:Math.min(r===St.Down?p.bottom-p.height/2:p.bottom,Math.max(r===St.Down?p.top:p.top+p.height/2,d.y))},_=r===St.Right&&!c||r===St.Left&&!o,g=r===St.Down&&!l||r===St.Up&&!i;if(_&&h.x!==d.x){const e=a.scrollLeft+t.x,i=r===St.Right&&e<=u.x||r===St.Left&&e>=m.x;if(i&&!t.y)return void a.scrollTo({left:e,behavior:s});n.x=i?a.scrollLeft-e:r===St.Right?a.scrollLeft-u.x:a.scrollLeft-m.x,n.x&&a.scrollBy({left:-n.x,behavior:s});break}if(g&&h.y!==d.y){const e=a.scrollTop+t.y,i=r===St.Down&&e<=u.y||r===St.Up&&e>=m.y;if(i&&!t.x)return void a.scrollTo({top:e,behavior:s});n.y=i?a.scrollTop-e:r===St.Down?a.scrollTop-u.y:a.scrollTop-m.y,n.y&&a.scrollBy({top:-n.y,behavior:s});break}}this.handleMove(e,Ce(Ie(d,this.referenceCoordinates),n))}}}handleMove(e,t){const{onMove:a}=this.props;e.preventDefault(),a(t)}handleEnd(e){const{onEnd:t}=this.props;e.preventDefault(),this.detach(),t()}handleCancel(e){const{onCancel:t}=this.props;e.preventDefault(),this.detach(),t()}detach(){this.listeners.removeAll(),this.windowListeners.removeAll()}}function $t(e){return Boolean(e&&"distance"in e)}function Rt(e){return Boolean(e&&"delay"in e)}Mt.activators=[{eventName:"onKeyDown",handler:(e,t,a)=>{let{keyboardCodes:n=It,onActivation:r}=t,{active:i}=a;const{code:s}=e.nativeEvent;if(n.start.includes(s)){const t=i.activatorNode.current;return(!t||e.target===t)&&(e.preventDefault(),null==r||r({event:e.nativeEvent}),!0)}return!1}}];class Et{constructor(e,t,a){var n;void 0===a&&(a=function(e){const{EventTarget:t}=he(e);return e instanceof t?e:ve(e)}(e.event.target)),this.props=void 0,this.events=void 0,this.autoScrollEnabled=!0,this.document=void 0,this.activated=!1,this.initialCoordinates=void 0,this.timeoutId=null,this.listeners=void 0,this.documentListeners=void 0,this.windowListeners=void 0,this.props=e,this.events=t;const{event:r}=e,{target:i}=r;this.props=e,this.events=t,this.document=ve(i),this.documentListeners=new yt(this.document),this.listeners=new yt(a),this.windowListeners=new yt(he(i)),this.initialCoordinates=null!=(n=Me(r))?n:Ke,this.handleStart=this.handleStart.bind(this),this.handleMove=this.handleMove.bind(this),this.handleEnd=this.handleEnd.bind(this),this.handleCancel=this.handleCancel.bind(this),this.handleKeydown=this.handleKeydown.bind(this),this.removeTextSelection=this.removeTextSelection.bind(this),this.attach()}attach(){const{events:e,props:{options:{activationConstraint:t,bypassActivationConstraint:a}}}=this;if(this.listeners.add(e.move.name,this.handleMove,{passive:!1}),this.listeners.add(e.end.name,this.handleEnd),e.cancel&&this.listeners.add(e.cancel.name,this.handleCancel),this.windowListeners.add(Nt.Resize,this.handleCancel),this.windowListeners.add(Nt.DragStart,kt),this.windowListeners.add(Nt.VisibilityChange,this.handleCancel),this.windowListeners.add(Nt.ContextMenu,kt),this.documentListeners.add(Nt.Keydown,this.handleKeydown),t){if(null!=a&&a({event:this.props.event,activeNode:this.props.activeNode,options:this.props.options}))return this.handleStart();if(Rt(t))return this.timeoutId=setTimeout(this.handleStart,t.delay),void this.handlePending(t);if($t(t))return void this.handlePending(t)}this.handleStart()}detach(){this.listeners.removeAll(),this.windowListeners.removeAll(),setTimeout(this.documentListeners.removeAll,50),null!==this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}handlePending(e,t){const{active:a,onPending:n}=this.props;n(a,e,this.initialCoordinates,t)}handleStart(){const{initialCoordinates:e}=this,{onStart:t}=this.props;e&&(this.activated=!0,this.documentListeners.add(Nt.Click,Ct,{capture:!0}),this.removeTextSelection(),this.documentListeners.add(Nt.SelectionChange,this.removeTextSelection),t(e))}handleMove(e){var t;const{activated:a,initialCoordinates:n,props:r}=this,{onMove:i,options:{activationConstraint:s}}=r;if(!n)return;const c=null!=(t=Me(e))?t:Ke,o=Ie(n,c);if(!a&&s){if($t(s)){if(null!=s.tolerance&&wt(o,s.tolerance))return this.handleCancel();if(wt(o,s.distance))return this.handleStart()}return Rt(s)&&wt(o,s.tolerance)?this.handleCancel():void this.handlePending(s,o)}e.cancelable&&e.preventDefault(),i(c)}handleEnd(){const{onAbort:e,onEnd:t}=this.props;this.detach(),this.activated||e(this.props.active),t()}handleCancel(){const{onAbort:e,onCancel:t}=this.props;this.detach(),this.activated||e(this.props.active),t()}handleKeydown(e){e.code===St.Esc&&this.handleCancel()}removeTextSelection(){var e;null==(e=this.document.getSelection())||e.removeAllRanges()}}const Tt={cancel:{name:"pointercancel"},move:{name:"pointermove"},end:{name:"pointerup"}};class Ot extends Et{constructor(e){const{event:t}=e,a=ve(t.target);super(e,Tt,a)}}Ot.activators=[{eventName:"onPointerDown",handler:(e,t)=>{let{nativeEvent:a}=e,{onActivation:n}=t;return!(!a.isPrimary||0!==a.button)&&(null==n||n({event:a}),!0)}}];const Pt={move:{name:"mousemove"},end:{name:"mouseup"}};var At,Ft;(Ft=At||(At={}))[Ft.RightClick=2]="RightClick";(class extends Et{constructor(e){super(e,Pt,ve(e.event.target))}}).activators=[{eventName:"onMouseDown",handler:(e,t)=>{let{nativeEvent:a}=e,{onActivation:n}=t;return a.button!==At.RightClick&&(null==n||n({event:a}),!0)}}];const Lt={cancel:{name:"touchcancel"},move:{name:"touchmove"},end:{name:"touchend"}};var Wt,zt,Bt,Ut;function Kt(e){let{acceleration:a,activator:n=Wt.Pointer,canScroll:r,draggingRect:i,enabled:s,interval:c=5,order:o=Bt.TreeOrder,pointerCoordinates:l,scrollableAncestors:d,scrollableAncestorRects:u,delta:m,threshold:p}=e;const h=function(e){let{delta:t,disabled:a}=e;const n=je(t);return we(e=>{if(a||!n||!e)return Ht;const r={x:Math.sign(t.x-n.x),y:Math.sign(t.y-n.y)};return{x:{[ut.Backward]:e.x[ut.Backward]||-1===r.x,[ut.Forward]:e.x[ut.Forward]||1===r.x},y:{[ut.Backward]:e.y[ut.Backward]||-1===r.y,[ut.Forward]:e.y[ut.Forward]||1===r.y}}},[a,t,n])}({delta:m,disabled:!s}),[_,g]=function(){const e=t.useRef(null);return[t.useCallback((t,a)=>{e.current=setInterval(t,a)},[]),t.useCallback(()=>{null!==e.current&&(clearInterval(e.current),e.current=null)},[])]}(),f=t.useRef({x:0,y:0}),v=t.useRef({x:0,y:0}),x=t.useMemo(()=>{switch(n){case Wt.Pointer:return l?{top:l.y,bottom:l.y,left:l.x,right:l.x}:null;case Wt.DraggableRect:return i}},[n,i,l]),b=t.useRef(null),y=t.useCallback(()=>{const e=b.current;if(!e)return;const t=f.current.x*v.current.x,a=f.current.y*v.current.y;e.scrollBy(t,a)},[]),w=t.useMemo(()=>o===Bt.TreeOrder?[...d].reverse():d,[o,d]);t.useEffect(()=>{if(s&&d.length&&x){for(const e of w){if(!1===(null==r?void 0:r(e)))continue;const t=d.indexOf(e),n=u[t];if(!n)continue;const{direction:i,speed:s}=gt(e,n,x,a,p);for(const e of["x","y"])h[e][i[e]]||(s[e]=0,i[e]=0);if(s.x>0||s.y>0)return g(),b.current=e,_(y,c),f.current=s,void(v.current=i)}f.current={x:0,y:0},v.current={x:0,y:0},g()}else g()},[a,y,r,g,s,c,JSON.stringify(x),JSON.stringify(h),_,d,w,u,JSON.stringify(p)])}(class extends Et{constructor(e){super(e,Lt)}static setup(){return window.addEventListener(Lt.move.name,e,{capture:!1,passive:!1}),function(){window.removeEventListener(Lt.move.name,e)};function e(){}}}).activators=[{eventName:"onTouchStart",handler:(e,t)=>{let{nativeEvent:a}=e,{onActivation:n}=t;const{touches:r}=a;return!(r.length>1)&&(null==n||n({event:a}),!0)}}],(zt=Wt||(Wt={}))[zt.Pointer=0]="Pointer",zt[zt.DraggableRect=1]="DraggableRect",(Ut=Bt||(Bt={}))[Ut.TreeOrder=0]="TreeOrder",Ut[Ut.ReversedTreeOrder=1]="ReversedTreeOrder";const Ht={x:{[ut.Backward]:!1,[ut.Forward]:!1},y:{[ut.Backward]:!1,[ut.Forward]:!1}};var Qt,Vt,Xt;(Vt=Qt||(Qt={}))[Vt.Always=0]="Always",Vt[Vt.BeforeDragging=1]="BeforeDragging",Vt[Vt.WhileDragging=2]="WhileDragging",(Xt||(Xt={})).Optimized="optimized";const Jt=new Map;function Yt(e,t){return we(a=>e?a||("function"==typeof t?t(e):e):null,[t,e])}function Gt(e){let{callback:a,disabled:n}=e;const r=be(a),i=t.useMemo(()=>{if(n||"undefined"==typeof window||void 0===window.ResizeObserver)return;const{ResizeObserver:e}=window;return new e(r)},[n]);return t.useEffect(()=>()=>null==i?void 0:i.disconnect(),[i]),i}function Zt(e){return new bt(nt(e),e)}function ea(e,a,n){void 0===a&&(a=Zt);const[r,i]=t.useState(null);function s(){i(t=>{if(!e)return null;var r;if(!1===e.isConnected)return null!=(r=null!=t?t:n)?r:null;const i=a(e);return JSON.stringify(t)===JSON.stringify(i)?t:i})}const c=function(e){let{callback:a,disabled:n}=e;const r=be(a),i=t.useMemo(()=>{if(n||"undefined"==typeof window||void 0===window.MutationObserver)return;const{MutationObserver:e}=window;return new e(r)},[r,n]);return t.useEffect(()=>()=>null==i?void 0:i.disconnect(),[i]),i}({callback(t){if(e)for(const a of t){const{type:t,target:n}=a;if("childList"===t&&n instanceof HTMLElement&&n.contains(e)){s();break}}}}),o=Gt({callback:s});return xe(()=>{s(),e?(null==o||o.observe(e),null==c||c.observe(document.body,{childList:!0,subtree:!0})):(null==o||o.disconnect(),null==c||c.disconnect())},[e]),r}const ta=[];function aa(e,a){void 0===a&&(a=[]);const n=t.useRef(null);return t.useEffect(()=>{n.current=null},a),t.useEffect(()=>{const t=e!==Ke;t&&!n.current&&(n.current=e),!t&&n.current&&(n.current=null)},[e]),n.current?Ie(e,n.current):Ke}function na(e){return t.useMemo(()=>e?function(e){const t=e.innerWidth,a=e.innerHeight;return{top:0,left:0,right:t,bottom:a,width:t,height:a}}(e):null,[e])}const ra=[];function ia(e){let{measure:a}=e;const[n,r]=t.useState(null),i=Gt({callback:t.useCallback(e=>{for(const{target:t}of e)if(ge(t)){r(e=>{const n=a(t);return e?{...e,width:n.width,height:n.height}:n});break}},[a])}),s=t.useCallback(e=>{const t=function(e){if(!e)return null;if(e.children.length>1)return e;const t=e.children[0];return ge(t)?t:e}(e);null==i||i.disconnect(),t&&(null==i||i.observe(t)),r(t?a(t):null)},[a,i]),[c,o]=Ne(s);return t.useMemo(()=>({nodeRef:c,rect:n,setRef:o}),[n,c,o])}const sa=[{sensor:Ot,options:{}},{sensor:Mt,options:{}}],ca={current:{}},oa={draggable:{measure:rt},droppable:{measure:rt,strategy:Qt.WhileDragging,frequency:Xt.Optimized},dragOverlay:{measure:nt}};class la extends Map{get(e){var t;return null!=e&&null!=(t=super.get(e))?t:void 0}toArray(){return Array.from(this.values())}getEnabled(){return this.toArray().filter(e=>{let{disabled:t}=e;return!t})}getNodeFor(e){var t,a;return null!=(t=null==(a=this.get(e))?void 0:a.node.current)?t:void 0}}const da={activatorEvent:null,active:null,activeNode:null,activeNodeRect:null,collisions:null,containerNodeRect:null,draggableNodes:new Map,droppableRects:new Map,droppableContainers:new la,over:null,dragOverlay:{nodeRef:{current:null},rect:null,setRef:Ue},scrollableAncestors:[],scrollableAncestorRects:[],measuringConfiguration:oa,measureDroppableContainers:Ue,windowRect:null,measuringScheduled:!1},ua={activatorEvent:null,activators:[],active:null,activeNodeRect:null,ariaDescribedById:{draggable:""},dispatch:Ue,draggableNodes:new Map,over:null,measureDroppableContainers:Ue},ma=t.createContext(ua),pa=t.createContext(da);function ha(){return{draggable:{active:null,initialCoordinates:{x:0,y:0},nodes:new Map,translate:{x:0,y:0}},droppable:{containers:new la}}}function _a(e,t){switch(t.type){case ze.DragStart:return{...e,draggable:{...e.draggable,initialCoordinates:t.initialCoordinates,active:t.active}};case ze.DragMove:return null==e.draggable.active?e:{...e,draggable:{...e.draggable,translate:{x:t.coordinates.x-e.draggable.initialCoordinates.x,y:t.coordinates.y-e.draggable.initialCoordinates.y}}};case ze.DragEnd:case ze.DragCancel:return{...e,draggable:{...e.draggable,active:null,initialCoordinates:{x:0,y:0},translate:{x:0,y:0}}};case ze.RegisterDroppable:{const{element:a}=t,{id:n}=a,r=new la(e.droppable.containers);return r.set(n,a),{...e,droppable:{...e.droppable,containers:r}}}case ze.SetDroppableDisabled:{const{id:a,key:n,disabled:r}=t,i=e.droppable.containers.get(a);if(!i||n!==i.key)return e;const s=new la(e.droppable.containers);return s.set(a,{...i,disabled:r}),{...e,droppable:{...e.droppable,containers:s}}}case ze.UnregisterDroppable:{const{id:a,key:n}=t,r=e.droppable.containers.get(a);if(!r||n!==r.key)return e;const i=new la(e.droppable.containers);return i.delete(a),{...e,droppable:{...e.droppable,containers:i}}}default:return e}}function ga(e){let{disabled:a}=e;const{active:n,activatorEvent:r,draggableNodes:i}=t.useContext(ma),s=je(r),c=je(null==n?void 0:n.id);return t.useEffect(()=>{if(!a&&!r&&s&&null!=c){if(!De(s))return;if(document.activeElement===s.target)return;const e=i.get(c);if(!e)return;const{activatorNode:t,node:a}=e;if(!t.current&&!a.current)return;requestAnimationFrame(()=>{for(const e of[t.current,a.current]){if(!e)continue;const t=Ee(e);if(t){t.focus();break}}})}},[r,a,i,c,s]),null}const fa=t.createContext({...Ke,scaleX:1,scaleY:1});var va,xa;(xa=va||(va={}))[xa.Uninitialized=0]="Uninitialized",xa[xa.Initializing=1]="Initializing",xa[xa.Initialized=2]="Initialized";const ba=t.memo(function(e){var r,i,s,c;let{id:o,accessibility:l,autoScroll:d=!0,children:u,sensors:m=sa,collisionDetection:p=Ge,measuring:h,modifiers:_,...g}=e;const f=t.useReducer(_a,void 0,ha),[v,x]=f,[b,y]=function(){const[e]=t.useState(()=>new Set),a=t.useCallback(t=>(e.add(t),()=>e.delete(t)),[e]);return[t.useCallback(t=>{let{type:a,event:n}=t;e.forEach(e=>{var t;return null==(t=e[a])?void 0:t.call(e,n)})},[e]),a]}(),[w,N]=t.useState(va.Uninitialized),j=w===va.Initialized,{draggable:{active:S,nodes:q,translate:k},droppable:{containers:C}}=v,I=null!=S?q.get(S):null,D=t.useRef({initial:null,translated:null}),M=t.useMemo(()=>{var e;return null!=S?{id:S,data:null!=(e=null==I?void 0:I.data)?e:ca,rect:D}:null},[S,I]),$=t.useRef(null),[R,E]=t.useState(null),[T,O]=t.useState(null),P=ye(g,Object.values(g)),A=qe("DndDescribedBy",o),F=t.useMemo(()=>C.getEnabled(),[C]),L=(W=h,t.useMemo(()=>({draggable:{...oa.draggable,...null==W?void 0:W.draggable},droppable:{...oa.droppable,...null==W?void 0:W.droppable},dragOverlay:{...oa.dragOverlay,...null==W?void 0:W.dragOverlay}}),[null==W?void 0:W.draggable,null==W?void 0:W.droppable,null==W?void 0:W.dragOverlay]));var W;const{droppableRects:z,measureDroppableContainers:B,measuringScheduled:U}=function(e,a){let{dragging:n,dependencies:r,config:i}=a;const[s,c]=t.useState(null),{frequency:o,measure:l,strategy:d}=i,u=t.useRef(e),m=function(){switch(d){case Qt.Always:return!1;case Qt.BeforeDragging:return n;default:return!n}}(),p=ye(m),h=t.useCallback(function(e){void 0===e&&(e=[]),p.current||c(t=>null===t?e:t.concat(e.filter(e=>!t.includes(e))))},[p]),_=t.useRef(null),g=we(t=>{if(m&&!n)return Jt;if(!t||t===Jt||u.current!==e||null!=s){const t=new Map;for(let a of e){if(!a)continue;if(s&&s.length>0&&!s.includes(a.id)&&a.rect.current){t.set(a.id,a.rect.current);continue}const e=a.node.current,n=e?new bt(l(e),e):null;a.rect.current=n,n&&t.set(a.id,n)}return t}return t},[e,s,n,m,l]);return t.useEffect(()=>{u.current=e},[e]),t.useEffect(()=>{m||h()},[n,m]),t.useEffect(()=>{s&&s.length>0&&c(null)},[JSON.stringify(s)]),t.useEffect(()=>{m||"number"!=typeof o||null!==_.current||(_.current=setTimeout(()=>{h(),_.current=null},o))},[o,m,h,...r]),{droppableRects:g,measureDroppableContainers:h,measuringScheduled:null!=s}}(F,{dragging:j,dependencies:[k.x,k.y],config:L.droppable}),K=function(e,t){const a=null!=t?e.get(t):void 0,n=a?a.node.current:null;return we(e=>{var a;return null==t?null:null!=(a=null!=n?n:e)?a:null},[n,t])}(q,S),H=t.useMemo(()=>T?Me(T):null,[T]),Q=function(){const e=!1===(null==R?void 0:R.autoScrollEnabled),t="object"==typeof d?!1===d.enabled:!1===d,a=j&&!e&&!t;if("object"==typeof d)return{...d,enabled:a};return{enabled:a}}(),V=function(e,t){return Yt(e,t)}(K,L.draggable.measure);!function(e){let{activeNode:a,measure:n,initialRect:r,config:i=!0}=e;const s=t.useRef(!1),{x:c,y:o}="boolean"==typeof i?{x:i,y:i}:i;xe(()=>{if(!c&&!o||!a)return void(s.current=!1);if(s.current||!r)return;const e=null==a?void 0:a.node.current;if(!e||!1===e.isConnected)return;const t=Ze(n(e),r);if(c||(t.x=0),o||(t.y=0),s.current=!0,Math.abs(t.x)>0||Math.abs(t.y)>0){const a=st(e);a&&a.scrollBy({top:t.y,left:t.x})}},[a,c,o,r,n])}({activeNode:null!=S?q.get(S):null,config:Q.layoutShiftCompensation,initialRect:V,measure:L.draggable.measure});const X=ea(K,L.draggable.measure,V),J=ea(K?K.parentElement:null),Y=t.useRef({activatorEvent:null,active:null,activeNode:K,collisionRect:null,collisions:null,droppableRects:z,draggableNodes:q,draggingNode:null,draggingNodeRect:null,droppableContainers:C,over:null,scrollableAncestors:[],scrollAdjustedTranslate:null}),G=C.getNodeFor(null==(r=Y.current.over)?void 0:r.id),Z=ia({measure:L.dragOverlay.measure}),ee=null!=(i=Z.nodeRef.current)?i:K,te=j?null!=(s=Z.rect)?s:X:null,ae=Boolean(Z.nodeRef.current&&Z.rect),ne=Ze(re=ae?null:X,Yt(re));var re;const ie=na(ee?he(ee):null),se=function(e){const a=t.useRef(e),n=we(t=>e?t&&t!==ta&&e&&a.current&&e.parentNode===a.current.parentNode?t:it(e):ta,[e]);return t.useEffect(()=>{a.current=e},[e]),n}(j?null!=G?G:K:null),ce=function(e,a){void 0===a&&(a=nt);const[n]=e,r=na(n?he(n):null),[i,s]=t.useState(ra);function c(){s(()=>e.length?e.map(e=>pt(e)?r:new bt(a(e),e)):ra)}const o=Gt({callback:c});return xe(()=>{null==o||o.disconnect(),c(),e.forEach(e=>null==o?void 0:o.observe(e))},[e]),i}(se),oe=function(e,t){let{transform:a,...n}=t;return null!=e&&e.length?e.reduce((e,t)=>t({transform:e,...n}),a):a}(_,{transform:{x:k.x-ne.x,y:k.y-ne.y,scaleX:1,scaleY:1},activatorEvent:T,active:M,activeNodeRect:X,containerNodeRect:J,draggingNodeRect:te,over:Y.current.over,overlayNodeRect:Z.rect,scrollableAncestors:se,scrollableAncestorRects:ce,windowRect:ie}),le=H?Ce(H,k):null,de=function(e){const[a,n]=t.useState(null),r=t.useRef(e),i=t.useCallback(e=>{const t=ct(e.target);t&&n(e=>e?(e.set(t,dt(t)),new Map(e)):null)},[]);return t.useEffect(()=>{const t=r.current;if(e!==t){a(t);const s=e.map(e=>{const t=ct(e);return t?(t.addEventListener("scroll",i,{passive:!0}),[t,dt(t)]):null}).filter(e=>null!=e);n(s.length?new Map(s):null),r.current=e}return()=>{a(e),a(t)};function a(e){e.forEach(e=>{const t=ct(e);null==t||t.removeEventListener("scroll",i)})}},[i,e]),t.useMemo(()=>e.length?a?Array.from(a.values()).reduce((e,t)=>Ce(e,t),Ke):vt(e):Ke,[e,a])}(se),me=aa(de),pe=aa(de,[X]),_e=Ce(oe,me),ge=te?tt(te,oe):null,fe=M&&ge?p({active:M,collisionRect:ge,droppableRects:z,droppableContainers:F,pointerCoordinates:le}):null,ve=function(e,t){if(!e||0===e.length)return null;const[a]=e;return a[t]}(fe,"id"),[be,Ne]=t.useState(null),je=function(e,t,a){return{...e,scaleX:t&&a?t.width/a.width:1,scaleY:t&&a?t.height/a.height:1}}(ae?oe:Ce(oe,pe),null!=(c=null==be?void 0:be.rect)?c:null,X),Se=t.useRef(null),ke=t.useCallback((e,t)=>{let{sensor:a,options:r}=t;if(null==$.current)return;const i=q.get($.current);if(!i)return;const s=e.nativeEvent,c=new a({active:$.current,activeNode:i,event:s,options:r,context:Y,onAbort(e){if(!q.get(e))return;const{onDragAbort:t}=P.current,a={id:e};null==t||t(a),b({type:"onDragAbort",event:a})},onPending(e,t,a,n){if(!q.get(e))return;const{onDragPending:r}=P.current,i={id:e,constraint:t,initialCoordinates:a,offset:n};null==r||r(i),b({type:"onDragPending",event:i})},onStart(e){const t=$.current;if(null==t)return;const a=q.get(t);if(!a)return;const{onDragStart:r}=P.current,i={activatorEvent:s,active:{id:t,data:a.data,rect:D}};n.unstable_batchedUpdates(()=>{null==r||r(i),N(va.Initializing),x({type:ze.DragStart,initialCoordinates:e,active:t}),b({type:"onDragStart",event:i}),E(Se.current),O(s)})},onMove(e){x({type:ze.DragMove,coordinates:e})},onEnd:o(ze.DragEnd),onCancel:o(ze.DragCancel)});function o(e){return async function(){const{active:t,collisions:a,over:r,scrollAdjustedTranslate:i}=Y.current;let c=null;if(t&&i){const{cancelDrop:n}=P.current;if(c={activatorEvent:s,active:t,collisions:a,delta:i,over:r},e===ze.DragEnd&&"function"==typeof n){await Promise.resolve(n(c))&&(e=ze.DragCancel)}}$.current=null,n.unstable_batchedUpdates(()=>{x({type:e}),N(va.Uninitialized),Ne(null),E(null),O(null),Se.current=null;const t=e===ze.DragEnd?"onDragEnd":"onDragCancel";if(c){const e=P.current[t];null==e||e(c),b({type:t,event:c})}})}}Se.current=c},[q]),Ie=function(e,a){return t.useMemo(()=>e.reduce((e,t)=>{const{sensor:n}=t;return[...e,...n.activators.map(e=>({eventName:e.eventName,handler:a(e.handler,t)}))]},[]),[e,a])}(m,t.useCallback((e,t)=>(a,n)=>{const r=a.nativeEvent,i=q.get(n);if(null!==$.current||!i||r.dndKit||r.defaultPrevented)return;const s={active:i};!0===e(a,t.options,s)&&(r.dndKit={capturedBy:t.sensor},$.current=n,ke(a,t))},[q,ke]));!function(e){t.useEffect(()=>{if(!ue)return;const t=e.map(e=>{let{sensor:t}=e;return null==t.setup?void 0:t.setup()});return()=>{for(const e of t)null==e||e()}},e.map(e=>{let{sensor:t}=e;return t}))}(m),xe(()=>{X&&w===va.Initializing&&N(va.Initialized)},[X,w]),t.useEffect(()=>{const{onDragMove:e}=P.current,{active:t,activatorEvent:a,collisions:r,over:i}=Y.current;if(!t||!a)return;const s={active:t,activatorEvent:a,collisions:r,delta:{x:_e.x,y:_e.y},over:i};n.unstable_batchedUpdates(()=>{null==e||e(s),b({type:"onDragMove",event:s})})},[_e.x,_e.y]),t.useEffect(()=>{const{active:e,activatorEvent:t,collisions:a,droppableContainers:r,scrollAdjustedTranslate:i}=Y.current;if(!e||null==$.current||!t||!i)return;const{onDragOver:s}=P.current,c=r.get(ve),o=c&&c.rect.current?{id:c.id,rect:c.rect.current,data:c.data,disabled:c.disabled}:null,l={active:e,activatorEvent:t,collisions:a,delta:{x:i.x,y:i.y},over:o};n.unstable_batchedUpdates(()=>{Ne(o),null==s||s(l),b({type:"onDragOver",event:l})})},[ve]),xe(()=>{Y.current={activatorEvent:T,active:M,activeNode:K,collisionRect:ge,collisions:fe,droppableRects:z,draggableNodes:q,draggingNode:ee,draggingNodeRect:te,droppableContainers:C,over:be,scrollableAncestors:se,scrollAdjustedTranslate:_e},D.current={initial:te,translated:ge}},[M,K,fe,ge,q,ee,te,z,C,be,se,_e]),Kt({...Q,delta:k,draggingRect:ge,pointerCoordinates:le,scrollableAncestors:se,scrollableAncestorRects:ce});const De=t.useMemo(()=>({active:M,activeNode:K,activeNodeRect:X,activatorEvent:T,collisions:fe,containerNodeRect:J,dragOverlay:Z,draggableNodes:q,droppableContainers:C,droppableRects:z,over:be,measureDroppableContainers:B,scrollableAncestors:se,scrollableAncestorRects:ce,measuringConfiguration:L,measuringScheduled:U,windowRect:ie}),[M,K,X,T,fe,J,Z,q,C,z,be,B,se,ce,L,U,ie]),$e=t.useMemo(()=>({activatorEvent:T,activators:Ie,active:M,activeNodeRect:X,ariaDescribedById:{draggable:A},dispatch:x,draggableNodes:q,over:be,measureDroppableContainers:B}),[T,Ie,M,X,x,A,q,be,B]);return a.createElement(Ae.Provider,{value:y},a.createElement(ma.Provider,{value:$e},a.createElement(pa.Provider,{value:De},a.createElement(fa.Provider,{value:je},u)),a.createElement(ga,{disabled:!1===(null==l?void 0:l.restoreFocus)})),a.createElement(We,{...l,hiddenTextDescribedById:A}))}),ya=t.createContext(null),wa="button";function Na(e){let{id:a,data:n,disabled:r=!1,attributes:i}=e;const s=qe("Draggable"),{activators:c,activatorEvent:o,active:l,activeNodeRect:d,ariaDescribedById:u,draggableNodes:m,over:p}=t.useContext(ma),{role:h=wa,roleDescription:_="draggable",tabIndex:g=0}=null!=i?i:{},f=(null==l?void 0:l.id)===a,v=t.useContext(f?fa:ya),[x,b]=Ne(),[y,w]=Ne(),N=function(e,a){return t.useMemo(()=>e.reduce((e,t)=>{let{eventName:n,handler:r}=t;return e[n]=e=>{r(e,a)},e},{}),[e,a])}(c,a),j=ye(n);xe(()=>(m.set(a,{id:a,key:s,node:x,activatorNode:y,data:j}),()=>{const e=m.get(a);e&&e.key===s&&m.delete(a)}),[m,a]);return{active:l,activatorEvent:o,activeNodeRect:d,attributes:t.useMemo(()=>({role:h,tabIndex:g,"aria-disabled":r,"aria-pressed":!(!f||h!==wa)||void 0,"aria-roledescription":_,"aria-describedby":u.draggable}),[r,h,g,f,_,u.draggable]),isDragging:f,listeners:r?void 0:N,node:x,over:p,setNodeRef:b,setActivatorNodeRef:w,transform:v}}const ja={timeout:25};function Sa(e,t,a){const n=e.slice();return n.splice(a<0?n.length+a:a,0,n.splice(t,1)[0]),n}function qa(e,t){return e.reduce((e,a,n)=>{const r=t.get(a);return r&&(e[n]=r),e},Array(e.length))}function ka(e){return null!==e&&e>=0}const Ca=e=>{let{rects:t,activeIndex:a,overIndex:n,index:r}=e;const i=Sa(t,n,a),s=t[r],c=i[r];return c&&s?{x:c.left-s.left,y:c.top-s.top,scaleX:c.width/s.width,scaleY:c.height/s.height}:null},Ia={scaleX:1,scaleY:1},Da=e=>{var t;let{activeIndex:a,activeNodeRect:n,index:r,rects:i,overIndex:s}=e;const c=null!=(t=i[a])?t:n;if(!c)return null;if(r===a){const e=i[s];return e?{x:0,y:a<s?e.top+e.height-(c.top+c.height):e.top-c.top,...Ia}:null}const o=function(e,t,a){const n=e[t],r=e[t-1],i=e[t+1];if(!n)return 0;if(a<t)return r?n.top-(r.top+r.height):i?i.top-(n.top+n.height):0;return i?i.top-(n.top+n.height):r?n.top-(r.top+r.height):0}(i,r,a);return r>a&&r<=s?{x:0,y:-c.height-o,...Ia}:r<a&&r>=s?{x:0,y:c.height+o,...Ia}:{x:0,y:0,...Ia}};const Ma="Sortable",$a=a.createContext({activeIndex:-1,containerId:Ma,disableTransforms:!1,items:[],overIndex:-1,useDragOverlay:!1,sortedRects:[],strategy:Ca,disabled:{draggable:!1,droppable:!1}});function Ra(e){let{children:n,id:r,items:i,strategy:s=Ca,disabled:c=!1}=e;const{active:o,dragOverlay:l,droppableRects:d,over:u,measureDroppableContainers:m}=t.useContext(pa),p=qe(Ma,r),h=Boolean(null!==l.rect),_=t.useMemo(()=>i.map(e=>"object"==typeof e&&"id"in e?e.id:e),[i]),g=null!=o,f=o?_.indexOf(o.id):-1,v=u?_.indexOf(u.id):-1,x=t.useRef(_),b=!function(e,t){if(e===t)return!0;if(e.length!==t.length)return!1;for(let a=0;a<e.length;a++)if(e[a]!==t[a])return!1;return!0}(_,x.current),y=-1!==v&&-1===f||b,w=function(e){return"boolean"==typeof e?{draggable:e,droppable:e}:e}(c);xe(()=>{b&&g&&m(_)},[b,_,g,m]),t.useEffect(()=>{x.current=_},[_]);const N=t.useMemo(()=>({activeIndex:f,containerId:p,disabled:w,disableTransforms:y,items:_,overIndex:v,useDragOverlay:h,sortedRects:qa(_,d),strategy:s}),[f,p,w.draggable,w.droppable,y,_,v,d,h,s]);return a.createElement($a.Provider,{value:N},n)}const Ea=e=>{let{id:t,items:a,activeIndex:n,overIndex:r}=e;return Sa(a,n,r).indexOf(t)},Ta=e=>{let{containerId:t,isSorting:a,wasDragging:n,index:r,items:i,newIndex:s,previousItems:c,previousContainerId:o,transition:l}=e;return!(!l||!n)&&((c===i||r!==s)&&(!!a||s!==r&&t===o))},Oa={duration:200,easing:"ease"},Pa="transform",Aa=$e.Transition.toString({property:Pa,duration:0,easing:"linear"}),Fa={roleDescription:"sortable"};function La(e){let{animateLayoutChanges:a=Ta,attributes:n,disabled:r,data:i,getNewIndex:s=Ea,id:c,strategy:o,resizeObserverConfig:l,transition:d=Oa}=e;const{items:u,containerId:m,activeIndex:p,disabled:h,disableTransforms:_,sortedRects:g,overIndex:f,useDragOverlay:v,strategy:x}=t.useContext($a),b=function(e,t){var a,n;if("boolean"==typeof e)return{draggable:e,droppable:!1};return{draggable:null!=(a=null==e?void 0:e.draggable)?a:t.draggable,droppable:null!=(n=null==e?void 0:e.droppable)?n:t.droppable}}(r,h),y=u.indexOf(c),w=t.useMemo(()=>({sortable:{containerId:m,index:y,items:u},...i}),[m,i,y,u]),N=t.useMemo(()=>u.slice(u.indexOf(c)),[u,c]),{rect:j,node:S,isOver:q,setNodeRef:k}=function(e){let{data:a,disabled:n=!1,id:r,resizeObserverConfig:i}=e;const s=qe("Droppable"),{active:c,dispatch:o,over:l,measureDroppableContainers:d}=t.useContext(ma),u=t.useRef({disabled:n}),m=t.useRef(!1),p=t.useRef(null),h=t.useRef(null),{disabled:_,updateMeasurementsFor:g,timeout:f}={...ja,...i},v=ye(null!=g?g:r),x=Gt({callback:t.useCallback(()=>{m.current?(null!=h.current&&clearTimeout(h.current),h.current=setTimeout(()=>{d(Array.isArray(v.current)?v.current:[v.current]),h.current=null},f)):m.current=!0},[f]),disabled:_||!c}),b=t.useCallback((e,t)=>{x&&(t&&(x.unobserve(t),m.current=!1),e&&x.observe(e))},[x]),[y,w]=Ne(b),N=ye(a);return t.useEffect(()=>{x&&y.current&&(x.disconnect(),m.current=!1,x.observe(y.current))},[y,x]),t.useEffect(()=>(o({type:ze.RegisterDroppable,element:{id:r,key:s,disabled:n,node:y,rect:p,data:N}}),()=>o({type:ze.UnregisterDroppable,key:s,id:r})),[r]),t.useEffect(()=>{n!==u.current.disabled&&(o({type:ze.SetDroppableDisabled,id:r,key:s,disabled:n}),u.current.disabled=n)},[r,s,n,o]),{active:c,rect:p,isOver:(null==l?void 0:l.id)===r,node:y,over:l,setNodeRef:w}}({id:c,data:w,disabled:b.droppable,resizeObserverConfig:{updateMeasurementsFor:N,...l}}),{active:C,activatorEvent:I,activeNodeRect:D,attributes:M,setNodeRef:$,listeners:R,isDragging:E,over:T,setActivatorNodeRef:O,transform:P}=Na({id:c,data:w,attributes:{...Fa,...n},disabled:b.draggable}),A=function(){for(var e=arguments.length,a=new Array(e),n=0;n<e;n++)a[n]=arguments[n];return t.useMemo(()=>e=>{a.forEach(t=>t(e))},a)}(k,$),F=Boolean(C),L=F&&!_&&ka(p)&&ka(f),W=!v&&E,z=W&&L?P:null,B=L?null!=z?z:(null!=o?o:x)({rects:g,activeNodeRect:D,activeIndex:p,overIndex:f,index:y}):null,U=ka(p)&&ka(f)?s({id:c,items:u,activeIndex:p,overIndex:f}):y,K=null==C?void 0:C.id,H=t.useRef({activeId:K,items:u,newIndex:U,containerId:m}),Q=u!==H.current.items,V=a({active:C,containerId:m,isDragging:E,isSorting:F,id:c,index:y,items:u,newIndex:H.current.newIndex,previousItems:H.current.items,previousContainerId:H.current.containerId,transition:d,wasDragging:null!=H.current.activeId}),X=function(e){let{disabled:a,index:n,node:r,rect:i}=e;const[s,c]=t.useState(null),o=t.useRef(n);return xe(()=>{if(!a&&n!==o.current&&r.current){const e=i.current;if(e){const t=nt(r.current,{ignoreTransform:!0}),a={x:e.left-t.left,y:e.top-t.top,scaleX:e.width/t.width,scaleY:e.height/t.height};(a.x||a.y)&&c(a)}}n!==o.current&&(o.current=n)},[a,n,r,i]),t.useEffect(()=>{s&&c(null)},[s]),s}({disabled:!V,index:y,node:S,rect:j});return t.useEffect(()=>{F&&H.current.newIndex!==U&&(H.current.newIndex=U),m!==H.current.containerId&&(H.current.containerId=m),u!==H.current.items&&(H.current.items=u)},[F,U,m,u]),t.useEffect(()=>{if(K===H.current.activeId)return;if(null!=K&&null==H.current.activeId)return void(H.current.activeId=K);const e=setTimeout(()=>{H.current.activeId=K},50);return()=>clearTimeout(e)},[K]),{active:C,activeIndex:p,attributes:M,data:w,rect:j,index:y,newIndex:U,items:u,isOver:q,isSorting:F,isDragging:E,listeners:R,node:S,overIndex:f,over:T,setNodeRef:A,setActivatorNodeRef:O,setDroppableNodeRef:k,setDraggableNodeRef:$,transform:null!=X?X:B,transition:function(){if(X||Q&&H.current.newIndex===y)return Aa;if(W&&!De(I)||!d)return;if(F||V)return $e.Transition.toString({...d,property:Pa});return}()}}function Wa({children:e,onConfirm:a,disabled:n=!1,placeholder:s="날짜와 금액을 입력하세요",align:c="center",side:o="bottom",defaultDate:l,defaultAmount:d}){const[u,m]=t.useState(!1),[p,h]=t.useState(l),[_,g]=t.useState(d?.toString()||"");return r.jsxs(W,{open:u,onOpenChange:m,children:[r.jsx(z,{asChild:!0,disabled:n,children:e}),r.jsx(B,{className:"w-auto p-0 border-gray-200 shadow-lg",align:c,side:o,sideOffset:8,children:r.jsxs("div",{className:"bg-white business-radius-card p-3",children:[r.jsx("div",{className:"mb-2 px-1",children:r.jsx("div",{className:"modal-label text-gray-600 text-center",children:s})}),r.jsx(D,{mode:"single",selected:p,onSelect:h,locale:M,initialFocus:!0,className:"compact-calendar",disabled:!1,fromDate:new Date("2020-01-01"),toDate:new Date("2030-12-31"),defaultMonth:p||new Date,modifiers:{today:new Date},modifiersClassNames:{today:"bg-blue-500 text-white font-semibold cursor-pointer hover:bg-blue-600 rounded-md"}}),r.jsxs("div",{className:"mt-3 px-1",children:[r.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"지출금액"}),r.jsx(T,{type:"text",value:_,onChange:e=>{const t=e.target.value.replace(/[^0-9]/g,"");if(t){const e=parseInt(t,10);g(e.toLocaleString())}else g("")},placeholder:"금액을 입력하세요",className:"w-full"})]}),r.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[r.jsx(i,{variant:"outline",size:"sm",onClick:()=>m(!1),children:"취소"}),r.jsx(i,{size:"sm",onClick:()=>{if(!p)return;const e=parseFloat(_.replace(/,/g,""));isNaN(e)||e<=0||(a(p,e),m(!1),h(l),g(d?.toString()||""))},disabled:!p||!_||parseFloat(_.replace(/,/g,""))<=0,className:"button-base button-action-primary",children:"확인"})]})]})})]})}function za({children:e,onConfirm:a,disabled:n=!1,placeholder:s="날짜와 실제입고수량을 입력하세요",align:c="center",side:o="bottom",defaultDate:l,defaultQuantity:d,maxQuantity:u,allowOverMaxQuantity:m=!1,hideQuantityInput:p=!1,quantityInfoText:h="요청입고수량과 동일한 수량으로 입력됩니다"}){const[_,g]=t.useState(!1),[f,v]=t.useState(l),[x,b]=t.useState(d?.toString()||"");return r.jsxs(W,{open:_,onOpenChange:g,children:[r.jsx(z,{asChild:!0,disabled:n,children:e}),r.jsx(B,{className:"w-auto p-0 border-gray-200 shadow-lg",align:c,side:o,sideOffset:8,children:r.jsxs("div",{className:"bg-white business-radius-card p-3",children:[r.jsx("div",{className:"mb-2 px-1",children:r.jsx("div",{className:"modal-label text-gray-600 text-center",children:s})}),p&&r.jsx("div",{className:"mb-2 px-1",children:r.jsxs("div",{className:"text-[10px] text-gray-500 text-center leading-tight",children:[r.jsx("div",{children:"요청입고수량과 동일한"}),r.jsx("div",{children:"수량으로 입력됩니다"})]})}),r.jsx(D,{mode:"single",selected:f,onSelect:v,locale:M,initialFocus:!0,className:"compact-calendar",disabled:!1,fromDate:new Date("2020-01-01"),toDate:new Date("2030-12-31"),defaultMonth:f||new Date,modifiers:{today:new Date},modifiersClassNames:{today:"bg-blue-500 text-white font-semibold cursor-pointer hover:bg-blue-600 rounded-md"}}),!p&&r.jsxs("div",{className:"mt-3 px-1",children:[r.jsxs("div",{className:"flex items-center justify-between mb-1 gap-2",children:[r.jsx("label",{className:"block text-xs font-medium text-gray-700",children:h?.includes("미입고")?"추가입고수량":"실제입고수량"}),void 0!==u&&r.jsx(i,{type:"button",variant:"outline",size:"sm",onClick:()=>{void 0!==u&&b(u.toString())},className:"h-6 px-2 text-[10px] border-gray-200 text-hansl-600",children:h?.includes("미입고")?"미입고 수량 전체":"요청수량과 동일"})]}),r.jsx(T,{type:"number",value:x,onChange:e=>{const t=e.target.value.replace(/[^0-9]/g,"");b(t)},placeholder:"수량을 입력하세요",className:"border-gray-200 rounded-lg text-center w-full !h-5 !px-1.5 !py-0.5 !text-[9px] font-normal text-gray-600 focus:border-blue-400",min:"0",max:m?void 0:u}),void 0!==u&&r.jsx("p",{className:"text-xs text-gray-500 mt-1",children:h?.includes("미입고")?h:`${m?"요청수량":"최대"}: ${u.toLocaleString()}`})]}),r.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[r.jsx(i,{variant:"outline",size:"sm",onClick:()=>g(!1),className:"button-base",children:"취소"}),r.jsx(i,{size:"sm",onClick:()=>{if(!f)return;if(p)return a(f,void 0),g(!1),v(l),void b(d?.toString()||"");const e=parseFloat(x.replace(/,/g,""));isNaN(e)||e<0||void 0!==u&&!m&&e>u||(a(f,e),g(!1),v(l),b(d?.toString()||""))},disabled:!f||!p&&(!x||parseFloat(x.replace(/,/g,""))<0||!m&&void 0!==u&&parseFloat(x.replace(/,/g,""))>u),className:"button-base button-action-primary",children:"확인"})]})]})})]})}function Ba({config:e,currentUserName:a,canPerformAction:n,purchaseId:r,onUpdate:i,onBeforeUpdate:m,onOptimisticUpdate:p}){const h=s(),_=t.useCallback(async(t,s,d,u)=>{if(!n)return c.warn("❌ 권한 없음",{canPerformAction:n,currentUserName:a}),void Y.error(("statement_received"===e.field?"거래명세서":"입고")+" 확인 권한이 없습니다.");const _="number"==typeof t?t:Number(t);if(Number.isNaN(_))return c.error("❌ 잘못된 ID",{itemId:t,numericId:_}),void Y.error("유효하지 않은 항목 ID 입니다.");if(d){const t=`품목명: ${d.item_name||"-"}\n규격: ${d.specification||"-"}\n수량: ${d.quantity?.toLocaleString()||0}\n단가: ₩${d.unit_price_value?.toLocaleString()||0}\n합계: ₩${d.amount_value?.toLocaleString()||0}\n비고: ${d.remark||"-"}\n\n${e.confirmMessage.confirm}`;if(!window.confirm(t))return}m?.();try{let t;if("statement_received"===e.field)t={is_statement_received:!0,statement_received_date:C(s),statement_received_by_name:a,accounting_received_date:C(s)};else if("actual_received"===e.field){const e=d?.quantity||0,n=d?.received_quantity||0,r=void 0!==u?u:e,i=n+r,{data:o}=await h.from("purchase_request_items").select("receipt_history").eq("id",_).single(),l=o?.receipt_history||[],m={seq:l.length+1,qty:r,date:C(s),by:a||"알수없음"},p=[...l,m],g=i>=e;t={actual_received_date:C(s),is_received:g,received_quantity:i,delivery_status:0===i?"pending":g?"received":"partial",receipt_history:p},c.debug("📦 분할 입고 처리:",{requestedQuantity:e,currentReceivedQuantity:n,newReceivedQuantity:r,totalReceivedQuantity:i,isFullyReceived:g,historyCount:p.length})}c.debug("📝 업데이트할 데이터:",t);const{data:n,error:m}=await h.from("purchase_request_items").update(t).eq("id",_).select();if(c.debug("📝 DB 업데이트 결과:",{data:n,error:m}),m)throw c.error("❌ DB 업데이트 실패",m),m;if(c.info("✅ DB 업데이트 성공",n),r)if("actual_received"===e.field){o(r,_,C(s),u)||c.warn("[useConfirmDateAction] 메모리 캐시 입고완료 업데이트 실패",{purchaseId:r,itemId:_})}else if("statement_received"===e.field){l(r,_,C(s),a||void 0)||c.warn("[useConfirmDateAction] 메모리 캐시 거래명세서 확인 업데이트 실패",{purchaseId:r,itemId:_})}p&&p({itemId:_,selectedDate:s,action:"confirm",receivedQuantity:void 0!==u?u:d?.received_quantity,itemInfo:d}),i&&i(),Y.success(e.successMessage.confirm)}catch(g){c.error("❌ 전체 처리 실패",g),Y.error(("statement_received"===e.field?"거래명세서":"입고")+" 확인 처리 중 오류가 발생했습니다.")}},[e,a,n,r,i,m,p,h]),g=t.useCallback(async(t,s)=>{if(!n)return c.warn("❌ 취소 권한 없음",{canPerformAction:n,currentUserName:a}),void Y.error(("statement_received"===e.field?"거래명세서":"입고")+" 확인 권한이 없습니다.");const o="number"==typeof t?t:Number(t);if(Number.isNaN(o))Y.error("유효하지 않은 항목 ID 입니다.");else{if(s){const t=`품목명: ${s.item_name||"-"}\n규격: ${s.specification||"-"}\n수량: ${s.quantity?.toLocaleString()||0}\n단가: ₩${s.unit_price_value?.toLocaleString()||0}\n합계: ₩${s.amount_value?.toLocaleString()||0}\n비고: ${s.remark||"-"}\n\n${e.confirmMessage.cancel}`;if(!window.confirm(t))return}m?.();try{let a;c.debug(`🔄 ${e.field} 확인 취소 시작`,{itemId:t,itemName:s?.item_name}),"statement_received"===e.field?a={is_statement_received:!1,statement_received_date:null,statement_received_by_name:null,accounting_received_date:null}:"actual_received"===e.field&&(a={actual_received_date:null,is_received:!1,received_quantity:0,delivery_status:"pending",receipt_history:[]}),c.debug("🔄 취소 업데이트할 데이터:",a);const{data:n,error:l}=await h.from("purchase_request_items").update(a).eq("id",o).select();if(c.debug("🔄 취소 DB 업데이트 결과:",{data:n,error:l}),l)throw c.error("❌ DB 업데이트 실패",l),l;if(c.info(`✅ ${e.field} 확인 취소 성공`,n),r)if("actual_received"===e.field){d(r,o)||c.warn("[useConfirmDateAction] 메모리 캐시 입고취소 업데이트 실패",{purchaseId:r,itemId:o})}else if("statement_received"===e.field){u(r,o)||c.warn("[useConfirmDateAction] 메모리 캐시 거래명세서 취소 업데이트 실패",{purchaseId:r,itemId:o})}p&&p({itemId:o,action:"cancel",itemInfo:s}),i&&i(),Y.success(e.successMessage.cancel)}catch(l){c.error(`❌ ${e.field} 확인 취소 실패`,l),Y.error(("statement_received"===e.field?"거래명세서":"입고")+" 확인 취소 중 오류가 발생했습니다.")}}},[e,n,r,i,m,p,h]),f=t.useCallback(t=>"statement_received"===e.field?t.is_statement_received:"actual_received"===e.field&&t.is_received,[e.field]),v=t.useCallback(t=>{if("actual_received"===e.field){const e=t.received_quantity||0,a=t.quantity||0;return e>0&&e<a}return!1},[e.field]),x=t.useCallback(e=>{const t=e.received_quantity||0,a=e.quantity||0;return Math.max(0,a-t)},[]),b=t.useCallback(t=>"statement_received"===e.field?t.statement_received_date:"actual_received"===e.field?t.actual_received_date:null,[e.field]),y=t.useCallback(t=>"statement_received"===e.field?t.statement_received_by_name:(e.field,null),[e.field]);return{config:e,handleConfirm:_,handleCancel:g,isCompleted:f,isPartiallyReceived:v,getRemainingQuantity:x,getCompletedDate:b,getCompletedByName:y}}St.Down,St.Right,St.Up,St.Left;const Ua=[{id:"statement_progress",label:"거래명세서",description:"거래명세서 수령 진행률",defaultVisible:!0},{id:"purchase_order_number",label:"발주번호",description:"발주요청 번호",defaultVisible:!0},{id:"payment_category",label:"결제종류",description:"결제 방식 (구매요청, 발주, 현장결제 등)",defaultVisible:!0},{id:"requester_name",label:"요청자",description:"발주를 요청한 사용자",defaultVisible:!0},{id:"request_date",label:"청구일",description:"발주 요청 날짜",defaultVisible:!0},{id:"utk_status",label:"UTK",description:"UTK 확인 상태",defaultVisible:!0},{id:"vendor_name",label:"업체",description:"공급업체명",defaultVisible:!0},{id:"contact_name",label:"담당자",description:"업체 담당자명",defaultVisible:!0},{id:"delivery_request_date",label:"입고요청일",description:"입고 요청 날짜",defaultVisible:!0},{id:"revised_delivery_date",label:"변경입고일",description:"수정된 입고 날짜",defaultVisible:!0},{id:"item_name",label:"품명",description:"구매 품목명",defaultVisible:!0},{id:"specification",label:"규격",description:"품목 규격 정보",defaultVisible:!0},{id:"quantity",label:"수량",description:"구매 수량",defaultVisible:!0},{id:"unit_price",label:"단가",description:"품목 단가",defaultVisible:!0},{id:"amount",label:"합계",description:"총 금액",defaultVisible:!0},{id:"remark",label:"비고",description:"추가 메모 사항",defaultVisible:!0},{id:"link",label:"링크",description:"관련 링크",defaultVisible:!0},{id:"project_vendor",label:"PJ업체",description:"프로젝트 업체",defaultVisible:!0},{id:"project_item",label:"PJ ITEM",description:"프로젝트 아이템",defaultVisible:!0},{id:"sales_order_number",label:"수주번호",description:"수주 번호",defaultVisible:!0},{id:"purchase_progress",label:"구매진행",description:"구매 진행률",defaultVisible:!0},{id:"receipt_progress",label:"입고진행",description:"입고 진행률",defaultVisible:!0}],Ka=Ua.reduce((e,t)=>(e[t.id]=t.defaultVisible,e),{});Ua.reduce((e,t)=>(e[t.id]=t,e),{});const Ha=["purchase_order_number","vendor_name","item_name","specification"],Qa=["statement_progress","utk_status","unit_price","amount"],Va=["app_admin","ceo","final_approver","purchase_manager","lead buyer","accounting"],Xa=["app_admin","lead buyer","accounting"],Ja=[{title:"기본 정보",columns:["statement_progress","purchase_order_number","payment_category","requester_name","request_date","utk_status"]},{title:"업체 정보",columns:["vendor_name","contact_name","delivery_request_date","revised_delivery_date"]},{title:"품목 정보",columns:["item_name","specification","quantity","unit_price","amount","remark","link"]},{title:"프로젝트 정보",columns:["project_vendor","project_item","sales_order_number"]},{title:"진행 상태",columns:["purchase_progress","receipt_progress"]}];function Ya(e){if(!e)return e;const t=e.toUpperCase().replace(/\s+/g,""),a=t.match(/^(F\d{8})[_-](\d{1,3})$/);if(a){const[,e,t]=a;return`${e}_${t.padStart(3,"0")}`}if(t.startsWith("F")&&t.includes("-")&&!t.includes("_")){const e=t.match(/^(F\d{6,8})-(\d{1,3})$/);if(e){const[,t,a]=e;return`${t}_${a.padStart(3,"0")}`}return t.replace("-","_")}const n=t.match(/^(HS\d{6})-(\d{1,2})$/);if(n){const[,e,t]=n;return`${e}-${t.padStart(2,"0")}`}return t}const Ga=new class{constructor(){this.kickQueueInFlight=!1,this.lastKickQueueAt=0,this.supabase=s()}async prepareOcrImage(e){if(!e.type.startsWith("image/"))return e;try{const t=await createImageBitmap(e),a=Math.max(t.width,t.height),n=a>2200?2200/a:1,r=Math.round(t.width*n),i=Math.round(t.height*n),s=document.createElement("canvas");s.width=r,s.height=i;const c=s.getContext("2d");if(!c)return e;c.drawImage(t,0,0,r,i);const o=await new Promise(e=>s.toBlob(e,"image/jpeg",.85));return o?new File([o],e.name.replace(/\.\w+$/,".jpg"),{type:"image/jpeg"}):e}catch(t){return e}}async uploadStatement(e,t,a,n){try{const r=await this.prepareOcrImage(e),i=r.name.split(".").pop()?.toLowerCase()||"png",s=crypto.randomUUID(),c=`Transaction Statement/${`${s}.${i}`}`,{data:o,error:l}=await this.supabase.storage.from("receipt-images").upload(c,r,{contentType:r.type,upsert:!1});if(l)throw l;const{data:d}=this.supabase.storage.from("receipt-images").getPublicUrl(c),u=d.publicUrl,{data:{user:m}}=await this.supabase.auth.getUser(),p=a?C(a):null,{data:h,error:_}=await this.supabase.from("transaction_statements").insert({image_url:u,file_name:e.name,uploaded_by:m?.id,uploaded_by_name:t,status:"queued",queued_at:(new Date).toISOString(),po_scope:n,extracted_data:p?{actual_received_date:p}:null}).select().single();if(_)throw new Error(`DB 저장 실패: ${_.message} (code: ${_.code})`);return fetch("http://127.0.0.1:7244/ingest/d1bfd845-9c34-4c24-9ef7-fd981ce7dd8e",{method:"POST",headers:{"Content-Type":"application/json","X-Debug-Session-Id":"9f46d9"},body:JSON.stringify({sessionId:"9f46d9",runId:"web-repro",hypothesisId:"H5",location:"transactionStatementService.ts:uploadStatement:inserted",message:"web statement inserted",data:{statementId:h.id,status:h.status??null,imageUrlLength:u.length},timestamp:Date.now()})}).catch(()=>{}),{success:!0,data:{statementId:h.id,imageUrl:u}}}catch(r){return{success:!1,error:r instanceof Error?r.message:"업로드 중 오류가 발생했습니다."}}}async uploadReceiptQuantity(e,t,a,n){try{const r=await this.prepareOcrImage(e),i=r.name.split(".").pop()?.toLowerCase()||"png",s=crypto.randomUUID(),c=`Transaction Statement/${`${s}.${i}`}`,{data:o,error:l}=await this.supabase.storage.from("receipt-images").upload(c,r,{contentType:r.type,upsert:!1});if(l)throw l;const{data:d}=this.supabase.storage.from("receipt-images").getPublicUrl(c),u=d.publicUrl,{data:{user:m}}=await this.supabase.auth.getUser(),p=a?C(a):null,{data:h,error:_}=await this.supabase.from("transaction_statements").insert({image_url:u,file_name:e.name,uploaded_by:m?.id,uploaded_by_name:t,status:"queued",queued_at:(new Date).toISOString(),statement_mode:"receipt",po_scope:n,extracted_data:p?{actual_received_date:p}:null}).select().single();if(_)throw new Error(`DB 저장 실패: ${_.message} (code: ${_.code})`);return this.triggerReceiptQuantityExtraction(h.id,u),{success:!0,data:{statementId:h.id,imageUrl:u}}}catch(r){return{success:!1,error:r instanceof Error?r.message:"업로드 중 오류가 발생했습니다."}}}async uploadMonthlyStatement(e,t,a,n,r){try{const i="image"===r?await this.prepareOcrImage(e):e,s=i.name.split(".").pop()?.toLowerCase()||"bin",c=crypto.randomUUID(),o=`Transaction Statement/${`${c}.${s}`}`,{data:l,error:d}=await this.supabase.storage.from("receipt-images").upload(o,i,{contentType:i.type||"application/octet-stream",upsert:!1});if(d)throw d;const{data:u}=this.supabase.storage.from("receipt-images").getPublicUrl(o),m=u.publicUrl,{data:{user:p}}=await this.supabase.auth.getUser(),h=a?C(a):null,{data:_,error:g}=await this.supabase.from("transaction_statements").insert({image_url:m,file_name:e.name,uploaded_by:p?.id,uploaded_by_name:t,status:"processing",processing_started_at:(new Date).toISOString(),statement_mode:"monthly",po_scope:n||null,extracted_data:{...h?{actual_received_date:h}:{},file_type:r||"excel"}}).select().single();if(g)throw new Error(`DB 저장 실패: ${g.message} (code: ${g.code})`);return this.triggerMonthlyStatementParsing(_.id,m,r||"excel"),{success:!0,data:{statementId:_.id,fileUrl:m}}}catch(i){return{success:!1,error:i instanceof Error?i.message:"업로드 중 오류가 발생했습니다."}}}async triggerMonthlyStatementParsing(e,t,a){try{await this.supabase.functions.invoke("parse-monthly-statement",{body:{statementId:e,fileUrl:t,fileType:a}})}catch(n){}}async triggerReceiptQuantityExtraction(e,t){try{await this.supabase.functions.invoke("ocr-receipt-quantity",{body:{statementId:e,imageUrl:t,mode:"process_specific"}})}catch(a){}}async extractStatementData(e,t,a=!1){let n=null,r=null;try{const{data:s}=await this.supabase.auth.getSession(),c=s?.session;fetch("http://127.0.0.1:7244/ingest/d1bfd845-9c34-4c24-9ef7-fd981ce7dd8e",{method:"POST",headers:{"Content-Type":"application/json","X-Debug-Session-Id":"9f46d9"},body:JSON.stringify({sessionId:"9f46d9",runId:"web-repro",hypothesisId:"H1",location:"transactionStatementService.ts:extractStatementData:beforeInvoke",message:"before invoke edge function",data:{statementId:e,hasSession:Boolean(c?.access_token),resetBeforeExtract:a,imageUrlLength:t.length},timestamp:Date.now()})}).catch(()=>{});let o=null,l=null,d=null,u=null,m=null;try{const{data:t}=await this.supabase.from("transaction_statements").select("status, locked_by, next_retry_at, processing_started_at").eq("id",e).maybeSingle();o=t?.status??null,l=Boolean(t?.locked_by),d=t?.next_retry_at??null,u=t?.processing_started_at??null;const a=new Date(Date.now()-9e5).toISOString(),{count:n}=await this.supabase.from("transaction_statements").select("id",{count:"exact",head:!0}).eq("status","processing").not("processing_started_at","is",null).gt("processing_started_at",a);m="number"==typeof n?n:null}catch(i){}if(a&&"extracted"===o){const t=(new Date).toISOString(),{data:a,error:n}=await this.supabase.from("transaction_statements").update({status:"queued",queued_at:t,next_retry_at:t,reset_before_extract:!0,processing_started_at:null,processing_finished_at:null,locked_by:null}).eq("id",e).eq("status","extracted").select("id, status"),r=Array.isArray(a)?a.length:0;r>0&&(o="queued",l=!1,d=t,u=null),fetch("http://127.0.0.1:7244/ingest/d1bfd845-9c34-4c24-9ef7-fd981ce7dd8e",{method:"POST",headers:{"Content-Type":"application/json","X-Debug-Session-Id":"9f46d9"},body:JSON.stringify({sessionId:"9f46d9",runId:"ocr-regression-debug",hypothesisId:"H5",location:"transactionStatementService.ts:extractStatementData:preQueueExtracted",message:"pre-queue extracted statement before invoke",data:{statementId:e,preQueueUpdatedRows:r,preQueueError:n?.message??null},timestamp:Date.now()})}).catch(()=>{})}const p=Boolean(o&&["pending","queued","failed"].includes(o))&&(0===m||null===m);fetch("http://127.0.0.1:7244/ingest/d1bfd845-9c34-4c24-9ef7-fd981ce7dd8e",{method:"POST",headers:{"Content-Type":"application/json","X-Debug-Session-Id":"9f46d9"},body:JSON.stringify({sessionId:"9f46d9",runId:"web-repro",hypothesisId:"H1",location:"transactionStatementService.ts:extractStatementData:preInvokeSnapshot",message:"pre-invoke db snapshot",data:{statementId:e,preRowStatus:o,preRowLocked:l,preRowNextRetryAt:d,preRowProcessingStartedAt:u,preProcessingCount:m,preClaimable:p},timestamp:Date.now()})}).catch(()=>{});const{data:h,error:_}=await this.supabase.functions.invoke("ocr-transaction-statement",{body:{statementId:e,imageUrl:t,reset_before_extract:a,mode:"process_specific"}});if(_){const e=_?.context;n=e?.status??null;try{if(e?.clone){const t=await e.clone().text();r=t?t.slice(0,800):null}else if(e?.text){const t=await e.text();r=t?t.slice(0,800):null}}catch(i){r=null}}if(fetch("http://127.0.0.1:7244/ingest/d1bfd845-9c34-4c24-9ef7-fd981ce7dd8e",{method:"POST",headers:{"Content-Type":"application/json","X-Debug-Session-Id":"9f46d9"},body:JSON.stringify({sessionId:"9f46d9",runId:"web-repro",hypothesisId:_?"H2":"H1",location:"transactionStatementService.ts:extractStatementData:afterInvoke",message:"after invoke edge function",data:{statementId:e,hasError:Boolean(_),errorName:_?.name??null,errorType:_?.constructor?.name??null,hasContext:Boolean(_?.context),invokeContextStatus:n,invokeContextBodyHead:r?r.slice(0,200):null,queued:Boolean(h?.queued),success:Boolean(h?.success),queuedReason:h?.reason??null,queuedDebug:h?.debug??null},timestamp:Date.now()})}).catch(()=>{}),!_){const t=Array.isArray(h?.result?.items)?h.result.items:[];fetch("http://127.0.0.1:7244/ingest/d1bfd845-9c34-4c24-9ef7-fd981ce7dd8e",{method:"POST",headers:{"Content-Type":"application/json","X-Debug-Session-Id":"9f46d9"},body:JSON.stringify({sessionId:"9f46d9",runId:"ocr-regression-debug",hypothesisId:"H1",location:"transactionStatementService.ts:extractStatementData:invokeResultShape",message:"edge response result shape",data:{statementId:e,responseHasResult:Boolean(h?.result),responseItemCount:t.length,responseVendorName:h?.result?.vendor_name??h?.vendor_name??null,sample:t.slice(0,5).map(e=>({line:e?.line_number??null,itemName:e?.item_name??null,specification:e?.specification??null,quantity:e?.quantity??null,unitPrice:e?.unit_price??null,amount:e?.amount??null,po:e?.po_number??null}))},timestamp:Date.now()})}).catch(()=>{})}if(_)throw _;if(h?.queued){try{const{data:t,error:a}=await this.supabase.from("transaction_statements").select("status, locked_by, next_retry_at, processing_started_at").eq("id",e).maybeSingle(),{count:n,error:r}=await this.supabase.from("transaction_statements").select("id",{count:"exact",head:!0}).eq("status","processing").not("processing_started_at","is",null);fetch("http://127.0.0.1:7244/ingest/d1bfd845-9c34-4c24-9ef7-fd981ce7dd8e",{method:"POST",headers:{"Content-Type":"application/json","X-Debug-Session-Id":"9f46d9"},body:JSON.stringify({sessionId:"9f46d9",runId:"web-repro",hypothesisId:"H3",location:"transactionStatementService.ts:extractStatementData:queuedSnapshot",message:"queued snapshot after invoke",data:{statementId:e,rowFound:Boolean(t),rowStatus:t?.status??null,rowLocked:Boolean(t?.locked_by),rowNextRetryAt:t?.next_retry_at??null,rowProcessingStartedAt:t?.processing_started_at??null,processingCount:"number"==typeof n?n:null,rowError:a?.message??null,countError:r?.message??null},timestamp:Date.now()})}).catch(()=>{})}catch(i){}const t=await this.kickQueue();try{const{data:t,error:a}=await this.supabase.from("transaction_statements").select("status, locked_by, next_retry_at, processing_started_at").eq("id",e).maybeSingle();fetch("http://127.0.0.1:7244/ingest/d1bfd845-9c34-4c24-9ef7-fd981ce7dd8e",{method:"POST",headers:{"Content-Type":"application/json","X-Debug-Session-Id":"9f46d9"},body:JSON.stringify({sessionId:"9f46d9",runId:"web-repro",hypothesisId:"H8",location:"transactionStatementService.ts:extractStatementData:queuedPostKickSnapshot",message:"row snapshot after kickQueue",data:{statementId:e,rowStatus:t?.status??null,rowLocked:Boolean(t?.locked_by),rowNextRetryAt:t?.next_retry_at??null,rowProcessingStartedAt:t?.processing_started_at??null,rowError:a?.message??null},timestamp:Date.now()})}).catch(()=>{})}catch(i){}return fetch("http://127.0.0.1:7244/ingest/d1bfd845-9c34-4c24-9ef7-fd981ce7dd8e",{method:"POST",headers:{"Content-Type":"application/json","X-Debug-Session-Id":"9f46d9"},body:JSON.stringify({sessionId:"9f46d9",runId:"web-repro",hypothesisId:"H7",location:"transactionStatementService.ts:extractStatementData:queuedKickQueue",message:"triggered kickQueue after queued response",data:{statementId:e,kickSuccess:t.success,kickError:t.error??null,kickSkipped:t.queueResponse?.skipped??null,kickReason:t.queueResponse?.reason??null,kickStatementId:t.queueResponse?.statementId??null,kickStatus:t.queueResponse?.status??null},timestamp:Date.now()})}).catch(()=>{}),{success:!0,queued:!0,status:"queued"}}if(!h?.success)throw new Error(h.error||"OCR 추출 실패");const g=await this.getStatementWithItems(e);return fetch("http://127.0.0.1:7244/ingest/d1bfd845-9c34-4c24-9ef7-fd981ce7dd8e",{method:"POST",headers:{"Content-Type":"application/json","X-Debug-Session-Id":"9f46d9"},body:JSON.stringify({sessionId:"9f46d9",runId:"ocr-regression-debug",hypothesisId:"H2",location:"transactionStatementService.ts:extractStatementData:dbItemsAfterInvoke",message:"db items after invoke",data:{statementId:e,resultSuccess:g.success,itemCount:g.data?.items?.length??0,sample:(g.data?.items||[]).slice(0,5).map(e=>({id:e?.id??null,line:e?.line_number??null,itemName:e?.extracted_item_name??null,specification:e?.extracted_specification??null,quantity:e?.extracted_quantity??null,unitPrice:e?.extracted_unit_price??null,amount:e?.extracted_amount??null,po:e?.extracted_po_number??null}))},timestamp:Date.now()})}).catch(()=>{}),g}catch(s){const t=s instanceof Error?s.message:"OCR 추출 중 오류가 발생했습니다.";let a=t;if(r)try{const e=JSON.parse(r);a=e?.error||r}catch(i){a=r}fetch("http://127.0.0.1:7244/ingest/d1bfd845-9c34-4c24-9ef7-fd981ce7dd8e",{method:"POST",headers:{"Content-Type":"application/json","X-Debug-Session-Id":"9f46d9"},body:JSON.stringify({sessionId:"9f46d9",runId:"web-repro",hypothesisId:"H2",location:"transactionStatementService.ts:extractStatementData:catchEntered",message:"extract catch entered",data:{statementId:e,errorMessage:t,errorName:s?.name??null,errorType:s?.constructor?.name??null,hasContext:Boolean(s?.context),invokeContextStatus:n,resolvedErrorMessage:a},timestamp:Date.now()})}).catch(()=>{});try{const{data:t,error:n}=await this.supabase.from("transaction_statements").update({status:"failed",extraction_error:a,last_error_at:(new Date).toISOString(),processing_finished_at:(new Date).toISOString()}).eq("id",e).in("status",["pending","queued","processing","failed"]).select("id, status, extraction_error");fetch("http://127.0.0.1:7244/ingest/d1bfd845-9c34-4c24-9ef7-fd981ce7dd8e",{method:"POST",headers:{"Content-Type":"application/json","X-Debug-Session-Id":"9f46d9"},body:JSON.stringify({sessionId:"9f46d9",runId:"web-repro",hypothesisId:"H4",location:"transactionStatementService.ts:extractStatementData:catchUpdateResult",message:"failed-status update result",data:{statementId:e,updatedRows:Array.isArray(t)?t.length:null,updateError:n?.message??null},timestamp:Date.now()})}).catch(()=>{})}catch(i){}return{success:!1,error:a}}}async kickQueue(){const e=Date.now();if(this.kickQueueInFlight||e-this.lastKickQueueAt<8e3)return fetch("http://127.0.0.1:7244/ingest/d1bfd845-9c34-4c24-9ef7-fd981ce7dd8e",{method:"POST",headers:{"Content-Type":"application/json","X-Debug-Session-Id":"9f46d9"},body:JSON.stringify({sessionId:"9f46d9",runId:"queue-debug",hypothesisId:"H3",location:"transactionStatementService.ts:kickQueue:skip",message:"kickQueue skipped by guard",data:{kickQueueInFlight:this.kickQueueInFlight,elapsedSinceLastKickMs:e-this.lastKickQueueAt,minIntervalMs:8e3},timestamp:Date.now()})}).catch(()=>{}),{success:!0};this.kickQueueInFlight=!0,this.lastKickQueueAt=e;try{const{data:e,error:n}=await this.supabase.functions.invoke("ocr-transaction-statement",{body:{mode:"process_next"}});let r=null,i=null;if(n){const e=n?.context;r=e?.status??null;try{if(e?.clone){const t=await e.clone().text();i=t?t.slice(0,200):null}else if(e?.text){const t=await e.text();i=t?t.slice(0,200):null}}catch(t){i=null}}if(fetch("http://127.0.0.1:7244/ingest/d1bfd845-9c34-4c24-9ef7-fd981ce7dd8e",{method:"POST",headers:{"Content-Type":"application/json","X-Debug-Session-Id":"9f46d9"},body:JSON.stringify({sessionId:"9f46d9",runId:"queue-debug",hypothesisId:"H4",location:"transactionStatementService.ts:kickQueue:invokeResult",message:"kickQueue invoke result",data:{hasError:Boolean(n),errorMessage:n instanceof Error?n.message:n?.message??null,hasContext:Boolean(n?.context),contextStatus:r,contextBodyHead:i,responseSuccess:Boolean(e?.success),responseSkipped:Boolean(e?.skipped),responseReason:e?.reason??null,responseStatementId:e?.statementId??null,responseStatus:e?.status??null},timestamp:Date.now()})}).catch(()=>{}),n)throw n;if(e?.skipped){let e=null,t=null,n=null,r=[],i=null,s=null,c=null,o=null;try{const a=(new Date).toISOString(),l=new Date(Date.now()-9e5).toISOString(),{count:d,error:u}=await this.supabase.from("transaction_statements").select("id",{count:"exact",head:!0}).eq("status","queued");e="number"==typeof d?d:null,i=u?.message??null;const{count:m,error:p}=await this.supabase.from("transaction_statements").select("id",{count:"exact",head:!0}).eq("status","queued").or(`next_retry_at.is.null,next_retry_at.lte.${a}`);t="number"==typeof m?m:null,s=p?.message??null;const{count:h,error:_}=await this.supabase.from("transaction_statements").select("id",{count:"exact",head:!0}).eq("status","processing").not("processing_started_at","is",null).gt("processing_started_at",l);n="number"==typeof h?h:null,c=_?.message??null;const{data:g,error:f}=await this.supabase.from("transaction_statements").select("id, next_retry_at, queued_at, processing_started_at, locked_by").eq("status","queued").order("queued_at",{ascending:!0}).limit(3);r=(g||[]).map(e=>({id:e?.id??"",next_retry_at:e?.next_retry_at??null,queued_at:e?.queued_at??null,processing_started_at:e?.processing_started_at??null,locked_by:e?.locked_by??null})),o=f?.message??null}catch(a){o=a instanceof Error?a.message:"snapshot_failed"}fetch("http://127.0.0.1:7244/ingest/d1bfd845-9c34-4c24-9ef7-fd981ce7dd8e",{method:"POST",headers:{"Content-Type":"application/json","X-Debug-Session-Id":"9f46d9"},body:JSON.stringify({sessionId:"9f46d9",runId:"queue-debug",hypothesisId:"H9",location:"transactionStatementService.ts:kickQueue:skippedSnapshot",message:"queue state snapshot after skipped process_next",data:{queuedTotalCount:e,queuedEligibleCount:t,processingActiveCount:n,queuedTotalError:i,queuedEligibleError:s,processingActiveError:c,queuedSampleError:o,queuedSample:r},timestamp:Date.now()})}).catch(()=>{})}return{success:!0,queueResponse:{skipped:Boolean(e?.skipped),reason:e?.reason??void 0,statementId:e?.statementId??void 0,status:e?.status??void 0}}}catch(n){return{success:!1,error:n instanceof Error?n.message:"큐 처리를 시작하지 못했습니다."}}finally{this.kickQueueInFlight=!1}}async getStatements(e){try{let t=this.supabase.from("transaction_statements").select("\n          *,\n          items:transaction_statement_items(matched_purchase_id)\n        ",{count:"exact"}).order("uploaded_at",{ascending:!1});e?.status&&"all"!==e.status&&(t=t.eq("status",e.status)),e?.dateFrom&&(t=t.gte("uploaded_at",e.dateFrom)),e?.dateTo&&(t=t.lte("uploaded_at",e.dateTo+"T23:59:59")),e?.search&&(t=t.or(`vendor_name.ilike.%${e.search}%,file_name.ilike.%${e.search}%`)),e?.limit&&(t=t.limit(e.limit)),e?.offset&&(t=t.range(e.offset,e.offset+(e.limit||20)-1));const{data:a,count:n,error:r}=await t;if(r)throw r;const i=new Set;(a||[]).forEach(e=>{e.items?.forEach(e=>{e.matched_purchase_id&&i.add(e.matched_purchase_id)})});const s=new Map;if(i.size>0){const{data:e}=await this.supabase.from("purchase_requests").select("id, purchase_order_number, sales_order_number").in("id",Array.from(i));e?.forEach(e=>{s.set(e.id,{purchase_order_number:e.purchase_order_number,sales_order_number:e.sales_order_number})})}return{success:!0,data:(a||[]).map(e=>{const t=new Set;e.items?.forEach(e=>{e.matched_purchase_id&&t.add(e.matched_purchase_id)});const a=Array.from(t).map(e=>{const t=s.get(e);return{purchase_id:e,purchase_order_number:t?.purchase_order_number||"",sales_order_number:t?.sales_order_number}}),{items:n,...r}=e;return{...r,matched_purchase_id:a[0]?.purchase_id||null,matched_purchases:a}}),count:n||0}}catch(t){return{success:!1,error:t instanceof Error?t.message:"조회 중 오류가 발생했습니다."}}}async getStatementWithItems(e){try{const{data:t,error:a}=await this.supabase.from("transaction_statements").select("*").eq("id",e).single();if(a)throw a;const{data:n,error:r}=await this.supabase.from("transaction_statement_items").select("*").eq("statement_id",e).order("line_number",{ascending:!0});if(r)throw r;const i=t.vendor_name||"",s=[...new Set((n||[]).map(e=>e.matched_purchase_id).filter(Boolean))],c=[...new Set((n||[]).map(e=>e.matched_item_id).filter(Boolean))],o=new Map,l=new Map;if(s.length>0){const{data:e}=await this.supabase.from("purchase_requests").select("id, purchase_order_number, sales_order_number, vendor:vendors(vendor_name)").in("id",s);(e||[]).forEach(e=>o.set(e.id,e))}if(c.length>0){const{data:e}=await this.supabase.from("purchase_request_items").select("id, item_name, specification, quantity, unit_price_value, amount_value, received_quantity").in("id",c);(e||[]).forEach(e=>l.set(e.id,e))}const d=await Promise.all((n||[]).map(async e=>{let t;const a=e.match_candidates_data;let n,r;if(a&&Array.isArray(a)&&a.length>0?t=a:(t=await this.findMatchCandidates(e,i),t.length>0&&this.supabase.from("transaction_statement_items").update({match_candidates_data:t}).eq("id",e.id).then(()=>{})),e.matched_purchase_id){const t=o.get(e.matched_purchase_id);t&&(n={id:t.id,purchase_order_number:t.purchase_order_number||"",sales_order_number:t.sales_order_number,vendor_name:t.vendor?.vendor_name})}if(e.matched_item_id){const t=l.get(e.matched_item_id);t&&(r={id:t.id,item_name:t.item_name,specification:t.specification,quantity:t.quantity,unit_price_value:t.unit_price_value,amount_value:t.amount_value,received_quantity:t.received_quantity})}return{...e,match_candidates:t,matched_purchase:n,matched_item:r}}));return{success:!0,data:{...t,items:d}}}catch(t){return{success:!1,error:t instanceof Error?t.message:"조회 중 오류가 발생했습니다."}}}async findMatchCandidates(e,t){const a=new Map;try{const n=e.extracted_po_number||"",r=n?Ya(n):"",i=n.toUpperCase().match(/^(F)(\d{8})$/),s=n.toUpperCase().match(/^(HS)(\d{6})$/),c=!(!i&&!s),o=i?`F${i[2]}`:s?`HS${s[2]}`:"";if(r){const{data:n}=await this.supabase.from("purchase_requests").select("\n            id, \n            purchase_order_number, \n            sales_order_number,\n            vendor:vendors(vendor_name),\n            items:purchase_request_items(id, item_name, specification, quantity, received_quantity, unit_price_value)\n          ").or(`purchase_order_number.eq.${r},sales_order_number.eq.${r}`).limit(10);if(n)for(const r of n){const n=r.vendor?.vendor_name||"",i=t?this.calculateVendorSimilarity(t,n):100;if(!(i<50))for(const t of r.items||[]){const s=`${r.id}-${t.id}`,c=["발주/수주번호 일치"];let o=50;if(i>=90?(o+=10,c.push("거래처 일치")):i>=70&&(o+=5,c.push("거래처 유사")),e.extracted_item_name){const a=this.calculateItemMatchScore(e.extracted_item_name,t.item_name,t.specification);o+=.3*a.score,a.score>=80&&c.push("specification"===a.matchedField?"규격 일치":"품목명 일치")}e.extracted_quantity&&t.quantity&&(e.extracted_quantity===t.quantity?(o+=15,c.push(`수량 일치 (${e.extracted_quantity})`)):e.extracted_quantity<=t.quantity&&(o+=5,c.push(`수량 (요청:${t.quantity}, 입고:${e.extracted_quantity})`))),a.set(s,{purchase_id:r.id,purchase_order_number:r.purchase_order_number||"",sales_order_number:r.sales_order_number,item_id:t.id,item_name:t.item_name,specification:t.specification,quantity:t.quantity,received_quantity:t.received_quantity,unit_price:t.unit_price_value,vendor_name:n,score:o,match_reasons:c})}}}if(c&&o&&0===a.size){const{data:n}=await this.supabase.from("purchase_requests").select("\n            id, \n            purchase_order_number, \n            sales_order_number,\n            vendor:vendors(vendor_name),\n            items:purchase_request_items(id, item_name, specification, quantity, received_quantity, unit_price_value)\n          ").or(`purchase_order_number.ilike.${o}%,sales_order_number.ilike.${o}%`).limit(20);if(n)for(const r of n){const n=r.vendor?.vendor_name||"",i=t?this.calculateVendorSimilarity(t,n):100;if(!(i<50))for(const t of r.items||[]){const s=`${r.id}-${t.id}`;if(a.has(s))continue;const c=[`날짜 일치 (${o})`];let l=30;if(i>=90?(l+=20,c.push("거래처 일치")):i>=70&&(l+=10,c.push("거래처 유사")),e.extracted_item_name){const a=this.calculateItemMatchScore(e.extracted_item_name,t.item_name,t.specification);l+=.4*a.score,a.score>=80?c.push("specification"===a.matchedField?"규격 일치":"품목명 일치"):a.score>=50&&c.push("specification"===a.matchedField?"규격 유사":"품목명 유사")}e.extracted_quantity&&t.quantity&&(e.extracted_quantity===t.quantity?(l+=15,c.push(`수량 일치 (${e.extracted_quantity})`)):e.extracted_quantity<=t.quantity&&(l+=5,c.push(`수량 (요청:${t.quantity}, 입고:${e.extracted_quantity})`))),a.set(s,{purchase_id:r.id,purchase_order_number:r.purchase_order_number||"",sales_order_number:r.sales_order_number,item_id:t.id,item_name:t.item_name,specification:t.specification,quantity:t.quantity,received_quantity:t.received_quantity,unit_price:t.unit_price_value,vendor_name:n,score:l,match_reasons:c})}}}if(e.extracted_item_name){const n=e.extracted_item_name.trim(),i=[n,n.substring(0,Math.min(n.length,12)),n.substring(0,Math.min(n.length,8)),n.split(/\[|]|\s|_|-/)[0]].filter(e=>e&&e.length>=3),s=[...new Set(i)];for(const c of s){const{data:n}=await this.supabase.from("purchase_request_items").select("\n              id, \n              item_name, \n              specification, \n              quantity, \n              received_quantity,\n              unit_price_value,\n              purchase:purchase_requests!inner(\n                id, \n                purchase_order_number, \n                sales_order_number,\n                vendor:vendors(vendor_name)\n              )\n            ").or(`item_name.ilike.%${c}%,specification.ilike.%${c}%`).limit(50);if(n&&n.length>0){for(const i of n){const n=`${i.purchase?.id}-${i.id}`;if(a.has(n))continue;const s=i.purchase?.vendor?.vendor_name||"",c=t?this.calculateVendorSimilarity(t,s):100;if(c<50)continue;const o=[];let l=0;c>=90?(l+=20,o.push("거래처 일치")):c>=70&&(l+=10,o.push("거래처 유사"));const d=this.calculateItemMatchScore(e.extracted_item_name,i.item_name,i.specification);d.score>=40&&(l+=.7*d.score,d.score>=85?o.push("specification"===d.matchedField?"규격 일치":"품목명 일치"):d.score>=50?o.push("specification"===d.matchedField?"규격 유사":"품목명 유사"):o.push("품목 부분일치")),e.extracted_quantity&&i.quantity&&(e.extracted_quantity===i.quantity?(l+=15,o.push(`수량 일치 (${e.extracted_quantity})`)):e.extracted_quantity<=i.quantity&&(l+=5,o.push(`수량 (요청:${i.quantity}, 입고:${e.extracted_quantity})`)));const u=i.purchase?.purchase_order_number||"",m=i.purchase?.sales_order_number||"";r&&u!==r&&m!==r&&o.push(`⚠️ OCR 오류 가능: ${r} → ${u||m}`),l>=15&&a.set(n,{purchase_id:i.purchase?.id,purchase_order_number:u,sales_order_number:m,item_id:i.id,item_name:i.item_name,specification:i.specification,quantity:i.quantity,received_quantity:i.received_quantity,unit_price:i.unit_price_value,vendor_name:i.purchase?.vendor?.vendor_name,score:l,match_reasons:o})}if(a.size>=5)break}}}const l=Array.from(a.values()).some(e=>e.score>=40);if((0===a.size||!l)&&t){const{data:n}=await this.supabase.from("vendors").select("id, vendor_name").limit(100);if(n){const i=n.filter(e=>this.calculateVendorSimilarity(t,e.vendor_name)>=70);if(i.length>0){const t=i.map(e=>e.id),n=new Date;n.setMonth(n.getMonth()-3);const{data:s}=await this.supabase.from("purchase_requests").select("\n                id, \n                purchase_order_number, \n                sales_order_number,\n                vendor:vendors(vendor_name),\n                items:purchase_request_items(id, item_name, specification, quantity, received_quantity, unit_price_value)\n              ").in("vendor_id",t).gte("created_at",n.toISOString()).order("created_at",{ascending:!1}).limit(30);if(s)for(const i of s){const t=i.vendor?.vendor_name||"";for(const n of i.items||[]){const s=`${i.id}-${n.id}`;if(a.has(s))continue;const c=["거래처 일치"];let o=20;if(e.extracted_item_name){const t=this.calculateItemMatchScore(e.extracted_item_name,n.item_name,n.specification);t.score>=40&&(o+=.5*t.score,t.score>=85?c.push("specification"===t.matchedField?"규격 일치":"품목명 일치"):t.score>=50&&c.push("specification"===t.matchedField?"규격 유사":"품목명 유사"))}e.extracted_quantity&&n.quantity&&(e.extracted_quantity===n.quantity?(o+=15,c.push(`수량 일치 (${e.extracted_quantity})`)):e.extracted_quantity<=n.quantity&&(o+=5,c.push(`수량 (요청:${n.quantity}, 입고:${e.extracted_quantity})`)));const l=i.purchase_order_number||"",d=i.sales_order_number||"";r&&c.push(`⚠️ OCR 오류 가능: ${r} → ${l||d}`),o>=15&&a.set(s,{purchase_id:i.id,purchase_order_number:l,sales_order_number:d,item_id:n.id,item_name:n.item_name,specification:n.specification,quantity:n.quantity,received_quantity:n.received_quantity,unit_price:n.unit_price_value,vendor_name:t,score:o,match_reasons:c})}}}}}const d=Array.from(a.values());return d.sort((e,t)=>t.score-e.score),d.length,d.slice(0,15)}catch(n){return[]}}calculateNameSimilarity(e,t){const a=e.toLowerCase().replace(/\s+/g,""),n=t.toLowerCase().replace(/\s+/g,"");if(!a||!n)return 0;if(a===n)return 100;if(a.includes(n)||n.includes(a))return 80;const r=Math.max(a.length,n.length),i=(r-this.levenshteinDistance(a,n))/r*100;return Math.round(i)}calculateItemMatchScore(e,t,a){if(!e)return{score:0,matchedField:"none"};const n=t?this.calculateNameSimilarity(e,t):0,r=a?this.calculateNameSimilarity(e,a):0;return n>=r?{score:n,matchedField:n>0?"item_name":"none"}:{score:r,matchedField:r>0?"specification":"none"}}calculateVendorSimilarity(e,t){if(!e||!t)return 0;const a=e=>e.toLowerCase().replace(/\(주\)|주식회사|㈜|주\)|주|co\.|co,|ltd\.|ltd|inc\.|inc|corp\.|corp|company|컴퍼니/gi,"").replace(/[^a-z0-9가-힣]/g,"").trim(),n=a(e),r=a(t);if(!n||!r)return 0;if(n===r)return 100;if(n.includes(r)||r.includes(n))return 90;const i={yg:["와이지","yg"],"와이지":["yg","와이지"],tech:["테크","텍","tech"],"테크":["tech","텍","테크"],"텍":["tech","테크","텍"],high:["하이","high"],"하이":["high","하이"],korea:["코리아","한국","korea"],"코리아":["korea","한국","코리아"],electric:["전기","일렉트릭","electric"],"전기":["electric","일렉트릭","전기"],steel:["스틸","철강","steel"],"스틸":["steel","철강","스틸"],metal:["메탈","금속","metal"],"메탈":["metal","금속","메탈"],system:["시스템","system"],"시스템":["system","시스템"],soft:["소프트","soft"],"소프트":["soft","소프트"],net:["넷","net"],"넷":["net","넷"],global:["글로벌","global"],"글로벌":["global","글로벌"],trade:["트레이드","무역","trade"],"트레이드":["trade","무역","트레이드"],international:["인터내셔널","international"],"인터내셔널":["international","인터내셔널"]};let s=n,c=r;for(const[d,u]of Object.entries(i)){if(n.includes(d)){for(const e of u)if(s=s.replace(d,e),s===r||r.includes(s)||s.includes(r))return 85;s=n}if(r.includes(d)){for(const e of u)if(c=c.replace(d,e),n===c||n.includes(c)||c.includes(n))return 85;c=r}}const o=Math.max(n.length,r.length),l=(o-this.levenshteinDistance(n,r))/o*100;return Math.round(l)}isVendorMatch(e,t,a=70){return this.calculateVendorSimilarity(e,t)>=a}levenshteinDistance(e,t){const a=e.length,n=t.length,r=Array(a+1).fill(null).map(()=>Array(n+1).fill(0));for(let i=0;i<=a;i++)r[i][0]=i;for(let i=0;i<=n;i++)r[0][i]=i;for(let i=1;i<=a;i++)for(let a=1;a<=n;a++)e[i-1]===t[a-1]?r[i][a]=r[i-1][a-1]:r[i][a]=Math.min(r[i-1][a-1],r[i-1][a],r[i][a-1])+1;return r[a][n]}calculateSimilarityScore(e,t){let a=0;if(e.extracted_item_name){a+=.4*this.calculateItemMatchScore(e.extracted_item_name,t.item_name||"",t.specification||"").score}if(e.extracted_specification){a+=.2*this.calculateItemMatchScore(e.extracted_specification,t.item_name||"",t.specification||"").score}if(e.extracted_quantity&&t.quantity){const n=Math.abs(e.extracted_quantity-t.quantity);0===n?a+=20:n<=.1*t.quantity?a+=15:n<=.2*t.quantity&&(a+=10)}if(e.extracted_unit_price&&t.unit_price_value){const n=Math.abs(e.extracted_unit_price-t.unit_price_value);0===n?a+=20:n<=.05*t.unit_price_value?a+=15:n<=.1*t.unit_price_value&&(a+=10)}return a}getMatchReasons(e,t,a){const n=[];if(e.extracted_item_name){const a=this.calculateItemMatchScore(e.extracted_item_name,t.item_name||"",t.specification||"");a.score>=90?n.push("specification"===a.matchedField?"규격 완전 일치":"품목명 완전 일치"):a.score>=70?n.push("specification"===a.matchedField?"규격 높은 유사도":"품목명 높은 유사도"):a.score>=50&&n.push("specification"===a.matchedField?"규격 부분 일치":"품목명 부분 일치")}return e.extracted_quantity&&t.quantity&&(e.extracted_quantity===t.quantity?n.push(`수량 일치 (${e.extracted_quantity})`):e.extracted_quantity<=t.quantity&&n.push(`수량 (요청:${t.quantity}, 입고:${e.extracted_quantity})`)),e.extracted_unit_price===t.unit_price_value&&n.push("단가 일치"),a>=70?n.push("높은 유사도"):a>=50&&n.push("보통 유사도"),n}async updateItemMatch(e,t,a,n="manual"){try{const{error:r}=await this.supabase.from("transaction_statement_items").update({matched_purchase_id:t,matched_item_id:a,match_method:n}).eq("id",e);if(r)throw r;return{success:!0}}catch(r){return{success:!1,error:r instanceof Error?r.message:"매칭 업데이트 중 오류가 발생했습니다."}}}async confirmStatement(e,t){try{const{data:{user:a}}=await this.supabase.auth.getUser();for(const o of e.items){const{error:a}=await this.supabase.from("transaction_statement_items").update({is_confirmed:!0,matched_purchase_id:o.matched_purchase_id,matched_item_id:o.matched_item_id,confirmed_quantity:o.confirmed_quantity,confirmed_unit_price:o.confirmed_unit_price,confirmed_amount:o.confirmed_amount,is_additional_item:o.is_additional_item||!1,parent_item_id:o.parent_item_id}).eq("id",o.itemId);if(a)throw a;if(o.matched_item_id){const a={};if(void 0!==o.confirmed_unit_price&&null!==o.confirmed_unit_price&&(a.unit_price_value=o.confirmed_unit_price),void 0!==o.confirmed_amount&&null!==o.confirmed_amount&&(a.amount_value=o.confirmed_amount),e.accounting_received_date&&(a.accounting_received_date=e.accounting_received_date,a.is_statement_received=!0,a.statement_received_date=e.accounting_received_date,a.statement_received_by_name=t||null),Object.keys(a).length>0){const{error:e}=await this.supabase.from("purchase_request_items").update(a).eq("id",o.matched_item_id);e&&c.warn("Failed to update purchase item (unit_price/amount/accounting_date):",e)}}if(o.is_additional_item&&o.matched_purchase_id&&!o.matched_item_id){const a=await this.getStatementItem(o.itemId),n={purchase_request_id:o.matched_purchase_id,item_name:a?.extracted_item_name||"추가 공정",specification:a?.extracted_specification,quantity:o.confirmed_quantity||1,unit_price_value:o.confirmed_unit_price,amount_value:o.confirmed_amount,accounting_received_date:e.accounting_received_date,remark:"거래명세서에서 추가됨"};e.accounting_received_date&&(n.is_statement_received=!0,n.statement_received_date=e.accounting_received_date,n.statement_received_by_name=t||null);const{error:r}=await this.supabase.from("purchase_request_items").insert(n);r&&c.warn("Failed to insert additional item:",r)}}const n=(new Date).toISOString(),{data:r,error:i}=await this.supabase.from("transaction_statements").update({manager_confirmed_at:n,manager_confirmed_by:a?.id,manager_confirmed_by_name:t||null}).eq("id",e.statementId).select("*").single();if(i)throw i;const s=await this.tryFinalizeStatement(e.statementId);return s.success?{success:!0,finalized:s.finalized,updatedStatement:s.updatedStatement||r}:{success:!1,error:s.error}}catch(a){return c.error("Confirm statement error:",a),{success:!1,error:a instanceof Error?a.message:"확정 중 오류가 발생했습니다."}}}async confirmQuantityMatch(e,t){try{const{data:{user:a}}=await this.supabase.auth.getUser(),n=(new Date).toISOString(),{data:r,error:i}=await this.supabase.from("transaction_statements").update({quantity_match_confirmed_at:n,quantity_match_confirmed_by:a?.id,quantity_match_confirmed_by_name:t||null}).eq("id",e.statementId).select("*").single();if(i)throw i;if(e.actual_received_date){const a=t||"알수없음";for(const t of e.items){if(!t.matched_item_id||void 0===t.confirmed_quantity||null===t.confirmed_quantity)continue;const{data:n}=await this.supabase.from("purchase_request_items").select("receipt_history").eq("id",t.matched_item_id).single(),r=Array.isArray(n?.receipt_history)?n?.receipt_history:[],i=r.length+1,s=[...r,{seq:i,qty:t.confirmed_quantity,date:e.actual_received_date,by:a}],{error:o}=await this.supabase.from("purchase_request_items").update({actual_received_date:e.actual_received_date,received_quantity:t.confirmed_quantity,is_received:!0,delivery_status:"received",receipt_history:s,received_at:(new Date).toISOString()}).eq("id",t.matched_item_id);o&&c.warn("Failed to update purchase item:",o)}}const s=await this.tryFinalizeStatement(e.statementId);return s.success?{success:!0,finalized:s.finalized,updatedStatement:s.updatedStatement||r}:{success:!1,error:s.error}}catch(a){return c.error("Confirm quantity match error:",a),{success:!1,error:a instanceof Error?a.message:"수량일치 확인 중 오류가 발생했습니다."}}}async tryFinalizeStatement(e){try{const{data:t,error:a}=await this.supabase.from("transaction_statements").select("*").eq("id",e).single();if(a)throw a;if("confirmed"===t.status)return{success:!0,finalized:!0,updatedStatement:t};const n=!!t.manager_confirmed_at,r=!!t.quantity_match_confirmed_at;if(!n||!r)return{success:!0,finalized:!1,updatedStatement:t};const i=(new Date).toISOString(),s=t.manager_confirmed_by||t.quantity_match_confirmed_by||null,c=t.manager_confirmed_by_name||t.quantity_match_confirmed_by_name||null,{data:o,error:l}=await this.supabase.from("transaction_statements").update({status:"confirmed",confirmed_at:i,confirmed_by:s,confirmed_by_name:c}).eq("id",e).select("*").single();if(l)throw l;return{success:!0,finalized:!0,updatedStatement:o}}catch(t){return c.error("Finalize statement error:",t),{success:!1,finalized:!1,error:t instanceof Error?t.message:"확정 처리 중 오류가 발생했습니다."}}}async getStatementItem(e){const{data:t}=await this.supabase.from("transaction_statement_items").select("*").eq("id",e).single();return t}async rejectStatement(e){try{const{error:t}=await this.supabase.from("transaction_statements").update({status:"rejected"}).eq("id",e);if(t)throw t;return{success:!0}}catch(t){return{success:!1,error:t instanceof Error?t.message:"거부 처리 중 오류가 발생했습니다."}}}async deleteStatement(e){try{const{data:a}=await this.supabase.from("transaction_statements").select("image_url").eq("id",e).single(),{error:n}=await this.supabase.from("transaction_statements").delete().eq("id",e);if(n)throw n;if(a?.image_url)try{const e=a.image_url.split("/receipt-images/")[1];e&&await this.supabase.storage.from("receipt-images").remove([e])}catch(t){}return{success:!0}}catch(a){return{success:!1,error:a instanceof Error?a.message:"삭제 중 오류가 발생했습니다."}}}async findBestMatchingPurchaseOrderSet(e,t,a){try{const n=t?Ya(t):"",r=[];if(n){const{data:t}=await this.supabase.from("purchase_requests").select("\n            id, \n            purchase_order_number, \n            sales_order_number,\n            vendor:vendors(vendor_name),\n            items:purchase_request_items(id, item_name, specification, quantity, received_quantity, unit_price_value)\n          ").or(`purchase_order_number.eq.${n},sales_order_number.eq.${n}`).limit(5);if(t&&t.length>0)for(const n of t){const t=n.vendor?.vendor_name||"";if((a?this.calculateVendorSimilarity(a,t):100)<50)continue;const i=this.calculateSetMatchScore(e,n.items||[]);r.push({purchase_id:n.id,purchase_order_number:n.purchase_order_number||"",sales_order_number:n.sales_order_number,vendor_name:t,matchScore:i.score,matchedItemCount:i.matchedCount,totalItemCount:e.length,items:n.items||[],itemMatches:i.itemMatches})}}const i=r.length>0?r.reduce((e,t)=>e.matchScore>t.matchScore?e:t):null;if(i&&i.matchScore>=80)return{success:!0,data:{bestMatch:{...i,confidence:"high"},candidates:r.map(e=>({purchase_id:e.purchase_id,purchase_order_number:e.purchase_order_number,sales_order_number:e.sales_order_number,vendor_name:e.vendor_name,matchScore:e.matchScore,matchedItemCount:e.matchedItemCount}))}};const s=new Date;s.setMonth(s.getMonth()-3);const{data:c}=await this.supabase.from("purchase_requests").select("\n          id, \n          purchase_order_number, \n          sales_order_number,\n          vendor:vendors(vendor_name),\n          items:purchase_request_items(id, item_name, specification, quantity, received_quantity, unit_price_value)\n        ").gte("created_at",s.toISOString()).order("created_at",{ascending:!1}).limit(100);if(c)for(const t of c){if(r.some(e=>e.purchase_id===t.id))continue;const n=t.vendor?.vendor_name||"";if((a?this.calculateVendorSimilarity(a,n):100)<50)continue;const i=this.calculateSetMatchScore(e,t.items||[]);i.score>=40&&r.push({purchase_id:t.id,purchase_order_number:t.purchase_order_number||"",sales_order_number:t.sales_order_number,vendor_name:n,matchScore:i.score,matchedItemCount:i.matchedCount,totalItemCount:e.length,items:t.items||[],itemMatches:i.itemMatches})}r.sort((e,t)=>t.matchScore-e.matchScore);const o=r.length>0?r[0]:null;return{success:!0,data:{bestMatch:o?{...o,confidence:o.matchScore>=80?"high":o.matchScore>=50?"medium":"low"}:null,candidates:r.slice(0,10).map(e=>({purchase_id:e.purchase_id,purchase_order_number:e.purchase_order_number,sales_order_number:e.sales_order_number,vendor_name:e.vendor_name,matchScore:e.matchScore,matchedItemCount:e.matchedItemCount}))}}}catch(n){return{success:!1,error:n instanceof Error?n.message:"세트 매칭 중 오류가 발생했습니다."}}}calculateSetMatchScore(e,t){if(0===e.length||0===t.length)return{score:0,matchedCount:0,itemMatches:[]};const a=[],n=new Set;let r=0;for(const o of e){let e=null;for(const a of t){if(n.has(a.id))continue;const t=this.calculateItemMatchScore(o.extracted_item_name||"",a.item_name||"",a.specification||"");let r=0;o.extracted_quantity&&a.quantity&&(o.extracted_quantity===a.quantity?r=15:o.extracted_quantity<=a.quantity&&(r=5));const i=t.score+r;(!e||i>e.similarity)&&(e={id:a.id,name:a.item_name,similarity:i})}e&&e.similarity>=40&&(n.add(e.id),r+=e.similarity,a.push({ocrItemId:o.id,systemItemId:e.id,systemItemName:e.name,similarity:e.similarity}))}const i=a.length/e.length,s=a.length>0?r/a.length:0,c=Math.round(50*i+.5*s);return{score:Math.min(100,c),matchedCount:a.length,itemMatches:a}}async saveCorrection(e){try{const{data:{user:t}}=await this.supabase.auth.getUser(),{error:a}=await this.supabase.from("ocr_corrections").insert({statement_id:e.statement_id,statement_item_id:e.statement_item_id,original_text:e.original_text,corrected_text:e.corrected_text,field_type:e.field_type,corrected_by:t?.id});if(a)throw a;return{success:!0}}catch(t){return{success:!1,error:t instanceof Error?t.message:"교정 데이터 저장 중 오류가 발생했습니다."}}}async getStatementsByPurchaseId(e){try{const{data:t}=await this.supabase.from("transaction_statement_items").select("statement_id, line_number").eq("matched_purchase_id",e);if(!t||0===t.length)return{success:!0,data:[]};const a=new Map;t.forEach(e=>{const t=a.get(e.statement_id)||[];e.line_number&&!t.includes(e.line_number)&&t.push(e.line_number),a.set(e.statement_id,t)});const n=[...a.keys()],{data:r,error:i}=await this.supabase.from("transaction_statements").select("*").in("id",n).order("uploaded_at",{ascending:!1});if(i)throw i;return{success:!0,data:(r||[]).map(e=>({...e,linked_line_numbers:(a.get(e.id)||[]).sort((e,t)=>e-t)}))}}catch(t){return{success:!1,error:t instanceof Error?t.message:"조회 중 오류가 발생했습니다."}}}},Za=({id:e,children:t})=>{const{attributes:a,listeners:n,setNodeRef:i,transform:s,transition:c,isDragging:o}=La({id:e}),l={transform:$e.Transform.toString(s),transition:c};return r.jsx(r.Fragment,{children:t({setNodeRef:i,attributes:a,listeners:n,isDragging:o,style:l})})};const en=t.memo(function({purchaseId:e,isOpen:a,onClose:n,embedded:d=!1,currentUserRoles:u=[],activeTab:D,forceShowStatementColumns:M=!1,onRefresh:ue,onOptimisticUpdate:me,onDelete:pe}){const{allPurchases:he,lastFetch:_e}=m(),[ge,fe]=t.useState(!1),[ve,xe]=t.useState(null),[be,ye]=t.useState(!1),[we,Ne]=t.useState(null),[je,Se]=t.useState([]),[qe,ke]=t.useState([]),[Ce,Ie]=t.useState([]),[De,Me]=t.useState(""),[$e,Re]=t.useState([]),[Ee,Te]=t.useState(null),[Oe,Pe]=t.useState([]),[Ae,Fe]=t.useState(""),[Le,We]=t.useState(!1),[ze,Be]=t.useState(""),[Ue,Ke]=t.useState(""),[He,Qe]=t.useState(),[Ve,Xe]=t.useState([]),[Ye,Ge]=t.useState([]),[Ze,et]=t.useState(!1),tt=t.useRef(null),[at,nt]=t.useState(!1),[rt,it]=t.useState([]),st=function(){for(var e=arguments.length,a=new Array(e),n=0;n<e;n++)a[n]=arguments[n];return t.useMemo(()=>[...a].filter(e=>null!=e),[...a])}((ct=Ot,ot={activationConstraint:{distance:4}},t.useMemo(()=>({sensor:ct,options:null!=ot?ot:{}}),[ct,ot])));var ct,ot;const lt=t.useCallback((e,t)=>e?.stableKey?e.stableKey:null!=e?.id?`sk-item-${e.id}`:e?.tempId?`sk-tmp-${e.tempId}`:null!=e?.line_number?`sk-line-${e.line_number}-${t}`:`sk-idx-${t}`,[]),dt=t.useCallback((e=[])=>e.map((e,t)=>{const a={...e,tempId:e?.tempId??`tmp-${e?.id??e?.line_number??t}-${t}`};return{...a,stableKey:lt(a,t)}}),[lt]),ut=t.useCallback((e,t)=>e?.stableKey?e.stableKey:null!=e?.id?`item-${e.id}`:e?.tempId?`tmp-${e.tempId}`:null!=e?.line_number?`line-${e.line_number}-${t}`:`temp-${t}`,[]),mt=t.useCallback(e=>{const{active:t,over:a}=e;a&&t.id!==a.id&&Se(e=>{const n=e.findIndex((e,a)=>ut(e,a)===t.id),r=e.findIndex((e,t)=>ut(e,t)===a.id);if(-1===n||-1===r)return e;return Sa(e,n,r).map((e,t)=>({...e,line_number:t+1,stableKey:e.stableKey??lt(e,t)}))})},[ut,lt]);t.useEffect(()=>{Le&&(Be(""),Ke(""),Qe(void 0),Xe([]),Ge([]))},[Le]),t.useEffect(()=>{"quantity_change"===ze&&0===Ve.length&&Xe([{id:pt(),itemId:"",newQuantity:""}]),"price_change"===ze&&0===Ye.length&&Ge([{id:pt(),itemId:"",changeType:"unit_price",newValue:""}])},[ze,Ve.length,Ye.length]);const pt=()=>`row-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,ht=t.useMemo(()=>ve?.purchase_request_items?[...ve.purchase_request_items].sort((e,t)=>(e.line_number??Number.MAX_SAFE_INTEGER)-(t.line_number??Number.MAX_SAFE_INTEGER)):[],[ve]),_t=t.useMemo(()=>ht.map(e=>({value:String(e.id),label:`${e.line_number?`${e.line_number}.`:""} ${e.item_name} (${e.specification||"-"})`.trim()})),[ht]),gt=[{value:"delivery_date_change",label:"입고일 변경 요청"},{value:"quantity_change",label:"수량 변경 요청"},{value:"price_change",label:"단가/합계 금액 변경 요청"},{value:"modify",label:"수정 요청"},{value:"delete",label:"삭제 요청"}],ft=[{value:"unit_price",label:"단가"},{value:"amount",label:"합계액"}],vt=e=>{if("undefined"==typeof document)return 7*e.length;tt.current||(tt.current=document.createElement("canvas"));const t=tt.current.getContext("2d");return t?(t.font=(()=>{if("undefined"==typeof document)return'11px Pretendard, -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans KR", sans-serif';const e=window.getComputedStyle(document.body),t=e.fontFamily||'Pretendard, -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans KR", sans-serif';return`${e.fontWeight||"400"} 11px ${t}`})(),Math.ceil(t.measureText(e).width)):7*e.length},xt=(e,t=4,a=12)=>Math.max(e.length+t,a),bt=e=>e.reduce((e,t)=>{const a=t.label??"";return Math.max(e,vt(a))},0),yt="문의 유형을 선택해주세요",wt=xt(yt,3,14),Nt=xt(gt.reduce((e,t)=>{const a=t.label||"";return a.length>e.length?a:e},yt),3,wt),jt="품목 선택/검색",St=((e,t)=>{const a=bt(e),n=Math.max(a,vt(t));return Math.ceil(n+24+30)})(_t,jt)+16,qt=((e,t)=>{const a=bt(e),n=Math.max(a,vt(t));return Math.ceil(n+24+30+14)})(_t,jt),kt=(e,t)=>({control:e=>({...e,minHeight:"28px",height:"28px",fontSize:"11px",borderRadius:"8px",borderColor:"#e5e7eb",boxShadow:"none"}),container:t=>({...t,width:e?`${e}px`:t.width,maxWidth:"100%"}),valueContainer:e=>({...e,padding:"0 8px"}),input:e=>({...e,margin:0,padding:0,fontSize:"11px"}),indicatorsContainer:e=>({...e,height:"28px"}),option:e=>({...e,fontSize:"11px",whiteSpace:"nowrap",overflow:"visible",textOverflow:"clip"}),placeholder:e=>({...e,fontSize:"11px",color:"#9ca3af"}),singleValue:e=>({...e,fontSize:"11px",overflow:"visible",textOverflow:"clip",maxWidth:"none"}),menu:e=>({...e,width:t?`${t}px`:e.width,minWidth:t?`${t}px`:e.minWidth,maxWidth:t?`${t}px`:"90vw"}),menuList:e=>({...e,width:t?`${t}px`:e.width,minWidth:t?`${t}px`:e.minWidth,maxWidth:t?`${t}px`:e.maxWidth})}),Ct=e=>{if(!e)return"";const t=Number(e);return Number.isFinite(t)?t.toLocaleString("ko-KR"):e},It=(e,t)=>{Xe(a=>a.map(a=>a.id===e?{...a,...t}:a))},Dt=(e,t)=>{Ge(a=>a.map(a=>a.id===e?{...a,...t}:a))},Mt=t.useRef(be);t.useEffect(()=>{Mt.current=be},[be]);const $t=t.useRef(at);t.useEffect(()=>{$t.current=at},[at]);const Rt=t.useRef(0),Et=t.useRef(0),Tt=t.useRef(!0),Pt=t.useRef(!1);t.useEffect(()=>{if(!a||!e)return;const t=p(()=>{if(Tt.current)return void(Tt.current=!1);if(Mt.current)return;if($t.current)return;if(Rt.current&&Date.now()-Rt.current<3e4)return void c.debug("[PurchaseDetailModal] 저장 직후(30s) - Realtime 캐시 이벤트 무시");if(Pt.current)return void c.debug("[PurchaseDetailModal] 업데이트 진행 중 - Realtime 이벤트 무시");const t=_(e);if(t){const e=t.items||t.purchase_request_items||[];xe(a=>{const n=a?.items||a?.purchase_request_items||[],r=0===e.length&&n.length>0?n:e;return 0===e.length&&0===n.length&&a?(c.debug("[PurchaseDetailModal] 캐시/현재 items 모두 비어있음 - 업데이트 스킵"),a):{...t,id:String(t.id),is_po_generated:!1,items:r,purchase_request_items:r}})}});return()=>t()},[a,e]);const At=t.useMemo(()=>{if(ve?.items&&ve.items.length>0)return dt(ve.items);if(ve?.purchase_request_items&&ve.purchase_request_items.length>0)return dt(ve.purchase_request_items);if(e&&he){const t=he.find(t=>t.id===e);if(t){const e=t.items&&t.items.length>0?t.items:t.purchase_request_items||[];return dt(e)}}return[]},[ve,e,he,_e,dt]),Ft=t.useMemo(()=>{if(be)return je||[];return[...At||[]].sort((e,t)=>{const a=e?.line_number??999999,n=t?.line_number??999999;if(a!==n)return a-n;const r=e?.created_at?new Date(e.created_at).getTime():0,i=t?.created_at?new Date(t.created_at).getTime():0;if(r!==i)return r-i;const s=e?.id??0,c=t?.id??0;if(s!==c)return s-c;const o=e?.tempId??"",l=t?.tempId??"";return o<l?-1:o>l?1:0})},[be,je,At]),Lt=t.useMemo(()=>(je||[]).map((e,t)=>ut(e,t)),[je,ut]);t.useMemo(()=>{if($e.length>0){const e=$e.length>1?12*($e.length-1):0,t=24,a=$e.reduce((e,t)=>e+t,0)+e+t;return Math.max(a,720)}const e=[120,200,70,90,100,150,80];"purchase"===D&&e.push(120),"receipt"!==D&&"done"!==D||e.push(120),"receipt"===D&&e.push(140),"done"===D&&e.push(100,80,110),be&&e.push(110);const t=e.length>1?12*(e.length-1):0,a=e.reduce((e,t)=>e+t,0)+t+48;return Math.max(a,720)},[$e,D,be]);const Wt=t.useRef(null),zt=s();t.useEffect(()=>{a&&(async()=>{try{const e="https://qvhbigvdfyvhoegkhvef.supabase.co";if(!e||e.includes("placeholder"))return void c.warn("Supabase 환경 변수가 설정되지 않음 - PurchaseDetailModal");const{data:{user:t}}=await zt.auth.getUser();if(t){let{data:e}=await zt.from("employees").select("*").eq("id",t.id).maybeSingle();if(!e&&t.email){const{data:a}=await zt.from("employees").select("*").eq("email",t.email).maybeSingle();e=a}if(e?.name&&Me(e.name),e?.purchase_role){let t=[];t=Array.isArray(e.purchase_role)?e.purchase_role.map(e=>String(e).trim()):String(e.purchase_role).split(",").map(e=>e.trim()).filter(e=>e.length>0),Ie(t)}}}catch(e){c.error("사용자 권한 로드 실패:",e)}})()},[a]),t.useEffect(()=>{a&&(async()=>{try{const{data:e,error:t}=await zt.from("vendors").select("*").order("vendor_name",{ascending:!0});if(t)throw t;e&&Pe(e)}catch(e){c.error("업체 목록 로드 실패:",e)}})()},[a]);const Bt=Array.isArray(u)&&u.length>0?u:Ce,Ut=Bt.includes("final_approver")||Bt.includes("app_admin")||Bt.includes("ceo"),Kt=Bt.includes("lead buyer"),Ht=Ut||Kt,Qt=Bt.some(e=>Va.includes(e)),Vt=M||"발주"===ve?.payment_category&&("done"===D||"receipt"===D&&Bt.includes("lead buyer")),Xt=M&&"done"===D||"발주"===ve?.payment_category&&"done"===D,Jt="approved"===ve?.final_manager_status?Ut:Ut||ve?.requester_name===De,Yt=Bt.includes("app_admin")||Bt.includes("lead buyer")||Bt.includes("lead buyer"),Gt=Bt.includes("app_admin")||ve?.requester_name===De,Zt=Bt.includes("final_approver")||Bt.includes("app_admin")||Bt.includes("ceo"),ea=ve?.requester_name===De,ta=Bt.includes("app_admin")||Bt.includes("lead buyer")||Bt.includes("accounting"),aa=Bt.includes("app_admin")||ea,na=t.useCallback(async()=>{if(e)if(Mt.current||$t.current)c.debug("[refreshModalData] 편집/저장 중 - DB 새로고침 스킵",{isEditing:Mt.current,isSaving:$t.current});else try{const t=s(),{data:a,error:n}=await t.from("purchase_requests").select("\n          *,\n          vendors:vendor_id(id, vendor_name, is_active),\n          purchase_request_items(*),\n          contact:contact_id(id, contact_name, contact_email, contact_phone, position)\n        ").eq("id",e).single();if(n)throw n;let r=[];if(a&&a.vendor_id){const{data:e}=await t.from("vendor_contacts").select("id, contact_name, contact_email, contact_phone, position").eq("vendor_id",a.vendor_id).order("contact_name");if(e&&e.length>0){if(a.contact_id){const t=e.find(e=>e.id===a.contact_id),n=e.filter(e=>e.id!==a.contact_id);r=t?[t,...n]:e}else r=e;c.info("🔍 업체의 모든 담당자 로드:",{vendor_id:a.vendor_id,contact_id:a.contact_id,allContacts_count:e.length,vendorContacts:r})}}else a&&a.contact&&(r=[a.contact]);if(a){const e=dt((a.purchase_request_items||[]).sort((e,t)=>(e.line_number||999999)-(t.line_number||999999))),t=e.map(e=>({id:e.id,item_name:e.item_name,amount_value:e.amount_value,unit_price_value:e.unit_price_value,quantity:e.quantity}));c.info("🔍 [refreshModalData] DB에서 가져온 품목 데이터:",{itemsData:t}),t.forEach(e=>{0===e.amount_value&&null!=e.unit_price_value&&0!==e.unit_price_value&&c.warn("⚠️ [refreshModalData] 합계금액이 0인데 단가가 있는 품목:",{itemId:e.id,item_name:e.item_name,amount_value:e.amount_value,unit_price_value:e.unit_price_value,quantity:e.quantity,calculated_amount:(e.quantity||0)*(e.unit_price_value||0)})});const n={...a,items:e,vendor:a.vendors||null,vendor_contacts:r,contact_id:a.contact_id,contact_name:r[0]?.contact_name||a.contact?.contact_name||null};xe({...n,items:e}),Ne(n),Se(e),c.info("🔍 refreshModalData DB에서 로드 완료:",{vendor_contacts:n.vendor_contacts,vendorContacts_from_query:r,purchase_updated:!0,vendor_id:a.vendor_id,has_vendor_contacts:r&&r.length>0}),c.debug("refreshModalData - DB에서 가져온 데이터:",{vendor_id:a.vendor_id,vendor_contacts:r,purchaseData_full:n,"담당자이름":r?.[0]?.contact_name||"없음"})}}catch(t){c.error("모달 데이터 새로고침 실패",t)}},[e]),ra=t.useCallback(async()=>{Pt.current=!0;try{await na()}finally{setTimeout(()=>{Pt.current=!1},3e3)}},[na]),ia=t.useCallback(async()=>{if(!ve)return;if(!ta||!Qt)return;const e=!(ve.is_utk_checked||!1),t=e?`발주번호: ${ve.purchase_order_number}\n\nUTK 확인 처리하시겠습니까?`:`발주번호: ${ve.purchase_order_number}\n\nUTK 확인을 취소하시겠습니까?`;if(window.confirm(t))try{const t=s(),{error:a}=await t.from("purchase_requests").update({is_utk_checked:e}).eq("id",ve.id);if(a)return c.error("UTK 확인 DB 업데이트 실패",{error:a,purchaseId:ve.id}),void Y.error("UTK 확인 처리 중 오류가 발생했습니다.");xe(t=>t?{...t,is_utk_checked:e,updated_at:(new Date).toISOString()}:null),ve.id&&h(ve.id,t=>({...t,is_utk_checked:e})),Y.success(e?"UTK 확인이 완료되었습니다.":"UTK 확인이 취소되었습니다."),await ra();const n=ue?.(!0,{silent:!0});n instanceof Promise&&await n}catch(a){c.error("UTK 확인 처리 중 오류",a),Y.error("UTK 확인 처리 중 오류가 발생했습니다.")}},[ve,ta,Qt,ue,ra]);t.useEffect(()=>{if(!e||!he||!ve)return;if(be||at)return;const t=he.find(t=>t.id===e);if(t){const e=dt(t.items&&t.items.length>0?t.items:t.purchase_request_items||[]),a={...ve,...t,id:String(t.id),items:e,purchase_request_items:e};xe(a),Ne(a),Se(e.length>0?e:[])}},[he,_e,be,at]),t.useEffect(()=>{if(!a||!e||!he)return;if(be||at)return;const t=he.find(t=>t.id===e);if(t){const e=dt(t.items&&t.items.length>0?t.items:t.purchase_request_items||[]),a={...t,id:String(t.id),is_po_generated:!1,items:e,purchase_request_items:e,vendor:{id:t.vendor_id,vendor_name:t.vendor_name||"알 수 없음",is_active:!0,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()},vendor_contacts:[]};xe(a),Ne(a),Se(e.length>0?e:[])}},[a,e,he,be,at]);const[sa,ca]=t.useState(!0),oa=e?Number(e):ve?Number(ve.id):NaN,la=t.useCallback(({itemId:e,selectedDate:t,action:a,receivedQuantity:n})=>{const r=String(e),i=(new Date).toISOString(),s=t?C(t):void 0,c=e=>e?e.map(e=>String(e.id)!==r?e:"confirm"===a?{...e,is_received:!0,actual_received_date:s,received_at:i,received_quantity:void 0!==n?n:e.received_quantity}:{...e,is_received:!1,actual_received_date:void 0,received_at:void 0,received_quantity:void 0}):e;xe(e=>{if(!e)return e;const t=c(e.items)||[],a=c(e.purchase_request_items)||[],n=t.length,r=t.filter(e=>e.is_received).length,s=n>0&&r===n;return{...e,items:t,purchase_request_items:a,is_received:s,received_at:s?e.received_at||i:void 0,updated_at:(new Date).toISOString()}}),Ne(e=>{if(!e)return e;const t=c(e.items)||[],a=c(e.purchase_request_items)||[];return{...e,items:t,purchase_request_items:a}}),Se(e=>e&&0!==e.length?e.map(e=>e.id&&String(e.id)===r?"confirm"===a?{...e,is_received:!0,actual_received_date:s,received_at:i,received_quantity:void 0!==n?n:e.received_quantity}:{...e,is_received:!1,actual_received_date:void 0,received_at:void 0,received_quantity:void 0}:e):e),Number.isNaN(oa)||me?.(oa,e=>{const t=c(e.items)||e.items||[],a=c(e.purchase_request_items)||e.purchase_request_items||[],n=t.length||e.items?.length||0,r=t.filter(e=>e.is_received).length,s=n>0&&r===n;return{...e,items:t,purchase_request_items:a,is_received:s,received_at:s?e.received_at||i:void 0,updated_at:(new Date).toISOString()}})},[me,oa]),da=t.useCallback(({itemId:e,selectedDate:t,action:a})=>{const n=String(e),r=t?C(t):void 0;let i=!1,o=null;if(xe(e=>{if(!e)return e;const t=(e.items||[]).map(e=>String(e.id)!==n?e:"confirm"===a?{...e,is_statement_received:!0,statement_received_date:r,accounting_received_date:r,statement_received_by_name:De}:{...e,is_statement_received:!1,statement_received_date:null,accounting_received_date:null,statement_received_by_name:null});return i=t.length>0&&t.every(e=>e.is_statement_received),o=i?r||e.statement_received_at||(new Date).toISOString():null,{...e,items:t,is_statement_received:i,statement_received_at:o}}),Ne(e=>{if(!e)return e;const t=(e.items||[]).map(e=>String(e.id)!==n?e:"confirm"===a?{...e,is_statement_received:!0,statement_received_date:r,accounting_received_date:r,statement_received_by_name:De}:{...e,is_statement_received:!1,statement_received_date:null,accounting_received_date:null,statement_received_by_name:null});return{...e,items:t,is_statement_received:i,statement_received_at:o}}),Se(e=>e?e.map(e=>String(e.id)!==n?e:"confirm"===a?{...e,is_statement_received:!0,statement_received_date:r,accounting_received_date:r,statement_received_by_name:De}:{...e,is_statement_received:!1,statement_received_date:null,accounting_received_date:null,statement_received_by_name:null}):e),Number.isNaN(oa)||me?.(oa,e=>{const t=(e.items||[]).map(e=>String(e.id)!==n?e:"confirm"===a?{...e,is_statement_received:!0,statement_received_date:r,statement_received_by_name:De}:{...e,is_statement_received:!1,statement_received_date:null,statement_received_by_name:null}),i=t.length>0&&t.every(e=>e.is_statement_received);return{...e,items:t,is_statement_received:i}}),ve&&void 0!==i){s().from("purchase_requests").update({is_statement_received:i,statement_received_at:o}).eq("id",ve.id).then(({error:e})=>{e&&c.error("거래명세서 확인 purchase_requests 업데이트 실패",e)})}},[De,me,oa,ve]),ua=t.useCallback(()=>{Pt.current=!0,c.debug("[PurchaseDetailModal] 업데이트 시작 - Realtime 이벤트 무시 활성화")},[]),ma=Ba({config:{field:"statement_received",confirmMessage:{confirm:"거래명세서 확인을 처리하시겠습니까?",cancel:"거래명세서 확인을 취소하시겠습니까?"},successMessage:{confirm:"거래명세서 확인이 완료되었습니다.",cancel:"거래명세서 확인이 취소되었습니다."},completedText:"✓ 완료",waitingText:"대기"},currentUserName:De,canPerformAction:ta,purchaseId:ve?.id,onBeforeUpdate:ua,onUpdate:ra,onOptimisticUpdate:da}),pa=Ba({config:{field:"actual_received",confirmMessage:{confirm:"실제 입고 처리를 진행하시겠습니까?",cancel:"실제 입고 처리를 취소하시겠습니까?"},successMessage:{confirm:"실제 입고 처리가 완료되었습니다.",cancel:"실제 입고 처리가 취소되었습니다."},completedText:"입고완료",waitingText:"입고대기"},currentUserName:De,canPerformAction:aa,purchaseId:ve?.id,onBeforeUpdate:ua,onUpdate:ra,onOptimisticUpdate:la}),ha=Bt.includes("middle_manager")||Bt.includes("app_admin")||Bt.includes("ceo"),_a=Bt.includes("final_approver")||Bt.includes("app_admin")||Bt.includes("ceo"),ga="inline-flex items-center gap-1 business-radius-badge !h-auto !min-h-0 !px-2.5 !py-0.5 badge-text leading-tight",fa="inline-flex items-center gap-1 business-radius-badge px-2.5 py-0.5 badge-text leading-tight";t.useEffect(()=>{if(e&&a){const t=_(e);if(t){const e={...t,id:String(t.id),is_po_generated:!1,vendor:t.vendor||(t.vendor_id?{id:t.vendor_id,vendor_name:t.vendor_name||"알 수 없음",is_active:!0,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}:null),vendor_contacts:t.vendor_contacts||[]};xe(e),Ne(e),Se(t.items||[])}else ja(e.toString());ye(!1),va(e)}},[e,a]);const va=async e=>{try{const t=await Ga.getStatementsByPurchaseId(e);t.success&&t.data&&it(t.data)}catch(t){it([])}},xa=t.useCallback(()=>{const e=ve?.items&&ve.items.length>0?ve.items:ve?.purchase_request_items&&ve.purchase_request_items.length>0?ve.purchase_request_items:[];if(0===e.length)return[];const t=[{key:"line_number",minWidth:32,maxWidth:32,baseWidth:32,isFixed:!0},{key:"item_name",minWidth:80,maxWidth:500,baseWidth:80},{key:"specification",minWidth:80,maxWidth:200,baseWidth:150,isFixed:!1},{key:"quantity",minWidth:70,maxWidth:120,baseWidth:70},{key:"unit_price",minWidth:90,maxWidth:150,baseWidth:90},{key:"total_price",minWidth:100,maxWidth:180,baseWidth:100}];"발주"===ve?.payment_category&&t.push({key:"tax_amount",minWidth:80,maxWidth:150,baseWidth:80}),t.push({key:"link",minWidth:60,maxWidth:80,baseWidth:60,isFixed:!0}),t.push({key:"remarks",minWidth:150,maxWidth:150,baseWidth:150,isFixed:!0}),"pending"!==D&&t.push({key:"status",minWidth:70,maxWidth:100,baseWidth:70}),"receipt"===D&&(t.push({key:"actual_receipt_date",minWidth:100,maxWidth:160,baseWidth:100,isFixed:!1}),Vt&&t.push({key:"transaction_confirm",minWidth:85,maxWidth:120,baseWidth:85,isFixed:!1},{key:"accounting_date",minWidth:70,maxWidth:70,baseWidth:70,isFixed:!0})),"done"!==D||"발주"!==ve?.payment_category&&!M||t.push({key:"transaction_confirm",minWidth:85,maxWidth:120,baseWidth:85,isFixed:!1},{key:"accounting_date",minWidth:70,maxWidth:70,baseWidth:70,isFixed:!0},{key:"expenditure_info",minWidth:90,maxWidth:150,baseWidth:90,isFixed:!1});const a=t.map((t,a)=>{let n=4;const r=(()=>{const e="purchase"===D?"구매상태":"receipt"===D||"done"===D?"입고상태":"상태",t="receipt"===D||"done"===D?"요청/실제 입고수량":"요청수량",a="pending"===D?["#","품목명","규격",t,"단가","합계","발주"===ve?.payment_category?"세액":null,"비고"].filter(e=>null!==e):["#","품목명","규격",t,"단가","합계","발주"===ve?.payment_category?"세액":null,"비고",e].filter(e=>null!==e);if("receipt"===D){const e=[...a,"실제입고일"];return Vt&&e.push("거래명세서 확인","회계상 입고일"),e}if("done"===D){const e=[...a];return Vt&&(e.push("거래명세서 확인","회계상 입고일"),Xt&&e.push("지출정보")),e}return a})();if(r[a]&&(n=Math.max(n,r[a].length)),e.forEach(e=>{let a="";switch(t.key){case"line_number":a=e.line_number?.toString()||"";break;case"item_name":a=e.item_name||"";break;case"specification":a=e.specification||"";break;case"quantity":if("receipt"===D||"done"===D){const t=e.quantity||0,n=e.received_quantity??0;a=t>=100||n>=100?`${t}`:`${t}/${n}`}else a=e.quantity?.toString()||"";break;case"unit_price":a=null!=e.unit_price_value?e.unit_price_value.toLocaleString():"";break;case"total_price":a=null!=e.amount_value?e.amount_value.toLocaleString():null!=e.quantity&&null!=e.unit_price_value?(Number(e.quantity)*Number(e.unit_price_value)).toLocaleString():"";break;case"tax_amount":a=null!=e.tax_amount_value?e.tax_amount_value.toLocaleString():"";break;case"remarks":a=e.remark||"";break;case"status":a=ya(e)||"";break;case"actual_receipt_date":a=e.actual_received_date?I(e.actual_received_date):"";break;case"transaction_confirm":a=e.is_statement_received?"확인완료":"미확인";break;case"accounting_date":a=e.accounting_received_date?I(e.accounting_received_date):"";break;case"expenditure_info":a=e.expenditure_date&&null!==e.expenditure_amount&&void 0!==e.expenditure_amount?"2025. 11. 25.":"지출입력"}const r=a.split("").reduce((e,t)=>e+(/[가-힣]/.test(t)?1.5:1),0);n=Math.max(n,Math.ceil(r))}),t.isFixed)return t.baseWidth;let i=Math.max(t.minWidth,Math.min(t.maxWidth,7*n+20));return"expenditure_info"===t.key&&(i=110),i});return Re(a),a},[ve,D,Vt,Xt]),ya=e=>"purchase"===D?e.is_payment_completed?"구매완료":"구매요청":"receipt"===D?e.is_received?"입고":"입고대기":e.is_payment_completed?"구매완료":"구매요청";function wa(){if($e.length>0){return $e.map(e=>`${e}px`).join(" ")}const e=["32px","minmax(80px, 1fr)","200px","70px","90px","100px"];if("발주"===ve?.payment_category&&e.push("100px"),e.push("60px"),e.push("150px"),"pending"!==D&&e.push("80px"),"receipt"===D){const t=[...e,"100px"];return Vt&&t.push("100px","80px"),t.join(" ")}if("done"===D){const t=[...e];return Vt&&(t.push("100px","80px"),Xt&&t.push("110px")),t.join(" ")}return e.join(" ")}t.useEffect(()=>{const e=ve?.items&&ve.items.length>0||ve?.purchase_request_items&&ve.purchase_request_items.length>0;ve&&e&&!be&&requestAnimationFrame(()=>{xa()})},[ve,be,D,xa]);const Na=e=>{if(e&&!be){Ne(ve);const e=[...At||[]].sort((e,t)=>(e?.line_number??999999)-(t?.line_number??999999));Se(e),ke([]),xa()}ye(e)},ja=async e=>{try{const t=_(e);if(t){const e={...t,id:String(t.id),is_po_generated:!1,vendor:t.vendor||(t.vendor_id?{id:t.vendor_id,vendor_name:t.vendor_name||"알 수 없음",is_active:!0,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}:null),vendor_contacts:t.vendor_contacts||[]};return xe({...e,items:dt(t.items||e.items||[])}),Ne(e),void Se(dt(t.items||[]))}fe(!0);const a=s(),{data:n,error:r}=await a.from("purchase_requests").select("\n          *,\n          vendors:vendor_id(id, vendor_name, is_active),\n          purchase_request_items(*),\n          contact:contact_id(id, contact_name, contact_email, contact_phone, position)\n        ").eq("id",e).single();if(r)throw r;let i=[];if(n&&n.vendor_id){const{data:e}=await a.from("vendor_contacts").select("id, contact_name, contact_email, contact_phone, position").eq("vendor_id",n.vendor_id).order("contact_name");if(e&&e.length>0){if(n.contact_id){const t=e.find(e=>e.id===n.contact_id),a=e.filter(e=>e.id!==n.contact_id);i=t?[t,...a]:e}else i=e;c.info("🔍 loadPurchaseDetail - 업체의 모든 담당자 로드:",{vendor_id:n.vendor_id,contact_id:n.contact_id,allContacts_count:e.length,vendorContacts:i})}}else n&&n.contact&&(i=[n.contact]);if(n){const e=dt((n.purchase_request_items||[]).sort((e,t)=>(e.line_number||999999)-(t.line_number||999999))),t={...n,items:e,vendor:n.vendors||null,vendor_contacts:i,contact_id:n.contact_id,contact_name:i[0]?.contact_name||n.contact?.contact_name||null};xe({...t,items:e}),Ne(t),Se(e)}}catch(t){c.error("[PurchaseDetailModal] 발주 상세 로드 실패:",t),Y.error("발주 상세 정보를 불러오는데 실패했습니다.")}finally{fe(!1)}},qa=(e,t=0)=>{if(null==e)return t;if("string"==typeof e){const a=e.trim();if(""===a)return t;const n=a.replace(/,/g,""),r=Number(n);return Number.isNaN(r)?t:r}const a=Number(e);return Number.isNaN(a)?t:a},ka=e=>new Intl.NumberFormat("ko-KR").format(e),Ca=e=>"USD"===e?"USD":"KRW",Ia=()=>Ca(be?we?.currency:ve?.currency),Ma=e=>Ca(e?.unit_price_currency??e?.amount_currency??e?.tax_amount_currency??Ia()),$a=(e,t)=>`${(e=>"USD"===Ca(e)?"$":"₩")(t)}${ka(e)}`,Ea=(e,t)=>Promise.race([Promise.resolve(e),new Promise((e,a)=>setTimeout(()=>a(new Error(`작업이 ${t}ms 내에 완료되지 않았습니다.`)),t))]),Ta=(e,t,a)=>{const n=[...je];if("quantity"===t||"unit_price_value"===t){if(n[e]?.is_amount_manual)return n[e]={...n[e],[t]:a},void Se(n);const r="quantity"===t?a:n[e].quantity,i="unit_price_value"===t?a:n[e].unit_price_value;if(null!=i&&void 0!==i&&""!==i&&0!==i&&(null!=r&&void 0!==r&&0!==r)){const s=(r||0)*(i||0),c="발주"===ve?.payment_category?Math.round(.1*s):0;n[e]={...n[e],[t]:a,amount_value:s,tax_amount_value:c}}else n[e]={...n[e],[t]:a}}else if("amount_value"===t){let t=0;if(""!==a&&null!=a&&void 0!==a){const e=Number(a);Number.isNaN(e)||(t=e)}const r="발주"===ve?.payment_category?Math.round(.1*t):0;n[e]={...n[e],is_amount_manual:!0,amount_value:t,tax_amount_value:r}}else n[e]={...n[e],[t]:a};Se(n)},Oa=async(e,t)=>{if(!Yt)return c.warn("[handlePaymentToggle] 권한 없음",{canPurchase:Yt,currentUserRoles:u}),void Y.error("구매완료 처리 권한이 없습니다.");const a=String(e),n="number"==typeof e?e:Number(e);if(Number.isNaN(n))return c.error("[handlePaymentToggle] 잘못된 ID",{itemId:e,numericId:n}),void Y.error("유효하지 않은 항목 ID 입니다.");if(!ve)return;const r=ve.items&&ve.items.length>0?ve.items:[],i=ve.purchase_request_items&&ve.purchase_request_items.length>0?ve.purchase_request_items:[],s=(r.length>0?r:i).find(e=>String(e.id)===a);if(!s)return;const o=`품명: ${s.item_name}\n규격: ${s.specification||"미입력"}\n수량: ${s.quantity?.toLocaleString()||0}${s.unit||""}\n단가: ₩${s.unit_price_value?.toLocaleString()||0}\n합계: ₩${s.amount_value?.toLocaleString()||0}`,l=t?`다음 품목을 구매완료 처리하시겠습니까?\n\n${o}`:`다음 품목의 구매완료를 취소하시겠습니까?\n\n${o}`;if(window.confirm(l))try{const{error:e}=await zt.from("purchase_request_items").update({is_payment_completed:t,payment_completed_at:t?(new Date).toISOString():null}).eq("id",n);if(e)throw e;if(ve){(t?y(ve.id,n):q(ve.id,n))||c.warn("[PurchaseDetailModal] 메모리 캐시 품목 업데이트 실패",{purchaseId:ve.id,itemId:n,isCompleted:t})}if(xe(e=>{if(!e)return null;const n=e.items&&e.items.length>0?e.items:[],r=e.purchase_request_items&&e.purchase_request_items.length>0?e.purchase_request_items:[],i=(n.length>0?n:r).map(e=>String(e.id)===a?{...e,is_payment_completed:t,payment_completed_at:t?(new Date).toISOString():null}:e);return{...e,items:e.items?i:e.items,purchase_request_items:e.purchase_request_items?i:e.purchase_request_items}}),ve){const e=Number(ve.id);Number.isNaN(e)||me?.(e,e=>{const n=(e.items||[]).map(e=>String(e.id)===a?{...e,is_payment_completed:t}:e),r=n.length||e.items?.length||0,i=n.filter(e=>e.is_payment_completed).length,s=r>0&&i===r;return{...e,items:n,is_payment_completed:s,payment_completed_at:s?(new Date).toISOString():null,payment_completed_by_name:s&&De||e.payment_completed_by_name}})}Y.success(t?"구매완료 처리되었습니다.":"구매완료가 취소되었습니다."),await ra();const r=ue?.(!0,{silent:!0});r instanceof Promise&&await r}catch(d){Y.error("구매완료 처리 중 오류가 발생했습니다.")}},Pa=async(e,t,a)=>{if(Pt.current=!0,!Gt)return Y.error("입고 처리 권한이 없습니다."),void(Pt.current=!1);const n=String(e),r="number"==typeof e?e:Number(e);if(Number.isNaN(r))return void Y.error("유효하지 않은 항목 ID 입니다.");const i=ve?.items?.find(e=>String(e.id)===n)||ve?.purchase_request_items?.find(e=>String(e.id)===n),s=i?.quantity||0,l=void 0!==a?a:s,d=(i?.received_quantity||0)+l,u=d>s,m=u?d:s,p=d>=m,h=0===d?"pending":p?"received":"partial",_=i?.receipt_history||[],g={seq:_.length+1,qty:l,date:C(t),by:De||"알수없음"},f=[..._,g],v=ve?Number(ve.id):NaN,x=u?{quantity:m}:{};try{const{error:e}=await zt.from("purchase_request_items").update({is_received:p,delivery_status:h,received_at:(new Date).toISOString(),actual_received_date:C(t),received_quantity:d,receipt_history:f,...u?{quantity:m}:{}}).eq("id",r);if(e)throw e;if(ve){o(ve.id,r,C(t),d)||c.warn("[PurchaseDetailModal] 메모리 캐시 개별 품목 입고완료 업데이트 실패",{purchaseId:ve.id,itemId:r})}xe(e=>{if(!e)return null;const a=e.items?.map(e=>String(e.id)===n?{...e,...x,is_received:p,delivery_status:h,received_at:(new Date).toISOString(),actual_received_date:C(t),received_quantity:d,receipt_history:f}:e),r=e.purchase_request_items?.map(e=>String(e.id)===n?{...e,...x,is_received:p,delivery_status:h,received_at:(new Date).toISOString(),actual_received_date:C(t),received_quantity:d,receipt_history:f}:e);return{...e,items:a,purchase_request_items:r,updated_at:(new Date).toISOString()}}),Number.isNaN(v)||me?.(v,e=>{const a=(e.items||[]).map(e=>String(e.id)===n?{...e,...x,is_received:p,delivery_status:h,actual_received_date:C(t),received_quantity:d,receipt_history:f}:e),r=a.length||e.items?.length||0,i=a.filter(e=>e.is_received).length,s=r>0&&i===r;return{...e,items:a,is_received:s,received_at:s?(new Date).toISOString():e.received_at}});const a=ve?.items?.find(e=>String(e.id)===n);Y.success(`"${a?.item_name}" 품목이 입고완료 처리되었습니다.`),await ra();const i=ue?.(!0,{silent:!0});i instanceof Promise&&await i}catch(b){Y.error("입고완료 처리 중 오류가 발생했습니다.")}},Aa=async e=>{if(!ve)return;const t="middle"===e?"1차 승인":"최종 승인",a=`발주번호: ${ve.purchase_order_number}\n\n${t}을 진행하시겠습니까?`;if(window.confirm(a))try{const t="middle"===e?{middle_manager_status:"approved"}:{final_manager_status:"approved"},{error:a}=await zt.from("purchase_requests").update(t).eq("id",ve.id);if(a)throw a;if(xe("middle"===e?e=>e?{...e,middle_manager_status:"approved"}:null:e=>e?{...e,final_manager_status:"approved"}:null),h(String(ve.id),t=>({...t,..."middle"===e?{middle_manager_status:"approved"}:{final_manager_status:"approved"}})),ve&&me){const t=Number(ve.id);Number.isNaN(t)||me(t,t=>"middle"===e?{...t,middle_manager_status:"approved"}:{...t,final_manager_status:"approved"})}Y.success(("middle"===e?"중간":"최종")+" 승인이 완료되었습니다."),await ra();const n=ue?.(!0,{silent:!0});n instanceof Promise&&await n}catch(n){Y.error("승인 처리 중 오류가 발생했습니다.")}},Fa=async(e,t,a)=>{if(!ve||!ta)return void Y.error("지출 정보 입력 권한이 없습니다.");const n=String(e),r="number"==typeof e?e:Number(e);if(Number.isNaN(r))return void c.error("유효하지 않은 itemId",{itemId:e});const i=ve.items?.find(e=>String(e.id)===n);if(!i)return;const s=ve?Number(ve.id):NaN;try{Number.isNaN(s)||me?.(s,e=>{const r=(e.items||[]).map(e=>String(e.id)===n?{...e,expenditure_date:C(t),expenditure_amount:a}:e);return{...e,items:r}}),xe(e=>{if(!e)return null;const r=(e.items||e.purchase_request_items||[]).map(e=>String(e.id)===n?{...e,expenditure_date:C(t),expenditure_amount:a}:e),i=r.reduce((e,t)=>e+(t.expenditure_amount||0),0);return{...e,items:r,purchase_request_items:r,total_expenditure_amount:i,updated_at:(new Date).toISOString()}});const{error:e}=await zt.from("purchase_request_items").update({expenditure_date:C(t),expenditure_amount:a}).eq("id",r);if(e)throw c.error("지출 정보 DB 업데이트 실패",{error:e,itemId:r}),e;const o=(ve.items||ve.purchase_request_items||[]).reduce((e,t)=>String(t.id)===n?e+a:e+(t.expenditure_amount||0),0);if(await zt.from("purchase_requests").update({total_expenditure_amount:o}).eq("id",s),ve?.id){k(ve.id,r,C(t),a)||c.warn("[PurchaseDetailModal] 메모리 캐시 지출 정보 업데이트 실패",{purchaseId:ve.id,itemId:r})}Y.success(`"${i.item_name}" 품목의 지출 정보가 저장되었습니다.`),await ra();const l=ue?.(!0,{silent:!0});l instanceof Promise&&await l}catch(o){c.error("지출 정보 입력 중 오류",o),Y.error("지출 정보 입력 중 오류가 발생했습니다.")}},La=(e,t,a,n)=>{const s=n||e?.stableKey||ut(e,t),c={className:`px-2 sm:px-3 py-1 border-b border-gray-50 hover:bg-gray-50/50 relative overflow-visible w-fit ${be?"pl-7 sm:pl-8":""} ${a?.isDragging?"shadow-lg ring-2 ring-blue-200 bg-white":""}`,key:s};return a?.setNodeRef&&(c.ref=a.setNodeRef),a?.style&&(c.style=a.style),r.jsxs("div",{...c,children:[be&&a&&r.jsx("button",{className:"absolute left-1 top-2 sm:top-3 text-gray-400 hover:text-gray-600 p-1 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-200",...a.attributes,...a.listeners,"aria-label":"드래그하여 품목 순서 변경",children:r.jsx(ie,{className:"w-3.5 h-3.5"})}),r.jsxs("div",{className:"hidden sm:grid items-center gap-1 overflow-visible w-fit",style:{gridTemplateColumns:wa()},children:[r.jsx("div",{className:"flex justify-center items-center text-[11px] text-gray-500 font-medium -ml-2 sm:-ml-3",children:e.line_number||t+1}),r.jsx("div",{className:"min-w-0 relative overflow-visible flex items-center",children:be?r.jsx(T,{value:e.item_name,onChange:e=>Ta(t,"item_name",e.target.value),onFocus:()=>Te(`item_name_${t}`),onBlur:()=>Te(null),className:"modal-label border-gray-200 rounded-lg w-full !px-1.5 !py-0.5 !text-[10px] focus:border-blue-400 transition-all duration-200 "+(Ee===`item_name_${t}`?"!h-auto !min-h-[20px] !absolute !z-[9999] !bg-white !shadow-lg !left-0 !right-0 !-translate-y-1/2 !top-1/2 !whitespace-normal":"!h-5 !truncate"),placeholder:"품목명"}):r.jsx("div",{className:"modal-value",style:{whiteSpace:"normal",wordBreak:"break-all",overflowWrap:"break-word",hyphens:"none",WebkitHyphens:"none",MozHyphens:"none",msHyphens:"none",lineHeight:"1.4",maxHeight:"2.8em",overflow:"hidden",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical"},title:e.item_name||"품목명 없음",children:e.item_name||"품목명 없음"})}),r.jsx("div",{className:"min-w-0 relative overflow-visible flex items-center w-full",children:be?r.jsx(T,{value:e.specification,onChange:e=>Ta(t,"specification",e.target.value),onFocus:()=>Te(`specification_${t}`),onBlur:()=>Te(null),className:"modal-label border-gray-200 rounded-lg w-full !px-1.5 !py-0.5 !text-[10px] focus:border-blue-400 transition-all duration-200 "+(Ee===`specification_${t}`?"!h-auto !min-h-[20px] !absolute !z-[9999] !bg-white !shadow-lg !left-0 !right-0 !-translate-y-1/2 !top-1/2 !whitespace-normal":"!h-5 !truncate"),placeholder:"규격"}):r.jsx("div",{className:"text-[11px] text-gray-600 font-medium",style:{whiteSpace:"normal",wordBreak:"break-all",overflowWrap:"break-word",hyphens:"none",WebkitHyphens:"none",MozHyphens:"none",msHyphens:"none",lineHeight:"1.4",maxHeight:"2.8em",overflow:"hidden",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical"},title:e.specification||"-",children:e.specification||"-"})}),r.jsx("div",{className:"text-center min-w-0 flex items-center justify-center",children:be?"receipt"===D||"done"===D?r.jsxs("div",{className:"flex flex-col items-center gap-0.5 w-full",children:[r.jsx(T,{type:"number",value:e.quantity,onChange:e=>Ta(t,"quantity",Number(e.target.value)),className:"border-gray-200 rounded-lg text-center w-full !h-5 !px-1.5 !py-0.5 !text-[9px] font-normal text-gray-600 focus:border-blue-400",placeholder:"요청수량",max:"99999",disabled:Kt&&!Ut}),r.jsxs("div",{className:"flex items-center gap-0.5 w-full",children:[r.jsx("span",{className:"text-[9px] text-gray-500",children:"/"}),r.jsx(T,{type:"number",value:e.received_quantity??"",onChange:e=>Ta(t,"received_quantity",e.target.value?Number(e.target.value):null),className:"border-gray-200 rounded-lg text-center flex-1 !h-5 !px-1.5 !py-0.5 !text-[9px] font-normal text-gray-600 focus:border-blue-400",placeholder:"실제입고",max:"99999",disabled:Kt&&!Ut})]})]}):r.jsx(T,{type:"number",value:e.quantity,onChange:e=>Ta(t,"quantity",Number(e.target.value)),className:"border-gray-200 rounded-lg text-center w-full !h-5 !px-1.5 !py-0.5 !text-[9px] font-normal text-gray-600 focus:border-blue-400",placeholder:"수량",max:"99999",disabled:Kt&&!Ut}):"receipt"===D||"done"===D?(()=>{const t=e.quantity||0,a=e.received_quantity??0,n=a>0;return t>=100||a>=100?r.jsxs("div",{className:"flex flex-col items-center leading-tight",children:[r.jsx("div",{className:"modal-subtitle "+(n?"text-gray-400":""),children:t}),r.jsxs("div",{className:"modal-subtitle "+(n?"":"text-gray-400"),children:["/",a]})]}):r.jsxs("span",{className:"modal-subtitle",children:[r.jsx("span",{className:n?"text-gray-400":"",children:t}),r.jsxs("span",{className:n?"":"text-gray-400",children:["/",a]})]})})():r.jsx("span",{className:"modal-subtitle",children:e.quantity||0})}),r.jsx("div",{className:"text-right min-w-0 flex items-center justify-end",children:be?r.jsx(T,{type:"number",value:e.unit_price_value??0,onChange:e=>Ta(t,"unit_price_value",Number(e.target.value)),onWheel:e=>e.currentTarget.blur(),className:"border-gray-200 rounded-lg text-right w-full !h-5 !px-1.5 !py-0.5 !text-[9px] font-normal text-gray-600 focus:border-blue-400",placeholder:"단가",max:"100000000000"}):r.jsx("span",{className:"modal-subtitle",children:"done"!==D||Qt?$a(e.unit_price_value??0,Ma(e)):"-"})}),r.jsx("div",{className:"text-right min-w-0 flex items-center justify-end",children:be?r.jsx(T,{type:"number",value:e.amount_value||0,onChange:e=>Ta(t,"amount_value",Number(e.target.value)),onWheel:e=>e.currentTarget.blur(),className:"border-gray-200 rounded-lg w-full !h-6 !px-1.5 !py-0.5 !text-[10px] font-normal text-gray-600 focus:border-blue-400 text-right",placeholder:"합계"}):r.jsx("span",{className:"modal-value",children:"done"!==D||Qt?$a(e.amount_value||0,Ma(e)):"-"})}),"발주"===ve?.payment_category&&r.jsx("div",{className:"text-right min-w-0 flex items-center justify-end",children:r.jsx("span",{className:be?"modal-subtitle":"modal-value",children:"done"!==D||Qt?$a(e.tax_amount_value||0,Ma(e)):"-"})}),r.jsx("div",{className:"text-center min-w-0 flex items-center justify-center",children:be?r.jsx(T,{value:e.link||"",onChange:e=>Ta(t,"link",e.target.value),className:"border-gray-200 rounded-lg text-center w-full !h-5 !px-1.5 !py-0.5 !text-[9px] font-normal text-gray-600 focus:border-blue-400",placeholder:"링크(URL)"}):e.link?r.jsx("a",{href:e.link,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:text-blue-800 underline text-[11px]",onClick:e=>e.stopPropagation(),children:"링크"}):r.jsx("span",{className:"text-gray-400 text-[11px]",children:"-"})}),r.jsx("div",{className:"min-w-0 flex justify-center items-center text-center relative overflow-visible",style:{width:"150px",maxWidth:"150px",minWidth:"150px"},children:be?r.jsx(T,{value:e.remark||"",disabled:!Ut&&!Kt,onChange:e=>Ta(t,"remark",e.target.value),onFocus:()=>Te(`remark_${t}`),onBlur:()=>Te(null),className:"modal-label border-gray-200 rounded-lg text-center w-full !px-1.5 !py-0.5 !text-[10px] focus:border-blue-400 transition-all duration-200 "+(Ee===`remark_${t}`?"!h-auto !min-h-[20px] !absolute !z-[9999] !bg-white !shadow-lg !left-0 !right-0 !-translate-y-1/2 !top-1/2 !whitespace-normal !text-left":"!h-5 !truncate"),placeholder:"비고"}):r.jsx("div",{className:"text-[11px] text-gray-600 font-medium",style:{width:"150px",maxWidth:"150px",minWidth:"150px",boxSizing:"border-box",whiteSpace:"normal",wordBreak:"break-all",overflowWrap:"break-word",hyphens:"none",WebkitHyphens:"none",MozHyphens:"none",msHyphens:"none",lineHeight:"1.4",maxHeight:"2.8em",overflow:"hidden",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical"},title:e.remark||"-",children:e.remark||"-"})}),"pending"!==D&&r.jsx("div",{className:"text-center flex justify-center items-center",children:be?r.jsx(i,{size:"sm",variant:"ghost",onClick:()=>(e=>{const t=je[e];t.id&&ke([...qe,t.id]);const a=je.filter((t,a)=>a!==e).sort((e,t)=>(e.line_number||999999)-(t.line_number||999999)).map((e,t)=>({...e,line_number:t+1,stableKey:e.stableKey??lt(e,t)}));Se(a)})(t),className:"text-red-600 hover:bg-red-50 rounded-lg p-1 h-6 w-6",disabled:Kt&&!Ut,children:r.jsx(te,{className:"w-3 h-3"})}):r.jsxs(r.Fragment,{children:["purchase"===D&&r.jsx("div",{className:"flex flex-col items-center gap-1",children:r.jsx("div",{className:"flex justify-center",children:Yt?r.jsx("button",{onClick:()=>Oa(e.id,!e.is_payment_completed),className:""+(e.is_payment_completed?"button-toggle-active bg-orange-500 hover:bg-orange-600 text-white":"button-toggle-inactive"),children:e.is_payment_completed?"구매완료":"구매대기"}):r.jsx("span",{className:""+(e.is_payment_completed?"button-toggle-active bg-orange-500 text-white":"button-waiting-inactive"),children:e.is_payment_completed?"구매완료":"구매대기"})})}),"receipt"===D&&r.jsx("div",{className:"flex justify-center",children:Gt?pa.isCompleted(e)?r.jsx("button",{onClick:()=>{pa.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-action-primary",children:pa.config.completedText}):pa.isPartiallyReceived(e)?r.jsx(za,{onConfirm:(t,a)=>{Pa(e.id,t,a)},placeholder:"추가 입고수량을 입력하세요",align:"center",side:"bottom",maxQuantity:pa.getRemainingQuantity(e),quantityInfoText:`미입고: ${pa.getRemainingQuantity(e)}개`,allowOverMaxQuantity:!0,children:r.jsx("button",{className:"button-base bg-blue-300 hover:bg-blue-400 text-white",children:"부분입고"})}):r.jsx(za,{onConfirm:(t,a)=>{Pa(e.id,t,a)},placeholder:"날짜와 실제입고수량을 입력하세요",align:"center",side:"bottom",defaultQuantity:e.received_quantity??void 0,maxQuantity:e.quantity,allowOverMaxQuantity:!0,children:r.jsx("button",{className:"button-toggle-inactive",children:pa.config.waitingText})}):r.jsx("span",{className:""+(pa.isCompleted(e)?"button-action-primary":pa.isPartiallyReceived(e)?"button-base bg-blue-300 text-white":"button-waiting-inactive"),children:pa.isCompleted(e)?pa.config.completedText:pa.isPartiallyReceived(e)?"부분입고":pa.config.waitingText})}),"done"===D&&r.jsx("div",{className:"flex justify-center",children:Gt?pa.isCompleted(e)?r.jsx("button",{onClick:()=>{pa.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-base bg-blue-500 hover:bg-blue-600 text-white",children:pa.config.completedText}):pa.isPartiallyReceived(e)?r.jsx(za,{onConfirm:(t,a)=>{Pa(e.id,t,a)},placeholder:"추가 입고수량을 입력하세요",align:"center",side:"bottom",maxQuantity:pa.getRemainingQuantity(e),quantityInfoText:`미입고: ${pa.getRemainingQuantity(e)}개`,allowOverMaxQuantity:!0,children:r.jsx("button",{className:"button-base bg-blue-300 hover:bg-blue-400 text-white",children:"부분입고"})}):r.jsx($,{onDateSelect:t=>{pa.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"실제 입고된 날짜를 선택하세요",align:"center",side:"bottom",children:r.jsx("button",{className:"button-base border border-gray-300 text-gray-600 bg-white hover:bg-gray-50",children:pa.config.waitingText})}):r.jsx("span",{className:"button-base "+(pa.isCompleted(e)?"bg-blue-500 hover:bg-blue-600 text-white":pa.isPartiallyReceived(e)?"bg-blue-300 text-white":"border border-gray-300 text-gray-600 bg-white hover:bg-gray-50"),children:pa.isCompleted(e)?"입고완료":pa.isPartiallyReceived(e)?"부분입고":"입고대기"})}),"purchase"!==D&&"receipt"!==D&&"done"!==D&&r.jsx("div",{className:"flex justify-center",children:r.jsx("span",{className:"badge-text",children:"-"})})]})}),"receipt"===D&&r.jsx("div",{className:"text-center flex justify-center items-center pl-2",children:pa.getCompletedDate(e)?r.jsx("div",{className:"modal-subtitle text-green-700",children:new Date(pa.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})}):r.jsx("span",{className:"modal-subtitle text-gray-400",children:"-"})}),Vt&&r.jsx("div",{className:"text-center flex justify-center items-center",children:ta?ma.isCompleted(e)?r.jsx("button",{onClick:()=>{ma.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-action-primary hover:bg-green-600",title:"클릭하여 거래명세서 확인 취소",children:ma.config.completedText}):r.jsx($,{onDateSelect:t=>{ma.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"회계상 입고일을 선택하세요",align:"center",side:"bottom",children:r.jsx("button",{className:"button-toggle-inactive",onClick:()=>{},children:ma.config.waitingText})}):r.jsx("span",{className:""+(ma.isCompleted(e)?"button-action-primary":"button-waiting-inactive"),children:ma.isCompleted(e)?ma.config.completedText:ma.config.waitingText})}),Vt&&r.jsx("div",{className:"text-center flex justify-center items-center",children:e.accounting_received_date?r.jsx("div",{className:"modal-subtitle text-blue-700",children:new Date(e.accounting_received_date).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})}):r.jsx("span",{className:"modal-subtitle text-gray-400",children:"-"})}),Xt&&r.jsx("div",{className:"text-center flex justify-center items-center",children:(()=>{const t=!!e.expenditure_date,a=null!==e.expenditure_amount&&void 0!==e.expenditure_amount;return ta?t?r.jsxs("div",{className:"w-full px-1 leading-none",children:[r.jsx("div",{className:"text-blue-700 text-[9px] leading-[1.1] font-normal",children:(()=>{const t=new Date(e.expenditure_date);return`${t.getFullYear().toString().slice(-2)}.${(t.getMonth()+1).toString().padStart(2,"0")}.${t.getDate().toString().padStart(2,"0")}`})()}),r.jsx("div",{className:"text-gray-700 text-[9px] leading-[1.1] font-normal",children:Qt?a?`₩${Number(e.expenditure_amount).toLocaleString()}`:"":"-"})]}):r.jsx(Wa,{onConfirm:(t,a)=>Fa(e.id,t,a),placeholder:"지출 날짜와 금액을 입력하세요",align:"center",side:"bottom",children:r.jsx("button",{className:"button-toggle-inactive",children:"지출입력"})}):t?r.jsxs("div",{className:"w-full px-1 leading-none",children:[r.jsx("div",{className:"text-blue-700 text-[9px] leading-[1.1] font-normal",children:(()=>{const t=new Date(e.expenditure_date);return`${t.getFullYear().toString().slice(-2)}.${(t.getMonth()+1).toString().padStart(2,"0")}.${t.getDate().toString().padStart(2,"0")}`})()}),r.jsx("div",{className:"text-gray-700 text-[9px] leading-[1.1] font-normal",children:Qt?a?`₩${Number(e.expenditure_amount).toLocaleString()}`:"":"-"})]}):r.jsx("span",{className:"modal-subtitle text-gray-400",children:"-"})})()})]}),r.jsxs("div",{className:"block sm:hidden space-y-2",children:[r.jsxs("div",{className:"flex justify-between items-start",children:[r.jsxs("div",{className:"flex-1 min-w-0 relative",children:[be?r.jsx(T,{value:e.item_name,onChange:e=>Ta(t,"item_name",e.target.value),onFocus:()=>Te(`m_item_name_${t}`),onBlur:()=>Te(null),className:"modal-label border-gray-200 rounded-lg w-full !px-1.5 !py-0.5 !text-[10px] focus:border-blue-400 transition-all duration-200 "+(Ee===`m_item_name_${t}`?"!h-auto !min-h-[20px] !absolute !z-[9999] !bg-white !shadow-lg !left-0 !right-0 !-translate-y-1/2 !top-1/2 !whitespace-normal":"!h-5 !truncate"),placeholder:"품목명"}):r.jsx("div",{className:"modal-value font-medium",children:e.item_name||"품목명 없음"}),be?r.jsx(T,{value:e.specification,onChange:e=>Ta(t,"specification",e.target.value),onFocus:()=>Te(`m_specification_${t}`),onBlur:()=>Te(null),className:"modal-label border-gray-200 rounded-lg mt-1 w-full !px-1.5 !py-0.5 !text-[10px] focus:border-blue-400 transition-all duration-200 "+(Ee===`m_specification_${t}`?"!h-auto !min-h-[20px] !absolute !z-[9999] !bg-white !shadow-lg !left-0 !right-0 !-translate-y-1/2 !top-1/2 !whitespace-normal !w-full":"!h-5 !truncate"),placeholder:"규격"}):r.jsx("div",{className:"modal-subtitle text-gray-500",children:e.specification||"-"})]}),r.jsxs("div",{className:"ml-3 text-right flex-shrink-0",children:[be?r.jsx(T,{type:"number",value:e.amount_value||0,onChange:e=>Ta(t,"amount_value",Number(e.target.value)),onWheel:e=>e.currentTarget.blur(),className:"border-gray-200 rounded-lg w-24 !h-6 !px-1.5 !py-0.5 !text-[10px] font-normal text-gray-600 focus:border-blue-400 text-right",placeholder:"합계"}):r.jsx("div",{className:"modal-value font-semibold",children:$a(e.amount_value||0,Ma(e))}),r.jsxs("div",{className:"text-[10px] text-gray-500 mt-0.5",children:["done"!==D||Qt?`${$a(e.unit_price_value||0,Ma(e))}`:"-"," / 단가"]})]})]}),r.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[r.jsxs("div",{children:[r.jsx("span",{className:"text-gray-500 text-xs",children:"수량"}),be?"receipt"===D||"done"===D?r.jsxs("div",{className:"grid grid-cols-2 gap-1 mt-1",children:[r.jsx(T,{type:"number",value:e.quantity,onChange:e=>Ta(t,"quantity",Number(e.target.value)),className:"border-gray-200 rounded-lg text-center w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"요청수량",max:"99999"}),r.jsx(T,{type:"number",value:e.received_quantity??"",onChange:e=>Ta(t,"received_quantity",e.target.value?Number(e.target.value):null),className:"border-gray-200 rounded-lg text-center w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"실제입고",max:"99999"})]}):r.jsx(T,{type:"number",value:e.quantity,onChange:e=>Ta(t,"quantity",Number(e.target.value)),className:"border-gray-200 rounded-lg text-center w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400 mt-1",placeholder:"수량",max:"99999"}):r.jsx("div",{className:"modal-subtitle mt-1",children:"receipt"===D||"done"===D?r.jsxs(r.Fragment,{children:[r.jsx("span",{className:"text-gray-500",children:e.quantity||0}),r.jsxs("span",{className:"text-gray-400",children:["/",e.received_quantity??0]})]}):e.quantity||0})]}),r.jsxs("div",{children:[r.jsx("span",{className:"text-gray-500 text-xs",children:"링크"}),r.jsx("div",{className:"mt-1",children:be?r.jsx(T,{value:e.link||"",onChange:e=>Ta(t,"link",e.target.value),className:"border-gray-200 rounded-lg text-center w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"링크(URL)"}):e.link?r.jsx("a",{href:e.link,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:text-blue-800 underline text-[11px] break-all",onClick:e=>e.stopPropagation(),children:e.link}):r.jsx("span",{className:"text-gray-400 text-[11px]",children:"-"})})]})]}),r.jsxs("div",{className:"grid grid-cols-2 gap-2 items-center",children:[r.jsxs("div",{children:[r.jsx("span",{className:"text-gray-500 text-xs",children:"상태"}),r.jsx("div",{className:"mt-1",children:"pending"===D?r.jsx("span",{className:"text-xs text-gray-400",children:"-"}):r.jsxs(r.Fragment,{children:["purchase"===D&&r.jsx("div",{className:"flex items-center gap-2",children:Yt?r.jsx("button",{onClick:()=>Oa(e.id,!e.is_payment_completed),className:"text-xs px-2 py-1 rounded "+(e.is_payment_completed?"button-action-primary":"bg-gray-100 text-gray-600"),children:e.is_payment_completed?"구매완료":"구매대기"}):r.jsx("span",{className:"text-xs px-2 py-1 rounded "+(e.is_payment_completed?"button-action-primary":"bg-gray-100 text-gray-400"),children:e.is_payment_completed?"구매완료":"구매대기"})}),"receipt"===D&&r.jsx("div",{className:"flex items-center gap-2",children:Gt?pa.isCompleted(e)?r.jsx("button",{onClick:()=>{pa.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"text-xs px-2 py-1 rounded button-action-primary",children:pa.config.completedText}):r.jsx($,{onDateSelect:t=>{pa.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"실제 입고된 날짜를 선택하세요",align:"center",side:"bottom",children:r.jsx("button",{className:"text-xs px-2 py-1 rounded bg-gray-100 text-gray-600",children:pa.config.waitingText})}):r.jsx("span",{className:"text-xs px-2 py-1 rounded "+(pa.isCompleted(e)?"button-action-primary":"bg-gray-100 text-gray-400"),children:pa.isCompleted(e)?pa.config.completedText:pa.config.waitingText})}),"done"===D&&r.jsx(r.Fragment,{children:r.jsx("span",{className:"button-base "+(pa.isCompleted(e)?"bg-green-500 text-white":"border border-gray-300 text-gray-600 bg-white"),children:pa.isCompleted(e)?"입고완료":"입고대기"})}),"purchase"!==D&&"receipt"!==D&&"done"!==D&&r.jsx("span",{className:"text-xs text-gray-400",children:"-"})]})})]}),(e.remark||be)&&r.jsxs("div",{children:[r.jsx("span",{className:"text-gray-500 text-xs",children:"비고:"}),be?r.jsx(T,{value:e.remark||"",onChange:e=>Ta(t,"remark",e.target.value),className:"modal-label border-gray-200 rounded-lg mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"비고"}):r.jsx("div",{className:"modal-subtitle text-gray-500 mt-1",children:e.remark||"-"})]})]}),!be&&"receipt"===D&&pa.getCompletedDate(e)&&r.jsxs("div",{children:[r.jsx("span",{className:"text-gray-500 text-xs",children:"실제입고일:"}),r.jsxs("div",{className:"mt-1",children:[r.jsx("div",{className:"modal-subtitle text-green-700",children:new Date(pa.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})}),r.jsx("div",{className:"text-[9px] text-gray-500",children:new Date(pa.getCompletedDate(e)).toLocaleTimeString("ko-KR",{hour:"2-digit",minute:"2-digit"})})]})]}),!be&&Vt&&r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("span",{className:"text-gray-500 text-xs",children:"거래명세서 확인:"}),r.jsx("div",{className:"flex items-center gap-2",children:ta?ma.isCompleted(e)?r.jsx("button",{onClick:()=>{ma.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"text-xs px-2 py-1 rounded button-action-primary",children:ma.config.completedText}):r.jsx($,{onDateSelect:t=>{ma.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"회계상 입고일을 선택하세요",align:"center",side:"bottom",children:r.jsx("button",{className:"text-xs px-2 py-1 rounded bg-gray-100 text-gray-600",children:ma.config.waitingText})}):r.jsx("span",{className:"text-xs px-2 py-1 rounded "+(ma.isCompleted(e)?"button-action-primary":"bg-gray-100 text-gray-400"),children:ma.isCompleted(e)?ma.config.completedText:ma.config.waitingText})})]}),!be&&Vt&&e.accounting_received_date&&r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("span",{className:"text-gray-500 text-xs",children:"회계상 입고일:"}),r.jsx("span",{className:"modal-subtitle text-blue-700",children:new Date(e.accounting_received_date).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})})]}),!be&&Xt&&r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("span",{className:"text-gray-500 text-xs",children:"지출정보:"}),r.jsx("div",{className:"text-right",children:e.expenditure_date?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"text-blue-700 text-[11px]",children:(()=>{const t=new Date(e.expenditure_date);return`${t.getFullYear().toString().slice(-2)}.${(t.getMonth()+1).toString().padStart(2,"0")}.${t.getDate().toString().padStart(2,"0")}`})()}),r.jsx("div",{className:"text-gray-700 text-[11px]",children:Qt?null!==e.expenditure_amount&&void 0!==e.expenditure_amount?`₩${Number(e.expenditure_amount).toLocaleString()}`:"":"-"})]}):r.jsx("span",{className:"text-gray-400 text-[11px]",children:"-"})})]})]})]})},Ua=r.jsx("div",{className:"space-y-1 sm:space-y-4",children:ge?r.jsx("div",{className:"flex items-center justify-center py-12",children:r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-hansl-600"})}):ve?r.jsxs("div",{children:[r.jsx("div",{className:"bg-gray-50 rounded-lg p-2 sm:p-3 mb-1 sm:mb-2 border border-gray-100",children:r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 items-center gap-3 sm:gap-0",children:[r.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-4",children:[r.jsxs("div",{className:"flex items-center gap-3",children:[(()=>{if(!ve)return null;if(ve.payment_category){const e=ve.payment_category.trim();return"발주"===e?r.jsx("span",{className:"badge-stats bg-green-500 text-white",children:"발주"}):"구매요청"===e?r.jsx("span",{className:"badge-stats bg-blue-500 text-white",children:"구매요청"}):"현장결제"===e?r.jsx("span",{className:"badge-stats bg-gray-500 text-white",children:"현장결제"}):r.jsx("span",{className:"badge-stats bg-blue-500 text-white",children:e})}return r.jsx("span",{className:"badge-stats bg-blue-500 text-white",children:"구매요청"})})(),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("span",{className:"modal-label",children:"요청자:"}),r.jsx("span",{className:"modal-value",children:ve.requester_name})]})]}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(G,{className:"w-3 h-3 text-gray-500"}),r.jsxs("span",{className:"modal-subtitle",children:["청구일: ",I(ve.request_date)]})]})]}),r.jsxs("div",{className:"flex items-center justify-center gap-2 sm:gap-3 flex-wrap",children:[ha&&"pending"===ve.middle_manager_status&&r.jsx(i,{size:"sm",variant:"outline",onClick:()=>Aa("middle"),className:`${ga} border border-gray-400 bg-white hover:bg-gray-50 hover:border-gray-500`,children:"1차 승인 대기"}),"approved"===ve.middle_manager_status&&r.jsxs("div",{className:"button-approved badge-text shadow-sm",children:[r.jsx(Z,{className:"w-3 h-3"}),"1차 승인완료"]}),"rejected"===ve.middle_manager_status&&r.jsxs("div",{className:"button-rejected badge-text",children:[r.jsx(g,{className:"w-3 h-3"}),"1차 반려"]}),"pending"===ve.middle_manager_status&&!ha&&r.jsx("div",{className:`${fa} border border-gray-300 text-gray-600 bg-white`,children:"1차 승인대기"}),_a&&"approved"===ve.middle_manager_status&&"pending"===ve.final_manager_status&&r.jsxs(i,{size:"sm",variant:"outline",onClick:()=>Aa("final"),className:`${ga} border border-gray-400 bg-white hover:bg-gray-50 hover:border-gray-500`,children:[r.jsx(Z,{className:"w-3 h-3"}),"최종 승인"]}),"approved"===ve.final_manager_status&&r.jsxs("div",{className:"button-approved badge-text",children:[r.jsx(Z,{className:"w-3 h-3"}),"최종 승인완료"]}),"rejected"===ve.final_manager_status&&r.jsxs("div",{className:"button-rejected badge-text",children:[r.jsx(g,{className:"w-3 h-3"}),"최종 반려"]}),"approved"!==ve.middle_manager_status&&"pending"===ve.final_manager_status&&r.jsx("div",{className:`${fa} border border-gray-300 text-gray-600 bg-white`,children:"최종 승인대기"})]}),r.jsx("div",{})]})}),r.jsxs("div",{className:"flex flex-col lg:flex-row gap-3 sm:gap-6",children:[r.jsxs("div",{className:"lg:w-80 lg:flex-shrink-0 space-y-1 sm:space-y-4 relative",children:[r.jsxs("div",{className:"bg-white rounded-lg p-2 sm:p-3 border border-gray-100 shadow-sm",children:[r.jsx("div",{className:"mb-3",children:r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("h3",{className:"modal-section-title flex items-center",children:[r.jsx(f,{className:"w-4 h-4 mr-2 text-gray-600"}),ve?.purchase_order_number||"PO번호 없음"]}),ta&&Qt&&("done"===D||"receipt"===D)&&r.jsxs("button",{onClick:ia,className:"button-base text-xs px-2 py-1 flex items-center "+(ve?.is_utk_checked?"button-toggle-active bg-orange-500 hover:bg-orange-600 text-white":"button-toggle-inactive"),title:ve?.is_utk_checked?"UTK 확인 취소":"UTK 확인",children:[r.jsx(ne,{className:"w-3 h-3 mr-1"}),"UTK ",ve?.is_utk_checked?"완료":"확인"]})]})}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[r.jsxs("div",{className:"w-32",children:[r.jsx("span",{className:"modal-label",children:"발주서 종류"}),be?r.jsx(T,{value:we?.request_type||"",onChange:e=>Ne(t=>t?{...t,request_type:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"일반",disabled:Kt&&!Ut}):r.jsx("p",{className:"modal-value",children:ve.request_type||"일반"})]}),r.jsxs("div",{className:"w-32",children:[r.jsx("span",{className:"modal-label",children:"결제 종류"}),be?r.jsx(T,{value:we?.payment_category||"",onChange:e=>Ne(t=>t?{...t,payment_category:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"발주/구매요청/현장결제",disabled:Kt&&!Ut}):r.jsx("p",{className:"modal-value",children:ve.payment_category||"-"})]})]}),r.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[r.jsxs("div",{className:"w-32",children:[r.jsx("span",{className:"modal-label",children:"입고 요청일"}),be?r.jsx($,{onDateSelect:e=>{Ne(t=>t?{...t,delivery_request_date:R(e,"yyyy-MM-dd")}:null)},placeholder:"입고 요청일을 선택하세요",align:"start",side:"bottom",children:r.jsxs(i,{variant:"outline",className:"mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] justify-start text-left font-normal business-radius-input",disabled:Kt&&!Ut,children:[r.jsx(G,{className:"mr-1 h-3 w-3"}),we?.delivery_request_date?I(we.delivery_request_date):"날짜 선택"]})}):r.jsx("p",{className:"modal-subtitle",children:I(ve.delivery_request_date)})]}),r.jsxs("div",{className:"w-32",children:[r.jsx("span",{className:"modal-label text-orange-500",children:"변경 입고일"}),be?r.jsx($,{onDateSelect:e=>{Ne(t=>t?{...t,revised_delivery_request_date:R(e,"yyyy-MM-dd")}:null)},placeholder:"변경 입고일을 선택하세요",align:"start",side:"bottom",children:r.jsxs(i,{variant:"outline",className:"mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] justify-start text-left font-normal business-radius-input",disabled:Kt&&!Ut,children:[r.jsx(G,{className:"mr-1 h-3 w-3"}),we?.revised_delivery_request_date?I(we.revised_delivery_request_date):"날짜 선택"]})}):r.jsx("p",{className:"modal-subtitle text-orange-700",children:ve.revised_delivery_request_date?I(ve.revised_delivery_request_date):"미설정"})]})]})]})]}),r.jsxs("div",{className:"bg-white rounded-lg p-2 sm:p-3 border border-gray-100 shadow-sm",children:[r.jsxs("h3",{className:"modal-section-title mb-3 flex items-center",children:[r.jsx(v,{className:"w-4 h-4 mr-2 text-gray-600"}),"업체 정보"]}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[r.jsxs("div",{className:"w-32",children:[r.jsx("span",{className:"modal-label",children:"업체명"}),be?r.jsx(E,{options:Oe.map(e=>({value:e.id.toString(),label:e.vendor_name})),value:we?.vendor_id?{value:we.vendor_id.toString(),label:we.vendor_name||Oe.find(e=>e.id===we.vendor_id)?.vendor_name||""}:null,isDisabled:Kt&&!Ut,onChange:e=>{if(c.info("ReactSelect onChange:",{option:e}),e){const t=Oe.find(t=>t.id.toString()===e.value);if(c.info("Selected vendor:",{selectedVendor:t}),t){s().from("vendor_contacts").select("id, contact_name, contact_email, contact_phone, position").eq("vendor_id",t.id).then(({data:e,error:a})=>{a&&c.error("담당자 목록 로드 오류:",a),c.info("🔍 업체 변경 - 담당자 목록 로드:",{vendor_id:t.id,vendor_name:t.vendor_name,contactsData:e,contactsCount:e?.length||0}),c.debug("업체 변경 - 담당자 목록:",e),Ne(a=>{const n=a?{...a,vendor_id:t.id,vendor_name:t.vendor_name,vendor:t,vendor_contacts:Array.isArray(e)?e:[],contact_id:void 0,contact_name:void 0}:null;return c.info("🔍 업체 변경 - editedPurchase 업데이트 완료:",{vendor_id:t.id,vendor_name:t.vendor_name,contactsData:e,updated_vendor_contacts:n?.vendor_contacts,updated_full:n}),c.debug("업체 변경 - editedPurchase 전체:",{updated:n}),n})})}}else Ne(e=>e?{...e,vendor_id:void 0,vendor_name:"",vendor:void 0,vendor_contacts:[],contact_id:void 0,contact_name:void 0}:null)},placeholder:"업체 선택",isClearable:!0,isSearchable:!0,menuPortalTarget:document.body,styles:{control:e=>({...e,minHeight:"20px",height:"20px",fontSize:"10px",borderRadius:"8px",borderColor:"#e5e7eb",borderWidth:"1px",backgroundColor:"#ffffff",boxShadow:"none",paddingLeft:"6px",paddingRight:"6px","&:hover":{borderColor:"#e5e7eb"},"&:focus-within":{borderColor:"#60a5fa",boxShadow:"none",outline:"none"}}),valueContainer:e=>({...e,height:"18px",padding:"0 2px",margin:"0"}),input:e=>({...e,margin:"0",padding:"0",fontSize:"10px"}),indicatorsContainer:e=>({...e,height:"18px",padding:"0"}),indicatorSeparator:()=>({display:"none"}),dropdownIndicator:e=>({...e,padding:"0 2px",svg:{width:"12px",height:"12px"}}),clearIndicator:e=>({...e,padding:"0 2px",svg:{width:"12px",height:"12px"}}),option:e=>({...e,fontSize:"10px",padding:"4px 8px"}),menuPortal:e=>({...e,zIndex:9999})},classNamePrefix:"vendor-select"}):r.jsx("p",{className:"modal-value",children:ve.vendor?.vendor_name||"-"})]}),r.jsxs("div",{className:"w-32",children:[r.jsx("span",{className:"modal-label",children:"업체 담당자"}),be?we?.vendor_id?r.jsx(E,{isDisabled:Kt&&!Ut,options:(()=>{const e=Array.isArray(we.vendor_contacts)?we.vendor_contacts:[],t=e.filter((e,t,a)=>a.findIndex(t=>t.id===e.id)===t),a=t.filter((e,t,a)=>a.findIndex(t=>t.contact_name===e.contact_name)===t),n=a.map(e=>({value:e.id.toString(),label:e.contact_name||""}))||[];return c.info("🔍 담당자 드롭다운 옵션:",{vendor_id:we.vendor_id,vendor_contacts_raw:we.vendor_contacts,vendor_contacts_count:e.length,unique_by_id_count:t.length,final_unique_count:a.length,options:n}),c.debug("담당자 드롭다운 옵션:",{options:n}),n})(),value:(()=>{const e=(Array.isArray(we.vendor_contacts)?we.vendor_contacts:[])[0];return e?.id?{value:e.id.toString(),label:e.contact_name||""}:null})(),onChange:e=>{if(c.info("🔍 담당자 선택 변경:",{option:e}),e){const t=Array.isArray(we.vendor_contacts)?we.vendor_contacts:[],a=t.find(t=>t.id.toString()===e.value);a&&Ne(e=>e?{...e,contact_id:a.id,contact_name:a.contact_name,vendor_contacts:[a,...t.filter(e=>e.id!==a.id)]}:null)}else Ne(e=>e?{...e,contact_id:void 0,contact_name:void 0,vendor_contacts:Array.isArray(we.vendor_contacts)?we.vendor_contacts:[]}:null)},placeholder:"담당자를 선택하세요",isClearable:!0,isSearchable:!0,noOptionsMessage:()=>"담당자가 없습니다",menuPortalTarget:document.body,styles:{control:e=>({...e,minHeight:"20px",height:"20px",fontSize:"10px",borderRadius:"8px",borderColor:"#e5e7eb",borderWidth:"1px",backgroundColor:"#ffffff",boxShadow:"none",paddingLeft:"6px",paddingRight:"6px","&:hover":{borderColor:"#e5e7eb"},"&:focus-within":{borderColor:"#60a5fa",boxShadow:"none",outline:"none"}}),valueContainer:e=>({...e,height:"18px",padding:"0 2px",margin:"0"}),input:e=>({...e,margin:"0",padding:"0",fontSize:"10px"}),indicatorsContainer:e=>({...e,height:"18px",padding:"0"}),indicatorSeparator:()=>({display:"none"}),dropdownIndicator:e=>({...e,padding:"0 2px",svg:{width:"12px",height:"12px"}}),clearIndicator:e=>({...e,padding:"0 2px",svg:{width:"12px",height:"12px"}}),option:e=>({...e,fontSize:"10px",padding:"4px 8px"}),menuPortal:e=>({...e,zIndex:9999})},classNamePrefix:"contact-select"}):r.jsx(T,{value:"",disabled:!0,className:"mt-1 rounded-lg border-gray-200 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"업체를 먼저 선택하세요"}):r.jsx("p",{className:"modal-value",children:(()=>{const e=Array.isArray(ve.vendor_contacts)?ve.vendor_contacts:[],t=ve.contact_name||e[0]?.contact_name||"-";return c.info("🔍 vendor_contacts display 렌더링:",{purchase_id:ve?.id,vendor_id:ve?.vendor_id,contact_id:ve?.contact_id,vendor_contacts:ve.vendor_contacts,purchase_contact_name:ve.contact_name,contactName:t,purchase_full:ve}),c.debug("vendor_contacts display 렌더링:",{purchase_id:ve?.id,vendor_id:ve?.vendor_id,contact_id:ve?.contact_id,vendor_contacts:ve.vendor_contacts,purchase_contact_name:ve.contact_name,contactName:t}),t})()})]})]}),r.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[r.jsxs("div",{className:"w-32",children:[r.jsx("span",{className:"modal-label",children:"PJ업체"}),be?r.jsx(T,{value:we?.project_vendor||"",onChange:e=>Ne(t=>t?{...t,project_vendor:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"입력",disabled:Kt&&!Ut}):r.jsx("p",{className:"modal-value",children:ve.project_vendor||"-"})]}),r.jsxs("div",{className:"w-32",children:[r.jsx("span",{className:"modal-label",children:"Item"}),be?r.jsx(T,{value:we?.project_item||"",onChange:e=>Ne(t=>t?{...t,project_item:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"입력",disabled:Kt&&!Ut}):r.jsx("p",{className:"modal-subtitle break-all whitespace-pre-wrap",style:{whiteSpace:"pre-wrap",wordBreak:"break-all"},children:ve.project_item||"-"})]})]}),r.jsx("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:r.jsxs("div",{className:"w-32",children:[r.jsx("span",{className:"modal-label",children:"수주번호"}),be?r.jsx(T,{value:we?.sales_order_number||"",onChange:e=>Ne(t=>t?{...t,sales_order_number:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"입력",disabled:Kt&&!Ut}):r.jsx("p",{className:"modal-subtitle",children:ve.sales_order_number||"-"})]})})]})]}),rt.length>0&&r.jsxs("div",{className:"bg-white rounded-lg p-2 sm:p-3 border border-gray-100 shadow-sm mt-3",children:[r.jsx("div",{className:"mb-2",children:r.jsxs("h3",{className:"modal-section-title flex items-center",children:[r.jsx(x,{className:"w-4 h-4 mr-2 text-gray-600"}),"연결된 거래명세서",r.jsxs("span",{className:"ml-2 badge-stats bg-green-500 text-white text-[10px]",children:[rt.length,"건"]})]})}),r.jsx("div",{className:"space-y-2",children:rt.map((e,t)=>r.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors",onClick:()=>(e=>{const t=(window.screen.width-1e3)/2,a=(window.screen.height-800)/2;window.open(e,"_blank",`width=1000,height=800,left=${t},top=${a},scrollbars=yes,resizable=yes`)})(e.image_url),children:[r.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[r.jsx(se,{className:"w-4 h-4 text-gray-400 flex-shrink-0"}),r.jsxs("div",{className:"min-w-0",children:[r.jsxs("div",{className:"flex items-center gap-1.5",children:[r.jsx("p",{className:"text-xs font-medium text-gray-900 truncate",children:e.vendor_name||e.file_name||"거래명세서"}),r.jsx("span",{className:"text-[9px] px-1.5 py-0.5 rounded-full font-medium "+("confirmed"===e.status?"bg-green-100 text-green-700":"extracted"===e.status?"bg-yellow-100 text-yellow-700":"bg-gray-100 text-gray-600"),children:"confirmed"===e.status?"확정":"extracted"===e.status?"확인필요":"processing"===e.status?"처리중":e.status})]}),r.jsxs("p",{className:"text-[10px] text-gray-500",children:[e.statement_date?I(e.statement_date):I(e.uploaded_at),e.grand_total&&r.jsxs("span",{className:"ml-2 text-gray-700",children:[Number(e.grand_total).toLocaleString(),"원"]})]}),e.linked_line_numbers&&e.linked_line_numbers.length>0&&r.jsxs("p",{className:"text-[9px] text-blue-600 mt-0.5",children:["품목: ",e.linked_line_numbers.map(e=>`#${e}`).join(", ")]})]})]}),r.jsx(i,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 flex-shrink-0",title:"이미지 보기",children:r.jsx(se,{className:"w-3 h-3"})})]},e.id))})]})]}),r.jsx("div",{className:"w-full min-w-0 xl:w-fit relative",children:r.jsxs("div",{className:"bg-white rounded-lg border border-gray-100 shadow-sm overflow-hidden",children:[r.jsxs("div",{className:"p-2 sm:p-3 bg-gray-50 border-b border-gray-100 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-0",children:[r.jsxs("h3",{className:"modal-section-title flex items-center",children:[r.jsx(b,{className:"w-4 h-4 mr-2 text-gray-600"}),"품목 리스트",r.jsxs("span",{className:"ml-2 badge-stats bg-gray-500 text-white",children:[At?.length||0,"개"]}),be?r.jsx(E,{isDisabled:Kt&&!Ut,options:[{value:"KRW",label:"KRW"},{value:"USD",label:"USD"},{value:"EUR",label:"EUR"},{value:"JPY",label:"JPY"},{value:"CNY",label:"CNY"}],value:we?.currency?{value:we.currency,label:we.currency}:{value:"KRW",label:"KRW"},onChange:e=>{e&&Ne(t=>t?{...t,currency:e.value}:null)},menuPortalTarget:document.body,styles:{control:e=>({...e,minHeight:"20px",height:"20px",width:"75px",fontSize:"10px",borderRadius:"8px",borderColor:"#e5e7eb",marginLeft:"8px"}),valueContainer:e=>({...e,padding:"0 6px",height:"20px"}),singleValue:e=>({...e,margin:0,position:"absolute",top:"50%",transform:"translateY(-50%)"}),input:e=>({...e,margin:0,padding:0}),indicatorsContainer:e=>({...e,height:"20px"}),indicatorSeparator:()=>({display:"none"}),dropdownIndicator:e=>({...e,padding:"0 4px"}),option:e=>({...e,fontSize:"10px",padding:"4px 8px"}),menuPortal:e=>({...e,zIndex:9999})}}):r.jsx("span",{className:"ml-2 badge-stats bg-blue-500 text-white",children:ve.currency||"KRW"})]}),!be&&r.jsxs(r.Fragment,{children:["purchase"===D&&Yt&&r.jsxs(i,{size:"sm",onClick:async()=>{if(!ve||!Yt)return;const e=`발주번호: ${ve.purchase_order_number}\n\n전체 구매완료 처리하시겠습니까?`;if(window.confirm(e)){ve&&Number(ve.id);try{const e=ve.purchase_request_items||[],t=e.filter(e=>!e.is_payment_completed);if(0===t.length)return void Y.info("모든 품목이 이미 구매완료되었습니다.");c.info(`전체 구매완료 처리: ${t.length}개 품목 (총 ${e.length}개 중)`);for(const n of t){const e={is_payment_completed:!0,payment_completed_at:(new Date).toISOString()},{error:t}=await zt.from("purchase_request_items").update(e).eq("id",n.id);if(t)throw t;y(ve.id,n.id)||c.warn("[PurchaseDetailModal] 메모리 캐시 개별 품목 구매완료 업데이트 실패",{purchaseId:ve.id,itemId:n.id})}Y.success(`${t.length}개 품목이 구매완료 처리되었습니다.`),await ra();const a=ue?.(!0,{silent:!0});a instanceof Promise&&await a}catch(t){c.error("전체 구매완료 처리 오류",t),Y.error("구매완료 처리 중 오류가 발생했습니다.")}}},className:"button-base bg-orange-500 hover:bg-orange-600 text-white",children:[r.jsx(ee,{className:"w-3 h-3 mr-1"}),"전체 구매완료"]}),"receipt"===D&&Gt&&r.jsx(za,{onConfirm:async(e,t)=>{if(!ve||!Gt)return;const a=`발주번호: ${ve.purchase_order_number}\n\n전체 입고완료 처리하시겠습니까?`;if(!window.confirm(a))return;const n=ve?Number(ve.id):NaN;try{const a=ve.purchase_request_items||[],r=a.filter(e=>!e.is_received),i=()=>{Number.isNaN(n)||me?.(n,a=>{const n=(a.items||[]).map(a=>r.find(e=>String(e.id)===String(a.id))?{...a,is_received:!0,actual_received_date:a.actual_received_date||C(e),received_quantity:void 0!==t?t:a.quantity}:a),i=(a.purchase_request_items||[]).map(a=>r.find(e=>String(e.id)===String(a.id))?{...a,is_received:!0,actual_received_date:a.actual_received_date||C(e),received_quantity:void 0!==t?t:a.quantity}:a);return{...a,items:n,purchase_request_items:i,is_received:!0,received_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}})};if(0===r.length)return void Y.info("모든 품목이 이미 입고완료되었습니다.");c.info(`전체 입고완료 처리: ${r.length}개 품목 (총 ${a.length}개 중)`),i(),xe(a=>{if(!a)return null;const n=a.items?.map(a=>r.find(e=>String(e.id)===String(a.id))?{...a,is_received:!0,received_at:(new Date).toISOString(),actual_received_date:C(e),received_quantity:void 0!==t?t:a.quantity}:a)||[],i=a.purchase_request_items?.map(a=>r.find(e=>String(e.id)===String(a.id))?{...a,is_received:!0,received_at:(new Date).toISOString(),actual_received_date:C(e),received_quantity:void 0!==t?t:a.quantity}:a)||[],s=n.length,c=n.filter(e=>e.is_received).length,o=s>0&&c===s;return{...a,items:n,purchase_request_items:i,is_received:o,received_at:o?(new Date).toISOString():a.received_at,updated_at:(new Date).toISOString()}});for(const n of r){const a={actual_received_date:C(e),is_received:!0,received_quantity:void 0!==t?t:n.quantity},{error:r}=await zt.from("purchase_request_items").update(a).eq("id",n.id);if(r)throw r;const i=void 0!==t?t:n.quantity;o(ve.id,n.id,C(e),i)||c.warn("[PurchaseDetailModal] 메모리 캐시 개별 품목 입고완료 업데이트 실패",{purchaseId:ve.id,itemId:n.id})}Y.success(`${r.length}개 품목이 입고완료 처리되었습니다.`),await ra();const s=ue?.(!0,{silent:!0});s instanceof Promise&&await s}catch(r){c.error("전체 입고완료 처리 오류",r),Y.error("입고완료 처리 중 오류가 발생했습니다.")}},placeholder:"입고일을 선택하세요",align:"end",side:"bottom",hideQuantityInput:!0,quantityInfoText:"요청입고수량과 동일한 수량으로 입력됩니다",children:r.jsxs(i,{size:"sm",className:"button-base button-action-primary",children:[r.jsx(de,{className:"w-3 h-3 mr-1"}),"전체 입고완료"]})}),Vt&&ta&&Qt&&r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx($,{onDateSelect:async e=>{if(!ve||!ta)return;e.toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"});const t=`발주번호: ${ve.purchase_order_number}\n\n전체 거래명세서 확인 처리하시겠습니까?`;if(!window.confirm(t))return;const a=C(e);ve&&Number(ve.id);try{const e=ve.purchase_request_items||[],t=e.filter(e=>!e.is_statement_received);if(0===t.length)return void Y.info("모든 품목의 거래명세서가 이미 확인되었습니다.");c.info(`전체 거래명세서 확인 처리: ${t.length}개 품목 (총 ${e.length}개 중)`);for(const r of t){const e={is_statement_received:!0,statement_received_date:a,accounting_received_date:a,statement_received_by_name:De||null},{error:t}=await zt.from("purchase_request_items").update(e).eq("id",r.id);if(t)throw t;l(ve.id,r.id,a,De||void 0)||c.warn("[PurchaseDetailModal] 메모리 캐시 개별 품목 거래명세서 확인 업데이트 실패",{purchaseId:ve.id,itemId:r.id})}Y.success(`${t.length}개 품목의 거래명세서 확인이 완료되었습니다.`),await ra();const n=ue?.(!0,{silent:!0});n instanceof Promise&&await n}catch(n){c.error("전체 거래명세서 확인 처리 오류",n),Y.error("거래명세서 확인 처리 중 오류가 발생했습니다.")}},placeholder:"전체 회계상 입고일을 선택하세요",align:"end",side:"bottom",children:r.jsxs(i,{size:"sm",className:"button-base button-action-primary",children:[r.jsx(f,{className:"w-3 h-3 mr-1"}),"거래명세서 확인"]})}),"done"===D&&"발주"===ve.payment_category&&r.jsx(Wa,{onConfirm:async(e,t)=>{if(!ve||!ta)return void Y.error("지출 정보 입력 권한이 없습니다.");const a=`발주번호: ${ve.purchase_order_number}\n\n일괄 지출 정보를 입력하시겠습니까?\n날짜: ${e.toLocaleDateString("ko-KR")}\n총 금액: ${t.toLocaleString()}원\n\n* 주의: 기존에 입력된 개별 품목의 지출 정보가 모두 초기화되고, 입력하신 총 금액으로 설정됩니다.`;if(!window.confirm(a))return;const n=ve?Number(ve.id):NaN;try{Number.isNaN(n)||me?.(n,a=>{const n=(a.items||[]).map(t=>({...t,expenditure_date:C(e),expenditure_amount:null}));return{...a,items:n,total_expenditure_amount:t}});const a=ve.items||ve.purchase_request_items||[];if(0===a.length)return void Y.error("품목이 없습니다.");xe(a=>{if(!a)return null;const n=(a.items||a.purchase_request_items||[]).map(t=>({...t,expenditure_date:C(e),expenditure_amount:null}));return{...a,items:n,purchase_request_items:n,total_expenditure_amount:t,updated_at:(new Date).toISOString()}});const{error:r}=await zt.from("purchase_request_items").update({expenditure_date:C(e),expenditure_amount:null}).in("id",a.map(e=>e.id));if(r)throw c.error("일괄 지출 정보 아이템 DB 업데이트 실패",{error:r}),r;const{error:i}=await zt.from("purchase_requests").update({total_expenditure_amount:t}).eq("id",n);if(i)throw c.error("일괄 지출 정보 총액 DB 업데이트 실패",{error:i}),i;w(ve.id,C(e),t),Y.success("일괄 지출 정보가 입력되었습니다.")}catch(r){c.error("일괄 지출 정보 입력 중 오류",r),Y.error("일괄 지출 정보 입력 중 오류가 발생했습니다.")}},placeholder:"일괄 지출 날짜와 금액을 입력하세요",align:"end",side:"bottom",children:r.jsxs(i,{size:"sm",className:"button-base button-action-primary",children:[r.jsx(re,{className:"w-3 h-3 mr-1"}),"일괄지출"]})})]})]})]}),r.jsx("div",{className:"block sm:hidden bg-gray-50 px-2 py-1 border-b border-gray-100",children:r.jsx("div",{className:"text-xs font-medium text-gray-600",children:"품목 목록 (터치하여 스크롤)"})}),r.jsx("div",{className:"w-full sm:overflow-x-auto",children:r.jsxs("div",{className:"min-w-max",children:[r.jsx("div",{className:"bg-gray-50 px-2 sm:px-3 py-1 border-b border-gray-100 sticky top-0 z-20 min-w-max "+(be?"pl-7 sm:pl-8":""),children:r.jsxs("div",{ref:Wt,className:"hidden sm:grid gap-1 modal-label min-w-max",style:{gridTemplateColumns:wa()},children:[r.jsx("div",{className:"text-center -ml-2 sm:-ml-3",children:"#"}),r.jsx("div",{children:"품목명"}),r.jsx("div",{children:"규격"}),r.jsx("div",{className:"text-center",children:"receipt"!==D&&"done"!==D||be?"요청수량":r.jsxs("div",{className:"flex flex-col items-center leading-tight",children:[r.jsx("div",{className:"text-[9px]",children:"요청/실제"}),r.jsx("div",{className:"text-[10px]",children:"입고수량"})]})}),r.jsx("div",{className:"text-right",children:"단가"}),r.jsx("div",{className:"text-right",children:"합계"}),"발주"===ve.payment_category&&r.jsx("div",{className:"text-right",children:"세액"}),r.jsx("div",{className:"text-center",children:"링크"}),r.jsx("div",{className:"text-center",children:"비고"}),"pending"!==D&&(be?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"text-center",children:"삭제"}),"receipt"===D&&r.jsx(r.Fragment,{children:r.jsx("div",{className:"text-center",children:"실제입고일"})}),Vt&&r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"text-center",children:"거래명세서 확인"}),r.jsx("div",{className:"text-center",children:"회계상 입고일"}),Xt&&r.jsx("div",{className:"text-center",children:"지출정보"})]})]}):r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"text-center",children:"purchase"===D?"구매상태":"receipt"===D||"done"===D?"입고상태":"상태"}),"receipt"===D&&r.jsx(r.Fragment,{children:r.jsx("div",{className:"text-center",children:"실제입고일"})}),Vt&&r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"text-center",children:"거래명세서 확인"}),r.jsx("div",{className:"text-center",children:"회계상 입고일"}),Xt&&r.jsx("div",{className:"text-center",children:"지출정보"})]})]}))]})}),r.jsx("div",{className:"max-h-[50vh] sm:max-h-[40vh] overflow-y-auto overflow-x-hidden",children:r.jsxs("div",{className:"pb-0",children:[be&&r.jsx(ba,{sensors:st,collisionDetection:Je,onDragEnd:mt,children:r.jsx(Ra,{items:Lt,strategy:Da,children:(je||[]).map((e,t)=>r.jsx(Za,{id:ut(e,t),children:a=>La(e,t,a,ut(e,t))},ut(e,t)))})}),!be&&r.jsx("div",{className:"divide-y divide-gray-100 overflow-visible min-w-max",children:Ft?.map((e,t)=>La(e,t,void 0,ut(e,t)))})]})}),r.jsx("div",{className:"hidden sm:block bg-gray-50 border-t border-gray-100",children:r.jsxs("div",{className:"px-2 sm:px-3",children:[r.jsxs("div",{className:"sm:grid items-center gap-1 py-2 min-w-max",style:{gridTemplateColumns:wa()},children:[r.jsx("div",{className:"-ml-2 sm:-ml-3"}),r.jsx("div",{}),r.jsx("div",{}),r.jsx("div",{}),r.jsx("div",{className:"text-right flex items-center justify-end",children:r.jsx("span",{className:"text-[11px] text-gray-600 font-medium",children:"공급가액"})}),r.jsx("div",{className:"text-right flex items-center justify-end",children:r.jsx("span",{className:"text-[12px] font-bold text-gray-900",children:"done"!==D||Qt?`${"USD"===(be?we?.currency:ve.currency)?"$":"₩"}${ka(Ft?.reduce((e,t)=>e+(t.amount_value||0),0)||0)}`:"-"})}),"발주"===ve.payment_category&&r.jsx("div",{className:"text-right flex items-center justify-end",children:r.jsx("span",{className:"text-[12px] font-bold text-gray-900",children:"done"!==D||Qt?`${"USD"===(be?we?.currency:ve.currency)?"$":"₩"}${ka(Ft?.reduce((e,t)=>e+(t.tax_amount_value||0),0)||0)}`:"-"})}),r.jsx("div",{}),r.jsx("div",{}),"pending"!==D&&(be?r.jsx("div",{}):r.jsx("div",{className:"done"===D&&"발주"===ve.payment_category?"text-right flex items-center justify-end":"",children:"done"===D&&"발주"===ve.payment_category&&r.jsx("span",{className:"text-[11px] text-gray-600 font-medium",children:"지출총합"})})),"receipt"===D&&r.jsx("div",{}),"done"===D&&r.jsx(r.Fragment,{children:"발주"===ve.payment_category&&r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"text-right flex items-center justify-end",children:r.jsx("div",{className:"text-[12px] font-bold text-blue-700",children:Qt?`₩${ka(ve.total_expenditure_amount??((be?je:At)?.reduce((e,t)=>e+(Number(t.expenditure_amount)||0),0)||0))}`:"-"})}),r.jsx("div",{}),r.jsx("div",{})]})})]}),"발주"===ve.payment_category&&r.jsxs("div",{className:"sm:grid items-center gap-1 py-2 min-w-max border-t border-gray-300",style:{gridTemplateColumns:wa()},children:[r.jsx("div",{className:"-ml-2 sm:-ml-3"}),r.jsx("div",{}),r.jsx("div",{}),r.jsx("div",{}),r.jsx("div",{}),r.jsx("div",{className:"text-right flex items-center justify-end",children:r.jsx("span",{className:"text-[11px] text-gray-600 font-medium",children:"총액"})}),r.jsx("div",{className:"text-right flex items-center justify-end",children:r.jsx("span",{className:"text-[12px] font-bold text-blue-600",children:"done"!==D||Qt?$a((be?je:At)?.reduce((e,t)=>e+(t.amount_value||0)+(t.tax_amount_value||0),0)||0,Ia()):"-"})}),r.jsx("div",{}),r.jsx("div",{}),r.jsx("div",{}),"receipt"===D&&r.jsx("div",{}),"done"===D&&"발주"===ve.payment_category&&r.jsxs(r.Fragment,{children:[r.jsx("div",{}),r.jsx("div",{}),r.jsx("div",{})]})]})]})})]})}),r.jsx("div",{className:"bg-gray-50 px-2 sm:px-3 border-t border-gray-100",children:r.jsxs("div",{className:"block sm:hidden py-2 space-y-1",children:[r.jsxs("div",{className:"flex justify-between items-center",children:[r.jsx("span",{className:"text-[12px] text-gray-500",children:"합계 총액"}),r.jsx("span",{className:"text-[13px] font-bold text-gray-900",children:"done"!==D||Qt?$a((be?je:At)?.reduce((e,t)=>e+(t.amount_value||0),0)||0,Ia()):"-"})]}),"발주"===ve.payment_category&&r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"flex justify-between items-center",children:[r.jsx("span",{className:"text-[12px] text-gray-500",children:"세액 총액"}),r.jsx("span",{className:"text-[13px] font-bold text-gray-900",children:"done"!==D||Qt?$a((be?je:At)?.reduce((e,t)=>e+(t.tax_amount_value||0),0)||0,Ia()):"-"})]}),r.jsxs("div",{className:"flex justify-between items-center border-t pt-1",children:[r.jsx("span",{className:"text-[12px] text-gray-500",children:"합계+세액"}),r.jsx("span",{className:"text-[13px] font-bold text-blue-600",children:"done"!==D||Qt?$a((be?je:At)?.reduce((e,t)=>e+(t.amount_value||0)+(t.tax_amount_value||0),0)||0,Ia()):"-"})]})]}),"done"===D&&"발주"===ve.payment_category&&r.jsxs("div",{className:"flex justify-between items-center border-t pt-1",children:[r.jsx("span",{className:"text-[12px] text-gray-500",children:"지출 총합"}),r.jsx("span",{className:"text-[13px] font-bold text-blue-700",children:Qt?`₩${ka(ve.total_expenditure_amount??((be?je:At)?.reduce((e,t)=>e+(Number(t.expenditure_amount)||0),0)||0))}`:"-"})]})]})}),be&&r.jsx("div",{className:"p-2 sm:p-3 border-t border-gray-100",children:r.jsxs(i,{type:"button",size:"sm",variant:"outline",onClick:e=>{if(e?.preventDefault?.(),e?.stopPropagation?.(),!be)return;const t=Date.now();t-Et.current<350?c.warn("[PurchaseDetailModal] handleAddItem 중복 호출 차단",{deltaMs:t-Et.current}):(Et.current=t,Se(e=>{const a=e||[],n={item_name:"",specification:"",quantity:1,unit_price_value:0,amount_value:0,remark:"",line_number:a.reduce((e,t)=>{const a=t.line_number||0;return a>e?a:e},0)+1,tempId:`tmp-new-${t}-${Math.random()}`};return[...a,n].sort((e,t)=>(e.line_number||999999)-(t.line_number||999999)).map((e,t)=>({...e,line_number:t+1,stableKey:e.stableKey??lt(e,t)}))}))},className:"w-full rounded-lg border-dashed border-2 border-gray-300 hover:border-gray-400 py-2 badge-text",children:[r.jsx(O,{className:"w-4 h-4 mr-1"}),"항목 추가"]})})]})})]})]}):r.jsx("div",{className:"text-center py-12",children:ge?r.jsxs("div",{className:"flex items-center justify-center gap-2",children:[r.jsx("div",{className:"w-5 h-5 border-2 border-gray-300 border-t-transparent rounded-full animate-spin"}),r.jsx("span",{className:"modal-subtitle",children:"불러오는 중..."})]}):r.jsxs("div",{className:"space-y-3",children:[r.jsx("span",{className:"modal-subtitle",children:"발주내역이 삭제 되었거나 없습니다."}),!d&&r.jsx("div",{children:r.jsx(i,{size:"sm",variant:"outline",onClick:n,className:"button-base button-action-secondary",children:"닫기"})})]})})});return d?Ua:r.jsx(r.Fragment,{children:r.jsx(P,{open:a,onOpenChange:n,children:r.jsxs(A,{className:"overflow-hidden bg-white rounded-lg shadow-sm border-0 w-full sm:w-auto max-w-[calc(100vw-48px)] sm:max-w-[calc(100vw-80px)] lg:max-w-[90vw] xl:max-w-[85vw] h-[95vh] sm:h-auto sm:max-h-[90vh] lg:max-h-[85vh] sm:rounded-lg flex flex-col",showCloseButton:!1,children:[r.jsx(F,{className:"sr-only",children:r.jsx(L,{children:"발주 상세 정보"})}),r.jsxs("div",{className:"relative px-3 sm:px-6 pt-0 sm:pt-3 lg:pt-4 pb-0 sm:pb-2 lg:pb-3 flex-shrink-0",children:[r.jsxs("div",{className:"absolute right-3 sm:right-6 top-3 sm:top-3 lg:top-4 flex items-center gap-2 z-10",children:[!be&&Ht&&r.jsxs(i,{size:"sm",variant:"outline",onClick:()=>Na(!0),className:"button-base button-action-secondary h-8 text-xs px-3",children:[r.jsx(le,{className:"w-3.5 h-3.5 mr-1.5"}),"수정"]}),!be&&Jt&&pe&&r.jsxs(i,{size:"sm",variant:"outline",onClick:()=>{ve&&pe(ve)},className:"button-base button-action-danger h-8 text-xs px-3",children:[r.jsx(te,{className:"w-3.5 h-3.5 mr-1.5"}),"삭제"]}),!Zt&&!be&&r.jsxs(W,{open:Le,onOpenChange:e=>{We(e)},children:[r.jsx(z,{asChild:!0,children:r.jsxs(i,{variant:"outline",size:"sm",className:"button-base button-action-secondary h-8 text-xs px-3 gap-1.5",title:"수정 요청",children:[r.jsx(oe,{className:"w-3.5 h-3.5 text-gray-500"}),r.jsx("span",{children:"수정 요청"})]})}),r.jsx(B,{className:"w-[680px] max-w-[95vw] p-4",align:"end",onOpenAutoFocus:e=>e.preventDefault(),children:r.jsxs("div",{onWheel:e=>{e.currentTarget.scrollHeight>e.currentTarget.clientHeight&&(e.preventDefault(),e.stopPropagation(),e.currentTarget.scrollTop+=e.deltaY)},className:"space-y-4 max-h-[70vh] overflow-y-auto pr-1",children:[r.jsxs("div",{className:"space-y-1",children:[r.jsx("h4",{className:"modal-section-title text-gray-900",children:"수정 요청"}),r.jsx("p",{className:"card-description text-gray-500",children:"해당 발주서에 대한 요청 사항을 선택해주세요."})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"modal-label text-gray-600",children:"문의 유형 *"}),r.jsxs(H,{value:ze,onValueChange:Be,children:[r.jsx(Q,{size:"sm",className:"button-base business-radius-input border border-gray-300 bg-white text-gray-700 w-auto !h-7 !px-2.5 !text-[11px]",style:{width:`${wt}em`,maxWidth:"100%"},children:r.jsx(V,{placeholder:yt})}),r.jsx(X,{className:"text-[11px] business-radius-card",style:{minWidth:`${Nt}em`},children:gt.map(e=>r.jsx(J,{className:"text-[11px] py-1.5",value:e.value,children:e.label},e.value))})]})]}),r.jsxs("div",{className:"space-y-2 p-3 bg-gray-50 business-radius-card border border-gray-200",children:[r.jsx("div",{className:"modal-section-title text-gray-900",children:"발주요청 정보"}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("span",{className:"card-title",children:ve?.purchase_order_number||"(승인대기)"}),r.jsx("span",{className:"card-subtitle",children:ve?.vendor_name}),r.jsx("span",{className:"card-date",children:(ve?.request_date||ve?.created_at)&&R(new Date(ve.request_date||ve.created_at),"MM/dd")})]}),ht.length>0&&r.jsxs("div",{className:"mt-2 space-y-1",children:[r.jsx("div",{className:"modal-label text-gray-600",children:"품목 상세"}),ht.map((e,t)=>r.jsxs("div",{className:"flex items-center gap-2 pl-2",children:[r.jsxs("span",{className:"card-description text-gray-400",children:[e.line_number??t+1,"."]}),r.jsx("span",{className:"card-description",children:e.item_name}),e.specification&&r.jsxs("span",{className:"card-description text-gray-500",children:["(",e.specification,")"]}),r.jsxs("span",{className:"card-description text-gray-500",children:["- ",e.quantity,"개"]})]},e.id||t))]})]}),"delivery_date_change"===ze&&r.jsxs("div",{className:"space-y-3 p-3 bg-gray-50 business-radius-card border border-gray-200",children:[r.jsx("div",{className:"modal-section-title text-gray-900",children:"입고일 변경 요청"}),r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[r.jsxs("div",{children:[r.jsx("label",{className:"modal-label text-gray-600 mb-1 block",children:"현재 입고요청일"}),r.jsx("div",{className:"modal-value text-gray-700",children:ve?.delivery_request_date?R(new Date(ve.delivery_request_date),"yyyy-MM-dd"):"-"})]}),r.jsxs("div",{children:[r.jsx("label",{className:"modal-label text-gray-600 mb-1 block",children:"변경 입고일"}),r.jsx($,{onDateSelect:Qe,placeholder:"변경 입고일을 선택하세요",align:"start",side:"bottom",children:r.jsxs(i,{type:"button",variant:"outline",className:"button-base justify-start border border-gray-300 bg-white text-gray-700 business-radius-input",children:[r.jsx(G,{className:"mr-2 h-3.5 w-3.5"}),He?R(He,"yyyy-MM-dd"):"날짜 선택"]})})]})]})]}),"quantity_change"===ze&&r.jsxs("div",{className:"space-y-3 p-3 bg-gray-50 business-radius-card border border-gray-200",children:[r.jsx("div",{className:"modal-section-title text-gray-900",children:"수량 변경 요청"}),r.jsx("div",{className:"space-y-2",children:Ve.map(e=>{const t=ht.find(t=>String(t.id)===e.itemId);return r.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2",children:[r.jsx("div",{className:"flex-1",children:r.jsx(E,{value:_t.find(t=>t.value===e.itemId)||null,onChange:t=>It(e.id,{itemId:t?.value||""}),options:_t,placeholder:"품목 선택/검색",isSearchable:!0,noOptionsMessage:()=>"일치하는 품목이 없습니다",filterOption:(e,t)=>e.label.toLowerCase().includes(t.toLowerCase()),styles:kt(St,qt)})}),r.jsx("div",{className:"badge-text text-gray-600 sm:w-24 text-right",children:"변경 수량 :"}),r.jsx(T,{type:"number",value:e.newQuantity,onChange:t=>It(e.id,{newQuantity:t.target.value}),placeholder:`입고 수량 : ${t?.quantity??"-"}`,className:"sm:w-28 business-radius-input h-7 !text-[11px] !leading-tight",min:0}),r.jsxs("button",{type:"button",onClick:()=>{return t=e.id,void Xe(e=>e.filter(e=>e.id!==t));var t},className:"button-action-danger",children:[r.jsx(te,{className:"w-3.5 h-3.5 mr-1"}),"삭제"]})]},e.id)})}),r.jsxs("div",{className:"flex gap-2",children:[r.jsxs("button",{type:"button",onClick:()=>{Xe(e=>[...e,{id:pt(),itemId:"",newQuantity:""}])},className:"button-action-secondary",children:[r.jsx(O,{className:"w-3.5 h-3.5 mr-1"}),"품목 추가"]}),r.jsxs("button",{type:"button",onClick:()=>{if(0===ht.length)return;const e=new Set(Ve.map(e=>e.itemId)),t=ht.filter(t=>!e.has(String(t.id))).map(e=>({id:pt(),itemId:String(e.id),newQuantity:""}));0!==t.length&&Xe(e=>[...e.filter(e=>e.itemId),...t])},className:"button-action-secondary",disabled:0===ht.length,children:[r.jsx(ce,{className:"w-3.5 h-3.5 mr-1"}),"전체 품목 추가"]})]})]}),"price_change"===ze&&r.jsxs("div",{className:"space-y-3 p-3 bg-gray-50 business-radius-card border border-gray-200",children:[r.jsx("div",{className:"modal-section-title text-gray-900",children:"단가/합계 금액 변경 요청"}),r.jsx("div",{className:"space-y-2",children:Ye.map(e=>{const t=ht.find(t=>String(t.id)===e.itemId),a=Number(t?.unit_price_value??t?.unit_price??0),n=Number(t?.amount_value??a*(t?.quantity??0)),i=t?a.toLocaleString("ko-KR"):"-",s=t?n.toLocaleString("ko-KR"):"-",c="amount"===e.changeType?`현재 합계액: ${s}`:`현재 단가: ${i}`;return r.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center gap-2",children:[r.jsx("div",{className:"flex-1",children:r.jsx(E,{value:_t.find(t=>t.value===e.itemId)||null,onChange:t=>Dt(e.id,{itemId:t?.value||""}),options:_t,placeholder:"품목 선택/검색",isSearchable:!0,noOptionsMessage:()=>"일치하는 품목이 없습니다",filterOption:(e,t)=>e.label.toLowerCase().includes(t.toLowerCase()),styles:kt(St,qt)})}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("span",{className:"badge-text text-gray-600",children:"변경 요청"}),r.jsxs(H,{value:e.changeType,onValueChange:t=>Dt(e.id,{changeType:t,newValue:""}),children:[r.jsx(Q,{size:"sm",className:"button-base business-radius-input border border-gray-300 bg-white text-gray-700 w-auto !h-7 !px-2.5 !text-[11px]",children:r.jsx(V,{})}),r.jsx(X,{className:"text-[11px] business-radius-card",children:ft.map(e=>r.jsx(J,{className:"text-[11px] py-1.5",value:e.value,children:e.label},e.value))})]})]}),r.jsx(T,{type:"text",inputMode:"numeric",value:Ct(e.newValue),onChange:t=>{return Dt(e.id,{newValue:(a=t.target.value,a.replace(/[^\d]/g,""))});var a},placeholder:c,className:"lg:w-40 business-radius-input h-7 !text-[11px] !leading-tight",min:0}),r.jsxs("button",{type:"button",onClick:()=>{return t=e.id,void Ge(e=>e.filter(e=>e.id!==t));var t},className:"button-action-danger",children:[r.jsx(te,{className:"w-3.5 h-3.5 mr-1"}),"삭제"]})]},e.id)})}),r.jsxs("button",{type:"button",onClick:()=>{Ge(e=>[...e,{id:pt(),itemId:"",changeType:"unit_price",newValue:""}])},className:"button-action-secondary",children:[r.jsx(O,{className:"w-3.5 h-3.5 mr-1"}),"품목 추가"]})]}),r.jsxs("div",{children:[r.jsxs("label",{className:"block modal-label text-gray-700 mb-1",children:["내용 ",r.jsx("span",{className:"text-red-500",children:"*"})]}),r.jsx("div",{className:"relative",onWheel:e=>e.stopPropagation(),children:r.jsx(K,{value:Ue,onChange:e=>Ke(e.target.value),className:"business-radius-input min-h-20 text-[11px]",placeholder:"문의 내용을 자세히 입력해주세요"})})]}),r.jsxs("div",{className:"flex justify-end gap-2",children:[r.jsx(i,{variant:"outline",size:"sm",onClick:()=>We(!1),className:"button-base border border-gray-300 bg-white text-gray-700",children:"취소"}),r.jsx(i,{size:"sm",onClick:async()=>{if(ze&&Ue.trim())if(ve){et(!0);try{const e=(e=>{switch(e){case"delivery_date_change":return"입고일 변경 요청";case"quantity_change":return"수량 변경 요청";case"price_change":return"단가/합계 금액 변경 요청";case"modify":return"수정 요청";case"delete":return"삭제 요청";default:return e}})(ze)||ze;let t=null;const a=[];if("delivery_date_change"===ze){if(!He)return Y.error("변경 입고일을 입력해주세요."),void et(!1);const e=ve.delivery_request_date?R(new Date(ve.delivery_request_date),"yyyy-MM-dd"):"-",n=R(He,"yyyy-MM-dd");t={requested_date:n,current_date:ve.delivery_request_date||null},a.push(`현재 입고요청일: ${e}`),a.push(`변경 입고일: ${n}`)}if("quantity_change"===ze){const e=Ve.filter(e=>e.itemId||e.newQuantity.trim());if(0===e.length)return Y.error("수량 변경할 품목을 추가해주세요."),void et(!1);const n=[];for(const t of e){if(!t.itemId||!t.newQuantity.trim())return Y.error("수량 변경 항목을 모두 입력해주세요."),void et(!1);const e=Number(t.newQuantity);if(!Number.isFinite(e))return Y.error("변경 수량이 올바르지 않습니다."),void et(!1);const r=ht.find(e=>String(e.id)===t.itemId);if(!r)return Y.error("선택한 품목을 찾을 수 없습니다."),void et(!1);n.push({item_id:String(r.id),line_number:r.line_number??null,item_name:r.item_name,specification:r.specification??null,current_quantity:r.quantity??null,new_quantity:e}),a.push(`${r.line_number??"-"}번 ${r.item_name} (${r.specification||"-"}) ${r.quantity??0} → ${e}`)}t={items:n}}if("price_change"===ze){const e=Ye.filter(e=>e.itemId||e.newValue.trim());if(0===e.length)return Y.error("단가/합계 금액 변경할 품목을 추가해주세요."),void et(!1);const n=[];for(const t of e){if(!t.itemId||!t.newValue.trim())return Y.error("단가/합계 금액 변경 항목을 모두 입력해주세요."),void et(!1);const e=Number(t.newValue);if(!Number.isFinite(e))return Y.error("변경 값이 올바르지 않습니다."),void et(!1);const r=ht.find(e=>String(e.id)===t.itemId);if(!r)return Y.error("선택한 품목을 찾을 수 없습니다."),void et(!1);const i=Number(r.unit_price_value??r.unit_price??0),s=Number(r.amount_value??i*(r.quantity??0)),c=Number(r.quantity??0);if("amount"===t.changeType){const t=e,o=c>0?t/c:0;n.push({item_id:String(r.id),line_number:r.line_number??null,item_name:r.item_name,specification:r.specification??null,change_type:"amount",current_unit_price:i,new_unit_price:o,current_amount:s,new_amount:t}),a.push(`${r.line_number??"-"}번 ${r.item_name} (${r.specification||"-"}) 합계 ${s.toLocaleString("ko-KR")} → ${t.toLocaleString("ko-KR")}`)}else{const t=e,o=c*t;n.push({item_id:String(r.id),line_number:r.line_number??null,item_name:r.item_name,specification:r.specification??null,change_type:"unit_price",current_unit_price:i,new_unit_price:t,current_amount:s,new_amount:o}),a.push(`${r.line_number??"-"}번 ${r.item_name} (${r.specification||"-"}) 단가 ${i.toLocaleString("ko-KR")} → ${t.toLocaleString("ko-KR")} 합계 ${s.toLocaleString("ko-KR")} → ${o.toLocaleString("ko-KR")}`)}}t={items:n}}"delete"===ze&&(t={reason:Ue.trim()});let n="";const r=ht.map((e,t)=>`- ${e.line_number??t+1}. ${e.item_name} (${e.specification||"-"}) ${e.quantity}개`).join("\n");n=`발주번호: ${ve.purchase_order_number||"(승인대기)"}\n업체: ${ve.vendor_name}\n요청자: ${ve.requester_name}\n요청일: ${ve.request_date||ve.created_at||"-"}\n품목:\n${r}`;const i=[Ue.trim()];a.length>0&&i.push(`[요청 상세]\n${a.join("\n")}`),n&&i.push(`[관련 발주 정보]\n${n}`);const s=i.join("\n\n"),c=Number(ve.id),o=Number.isFinite(c)?c:void 0,l=await N.createInquiry({inquiry_type:ze,subject:e,message:s,purchase_request_id:o,purchase_info:n,purchase_order_number:ve.purchase_order_number,attachments:[],inquiry_payload:t});l.success?(Y.success("수정 요청이 전송되었습니다."),We(!1),Be(""),Ke(""),Qe(void 0),Xe([]),Ge([])):Y.error(l.error||"수정 요청 전송 중 오류가 발생했습니다.")}catch(e){c.error("수정 요청 전송 실패",e),Y.error("수정 요청 전송 중 오류가 발생했습니다.")}finally{et(!1)}}else Y.error("발주요청 정보를 찾을 수 없습니다.");else Y.error("모든 필드를 입력해주세요.")},disabled:Ze,className:"button-base bg-blue-500 hover:bg-blue-600 text-white",children:Ze?"전송 중...":"요청 전송"})]})]})})]}),r.jsx("button",{onClick:n,className:"button-base button-action-secondary w-8 h-8 rounded-full flex items-center justify-center",children:r.jsx(g,{className:"w-4 h-4 text-gray-500"})})]}),r.jsx("div",{className:"pr-8 sm:pr-16",children:r.jsxs("div",{className:"flex items-start gap-4 mb-0 sm:mb-3",children:[r.jsx("div",{className:"min-w-0 flex-1",children:r.jsx("h1",{className:"page-title mb-0 sm:mb-1",children:"발주 기본정보"})}),r.jsx("div",{className:"flex items-center gap-3",children:be&&r.jsxs(r.Fragment,{children:[r.jsxs(i,{size:"sm",variant:"outline",onClick:()=>{Na(!1),Ne(ve),Se(ve?.items||[]),ke([])},className:"button-base button-action-secondary",children:[r.jsx(g,{className:"w-4 h-4 mr-2"}),"취소"]}),r.jsx(i,{size:"sm",onClick:async()=>{if(ve&&we){Rt.current=Date.now(),$t.current=!0,nt(!0),c.debug("[handleSave] 저장 시작");try{const r=s(),i=2e4;c.debug("[handleSave] Step 1: 발주 기본 정보 업데이트 시작");const o=je.reduce((e,t)=>e+(t.amount_value||0),0);let l=null;we.contact_id?l=we.contact_id:Array.isArray(we.vendor_contacts)&&we.vendor_contacts.length>0&&(l=we.vendor_contacts[0].id||null);const d=await Ea(r.from("purchase_requests").update({purchase_order_number:we.purchase_order_number||null,requester_name:we.requester_name||null,vendor_id:we.vendor_id||null,vendor_name:we.vendor_name||null,contact_id:l,delivery_request_date:we.delivery_request_date||null,revised_delivery_request_date:we.revised_delivery_request_date||null,payment_category:we.payment_category||null,project_vendor:we.project_vendor||null,project_item:we.project_item||null,sales_order_number:we.sales_order_number||null,total_amount:Number(o),updated_at:(new Date).toISOString()}).eq("id",ve.id),i),u=d?.error;if(u)throw c.error("Purchase update error:",u),u;c.debug("[handleSave] Step 1 완료"),c.debug("[handleSave] Step 2: 담당자 정보 업데이트 시작");let m=null;try{if(we.vendor_id&&Array.isArray(we.vendor_contacts)&&we.vendor_contacts.length>0){const e=we.vendor_contacts[0];if(e.id){m=e.id;const{error:t}=await r.from("vendor_contacts").update({contact_name:e.contact_name||"",contact_email:e.contact_email||"",contact_phone:e.contact_phone||"",position:e.position||""}).eq("id",e.id);t?c.error("담당자 업데이트 오류:",t):xe(t=>t?{...t,vendor_contacts:[e],contact_id:e.id,contact_name:e.contact_name}:null)}else if(e.contact_name){const{data:t,error:a}=await r.from("vendor_contacts").insert({vendor_id:we.vendor_id,contact_name:e.contact_name,contact_email:e.contact_email||"",contact_phone:e.contact_phone||"",position:e.position||""}).select().single();if(a)c.error("담당자 생성 오류:",a);else if(t){m=t.id,we.vendor_contacts=[t],xe(e=>e?{...e,vendor_contacts:[t],contact_id:t.id,contact_name:t.contact_name}:null);const{error:e}=await r.from("purchase_requests").update({contact_id:t.id}).eq("id",ve.id);e&&c.error("purchase_requests contact_id 업데이트 오류:",e)}}}}catch(e){c.warn("⚠️ [handleSave] 담당자 정보 업데이트 실패 (무시하고 계속)",{error:e})}if(c.debug("[handleSave] Step 2 완료"),c.debug("[handleSave] Step 3: 삭제된 항목 처리 시작"),qe.length>0){const e=await Ea(r.from("purchase_request_items").delete().in("id",qe),i),t=e?.error;if(t)throw c.error("품목 삭제 에러:",t),t}if(c.debug("[handleSave] Step 3 완료"),0===je.length){c.info("🚀 모든 품목이 삭제되어 발주기본정보도 삭제합니다",{purchaseId:ve.id,deletedItemIds:qe});const{error:e}=await r.from("purchase_requests").delete().eq("id",ve.id);if(e)throw c.error("발주기본정보 삭제 실패",e),e;const t=Number(ve.id);if(!Number.isNaN(t)){j(t)?c.info("✅ [handleSave] 발주기본정보 삭제 메모리 캐시 업데이트 성공",{purchaseId:t}):c.warn("[handleSave] 발주기본정보 삭제 메모리 캐시 업데이트 실패",{purchaseId:t})}Y.success("모든 품목이 삭제되어 발주요청이 삭제되었습니다."),Na(!1),ke([]),n();const a=ue?.(!0,{silent:!1});return void(a instanceof Promise&&await a)}c.debug(`[handleSave] Step 4: 아이템 저장 시작, 총 ${je.length}개`);for(let e=0;e<je.length;e++){const t=je[e],a=6e4;if(!t.item_name||!t.item_name.trim())throw new Error("품목명은 필수입니다.");(!t.quantity||t.quantity<=0)&&(t.quantity=1);const n=qa(t.unit_price_value,0),i=qa(t.amount_value,0);if(n<0)throw new Error("단가는 0 이상이어야 합니다.");if(i<0)throw new Error("합계는 0 이상이어야 합니다.");const s=t.id?Number(t.id):null,o=s&&!Number.isNaN(s)&&s>0,l=qa(t.unit_price_value,0),d=qa(t.amount_value,0);if(o){const n=await Ea(r.from("purchase_request_items").update({item_name:t.item_name.trim(),specification:t.specification||null,quantity:qa(t.quantity,1),received_quantity:null!=t.received_quantity?qa(t.received_quantity):null,unit_price_value:l,unit_price_currency:ve.currency||"KRW",amount_value:d,amount_currency:ve.currency||"KRW",remark:t.remark||null,link:t.link&&String(t.link).trim()?String(t.link).trim():null,updated_at:(new Date).toISOString()}).eq("id",s),a),i=n?.error;if(i)throw c.error("기존 항목 업데이트 오류",i),i;c.debug(`[handleSave] 아이템 ${e+1} 업데이트 완료`)}else{const n={purchase_request_id:ve.id,item_name:t.item_name.trim(),specification:t.specification||null,quantity:qa(t.quantity,1),received_quantity:null!=t.received_quantity?qa(t.received_quantity):null,unit_price_value:l,unit_price_currency:ve.currency||"KRW",amount_value:d,amount_currency:ve.currency||"KRW",remark:t.remark||null,link:t.link&&String(t.link).trim()?String(t.link).trim():null,line_number:t.line_number||je.indexOf(t)+1,created_at:(new Date).toISOString()},i=await Ea(r.from("purchase_request_items").insert(n),a),s=i?.error;if(s)throw c.error("새 항목 생성 오류",s),s;c.debug(`[handleSave] 아이템 ${e+1} 삽입 완료`)}}c.debug("[handleSave] Step 4 완료: 모든 아이템 저장됨");const p=ve?Number(ve.id):NaN,_=we||ve;try{!Number.isNaN(p)&&qe.length>0&&qe.forEach(e=>{try{S(p,e)||c.warn("[handleSave] 개별 품목 삭제 메모리 캐시 업데이트 실패",{purchaseId:p,itemId:e})}catch(t){c.warn("⚠️ [handleSave] 개별 품목 삭제 메모리 캐시 업데이트 중 에러 (무시)",{error:t})}})}catch(t){c.warn("⚠️ [handleSave] 메모리 캐시 삭제 처리 중 에러 (무시하고 계속)",{error:t})}try{if(!Number.isNaN(p)){h(p,e=>{const t=je.reduce((e,t)=>e+(t.amount_value||0),0);return{...e,purchase_order_number:_?.purchase_order_number||e.purchase_order_number,requester_name:_?.requester_name||e.requester_name,vendor_id:_?.vendor_id||e.vendor_id,vendor_name:_?.vendor_name||e.vendor_name,vendor:_?.vendor||e.vendor,vendor_contacts:_?.vendor_contacts||e.vendor_contacts,delivery_request_date:_?.delivery_request_date||e.delivery_request_date,revised_delivery_request_date:_?.revised_delivery_request_date||e.revised_delivery_request_date,payment_category:_?.payment_category||e.payment_category,project_vendor:_?.project_vendor||e.project_vendor,project_item:_?.project_item||e.project_item,total_amount:t,items:je,purchase_request_items:je,updated_at:(new Date).toISOString()}})}}catch(t){c.warn("⚠️ [handleSave] 메모리 캐시 업데이트 중 에러 (무시하고 계속)",{error:t})}try{const e=()=>{!Number.isNaN(p)&&me&&me(p,e=>{const t=je,a=t.reduce((e,t)=>e+(t.amount_value||0),0);return{...e,purchase_order_number:_?.purchase_order_number||e.purchase_order_number,requester_name:_?.requester_name||e.requester_name,vendor_id:_?.vendor_id||e.vendor_id,vendor_name:_?.vendor_name||e.vendor_name,vendor:_?.vendor||e.vendor,vendor_contacts:_?.vendor_contacts||e.vendor_contacts,delivery_request_date:_?.delivery_request_date||e.delivery_request_date,revised_delivery_request_date:_?.revised_delivery_request_date||e.revised_delivery_request_date,payment_category:_?.payment_category||e.payment_category,project_vendor:_?.project_vendor||e.project_vendor,project_item:_?.project_item||e.project_item,total_amount:a,items:t,purchase_request_items:t,updated_at:(new Date).toISOString()}})};c.debug("[handleSave] Step 5 - UI 업데이트 시작"),e(),c.debug("[handleSave] Step 5 완료 - 저장 성공!")}catch(a){c.warn("⚠️ [handleSave] OptimisticUpdate 중 에러 (무시하고 계속)",{error:a})}c.debug("[handleSave] Step 5 완료: UI 업데이트됨"),Y.success("발주 내역이 성공적으로 저장되었습니다."),Na(!1),ke([]),c.debug("[handleSave] 저장 완료! 로딩 해제"),nt(!1),ra().catch(e=>{c.warn("⚠️ [handleSave] 백그라운드 새로고침 실패",{error:e});const t=e instanceof Error?e.message:String(e);Y.error(`저장 후 새로고침 실패: ${t}`,{duration:5e3})});const g=ue?.(!0,{silent:!0});g instanceof Promise&&g.catch(e=>{c.warn("⚠️ [handleSave] 백그라운드 onRefresh 실패 (무시)",{error:e})})}catch(r){c.error("[handleSave] 저장 실패:",r);const e=r instanceof Error?r.message:"알 수 없는 오류가 발생했습니다";Y.error(`저장 실패: ${e}`,{duration:5e3})}finally{c.debug("[handleSave] finally 블록 실행 - 로딩 해제"),$t.current=!1,nt(!1)}}else Y.error("저장할 데이터가 없습니다.")},disabled:at,className:"button-base button-action-primary",children:at?r.jsxs(r.Fragment,{children:[r.jsx(ae,{className:"w-4 h-4 mr-2 animate-spin"}),"저장 중..."]}):r.jsxs(r.Fragment,{children:[r.jsx(U,{className:"w-4 h-4 mr-2"}),"저장"]})})]})})]})})]}),r.jsx("div",{className:"overflow-y-auto flex-1 px-3 sm:px-6 pb-1 sm:pb-6 mt-0",children:Ua})]})})})}),tn=Object.freeze(Object.defineProperty({__proto__:null,default:en},Symbol.toStringTag,{value:"Module"}));export{Va as A,ne as C,Ka as D,se as I,ce as L,oe as M,en as P,Ha as R,de as T,Xa as U,Ja as a,Qa as b,re as c,le as d,za as e,tn as f,Ya as n,Ga as t,Ba as u};
//# sourceMappingURL=PurchaseDetailModal-C-yD7klJ.js.map
