import{c as E,r as n,a as V,j as e,b as h,X as B,F as ae,U as re,I as ne}from"./index-m3fJUWdN.js";import{C as q,c as H,a as ie,b as oe}from"./card-CB2Q29jH.js";import{t as l,B as F}from"./index-OpY-RBjo.js";import{I as J}from"./input-L8jZtFSn.js";import{D as ee,a as te,b as le,c as ce,d as de}from"./dialog-BsyHRK2b.js";import{D as A}from"./download-DgmFTFDD.js";import{T as Z}from"./trash-2-CYhjtZSR.js";import{C as me}from"./calendar-Bvy8cUb0.js";import{T as he}from"./textarea-wXZ1djWI.js";import{L as X}from"./label-C8mLdQRi.js";import{P as xe}from"./plus-BLzYEBb7.js";import{F as ge}from"./funnel-BpRG3l8K.js";import{S as pe}from"./search-gHNZD30F.js";/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["circle",{cx:"10",cy:"12",r:"2",key:"737tya"}],["path",{d:"m20 17-1.296-1.296a2.41 2.41 0 0 0-3.408 0L9 22",key:"wt3hpn"}]],fe=E("file-image",ue);/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ye=[["path",{d:"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2",key:"143wyd"}],["path",{d:"M6 9V3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6",key:"1itne7"}],["rect",{x:"6",y:"14",width:"12",height:"8",rx:"1",key:"1ue0tg"}]],G=E("printer",ye);/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const we=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]],je=E("rotate-ccw",we);/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]],Q=E("upload",be);/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"11",x2:"11",y1:"8",y2:"14",key:"1vmskp"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]],ve=E("zoom-in",Ne);/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]],ke=E("zoom-out",_e);function Y(){const[s,d]=n.useState({canView:!1,canUpload:!1,canDownload:!1,canPrint:!1,canDelete:!1,canViewUploaderInfo:!1}),[x,i]=n.useState(null),[c,m]=n.useState(!0),v=V(),_=async()=>{try{const{data:{user:k}}=await v.auth.getUser();if(!k){m(!1);return}const{data:U}=await v.from("employees").select("purchase_role").eq("email",k.email).single(),j=U?.purchase_role||"";i(j);const w=j.includes("app_admin"),S=j.includes("hr"),L=j.includes("lead buyer"),g=w||S||L;d({canView:g,canUpload:g,canDownload:g,canPrint:g,canDelete:w,canViewUploaderInfo:w})}catch(k){console.error("권한 확인 오류:",k)}finally{m(!1)}};return n.useEffect(()=>{_()},[]),{permissions:s,userRole:x,loading:c,refreshPermissions:_}}function Ce({receipt:s,isOpen:d,onClose:x,onDelete:i}){const[c,m]=n.useState(1),[v,_]=n.useState(0),[k,U]=n.useState(!1),[j,w]=n.useState(!1),[S,L]=n.useState({width:0,height:0}),[g,u]=n.useState(!1),y=V(),{permissions:b}=Y();n.useEffect(()=>{d&&(m(1),_(0),U(!1),u(!1))},[d]);const D=async()=>{try{const f=new URL(s.receipt_image_url).pathname.split("/"),N=f.indexOf("receipt-images");if(N===-1)throw new Error("잘못된 영수증 URL입니다");const C=f.slice(N+1).join("/"),{data:M,error:P}=await y.storage.from("receipt-images").download(C);if(P)throw P;const z=new Blob([M],{type:"image/jpeg"}),K=window.URL.createObjectURL(z),T=document.createElement("a");T.href=K,T.download=s.file_name||`영수증_${s.id}.jpg`,document.body.appendChild(T),T.click(),document.body.removeChild(T),window.URL.revokeObjectURL(K),l.success("영수증 이미지가 다운로드되었습니다.")}catch(r){console.error("다운로드 오류:",r),l.error("다운로드에 실패했습니다.")}},o=()=>{m(r=>Math.min(r+.25,3))},R=()=>{m(r=>Math.max(r-.25,.5))},O=()=>{_(r=>(r+90)%360)},$=r=>{const f=r.currentTarget;L({width:f.naturalWidth,height:f.naturalHeight}),u(!0)},I=()=>{if(!g)return{width:"100%",height:"100vh"};const r=window.innerWidth-64,f=window.innerHeight,N=r/S.width,C=f/S.height,M=Math.min(N,C);return{width:`${S.width*M}px`,height:`${S.height*M}px`}},t=n.useCallback(async()=>{try{const{data:{user:r}}=await y.auth.getUser();if(!r){l.error("사용자 정보를 불러올 수 없습니다.");return}const{data:f}=await y.from("employees").select("name").eq("email",r.email).single(),{error:N}=await y.from("purchase_receipts").update({is_printed:!0,printed_at:new Date().toISOString(),printed_by:r.id,printed_by_name:f?.name||r.email}).eq("id",s.id);if(N)throw N;l.success("인쇄 완료로 표시되었습니다."),x(),i&&i()}catch(r){console.error("인쇄 완료 처리 오류:",r),l.error("인쇄 완료 처리에 실패했습니다.")}},[y,s.id,x,i]),a=n.useCallback(()=>{const r=window.open("","_blank");r&&(r.document.write(`
        <!DOCTYPE html>
        <html><head><title></title>
        <style>@page{margin:0;size:auto;}*{margin:0;padding:0;box-sizing:border-box;}body{display:flex;justify-content:center;align-items:center;min-height:100vh;background:white;margin:0;padding:0;}.receipt-image{max-width:100%;max-height:100vh;object-fit:contain;display:block;}@media print{@page{margin:0;}body{margin:0;padding:0;background:white;}.receipt-image{max-width:100%;max-height:100%;width:auto;height:auto;page-break-inside:avoid;}}</style>
        </head><body>
        <img src="${s.receipt_image_url}" alt="" class="receipt-image" onload="setTimeout(function(){window.print();window.close();},100);" onerror="window.close();" />
        </body></html>
      `),r.document.close(),setTimeout(()=>{confirm("인쇄를 완료하셨습니까?")&&t()},1e3))},[s.receipt_image_url,t]),p=n.useCallback(async()=>{if(!b.canDelete){l.error("삭제 권한이 없습니다.");return}if(confirm("정말로 이 영수증을 삭제하시겠습니까?"))try{w(!0);const f=new URL(s.receipt_image_url).pathname.split("/"),N=f.indexOf("receipt-images");if(N!==-1){const M=f.slice(N+1).join("/"),{error:P}=await y.storage.from("receipt-images").remove([M]);P&&console.warn("스토리지 파일 삭제 실패:",P)}const{error:C}=await y.from("purchase_receipts").delete().eq("id",s.id);if(C)throw C;l.success("영수증이 삭제되었습니다."),x(),i&&i()}catch(r){console.error("삭제 오류:",r),l.error("삭제에 실패했습니다.")}finally{w(!1)}},[b.canDelete,s.id,s.receipt_image_url,x,i,y]);return e.jsx(ee,{open:d,onOpenChange:x,children:e.jsx(te,{className:"w-[100vw] max-w-none h-[100vh] p-0 overflow-hidden m-0 border-0 rounded-none",children:e.jsxs("div",{className:"flex h-full",children:[e.jsxs("div",{className:"flex-1 bg-white relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx("img",{src:s.receipt_image_url,alt:"영수증",className:"object-contain",style:{...I(),transform:`scale(${c}) rotate(${v}deg)`,transformOrigin:"center"},onLoad:$,onError:()=>U(!0)})}),e.jsx(h,{variant:"ghost",size:"sm",onClick:x,className:"absolute top-4 left-4 h-10 w-10 p-0 bg-gray-900/80 hover:bg-gray-900 text-white rounded-full",children:e.jsx(B,{className:"h-5 w-5"})}),e.jsx("div",{className:"absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-900/80 rounded-full px-4 py-2",children:e.jsxs("div",{className:"flex items-center gap-2 text-white",children:[e.jsx(h,{variant:"ghost",size:"sm",onClick:R,disabled:c<=.5,className:"h-8 w-8 p-0 text-white hover:bg-white/20",children:e.jsx(ke,{className:"w-4 h-4"})}),e.jsxs("span",{className:"text-sm min-w-[40px] text-center",children:[Math.round(c*100),"%"]}),e.jsx(h,{variant:"ghost",size:"sm",onClick:o,disabled:c>=3,className:"h-8 w-8 p-0 text-white hover:bg-white/20",children:e.jsx(ve,{className:"w-4 h-4"})}),e.jsx("div",{className:"w-px h-4 bg-white/30 mx-1"}),e.jsx(h,{variant:"ghost",size:"sm",onClick:O,className:"h-8 w-8 p-0 text-white hover:bg-white/20",children:e.jsx(je,{className:"w-4 h-4"})})]})})]}),e.jsxs("div",{className:"w-16 bg-gray-900 flex flex-col items-center justify-center space-y-4",children:[e.jsx(h,{variant:"ghost",size:"sm",onClick:a,className:"w-12 h-12 p-0 text-white hover:bg-gray-700 rounded-lg",title:"인쇄",children:e.jsx(G,{className:"w-6 h-6"})}),e.jsx(h,{variant:"ghost",size:"sm",onClick:D,className:"w-12 h-12 p-0 text-white hover:bg-gray-700 rounded-lg",title:"다운로드",children:e.jsx(A,{className:"w-6 h-6"})}),b.canDelete&&e.jsx(h,{variant:"ghost",size:"sm",onClick:p,disabled:j,className:"w-12 h-12 p-0 text-white hover:bg-red-600 rounded-lg",title:"삭제",children:j?e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsx(Z,{className:"w-6 h-6"})})]})]})})})}function se(s){if(s===0)return"0 B";const d=1024,x=["B","KB","MB","GB"],i=Math.floor(Math.log(s)/Math.log(d));return`${parseFloat((s/Math.pow(d,i)).toFixed(1))} ${x[i]}`}function W(s){if(!s)return"-";try{const d=new Date(s);return isNaN(d.getTime())?"-":d.toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})}catch{return"-"}}function Se(s,d="receipt-images"){try{const i=new URL(s).pathname.split("/"),c=i.indexOf(d);return c===-1?null:i.slice(c+1).join("/")}catch{return null}}function De({receipt:s,onView:d,onPrint:x,onDownload:i,onDelete:c}){return e.jsx(q,{className:"w-full border border-gray-200 hover:shadow-md transition-shadow cursor-pointer",onClick:()=>d(s),children:e.jsx(H,{className:"p-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[s.is_printed?e.jsx(F,{className:"bg-green-100 text-green-700 hover:bg-green-100 text-xs",children:"✓ 인쇄완료"}):e.jsx(F,{variant:"secondary",className:"bg-gray-100 text-gray-600 text-xs",children:"미완료"}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-gray-500",children:[e.jsx(me,{className:"w-3 h-3"}),e.jsx("span",{children:W(s.uploaded_at)})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"w-4 h-4 text-hansl-600"}),e.jsx("span",{className:"font-semibold text-gray-900",children:s.file_name})]}),s.memo&&e.jsx("div",{className:"text-sm text-gray-900 bg-gray-50 rounded p-2",children:s.memo}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-1 text-gray-600",children:[e.jsx(re,{className:"w-3 h-3"}),e.jsx("span",{children:s.uploaded_by_name||s.uploaded_by})]}),e.jsx("span",{className:"text-gray-500",children:se(s.file_size)})]}),e.jsxs("div",{className:`flex gap-2 pt-2 border-t border-gray-100 ${c?"grid grid-cols-3":"grid grid-cols-2"}`,children:[e.jsxs(h,{size:"sm",variant:"outline",onClick:m=>{m.stopPropagation(),x(s)},className:"flex-1",children:[e.jsx(G,{className:"w-4 h-4 mr-1"}),"인쇄"]}),e.jsxs(h,{size:"sm",variant:"outline",onClick:m=>{m.stopPropagation(),i(s)},className:"flex-1",children:[e.jsx(A,{className:"w-4 h-4 mr-1"}),"다운로드"]}),c&&e.jsxs(h,{size:"sm",variant:"outline",onClick:m=>{m.stopPropagation(),c(s)},className:"flex-1 border-red-200 text-red-600 hover:bg-red-50",children:[e.jsx(Z,{className:"w-4 h-4 mr-1"}),"삭제"]})]})]})})})}function Re({isOpen:s,onClose:d,onSuccess:x}){const[i,c]=n.useState(null),[m,v]=n.useState(""),[_,k]=n.useState(!1),[U,j]=n.useState(!1),w=V(),{permissions:S}=Y(),L=n.useCallback(o=>{if(!o.type.startsWith("image/")){l.error("이미지 파일만 업로드할 수 있습니다.");return}if(o.size>10*1024*1024){l.error("파일 크기는 10MB 이하여야 합니다.");return}c(o)},[]),g=o=>{o.preventDefault(),j(!0)},u=o=>{o.preventDefault(),j(!1)},y=o=>{o.preventDefault(),j(!1);const R=Array.from(o.dataTransfer.files);R.length>0&&L(R[0])},b=n.useCallback(async()=>{if(!S.canUpload){l.error("업로드 권한이 없습니다.");return}if(!i){l.error("파일을 선택해주세요.");return}try{k(!0);const{data:{user:o},error:R}=await w.auth.getUser();if(R||!o)throw new Error("로그인이 필요합니다.");const{data:O,error:$}=await w.from("employees").select("name").eq("email",o.email).single(),I=O?.name||"",t=new Date,a=i.name.split(".").pop()||"jpg",p=`rec${t.getFullYear().toString().substring(2)}${(t.getMonth()+1).toString().padStart(2,"0")}${t.getDate().toString().padStart(2,"0")}${t.getHours().toString().padStart(2,"0")}${t.getMinutes().toString().padStart(2,"0")}.${a}`,r=`receipts/web/${t.getTime()}/${p}`,{error:f}=await w.storage.from("receipt-images").upload(r,i,{contentType:i.type,upsert:!1});if(f)throw f;const{data:{publicUrl:N}}=w.storage.from("receipt-images").getPublicUrl(r),{error:C}=await w.from("purchase_receipts").insert({receipt_image_url:N,file_name:p,file_size:i.size,uploaded_by:o.email,uploaded_by_name:I,memo:m||null,uploaded_at:new Date().toISOString()});if(C)throw C;l.success("영수증이 성공적으로 업로드되었습니다."),D(),x()}catch(o){console.error("업로드 오류:",o),l.error(`업로드 실패: ${o instanceof Error?o.message:o}`)}finally{k(!1)}},[i,m,S.canUpload,x]),D=n.useCallback(()=>{c(null),v(""),k(!1),j(!1),d()},[d]);return e.jsx(ee,{open:s,onOpenChange:D,children:e.jsxs(te,{className:"max-w-lg",children:[e.jsxs(le,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(ce,{className:"text-xl font-bold text-gray-900",children:"📎 영수증 업로드"}),e.jsx(h,{variant:"ghost",size:"sm",onClick:D,className:"h-8 w-8 p-0 hover:bg-gray-100",children:e.jsx(B,{className:"h-4 w-4"})})]}),e.jsx(de,{className:"text-sm text-gray-600",children:"영수증 이미지를 업로드하고 메모를 추가할 수 있습니다."})]}),e.jsxs("div",{className:"space-y-6 pt-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{className:"text-sm font-medium text-gray-700",children:"파일 선택"}),e.jsxs("div",{className:`relative border-2 border-dashed rounded-xl p-8 text-center transition-all duration-200 cursor-pointer ${U?"border-hansl-400 bg-hansl-50 scale-[1.02]":i?"border-green-400 bg-green-50":"border-gray-300 hover:border-hansl-300 hover:bg-gray-50"}`,onDragOver:g,onDragLeave:u,onDrop:y,children:[i?e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto",children:e.jsx(fe,{className:"w-8 h-8 text-green-600"})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-medium text-green-800 truncate max-w-[200px] mx-auto",children:i.name}),e.jsxs("p",{className:"text-xs text-green-600",children:[(i.size/1024/1024).toFixed(2),"MB"]})]}),e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>c(null),className:"mt-3 text-red-600 border-red-200 hover:bg-red-50",children:[e.jsx(B,{className:"w-3 h-3 mr-1"}),"제거"]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto",children:e.jsx(Q,{className:"w-8 h-8 text-gray-400"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700",children:"이미지를 드래그하여 놓거나 클릭하여 선택하세요"}),e.jsx("p",{className:"text-xs text-gray-500",children:"JPG, PNG, HEIC, WebP • 최대 10MB"})]})]}),!i&&e.jsx("input",{type:"file",accept:"image/*",onChange:o=>{const R=o.target.files?.[0];R&&L(R)},className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(X,{htmlFor:"memo",className:"text-sm font-medium text-gray-700",children:["메모 ",e.jsx("span",{className:"text-gray-400 text-xs",children:"(선택사항)"})]}),e.jsx(he,{id:"memo",placeholder:"영수증에 대한 간단한 메모를 입력하세요",value:m,onChange:o=>v(o.target.value),className:"resize-none border-gray-200 focus:border-hansl-400 focus:ring-hansl-400",rows:3})]}),e.jsxs("div",{className:"flex gap-3 pt-6 border-t border-gray-100",children:[e.jsx(h,{variant:"outline",onClick:D,className:"flex-1 h-11 border-gray-200 hover:bg-gray-50",disabled:_,children:"취소"}),e.jsx(h,{onClick:b,disabled:!i||_,className:"flex-1 h-11 bg-hansl-600 hover:bg-hansl-700 text-white font-medium shadow-sm",children:_?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"업로드 중..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Q,{className:"w-4 h-4 mr-2"}),"업로드"]})})]})]})]})})}function qe(){const[s,d]=n.useState([]),[x,i]=n.useState(!0),[c,m]=n.useState(""),[v,_]=n.useState(""),[k,U]=n.useState(null),[j,w]=n.useState(!1),[S,L]=n.useState(!1),g=V(),{permissions:u,loading:y}=Y();n.useEffect(()=>{!y&&!u.canView&&l.error("영수증 관리에 접근할 권한이 없습니다.")},[u.canView,y]);const b=n.useCallback(async()=>{if(u.canView)try{i(!0);const{data:t,error:a}=await g.from("purchase_receipts").select(`
          id,
          receipt_image_url,
          file_name,
          file_size,
          uploaded_by,
          uploaded_by_name,
          uploaded_at,
          memo,
          is_printed,
          printed_at,
          printed_by,
          printed_by_name
        `).order("uploaded_at",{ascending:!1});if(a)throw a;d(t||[])}catch(t){console.error("영수증 조회 오류:",t),l.error("영수증 데이터를 불러오는데 실패했습니다.")}finally{i(!1)}},[u.canView,g]),D=n.useMemo(()=>{let t=[...s];if(c){const a=c.toLowerCase();t=t.filter(p=>p.file_name.toLowerCase().includes(a)||p.memo?.toLowerCase().includes(a)||W(p.uploaded_at).includes(c)||p.uploaded_at.includes(c))}return v&&(t=t.filter(a=>a.uploaded_at?new Date(a.uploaded_at).toISOString().split("T")[0]===v:!1)),t},[s,c,v]);n.useEffect(()=>{y||b()},[b,y]);const o=t=>{U(t),w(!0)},R=n.useCallback(async t=>{try{const{data:{user:a}}=await g.auth.getUser();if(!a){l.error("사용자 정보를 불러올 수 없습니다.");return}const{data:p}=await g.from("employees").select("name").eq("email",a.email).single(),{error:r}=await g.from("purchase_receipts").update({is_printed:!0,printed_at:new Date().toISOString(),printed_by:a.id,printed_by_name:p?.name||a.email}).eq("id",t);if(r)throw r;l.success("인쇄 완료로 표시되었습니다."),b()}catch(a){console.error("인쇄 완료 처리 오류:",a),l.error("인쇄 완료 처리에 실패했습니다.")}},[g,b]),O=async t=>{if(!t.receipt_image_url){l.error("영수증 이미지가 없습니다.");return}try{const a=window.open("","_blank");if(!a){l.error("팝업이 차단되었습니다. 팝업을 허용해주세요.");return}a.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>영수증 인쇄</title>
          <style>
            * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
            }
            body {
              display: flex;
              justify-content: center;
              align-items: center;
              min-height: 100vh;
              background: white;
            }
            .receipt-image {
              max-width: 100%;
              max-height: 100vh;
              object-fit: contain;
            }
            @media print {
              body {
                margin: 0;
                padding: 0;
              }
              .receipt-image {
                max-width: 100%;
                max-height: 100%;
                width: auto;
                height: auto;
              }
            }
          </style>
        </head>
        <body>
          <img 
            src="${t.receipt_image_url}" 
            alt="영수증" 
            class="receipt-image"
            onload="window.print(); window.close();"
            onerror="alert('이미지를 불러올 수 없습니다.'); window.close();"
          />
        </body>
        </html>
      `),a.document.close(),setTimeout(()=>{confirm("인쇄를 완료하셨습니까?")&&R(t.id)},1e3)}catch(a){console.error("인쇄 오류:",a),l.error("인쇄에 실패했습니다.")}},$=async t=>{if(!t.receipt_image_url){l.error("영수증 이미지가 없습니다.");return}try{const p=new URL(t.receipt_image_url).pathname.split("/"),r=p.indexOf("receipt-images");if(r===-1)throw new Error("잘못된 영수증 URL입니다");const f=p.slice(r+1).join("/"),{data:N,error:C}=await g.storage.from("receipt-images").download(f);if(C)throw C;const M=new Blob([N],{type:"image/jpeg"}),P=window.URL.createObjectURL(M),z=document.createElement("a");z.href=P,z.download=t.file_name||`영수증_${t.id}.jpg`,document.body.appendChild(z),z.click(),document.body.removeChild(z),window.URL.revokeObjectURL(P),l.success("영수증 이미지가 다운로드되었습니다.")}catch(a){console.error("다운로드 오류:",a),l.error("다운로드에 실패했습니다.")}},I=n.useCallback(async t=>{if(!u.canDelete){l.error("삭제 권한이 없습니다.");return}if(confirm(`정말로 "${t.file_name}" 영수증을 삭제하시겠습니까?`))try{const a=Se(t.receipt_image_url);if(a){const{error:r}=await g.storage.from("receipt-images").remove([a]);r&&console.warn("스토리지 파일 삭제 실패:",r)}const{error:p}=await g.from("purchase_receipts").delete().eq("id",t.id);if(p)throw p;l.success("영수증이 삭제되었습니다."),b()}catch(a){console.error("삭제 오류:",a),l.error("삭제에 실패했습니다.")}},[u.canDelete,b]);return e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"영수증 관리"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"업로드된 영수증을 확인하고 관리할 수 있습니다"})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-4 sm:mt-0",children:[e.jsxs(h,{onClick:()=>{console.log("업로드 버튼 클릭됨"),L(!0),console.log("모달 상태 변경됨:",!0)},className:"bg-hansl-600 hover:bg-hansl-700 text-white",children:[e.jsx(xe,{className:"w-4 h-4 mr-2"}),"영수증 업로드"]}),e.jsxs(F,{variant:"secondary",className:"text-sm",children:["총 ",D.length,"건"]})]})]}),e.jsxs(q,{className:"mb-4 border border-gray-200",children:[e.jsx(ie,{className:"bg-white border-b border-gray-200 py-3",children:e.jsxs(oe,{className:"flex items-center text-gray-900 text-sm font-medium",children:[e.jsx(ge,{className:"w-4 h-4 mr-2"}),"검색 필터"]})}),e.jsx(H,{className:"py-3",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-1",children:"검색"}),e.jsxs("div",{className:"relative",children:[e.jsx(pe,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 w-3 h-3 text-gray-400"}),e.jsx(J,{placeholder:"파일명, 메모, 업로드일...",value:c,onChange:t=>m(t.target.value),className:"pl-7 text-sm h-9"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-1",children:"업로드 날짜"}),e.jsx(J,{type:"date",value:v,onChange:t=>_(t.target.value),className:"text-sm h-9"})]}),e.jsx("div",{className:"flex items-end",children:e.jsx(h,{variant:"outline",onClick:()=>{m(""),_("")},className:"h-9 text-sm",children:"초기화"})})]})})]}),e.jsx(q,{className:"overflow-hidden border border-gray-200",children:e.jsx(H,{className:"p-0",children:x||y?e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx("div",{className:"w-8 h-8 border-2 border-hansl-500 border-t-transparent rounded-full animate-spin"}),e.jsx("span",{className:"ml-3 text-gray-600",children:"로딩 중..."})]}):u.canView?D.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ne,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"영수증이 없습니다"}),e.jsx("p",{className:"text-gray-600",children:"업로드된 영수증이 없거나 검색 조건에 맞는 결과가 없습니다."})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"hidden md:block overflow-x-auto",children:e.jsxs("table",{className:"w-full min-w-fit",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"인쇄완료"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"업로드일"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"파일명"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"메모"}),u.canViewUploaderInfo&&e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"등록인"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"크기"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"액션"}),u.canDelete&&e.jsx("th",{className:"px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"삭제"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:D.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors cursor-pointer",onClick:()=>o(t),children:[e.jsx("td",{className:"px-4 py-3 text-sm text-center",children:t.is_printed?e.jsx(F,{className:"bg-green-100 text-green-700 hover:bg-green-100",children:"✓ 완료"}):e.jsx(F,{variant:"secondary",className:"bg-gray-100 text-gray-600",children:"미완료"})}),e.jsx("td",{className:"px-4 py-3 text-sm text-center text-gray-600",children:W(t.uploaded_at)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900",children:t.file_name}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900",children:t.memo||"-"}),u.canViewUploaderInfo&&e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:t.uploaded_by_name||t.uploaded_by}),e.jsx("td",{className:"px-4 py-3 text-sm text-center text-gray-600",children:se(t.file_size)}),e.jsx("td",{className:"px-4 py-3 text-sm text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx(h,{size:"sm",variant:"ghost",onClick:a=>{a.stopPropagation(),O(t)},className:"h-8 w-8 p-0",title:"인쇄",children:e.jsx(G,{className:"w-4 h-4"})}),e.jsx(h,{size:"sm",variant:"ghost",onClick:a=>{a.stopPropagation(),$(t)},className:"h-8 w-8 p-0",title:"다운로드",children:e.jsx(A,{className:"w-4 h-4"})})]})}),u.canDelete&&e.jsx("td",{className:"px-4 py-3 text-sm text-center",children:e.jsx(h,{size:"sm",variant:"ghost",onClick:a=>{a.stopPropagation(),I(t)},className:"h-8 w-8 p-0 text-red-600 hover:bg-red-50",title:"삭제",children:e.jsx(Z,{className:"w-4 h-4"})})})]},t.id))})]})}),e.jsx("div",{className:"md:hidden space-y-3 p-4",children:D.map(t=>e.jsx(De,{receipt:t,onView:o,onPrint:O,onDownload:$,onDelete:u.canDelete?I:void 0},t.id))})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"w-12 h-12 text-red-400 mx-auto mb-4",children:"🔒"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"접근 권한 없음"}),e.jsx("p",{className:"text-gray-600",children:"영수증 관리에 접근할 권한이 없습니다."})]})})}),k&&e.jsx(Ce,{receipt:k,isOpen:j,onClose:()=>{w(!1),U(null)},onDelete:()=>{b()}}),e.jsx(Re,{isOpen:S,onClose:()=>L(!1),onSuccess:()=>{b()}})]})}export{qe as default};
//# sourceMappingURL=ReceiptsMain-DQTvRWQ6.js.map
