import{u as e,a as t,r as a,j as s,B as r,X as n,i}from"./index-dj2fB8jQ.js";import{I as o,D as l,a as d,b as c,c as m,d as p,e as x}from"./dialog-CXF5pNfn.js";import{L as h}from"./label-DWMgeUx3.js";import{S as u,a as g,b as _,c as v,d as b}from"./select-Bovr-vQm.js";import{u as y,a as f}from"./index.esm-BKY0B9eT.js";import{t as j}from"./index-Cv_AwcOq.js";import{S as w,P as N}from"./react-select.esm-CMpEMIZm.js";import{P as S}from"./plus-D0n321ES.js";import{S as k}from"./save-DIzQb8uO.js";import"./chevron-down-h4T4Rdu_.js";function q(){const q=e(),C=t(),[z,H]=a.useState(null),[I,R]=a.useState(""),[$,K]=a.useState([]),[V,E]=a.useState(!1),[D,W]=a.useState(1),[O,P]=a.useState("");a.useEffect(()=>{(async()=>{const{data:{user:e}}=await C.auth.getUser();H(e)})()},[]),a.useEffect(()=>{(async()=>{try{const{data:e,error:t}=await C.from("employees").select("id, name, email, phone, adress, position, department").order("name");if(e&&!t&&e.length>0){if(K(e.map(e=>({id:e.id,name:e.name,email:e.email||"",phone:e.phone||"",address:e.address||"",position:e.position||"",department:e.department||""}))),I&&!e.find(e=>e.name===I)){const t={id:z?.id||"current-user",name:I,email:z?.email||"",phone:"",address:"",position:"",department:""};K([...e.map(e=>({id:e.id,name:e.name,email:e.email||"",phone:e.phone||"",address:e.address||"",position:e.position||"",department:e.department||""})),t])}}else K(I?[{id:z?.id||"current-user",name:I,email:z?.email||"",phone:"",address:"",position:"",department:""}]:[])}catch(e){K(I?[{id:z?.id||"current-user",name:I,email:z?.email||"",phone:"",address:"",position:"",department:""}]:[])}})()},[I,z]);const[M,T]=a.useState([]),[L,B]=a.useState([]),[F,U]=a.useState(""),[A,J]=a.useState([]),[G,Q]=a.useState("KRW"),[X,Y]=a.useState(!1),[Z,ee]=a.useState(""),[te,ae]=a.useState({}),[se,re]=a.useState(!1),[ne,ie]=a.useState([]),[oe,le]=a.useState(!1),de=a.useRef(!1),{control:ce,handleSubmit:me,watch:pe,setValue:xe,reset:he,getValues:ue}=y({defaultValues:{progress_type:"",payment_category:"",currency:"KRW",po_template_type:"일반",request_type:"",contacts:[],sales_order_number:"",project_vendor:"",project_item:"",delivery_request_date:"",vendor_id:0,requester_name:"",items:[{line_number:1,item_name:"",specification:"",quantity:1,unit_price_value:0,unit_price_currency:"KRW",amount_value:0,amount_currency:"KRW",remark:"",link:""}],request_date:(new Date).toISOString().slice(0,10)}}),{fields:ge,append:_e,remove:ve,update:be}=f({control:ce,name:"items"});a.useEffect(()=>{if(!z?.email||V)return;(async()=>{const{data:e}=await C.from("employees").select("name").eq("email",z.email).single();e?.name&&(R(e.name),xe("requester_name",e.name),E(!0))})()},[z,C,xe,V]),a.useEffect(()=>{(async()=>{if(z?.email&&xe&&!V)try{const{data:e,error:t}=await C.from("employees").select("name").eq("email",z.email).single();if(e&&!t)R(e.name),setTimeout(()=>{xe("requester_name",e.name,{shouldValidate:!0,shouldDirty:!0})},100),E(!0);else{const e=z.email.split("@")[0]||"사용자";R(e),setTimeout(()=>{xe("requester_name",e,{shouldValidate:!0,shouldDirty:!0})},100),E(!0)}}catch(e){const t=z.email?.split("@")[0]||"사용자";R(t),setTimeout(()=>{xe("requester_name",t,{shouldValidate:!0,shouldDirty:!0})},100),E(!0)}})()},[z,xe,V]),a.useEffect(()=>{(async()=>{try{const{data:e,error:t}=await C.from("vendors").select("*").order("vendor_name");if(t)throw t;T(e||[])}catch(e){j.error("업체 목록을 불러올 수 없습니다.")}})()},[]);const ye=pe("vendor_id");a.useEffect(()=>{(async()=>{if(ye)try{const{data:e,error:t}=await C.from("vendor_contacts").select("id, contact_name, contact_email, contact_phone, position").eq("vendor_id",ye);if(t)throw t;B(e||[])}catch(e){B([])}else B([])})()},[ye]),a.useEffect(()=>{const e=ue("items").map(e=>({...e,unit_price_currency:G,amount_currency:G}));xe("items",e),Q(G)},[G,xe,ue]),a.useEffect(()=>{ge.forEach((e,t)=>{const a=Number(e.quantity)*Number(e.unit_price_value);e.amount_value!==a&&be(t,{...e,amount_value:a})})},[ge.map(e=>`${e.quantity}-${e.unit_price_value}`).join(",")]);const fe=()=>{const e=pe("request_type"),t=pe("progress_type"),a=pe("payment_category"),s=pe("vendor_id");return!!(e&&t&&a&&s&&0!==s&&ge.length>0)},[je,we]=a.useState(!1);a.useEffect(()=>{we(fe())},[pe("request_type"),pe("progress_type"),pe("payment_category"),pe("vendor_id"),ge]);const Ne=async()=>{const e=`F${new Date((new Date).getTime()+324e5).toISOString().slice(0,10).replace(/-/g,"")}_`,{data:t,error:a}=await C.from("purchase_requests").select("purchase_order_number").like("purchase_order_number",`${e}%`).order("purchase_order_number",{ascending:!1});let s=1,r=0;if(t&&t.length>0){for(const e of t){const t=e.purchase_order_number.split("_");if(t.length>=2){const e=t[1],a=parseInt(e,10);!isNaN(a)&&a>r&&(r=a)}}s=r+1}const n=isNaN(s)?1:s;return`${e}${String(n).padStart(3,"0")}`},Se=async e=>{const t=$.find(t=>t.name===e.requester_name);if(!de.current)if(t){if(fe()){de.current=!0,Y(!0),ee("");try{let n=0,o="";const l=5;let d=0;for(;d<l;)try{o=await Ne();const{data:a,error:s}=await C.from("purchase_requests").insert({requester_id:t.id,purchase_order_number:o,requester_name:e.requester_name,requester_phone:t?.phone,requester_fax:null,requester_address:t?.address,vendor_id:e.vendor_id,sales_order_number:e.sales_order_number,project_vendor:e.project_vendor,project_item:e.project_item,request_date:e.request_date,delivery_request_date:e.delivery_request_date||null,request_type:e.request_type,progress_type:e.progress_type,is_payment_completed:!1,payment_category:e.payment_category,currency:G,total_amount:ge.reduce((e,t)=>e+t.amount_value,0),unit_price_currency:ge[0]?.unit_price_currency||G,po_template_type:e.po_template_type,contact_id:e.contact_id?Number(e.contact_id):null}).select("id").single();if(s&&!s.message.includes("duplicate key value violates unique constraint"))throw s;if(s&&s.message.includes("duplicate key value violates unique constraint")){if(d++,d>=l)throw new Error(`발주요청번호 생성에 ${l}번 실패했습니다. 잠시 후 다시 시도해주세요.`);await new Promise(e=>setTimeout(e,100+200*Math.random()));continue}if(!a)throw new Error("등록 실패");n=a.id;break}catch(a){if(!a.message.includes("duplicate key value violates unique constraint"))throw a;if(d++,d>=l)throw new Error(`발주요청번호 생성에 ${l}번 실패했습니다. 잠시 후 다시 시도해주세요.`);await new Promise(e=>setTimeout(e,100+200*Math.random()))}for(const[e,t]of ge.entries()){const{error:a}=await C.from("purchase_request_items").insert({purchase_request_id:n,line_number:e+1,item_name:t.item_name,specification:t.specification,quantity:t.quantity,unit_price_value:t.unit_price_value,unit_price_currency:G,amount_value:t.amount_value,amount_currency:G,remark:t.remark,link:t.link||null});if(a)throw a}try{const e=await fetch(`/api/purchase/${n}/notify-middle-manager`,{method:"POST",headers:{"Content-Type":"application/json"}});if(e.ok){await e.json()}else{await e.text()}}catch(s){}he({progress_type:"",payment_category:"",currency:"KRW",po_template_type:"일반",request_type:"",contacts:[],sales_order_number:"",project_vendor:"",project_item:"",delivery_request_date:"",vendor_id:0,requester_name:I,items:[{line_number:1,item_name:"",specification:"",quantity:1,unit_price_value:0,unit_price_currency:"KRW",amount_value:0,amount_currency:"KRW",remark:"",link:""}],request_date:(new Date).toISOString().slice(0,10)}),U(""),J([]),Q("KRW"),ee(""),Y(!1),j.success("발주요청서가 성공적으로 생성되었습니다."),i();try{await q("/purchase/list?tab=pending")}catch(r){window.location.href="/purchase/list?tab=pending"}return}catch(n){ee(n.message||"오류가 발생했습니다."),j.error(n.message||"발주요청서 저장에 실패했습니다.")}finally{Y(!1),de.current=!1}}}else ee("구매요청자 이름에 해당하는 직원이 없습니다. 이름을 정확히 입력해 주세요.")},ke=ge.reduce((e,t)=>e+t.amount_value,0),qe=(e,t,a)=>{ie(s=>s.map((s,r)=>r===e?{...s,[t]:a}:s)),le(!0)},Ce=pe("payment_category");return s.jsxs("form",{onSubmit:e=>{e.preventDefault(),me(Se)(e)},onKeyDown:e=>{"Enter"!==e.key&&13!==e.keyCode||e.preventDefault()},children:[s.jsxs("div",{className:"flex flex-col lg:flex-row gap-4 lg:gap-6",children:[s.jsxs("div",{className:"w-full lg:w-1/4 relative bg-muted/20 border border-border rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300 p-4 lg:p-5 space-y-4",children:[s.jsxs("div",{className:"flex flex-row items-start justify-between w-full mb-4",children:[s.jsxs("div",{className:"flex flex-col",children:[s.jsx("h4",{className:"font-semibold text-foreground",children:"발주 기본 정보"}),s.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:"Basic Information"})]}),s.jsxs("div",{className:"flex flex-col items-start",children:[s.jsxs(h,{className:"mb-1 block text-xs",children:["발주서 종류",s.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),s.jsxs(u,{value:pe("po_template_type"),onValueChange:e=>xe("po_template_type",e),children:[s.jsx(g,{className:"!h-9 !py-0 w-28 bg-white border border-[#d2d2d7] rounded-md text-xs shadow-sm hover:shadow-md transition-shadow duration-200",children:s.jsx(_,{placeholder:"종류 선택"})}),s.jsxs(v,{position:"popper",className:"z-[9999]",children:[s.jsx(b,{value:"일반",children:"일반"}),s.jsx(b,{value:"PCB",children:"PCB"}),s.jsx(b,{value:"소모품",children:"소모품"}),s.jsx(b,{value:"기타",children:"기타"})]})]})]})]}),"일반"===pe("po_template_type")&&s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"grid grid-cols-3 gap-1.5 sm:gap-2",children:[s.jsxs("div",{children:[s.jsxs(h,{className:"mb-0.5 block text-[10px] sm:text-xs",children:["요청 유형",s.jsx("span",{className:"text-red-500 ml-0.5",children:"*"})]}),s.jsxs(u,{value:pe("request_type"),onValueChange:e=>xe("request_type",e),children:[s.jsx(g,{className:"!h-9 !py-0 !leading-none bg-white border border-[#d2d2d7] rounded-md text-xs shadow-sm hover:shadow-md transition-shadow duration-200",children:s.jsx(_,{placeholder:"선택"})}),s.jsxs(v,{position:"popper",className:"z-[9999]",children:[s.jsx(b,{value:"원자재",children:"원자재"}),s.jsx(b,{value:"소모품",children:"소모품"})]})]})]}),s.jsxs("div",{children:[s.jsxs(h,{className:"mb-0.5 block text-[10px] sm:text-xs",children:["진행 종류",s.jsx("span",{className:"text-red-500 ml-0.5",children:"*"})]}),s.jsxs(u,{value:pe("progress_type"),onValueChange:e=>xe("progress_type",e),children:[s.jsx(g,{className:"!h-9 !py-0 !leading-none bg-white border border-[#d2d2d7] rounded-md text-xs shadow-sm hover:shadow-md transition-shadow duration-200",children:s.jsx(_,{placeholder:"선택"})}),s.jsxs(v,{position:"popper",className:"z-[9999]",children:[s.jsx(b,{value:"일반",children:"일반"}),s.jsx(b,{value:"선진행",children:"선진행"})]})]})]}),s.jsxs("div",{children:[s.jsxs(h,{className:"mb-0.5 block text-[10px] sm:text-xs",children:["결제 종류",s.jsx("span",{className:"text-red-500 ml-0.5",children:"*"})]}),s.jsxs(u,{value:pe("payment_category"),onValueChange:e=>xe("payment_category",e),children:[s.jsx(g,{className:"!h-9 !py-0 !leading-none bg-white border border-[#d2d2d7] rounded-md text-xs shadow-sm hover:shadow-md transition-shadow duration-200",children:s.jsx(_,{placeholder:"선택"})}),s.jsxs(v,{position:"popper",className:"z-[9999]",children:[s.jsx(b,{value:"구매 요청",children:"구매 요청"}),s.jsx(b,{value:"발주",children:"발주"}),s.jsx(b,{value:"현장 결제",children:"현장 결제"})]})]})]})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-1.5 sm:gap-2 lg:grid-cols-2",children:[s.jsxs("div",{children:[s.jsxs(h,{className:"mb-0.5 block text-[10px] sm:text-xs",children:["업체명",s.jsx("span",{className:"text-red-500 ml-0.5",children:"*"})]}),s.jsx(w,{options:M.map(e=>({value:e.id.toString(),label:e.vendor_name})),value:M.find(e=>e.id.toString()===F)?{value:F,label:M.find(e=>e.id.toString()===F)?.vendor_name}:null,onChange:e=>{const t=e;t?(U(t.value),xe("vendor_id",Number(t.value))):(U(""),xe("vendor_id",0))},placeholder:"업체 선택",isClearable:!0,isSearchable:!0,closeMenuOnSelect:!1,classNamePrefix:"vendor-select",blurInputOnSelect:!1,openMenuOnFocus:!1,openMenuOnClick:!0,tabSelectsValue:!1,captureMenuScroll:!1,pageSize:20,styles:{container:e=>({...e,width:"100%"}),control:e=>({...e,height:"36px !important",minHeight:"36px !important",maxHeight:"36px !important",background:"#fff",border:"1px solid #d2d2d7",borderRadius:"6px",fontSize:"0.75rem",boxShadow:"0 1px 2px 0 rgb(0 0 0 / 0.05)",padding:"0 !important",margin:"0 !important",alignItems:"center",display:"flex",position:"relative",verticalAlign:"top",lineHeight:"1","&:hover":{boxShadow:"0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1)"}}),valueContainer:e=>({...e,height:"36px !important",minHeight:"36px !important",maxHeight:"36px !important",padding:"0 14px !important",margin:"0 !important",fontSize:"0.75rem",alignItems:"center",display:"flex",lineHeight:"1",justifyContent:"flex-start"}),input:e=>({...e,margin:"0 !important",padding:"0 !important",fontSize:"0.75rem",lineHeight:"1",position:"relative",top:"0"}),singleValue:e=>({...e,margin:"0 !important",padding:"0 !important",fontSize:"0.75rem",lineHeight:"1",position:"relative",top:"0",transform:"none"}),placeholder:e=>({...e,margin:"0 !important",padding:"0 !important",fontSize:"0.75rem",lineHeight:"1",position:"relative",top:"0",transform:"none"}),indicatorsContainer:e=>({...e,height:"36px !important",padding:"0 8px !important",alignItems:"center",display:"flex"}),indicatorSeparator:()=>({display:"none"}),dropdownIndicator:e=>({...e,padding:"4px !important"}),clearIndicator:e=>({...e,padding:"4px !important"}),menuPortal:e=>({...e,zIndex:1400})}})]}),s.jsxs("div",{children:[s.jsxs("div",{className:"flex items-center justify-between mb-0.5",children:[s.jsx(h,{className:"text-[10px] sm:text-xs",children:"업체 담당자"}),s.jsxs("span",{className:"text-primary text-[9px] sm:text-[10px] cursor-pointer hover:underline select-none flex items-center",onClick:()=>{const e=L.map(e=>({...e,isNew:!1}));ie([...e,{contact_name:"",contact_email:"",contact_phone:"",position:"",isNew:!0}]),le(!1),re(!0)},children:[s.jsx("span",{className:"-translate-y-px",children:"+"}),s.jsx("span",{className:"ml-0.5",children:"추가/수정"})]})]}),s.jsxs(u,{value:pe("contacts")[0]||"",onValueChange:e=>{xe("contacts",[e]),xe("contact_id",e?Number(e):void 0)},children:[s.jsx(g,{className:"!h-9 !py-0 !leading-none bg-white border border-[#d2d2d7] rounded-md text-xs shadow-sm hover:shadow-md transition-shadow duration-200",children:s.jsx(_,{placeholder:"담당자 선택"})}),s.jsx(v,{position:"popper",className:"z-[9999]",children:L.map(e=>s.jsx(b,{value:e.id.toString(),children:e.contact_name||e.contact_email||e.contact_phone||e.position||""},e.id))})]})]})]}),s.jsxs("div",{className:"grid grid-cols-3 gap-1.5 sm:gap-2",children:[s.jsxs("div",{children:[s.jsx(h,{className:"mb-0.5 block text-[10px] sm:text-xs",children:"구매요구자"}),s.jsx(w,{value:I?{value:I,label:I}:null,defaultValue:I?{value:I,label:I}:null,onChange:e=>{const t=e?.value||"";xe("requester_name",t),R(t)},options:$.map(e=>({value:e.name,label:e.name})),placeholder:"선택",isSearchable:!0,isClearable:!1,noOptionsMessage:()=>"일치하는 직원이 없습니다",filterOption:(e,t)=>{const a=$.find(t=>t.name===e.value);return`${a?.name||""} ${a?.position||""} ${a?.email||""}`.toLowerCase().includes(t.toLowerCase())},styles:{control:e=>({...e,height:"36px !important",minHeight:"36px !important",maxHeight:"36px !important",background:"#fff",border:"1px solid #d2d2d7",borderRadius:"6px",fontSize:"0.75rem",boxShadow:"0 1px 2px 0 rgb(0 0 0 / 0.05)",padding:"0 !important",margin:"0 !important",alignItems:"center",display:"flex",position:"relative",verticalAlign:"top",lineHeight:"1","&:hover":{borderColor:"#d2d2d7",boxShadow:"0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1)"}}),valueContainer:e=>({...e,height:"36px !important",minHeight:"36px !important",maxHeight:"36px !important",padding:"0 14px !important",margin:"0 !important",fontSize:"0.75rem",alignItems:"center",display:"flex",lineHeight:"1",justifyContent:"flex-start"}),input:e=>({...e,margin:"0 !important",padding:"0 !important",fontSize:"0.75rem",lineHeight:"1",position:"relative",top:"0"}),singleValue:e=>({...e,margin:"0 !important",padding:"0 !important",fontSize:"0.75rem",lineHeight:"1",position:"relative",top:"0",transform:"none"}),placeholder:e=>({...e,margin:"0 !important",padding:"0 !important",fontSize:"0.75rem",lineHeight:"1",position:"relative",top:"0",transform:"none"}),indicatorsContainer:e=>({...e,height:"36px !important",padding:"0 8px !important",alignItems:"center",display:"flex"}),indicatorSeparator:()=>({display:"none"}),dropdownIndicator:e=>({...e,padding:"4px !important"}),clearIndicator:e=>({...e,padding:"4px !important"}),menu:e=>({...e,fontSize:"0.75rem",zIndex:9999}),option:e=>({...e,fontSize:"0.75rem",padding:"6px 10px"})}},`employee-select-${I}`)]}),s.jsxs("div",{children:[s.jsx(h,{className:"mb-0.5 block text-[10px] sm:text-xs",children:"청구일"}),s.jsx(o,{type:"date",value:pe("request_date"),onChange:e=>xe("request_date",e.target.value),className:"h-9 bg-white border border-[#d2d2d7] rounded-md text-xs shadow-sm hover:shadow-md transition-shadow duration-200"})]}),s.jsxs("div",{children:[s.jsx(h,{className:"mb-0.5 block text-[10px] sm:text-xs",children:"입고 요청일"}),s.jsx(o,{type:"date",value:pe("delivery_request_date"),onChange:e=>xe("delivery_request_date",e.target.value),className:"h-9 bg-white border border-[#d2d2d7] rounded-md text-xs shadow-sm hover:shadow-md transition-shadow duration-200"})]})]}),s.jsxs("div",{className:"grid grid-cols-3 gap-1.5 sm:gap-2",children:[s.jsxs("div",{children:[s.jsx(h,{className:"mb-0.5 block text-[10px] sm:text-xs",children:"PJ업체"}),s.jsx(o,{type:"text",value:pe("project_vendor"),onChange:e=>xe("project_vendor",e.target.value),placeholder:"입력",className:"h-9 bg-white border border-[#d2d2d7] rounded-md text-xs shadow-sm hover:shadow-md focus:shadow-md transition-shadow duration-200"})]}),s.jsxs("div",{children:[s.jsx(h,{className:"mb-0.5 block text-[10px] sm:text-xs",children:"수주번호"}),s.jsx(o,{type:"text",value:pe("sales_order_number"),onChange:e=>xe("sales_order_number",e.target.value),placeholder:"입력",className:"h-9 bg-white border border-[#d2d2d7] rounded-md text-xs shadow-sm hover:shadow-md focus:shadow-md transition-shadow duration-200"})]}),s.jsxs("div",{children:[s.jsx(h,{className:"mb-0.5 block text-[10px] sm:text-xs",children:"Item"}),s.jsx(o,{type:"text",value:pe("project_item"),onChange:e=>xe("project_item",e.target.value),placeholder:"입력",className:"h-9 bg-white border border-[#d2d2d7] rounded-md text-xs shadow-sm hover:shadow-md focus:shadow-md transition-shadow duration-200"})]})]})]})]}),s.jsxs("div",{className:"w-full lg:w-3/4 space-y-4",children:[s.jsxs("div",{className:"relative border border-gray-200 rounded-lg overflow-hidden",children:[s.jsxs("div",{className:"bg-gray-50 border-b border-gray-100 px-2 sm:px-3 py-2 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-3",children:[s.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(N,{className:"w-4 h-4 text-gray-600"}),s.jsxs("div",{className:"flex flex-col",children:[s.jsx("span",{className:"font-semibold text-foreground leading-tight",children:"품목 목록"}),s.jsx("span",{className:"text-xs text-muted-foreground leading-tight",children:"Purchase Items"})]}),s.jsxs("span",{className:"badge-secondary whitespace-nowrap",children:[ge.length,"개"]})]}),s.jsxs(u,{value:G,onValueChange:Q,children:[s.jsx(g,{className:"w-20 text-xs border-border business-radius-badge shadow-sm hover:shadow-md transition-shadow duration-200 bg-white",style:{height:"auto",padding:"2.5px 10px",minHeight:"auto"},children:s.jsx(_,{})}),s.jsxs(v,{className:"rounded-md",children:[s.jsx(b,{value:"KRW",children:"KRW"}),s.jsx(b,{value:"USD",children:"USD"})]})]})]}),s.jsxs("div",{className:"flex items-center justify-end gap-2 flex-wrap sm:flex-nowrap",children:[s.jsxs("span",{className:"badge-stats text-hansl-500 text-[10px] px-1.5 py-0.5 whitespace-nowrap flex-shrink-0 bg-hansl-50 business-radius-badge",children:["총액: ",ke.toLocaleString("ko-KR")," ",G]}),s.jsx(r,{type:"button",className:"button-base border border-gray-300 text-gray-600 bg-white hover:bg-red-50 hover:text-red-600",onClick:()=>{confirm("모든 품목을 삭제하시겠습니까?")&&(ge.forEach((e,t)=>ve(ge.length-1-t)),_e({line_number:1,item_name:"",specification:"",quantity:1,unit_price_value:0,unit_price_currency:G,amount_value:0,amount_currency:G,remark:"",link:""}))},children:"전체삭제"}),s.jsx(o,{type:"number",min:1,max:1e3,value:D,onChange:e=>W(Math.max(1,Number(e.target.value.replace(/[^0-9]/g,"")))),className:"w-12 text-center flex-shrink-0 business-radius-badge border border-gray-300 [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none [&]:!text-[12px] [&]:!font-medium [&]:!leading-tight",style:{height:"auto",padding:"2px 6px",minHeight:"auto",maxHeight:"none",lineHeight:"1.25"}}),s.jsxs(r,{type:"button",onClick:()=>{for(let e=0;e<D;e++)_e({line_number:ge.length+1+e,item_name:"",specification:"",quantity:1,unit_price_value:0,unit_price_currency:G,amount_value:0,amount_currency:G,remark:"",link:""})},className:"button-base bg-blue-500 hover:bg-blue-600 text-white",children:[s.jsx(S,{className:"w-3 h-3 mr-0.5"}),"추가"]})]})]}),s.jsx("div",{className:"overflow-x-auto",children:s.jsx("div",{className:"max-h-[500px] overflow-y-auto",children:s.jsxs("table",{className:"w-full text-xs",children:[s.jsx("thead",{className:"bg-gray-50 sticky top-0 z-10",children:s.jsxs("tr",{className:"border-b border-gray-200",children:[s.jsx("th",{className:"px-2 py-2 text-left font-medium text-gray-700 w-10",children:"#"}),s.jsxs("th",{className:"px-2 py-2 text-left font-medium text-gray-700 min-w-[100px] sm:min-w-[120px]",children:["품목",s.jsx("span",{className:"text-red-500",children:"*"})]}),s.jsx("th",{className:"px-2 py-2 text-left font-medium text-gray-700 min-w-[250px] sm:min-w-[320px]",children:"규격"}),s.jsxs("th",{className:"px-2 py-2 text-center font-medium text-gray-700 w-20",children:["수량",s.jsx("span",{className:"text-red-500",children:"*"})]}),s.jsxs("th",{className:"px-2 py-2 text-right font-medium text-gray-700 w-[140px] sm:w-[160px]",children:["단가 (",G,")"]}),s.jsxs("th",{className:"px-2 py-2 text-right font-medium text-gray-700 min-w-[110px] sm:min-w-[140px]",children:["합계 (",G,")"]}),"구매 요청"===Ce&&s.jsx("th",{className:"px-2 py-2 text-left font-medium text-gray-700 min-w-[120px] sm:min-w-[150px]",children:"링크"}),s.jsx("th",{className:"px-2 py-2 text-left font-medium text-gray-700 min-w-[100px] sm:min-w-[150px]",children:"비고"}),s.jsx("th",{className:"px-2 py-2 text-center font-medium text-gray-700 w-10"})]})}),s.jsx("tbody",{className:"bg-white",children:ge.map((e,t)=>s.jsxs("tr",{className:"border-b border-gray-100 hover:bg-gray-50",children:[s.jsx("td",{className:"px-2 py-1 text-center text-gray-500",children:t+1}),s.jsx("td",{className:"px-2 py-1",children:s.jsx(o,{value:e.item_name,onChange:a=>be(t,{...e,item_name:a.target.value}),className:"h-7 w-full bg-white border border-gray-200 text-xs",placeholder:"품목명 입력"})}),s.jsx("td",{className:"px-2 py-1",children:s.jsx(o,{value:e.specification,onChange:a=>be(t,{...e,specification:a.target.value}),className:"h-7 w-full bg-white border border-gray-200 text-xs",placeholder:"규격 입력"})}),s.jsx("td",{className:"px-2 py-1",children:s.jsx(o,{type:"number",min:"1",value:e.quantity||"",className:"h-7 w-20 bg-white border border-gray-200 text-xs text-center [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none",placeholder:"0",onChange:a=>{const s=parseInt(a.target.value)||0;be(t,{...e,quantity:s})}})}),s.jsx("td",{className:"px-2 py-1",children:s.jsxs("div",{className:"flex items-center",children:[s.jsx(o,{type:"text",inputMode:"decimal",value:te[`${t}_unit_price_value`]??(0===e.unit_price_value?"":e.unit_price_value?.toLocaleString("ko-KR")||""),onChange:a=>{const s=a.target.value.replace(/,/g,"").replace(/[^0-9.]/g,""),r=s.split("."),n=r.length>2?r[0]+"."+r.slice(1).join(""):s;ae(e=>({...e,[`${t}_unit_price_value`]:n}));const i=""===n?0:parseFloat(n)||0;be(t,{...e,unit_price_value:i})},onBlur:()=>{ae(e=>{const a={...e};return delete a[`${t}_unit_price_value`],a})},className:"h-7 w-32 bg-white border border-gray-200 text-xs text-right",placeholder:"0"}),s.jsx("span",{className:"ml-1 text-xs text-gray-500",children:"KRW"===G?"₩":"$"})]})}),s.jsx("td",{className:"px-2 py-1",children:s.jsxs("div",{className:"flex items-center justify-end",children:[s.jsx("span",{className:"text-xs text-right font-medium",children:(e.amount_value||0).toLocaleString("ko-KR")}),s.jsx("span",{className:"ml-1 text-xs text-gray-500",children:"KRW"===G?"₩":"$"})]})}),"구매 요청"===Ce&&s.jsx("td",{className:"px-2 py-1",children:s.jsx(o,{value:e.link||"",onChange:a=>be(t,{...e,link:a.target.value}),type:"url",className:"h-7 w-full bg-white border border-gray-200 text-xs",placeholder:"https://..."})}),s.jsx("td",{className:"px-2 py-1",children:s.jsx(o,{value:e.remark||"",onChange:a=>be(t,{...e,remark:a.target.value}),className:"h-7 w-full bg-white border border-gray-200 text-xs",placeholder:"비고"})}),s.jsx("td",{className:"px-2 py-1 text-center",children:ge.length>1&&s.jsx(r,{type:"button",onClick:()=>ve(t),size:"sm",variant:"ghost",className:"h-6 w-6 p-0 hover:bg-red-50",children:s.jsx(n,{className:"w-3 h-3 text-red-600"})})})]},t))})]})})})]}),s.jsxs("div",{className:"flex justify-end gap-3 mt-2",children:[s.jsx(r,{type:"button",variant:"outline",onClick:()=>q(-1),className:"button-base border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 hover:border-gray-400",children:"취소"}),s.jsx(r,{type:"submit",disabled:X||!je,className:"button-base bg-hansl-600 hover:bg-hansl-700 text-white",children:X?s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}),"처리 중..."]}):s.jsxs(s.Fragment,{children:[s.jsx(k,{className:"w-4 h-4 mr-2"}),"발주요청"]})})]})]})]}),Z&&s.jsx("div",{className:"mt-4 p-3 bg-red-50 border border-red-200 rounded-md text-red-700 text-sm",children:Z}),s.jsx(l,{open:se,onOpenChange:re,children:s.jsxs(d,{className:"w-full max-w-[95vw] sm:max-w-3xl max-h-[80vh] overflow-y-auto",children:[s.jsx(c,{children:s.jsx(m,{children:"담당자 관리"})}),s.jsx("div",{className:"space-y-4",children:ne.map((e,t)=>s.jsxs("div",{className:"flex gap-2 items-end",children:[s.jsxs("div",{className:"flex-1",children:[s.jsx(h,{className:"text-xs",children:"이름"}),s.jsx(o,{value:e.contact_name,onChange:e=>qe(t,"contact_name",e.target.value),placeholder:"담당자 이름",className:"h-9"})]}),s.jsxs("div",{className:"flex-1",children:[s.jsx(h,{className:"text-xs",children:"이메일"}),s.jsx(o,{value:e.contact_email,onChange:e=>qe(t,"contact_email",e.target.value),placeholder:"이메일",className:"h-9"})]}),s.jsxs("div",{className:"flex-1",children:[s.jsx(h,{className:"text-xs",children:"전화번호"}),s.jsx(o,{value:e.contact_phone,onChange:e=>qe(t,"contact_phone",e.target.value),placeholder:"전화번호",className:"h-9"})]}),s.jsxs("div",{className:"flex-1",children:[s.jsx(h,{className:"text-xs",children:"직책"}),s.jsx(o,{value:e.position,onChange:e=>qe(t,"position",e.target.value),placeholder:"직책",className:"h-9"})]}),s.jsx(r,{type:"button",size:"sm",variant:"ghost",onClick:()=>(e=>{ie(t=>t.filter((t,a)=>a!==e)),le(!0)})(t),className:"h-9 px-2",children:s.jsx(n,{className:"h-4 w-4"})})]},t))}),s.jsxs(p,{className:"gap-2",children:[s.jsxs(r,{type:"button",variant:"outline",onClick:()=>{ie(e=>[...e,{contact_name:"",contact_email:"",contact_phone:"",position:"",isNew:!0}]),le(!0)},size:"sm",children:[s.jsx(S,{className:"h-4 w-4 mr-1"}),"담당자 추가"]}),s.jsx(x,{asChild:!0,children:s.jsx(r,{type:"button",variant:"outline",size:"sm",children:"취소"})}),s.jsx(r,{type:"button",onClick:async()=>{if(ye)try{if(ne.filter(e=>e.contact_email&&e.contact_email.endsWith("@hansl.io")).length>0)return void alert("한슬 직원 이메일은 업체 담당자로 등록할 수 없습니다.");for(const t of ne)t.contact_name&&t.contact_email&&(!t.isNew&&t.id?await C.from("vendor_contacts").update({contact_name:t.contact_name,contact_email:t.contact_email,contact_phone:t.contact_phone||"",position:t.position||""}).eq("id",t.id):t.isNew&&await C.from("vendor_contacts").insert({vendor_id:ye,contact_name:t.contact_name,contact_email:t.contact_email,contact_phone:t.contact_phone||"",position:t.position||""}));const{data:e}=await C.from("vendor_contacts").select("id, contact_name, contact_email, contact_phone, position").eq("vendor_id",ye);e&&B(e),re(!1),j.success("담당자 정보가 저장되었습니다.")}catch(e){j.error("담당자 저장에 실패했습니다.")}},disabled:!oe,size:"sm",children:"저장"})]})]})})]})}export{q as default};
//# sourceMappingURL=PurchaseNewMain-7LiZjzZh.js.map
