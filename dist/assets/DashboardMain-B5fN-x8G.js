import{c as I,a as K,u as ae,r as N,j as e,F as re,B as v,S as z}from"./index-C0FAzD3m.js";import{B as j,t as D}from"./index-BxJnWAhi.js";import{C as P,a as A,b as O,c as M,E as ge}from"./card-uOpkqlwt.js";import{D as ne,a as le,b as ie,c as ce,d as de}from"./input-DaTkxl0w.js";import{E as _e}from"./exceljs.min-C8vExLsi.js";import{P as V,a as ye}from"./PurchaseDetailModal-DVHyq9uz.js";import{C as E}from"./pen-BGLtDehW.js";import{C as fe}from"./credit-card-CFwNpsyk.js";import{D as J}from"./download-DQVlhkO8.js";import"./plus-CqeW5uEq.js";import"./save-DYJzTmaz.js";/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]],Y=I("arrow-right",je);/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=[["path",{d:"M12 6v6l4 2",key:"mmk7yg"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],Q=I("clock",be);/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ve=[["path",{d:"M7 10v12",key:"1qc93n"}],["path",{d:"M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z",key:"emmmcr"}]],Ne=I("thumbs-up",ve);/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const we=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]],qe=I("triangle-alert",we);/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=[["path",{d:"M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2",key:"wrbu53"}],["path",{d:"M15 18H9",key:"1lyqi6"}],["path",{d:"M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14",key:"lysw3i"}],["circle",{cx:"17",cy:"18",r:"2",key:"332jqn"}],["circle",{cx:"7",cy:"18",r:"2",key:"19iecd"}]],Z=I("truck",Se);class De{constructor(){this.supabase=K()}parseRoles(r){let t=[];return r&&(Array.isArray(r)?t=r.map(n=>String(n).trim()):t=String(r).split(",").map(a=>a.trim()).filter(a=>a.length>0)),t}async getDashboardData(r){const[t,n,a,o,d,l,m]=await Promise.all([this.getDashboardStats(r),this.getUrgentRequests(r),this.getMyRecentRequests(r),this.getPendingApprovals(r),this.getQuickActions(r),this.getTodaySummary(r),this.getMyPurchaseStatus(r)]);return{employee:r,stats:t,urgentRequests:n,myRecentRequests:a,pendingApprovals:o,quickActions:d,todaySummary:l,myPurchaseStatus:m}}async getDashboardStats(r){const t=new Date().toISOString().split("T")[0],n=this.parseRoles(r.purchase_role),[a,o,d,l,m,x]=await Promise.all([this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("requester_name",r.name),this.getPendingCount(r,n),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("is_received",!0).gte("received_at",new Date(new Date().getFullYear(),new Date().getMonth(),1).toISOString()),this.getUrgentCount(r,n),this.getTodayActionsCount(r,t)]);return{total:a.count||0,myRequests:o.count||0,pending:d,completed:l.count||0,urgent:m,todayActions:x}}async getUrgentRequests(r){const t=new Date(Date.now()-2592e5).toISOString(),n=this.parseRoles(r.purchase_role);if(n.length===0)return[];let a=this.supabase.from("purchase_requests").select("*,vendors(vendor_name),purchase_request_items(id)").lt("created_at",t);if(n.includes("app_admin"))a=a.or("middle_manager_status.eq.pending,final_manager_status.eq.pending,purchase_status.eq.pending");else if(n.includes("middle_manager"))a=a.eq("middle_manager_status","pending");else if(n.includes("final_approver")||n.includes("ceo"))a=a.eq("middle_manager_status","approved").eq("final_manager_status","pending");else if(n.includes("lead_buyer"))a=a.eq("final_manager_status","approved").eq("purchase_status","pending");else return[];const{data:o}=await a.order("created_at",{ascending:!0}).limit(5);return(o||[]).map(d=>({...d,vendor_name:d.vendors?.vendor_name,total_items:d.purchase_request_items?.length||0,daysOverdue:Math.floor((Date.now()-new Date(d.created_at).getTime())/(1e3*60*60*24)),priority:this.calculatePriority(d),urgentReason:this.getUrgentReason(d,n)}))}async getMyRecentRequests(r){const{data:t}=await this.supabase.from("purchase_requests").select("*,vendors(vendor_name),purchase_request_items(id)").eq("requester_name",r.name).or("middle_manager_status.eq.pending,final_manager_status.eq.pending").order("created_at",{ascending:!1}).limit(5);return(t||[]).map(n=>({...n,vendor_name:n.vendors?.vendor_name,total_items:n.purchase_request_items?.length||0,progress_percentage:this.calculateProgress(n),current_step:this.getCurrentStep(n),next_action:this.getNextAction(n),estimated_completion:this.estimateCompletion(n)}))}async getPendingApprovals(r){const t=this.parseRoles(r.purchase_role);let n=null;const a=await this.supabase.from("purchase_requests").select("*,vendors(vendor_name),purchase_request_items(item_name,quantity,unit_price_value,amount_value)").order("request_date",{ascending:!1}).limit(100);if(a.error){a.error;const l=await this.supabase.from("purchase_requests").select("*").order("request_date",{ascending:!1}).limit(100);if(l.error)return[];n=l.data||[]}else n=a.data||[];let o=n||[];const d=l=>l==="pending"||l==="ëŒ€ê¸°"||l===""||l===null||l===void 0;if(t.includes("app_admin"))o=o.filter(l=>d(l.middle_manager_status)||l.middle_manager_status==="approved"&&d(l.final_manager_status));else if(t.includes("middle_manager"))o=o.filter(l=>d(l.middle_manager_status));else if(t.includes("raw_material_manager"))o=o.filter(l=>l.middle_manager_status==="approved"&&d(l.final_manager_status)&&l.payment_category==="ë°œì£¼ìš”ì²­");else if(t.includes("consumable_manager"))o=o.filter(l=>l.middle_manager_status==="approved"&&d(l.final_manager_status)&&l.payment_category==="êµ¬ë§¤ìš”ì²­");else if(t.some(l=>["final_approver","ceo"].includes(l)))o=o.filter(l=>l.middle_manager_status==="approved"&&d(l.final_manager_status));else if(t.includes("lead_buyer"))o=[];else return[];return o.map(l=>({...l,vendor_name:l.vendors?.vendor_name,purchase_request_items:l.purchase_request_items||l.items||[],total_amount:(l.purchase_request_items||l.items||[]).reduce((m,x)=>{const _=Number(x?.amount_value)||(Number(x?.quantity)||0)*(Number(x?.unit_price_value)||0);return m+_},0)}))}async getQuickActions(r){const t=this.parseRoles(r.purchase_role),n=[];if(t.includes("app_admin")||t.includes("middle_manager")||t.includes("final_approver")||t.includes("ceo")){const a=await this.getPendingCount(r,t);a>0&&n.push({id:"approve",type:"approve",label:"ìŠ¹ì¸ ëŒ€ê¸°",description:`${a}ê±´ì˜ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘`,count:a,color:"red"})}if(t.includes("lead_buyer")){const{count:a}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("final_manager_status","approved").eq("purchase_status","pending");a&&a>0&&n.push({id:"purchase",type:"purchase",label:"êµ¬ë§¤ ì²˜ë¦¬",description:`${a}ê±´ì˜ êµ¬ë§¤ ëŒ€ê¸° ì¤‘`,count:a,color:"yellow"})}return n}async getTodaySummary(r){const t=new Date().toISOString().split("T")[0],n=new Date(Date.now()+1440*60*1e3).toISOString().split("T")[0],[a,o,d]=await Promise.all([this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).gte("updated_at",t).lt("updated_at",n).or("middle_manager_status.eq.approved,final_manager_status.eq.approved"),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("requester_name",r.name).gte("created_at",t).lt("created_at",n),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("is_received",!0).gte("received_at",t).lt("received_at",n)]);return{approved:a.count||0,requested:o.count||0,received:d.count||0}}async getMyPurchaseStatus(r){const t=new Date(Date.now()-6048e5).toISOString(),n=await this.supabase.from("purchase_requests").select("*,vendors(vendor_name),purchase_request_items(item_name,quantity,specification,amount_value)").eq("requester_name",r.name).order("created_at",{ascending:!1}).limit(100);if(n.error)return console.error("getMyPurchaseStatus ì—ëŸ¬:",n.error),{waitingPurchase:[],waitingDelivery:[],recentCompleted:[]};const a=n.data||[],o=a.filter(m=>{const x=m.payment_category==="êµ¬ë§¤ ìš”ì²­"||m.payment_category==="êµ¬ë§¤ìš”ì²­"||m.payment_category==="ë°œì£¼ ìš”ì²­"||m.payment_category==="ë°œì£¼ìš”ì²­",_=!m.is_payment_completed,S=(m.progress_type||"").includes("ì„ ì§„í–‰");if(x&&_&&S)return!0;const C=(m.progress_type||"").includes("ì¼ë°˜")||!m.progress_type||m.progress_type==="",$=m.final_manager_status==="approved";return x&&_&&C&&$}).slice(0,10),d=a.filter(m=>{const x=!m.is_received,_=(m.progress_type||"").includes("ì„ ì§„í–‰");if(x&&_)return!0;const S=m.final_manager_status==="approved";return x&&S}).slice(0,10),l=a.filter(m=>{if(m.is_received!==!0||!m.received_at)return!1;const x=new Date(m.received_at),_=new Date(t);return x>=_}).slice(0,10);return{waitingPurchase:o,waitingDelivery:d,recentCompleted:l}}async quickApprove(r,t){try{const n=this.parseRoles(t.purchase_role),{data:a}=await this.supabase.from("purchase_requests").select("middle_manager_status, final_manager_status").eq("id",r).single();if(!a)return{success:!1,error:"ìš”ì²­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."};let o={};const d=x=>x==="pending"||x==="ëŒ€ê¸°"||x===""||x===null||x===void 0;if(n.includes("app_admin")?d(a.middle_manager_status)?o={middle_manager_status:"approved"}:a.middle_manager_status==="approved"&&d(a.final_manager_status)&&(o={final_manager_status:"approved"}):n.includes("middle_manager")?d(a.middle_manager_status)&&(o={middle_manager_status:"approved"}):n.includes("final_approver")||n.includes("ceo")?a.middle_manager_status==="approved"&&d(a.final_manager_status)&&(o={final_manager_status:"approved"}):(n.includes("raw_material_manager")||n.includes("consumable_manager"))&&a.middle_manager_status==="approved"&&d(a.final_manager_status)&&(o={final_manager_status:"approved"}),Object.keys(o).length===0)return{success:!1,error:"ìŠ¹ì¸í•  ìˆ˜ ìˆëŠ” ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤."};const{data:l,error:m}=await this.supabase.from("purchase_requests").update(o).eq("id",r).select().single();if(m)throw m;return{success:!0}}catch(n){return{success:!1,error:n.message}}}async getPendingCount(r,t){if(t.includes("app_admin")){const[n,a,o]=await Promise.all([this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).or("middle_manager_status.in.(pending,ëŒ€ê¸°),middle_manager_status.is.null"),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("middle_manager_status","approved").or("final_manager_status.in.(pending,ëŒ€ê¸°),final_manager_status.is.null"),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("final_manager_status","approved").or("purchase_status.in.(pending,ëŒ€ê¸°),purchase_status.is.null")]);return(n.count||0)+(a.count||0)+(o.count||0)}if(t.includes("middle_manager")){const{count:n,error:a}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).or("middle_manager_status.in.(pending,ëŒ€ê¸°),middle_manager_status.is.null");return a?0:n||0}if(t.includes("final_approver")||t.includes("ceo")){const{count:n,error:a}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("middle_manager_status","approved").or("final_manager_status.in.(pending,ëŒ€ê¸°),final_manager_status.is.null");return a?0:n||0}if(t.includes("lead_buyer")){const{count:n,error:a}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("final_manager_status","approved").or("purchase_status.in.(pending,ëŒ€ê¸°),purchase_status.is.null");return a?0:n||0}return 0}async getUrgentCount(r,t){if(t.length===0)return 0;const n=new Date(Date.now()-4320*60*1e3).toISOString();let a=this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).lt("created_at",n);if(t.includes("app_admin"))a=a.or("middle_manager_status.eq.pending,final_manager_status.eq.pending,purchase_status.eq.pending");else if(t.includes("middle_manager"))a=a.eq("middle_manager_status","pending");else if(t.includes("final_approver")||t.includes("ceo"))a=a.eq("middle_manager_status","approved").eq("final_manager_status","pending");else if(t.includes("lead_buyer"))a=a.eq("final_manager_status","approved").eq("purchase_status","pending");else return 0;const{count:o}=await a;return o||0}async getTodayActionsCount(r,t){const n=new Date(Date.now()+864e5).toISOString().split("T")[0],{count:a}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).gte("updated_at",t).lt("updated_at",n).or(`middle_manager_id.eq.${r.id},final_manager_id.eq.${r.id}`);return a||0}calculatePriority(r){const t=Math.floor((Date.now()-new Date(r.created_at).getTime())/864e5);return t>=7?"high":t>=5?"medium":"low"}getUrgentReason(r,t){return t.includes("middle_manager")&&r.middle_manager_status==="pending"||(t.includes("final_approver")||t.includes("ceo"))&&r.final_manager_status==="pending"?"overdue_approval":r.is_received?"payment_pending":"delivery_delay"}calculateProgress(r){let t=0;return r.middle_manager_status==="approved"&&(t+=25),r.final_manager_status==="approved"&&(t+=25),r.is_payment_completed&&(t+=25),r.is_received&&(t+=25),t}getCurrentStep(r){return r.is_received?"completed":r.is_payment_completed?"delivery":r.final_manager_status==="approved"?"purchase":"approval"}getNextAction(r){return r.middle_manager_status==="pending"?"ì¤‘ê°„ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘":r.final_manager_status==="pending"?"ìµœì¢… ìŠ¹ì¸ ëŒ€ê¸° ì¤‘":r.is_payment_completed?r.is_received?"ì™„ë£Œ":"ì…ê³  ëŒ€ê¸° ì¤‘":"êµ¬ë§¤ ì²˜ë¦¬ ëŒ€ê¸° ì¤‘"}estimateCompletion(r){const t=new Date(r.created_at);Math.floor((new Date().getTime()-t.getTime())/(1e3*60*60*24));let a=7;return r.progress_type==="ê¸´ê¸‰"&&(a=3),new Date(t.getTime()+a*24*60*60*1e3).toLocaleDateString("ko-KR")}async getUndownloadedOrders(r){const t=this.parseRoles(r.purchase_role);if(!t.includes("lead_buyer")&&!t.includes("lead buyer"))return[];const{data:n,error:a}=await this.supabase.from("purchase_requests").select("*,purchase_request_items(id,item_name,specification,quantity,unit_price_value,amount_value)").order("created_at",{ascending:!1}).limit(100);if(a)return console.error("Failed to fetch undownloaded orders:",a),[];const o=(n||[]).filter(d=>{const l=d.progress_type==="ì„ ì§„í–‰"||d.middle_manager_status==="approved"&&d.final_manager_status==="approved",m=!d.is_po_download||d.is_po_download===!1||d.is_po_download===null;return l&&m});return o.sort((d,l)=>new Date(d.created_at).getTime()-new Date(l.created_at).getTime()),o.slice(0,10)}}const W=new De;function ke({isOpen:c,onClose:r,item:t,type:n,onRefresh:a}){const o=ae(),d=K(),[l,m]=N.useState([]),[x,_]=N.useState(!1);if(N.useEffect(()=>{(async()=>{const{data:{user:p}}=await d.auth.getUser();if(p?.email){const{data:k}=await d.from("employees").select("purchase_role").eq("email",p.email).single();if(k?.purchase_role){const T=k.purchase_role.split(",").map(U=>U.trim());m(T)}}})()},[]),!t)return null;const S=t.purchase_request_items||[],C=S.reduce((h,p)=>h+(Number(p.amount_value)||0),0);S.reduce((h,p)=>h+(Number(p.quantity)||0),0);const L=(()=>{switch(n){case"purchase":return{icon:e.jsx(z,{className:"w-6 h-6 text-yellow-600"}),title:"êµ¬ë§¤ ëŒ€ê¸°",status:"êµ¬ë§¤ ì²˜ë¦¬ ëŒ€ê¸°ì¤‘",color:"bg-yellow-50 text-yellow-700 border-yellow-200"};case"delivery":return{icon:e.jsx(Z,{className:"w-6 h-6 text-blue-600"}),title:"ì…ê³  ëŒ€ê¸°",status:"ì…ê³  ì²˜ë¦¬ ëŒ€ê¸°ì¤‘",color:"bg-blue-50 text-blue-700 border-blue-200"};case"completed":return{icon:e.jsx(E,{className:"w-6 h-6 text-green-600"}),title:"ì²˜ë¦¬ ì™„ë£Œ",status:"ëª¨ë“  ì²˜ë¦¬ ì™„ë£Œ",color:"bg-green-50 text-green-700 border-green-200"}}})();return e.jsx(ne,{open:c,onOpenChange:r,children:e.jsxs(le,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(ie,{children:[e.jsxs(ce,{className:"text-xl font-bold",children:[t.purchase_order_number||"POë²ˆí˜¸ ì—†ìŒ"," ìƒì„¸ë³´ê¸°"]}),e.jsx(de,{children:t.vendor_name||"ì—…ì²´ëª… ì—†ìŒ"})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsxs("h3",{className:"font-semibold mb-3 flex items-center",children:[e.jsx(re,{className:"w-4 h-4 mr-2"}),"ê¸°ë³¸ ì •ë³´"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"ìš”ì²­ì"}),e.jsx("p",{className:"font-medium",children:t.requester_name})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"ìš”ì²­ì¼"}),e.jsx("p",{className:"font-medium",children:new Date(t.request_date||t.created_at).toLocaleDateString("ko-KR")})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"ë‚©ê¸°ìš”ì²­ì¼"}),e.jsx("p",{className:"font-medium",children:t.delivery_request_date?new Date(t.delivery_request_date).toLocaleDateString("ko-KR"):"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"ì¹´í…Œê³ ë¦¬"}),e.jsx("p",{className:"font-medium",children:t.payment_category||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"ìƒíƒœ"}),e.jsx("p",{className:"font-medium",children:e.jsx(j,{className:L.color,children:L.title})})]})]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsxs("h3",{className:"font-semibold mb-3 flex items-center",children:[e.jsx(V,{className:"w-4 h-4 mr-2"}),"í’ˆëª© ë¦¬ìŠ¤íŠ¸"]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{className:"bg-white",children:e.jsxs("tr",{children:[n==="delivery"&&e.jsx("th",{className:"px-3 py-2 text-center text-xs font-medium text-gray-500",children:"ì…ê³ "}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500",children:"í’ˆëª…"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500",children:"ê·œê²©"}),e.jsx("th",{className:"px-3 py-2 text-center text-xs font-medium text-gray-500",children:"ìˆ˜ëŸ‰"}),e.jsx("th",{className:"px-3 py-2 text-right text-xs font-medium text-gray-500",children:"ë‹¨ê°€"}),e.jsx("th",{className:"px-3 py-2 text-right text-xs font-medium text-gray-500",children:"ê¸ˆì•¡"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500",children:"ë¹„ê³ "})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:S.map((h,p)=>{const k=h.quantity>0?(Number(h.amount_value)||0)/h.quantity:0;return e.jsxs("tr",{children:[n==="delivery"&&e.jsx("td",{className:"px-3 py-2 text-center",children:e.jsx("div",{className:"flex items-center justify-center",children:h.is_received?e.jsx(j,{className:"bg-green-100 text-green-800 text-xs",children:"ì…ê³ ì™„ë£Œ"}):e.jsx(j,{variant:"outline",className:"text-gray-600 text-xs",children:"ë¯¸ì…ê³ "})})}),e.jsx("td",{className:"px-3 py-2",children:e.jsx("span",{className:"text-sm",children:h.item_name||"í’ˆëª©ëª… ì—†ìŒ"})}),e.jsx("td",{className:"px-3 py-2",children:e.jsx("span",{className:"text-sm",children:h.specification||"-"})}),e.jsx("td",{className:"px-3 py-2 text-center",children:e.jsx("span",{className:"text-sm",children:h.quantity||0})}),e.jsx("td",{className:"px-3 py-2 text-right",children:e.jsxs("span",{className:"text-sm",children:["â‚©",k.toLocaleString()]})}),e.jsx("td",{className:"px-3 py-2 text-right",children:e.jsxs("span",{className:"text-sm",children:["â‚©",(Number(h.amount_value)||0).toLocaleString()]})}),e.jsx("td",{className:"px-3 py-2",children:e.jsx("span",{className:"text-sm",children:h.remark||"-"})})]},p)})})]})}),e.jsx("div",{className:"mt-4 pt-4 border-t border-gray-200 bg-white p-3 rounded",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"font-semibold",children:"ì´ì•¡"}),e.jsxs("span",{className:"font-bold text-lg",children:["â‚©",C.toLocaleString()]})]})})]}),n==="delivery"&&S.length>1&&e.jsxs("div",{className:"bg-blue-50 rounded-lg p-4",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900 mb-3",children:"ì…ê³  ì§„í–‰ í˜„í™©"}),(()=>{const h=S.filter(T=>T.is_received).length,p=S.length,k=h/p*100;return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"ì…ê³  ì™„ë£Œ"}),e.jsxs("span",{className:"font-medium text-gray-900",children:[h,"/",p,"ê°œ (",k.toFixed(0),"%)"]})]}),e.jsx("div",{className:"w-full bg-blue-200 rounded-full h-2 overflow-hidden",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-300",style:{width:`${k}%`}})})]})})()]}),e.jsxs("div",{className:"flex justify-between gap-3 mt-6",children:[e.jsxs("div",{className:"flex gap-2",children:[n==="delivery"&&e.jsxs(v,{onClick:async()=>{_(!0);try{const{error:h}=await d.from("purchase_requests").update({is_received:!0,received_at:new Date().toISOString()}).eq("id",t.id);if(h)throw h;await d.from("purchase_request_items").update({is_received:!0,delivery_status:"received"}).eq("purchase_request_id",t.id),D.success("ì…ê³ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."),a?.(),r()}catch{D.error("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}finally{_(!1)}},disabled:x,className:"bg-blue-600 hover:bg-blue-700",size:"sm",children:[x?e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}):e.jsx(E,{className:"w-4 h-4 mr-2"}),"ì…ê³  ì™„ë£Œ ì²˜ë¦¬"]}),n==="purchase"&&(l.includes("app_admin")||l.includes("lead_buyer")||l.includes("final_approver")||l.includes("ceo"))&&e.jsxs(v,{onClick:async()=>{_(!0);try{const{error:h}=await d.from("purchase_requests").update({is_payment_completed:!0,payment_completed_at:new Date().toISOString()}).eq("id",t.id);if(h)throw h;D.success("êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."),a?.(),r()}catch{D.error("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}finally{_(!1)}},disabled:x,className:"bg-yellow-600 hover:bg-yellow-700",size:"sm",children:[x?e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}):e.jsx(fe,{className:"w-4 h-4 mr-2"}),"êµ¬ë§¤ ì™„ë£Œ ì²˜ë¦¬"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(v,{variant:"outline",onClick:()=>{o(`/purchase?highlight=${t.id}`),r()},size:"sm",children:["ë°œì£¼ ëª©ë¡ì—ì„œ ë³´ê¸°",e.jsx(Y,{className:"w-4 h-4 ml-2"})]}),e.jsx(v,{variant:"ghost",onClick:r,size:"sm",children:"ë‹«ê¸°"})]})]})]})]})})}function Ie(){const[c,r]=N.useState(null),[t,n]=N.useState(!0),[a,o]=N.useState(null),[d,l]=N.useState(null),[m,x]=N.useState(!1),[_,S]=N.useState([]),[C,$]=N.useState([]),[L,h]=N.useState(new Set),[p,k]=N.useState(null),[T,U]=N.useState(!1),[oe,G]=N.useState(null),[me,X]=N.useState(null),[ue,ee]=N.useState(!1),R=ae(),xe=K();N.useEffect(()=>{F()},[]);const F=async(s=!0)=>{try{s&&n(!0);const i=K(),{data:{user:u},error:b}=await i.auth.getUser();if(b){console.error("Auth error:",b),D.error("ì¸ì¦ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");return}if(!u){console.error("No user found in auth"),D.error("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");return}const{data:g,error:y}=await i.from("employees").select("*").eq("email",u.email).single();if(y||!g){console.error("Employee fetch error:",y);return}const w=await W.getDashboardData(g);if(r(w),g.purchase_role){const q=Array.isArray(g.purchase_role)?g.purchase_role.map(f=>String(f).trim()):String(g.purchase_role).split(",").map(f=>f.trim()).filter(f=>f.length>0);if(S(q),q.includes("lead_buyer")||q.includes("lead buyer")){const f=await W.getUndownloadedOrders(g);$(f)}}}catch{}finally{s&&n(!1)}},se=async s=>{if(!c?.employee){D.error("ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");return}if(!confirm("ì •ë§ë¡œ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"))return;o(s);const i=c;r(u=>u&&{...u,pendingApprovals:u.pendingApprovals.filter(b=>b.id!==s),stats:{...u.stats,pending:Math.max(0,u.stats.pending-1)}});try{const u=await W.quickApprove(s,c.employee);u.success?(D.success("ìŠ¹ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."),setTimeout(()=>{F(!1)},1e3)):(r(i),D.error(u.error||"ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."))}catch{r(i),D.error("ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}finally{o(null)}},B=(s,i)=>{G(s),X(i),ee(!0)},te=async s=>{try{h(f=>new Set(f).add(s.id));const i=new _e.Workbook,u=i.addWorksheet("ë°œì£¼ì„œ");u.columns=[{header:"ë°œì£¼ë²ˆí˜¸",key:"purchase_order_number",width:20},{header:"ì—…ì²´ëª…",key:"vendor_name",width:30},{header:"í’ˆëª©ëª…",key:"item_name",width:40},{header:"ê·œê²©",key:"specification",width:30},{header:"ìˆ˜ëŸ‰",key:"quantity",width:15},{header:"ë‹¨ê°€",key:"unit_price",width:20},{header:"ê¸ˆì•¡",key:"amount",width:20},{header:"ìš”ì²­ì¼",key:"request_date",width:15},{header:"ì§„í–‰ìƒíƒœ",key:"progress_type",width:15}],(s.purchase_request_items||[]).forEach(f=>{u.addRow({purchase_order_number:s.purchase_order_number,vendor_name:s.vendor_name||s.vendors?.vendor_name||"",item_name:f.item_name||"",specification:f.specification||"",quantity:f.quantity||0,unit_price:f.unit_price_value||0,amount:f.amount_value||0,request_date:s.request_date||"",progress_type:s.progress_type||""})}),u.getRow(1).font={bold:!0},u.getRow(1).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFE0E0E0"}};const g=await i.xlsx.writeBuffer(),y=new Blob([g],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),w=window.URL.createObjectURL(y),q=document.createElement("a");q.href=w,q.download=`ë°œì£¼ì„œ_${s.purchase_order_number}_${new Date().toISOString().slice(0,10)}.xlsx`,q.click(),window.URL.revokeObjectURL(w),(_.includes("lead_buyer")||_.includes("lead buyer"))&&(await xe.from("purchase_requests").update({is_po_download:!0}).eq("id",s.id),$(f=>f.filter(H=>H.id!==s.id))),D.success("ë°œì£¼ì„œê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.")}catch(i){console.error("Excel download error:",i),D.error("ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}finally{h(i=>{const u=new Set(i);return u.delete(s.id),u})}},he=s=>{switch(s){case"high":return"bg-red-100 text-red-800 border-red-200";case"medium":return"bg-yellow-100 text-yellow-800 border-yellow-200";case"low":return"bg-green-100 text-green-800 border-green-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}};if(t)return e.jsx("div",{className:"flex items-center justify-center h-screen bg-gray-50",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-12 h-12 border-3 border-hansl-500 border-t-transparent rounded-full animate-spin mx-auto"}),e.jsx("p",{className:"mt-4 text-sm text-gray-600",children:"ëŒ€ì‹œë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤..."})]})});if(!c?.employee)return e.jsx("div",{className:"flex items-center justify-center h-screen bg-gray-50",children:e.jsxs("div",{className:"text-center bg-white p-8 rounded-lg border border-gray-200",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"}),e.jsx("p",{className:"text-sm text-gray-600",children:"ë¡œê·¸ì¸ì„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."})]})});const pe=(Array.isArray(c.employee.purchase_role)?c.employee.purchase_role.map(s=>String(s).trim()):c.employee.purchase_role?String(c.employee.purchase_role).split(",").map(s=>s.trim()).filter(s=>s.length>0):[]).some(s=>["middle_manager","final_approver","app_admin","raw_material_manager","consumable_manager"].includes(s));return e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsxs("div",{className:"w-full px-4 lg:px-6",children:[e.jsx("div",{className:"mb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-gray-900",children:"ëŒ€ì‹œë³´ë“œ"}),e.jsxs("p",{className:"text-xs text-gray-600 mt-0.5",children:[c.employee.name,"ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤. ğŸ“Š"]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(j,{variant:"outline",className:"text-xs",children:new Date().toLocaleDateString("ko-KR",{month:"long",day:"numeric",weekday:"short"})})})]})}),c.urgentRequests.length>0&&e.jsxs(P,{className:"mb-3 border-red-200 bg-red-50",children:[e.jsx(A,{className:"pb-2 pt-3",children:e.jsxs(O,{className:"flex items-center gap-2 text-red-800 text-sm",children:[e.jsx(qe,{className:"w-4 h-4"}),"ê¸´ê¸‰ ì²˜ë¦¬ í•„ìš” (",c.urgentRequests.length,"ê±´)"]})}),e.jsx(M,{className:"p-3",children:e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2",children:c.urgentRequests.slice(0,5).map(s=>e.jsx("div",{className:"bg-white rounded-lg p-2 border border-red-200 min-w-[280px] flex-shrink-0",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-1 mb-1",children:[e.jsx(j,{className:`${he(s.priority)} text-[10px] h-4 px-1`,children:s.priority==="high"?"ë†’ìŒ":s.priority==="medium"?"ë³´í†µ":"ë‚®ìŒ"}),e.jsx("span",{className:"text-xs font-medium text-gray-900 truncate max-w-[120px]",children:s.vendor_name||"ì—…ì²´ëª… ì—†ìŒ"}),e.jsxs("span",{className:"text-[10px] text-gray-500",children:[s.daysOverdue,"ì¼ ì§€ì—°"]})]}),e.jsxs("div",{className:"text-[10px] text-gray-600",children:[e.jsxs("span",{children:["ë°œì£¼: ",s.purchase_order_number||s.id.slice(0,8)]}),e.jsxs("span",{className:"ml-1",children:["â€¢ ",s.total_items,"ê°œ"]})]})]}),e.jsxs("div",{className:"flex gap-1 shrink-0",children:[e.jsxs(v,{size:"sm",variant:"outline",onClick:()=>R(`/purchase?highlight=${s.id}`),className:"h-6 px-2 text-[10px]",children:[e.jsx(ge,{className:"w-3 h-3 mr-0.5"}),"ë³´ê¸°"]}),e.jsxs(v,{size:"sm",onClick:()=>se(s.id),disabled:a===s.id,className:"bg-red-600 hover:bg-red-700 h-6 px-2 text-[10px]",children:[e.jsx(Ne,{className:"w-3 h-3 mr-0.5"}),a===s.id?"ì²˜ë¦¬ì¤‘":"ìŠ¹ì¸"]})]})]})},s.id))})})]}),e.jsx("div",{className:"mb-2",children:e.jsxs("h2",{className:"text-sm font-semibold text-gray-900 mb-2 flex items-center gap-1.5",children:[e.jsx(V,{className:"w-3.5 h-3.5 text-gray-600"}),"ì „ì²´ í˜„í™©"]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3",children:[(_.includes("lead_buyer")||_.includes("lead buyer"))&&C.length>0&&e.jsxs(P,{className:"w-full col-span-1 row-span-2 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[e.jsx(A,{className:"py-3 px-4 bg-gray-50 border-b",children:e.jsxs(O,{className:"text-sm font-semibold flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{className:"w-4 h-4 text-orange-600"}),e.jsx("span",{className:"text-gray-900",children:"ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œ"})]}),e.jsx(j,{className:"bg-orange-100 text-orange-700 border-orange-200 px-2 py-0.5",children:C.length})]})}),e.jsx(M,{className:"p-4",children:e.jsxs("div",{className:"space-y-2",children:[C.slice(0,5).map(s=>{const i=s.purchase_request_items||[],u=i[0]||{},b=i.reduce((w,q)=>w+(Number(q.amount_value)||0),0);i.reduce((w,q)=>w+(Number(q.quantity)||0),0);const g=Math.floor((Date.now()-new Date(s.created_at).getTime())/(1e3*60*60*24)),y=s.progress_type==="ì„ ì§„í–‰";return e.jsx("div",{className:`border rounded-lg p-3 transition-all cursor-pointer hover:shadow-sm ${y?"bg-red-50 hover:bg-red-100 border-red-200":"bg-white hover:bg-gray-50 border-gray-200"}`,onClick:()=>{k(s),U(!0)},children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-semibold text-sm text-gray-900",children:s.purchase_order_number||`PO-${s.id.slice(0,8)}`}),y&&e.jsx(j,{className:"text-[10px] bg-red-100 text-red-700 border-red-200 px-1.5 py-0",children:"ì„ ì§„í–‰"}),g>3&&e.jsxs(j,{variant:"outline",className:"text-[10px] px-1.5 py-0",children:[g,"ì¼ ê²½ê³¼"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-xs text-gray-600",children:s.vendor_name||"ì—…ì²´ëª… ì—†ìŒ"}),e.jsxs("div",{className:"text-xs text-gray-500",children:[u.item_name||"í’ˆëª©",i.length>1&&e.jsxs("span",{className:"text-gray-400",children:[" ì™¸ ",i.length-1,"ê±´"]})]})]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsxs("div",{className:"text-sm font-bold text-gray-900",children:["â‚©",b.toLocaleString()]}),e.jsx(v,{size:"sm",variant:"outline",className:"h-7 px-2 text-[10px] border-orange-200 hover:bg-orange-50",onClick:w=>{w.stopPropagation(),te(s)},disabled:L.has(s.id),children:L.has(s.id)?e.jsx("div",{className:"w-3 h-3 border border-orange-600 border-t-transparent rounded-full animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"w-3 h-3 mr-1"}),"ë‹¤ìš´ë¡œë“œ"]})})]})]})},s.id)}),C.length>5&&e.jsxs(v,{variant:"outline",size:"sm",className:"w-full text-xs h-8 border-gray-200 hover:bg-gray-50",onClick:()=>R("/purchase/list?tab=purchase"),children:["ì „ì²´ë³´ê¸° (",C.length,"ê±´) â†’"]})]})})]}),(_.includes("lead_buyer")||_.includes("lead buyer"))&&c.quickActions.find(s=>s.id==="purchase")&&e.jsxs(P,{className:"border-yellow-200 w-full col-span-1",children:[e.jsx(A,{className:"py-2 px-3 bg-yellow-50",children:e.jsxs(O,{className:"text-xs sm:text-sm font-semibold flex items-center gap-1.5",children:[e.jsx(z,{className:"w-3.5 h-3.5 sm:w-4 sm:h-4 text-yellow-600"}),"êµ¬ë§¤ ì²˜ë¦¬ ëŒ€ê¸°",e.jsx(j,{variant:"destructive",className:"text-[10px] sm:text-xs ml-auto h-4 sm:h-5 px-1 sm:px-1.5",children:c.quickActions.find(s=>s.id==="purchase")?.count||0})]})}),e.jsx(M,{className:"p-3",children:e.jsxs("div",{className:"text-center py-4",children:[e.jsx(z,{className:"w-10 h-10 mx-auto mb-2 text-yellow-500"}),e.jsxs("p",{className:"text-xs font-medium mb-2",children:[c.quickActions.find(s=>s.id==="purchase")?.count||0,"ê±´ì˜ êµ¬ë§¤ ëŒ€ê¸°ì¤‘"]}),e.jsx(v,{className:"bg-yellow-600 hover:bg-yellow-700 text-xs h-7 px-3",onClick:()=>R("/purchase/list"),children:"êµ¬ë§¤ ì²˜ë¦¬í•˜ê¸°"})]})})]}),e.jsxs(P,{className:"w-full col-span-1 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[e.jsx(A,{className:"py-3 px-4 bg-gray-50 border-b",children:e.jsxs(O,{className:"text-sm font-semibold flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"w-4 h-4 text-purple-600"}),e.jsx("span",{className:"text-gray-900",children:"ë‚´ ìŠ¹ì¸ ì§„í–‰ì¤‘"})]}),c.myRecentRequests.length>0&&e.jsx(j,{className:"bg-purple-100 text-purple-700 border-purple-200 px-2 py-0.5",children:c.myRecentRequests.length})]})}),e.jsx(M,{className:"p-4",children:c.myRecentRequests.length===0?e.jsxs("div",{className:"text-center py-12 text-gray-400",children:[e.jsx(Q,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm font-medium",children:"ìŠ¹ì¸ ì§„í–‰ì¤‘ì¸ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤"}),e.jsx(v,{size:"sm",variant:"outline",className:"mt-3 h-8 text-xs px-4 border-gray-200",onClick:()=>R("/purchase/new"),children:"ìƒˆ ìš”ì²­ ì‘ì„±"})]}):e.jsxs("div",{className:"space-y-2",children:[c.myRecentRequests.slice(0,3).map(s=>{const i=s.middle_manager_status==="pending"?25:50;return e.jsx("div",{className:"border border-gray-200 rounded-lg p-3 bg-white hover:bg-gray-50 transition-all cursor-pointer hover:shadow-sm",onClick:()=>R(`/purchase?highlight=${s.id}`),children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-semibold text-sm text-gray-900",children:s.purchase_order_number||`PO-${s.id.slice(0,8)}`}),e.jsxs(j,{className:"text-[10px] bg-purple-100 text-purple-700 border-purple-200 px-1.5 py-0",children:[i,"% ì§„í–‰"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-xs text-gray-600",children:s.vendor_name||"ì—…ì²´ëª… ì—†ìŒ"}),e.jsxs("div",{className:"text-xs text-gray-500",children:[s.total_items,"ê°œ í’ˆëª©"]}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("div",{className:"flex-1 bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-purple-600 h-2 rounded-full transition-all",style:{width:`${i}%`}})}),e.jsxs("span",{className:"text-[10px] text-gray-600",children:[i,"%"]})]})]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsxs("div",{className:"text-sm font-bold text-gray-900",children:["â‚©",(s.total_amount||0).toLocaleString()]}),e.jsx("div",{className:"text-[10px] text-gray-500",children:s.current_step==="approval"?"ìŠ¹ì¸ ëŒ€ê¸°":s.current_step==="purchase"?"êµ¬ë§¤ ëŒ€ê¸°":"ì§„í–‰ì¤‘"})]})]})},s.id)}),c.myRecentRequests.length>3&&e.jsxs(v,{variant:"outline",size:"sm",className:"w-full text-xs h-8 border-gray-200 hover:bg-gray-50",onClick:()=>R("/purchase"),children:["ì „ì²´ë³´ê¸° (",c.myRecentRequests.length,"ê±´) â†’"]})]})})]}),pe&&e.jsxs(P,{className:"w-full col-span-1 row-span-2",children:[e.jsx(A,{className:"pb-2 pt-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(O,{className:"text-xs sm:text-sm font-semibold flex items-center gap-1.5",children:[e.jsx(Q,{className:"w-3.5 h-3.5 text-orange-500"}),"ìŠ¹ì¸ ëŒ€ê¸°",c.pendingApprovals.length>0&&e.jsx(j,{variant:"destructive",className:"text-[10px] h-4 px-1",children:c.pendingApprovals.length})]}),c.pendingApprovals.length>0&&e.jsx(v,{size:"sm",variant:"ghost",onClick:()=>R("/purchase"),className:"h-6 px-2",children:e.jsx(Y,{className:"w-3 h-3"})})]})}),e.jsx(M,{className:"p-3",children:c.pendingApprovals.length===0?e.jsxs("div",{className:"text-center py-4 text-gray-400",children:[e.jsx(E,{className:"w-6 h-6 mx-auto mb-1"}),e.jsx("p",{className:"text-xs",children:"ëŒ€ê¸° í•­ëª© ì—†ìŒ"})]}):e.jsx("div",{className:"space-y-1.5",children:c.pendingApprovals.slice(0,5).map(s=>{const i=s.purchase_request_items||[],u=i[0]||{},b=s.total_amount||i.reduce((y,w)=>y+(Number(w.amount_value)||0),0),g=s.progress_type==="ì„ ì§„í–‰";return e.jsx("div",{className:`border rounded-lg p-2 hover:shadow-sm transition-all cursor-pointer ${g?"bg-red-50 border-red-200":"hover:bg-orange-50/30"}`,onClick:y=>{y.target.closest("button")||(l(Number(s.id)),x(!0))},children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-1 mb-1",children:[e.jsx("span",{className:"font-medium text-[11px]",children:s.purchase_order_number}),g&&e.jsx(j,{className:"text-[8px] bg-red-100 text-red-800 px-1 h-3.5",children:"ì„ ì§„í–‰"})]}),e.jsxs("div",{className:"text-[10px] text-gray-600 space-y-0.5",children:[e.jsxs("div",{className:"truncate",children:[u.item_name||"í’ˆëª©"," ",i.length>1&&`ì™¸ ${i.length-1}ê±´`]}),e.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[e.jsx("span",{className:"truncate max-w-[100px]",children:s.vendor_name||"ì—…ì²´"}),e.jsxs("span",{className:"font-semibold text-gray-900",children:["â‚©",(b/1e6).toFixed(1),"M"]})]})]})]}),e.jsx(v,{size:"sm",onClick:y=>{y.stopPropagation(),se(s.id)},disabled:a===s.id,className:`h-7 px-2 text-white text-[10px] shrink-0 ${s.middle_manager_status==="approved"?"bg-blue-600 hover:bg-blue-700":"bg-green-600 hover:bg-green-700"}`,children:a===s.id?e.jsx("div",{className:"w-3 h-3 border border-white border-t-transparent rounded-full animate-spin"}):e.jsxs(e.Fragment,{children:[s.middle_manager_status==="approved"?"ìµœì¢…":"1ì°¨"," ìŠ¹ì¸"]})})]})},s.id)})})})]}),e.jsxs(P,{className:"w-full col-span-1 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[e.jsx(A,{className:"py-3 px-4 bg-gray-50 border-b",children:e.jsxs(O,{className:"text-sm font-semibold flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{className:"w-4 h-4 text-yellow-600"}),e.jsx("span",{className:"text-gray-900",children:"êµ¬ë§¤ ëŒ€ê¸°"})]}),c.myPurchaseStatus.waitingPurchase.length>0&&e.jsx(j,{className:"bg-yellow-100 text-yellow-700 border-yellow-200 px-2 py-0.5",children:c.myPurchaseStatus.waitingPurchase.length})]})}),e.jsx(M,{className:"p-4",children:c.myPurchaseStatus.waitingPurchase.length===0?e.jsxs("div",{className:"text-center py-12 text-gray-400",children:[e.jsx(z,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm font-medium",children:"êµ¬ë§¤ ëŒ€ê¸° í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤"})]}):e.jsxs("div",{className:"space-y-2",children:[c.myPurchaseStatus.waitingPurchase.slice(0,3).map(s=>{const i=s.purchase_request_items||[],u=i[0],b=i.reduce((y,w)=>y+(Number(w.amount_value)||0),0),g=(s.progress_type||"").includes("ì„ ì§„í–‰");return e.jsx("div",{className:`border rounded-lg p-3 transition-all cursor-pointer hover:shadow-sm ${g?"bg-red-50 hover:bg-red-100 border-red-200":"bg-white hover:bg-gray-50 border-gray-200"}`,onClick:()=>B(s,"purchase"),children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-semibold text-sm text-gray-900",children:s.purchase_order_number||`PO-${s.id.slice(0,8)}`}),g&&e.jsx(j,{className:"text-[10px] bg-red-100 text-red-700 border-red-200 px-1.5 py-0",children:"ì„ ì§„í–‰"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-xs text-gray-600",children:s.vendor_name||"ì—…ì²´ëª… ì—†ìŒ"}),e.jsxs("div",{className:"text-xs text-gray-500",children:[u?.item_name||"í’ˆëª©",i.length>1&&e.jsxs("span",{className:"text-gray-400",children:[" ì™¸ ",i.length-1,"ê±´"]})]})]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsxs("div",{className:"text-sm font-bold text-gray-900",children:["â‚©",b.toLocaleString()]}),e.jsx("div",{className:"text-[10px] text-gray-500",children:new Date(s.request_date).toLocaleDateString("ko-KR")})]})]})},s.id)}),c.myPurchaseStatus.waitingPurchase.length>3&&e.jsxs(v,{variant:"outline",size:"sm",className:"w-full text-xs h-8 border-gray-200 hover:bg-gray-50",onClick:()=>R("/purchase?tab=purchase"),children:["ì „ì²´ë³´ê¸° (",c.myPurchaseStatus.waitingPurchase.length,"ê±´) â†’"]})]})})]}),e.jsxs(P,{className:"w-full col-span-1 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[e.jsx(A,{className:"py-3 px-4 bg-gray-50 border-b",children:e.jsxs(O,{className:"text-sm font-semibold flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"w-4 h-4 text-blue-600"}),e.jsx("span",{className:"text-gray-900",children:"ì…ê³  ëŒ€ê¸°"})]}),c.myPurchaseStatus.waitingDelivery.length>0&&e.jsx(j,{className:"bg-blue-100 text-blue-700 border-blue-200 px-2 py-0.5",children:c.myPurchaseStatus.waitingDelivery.length})]})}),e.jsx(M,{className:"p-4",children:c.myPurchaseStatus.waitingDelivery.length===0?e.jsxs("div",{className:"text-center py-12 text-gray-400",children:[e.jsx(Z,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm font-medium",children:"ì…ê³  ëŒ€ê¸° í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤"})]}):e.jsxs("div",{className:"space-y-2",children:[c.myPurchaseStatus.waitingDelivery.slice(0,3).map(s=>{const i=s.purchase_request_items||[],u=i[0],b=i.length,g=i.filter(f=>f.is_received).length,y=b>0?Math.round(g/b*100):0,w=i.reduce((f,H)=>f+(Number(H.amount_value)||0),0),q=(s.progress_type||"").includes("ì„ ì§„í–‰");return e.jsx("div",{className:`border rounded-lg p-3 transition-all cursor-pointer hover:shadow-sm ${q?"bg-red-50 hover:bg-red-100 border-red-200":"bg-white hover:bg-gray-50 border-gray-200"}`,onClick:()=>B(s,"delivery"),children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-semibold text-sm text-gray-900",children:s.purchase_order_number||`PO-${s.id.slice(0,8)}`}),q&&e.jsx(j,{className:"text-[10px] bg-red-100 text-red-700 border-red-200 px-1.5 py-0",children:"ì„ ì§„í–‰"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-xs text-gray-600",children:s.vendor_name||"ì—…ì²´ëª… ì—†ìŒ"}),e.jsxs("div",{className:"text-xs text-gray-500",children:[u?.item_name||"í’ˆëª©",b>1&&e.jsxs("span",{className:"text-gray-400",children:[" ì™¸ ",b-1,"ê±´"]})]}),s.delivery_request_date&&e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["ë‚©ê¸°: ",new Date(s.delivery_request_date).toLocaleDateString("ko-KR")]})]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsxs("div",{className:"text-sm font-bold text-gray-900",children:["â‚©",w.toLocaleString()]}),y>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"text-[10px] text-gray-600",children:[g,"/",b," ì…ê³  (",y,"%)"]}),e.jsx("div",{className:"w-16 bg-gray-200 rounded-full h-1.5",children:e.jsx("div",{className:"bg-blue-600 h-1.5 rounded-full",style:{width:`${y}%`}})})]})]})]})},s.id)}),c.myPurchaseStatus.waitingDelivery.length>3&&e.jsxs(v,{variant:"outline",size:"sm",className:"w-full text-xs h-8 border-gray-200 hover:bg-gray-50",onClick:()=>R("/purchase?tab=receipt"),children:["ì „ì²´ë³´ê¸° (",c.myPurchaseStatus.waitingDelivery.length,"ê±´) â†’"]})]})})]}),e.jsxs(P,{className:"w-full col-span-1 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[e.jsx(A,{className:"py-3 px-4 bg-gray-50 border-b",children:e.jsxs(O,{className:"text-sm font-semibold flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{className:"w-4 h-4 text-green-600"}),e.jsx("span",{className:"text-gray-900",children:"ìµœê·¼ ì™„ë£Œ"})]}),c.myPurchaseStatus.recentCompleted.length>0&&e.jsx(j,{className:"bg-green-100 text-green-700 border-green-200 px-2 py-0.5",children:c.myPurchaseStatus.recentCompleted.length})]})}),e.jsx(M,{className:"p-4",children:c.myPurchaseStatus.recentCompleted.length===0?e.jsxs("div",{className:"text-center py-12 text-gray-400",children:[e.jsx(E,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm font-medium",children:"ìµœê·¼ ì™„ë£Œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤"})]}):e.jsxs("div",{className:"space-y-2",children:[c.myPurchaseStatus.recentCompleted.slice(0,3).map(s=>{const i=s.purchase_request_items||[],u=i[0],b=i.reduce((g,y)=>g+(Number(y.amount_value)||0),0);return e.jsx("div",{className:"border border-green-200 rounded-lg p-3 bg-green-50 hover:bg-green-100 transition-all cursor-pointer hover:shadow-sm",onClick:()=>B(s,"completed"),children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-semibold text-sm text-gray-900",children:s.purchase_order_number||`PO-${s.id.slice(0,8)}`}),e.jsx(j,{className:"text-[10px] bg-green-100 text-green-700 border-green-200 px-1.5 py-0",children:"ì™„ë£Œ"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-xs text-gray-600",children:s.vendor_name||"ì—…ì²´ëª… ì—†ìŒ"}),e.jsxs("div",{className:"text-xs text-gray-500",children:[u?.item_name||"í’ˆëª©",i.length>1&&e.jsxs("span",{className:"text-gray-400",children:[" ì™¸ ",i.length-1,"ê±´"]})]}),s.received_at&&e.jsxs("div",{className:"text-xs text-green-600 font-medium",children:["ì…ê³ ì™„ë£Œ: ",new Date(s.received_at).toLocaleDateString("ko-KR")]})]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsxs("div",{className:"text-sm font-bold text-gray-900",children:["â‚©",b.toLocaleString()]}),e.jsx("div",{className:"text-[10px] text-gray-500",children:new Date(s.received_at||s.created_at).toLocaleDateString("ko-KR")})]})]})},s.id)}),c.myPurchaseStatus.recentCompleted.length>3&&e.jsxs(v,{variant:"outline",size:"sm",className:"w-full text-xs h-8 border-gray-200 hover:bg-gray-50",onClick:()=>R("/purchase?tab=done"),children:["ì „ì²´ë³´ê¸° (",c.myPurchaseStatus.recentCompleted.length,"ê±´) â†’"]})]})})]})]})]}),e.jsx(ye,{purchaseId:d,isOpen:m,onClose:()=>{x(!1),l(null)},currentUserRoles:_,onRefresh:()=>{F(),x(!1),l(null)}}),e.jsx(ke,{isOpen:ue,onClose:()=>{ee(!1),G(null),X(null)},item:oe,type:me,onRefresh:F}),T&&p&&e.jsx(ne,{open:T,onOpenChange:()=>{U(!1),k(null)},children:e.jsxs(le,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(ie,{children:[e.jsxs(ce,{className:"text-xl font-bold",children:[p.purchase_order_number," ìƒì„¸ë³´ê¸°"]}),e.jsx(de,{children:p.vendor_name||"ì—…ì²´ëª… ì—†ìŒ"})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsxs("h3",{className:"font-semibold mb-3 flex items-center",children:[e.jsx(re,{className:"w-4 h-4 mr-2"}),"ê¸°ë³¸ ì •ë³´"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"ìš”ì²­ì"}),e.jsx("p",{className:"font-medium",children:p.requester_name})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"ìš”ì²­ì¼"}),e.jsx("p",{className:"font-medium",children:new Date(p.request_date||p.created_at).toLocaleDateString("ko-KR")})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"ë‚©ê¸°ìš”ì²­ì¼"}),e.jsx("p",{className:"font-medium",children:p.delivery_request_date?new Date(p.delivery_request_date).toLocaleDateString("ko-KR"):"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"ì¹´í…Œê³ ë¦¬"}),e.jsx("p",{className:"font-medium",children:p.payment_category||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"ìƒíƒœ"}),e.jsx("p",{className:"font-medium",children:e.jsx(j,{className:"bg-orange-50 text-orange-700 border-orange-200",children:"ë¯¸ë‹¤ìš´ë¡œë“œ"})})]})]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsxs("h3",{className:"font-semibold mb-3 flex items-center",children:[e.jsx(V,{className:"w-4 h-4 mr-2"}),"í’ˆëª© ë¦¬ìŠ¤íŠ¸"]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{className:"bg-white",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500",children:"í’ˆëª…"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500",children:"ê·œê²©"}),e.jsx("th",{className:"px-3 py-2 text-center text-xs font-medium text-gray-500",children:"ìˆ˜ëŸ‰"}),e.jsx("th",{className:"px-3 py-2 text-right text-xs font-medium text-gray-500",children:"ë‹¨ê°€"}),e.jsx("th",{className:"px-3 py-2 text-right text-xs font-medium text-gray-500",children:"ê¸ˆì•¡"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500",children:"ë¹„ê³ "})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:(p.purchase_request_items||[]).map((s,i)=>{const u=s.quantity>0?(Number(s.amount_value)||0)/s.quantity:0;return e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2",children:e.jsx("span",{className:"text-sm",children:s.item_name||"í’ˆëª©ëª… ì—†ìŒ"})}),e.jsx("td",{className:"px-3 py-2",children:e.jsx("span",{className:"text-sm",children:s.specification||"-"})}),e.jsx("td",{className:"px-3 py-2 text-center",children:e.jsx("span",{className:"text-sm",children:s.quantity||0})}),e.jsx("td",{className:"px-3 py-2 text-right",children:e.jsxs("span",{className:"text-sm",children:["â‚©",u.toLocaleString()]})}),e.jsx("td",{className:"px-3 py-2 text-right",children:e.jsxs("span",{className:"text-sm",children:["â‚©",(Number(s.amount_value)||0).toLocaleString()]})}),e.jsx("td",{className:"px-3 py-2",children:e.jsx("span",{className:"text-sm",children:s.remark||"-"})})]},i)})})]})}),e.jsx("div",{className:"mt-4 pt-4 border-t border-gray-200 bg-white p-3 rounded",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"font-semibold",children:"ì´ì•¡"}),e.jsxs("span",{className:"font-bold text-lg",children:["â‚©",(p.purchase_request_items||[]).reduce((s,i)=>s+(Number(i.amount_value)||0),0).toLocaleString()]})]})})]}),e.jsxs("div",{className:"flex justify-between gap-3 mt-6",children:[e.jsx("div",{className:"flex gap-2",children:e.jsxs(v,{onClick:()=>te(p),disabled:L.has(p.id),className:"bg-orange-600 hover:bg-orange-700",size:"sm",children:[L.has(p.id)?e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}):e.jsx(J,{className:"w-4 h-4 mr-2"}),"Excel ë‹¤ìš´ë¡œë“œ"]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(v,{variant:"outline",onClick:()=>R("/purchase/list?tab=purchase"),size:"sm",children:["ë°œì£¼ ëª©ë¡ì—ì„œ ë³´ê¸°",e.jsx(Y,{className:"w-4 h-4 ml-2"})]}),e.jsx(v,{variant:"ghost",onClick:()=>{U(!1),k(null)},size:"sm",children:"ë‹«ê¸°"})]})]})]})]})})]})}export{Ie as default};
//# sourceMappingURL=DashboardMain-B5fN-x8G.js.map
