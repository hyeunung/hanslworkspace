import{c as F,a as K,u as re,r as w,j as e,F as ne,B as le,b as v,S as G}from"./index-BZPnGuwA.js";import{B as j,t as P}from"./index-BRMmYxVM.js";import{C as M,a as L,b as $,c as E}from"./card-0XfmPTP6.js";import{D as ie,a as ce,b as de,c as oe,d as me}from"./input-Bp7z4yNm.js";import{E as ye}from"./exceljs.min-Bi8eD9my.js";import{P as Y,T as Z,a as _e}from"./PurchaseDetailModal-DoAtI-5j.js";import{C as I}from"./format-Cm3Bettn.js";import{C as fe}from"./credit-card-CqLIFE4x.js";import{E as je}from"./eye-DtQtsbWB.js";import{D as J}from"./download-D0QVtQl0.js";import"./helpers-BMiTuHMe.js";import"./chevron-down-CjKc6-Wz.js";import"./popover-vFiDhahG.js";import"./calendar-ghXAII5e.js";import"./plus-DKKA9jPQ.js";import"./save-DAb2-aYQ.js";/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]],V=F("arrow-right",be);/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ve=[["path",{d:"M12 6v6l4 2",key:"mmk7yg"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],H=F("clock",ve);/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=[["path",{d:"M7 10v12",key:"1qc93n"}],["path",{d:"M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z",key:"emmmcr"}]],we=F("thumbs-up",Ne);/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]],Se=F("triangle-alert",qe);class De{constructor(){this.supabase=K()}parseRoles(a){let t=[];return a&&(Array.isArray(a)?t=a.map(n=>String(n).trim()):t=String(a).split(",").map(r=>r.trim()).filter(r=>r.length>0)),t}async getDashboardData(a){const[t,n,r,o,d,p,h]=await Promise.all([this.getDashboardStats(a),this.getUrgentRequests(a),this.getMyRecentRequests(a),this.getPendingApprovals(a),this.getQuickActions(a),this.getTodaySummary(a),this.getMyPurchaseStatus(a)]);return{employee:a,stats:t,urgentRequests:n,myRecentRequests:r,pendingApprovals:o,quickActions:d,todaySummary:p,myPurchaseStatus:h}}async getDashboardStats(a){const t=new Date().toISOString().split("T")[0],n=this.parseRoles(a.purchase_role),[r,o,d,p,h,u]=await Promise.all([this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("requester_name",a.name),this.getPendingCount(a,n),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("is_received",!0).gte("received_at",new Date(new Date().getFullYear(),new Date().getMonth(),1).toISOString()),this.getUrgentCount(a,n),this.getTodayActionsCount(a,t)]);return{total:r.count||0,myRequests:o.count||0,pending:d,completed:p.count||0,urgent:h,todayActions:u}}async getUrgentRequests(a){const t=new Date(Date.now()-2592e5).toISOString(),n=this.parseRoles(a.purchase_role);if(n.length===0)return[];let r=this.supabase.from("purchase_requests").select("*,vendors(vendor_name),purchase_request_items(id)").lt("created_at",t);if(n.includes("app_admin"))r=r.or("middle_manager_status.eq.pending,final_manager_status.eq.pending,purchase_status.eq.pending");else if(n.includes("middle_manager"))r=r.eq("middle_manager_status","pending");else if(n.includes("final_approver")||n.includes("ceo"))r=r.eq("middle_manager_status","approved").eq("final_manager_status","pending");else if(n.includes("lead buyer"))r=r.eq("final_manager_status","approved").eq("purchase_status","pending");else return[];const{data:o}=await r.order("created_at",{ascending:!0}).limit(5);return(o||[]).map(d=>({...d,vendor_name:d.vendors?.vendor_name,total_items:d.purchase_request_items?.length||0,daysOverdue:Math.floor((Date.now()-new Date(d.created_at).getTime())/(1e3*60*60*24)),priority:this.calculatePriority(d),urgentReason:this.getUrgentReason(d,n)}))}async getMyRecentRequests(a){const{data:t}=await this.supabase.from("purchase_requests").select("*,vendors(vendor_name),purchase_request_items(id)").eq("requester_name",a.name).or("and(middle_manager_status.eq.approved,final_manager_status.eq.pending),and(final_manager_status.eq.approved,purchase_status.eq.pending)").order("created_at",{ascending:!1}).limit(5);return(t||[]).map(n=>({...n,vendor_name:n.vendors?.vendor_name,total_items:n.purchase_request_items?.length||0,progress_percentage:this.calculateProgress(n),current_step:this.getCurrentStep(n),next_action:this.getNextAction(n),estimated_completion:this.estimateCompletion(n)}))}async getPendingApprovals(a){const t=this.parseRoles(a.purchase_role);let n=null;const r=await this.supabase.from("purchase_requests").select("*").order("request_date",{ascending:!1}).limit(100);if(r.error){r.error;const h=await this.supabase.from("purchase_requests").select("*").order("request_date",{ascending:!1}).limit(100);if(h.error)return[];n=h.data||[]}else n=r.data||[];let o=n||[];const d=h=>h==="pending"||h==="대기"||h===""||h===null||h===void 0;return o=o.filter(h=>d(h.final_manager_status)),t.length===0?[]:await Promise.all(o.map(async h=>{const{data:u}=await this.supabase.from("purchase_request_items").select("*").eq("purchase_request_id",h.id);let g=h.vendor_name;if(!g&&h.vendor_id){const{data:A}=await this.supabase.from("vendors").select("vendor_name").eq("id",h.vendor_id).single();g=A?.vendor_name}const N=u||[],S=N.reduce((A,R)=>{const O=Number(R?.amount_value)||(Number(R?.quantity)||0)*(Number(R?.unit_price_value)||0);return A+O},0);return{...h,vendor_name:g,purchase_request_items:N,total_amount:S}}))}async getQuickActions(a){const t=this.parseRoles(a.purchase_role),n=[];if(t.includes("app_admin")||t.includes("middle_manager")||t.includes("final_approver")||t.includes("ceo")){const r=await this.getPendingCount(a,t);r>0&&n.push({id:"approve",type:"approve",label:"승인 대기",description:`${r}건의 승인 대기 중`,count:r,color:"red"})}if(t.includes("lead buyer")||t.includes("lead buyer")){const{count:r}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("final_manager_status","approved").eq("purchase_status","pending");r&&r>0&&n.push({id:"purchase",type:"purchase",label:"구매 처리",description:`${r}건의 구매 대기 중`,count:r,color:"yellow"})}return n}async getTodaySummary(a){const t=new Date().toISOString().split("T")[0],n=new Date(Date.now()+1440*60*1e3).toISOString().split("T")[0],[r,o,d]=await Promise.all([this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).gte("updated_at",t).lt("updated_at",n).or("middle_manager_status.eq.approved,final_manager_status.eq.approved"),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("requester_name",a.name).gte("created_at",t).lt("created_at",n),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("is_received",!0).gte("received_at",t).lt("received_at",n)]);return{approved:r.count||0,requested:o.count||0,received:d.count||0}}async getMyPurchaseStatus(a){const t=a.name||a.email,n=new Date(Date.now()-10080*60*1e3).toISOString(),r=await this.supabase.from("purchase_requests").select("*,vendors(vendor_name),purchase_request_items(item_name,quantity,specification,amount_value)").eq("requester_name",t).order("created_at",{ascending:!1}).limit(100);if(r.error)return console.error("getMyPurchaseStatus 에러:",r.error),{waitingPurchase:[],waitingDelivery:[],recentCompleted:[]};const o=r.data||[],d=o.filter(u=>{const g=(u.payment_category||"").trim().replace(/\s+/g,""),N=["구매요청","발주요청"].includes(g),S=!u.is_payment_completed,A=(u.progress_type||"").includes("선진행");if(N&&S&&A)return!0;const R=(u.progress_type||"").includes("일반")||!u.progress_type||u.progress_type==="",O=u.final_manager_status==="approved";return N&&S&&R&&O}).slice(0,10),p=o.filter(u=>{const g=!u.is_received,N=(u.progress_type||"").includes("선진행");if(g&&N)return!0;const S=u.final_manager_status==="approved";return g&&S}).slice(0,10),h=o.filter(u=>{if(u.is_received!==!0||!u.received_at)return!1;const g=new Date(u.received_at),N=new Date(n);return g>=N}).slice(0,10);return{waitingPurchase:d,waitingDelivery:p,recentCompleted:h}}async quickApprove(a,t){try{const n=this.parseRoles(t.purchase_role),{data:r}=await this.supabase.from("purchase_requests").select("middle_manager_status, final_manager_status").eq("id",a).single();if(!r)return{success:!1,error:"요청을 찾을 수 없습니다."};let o={};const d=u=>u==="pending"||u==="대기"||u===""||u===null||u===void 0;if(n.includes("app_admin")?d(r.middle_manager_status)?o={middle_manager_status:"approved"}:r.middle_manager_status==="approved"&&d(r.final_manager_status)&&(o={final_manager_status:"approved"}):n.includes("middle_manager")?d(r.middle_manager_status)&&(o={middle_manager_status:"approved"}):n.includes("final_approver")||n.includes("ceo")?r.middle_manager_status==="approved"&&d(r.final_manager_status)&&(o={final_manager_status:"approved"}):(n.includes("raw_material_manager")||n.includes("consumable_manager"))&&r.middle_manager_status==="approved"&&d(r.final_manager_status)&&(o={final_manager_status:"approved"}),Object.keys(o).length===0)return{success:!1,error:"승인할 수 있는 상태가 아닙니다."};const{data:p,error:h}=await this.supabase.from("purchase_requests").update(o).eq("id",a).select().single();if(h)throw h;return{success:!0}}catch(n){return{success:!1,error:n.message}}}async getPendingCount(a,t){if(t.includes("app_admin")){const[n,r,o]=await Promise.all([this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).or("middle_manager_status.in.(pending,대기),middle_manager_status.is.null"),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("middle_manager_status","approved").or("final_manager_status.in.(pending,대기),final_manager_status.is.null"),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("final_manager_status","approved").or("purchase_status.in.(pending,대기),purchase_status.is.null")]);return(n.count||0)+(r.count||0)+(o.count||0)}if(t.includes("middle_manager")){const{count:n,error:r}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).or("middle_manager_status.in.(pending,대기),middle_manager_status.is.null");return r?0:n||0}if(t.includes("final_approver")||t.includes("ceo")){const{count:n,error:r}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("middle_manager_status","approved").or("final_manager_status.in.(pending,대기),final_manager_status.is.null");return r?0:n||0}if(t.includes("lead buyer")){const{count:n,error:r}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("final_manager_status","approved").or("purchase_status.in.(pending,대기),purchase_status.is.null");return r?0:n||0}return 0}async getUrgentCount(a,t){if(t.length===0)return 0;const n=new Date(Date.now()-4320*60*1e3).toISOString();let r=this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).lt("created_at",n);if(t.includes("app_admin"))r=r.or("middle_manager_status.eq.pending,final_manager_status.eq.pending,purchase_status.eq.pending");else if(t.includes("middle_manager"))r=r.eq("middle_manager_status","pending");else if(t.includes("final_approver")||t.includes("ceo"))r=r.eq("middle_manager_status","approved").eq("final_manager_status","pending");else if(t.includes("lead buyer"))r=r.eq("final_manager_status","approved").eq("purchase_status","pending");else return 0;const{count:o}=await r;return o||0}async getTodayActionsCount(a,t){const n=new Date(Date.now()+864e5).toISOString().split("T")[0],{count:r}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).gte("updated_at",t).lt("updated_at",n).or(`middle_manager_id.eq.${a.id},final_manager_id.eq.${a.id}`);return r||0}async getTotalDeliveryWaitingCount(){const{count:a}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("is_received",!1).or("is_payment_completed.eq.true,progress_type.ilike.%선진행%");return a||0}calculatePriority(a){const t=Math.floor((Date.now()-new Date(a.created_at).getTime())/864e5);return t>=7?"high":t>=5?"medium":"low"}getUrgentReason(a,t){return t.includes("middle_manager")&&a.middle_manager_status==="pending"||(t.includes("final_approver")||t.includes("ceo"))&&a.final_manager_status==="pending"?"overdue_approval":a.is_received?"payment_pending":"delivery_delay"}calculateProgress(a){let t=0;return a.middle_manager_status==="approved"&&(t+=25),a.final_manager_status==="approved"&&(t+=25),a.is_payment_completed&&(t+=25),a.is_received&&(t+=25),t}getCurrentStep(a){return a.is_received?"completed":a.is_payment_completed?"delivery":a.final_manager_status==="approved"?"purchase":"approval"}getNextAction(a){return a.middle_manager_status==="pending"?"중간 승인 대기 중":a.final_manager_status==="pending"?"최종 승인 대기 중":a.is_payment_completed?a.is_received?"완료":"입고 대기 중":"구매 처리 대기 중"}estimateCompletion(a){const t=new Date(a.created_at);Math.floor((new Date().getTime()-t.getTime())/(1e3*60*60*24));let r=7;return a.progress_type==="긴급"&&(r=3),new Date(t.getTime()+r*24*60*60*1e3).toLocaleDateString("ko-KR")}async getUndownloadedOrders(a){const t=this.parseRoles(a.purchase_role);if(!t.includes("lead buyer")&&!t.includes("lead buyer"))return[];const{data:n,error:r}=await this.supabase.from("purchase_requests").select("*,purchase_request_items(id,item_name,specification,quantity,unit_price_value,amount_value)").order("created_at",{ascending:!1}).limit(100);if(r)return console.error("Failed to fetch undownloaded orders:",r),[];const o=(n||[]).filter(d=>{const p=d.progress_type==="선진행"||d.middle_manager_status==="approved"&&d.final_manager_status==="approved",h=!d.is_po_download||d.is_po_download===!1||d.is_po_download===null;return p&&h});return o.sort((d,p)=>new Date(d.created_at).getTime()-new Date(p.created_at).getTime()),o.slice(0,10)}}const z=new De;function ke({isOpen:l,onClose:a,item:t,type:n,onRefresh:r}){const o=re(),d=K(),[p,h]=w.useState([]),[u,g]=w.useState(!1);if(w.useEffect(()=>{(async()=>{const{data:{user:q}}=await d.auth.getUser();if(console.log("Fetching roles for user:",q?.email),q?.email){const{data:D}=await d.from("employees").select("purchase_role").eq("email",q.email).single();if(console.log("Employee data:",D),D?.purchase_role){const T=Array.isArray(D.purchase_role)?D.purchase_role:D.purchase_role.split(",").map(B=>B.trim());console.log("Parsed roles:",T),h(T)}else console.log("No purchase_role found for employee")}})()},[n]),!t)return null;const N=t.purchase_request_items||[],S=N.reduce((c,q)=>c+(Number(q.amount_value)||0),0),A=N.reduce((c,q)=>c+(Number(q.quantity)||0),0);console.log("PurchaseStatusModal Debug:",{type:n,currentUserRoles:p,item:t.purchase_order_number,showPurchaseButton:n==="purchase",hasPermission:p.includes("app_admin")||p.includes("lead buyer")});const O=(()=>{switch(n){case"purchase":return{icon:e.jsx(G,{className:"w-6 h-6 text-yellow-600"}),title:"구매 대기",status:"구매 처리 대기중",color:"bg-yellow-50 text-yellow-700 border-yellow-200"};case"delivery":return{icon:e.jsx(Z,{className:"w-6 h-6 text-blue-600"}),title:"입고 대기",status:"입고 처리 대기중",color:"bg-blue-50 text-blue-700 border-blue-200"};case"completed":return{icon:e.jsx(I,{className:"w-6 h-6 text-green-600"}),title:"처리 완료",status:"모든 처리 완료",color:"bg-green-50 text-green-700 border-green-200"}}})();return e.jsx(ie,{open:l,onOpenChange:a,children:e.jsxs(ce,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(de,{children:[e.jsxs(oe,{className:"text-xl font-bold",children:[t.purchase_order_number||"PO번호 없음"," 상세보기"]}),e.jsx(me,{children:t.vendor_name||"업체명 없음"})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-6",children:[e.jsxs("h3",{className:"font-semibold mb-4 flex items-center text-gray-900",children:[e.jsx(ne,{className:"w-5 h-5 mr-2 text-gray-700"}),"기본 정보"]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-6",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"요청자"}),e.jsx("p",{className:"font-medium text-gray-900",children:t.requester_name})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"요청일"}),e.jsx("p",{className:"font-medium text-gray-900",children:new Date(t.request_date||t.created_at).toLocaleDateString("ko-KR")})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"납기요청일"}),e.jsx("p",{className:"font-medium text-gray-900",children:t.delivery_request_date?new Date(t.delivery_request_date).toLocaleDateString("ko-KR"):"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"결제유형"}),e.jsx("p",{className:"font-medium text-gray-900",children:t.payment_category||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"진행구분"}),e.jsx("p",{className:"font-medium text-gray-900",children:t.progress_type||"일반"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"상태"}),e.jsx("p",{className:"font-medium",children:e.jsx(j,{className:O.color,children:O.title})})]})]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-6",children:[e.jsxs("h3",{className:"font-semibold mb-4 flex items-center text-gray-900",children:[e.jsx(le,{className:"w-5 h-5 mr-2 text-gray-700"}),"업체 정보"]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-6",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"업체명"}),e.jsx("p",{className:"font-medium text-gray-900",children:t.vendor_name||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"프로젝트 업체"}),e.jsx("p",{className:"font-medium text-gray-900",children:t.project_vendor||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"판매주문번호"}),e.jsx("p",{className:"font-medium text-gray-900",children:t.sales_order_number||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"프로젝트 품목"}),e.jsx("p",{className:"font-medium text-gray-900",children:t.project_item||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"발주서 템플릿"}),e.jsx("p",{className:"font-medium text-gray-900",children:t.po_template_type||"일반"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"통화"}),e.jsx("p",{className:"font-medium text-gray-900",children:t.currency||"KRW"})]})]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-6",children:[e.jsxs("h3",{className:"font-semibold mb-4 flex items-center text-gray-900",children:[e.jsx(Y,{className:"w-5 h-5 mr-2 text-gray-700"}),"품목 리스트"]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full bg-white rounded-lg overflow-hidden shadow-sm",children:[e.jsx("thead",{className:"bg-gray-100",children:e.jsxs("tr",{children:[n==="purchase"&&e.jsx("th",{className:"px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"구매"}),n==="delivery"&&e.jsx("th",{className:"px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"입고"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"품명"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"규격"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"수량"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"단가"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"금액"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"비고"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:N.map((c,q)=>{const D=c.quantity>0?(Number(c.amount_value)||0)/c.quantity:0;return e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[n==="purchase"&&e.jsx("td",{className:"px-4 py-3 text-center",children:e.jsx("div",{className:"flex items-center justify-center",children:t.is_payment_completed?e.jsx(j,{className:"bg-yellow-100 text-yellow-800 text-xs",children:"구매완료"}):e.jsx(j,{variant:"outline",className:"text-gray-600 text-xs",children:"구매대기"})})}),n==="delivery"&&e.jsx("td",{className:"px-4 py-3 text-center",children:e.jsx("div",{className:"flex items-center justify-center",children:c.is_received?e.jsx(j,{className:"bg-green-100 text-green-800 text-xs",children:"입고완료"}):e.jsx(j,{variant:"outline",className:"text-gray-600 text-xs",children:"미입고"})})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:"text-sm font-medium text-gray-900",children:c.item_name||"품목명 없음"})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:"text-sm text-gray-600",children:c.specification||"-"})}),e.jsx("td",{className:"px-4 py-3 text-center",children:e.jsx("span",{className:"text-sm font-medium text-gray-900",children:c.quantity||0})}),e.jsx("td",{className:"px-4 py-3 text-right",children:e.jsxs("span",{className:"text-sm text-gray-900",children:["₩",D.toLocaleString()]})}),e.jsx("td",{className:"px-4 py-3 text-right",children:e.jsxs("span",{className:"text-sm font-semibold text-gray-900",children:["₩",(Number(c.amount_value)||0).toLocaleString()]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:"text-sm text-gray-600",children:c.remark||"-"})})]},q)})})]})}),e.jsx("div",{className:"mt-6 bg-white rounded-lg p-4 shadow-sm",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"총"}),e.jsxs("span",{className:"ml-1 font-semibold text-gray-900",children:[A,"개"]}),e.jsx("span",{className:"text-sm text-gray-600 ml-1",children:"항목"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"text-sm text-gray-600 block",children:"총액"}),e.jsxs("span",{className:"font-bold text-xl text-gray-900",children:["₩",S.toLocaleString()]})]})]})})]}),n==="delivery"&&N.length>1&&e.jsxs("div",{className:"bg-blue-50 rounded-lg p-4",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900 mb-3",children:"입고 진행 현황"}),(()=>{const c=N.filter(T=>T.is_received).length,q=N.length,D=c/q*100;return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"입고 완료"}),e.jsxs("span",{className:"font-medium text-gray-900",children:[c,"/",q,"개 (",D.toFixed(0),"%)"]})]}),e.jsx("div",{className:"w-full bg-blue-200 rounded-full h-2 overflow-hidden",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-300",style:{width:`${D}%`}})})]})})()]}),e.jsxs("div",{className:"flex justify-between gap-3 mt-6",children:[e.jsxs("div",{className:"flex gap-2",children:[n==="delivery"&&(p.includes("app_admin")||p.includes("lead buyer")||p.includes("receiver"))&&e.jsxs(v,{onClick:async()=>{g(!0);try{const{error:c}=await d.from("purchase_requests").update({is_received:!0,received_at:new Date().toISOString()}).eq("id",t.id);if(c)throw c;await d.from("purchase_request_items").update({is_received:!0,delivery_status:"received"}).eq("purchase_request_id",t.id),P.success("입고완료 처리되었습니다."),a(),setTimeout(()=>{r?.()},100)}catch{P.error("처리 중 오류가 발생했습니다.")}finally{g(!1)}},disabled:u,className:"bg-blue-600 hover:bg-blue-700",size:"sm",children:[u?e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}):e.jsx(I,{className:"w-4 h-4 mr-2"}),"입고 완료 처리"]}),n==="purchase"&&(p.includes("app_admin")||p.includes("lead buyer"))&&e.jsxs(v,{onClick:async()=>{g(!0);try{const{error:c}=await d.from("purchase_requests").update({is_payment_completed:!0,payment_completed_at:new Date().toISOString()}).eq("id",t.id);if(c)throw c;P.success("구매완료 처리되었습니다."),a(),setTimeout(()=>{r?.()},100)}catch{P.error("처리 중 오류가 발생했습니다.")}finally{g(!1)}},disabled:u,className:"bg-yellow-600 hover:bg-yellow-700",size:"sm",children:[u?e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}):e.jsx(fe,{className:"w-4 h-4 mr-2"}),"구매 완료 처리"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(v,{variant:"outline",onClick:()=>{o(`/purchase?highlight=${t.id}`),a()},size:"sm",children:["발주 목록에서 보기",e.jsx(V,{className:"w-4 h-4 ml-2"})]}),e.jsx(v,{variant:"ghost",onClick:a,size:"sm",children:"닫기"})]})]})]})]})})}function Qe(){const[l,a]=w.useState(null),[t,n]=w.useState(!0),[r,o]=w.useState(null),[d,p]=w.useState(null),[h,u]=w.useState(!1),[g,N]=w.useState([]),[S,A]=w.useState([]),[R,O]=w.useState(new Set),[c,q]=w.useState(null),[D,T]=w.useState(!1),[B,X]=w.useState(null),[ue,ee]=w.useState(null),[xe,se]=w.useState(!1),C=re(),he=K(),U=w.useCallback(async(s=!0)=>{try{s&&n(!0);const i=K(),{data:{user:m},error:b}=await i.auth.getUser();if(b){console.error("Auth error:",b),P.error("인증 정보를 불러올 수 없습니다.");return}if(!m){console.error("No user found in auth"),P.error("로그인이 필요합니다.");return}const{data:x,error:f}=await i.from("employees").select("*").eq("email",m.email).single();if(f||!x){console.error("Employee fetch error:",f);const y={id:m.id,name:m.email?.split("@")[0]||"Guest User",email:m.email||"",purchase_role:null};try{const _=await z.getDashboardData(y);a(_)}catch(_){console.error("❌ 대시보드 데이터 로딩 에러:",_)}n(!1);return}console.log("🔍 조회된 Employee 데이터:",{id:x.id,name:x.name,email:x.email,employee_number:x.employee_number,employeeID:x.employeeID,purchase_role:x.purchase_role}),console.log("========== 대시보드 데이터 로딩 시작 =========="),console.log("1️⃣ 현재 사용자:",x.name,"/ Email:",x.email),console.log("2️⃣ Purchase Role:",x.purchase_role);try{const y=await z.getDashboardData(x),_=await z.getTotalDeliveryWaitingCount();a(y)}catch(y){console.error("❌ 대시보드 데이터 로딩 에러:",y),P.error("대시보드 데이터를 불러오는데 실패했습니다.")}if(x.purchase_role){const y=Array.isArray(x.purchase_role)?x.purchase_role.map(_=>String(_).trim()):String(x.purchase_role).split(",").map(_=>_.trim()).filter(_=>_.length>0);if(N(y),y.includes("lead buyer")||y.includes("lead buyer")){const _=await z.getUndownloadedOrders(x);A(_)}}}catch{}finally{s&&n(!1)}},[]);w.useEffect(()=>{U()},[U]);const te=async s=>{if(console.log("handleQuickApprove 호출:",{requestId:s,hasData:!!l,hasEmployee:!!l?.employee,employee:l?.employee}),!l?.employee){console.error("handleQuickApprove 에러: data.employee가 없음",{data:l}),P.error("사용자 정보를 찾을 수 없습니다.");return}if(!confirm("정말로 승인하시겠습니까?"))return;o(s);const i=l;a(m=>m&&{...m,pendingApprovals:m.pendingApprovals.filter(b=>b.id!==s),stats:{...m.stats,pending:Math.max(0,m.stats.pending-1)}});try{const m=await z.quickApprove(s,l.employee);m.success?(P.success("승인이 완료되었습니다."),setTimeout(()=>{U(!1)},1e3)):(a(i),P.error(m.error||"승인 처리 중 오류가 발생했습니다."))}catch{a(i),P.error("승인 처리 중 오류가 발생했습니다.")}finally{o(null)}},W=(s,i)=>{X(s),ee(i),se(!0)},ae=async s=>{try{O(k=>new Set(k).add(s.id));const i=new ye.Workbook,m=i.addWorksheet("발주서");m.columns=[{header:"발주번호",key:"purchase_order_number",width:20},{header:"업체명",key:"vendor_name",width:30},{header:"품목명",key:"item_name",width:40},{header:"규격",key:"specification",width:30},{header:"수량",key:"quantity",width:15},{header:"단가",key:"unit_price",width:20},{header:"금액",key:"amount",width:20},{header:"요청일",key:"request_date",width:15},{header:"진행상태",key:"progress_type",width:15}],(s.purchase_request_items||[]).forEach(k=>{m.addRow({purchase_order_number:s.purchase_order_number,vendor_name:s.vendor_name||s.vendors?.vendor_name||"",item_name:k.item_name||"",specification:k.specification||"",quantity:k.quantity||0,unit_price:k.unit_price_value||0,amount:k.amount_value||0,request_date:s.request_date||"",progress_type:s.progress_type||""})}),m.getRow(1).font={bold:!0},m.getRow(1).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFE0E0E0"}};const x=await i.xlsx.writeBuffer(),f=new Blob([x],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),y=window.URL.createObjectURL(f),_=document.createElement("a");_.href=y,_.download=`발주서_${s.purchase_order_number}_${new Date().toISOString().slice(0,10)}.xlsx`,_.click(),window.URL.revokeObjectURL(y),(g.includes("lead buyer")||g.includes("lead buyer"))&&(await he.from("purchase_requests").update({is_po_download:!0}).eq("id",s.id),A(k=>k.filter(Q=>Q.id!==s.id))),P.success("발주서가 다운로드되었습니다.")}catch(i){console.error("Excel download error:",i),P.error("다운로드 중 오류가 발생했습니다.")}finally{O(i=>{const m=new Set(i);return m.delete(s.id),m})}},pe=s=>{switch(s){case"high":return"bg-red-100 text-red-800 border-red-200";case"medium":return"bg-yellow-100 text-yellow-800 border-yellow-200";case"low":return"bg-green-100 text-green-800 border-green-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}};if(t)return e.jsx("div",{className:"flex items-center justify-center h-screen bg-gray-50",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-12 h-12 border-3 border-hansl-500 border-t-transparent rounded-full animate-spin mx-auto"}),e.jsx("p",{className:"mt-4 text-sm text-gray-600",children:"대시보드를 불러오고 있습니다..."})]})});if(!l?.employee)return e.jsx("div",{className:"flex items-center justify-center h-screen bg-gray-50",children:e.jsxs("div",{className:"text-center bg-white p-8 rounded-lg border border-gray-200",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"사용자 정보를 찾을 수 없습니다"}),e.jsx("p",{className:"text-sm text-gray-600",children:"로그인을 다시 시도해주세요."})]})});const ge=(Array.isArray(l.employee.purchase_role)?l.employee.purchase_role.map(s=>String(s).trim()):l.employee.purchase_role?String(l.employee.purchase_role).split(",").map(s=>s.trim()).filter(s=>s.length>0):[]).some(s=>["middle_manager","final_approver","app_admin","raw_material_manager","consumable_manager"].includes(s));return e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsxs("div",{className:"w-full px-4 lg:px-6",children:[e.jsx("div",{className:"mb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-gray-900",children:"대시보드"}),e.jsxs("p",{className:"text-xs text-gray-600 mt-0.5",children:[l.employee.name,"님, 환영합니다. 📊"]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(j,{variant:"outline",className:"text-xs",children:new Date().toLocaleDateString("ko-KR",{month:"long",day:"numeric",weekday:"short"})})})]})}),l.urgentRequests.length>0&&e.jsxs(M,{className:"mb-3 border-red-200 bg-red-50",children:[e.jsx(L,{className:"pb-2 pt-3",children:e.jsxs($,{className:"flex items-center gap-2 text-red-800 text-sm",children:[e.jsx(Se,{className:"w-4 h-4"}),"긴급 처리 필요 (",l.urgentRequests.length,"건)"]})}),e.jsx(E,{className:"p-3",children:e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2",children:l.urgentRequests.slice(0,5).map(s=>e.jsx("div",{className:"bg-white rounded-lg p-2 border border-red-200 min-w-[280px] flex-shrink-0",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-1 mb-1",children:[e.jsx(j,{className:`${pe(s.priority)} text-[10px] h-4 px-1`,children:s.priority==="high"?"높음":s.priority==="medium"?"보통":"낮음"}),e.jsx("span",{className:"text-xs font-medium text-gray-900 truncate max-w-[120px]",children:s.vendor_name||"업체명 없음"}),e.jsxs("span",{className:"text-[10px] text-gray-500",children:[s.daysOverdue,"일 지연"]})]}),e.jsxs("div",{className:"text-[10px] text-gray-600",children:[e.jsxs("span",{children:["발주: ",s.purchase_order_number||s.id.slice(0,8)]}),e.jsxs("span",{className:"ml-1",children:["• ",s.total_items,"개"]})]})]}),e.jsxs("div",{className:"flex gap-1 shrink-0",children:[e.jsxs(v,{size:"sm",variant:"outline",onClick:()=>C(`/purchase?highlight=${s.id}`),className:"h-6 px-2 text-[10px]",children:[e.jsx(je,{className:"w-3 h-3 mr-0.5"}),"보기"]}),e.jsxs(v,{size:"sm",onClick:()=>te(s.id),disabled:r===s.id,className:"bg-red-600 hover:bg-red-700 h-6 px-2 text-[10px]",children:[e.jsx(we,{className:"w-3 h-3 mr-0.5"}),r===s.id?"처리중":"승인"]})]})]})},s.id))})})]}),e.jsx("div",{className:"mb-2",children:e.jsxs("h2",{className:"text-sm font-semibold text-gray-900 mb-2 flex items-center gap-1.5",children:[e.jsx(Y,{className:"w-3.5 h-3.5 text-gray-600"}),"전체 현황"]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3",children:[(g.includes("lead buyer")||g.includes("lead buyer"))&&S.length>0&&e.jsxs(M,{className:"w-full col-span-1 row-span-2 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[e.jsx(L,{className:"py-3 px-4 bg-gray-50 border-b",children:e.jsxs($,{className:"text-sm font-semibold flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{className:"w-4 h-4 text-orange-600"}),e.jsx("span",{className:"text-gray-900",children:"미다운로드 발주서"})]}),e.jsx(j,{className:"bg-orange-100 text-orange-700 border-orange-200 px-2 py-0.5",children:S.length})]})}),e.jsx(E,{className:"p-4",children:e.jsxs("div",{className:"space-y-2",children:[S.slice(0,5).map(s=>{const i=s.purchase_request_items||[],m=i[0]||{},b=i.reduce((y,_)=>y+(Number(_.amount_value)||0),0);i.reduce((y,_)=>y+(Number(_.quantity)||0),0);const x=Math.floor((Date.now()-new Date(s.created_at).getTime())/(1e3*60*60*24)),f=s.progress_type==="선진행";return e.jsx("div",{className:`border rounded-lg p-3 transition-all cursor-pointer hover:shadow-sm ${f?"bg-red-50 hover:bg-red-100 border-red-200":"bg-white hover:bg-gray-50 border-gray-200"}`,onClick:()=>{q(s),T(!0)},children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-semibold text-sm text-gray-900",children:s.purchase_order_number||`PO-${s.id.slice(0,8)}`}),f&&e.jsx(j,{className:"text-[10px] bg-red-100 text-red-700 border-red-200 px-1.5 py-0",children:"선진행"}),x>3&&e.jsxs(j,{variant:"outline",className:"text-[10px] px-1.5 py-0",children:[x,"일 경과"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-xs text-gray-600",children:s.vendor_name||"업체명 없음"}),e.jsxs("div",{className:"text-xs text-gray-500",children:[m.item_name||"품목",i.length>1&&e.jsxs("span",{className:"text-gray-400",children:[" 외 ",i.length-1,"건"]})]})]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsxs("div",{className:"text-sm font-bold text-gray-900",children:["₩",b.toLocaleString()]}),e.jsx(v,{size:"sm",variant:"outline",className:"h-7 px-2 text-[10px] border-orange-200 hover:bg-orange-50",onClick:y=>{y.stopPropagation(),ae(s)},disabled:R.has(s.id),children:R.has(s.id)?e.jsx("div",{className:"w-3 h-3 border border-orange-600 border-t-transparent rounded-full animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"w-3 h-3 mr-1"}),"다운로드"]})})]})]})},s.id)}),S.length>5&&e.jsxs(v,{variant:"outline",size:"sm",className:"w-full text-xs h-8 border-gray-200 hover:bg-gray-50",onClick:()=>C("/purchase/list?tab=purchase"),children:["전체보기 (",S.length,"건) →"]})]})})]}),e.jsxs(M,{className:"w-full col-span-1 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[e.jsx(L,{className:"py-3 px-4 bg-gray-50 border-b",children:e.jsxs($,{className:"text-sm font-semibold flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(H,{className:"w-4 h-4 text-purple-600"}),e.jsx("span",{className:"text-gray-900",children:"내 승인 진행중"})]}),l.myRecentRequests.length>0&&e.jsx(j,{className:"bg-purple-100 text-purple-700 border-purple-200 px-2 py-0.5",children:l.myRecentRequests.length})]})}),e.jsx(E,{className:"p-4",children:l.myRecentRequests.length===0?e.jsxs("div",{className:"text-center py-12 text-gray-400",children:[e.jsx(H,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm font-medium",children:"승인 진행중인 항목이 없습니다"}),e.jsx(v,{size:"sm",variant:"outline",className:"mt-3 h-8 text-xs px-4 border-gray-200",onClick:()=>C("/purchase/new"),children:"새 요청 작성"})]}):e.jsxs("div",{className:"space-y-2",children:[l.myRecentRequests.slice(0,3).map(s=>{const i=s.middle_manager_status==="pending"?25:50;return e.jsx("div",{className:"border border-gray-200 rounded-lg p-3 bg-white hover:bg-gray-50 transition-all cursor-pointer hover:shadow-sm",onClick:()=>C(`/purchase?highlight=${s.id}`),children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-semibold text-sm text-gray-900",children:s.purchase_order_number||`PO-${s.id.slice(0,8)}`}),e.jsxs(j,{className:"text-[10px] bg-purple-100 text-purple-700 border-purple-200 px-1.5 py-0",children:[i,"% 진행"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-xs text-gray-600",children:s.vendor_name||"업체명 없음"}),e.jsxs("div",{className:"text-xs text-gray-500",children:[s.total_items,"개 품목"]}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("div",{className:"flex-1 bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-purple-600 h-2 rounded-full transition-all",style:{width:`${i}%`}})}),e.jsxs("span",{className:"text-[10px] text-gray-600",children:[i,"%"]})]})]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsxs("div",{className:"text-sm font-bold text-gray-900",children:["₩",(s.total_amount||0).toLocaleString()]}),e.jsx("div",{className:"text-[10px] text-gray-500",children:s.current_step==="approval"?"승인 대기":s.current_step==="purchase"?"구매 대기":"진행중"})]})]})},s.id)}),l.myRecentRequests.length>3&&e.jsxs(v,{variant:"outline",size:"sm",className:"w-full text-xs h-8 border-gray-200 hover:bg-gray-50",onClick:()=>C("/purchase"),children:["전체보기 (",l.myRecentRequests.length,"건) →"]})]})})]}),ge&&e.jsxs(M,{className:"w-full col-span-1 row-span-2",children:[e.jsx(L,{className:"pb-2 pt-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs($,{className:"text-xs sm:text-sm font-semibold flex items-center gap-1.5",children:[e.jsx(H,{className:"w-3.5 h-3.5 text-orange-500"}),"승인 대기",l.pendingApprovals.length>0&&e.jsx(j,{variant:"destructive",className:"text-[10px] h-4 px-1",children:l.pendingApprovals.length})]}),l.pendingApprovals.length>0&&e.jsx(v,{size:"sm",variant:"ghost",onClick:()=>C("/purchase"),className:"h-6 px-2",children:e.jsx(V,{className:"w-3 h-3"})})]})}),e.jsx(E,{className:"p-3",children:l.pendingApprovals.length===0?e.jsxs("div",{className:"text-center py-4 text-gray-400",children:[e.jsx(I,{className:"w-6 h-6 mx-auto mb-1"}),e.jsx("p",{className:"text-xs",children:"대기 항목 없음"})]}):e.jsx("div",{className:"space-y-1.5",children:l.pendingApprovals.slice(0,5).map(s=>{const i=s.purchase_request_items||[],m=i[0]||{},b=s.total_amount||i.reduce((f,y)=>f+(Number(y.amount_value)||0),0),x=s.progress_type==="선진행";return e.jsx("div",{className:`border rounded-lg p-2 hover:shadow-sm transition-all cursor-pointer ${x?"bg-red-50 border-red-200":"hover:bg-orange-50/30"}`,onClick:f=>{f.target.closest("button")||(p(Number(s.id)),u(!0))},children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-1 mb-1",children:[e.jsx("span",{className:"font-medium text-[11px]",children:s.purchase_order_number}),x&&e.jsx(j,{className:"text-[8px] bg-red-100 text-red-800 px-1 h-3.5",children:"선진행"})]}),e.jsxs("div",{className:"text-[10px] text-gray-600 space-y-0.5",children:[e.jsxs("div",{className:"truncate",children:[m.item_name||"품목"," ",i.length>1&&`외 ${i.length-1}건`]}),e.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[e.jsx("span",{className:"truncate max-w-[100px]",children:s.vendor_name||"업체"}),e.jsxs("span",{className:"font-semibold text-gray-900",children:["₩",(b/1e6).toFixed(1),"M"]})]})]})]}),e.jsx(v,{size:"sm",onClick:f=>{f.stopPropagation(),te(s.id)},disabled:r===s.id,className:`h-7 px-2 text-white text-[10px] shrink-0 ${s.middle_manager_status==="approved"?"bg-blue-600 hover:bg-blue-700":"bg-green-600 hover:bg-green-700"}`,children:r===s.id?e.jsx("div",{className:"w-3 h-3 border border-white border-t-transparent rounded-full animate-spin"}):e.jsxs(e.Fragment,{children:[s.middle_manager_status==="approved"?"최종":"1차"," 승인"]})})]})},s.id)})})})]}),e.jsxs(M,{className:"w-full col-span-1 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[e.jsx(L,{className:"py-3 px-4 bg-gray-50 border-b",children:e.jsxs($,{className:"text-sm font-semibold flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{className:"w-4 h-4 text-yellow-600"}),e.jsx("span",{className:"text-gray-900",children:"구매 대기"})]}),l.myPurchaseStatus&&l.myPurchaseStatus.waitingPurchase&&l.myPurchaseStatus.waitingPurchase.length>0&&e.jsx(j,{className:"bg-yellow-100 text-yellow-700 border-yellow-200 px-2 py-0.5",children:l.myPurchaseStatus.waitingPurchase.length})]})}),e.jsx(E,{className:"p-4",children:!l.myPurchaseStatus||!l.myPurchaseStatus.waitingPurchase||l.myPurchaseStatus.waitingPurchase.length===0?e.jsxs("div",{className:"text-center py-12 text-gray-400",children:[e.jsx(G,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm font-medium",children:"구매 대기 항목이 없습니다"})]}):e.jsxs("div",{className:"space-y-2",children:[l.myPurchaseStatus.waitingPurchase.slice(0,3).map(s=>{const i=s.purchase_request_items||[],m=i[0],b=i.reduce((f,y)=>f+(Number(y.amount_value)||0),0),x=(s.progress_type||"").includes("선진행");return e.jsx("div",{className:`border rounded-lg p-3 transition-all cursor-pointer hover:shadow-sm ${x?"bg-red-50 hover:bg-red-100 border-red-200":"bg-white hover:bg-gray-50 border-gray-200"}`,onClick:()=>W(s,"purchase"),children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-semibold text-sm text-gray-900",children:s.purchase_order_number||`PO-${s.id.slice(0,8)}`}),x&&e.jsx(j,{className:"text-[10px] bg-red-100 text-red-700 border-red-200 px-1.5 py-0",children:"선진행"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-xs text-gray-600",children:s.vendor_name||"업체명 없음"}),e.jsxs("div",{className:"text-xs text-gray-500",children:[m?.item_name||"품목",i.length>1&&e.jsxs("span",{className:"text-gray-400",children:[" 외 ",i.length-1,"건"]})]})]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsxs("div",{className:"text-sm font-bold text-gray-900",children:["₩",b.toLocaleString()]}),e.jsx("div",{className:"text-[10px] text-gray-500",children:new Date(s.request_date).toLocaleDateString("ko-KR")})]})]})},s.id)}),(g.includes("lead_buyer")||g.includes("lead buyer"))&&e.jsx(v,{className:"w-full bg-yellow-600 hover:bg-yellow-700 text-xs h-8",onClick:()=>C("/purchase/list"),children:"구매 처리하기"}),l.myPurchaseStatus.waitingPurchase.length>3&&e.jsxs(v,{variant:"outline",size:"sm",className:"w-full text-xs h-8 border-gray-200 hover:bg-gray-50",onClick:()=>C("/purchase?tab=purchase"),children:["전체보기 (",l.myPurchaseStatus.waitingPurchase.length,"건) →"]})]})})]}),e.jsxs(M,{className:"w-full col-span-1 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[e.jsx(L,{className:"py-3 px-4 bg-gray-50 border-b",children:e.jsxs($,{className:"text-sm font-semibold flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"w-4 h-4 text-blue-600"}),e.jsx("span",{className:"text-gray-900",children:"입고 대기"})]}),l.myPurchaseStatus.waitingDelivery.length>0&&e.jsx(j,{className:"bg-blue-100 text-blue-700 border-blue-200 px-2 py-0.5",children:l.myPurchaseStatus.waitingDelivery.length})]})}),e.jsx(E,{className:"p-4",children:l.myPurchaseStatus.waitingDelivery.length===0?e.jsxs("div",{className:"text-center py-12 text-gray-400",children:[e.jsx(Z,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm font-medium",children:"입고 대기 항목이 없습니다"})]}):e.jsxs("div",{className:"space-y-2",children:[l.myPurchaseStatus.waitingDelivery.slice(0,3).map(s=>{const i=s.purchase_request_items||[],m=i[0],b=i.length,x=i.filter(k=>k.is_received).length,f=b>0?Math.round(x/b*100):0,y=i.reduce((k,Q)=>k+(Number(Q.amount_value)||0),0),_=(s.progress_type||"").includes("선진행");return e.jsx("div",{className:`border rounded-lg p-3 transition-all cursor-pointer hover:shadow-sm ${_?"bg-red-50 hover:bg-red-100 border-red-200":"bg-white hover:bg-gray-50 border-gray-200"}`,onClick:()=>W(s,"delivery"),children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-semibold text-sm text-gray-900",children:s.purchase_order_number||`PO-${s.id.slice(0,8)}`}),_&&e.jsx(j,{className:"text-[10px] bg-red-100 text-red-700 border-red-200 px-1.5 py-0",children:"선진행"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-xs text-gray-600",children:s.vendor_name||"업체명 없음"}),e.jsxs("div",{className:"text-xs text-gray-500",children:[m?.item_name||"품목",b>1&&e.jsxs("span",{className:"text-gray-400",children:[" 외 ",b-1,"건"]})]}),s.delivery_request_date&&e.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["납기: ",new Date(s.delivery_request_date).toLocaleDateString("ko-KR")]})]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsxs("div",{className:"text-sm font-bold text-gray-900",children:["₩",y.toLocaleString()]}),f>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"text-[10px] text-gray-600",children:[x,"/",b," 입고 (",f,"%)"]}),e.jsx("div",{className:"w-16 bg-gray-200 rounded-full h-1.5",children:e.jsx("div",{className:"bg-blue-600 h-1.5 rounded-full",style:{width:`${f}%`}})})]})]})]})},s.id)}),l.myPurchaseStatus.waitingDelivery.length>3&&e.jsxs(v,{variant:"outline",size:"sm",className:"w-full text-xs h-8 border-gray-200 hover:bg-gray-50",onClick:()=>C("/purchase?tab=receipt"),children:["전체보기 (",l.myPurchaseStatus.waitingDelivery.length,"건) →"]})]})})]}),e.jsxs(M,{className:"w-full col-span-1 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[e.jsx(L,{className:"py-3 px-4 bg-gray-50 border-b",children:e.jsxs($,{className:"text-sm font-semibold flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-4 h-4 text-green-600"}),e.jsx("span",{className:"text-gray-900",children:"최근 완료"})]}),l.myPurchaseStatus.recentCompleted.length>0&&e.jsx(j,{className:"bg-green-100 text-green-700 border-green-200 px-2 py-0.5",children:l.myPurchaseStatus.recentCompleted.length})]})}),e.jsx(E,{className:"p-4",children:l.myPurchaseStatus.recentCompleted.length===0?e.jsxs("div",{className:"text-center py-12 text-gray-400",children:[e.jsx(I,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"text-sm font-medium",children:"최근 완료 항목이 없습니다"})]}):e.jsxs("div",{className:"space-y-2",children:[l.myPurchaseStatus.recentCompleted.slice(0,3).map(s=>{const i=s.purchase_request_items||[],m=i[0],b=i.reduce((x,f)=>x+(Number(f.amount_value)||0),0);return e.jsx("div",{className:"border border-green-200 rounded-lg p-3 bg-green-50 hover:bg-green-100 transition-all cursor-pointer hover:shadow-sm",onClick:()=>W(s,"completed"),children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-semibold text-sm text-gray-900",children:s.purchase_order_number||`PO-${s.id.slice(0,8)}`}),e.jsx(j,{className:"text-[10px] bg-green-100 text-green-700 border-green-200 px-1.5 py-0",children:"완료"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-xs text-gray-600",children:s.vendor_name||"업체명 없음"}),e.jsxs("div",{className:"text-xs text-gray-500",children:[m?.item_name||"품목",i.length>1&&e.jsxs("span",{className:"text-gray-400",children:[" 외 ",i.length-1,"건"]})]}),s.received_at&&e.jsxs("div",{className:"text-xs text-green-600 font-medium",children:["입고완료: ",new Date(s.received_at).toLocaleDateString("ko-KR")]})]})]}),e.jsxs("div",{className:"text-right space-y-1",children:[e.jsxs("div",{className:"text-sm font-bold text-gray-900",children:["₩",b.toLocaleString()]}),e.jsx("div",{className:"text-[10px] text-gray-500",children:new Date(s.received_at||s.created_at).toLocaleDateString("ko-KR")})]})]})},s.id)}),l.myPurchaseStatus.recentCompleted.length>3&&e.jsxs(v,{variant:"outline",size:"sm",className:"w-full text-xs h-8 border-gray-200 hover:bg-gray-50",onClick:()=>C("/purchase?tab=done"),children:["전체보기 (",l.myPurchaseStatus.recentCompleted.length,"건) →"]})]})})]})]})]}),e.jsx(_e,{purchaseId:d,isOpen:h,onClose:()=>{u(!1),p(null)},currentUserRoles:g,onRefresh:()=>{U(),u(!1),p(null)}}),e.jsx(ke,{isOpen:xe,onClose:()=>{se(!1),X(null),ee(null)},item:B,type:ue,onRefresh:()=>U(!1)}),D&&c&&e.jsx(ie,{open:D,onOpenChange:()=>{T(!1),q(null)},children:e.jsxs(ce,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(de,{children:[e.jsxs(oe,{className:"text-xl font-bold",children:[c.purchase_order_number," 상세보기"]}),e.jsx(me,{children:c.vendor_name||"업체명 없음"})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-6",children:[e.jsxs("h3",{className:"font-semibold mb-4 flex items-center text-gray-900",children:[e.jsx(ne,{className:"w-5 h-5 mr-2 text-gray-700"}),"기본 정보"]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-6",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"요청자"}),e.jsx("p",{className:"font-medium text-gray-900",children:c.requester_name})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"요청일"}),e.jsx("p",{className:"font-medium text-gray-900",children:new Date(c.request_date||c.created_at).toLocaleDateString("ko-KR")})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"납기요청일"}),e.jsx("p",{className:"font-medium text-gray-900",children:c.delivery_request_date?new Date(c.delivery_request_date).toLocaleDateString("ko-KR"):"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"결제유형"}),e.jsx("p",{className:"font-medium text-gray-900",children:c.payment_category||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"진행구분"}),e.jsx("p",{className:"font-medium text-gray-900",children:c.progress_type||"일반"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"상태"}),e.jsx("p",{className:"font-medium",children:e.jsx(j,{className:"bg-orange-50 text-orange-700 border-orange-200",children:"미다운로드"})})]})]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-6",children:[e.jsxs("h3",{className:"font-semibold mb-4 flex items-center text-gray-900",children:[e.jsx(le,{className:"w-5 h-5 mr-2 text-gray-700"}),"업체 정보"]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-6",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"업체명"}),e.jsx("p",{className:"font-medium text-gray-900",children:c.vendor_name||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"프로젝트 업체"}),e.jsx("p",{className:"font-medium text-gray-900",children:c.project_vendor||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"판매주문번호"}),e.jsx("p",{className:"font-medium text-gray-900",children:c.sales_order_number||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"프로젝트 품목"}),e.jsx("p",{className:"font-medium text-gray-900",children:c.project_item||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"발주서 템플릿"}),e.jsx("p",{className:"font-medium text-gray-900",children:c.po_template_type||"일반"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"통화"}),e.jsx("p",{className:"font-medium text-gray-900",children:c.currency||"KRW"})]})]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-6",children:[e.jsxs("h3",{className:"font-semibold mb-4 flex items-center text-gray-900",children:[e.jsx(Y,{className:"w-5 h-5 mr-2 text-gray-700"}),"품목 리스트"]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full bg-white rounded-lg overflow-hidden shadow-sm",children:[e.jsx("thead",{className:"bg-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"품명"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"규격"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"수량"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"단가"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"금액"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"비고"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:(c.purchase_request_items||[]).map((s,i)=>{const m=s.quantity>0?(Number(s.amount_value)||0)/s.quantity:0;return e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:"text-sm font-medium text-gray-900",children:s.item_name||"품목명 없음"})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:"text-sm text-gray-600",children:s.specification||"-"})}),e.jsx("td",{className:"px-4 py-3 text-center",children:e.jsx("span",{className:"text-sm font-medium text-gray-900",children:s.quantity||0})}),e.jsx("td",{className:"px-4 py-3 text-right",children:e.jsxs("span",{className:"text-sm text-gray-900",children:["₩",m.toLocaleString()]})}),e.jsx("td",{className:"px-4 py-3 text-right",children:e.jsxs("span",{className:"text-sm font-semibold text-gray-900",children:["₩",(Number(s.amount_value)||0).toLocaleString()]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:"text-sm text-gray-600",children:s.remark||"-"})})]},i)})})]})}),e.jsx("div",{className:"mt-6 bg-white rounded-lg p-4 shadow-sm",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"총"}),e.jsxs("span",{className:"ml-1 font-semibold text-gray-900",children:[(c.purchase_request_items||[]).reduce((s,i)=>s+(Number(i.quantity)||0),0),"개"]}),e.jsx("span",{className:"text-sm text-gray-600 ml-1",children:"항목"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"text-sm text-gray-600 block",children:"총액"}),e.jsxs("span",{className:"font-bold text-xl text-gray-900",children:["₩",(c.purchase_request_items||[]).reduce((s,i)=>s+(Number(i.amount_value)||0),0).toLocaleString()]})]})]})})]}),e.jsxs("div",{className:"flex justify-between gap-3 mt-6",children:[e.jsx("div",{className:"flex gap-2",children:e.jsxs(v,{onClick:()=>ae(c),disabled:R.has(c.id),className:"bg-orange-600 hover:bg-orange-700",size:"sm",children:[R.has(c.id)?e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}):e.jsx(J,{className:"w-4 h-4 mr-2"}),"Excel 다운로드"]})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(v,{variant:"outline",onClick:()=>C("/purchase/list?tab=purchase"),size:"sm",children:["발주 목록에서 보기",e.jsx(V,{className:"w-4 h-4 ml-2"})]}),e.jsx(v,{variant:"ghost",onClick:()=>{T(!1),q(null)},size:"sm",children:"닫기"})]})]})]})]})})]})}export{Qe as default};
//# sourceMappingURL=DashboardMain-B_5N2cTn.js.map
