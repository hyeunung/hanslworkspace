import{c as S,q as R,j as e,a as T,r as C,b as j,X as z}from"./index-Dv9d16If.js";import{D as P,a as B,b as M,c as H,I as g}from"./input-DUa4cizf.js";import{T as O,a as U,b as I,c as o,d as $,e as d}from"./table-CmddlnI6.js";import{B as E,t as L}from"./index-V7ajxhIs.js";import{E as A}from"./eye-Bmp-s4Ec.js";import{D as F}from"./download-BhudwEBV.js";import{P as X,f as V}from"./format-TRPNovzq.js";import{P as Z}from"./plus-D4n6UfPv.js";import{S as G}from"./save-DvZrlKDk.js";import{T as J}from"./card-BFToctv8.js";/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const K=[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"m14.5 12.5-5 5",key:"b62r18"}],["path",{d:"m9.5 12.5 5 5",key:"1rk7el"}]],Q=S("file-x",K),W=({itemId:w,receiptUrl:m,itemName:n,paymentCategory:v,onUpdate:y})=>{const[c,h]=R.useState(!1);if(v!=="현장 결제"&&v!=="현장결제")return null;const l=async()=>{if(m){h(!0);try{const u=new URL(m).pathname.split("/"),_=u.indexOf("receipt-images");if(_===-1)throw new Error("잘못된 영수증 URL입니다");const x=u.slice(_+1).join("/");console.log("📥 영수증 다운로드 시작:",x);const k=T(),{data:q,error:b}=await k.storage.from("receipt-images").download(x);if(b)throw b;const f=new Blob([q],{type:"image/jpeg"}),N=window.URL.createObjectURL(f),s=document.createElement("a");s.href=N,s.download=`영수증_${n}_${w}_${Date.now()}.jpg`,document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(N),console.log("✅ 영수증 다운로드 완료"),typeof window<"u"&&window.alert&&alert("✅ 영수증이 다운로드되었습니다.")}catch(i){console.error("❌ 영수증 다운로드 오류:",i),alert(`❌ 다운로드 실패: ${i instanceof Error?i.message:i}`)}finally{h(!1)}}},p=()=>{if(!m)return;const i=document.createElement("div");i.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      cursor: pointer;
    `;const u=document.createElement("img");u.src=m,u.style.cssText=`
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
      border-radius: 8px;
    `,i.appendChild(u),i.onclick=()=>document.body.removeChild(i),document.body.appendChild(i)};return m?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:p,className:"inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-semibold text-white bg-blue-500 hover:bg-blue-600 rounded-md transition-colors",title:"영수증 미리보기",children:[e.jsx(A,{className:"w-4 h-4"}),e.jsx("span",{children:"보기"})]}),e.jsxs("button",{onClick:l,disabled:c,className:"inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-semibold text-white bg-green-500 hover:bg-green-600 disabled:bg-gray-400 disabled:cursor-not-allowed rounded-md transition-colors",title:"영수증 다운로드",children:[e.jsx(F,{className:"w-4 h-4"}),e.jsx("span",{children:c?"다운로드 중...":"다운로드"})]})]}):e.jsxs("div",{className:"flex items-center gap-2 text-gray-400",children:[e.jsx(Q,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:"영수증 없음"})]})};function oe({isOpen:w,onClose:m,purchase:n,isAdmin:v,onUpdate:y}){const[c,h]=C.useState(n.items||[]),[l,p]=C.useState(!1),i=T(),u=()=>{p(!0),h([...n.items||[]])},_=()=>{p(!1),h(n.items||[])},x=(s,t,r)=>{const a=[...c];a[s]={...a[s],[t]:t==="quantity"||t==="unit_price_value"||t==="amount_value"?Number(r):r},(t==="quantity"||t==="unit_price_value")&&(a[s].amount_value=a[s].quantity*(a[s].unit_price_value||0)),h(a)},k=()=>{const s={line_number:c.length+1,item_name:"",specification:"",quantity:0,unit_price_value:0,amount_value:0,remark:"",is_received:!1};h([...c,s])},q=s=>{const t=c.filter((r,a)=>a!==s);t.forEach((r,a)=>{r.line_number=a+1}),h(t)},b=async()=>{try{await i.from("purchase_request_items").delete().eq("purchase_request_id",n.id);const s=c.map(a=>({purchase_request_id:n.id,purchase_order_number:n.purchase_order_number,line_number:a.line_number,item_name:a.item_name,specification:a.specification,quantity:a.quantity,unit_price_value:a.unit_price_value,amount_value:a.amount_value,remark:a.remark,link:a.link,is_received:a.is_received||!1,delivery_status:a.delivery_status||"pending"})),{error:t}=await i.from("purchase_request_items").insert(s);if(t)throw t;const r=c.reduce((a,D)=>a+(D.amount_value||0),0);await i.from("purchase_requests").update({total_amount:r}).eq("id",n.id),L.success("품목이 수정되었습니다."),p(!1),y(),m()}catch{L.error("저장 중 오류가 발생했습니다.")}},f=l?c:n.items||[],N=f.reduce((s,t)=>s+(t.amount_value||0),0);return e.jsx(P,{open:w,onOpenChange:m,children:e.jsxs(B,{className:"w-full max-w-[95vw] sm:max-w-6xl max-h-[80vh] overflow-hidden flex flex-col bg-white",children:[e.jsx(M,{className:"flex-shrink-0",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(H,{className:"text-xl font-bold",children:["발주 상세 항목 - ",n.purchase_order_number]}),e.jsxs("div",{className:"flex items-center gap-2",children:[v&&!l&&e.jsxs(j,{variant:"outline",size:"sm",onClick:u,children:[e.jsx(X,{className:"h-4 w-4 mr-1"}),"편집"]}),l&&e.jsxs(e.Fragment,{children:[e.jsxs(j,{variant:"outline",size:"sm",onClick:k,children:[e.jsx(Z,{className:"h-4 w-4 mr-1"}),"품목 추가"]}),e.jsxs(j,{variant:"default",size:"sm",onClick:b,children:[e.jsx(G,{className:"h-4 w-4 mr-1"}),"저장"]}),e.jsx(j,{variant:"ghost",size:"sm",onClick:_,children:"취소"})]}),e.jsx(j,{variant:"ghost",size:"icon",onClick:m,className:"h-6 w-6",children:e.jsx(z,{className:"h-4 w-4"})})]})]})}),e.jsxs("div",{className:"flex-shrink-0 grid grid-cols-2 md:grid-cols-4 gap-4 py-4 border-b",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"업체명"}),e.jsx("p",{className:"font-medium",children:n.vendor_name})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"요청자"}),e.jsx("p",{className:"font-medium",children:n.requester_name})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"프로젝트"}),e.jsx("p",{className:"font-medium truncate",title:n.project_vendor,children:n.project_vendor})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"납기일"}),e.jsx("p",{className:"font-medium",children:n.delivery_request_date&&V(new Date(n.delivery_request_date),"yyyy-MM-dd")})]})]}),e.jsx("div",{className:"flex-1 overflow-auto",children:e.jsxs(O,{children:[e.jsx(U,{className:"sticky top-0 bg-white z-10",children:e.jsxs(I,{children:[e.jsx(o,{className:"w-12",children:"No."}),e.jsx(o,{children:"품목"}),e.jsx(o,{children:"규격"}),e.jsx(o,{className:"text-right",children:"수량"}),e.jsx(o,{className:"text-right",children:"단가"}),e.jsx(o,{className:"text-right",children:"금액"}),e.jsx(o,{children:"입고상태"}),e.jsx(o,{children:"영수증"}),e.jsx(o,{children:"비고"}),l&&e.jsx(o,{className:"w-20",children:"삭제"})]})}),e.jsx($,{children:f.map((s,t)=>e.jsxs(I,{children:[e.jsx(d,{className:"font-medium",children:s.line_number||t+1}),e.jsx(d,{children:l?e.jsx(g,{value:s.item_name,onChange:r=>x(t,"item_name",r.target.value),className:"h-8 text-sm"}):e.jsx("div",{className:"sm:max-w-[200px]",children:e.jsx("p",{className:"font-medium truncate",title:s.item_name,children:s.item_name})})}),e.jsx(d,{children:l?e.jsx(g,{value:s.specification,onChange:r=>x(t,"specification",r.target.value),className:"h-8 text-sm"}):e.jsx("div",{className:"sm:max-w-[150px] truncate",title:s.specification,children:s.specification})}),e.jsx(d,{className:"text-right",children:l?e.jsx(g,{type:"number",value:s.quantity,onChange:r=>x(t,"quantity",r.target.value),className:"h-8 text-sm text-right"}):e.jsx("span",{className:"font-medium",children:s.quantity.toLocaleString()})}),e.jsx(d,{className:"text-right",children:l?e.jsx(g,{type:"number",value:s.unit_price_value,onChange:r=>x(t,"unit_price_value",r.target.value),className:"h-8 text-sm text-right"}):e.jsxs("span",{children:[(s.unit_price_value||0).toLocaleString()," ",n.currency]})}),e.jsx(d,{className:"text-right",children:l?e.jsx(g,{type:"number",value:s.amount_value,onChange:r=>x(t,"amount_value",r.target.value),className:"h-8 text-sm text-right font-medium"}):e.jsxs("span",{className:"font-medium",children:[(s.amount_value||0).toLocaleString()," ",n.currency]})}),e.jsx(d,{children:s.is_received?e.jsx(E,{className:"bg-green-100 text-green-800",children:"입고완료"}):e.jsx(E,{variant:"outline",children:"대기"})}),e.jsx(d,{children:e.jsx(W,{itemId:Number(s.id),receiptUrl:s.receipt_image_url,itemName:s.item_name,onUpdate:y})}),e.jsx(d,{children:l?e.jsx(g,{value:s.remark||"",onChange:r=>x(t,"remark",r.target.value),className:"h-8 text-sm",placeholder:"비고"}):e.jsx("div",{className:"sm:max-w-[150px]",children:e.jsx("span",{className:"text-sm text-gray-500 truncate block",title:s.remark,children:s.remark||"-"})})}),l&&e.jsx(d,{children:e.jsx(j,{variant:"ghost",size:"icon",onClick:()=>q(t),className:"h-8 w-8 text-red-500 hover:text-red-700",children:e.jsx(J,{className:"h-4 w-4"})})})]},s.id||t))})]})}),e.jsxs("div",{className:"flex-shrink-0 border-t pt-4 flex justify-between items-center",children:[e.jsxs("div",{className:"text-sm text-gray-500",children:["총 ",f.length,"개 품목"]}),e.jsxs("div",{className:"text-lg font-bold",children:["총 금액: ",N.toLocaleString()," ",n.currency]})]})]})})}export{oe as default};
//# sourceMappingURL=PurchaseItemsModal-Bdj3iIAJ.js.map
