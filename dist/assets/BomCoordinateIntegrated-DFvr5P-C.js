import{e,r as t,j as a,x as s,c as r,B as n,b as i,P as l,h as o,X as c,_ as d}from"./index-B0aFbCDa.js";import{t as m}from"./index-DqxGfJS2.js";import{C as p,c as x,T as h}from"./card-rzhbDXoW.js";import{D as u,a as g,b as f,c as y,P as N,I as b}from"./dialog-B9JpRg3-.js";import{L as j}from"./label-tQeQKrVk.js";import{C as w,a as _,b as v,f as C,c as S,d as O,e as T}from"./command-COjVEF7U.js";import{P as D,a as E,b as M}from"./popover-DZeKSEjt.js";import{B as k,P}from"./badge-BDxjb12i.js";import{T as R,a as F,b as I,c as B,d as U,e as $}from"./table-CHg4DtSi.js";import{E as L}from"./exceljs.min-qiOTCNPp.js";import{L as A}from"./loader-circle-Yppxpi33.js";import{D as q}from"./download-DE4_RAxd.js";import{read as W,utils as Q}from"./xlsx-ByDo_lG2.js";import{E as z}from"./eye-DrqZPcgx.js";import{C as V}from"./check-BFmJFwUt.js";import{R as H}from"./rotate-ccw-BnrU5g2N.js";import{S as G}from"./save-xm8dx6KV.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const X=e("link-2",[["path",{d:"M9 17H7A5 5 0 0 1 7 7h2",key:"8i5ue5"}],["path",{d:"M15 7h2a5 5 0 1 1 0 10h-2",key:"1b9ql8"}],["line",{x1:"8",x2:"16",y1:"12",y2:"12",key:"1jonct"}]]),Y=t.createContext(null),K=t.forwardRef(({className:e,defaultValue:r,value:n,onValueChange:i,...l},o)=>{const[c,d]=t.useState(r||""),m=void 0!==n?n:c,p=t.useCallback(e=>{i?i(e):d(e)},[i]);return a.jsx(Y.Provider,{value:{value:m,onValueChange:p},children:a.jsx("div",{ref:o,className:s("",e),...l})})});K.displayName="Tabs";const J=t.forwardRef(({className:e,...t},r)=>a.jsx("div",{ref:r,className:s("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",e),...t}));J.displayName="TabsList";const Z=t.forwardRef(({className:e,value:r,onClick:n,...i},l)=>{const o=t.useContext(Y);if(!o)throw new Error("TabsTrigger must be used within a Tabs component");const c=o.value===r;return a.jsx("button",{ref:l,type:"button",role:"tab","aria-selected":c,"data-state":c?"active":"inactive",className:s("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",e),onClick:e=>{o.onValueChange(r),n?.(e)},...i})});Z.displayName="TabsTrigger";const ee=t.forwardRef(({className:e,value:r,...n},i)=>{const l=t.useContext(Y);if(!l)throw new Error("TabsContent must be used within a Tabs component");return l.value!==r?null:a.jsx("div",{ref:i,role:"tabpanel",className:s("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",e),...n})});async function te(e,t,a,s){const r=new L.Workbook;try{const e=await fetch("/templates/BOM_Template.xlsx");if(!e.ok)throw new Error("템플릿 파일을 찾을 수 없습니다.");const t=await e.arrayBuffer();await r.xlsx.load(t)}catch(i){throw new Error("템플릿 파일 로드에 실패했습니다.")}r.creator="HANSL BOM System",r.modified=new Date,function(e,t,a){const s=e.worksheets[0];if(!s)throw new Error("BOM 시트를 찾을 수 없습니다.");const r=(a.boardName||"").trim().replace(/_\d{6}_정리본$/,"").replace(/_정리본$/,"").replace(/_\d{6}$/,"");r&&(s.name=r.substring(0,31));s.getCell("A2").value=a.artworkManager||"",s.getCell("C2").value=a.productionManager||"",s.getCell("H3").value=r,s.getCell("H5").value=`${r} 부품리스트`,s.mergeCells("A7:J7");const n=s.getCell("A7");n.value=`${r}  |  SET : ${a.productionQuantity}`,n.alignment={horizontal:"center",vertical:"middle"},n.font={bold:!0};const i=8,l={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}};let o="";t.forEach((e,r)=>{const n=i+r,c=s.getRow(n);c.getCell("A").value=r+1;const d=e.itemType||"";d!==o?(c.getCell("B").value=d,o=d):c.getCell("B").value="",c.getCell("C").value=e.itemName||"",c.getCell("D").value=e.setCount||0;const m=(e.itemName||"").toUpperCase(),p=(e.remark||"").toUpperCase().includes("미삽")||m.includes("_OPEN")||m.includes("OPEN_")||m.includes("_POGO")||m.includes("POGO_")||m.includes("_PAD")||m.includes("PAD_")||m.includes("_NC")||m.includes("NC_"),x=e.setCount||0;c.getCell("E").value=p?0:a.productionQuantity*x,c.getCell("G").value="□양호 □불량",c.getCell("H").value=e.refList||"",c.getCell("J").value=p?"미삽":e.remark||"";const h=[1,4,5,7,10],u={size:11,name:"굴림체",family:3,charset:129,color:p?{argb:"FFFF0000"}:{argb:"FF000000"}},g=d!==(r<t.length-1&&t[r+1].itemType||""),f=d!==(r>0&&t[r-1].itemType||"");for(let t=1;t<=10;t++){const e=c.getCell(t);let a=l;2===t&&(a={left:{style:"thin"},right:{style:"thin"},top:f?{style:"thin"}:void 0,bottom:g?{style:"thin"}:void 0}),e.style={font:u,border:a,alignment:{vertical:"middle",horizontal:h.includes(t)?"center":"left",wrapText:!0}}}const y=(e.refList||"").length;if(y>50){const e=Math.ceil(y/50);c.height=Math.max(15,15*e)}c.commit()})}(r,e,s),ae(r,"TOP",t),ae(r,"BOTTOM",a);const n=await r.xlsx.writeBuffer();return new Blob([n],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"})}function ae(e,t,a){if(0===a.length)return;const s=e.getWorksheet(t);if(!s)return;let r="";a.forEach((e,n)=>{const i=s.getRow(2+n),l=e.type||"";n<a.length-1&&a[n+1].type;const o=l!==r,c=n===a.length-1;o?(i.getCell("A").value=l,r=l):i.getCell("A").value="",i.getCell("B").value=e.partName||"",i.getCell("C").value=e.refDes||"",i.getCell("D").value=e.layer||t,i.getCell("E").value=e.locationX||0,i.getCell("F").value=e.locationY||0,i.getCell("G").value=e.rotation||0,i.getCell("H").value=e.remark||"";const d=(e.partName||"").toUpperCase(),m=(e.remark||"").toUpperCase().includes("미삽")||d.includes("_OPEN")||d.includes("OPEN_")||d.includes("_POGO")||d.includes("POGO_")||d.includes("_PAD")||d.includes("PAD_")||d.includes("_NC")||d.includes("NC_");for(let t=1;t<=8;t++){i.getCell(t).style={font:{size:10,name:"굴림체",color:m?{argb:"FFFF0000"}:{argb:"FF000000"}},alignment:{vertical:"middle",horizontal:t<=2?"left":"center"},border:{top:o?{style:"thick"}:void 0,bottom:c?{style:"thick"}:void 0,left:void 0,right:void 0}}}i.commit()})}async function se(e,t){if("showSaveFilePicker"in window)try{const a=await window.showSaveFilePicker({suggestedName:t,types:[{description:"Excel 파일",accept:{"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":[".xlsx"]}}]}),s=await a.createWritable();return await s.write(e),void(await s.close())}catch(r){if("AbortError"===r.name)return}const a=URL.createObjectURL(e),s=document.createElement("a");s.href=a,s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(a)}ee.displayName="TabsContent";const re=t.forwardRef(({bomItems:e,coordinates:s,boardName:r,productionQuantity:n,artworkManager:i="",productionManager:l="",onSave:o,onMergeStateChange:c,onBomChange:d},p)=>{const[x,h]=t.useState(e),[u,g]=t.useState(null),f=t.useRef({});t.useEffect(()=>{h(e)},[e]),t.useLayoutEffect(()=>{Object.values(f.current).forEach(e=>{if(e){e.style.height="auto";const t=Math.max(24,e.scrollHeight);e.style.height=t+"px"}})},[x]),x.filter(e=>e.isManualRequired).length,x.filter(e=>e.isNewPart).length,x.filter(e=>"미삽"===e.remark).length;const y=x.reduce((e,t)=>e+(t.setCount||0),0),N=t.useMemo(()=>{const e=new Set;return s.forEach(t=>{t.refDes&&e.add(t.refDes.trim().toUpperCase())}),e},[s]),b=e=>{if(!e.refList)return!1;return e.refList.split(",").map(e=>e.trim().toUpperCase()).filter(Boolean).some(e=>!N.has(e))},j=(e,t=10)=>{const a=document.createElement("canvas").getContext("2d");return a?(a.font=`${t}px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif`,Math.ceil(a.measureText(e).width)):10*e.length},w=Math.max(...x.map(e=>j(e.itemType||"",10)),j("종류",10),50)+20,_=Math.max(...x.map(e=>j(e.itemName||"",10)),j("품명",10),100)+20,v=x.flatMap(e=>(e.refList||"").split(",").map(e=>e.trim()).filter(e=>e)),C=(v.length>0?v.reduce((e,t)=>e+j(t,10),0)/v.length:j("C10",10))+j(", ",10),S=Math.ceil(15.5*C)+20,O=Math.max(j(String(x.length),10),j("No",10),30)+20,T=async()=>{try{if(!x||0===x.length)throw new Error("BOM 데이터가 없습니다. 데이터를 확인해주세요.");if(!r||""===r.trim())throw new Error("보드 이름이 설정되지 않았습니다.");const e=x.filter(e=>e.isManualRequired&&("데이터 없음 (수동 확인 필요)"===e.itemName||"데이터 없음"===e.itemType));if(e.length>0){if(!window.confirm(`수동 확인이 필요한 항목이 ${e.length}개 있습니다.\n그대로 다운로드하시겠습니까?\n\n(해당 항목들은 "데이터 없음"으로 표시됩니다)`))return}const t={boardName:r,artworkManager:i,productionManager:l,productionQuantity:n},a=s.filter(e=>"TOP"===e.layer),o=s.filter(e=>"BOTTOM"===e.layer),c=await te(x,a,o,t);if(!c||0===c.size)throw new Error("엑셀 파일 생성에 실패했습니다. (빈 파일)");const d=new Date,p=d.getFullYear().toString().slice(2)+String(d.getMonth()+1).padStart(2,"0")+String(d.getDate()).padStart(2,"0");se(c,`${r.trim().replace(/_\d{6}_정리본$/,"").replace(/_정리본$/,"").replace(/_\d{6}$/,"")}_${p}_정리본.xlsx`),m.success("엑셀 파일이 다운로드되었습니다.")}catch(e){let t="알 수 없는 오류";e instanceof Error&&(t=e.message),m.error(`다운로드 중 오류가 발생했습니다: ${t}`)}},D=()=>{confirm("모든 수정사항을 초기화하시겠습니까?")&&h(e)},E=()=>{if(u)return h(u),g(null),c?.(!1),void m.success("합치기가 해제되었습니다.");const e=new Map;x.forEach(t=>{if(t.itemName.includes("데이터 없음")||"데이터 없음"===t.itemType){const a=`__unique__${t.lineNumber}`;return void e.set(a,[t])}const a=`${t.itemType}|${t.itemName}`;e.has(a)||e.set(a,[]),e.get(a).push(t)});let t=0;if(e.forEach(e=>{e.length>1&&t++}),0===t)return void m.info("합칠 수 있는 동일 항목이 없습니다.");if(!confirm(`동일한 종류+품명 항목 ${t}건을 합치시겠습니까?`))return;g([...x]);const a=[];let s=1;e.forEach(e=>{if(1===e.length)a.push({...e[0],lineNumber:s++});else{const t=e[0],r=e.map(e=>e.refList).join(", "),n=e.reduce((e,t)=>e+(t.setCount||0),0),i=e.reduce((e,t)=>e+(t.totalQuantity||0),0);a.push({...t,lineNumber:s++,refList:r,setCount:n,totalQuantity:i})}}),h(a),c?.(!0),m.success(`${t}건의 동일 항목이 합쳐졌습니다.`)},M=()=>{o(x)};t.useImperativeHandle(p,()=>({handleDownload:T,handleSave:M,handleReset:D,handleMerge:E,isMerged:()=>null!==u}));const k=(e,t,a)=>{const s=[...x],r={...s[e]};r[t]="setCount"===t||"totalQuantity"===t||"stockQuantity"===t?Number(a)||0:a,"itemName"===t&&a&&"데이터 없음 (수동 확인 필요)"!==a&&(r.isManualRequired=!1),"itemType"===t&&a&&"데이터 없음"!==a&&(r.isNewPart=!1),s[e]=r,h(s),"itemType"!==t&&"itemName"!==t||d?.(s)},P=e=>e.isManualRequired?"bg-yellow-50 hover:bg-yellow-100":b(e)?"bg-red-50 hover:bg-red-100":e.isNewPart?"bg-gray-100 hover:bg-gray-200":"미삽"===e.remark?"bg-gray-50 hover:bg-gray-100":"hover:bg-gray-50";return a.jsx("div",{className:"space-y-3",children:a.jsx("div",{className:"border rounded-lg overflow-hidden bg-white shadow-sm w-full",children:a.jsx("div",{className:"overflow-x-auto w-full max-w-full",children:a.jsxs(R,{className:"w-full",style:{tableLayout:"fixed"},children:[a.jsx(F,{className:"bg-gray-50 sticky top-0 z-10",children:a.jsxs(I,{className:"h-6",children:[a.jsx(B,{className:"text-center !h-auto !py-0.5 !px-2",style:{width:`${O}px`},children:a.jsx("span",{className:"card-description",children:"No"})}),a.jsx(B,{className:"text-center whitespace-nowrap !h-auto !py-0.5 !px-2",style:{width:`${w}px`},children:a.jsx("span",{className:"card-description",children:"종류"})}),a.jsx(B,{className:"whitespace-nowrap !h-auto !py-0.5 !px-2",style:{width:`${_}px`},children:a.jsx("span",{className:"card-description",children:"품명"})}),a.jsx(B,{className:"w-[60px] text-center !h-auto !py-0.5 !px-2",children:a.jsx("span",{className:"card-description",children:"SET"})}),a.jsx(B,{className:"w-[70px] text-center !h-auto !py-0.5 !px-2",children:a.jsx("span",{className:"card-description",children:"수량"})}),a.jsx(B,{className:"w-[60px] text-center hidden sm:table-cell !h-auto !py-0.5 !px-2",children:a.jsx("span",{className:"card-description",children:"재고"})}),a.jsx(B,{className:"!h-auto !py-0.5 !px-2",style:{width:`${Math.min(S,350)}px`},children:a.jsx("span",{className:"card-description",children:"REF"})}),a.jsx(B,{className:"hidden md:table-cell !h-auto !py-0.5 !px-2",style:{width:"240px"},children:a.jsx("span",{className:"card-description",children:"대체품"})}),a.jsx(B,{className:"!h-auto !py-0.5 !px-2",children:a.jsx("span",{className:"card-description",children:"비고"})})]})}),a.jsx(U,{children:x.map((e,t)=>a.jsxs(I,{className:P(e),children:[a.jsx($,{className:"text-center py-1 px-2",children:a.jsx("div",{className:"card-subtitle",children:t+1})}),a.jsx($,{className:"text-center py-1 px-1 whitespace-nowrap",children:a.jsx("input",{type:"text",className:"w-full text-[10px] text-gray-600 text-center border border-transparent hover:border-gray-200 focus:border-primary focus:outline-none rounded px-1 "+("데이터 없음"===e.itemType?"!text-red-500 font-bold bg-red-50":"bg-transparent"),style:{fontSize:"10px",height:"24px"},value:e.itemType||"",onChange:e=>k(t,"itemType",e.target.value),placeholder:"종류"})}),a.jsx($,{className:"py-1 px-1 whitespace-nowrap",children:a.jsx("input",{type:"text",className:"w-full text-[10px] border border-transparent hover:border-gray-200 focus:border-primary focus:outline-none rounded px-1 "+(b(e)?"text-gray-500 bg-red-50":e.isNewPart?"text-gray-500 bg-gray-100":e.isManualRequired?"text-red-600 bg-yellow-50":"text-gray-500 bg-transparent"),style:{fontSize:"10px",height:"24px"},value:e.itemName,onChange:e=>k(t,"itemName",e.target.value),placeholder:"품명 입력",title:e.originalFootprint?`원본: ${e.originalFootprint}`:""})}),a.jsx($,{className:"text-center py-1 px-2",children:a.jsx("input",{type:"number",className:"w-full text-[10px] font-medium text-gray-900 text-center border border-transparent hover:border-gray-200 focus:border-primary focus:outline-none rounded bg-transparent px-1",style:{fontSize:"10px",height:"24px"},value:e.setCount,onChange:e=>k(t,"setCount",e.target.value)})}),a.jsx($,{className:"text-center py-1 px-2",children:a.jsx("input",{type:"number",className:"w-full text-[10px] font-bold text-gray-900 text-center border border-transparent hover:border-gray-200 focus:border-primary focus:outline-none rounded bg-gray-50 px-1",style:{fontSize:"10px",height:"24px"},value:e.totalQuantity,readOnly:!0,onChange:e=>k(t,"totalQuantity",e.target.value)})}),a.jsx($,{className:"hidden sm:table-cell text-center py-1 px-2",children:a.jsx("input",{type:"number",className:"w-full text-[10px] font-medium text-gray-900 text-center border border-transparent hover:border-gray-200 focus:border-primary focus:outline-none rounded bg-transparent px-1",style:{fontSize:"10px",height:"24px"},value:e.stockQuantity||"",placeholder:"0",onChange:e=>k(t,"stockQuantity",e.target.value)})}),a.jsx($,{className:"px-1 py-1 align-middle",children:a.jsx("div",{contentEditable:!0,suppressContentEditableWarning:!0,className:"text-[10px] text-gray-600 outline-none w-full",style:{lineHeight:"14px",wordWrap:"break-word",overflowWrap:"break-word",whiteSpace:"pre-wrap"},onBlur:e=>k(t,"refList",e.currentTarget.textContent||""),children:(e.refList||"").split(",").map(e=>e.trim()).filter(e=>e).join(", ")})}),a.jsx($,{className:"hidden md:table-cell py-1 px-2",children:a.jsx("input",{type:"text",className:"w-full text-[10px] text-gray-500 px-1 border border-transparent hover:border-gray-200 focus:border-primary focus:outline-none rounded bg-transparent",style:{fontSize:"10px",height:"24px"},value:e.alternativeItem||"",onChange:e=>k(t,"alternativeItem",e.target.value)})}),a.jsx($,{className:"py-1 px-2",children:a.jsx("input",{type:"text",className:"w-full text-[10px] text-gray-500 px-1 border border-transparent hover:border-gray-200 focus:border-primary focus:outline-none rounded "+("미삽"===e.remark?"!text-gray-500 font-bold bg-gray-50":"bg-transparent"),style:{fontSize:"10px",height:"24px"},value:e.remark||"",onChange:e=>k(t,"remark",e.target.value)})})]},t))}),a.jsx("tfoot",{className:"bg-gray-50 border-t",children:a.jsxs("tr",{children:[a.jsx("td",{className:"py-2 px-2",children:a.jsxs("span",{className:"card-description whitespace-nowrap",children:["총 ",x.length,"개 항목"]})}),a.jsx("td",{}),a.jsx("td",{className:"text-right pr-2",children:a.jsx("span",{className:"card-description",children:"합계:"})}),a.jsx("td",{className:"text-center py-2",children:a.jsx("span",{className:"text-[11px] text-gray-700",children:y})}),a.jsx("td",{}),a.jsx("td",{className:"hidden sm:table-cell"}),a.jsx("td",{}),a.jsx("td",{className:"hidden md:table-cell"}),a.jsx("td",{className:"py-2 px-2 text-right",children:a.jsxs("div",{className:"flex gap-4 card-description justify-end whitespace-nowrap",children:[a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"w-3 h-3 bg-yellow-100 border border-yellow-300 rounded"}),"수동 확인"]}),a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"w-3 h-3 bg-red-50 border border-red-200 rounded"}),"미삽"]})]})})]})})]})})})})});function ne({coordinates:e,bomItems:s=[]}){const r=e.filter(e=>"TOP"===e.layer),n=e.filter(e=>"BOTTOM"===e.layer),i=t.useMemo(()=>{const e=new Set;return s.forEach(t=>{if(t.refList){t.refList.split(",").map(e=>e.trim().toUpperCase()).filter(Boolean).forEach(t=>e.add(t))}}),e},[s]);return a.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4 w-full",children:[a.jsxs("div",{className:"w-full",children:[a.jsxs("div",{className:"mb-2 flex items-center gap-2",children:[a.jsx("h4",{className:"text-xs font-semibold text-gray-700",children:"TOP"}),a.jsx("span",{className:"badge-stats bg-gray-100 text-gray-600",children:r.length})]}),a.jsx(ie,{data:r,bomRefSet:i})]}),a.jsxs("div",{className:"w-full",children:[a.jsxs("div",{className:"mb-2 flex items-center gap-2",children:[a.jsx("h4",{className:"text-xs font-semibold text-gray-700",children:"BOTTOM"}),a.jsx("span",{className:"badge-stats bg-gray-100 text-gray-600",children:n.length})]}),a.jsx(ie,{data:n,bomRefSet:i})]})]})}function ie({data:e,bomRefSet:t}){const s=e.length;return a.jsx("div",{className:"border rounded-lg overflow-hidden bg-white shadow-sm w-full",children:a.jsx("div",{className:"overflow-x-auto w-full max-w-full",children:a.jsxs(R,{className:"w-full table-auto",children:[a.jsx(F,{className:"bg-gray-50 sticky top-0 z-10",children:a.jsxs(I,{className:"h-6",children:[a.jsx(B,{className:"w-[50px] text-center !h-auto !py-0.5 !px-2",children:a.jsx("span",{className:"card-description",children:"No"})}),a.jsx(B,{className:"text-center whitespace-nowrap !h-auto !py-0.5 !px-2",style:{minWidth:"80px"},children:a.jsx("span",{className:"card-description",children:"종류"})}),a.jsx(B,{className:"whitespace-nowrap !h-auto !py-0.5 !px-2",style:{minWidth:"120px"},children:a.jsx("span",{className:"card-description",children:"품명"})}),a.jsx(B,{className:"w-[80px] text-center !h-auto !py-0.5 !px-2",children:a.jsx("span",{className:"card-description",children:"RefDes"})}),a.jsx(B,{className:"w-[70px] text-center !h-auto !py-0.5 !px-2",children:a.jsx("span",{className:"card-description",children:"Layer"})}),a.jsx(B,{className:"w-[90px] text-center !h-auto !py-0.5 !px-2",children:a.jsx("span",{className:"card-description",children:"X"})}),a.jsx(B,{className:"w-[90px] text-center !h-auto !py-0.5 !px-2",children:a.jsx("span",{className:"card-description",children:"Y"})}),a.jsx(B,{className:"w-[70px] text-center !h-auto !py-0.5 !px-2",children:a.jsx("span",{className:"card-description",children:"Angle"})}),a.jsx(B,{className:"!h-auto !py-0.5 !px-2",style:{minWidth:"80px"},children:a.jsx("span",{className:"card-description",children:"비고"})})]})}),a.jsx(U,{children:0===e.length?a.jsx(I,{children:a.jsx($,{colSpan:9,className:"text-center py-6 card-description",children:"데이터가 없습니다."})}):e.map((s,r)=>{const n=r>0?e[r-1].type:null,i=s.type!==n,l="BOM 미존재"===s.remark,o=s.refDes&&!t.has(s.refDes.toUpperCase());return a.jsxs(I,{className:`hover:bg-gray-50 ${"미삽"===s.remark?"bg-gray-50":""} ${l||o?"bg-red-50/60":""}`,children:[a.jsx($,{className:"text-center py-1 px-2",children:a.jsx("span",{className:"text-[10px] text-gray-500",children:r+1})}),a.jsx($,{className:"text-center py-1 px-1 whitespace-nowrap",children:a.jsx("span",{className:"text-[10px] "+(l||o?"text-red-600 font-medium":"text-gray-600"),children:i?s.type||"-":""})}),a.jsx($,{className:"py-1 px-1 whitespace-nowrap",children:a.jsx("span",{className:"text-[10px] "+("미삽"===s.remark?"text-gray-400":l||o?"text-red-600 font-medium":"text-gray-600"),children:s.partName||"-"})}),a.jsx($,{className:"text-center py-1 px-2",children:a.jsx("span",{className:"text-[10px] font-medium "+(l||o?"text-red-700":"text-gray-900"),children:s.refDes})}),a.jsx($,{className:"text-center py-1 px-2",children:a.jsx(k,{variant:"TOP"===s.layer?"default":"secondary",className:"text-[9px] px-1.5 py-0 h-4 "+(l||o?"bg-red-100 text-red-700 border border-red-200":""),children:s.layer})}),a.jsx($,{className:"text-center py-1 px-2",children:a.jsx("span",{className:"text-[10px] font-mono "+(l||o?"text-red-600":"text-gray-600"),children:s.locationX?.toFixed(2)})}),a.jsx($,{className:"text-center py-1 px-2",children:a.jsx("span",{className:"text-[10px] font-mono "+(l||o?"text-red-600":"text-gray-600"),children:s.locationY?.toFixed(2)})}),a.jsx($,{className:"text-center py-1 px-2",children:a.jsx("span",{className:"text-[10px] font-mono "+(l||o?"text-red-600":"text-gray-600"),children:s.rotation||0})}),a.jsx($,{className:"py-1 px-2",children:a.jsx("span",{className:"text-[10px] "+("미삽"===s.remark?"text-red-500 font-medium":l||o?"text-red-600 font-medium":"text-gray-500"),children:o&&!l?"BOM에 없음":s.remark||""})})]},r)})}),a.jsx("tfoot",{className:"bg-gray-50 border-t",children:a.jsx("tr",{children:a.jsx("td",{colSpan:9,className:"py-2 px-2",children:a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsxs("span",{className:"card-description",children:["총 ",s,"개 항목"]}),a.jsxs("div",{className:"flex gap-4 card-description",children:[a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"w-3 h-3 bg-gray-100 border border-gray-300 rounded"}),"미삽"]}),a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"w-3 h-3 bg-red-50 border border-red-200 rounded"}),"BOM에 없음"]})]})]})})})})]})})})}function le({boardId:e,isOpen:s,onClose:i}){const[l,o]=t.useState(!1),[c,d]=t.useState(null),[p,x]=t.useState(!1),h=r();t.useEffect(()=>{s&&e&&N()},[s,e]);const N=async()=>{if(e){o(!0);try{const{data:t,error:a}=await h.from("cad_drawings").select("*").eq("id",e).single();if(a)throw a;const{data:s,error:r}=await h.from("bom_items").select("*").eq("cad_drawing_id",e).order("line_number");if(r)throw r;const{data:n,error:i}=await h.from("part_placements").select("*").eq("cad_drawing_id",e);if(i)throw i;const l=(s||[]).map(e=>({lineNumber:e.line_number,itemType:e.item_type||"",itemName:e.item_name||"",setCount:e.set_count||0,totalQuantity:e.total_quantity||0,stockQuantity:e.stock_quantity||0,checkStatus:e.check_status||"",refList:Array.isArray(e.ref_list)?e.ref_list.join(", "):e.ref_list||"",alternativeItem:e.alternative_item||"",remark:e.remark||"",isManualRequired:e.is_manual_required||!1,isNewPart:e.is_new_part||!1,originalPart:e.original_part||"",originalFootprint:e.original_footprint||""})),o=[],c=[];(n||[]).forEach(e=>{const t={refDes:e.ref||"",type:e.part_type||"",partName:e.part_name||"",layer:e.side||"TOP",locationX:e.x_coordinate||0,locationY:e.y_coordinate||0,rotation:e.angle||0,remark:e.remark||""};"TOP"===e.side?o.push(t):c.push(t)}),d({id:t.id,board_name:t.board_name,artwork_manager:t.artwork_manager||"",production_manager:t.production_manager||"",production_quantity:t.production_quantity||0,created_at:t.created_at,bomItems:l,topCoordinates:o,bottomCoordinates:c})}catch(t){m.error("데이터를 불러오는데 실패했습니다.")}finally{o(!1)}}},b=(e,t)=>{const a=(e||"").toUpperCase();return(t||"").toUpperCase().includes("미삽")||a.includes("_OPEN")||a.includes("OPEN_")||a.includes("_POGO")||a.includes("POGO_")||a.includes("_PAD")||a.includes("PAD_")||a.includes("_NC")||a.includes("NC_")};return s?a.jsx(u,{open:s,onOpenChange:e=>!e&&i(),children:a.jsxs(g,{maxWidth:"max-w-fit",showCloseButton:!1,className:"w-fit min-w-[600px] max-w-[90vw] max-h-[90vh] overflow-hidden flex flex-col p-4",children:[a.jsx(f,{className:"flex-shrink-0 !p-0 !border-0",children:a.jsxs("div",{className:"flex justify-between items-start",children:[a.jsxs("div",{children:[a.jsx(y,{className:"text-lg font-semibold text-gray-900",children:c?(j=c.board_name,(j||"").trim().replace(/_\d{6}_정리본$/,"").replace(/_정리본$/,"").replace(/_\d{6}$/,"")):"로딩 중..."}),c&&a.jsxs("div",{className:"flex gap-4 mt-1 text-xs text-gray-500",children:[a.jsxs("span",{children:["Artwork: ",c.artwork_manager||"-"]}),a.jsxs("span",{children:["생산: ",c.production_manager||"-"]}),a.jsxs("span",{children:["수량: ",c.production_quantity]})]})]}),a.jsx("div",{className:"flex gap-2",children:a.jsxs(n,{onClick:async()=>{if(c){x(!0);try{const e={boardName:c.board_name,artworkManager:c.artwork_manager,productionManager:c.production_manager,productionQuantity:c.production_quantity},t=await te(c.bomItems,c.topCoordinates,c.bottomCoordinates,e),a=new Date,s=a.getFullYear().toString().slice(2)+String(a.getMonth()+1).padStart(2,"0")+String(a.getDate()).padStart(2,"0"),r=`${c.board_name.trim().replace(/_\d{6}_정리본$/,"").replace(/_정리본$/,"").replace(/_\d{6}$/,"")}_${s}_정리본.xlsx`;await se(t,r),m.success("엑셀 파일이 다운로드되었습니다.")}catch(e){m.error("엑셀 다운로드에 실패했습니다.")}finally{x(!1)}}},disabled:p||!c,className:"h-8 px-3 text-xs bg-green-600 hover:bg-green-700 text-white",children:[p?a.jsx(A,{className:"w-3 h-3 animate-spin mr-1"}):a.jsx(q,{className:"w-3 h-3 mr-1"}),"Excel 다운로드"]})})]})}),a.jsx("div",{className:"flex-1 overflow-hidden mt-3",children:l?a.jsxs("div",{className:"flex items-center justify-center h-64",children:[a.jsx(A,{className:"w-6 h-6 text-hansl-600 animate-spin mr-2"}),a.jsx("span",{className:"text-sm text-gray-600",children:"데이터를 불러오는 중..."})]}):c?a.jsxs(K,{defaultValue:"bom",className:"h-full flex flex-col",children:[a.jsxs(J,{className:"flex-shrink-0 mb-3 grid grid-cols-3 h-8 bg-gray-100 p-1 business-radius-button",children:[a.jsxs(Z,{value:"bom",className:"text-[10px] h-7 data-[state=active]:bg-white data-[state=active]:text-hansl-600 data-[state=active]:shadow-sm",children:["정리된 BOM",a.jsx("span",{className:"ml-1 badge-stats bg-gray-100 text-gray-600 data-[state=active]:bg-hansl-50 data-[state=active]:text-hansl-700",children:c.bomItems.length})]}),a.jsxs(Z,{value:"top",className:"text-[10px] h-7 data-[state=active]:bg-white data-[state=active]:text-hansl-600 data-[state=active]:shadow-sm",children:["TOP",a.jsx("span",{className:"ml-1 badge-stats bg-gray-100 text-gray-600 data-[state=active]:bg-hansl-50 data-[state=active]:text-hansl-700",children:c.topCoordinates.length})]}),a.jsxs(Z,{value:"bottom",className:"text-[10px] h-7 data-[state=active]:bg-white data-[state=active]:text-hansl-600 data-[state=active]:shadow-sm",children:["BOTTOM",a.jsx("span",{className:"ml-1 badge-stats bg-gray-100 text-gray-600 data-[state=active]:bg-orange-50 data-[state=active]:text-orange-700",children:c.bottomCoordinates.length})]})]}),a.jsx(ee,{value:"bom",className:"flex-1 overflow-auto mt-0",children:a.jsx(oe,{items:c.bomItems,checkIsMisap:b,productionQuantity:c.production_quantity})}),a.jsx(ee,{value:"top",className:"flex-1 overflow-auto mt-0",children:a.jsx(ce,{coordinates:c.topCoordinates,bomItems:c.bomItems,checkIsMisap:b})}),a.jsx(ee,{value:"bottom",className:"flex-1 overflow-auto mt-0",children:a.jsx(ce,{coordinates:c.bottomCoordinates,bomItems:c.bomItems,checkIsMisap:b})})]}):a.jsx("div",{className:"flex items-center justify-center h-64 text-gray-500",children:"데이터를 불러올 수 없습니다."})})]})}):null;var j}function oe({items:e,checkIsMisap:t,productionQuantity:s}){let r="";const n=e.reduce((e,t)=>e+(t.setCount||0),0),i=e=>{const a=t(e.itemName,e.remark);return e.isManualRequired?"bg-yellow-50 hover:bg-yellow-100":e.isNewPart?"bg-red-50 hover:bg-red-100":a?"bg-gray-50 hover:bg-gray-100":"hover:bg-gray-50"};return a.jsx("div",{className:"border rounded-lg bg-white shadow-sm max-h-[55vh] overflow-auto",children:a.jsxs("table",{className:"table-auto w-auto border-collapse text-[13px]",children:[a.jsx("thead",{className:"bg-gray-50 sticky top-0 z-20",children:a.jsxs("tr",{className:"h-6 border-b border-gray-200",children:[a.jsx("th",{className:"w-[40px] sm:w-[50px] text-center py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"No"})}),a.jsx("th",{className:"text-center whitespace-nowrap py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"종류"})}),a.jsx("th",{className:"whitespace-nowrap py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"품명"})}),a.jsx("th",{className:"w-[50px] sm:w-[60px] text-center py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"SET"})}),a.jsx("th",{className:"w-[60px] sm:w-[80px] text-center py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"수량"})}),a.jsx("th",{className:"w-[50px] sm:w-[60px] text-center hidden sm:table-cell py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"재고"})}),a.jsx("th",{className:"min-w-[200px] sm:min-w-[300px] py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"REF"})}),a.jsx("th",{className:"w-[100px] sm:w-[150px] hidden md:table-cell py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"대체품"})}),a.jsx("th",{className:"w-[100px] sm:w-[150px] py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"비고"})})]})}),a.jsx("tbody",{children:0===e.length?a.jsx("tr",{children:a.jsx("td",{colSpan:9,className:"text-center py-6 card-description",children:"데이터가 없습니다."})}):e.map((e,s)=>{const n=t(e.itemName,e.remark),l=e.itemType!==r;return r=e.itemType,a.jsxs("tr",{className:`${i(e)} border-b border-gray-100`,children:[a.jsx("td",{className:"text-center py-1 px-2",children:a.jsx("span",{className:"text-[10px] "+(n?"text-red-600":"text-gray-500"),children:s+1})}),a.jsx("td",{className:"text-center py-1 px-1 whitespace-nowrap",children:a.jsx("span",{className:`text-[10px] ${n?"text-red-600":"text-gray-600"} ${"데이터 없음"===e.itemType?"!text-red-500 font-bold":""}`,children:l?e.itemType||"-":""})}),a.jsx("td",{className:"py-1 px-1 whitespace-nowrap",children:a.jsx("span",{className:"text-[10px] "+(n?"text-red-600 font-medium":e.isManualRequired||e.isNewPart?"text-red-600":"text-gray-500"),children:e.itemName||"-"})}),a.jsx("td",{className:"text-center py-1 px-2",children:a.jsx("span",{className:"text-[10px] font-medium "+(n?"text-red-600":"text-gray-900"),children:e.setCount})}),a.jsx("td",{className:"text-center py-1 px-2",children:a.jsx("span",{className:"text-[10px] font-bold "+(n?"text-red-600":"text-gray-900"),children:e.totalQuantity})}),a.jsx("td",{className:"hidden sm:table-cell text-center py-1 px-2",children:a.jsx("span",{className:"text-[10px] font-medium "+(n?"text-red-600":"text-gray-900"),children:e.stockQuantity||""})}),a.jsx("td",{className:"px-1 py-1 align-middle",style:{width:"300px",maxWidth:"300px"},children:a.jsx("span",{className:"text-[10px] "+(n?"text-red-600":"text-gray-600"),style:{display:"block",width:"300px",maxWidth:"300px",lineHeight:"14px",wordWrap:"break-word",overflowWrap:"break-word",whiteSpace:"pre-wrap"},children:e.refList||"-"})}),a.jsx("td",{className:"hidden md:table-cell py-1 px-2",children:a.jsx("span",{className:"text-[10px] "+(n?"text-red-600":"text-gray-500"),children:e.alternativeItem||""})}),a.jsx("td",{className:"py-1 px-2",children:a.jsx("span",{className:"text-[10px] "+(n?"text-red-600 font-medium":"text-gray-500"),children:e.remark||""})})]},s)})}),a.jsx("tfoot",{className:"bg-gray-50 border-t sticky bottom-0 z-20",children:a.jsxs("tr",{children:[a.jsx("td",{className:"py-2 px-2 bg-gray-50",children:a.jsxs("span",{className:"card-description whitespace-nowrap",children:["총 ",e.length,"개 항목"]})}),a.jsx("td",{className:"bg-gray-50"}),a.jsx("td",{className:"text-right pr-2 bg-gray-50",children:a.jsx("span",{className:"card-description",children:"합계:"})}),a.jsx("td",{className:"text-center py-2 bg-gray-50",children:a.jsx("span",{className:"text-[11px] text-gray-700",children:n})}),a.jsx("td",{className:"bg-gray-50"}),a.jsx("td",{className:"hidden sm:table-cell bg-gray-50"}),a.jsx("td",{className:"bg-gray-50"}),a.jsx("td",{className:"hidden md:table-cell bg-gray-50"}),a.jsx("td",{className:"py-2 px-2 text-right bg-gray-50",children:a.jsxs("div",{className:"flex gap-4 card-description justify-end whitespace-nowrap",children:[a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"w-3 h-3 bg-yellow-100 border border-yellow-300 rounded"}),"수동 확인"]}),a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"w-3 h-3 bg-red-50 border border-red-200 rounded"}),"미삽"]})]})})]})})]})})}function ce({coordinates:e,bomItems:t=[],checkIsMisap:s}){let r="";const n=e.length,i=new Set;return t.forEach(e=>{if(e.refList){e.refList.split(",").map(e=>e.trim().toUpperCase()).filter(Boolean).forEach(e=>i.add(e))}}),a.jsx("div",{className:"border rounded-lg bg-white shadow-sm max-h-[55vh] overflow-auto",children:a.jsxs("table",{className:"table-auto w-auto border-collapse text-[13px]",children:[a.jsx("thead",{className:"bg-gray-50 sticky top-0 z-20",children:a.jsxs("tr",{className:"h-6 border-b border-gray-200",children:[a.jsx("th",{className:"w-[40px] text-center py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"No"})}),a.jsx("th",{className:"text-center whitespace-nowrap py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"종류"})}),a.jsx("th",{className:"whitespace-nowrap py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"품명"})}),a.jsx("th",{className:"w-[80px] text-center py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"RefDes"})}),a.jsx("th",{className:"w-[60px] text-center py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"Layer"})}),a.jsx("th",{className:"w-[80px] text-center py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"X"})}),a.jsx("th",{className:"w-[80px] text-center py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"Y"})}),a.jsx("th",{className:"w-[60px] text-center py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"Angle"})}),a.jsx("th",{className:"w-[80px] py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"비고"})})]})}),a.jsx("tbody",{children:0===e.length?a.jsx("tr",{children:a.jsx("td",{colSpan:9,className:"text-center py-6 card-description",children:"데이터가 없습니다."})}):e.map((e,t)=>{const n=s(e.partName||"",e.remark||""),l=e.type!==r;r=e.type||"";const o=e.refDes&&!i.has(e.refDes.toUpperCase());return a.jsxs("tr",{className:`hover:bg-gray-50 border-b border-gray-100 ${n?"bg-gray-50":""} ${o?"bg-red-50/60":""}`,children:[a.jsx("td",{className:"text-center py-1 px-2",children:a.jsx("span",{className:"text-[10px] "+(n?"text-red-600":"text-gray-500"),children:t+1})}),a.jsx("td",{className:"text-center py-1 px-1 whitespace-nowrap",children:a.jsx("span",{className:"text-[10px] "+(n||o?"text-red-600":"text-gray-600"),children:l?e.type||"-":""})}),a.jsx("td",{className:"py-1 px-1 whitespace-nowrap",children:a.jsx("span",{className:"text-[10px] "+(n||o?"text-red-600":"text-gray-600"),children:e.partName||"-"})}),a.jsx("td",{className:"text-center py-1 px-2",children:a.jsx("span",{className:"text-[10px] font-medium "+(n||o?"text-red-700":"text-gray-900"),children:e.refDes})}),a.jsx("td",{className:"text-center py-1 px-2",children:a.jsx(k,{variant:"TOP"===e.layer?"default":"secondary",className:"text-[9px] px-1.5 py-0 h-4 "+(o?"bg-red-100 text-red-700 border border-red-200":""),children:e.layer})}),a.jsx("td",{className:"text-center py-1 px-2",children:a.jsx("span",{className:"text-[10px] font-mono "+(n||o?"text-red-600":"text-gray-600"),children:e.locationX?.toFixed(2)})}),a.jsx("td",{className:"text-center py-1 px-2",children:a.jsx("span",{className:"text-[10px] font-mono "+(n||o?"text-red-600":"text-gray-600"),children:e.locationY?.toFixed(2)})}),a.jsx("td",{className:"text-center py-1 px-2",children:a.jsx("span",{className:"text-[10px] font-mono "+(n||o?"text-red-600":"text-gray-600"),children:e.rotation||0})}),a.jsx("td",{className:"py-1 px-2",children:a.jsx("span",{className:"text-[10px] "+(n||o?"text-red-600 font-medium":"text-gray-500"),children:o?"BOM에 없음":e.remark||""})})]},t)})}),a.jsx("tfoot",{className:"bg-gray-50 border-t sticky bottom-0 z-20",children:a.jsx("tr",{children:a.jsx("td",{colSpan:9,className:"py-2 px-2 bg-gray-50",children:a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsxs("span",{className:"card-description",children:["총 ",n,"개 항목"]}),a.jsxs("div",{className:"flex gap-4 card-description",children:[a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"w-3 h-3 bg-gray-100 border border-gray-300 rounded"}),"미삽"]}),a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"w-3 h-3 bg-red-50 border border-red-200 rounded"}),"BOM에 없음"]})]})]})})})})]})})}re.displayName="GeneratedPreviewPanel";let de=null;const me=["1u/1005|C1UF_1005","10u/1005|C10UF_1005","1u/1608|C1UF_1608","0.01u/1005|C0.01UF_1005","0.1u/1005|C0.1UF_1005","10uf/1608|C10UF_1608","10pf/1005|C10PF_1005","10nf/1005|C10NF_1005","220pf/1005|C220PF_1005","47u/2012|C47UF_16V_2012","2.2u/1005|C2.2UF_16V_1005","0.001u/1005|C0.001UF_1005","4.7u/1005|C4.7UF_1005","|R1K_1005_0.1%"],pe={"FI-RE41S-HF":"FI-RE41S-HF-R1500","FI-RE51S-HF":"FI-RE51S-HF-R1500","24LC256ISN":"24LC256-I/SN",TLP3107:"TLP3107","AD5175BRMZ-10-RL7":"AD5175BRMZ-10-RL7","AD5175BCPZ-10-RL7":"AD5175BCPZ-10-RL7",ADS7828E_250:"ADS7828E/250",TPD2EUSB30DRTR_OPEN:"TPD2EUSB30DRTR_OPEN",TPD2EUSB30DRTR:"TPD2EUSB30DRTR",C10PF_50V_1005_OPEN:"C10pF/50V_1005_OPEN",C10PF_1005_OPEN:"C10PF/10V_1005_OPEN",R0_1005_OPEN:"R0_1005_OPEN","C0.1UF_16V_1005_OPEN":"C0.1uF/16V_1005_OPEN",W25Q16JVSSIQ_OPEN:"W25Q16JVSSIQ_OPEN",R1K_1005_OPEN_1903:"R1K_1005_OPEN",R10K_1005_OPEN_1903:"R10K_1005_OPEN",R10K_1005_OPEN:"R10K_1005_OPEN","R4.7K_1005":"R4.7K_1005_1%",R10_1005:"R10_1005_1%",R15_1005:"R15_1005_1%","MAX3373EEKA+T_NEW":"MAX3373EEKA+T","C0.1UF_16V_1005":"C0.1uF/16V_1005","T47UF_16V-B":'T47uF/16V "B"',"SN65DP141RLJR_R-PWQFN-N38_RLJ":"SN65DP141RLJR","TSM6963SD_TSSOP-8":"TSM6963SD","SW-DJMM-12V":"SW-DJMM-12V","BOI_C70_CUBE_Z-CAL_POGO":"BOI_C70_CUBE_Z-CAL_POGO",MGL_G1_AA_MASTER_SENSOR_POGO:"B2B","TPD2EUSB30DRTR/OPEN|TPD2EUSB30DRTR":"TPD2EUSB30DRTR_OPEN"};async function xe(){if(de)return de;try{const[t,a,s,n,i]=await Promise.all([fetch("/data/종류_매핑.json"),fetch("/data/품명_매핑.json"),fetch("/data/품명_충돌목록.json"),fetch("/data/종류_정렬순서.json"),fetch("/data/미삽항목.json")]);if(!t.ok)throw new Error(`종류_매핑.json 로드 실패: ${t.status}`);if(!a.ok)throw new Error(`품명_매핑.json 로드 실패: ${a.status}`);if(!s.ok)throw new Error(`품명_충돌목록.json 로드 실패: ${s.status}`);if(!n.ok)throw new Error(`종류_정렬순서.json 로드 실패: ${n.status}`);if(!i.ok)throw new Error(`미삽항목.json 로드 실패: ${i.status}`);const l=await t.json(),o=await a.json(),c=await s.json(),d=await n.json(),m=await i.json();let p={...o,...pe},x={...l};try{const e=r(),{data:t,error:a}=await e.from("ai_learning_records").select("processed_bom_data").not("processed_bom_data","is",null).order("created_at",{ascending:!1});if(a);else if(t&&t.length>0){let e=0,a=0;for(const s of t){const t=s.processed_bom_data;if(Array.isArray(t))for(const s of t){if(!s.originalPart&&!s.originalFootprint)continue;const t=(s.originalPart||"").trim(),r=(s.originalFootprint||"").trim().toUpperCase(),n=(s.itemName||"").trim(),i=(s.itemType||"").trim();if(r&&n&&"데이터 없음 (수동 확인 필요)"!==n){const a=n!==r&&n.toUpperCase()!==r;if(t){const s=`${t}|${r}`;!a&&p[s]||(p[s]=n,e++)}!a&&p[r]||(p[r]=n,e++)}n&&i&&"데이터 없음"!==i&&(x[n]&&x[n]===i||(x[n]=i,a++))}}}}catch(e){}return de={typeMapping:x,partNameMapping:p,partNameConflicts:c,typeSortOrder:d,misapKeywords:m,manualInputRequired:me},de}catch(t){throw t}}const he={normalizePartName:e=>e?e.toLowerCase().replace(/[\/\-_\s]/g,"").replace(/"/g,"").trim():"",normalizePartFootprintCombo(e,t){let a=(e||"").toLowerCase().replace(/uf/g,"u").replace(/pf/g,"p").replace(/nf/g,"n").replace(/\s/g,"");/^c\d/.test(a)&&(a=a.substring(1));return`${a}|${(t||"").toUpperCase()}`},isManualInputRequired(e,t,a){const s=(t||"").toUpperCase();return a.manualInputRequired.some(a=>{const[r,n]=a.split("|");if(n&&s===n.toUpperCase())return!0;return this.normalizePartFootprintCombo(e,t)===this.normalizePartFootprintCombo(r,n)})},isMisap(e,t,a){const s=(e||"").toUpperCase(),r=(t||"").toUpperCase();return a.misapKeywords.some(e=>s.includes(e)||r.includes(e))},parseRefs(e){if(!e)return[];const t=[],a=e.split(/[,.\s]+/).map(e=>e.trim()).filter(e=>e.length>0);for(const s of a){if(/^[-_=]+$/.test(s))continue;const e=s.match(/^([A-Z]+)(\d+)[-~]([A-Z]*)(\d+)$/i);if(e){const a=e[1],s=parseInt(e[2]),r=parseInt(e[4]);for(let e=s;e<=r;e++)t.push(a+e)}else t.push(s)}return t},isTP:e=>/^TP/i.test(e),normalizeType(e){if(!e)return"";const t=e.trim();return{"TP/DIP":"TEST POINT/DIP","TP/SMD":"TEST POINT/SMD",SENSOR:"SENSOR(SMD)","PEM NUT":"PEMNUT","BEAD(012)":"BEAD(2012)","TEST POINT":"TEST POINT/SMD",CONNECTGOR:"CONNECTOR",CONNECTO4R:"CONNECTOR",CONNECTROR:"CONNECTOR","DIOODE(SMD)":"DIODE(SMD)","X-TAL":"X-TAL(SMD)"}[t]||t}};function ue(e,t,a){const s=t.toUpperCase(),r=`${e}|${t}`;return a.partNameMapping[r]?{partName:a.partNameMapping[r],isNew:!1}:a.partNameMapping[s]?{partName:a.partNameMapping[s],isNew:!1}:a.partNameMapping[t]?{partName:a.partNameMapping[t],isNew:!1}:a.partNameMapping[e]?{partName:a.partNameMapping[e],isNew:!1}:{partName:t||e,isNew:!0}}function ge(e,t){if(t.typeMapping[e])return t.typeMapping[e];const a=he.normalizePartName(e);for(const[s,r]of Object.entries(t.typeMapping))if(he.normalizePartName(s)===a)return r;return""}function fe(e,t,a){const s=t.toUpperCase(),r=`${e}|${t}`;if(a.partNameMapping[r]){const e=ge(a.partNameMapping[r],a);if(e)return e}const n=[s,t];for(const i of n)if(a.partNameMapping[i]){const e=ge(a.partNameMapping[i],a);if(e)return e}if(a.partNameMapping[e]){const t=ge(a.partNameMapping[e],a);if(t)return t}for(const[i,l]of Object.entries(a.partNameMapping))if(i.toUpperCase().includes(s)||s.includes(i.toUpperCase())){const e=ge(l,a);if(e)return e}return""}async function ye(e,t,a){const s=await xe(),r=await async function(e){const t=await e.arrayBuffer(),a=new Uint8Array(t),s=W(a,{type:"array"}),r=s.Sheets[s.SheetNames[0]],n=Q.sheet_to_json(r,{header:1}),i=[];let l=-1,o={item:0,ref:1,qty:2,part:3,footprint:-1};const c=["reference","references","ref","designator"],d=["part","part number"],m=["pcb footprint","footprint","partnumber"];for(let x=0;x<Math.min(30,n.length);x++){const e=n[x];if(!e)continue;const t=e.map(e=>String(e||"").toLowerCase()).join(" ");if(c.some(e=>t.includes(e))){l=x,e.forEach((e,t)=>{const a=String(e||"").toLowerCase().trim();"item"!==a&&"no"!==a||(o.item=t),c.some(e=>a===e)&&(o.ref=t),"quantity"!==a&&"qty"!==a||(o.qty=t),d.some(e=>a===e)&&(o.part=t),m.some(e=>a===e)&&(o.footprint=t)});break}}-1===l&&(l=0);let p=null;for(let x=l+1;x<n.length;x++){const e=n[x];if(!e||0===e.length)continue;const t=String(e[o.item]||"").trim(),a=String(e[o.ref]||"").trim(),s=String(e[o.qty]||"").trim(),r=String(e[o.part]||"").trim(),l=o.footprint>=0?String(e[o.footprint]||"").trim():"";if(!a.startsWith("_"))if(t&&/^\d+$/.test(t)){p&&p.refs.length>0&&i.push(p);const e=he.parseRefs(a).filter(e=>!he.isTP(e));p={quantity:parseInt(s)||e.length,refs:e,part:r,footprint:l||r}}else if(p&&a){const e=he.parseRefs(a).filter(e=>!he.isTP(e));p.refs.push(...e)}}return p&&p.refs.length>0&&i.push(p),i}(e),n=await async function(e){const t=await e.arrayBuffer(),a=[];if(e.name.endsWith(".txt")){const e=new TextDecoder("utf-8").decode(t).split("\n");let s=!1,r={ref:0,x:1,y:2,rotation:3,layer:4};for(const t of e){const e=t.trim();if(!e)continue;if(!s){const t=e.toLowerCase();if(t.includes("refdes")||t.includes("ref")||t.includes("designator")){s=!0,e.split(/\t|\s{2,}/).map(e=>e.trim().replace(/"/g,"")).forEach((e,t)=>{const a=e.toLowerCase();(a.includes("ref")||a.includes("designator"))&&(r.ref=t),(a.includes("locationx")||"x"===a||"x"===a&&1===t)&&(r.x=t),(a.includes("locationy")||"y"===a||"y"===a&&2===t)&&(r.y=t),(a.includes("rotation")||a.includes("angle")||a.includes("rot"))&&(r.rotation=t),(a.includes("layer")||a.includes("side"))&&(r.layer=t)});continue}continue}const n=e.split(/\t|\s{2,}/).map(e=>e.trim().replace(/"/g,""));if(n.length<3)continue;const i=(n[r.ref]||"").trim().toUpperCase().replace(/"/g,"");if(!i||he.isTP(i)||/^\d+$/.test(i))continue;const l=parseFloat(n[r.x]||"0"),o=parseFloat(n[r.y]||"0"),c=parseFloat(n[r.rotation]||"0"),d=(n[r.layer]||"").toUpperCase().replace(/"/g,"").includes("BOT")?"BOTTOM":"TOP";a.push({ref:i,x:l,y:o,rotation:c,layer:d})}a.length}else{const e=new Uint8Array(t),s=W(e,{type:"array"}),r=s.Sheets[s.SheetNames[0]],n=Q.sheet_to_json(r,{header:1});let i=-1,l={ref:0,x:3,y:4,rotation:5,layer:2};for(let t=0;t<Math.min(10,n.length);t++){const e=n[t];if(!e)continue;const a=e.map(e=>String(e||"").toLowerCase()).join(" ");if(a.includes("ref")||a.includes("designator")){i=t,e.forEach((e,t)=>{const a=String(e||"").toLowerCase().trim();(a.includes("ref")||a.includes("designator"))&&(l.ref=t),(a.includes("locationx")||"x"===a)&&(l.x=t),(a.includes("locationy")||"y"===a)&&(l.y=t),(a.includes("rotation")||a.includes("angle"))&&(l.rotation=t),(a.includes("layer")||a.includes("side"))&&(l.layer=t)});break}}for(let t=i+1;t<n.length;t++){const e=n[t];if(!e)continue;const s=String(e[l.ref]||"").trim().toUpperCase();!s||he.isTP(s)||/^\d+$/.test(s)||a.push({ref:s,x:parseFloat(String(e[l.x]))||0,y:parseFloat(String(e[l.y]))||0,rotation:parseFloat(String(e[l.rotation]))||0,layer:String(e[l.layer]||"").toUpperCase().includes("BOT")?"BOTTOM":"TOP"})}}return a}(t);r.forEach(e=>{e.refs=e.refs.map(e=>e.toUpperCase())});const i=n.map(e=>({...e,ref:e.ref.toUpperCase()})),l=new Map;for(const N of i)l.set(N.ref,N);const o=[],c=[],d=[];let m=0,p=0,x=0,h=1;for(const N of r){const e=he.isManualInputRequired(N.part,N.footprint,s);let t,r=!1;if(e)t="데이터 없음 (수동 확인 필요)",m++;else{const e=ue(N.part,N.footprint,s);t=e.partName,r=e.isNew,r&&p++}let n=ge(t,s);n||e||r||(r=!0,p++);const i=he.isMisap(N.footprint,N.part,s);i&&x++;const u=(e,t,a)=>{const s=t.toUpperCase(),r=e.toUpperCase(),n=(a[0]||"").toUpperCase().replace(/\d+/g,"");let i="1005";return s.includes("0603")||r.includes("0603")?i="0603":s.includes("1005")||r.includes("1005")?i="1005":s.includes("1608")||r.includes("1608")?i="1608":s.includes("2012")||r.includes("2012")?i="2012":(s.includes("3225")||r.includes("3225"))&&(i="3225"),/^C\d/.test(r)||/^C[_-]/.test(r)||r.includes("UF")||r.includes("PF")||r.includes("NF")?`C/C(${i})`:/^R\d/.test(r)||/^R[_-]/.test(r)||r.includes("OHM")||/R\d+K/.test(r)?`저항(${i})`:r.includes("IC")||r.includes("MAX")||r.includes("LM")||r.includes("TPS")||r.includes("STM")||r.includes("AD5")||r.includes("ADS")||r.includes("PCA")||r.includes("TCA")||r.includes("SN6")||r.includes("SN7")?"IC(SMD)":r.includes("DMN")||r.includes("MOSFET")||r.includes("2N")||/^Q\d/.test(n)?"TR(SMD)":r.includes("DIODE")||r.includes("1N")||r.includes("BAT")||r.includes("D5V")||r.includes("D10V")||r.includes("TPD")?"DIODE(SMD)":r.includes("BEAD")||r.includes("BLM")||r.includes("FB")?"BEAD(2012)":r.includes("CONN")||r.includes("B2B")||r.includes("HEADER")||r.includes("POGO")||r.includes("PIN")||s.includes("CONN")||/^\d{5}/.test(r)?"CONNECTOR":r.includes("LED")?"LED(1608)":r.includes("OSC")||r.includes("XTAL")||r.includes("CRYSTAL")?"OSC(SMD)":r.includes("SW")||r.includes("SWITCH")?"S/W(DIP)":r.includes("TANT")||r.includes("T/T")?"T/T":"C"===n?`C/C(${i})`:"R"===n?`저항(${i})`:"U"===n?"IC(SMD)":"Q"===n?"TR(SMD)":"D"===n?"DIODE(SMD)":"L"===n||"FB"===n||"BD"===n?"BEAD(2012)":"LED"===n?"LED(1608)":"J"===n||"CN"===n||"CON"===n?"CONNECTOR":"SW"===n?"S/W(DIP)":"Y"===n||"X"===n?"OSC(SMD)":"데이터 없음"};let g;if(e||r||!n){const e=fe(N.part,N.footprint,s);g=e?he.normalizeType(e):u(N.part,N.footprint,N.refs)}else g=he.normalizeType(n);const f={lineNumber:h,itemType:g,itemName:t,setCount:N.refs.length,totalQuantity:N.refs.length*a,checkStatus:"□양호",refList:N.refs.join(", "),remark:i?"미삽":"",isManualRequired:e,isNewPart:r,originalPart:N.part,originalFootprint:N.footprint};o.push(f),h++;for(const a of N.refs){const e=a.toUpperCase(),t=l.get(e);if(!t)continue;const s={type:f.itemType,partName:f.itemName,refDes:a,layer:t.layer,locationX:t.x,locationY:t.y,rotation:t.rotation,remark:i?"미삽":void 0};"TOP"===t.layer?c.push(s):d.push(s),l.delete(e)}}l.forEach(e=>{const t={type:"좌표만 존재",partName:"BOM 없음",refDes:e.ref,layer:e.layer,locationX:e.x,locationY:e.y,rotation:e.rotation,remark:"BOM 미존재"};"TOP"===e.layer?c.push(t):d.push(t)});const u=["IC","SENSOR","TR","DIODE","T/T","C/C","저항","BEAD","OSC","LED","S/W","CONNECTOR","PEMNUT"],g=e=>{if(e.itemType&&"데이터 없음"!==e.itemType)return(t=e.itemType)&&"데이터 없음"!==t?t.startsWith("IC")?"IC":t.startsWith("SENSOR")?"SENSOR":t.startsWith("TR")?"TR":t.startsWith("DIODE")?"DIODE":t.startsWith("T/T")?"T/T":t.startsWith("C/C")?"C/C":t.startsWith("저항")?"저항":t.startsWith("BEAD")?"BEAD":t.startsWith("OSC")?"OSC":t.startsWith("LED")?"LED":t.startsWith("S/W")?"S/W":"CONNECTOR"===t?"CONNECTOR":"PEMNUT"===t?"PEMNUT":t:"";var t;const a=(e.refList||"").split(",")[0].trim().toUpperCase().replace(/\d+/g,"");if("C"===a)return"C/C";if("R"===a)return"저항";if("U"===a)return"IC";if("Q"===a)return"TR";if("D"===a)return"DIODE";if("L"===a||"FB"===a||"BD"===a)return"BEAD";if("LED"===a)return"LED";if("J"===a||"CN"===a||"CON"===a)return"CONNECTOR";if("SW"===a)return"S/W";if("Y"===a||"X"===a)return"OSC";const s=(e.originalPart||e.itemName||"").toUpperCase();return(e.originalFootprint||"").toUpperCase(),/^C\d/.test(s)||/^C[_-]/.test(s)||s.startsWith("CC")||s.includes("PF")||s.includes("UF")||s.includes("NF")?"C/C":/^R\d/.test(s)||/^R[_-]/.test(s)||s.includes("OHM")||/^\d+[KMR]$/.test(s)?"저항":/^U\d/.test(s)||s.includes("IC")||s.includes("MAX")||s.includes("LM")||s.includes("TPS")||s.includes("STM")||s.includes("MC")?"IC":/^Q\d/.test(s)||s.includes("TR")||s.includes("MOSFET")||s.includes("2N")?"TR":/^D\d/.test(s)||s.includes("DIODE")||s.includes("1N")||s.includes("BAT")?"DIODE":s.includes("LED")?"LED":s.includes("SENSOR")?"SENSOR":s.includes("BEAD")||s.includes("FB")?"BEAD":s.includes("CONN")||s.includes("B2B")||s.includes("HEADER")||s.includes("USB")||s.includes("PIN")||/^J\d/.test(s)?"CONNECTOR":s.includes("SW")||s.includes("SWITCH")||s.includes("BTN")?"S/W":s.includes("OSC")||s.includes("XTAL")||s.includes("CRYSTAL")?"OSC":s.includes("T/T")||s.includes("TANT")?"T/T":"CONNECTOR"},f=(e,t)=>{const a=(e||"").toUpperCase();return(t||"").toUpperCase().includes("미삽")||a.includes("_OPEN")||a.includes("OPEN_")||a.includes("_POGO")||a.includes("POGO_")||a.includes("_PAD")||a.includes("PAD_")||a.includes("_NC")||a.includes("NC_")};o.sort((e,t)=>{const a=g(e),s=g(t),r=u.indexOf(a),n=u.indexOf(s),i=-1===r?999:r,l=-1===n?999:n;if(i!==l)return i-l;if(e.itemType!==t.itemType)return(e.itemType||"").localeCompare(t.itemType||"");const o=f(e.itemName,e.remark);return o!==f(t.itemName,t.remark)?o?1:-1:(e.itemName||"").localeCompare(t.itemName||"")}),o.forEach((e,t)=>{e.lineNumber=t+1});const y=e=>e.sort((e,t)=>{const a=e=>{const t=(e||"").toUpperCase();return t.includes("IC")?"IC":t.includes("DIODE")?"DIODE":t.includes("C/C")||t.includes("C_C")?"C/C":t.includes("저항")?"저항":t.includes("BEAD")?"BEAD":t.includes("S/W")||t.includes("SW")?"S/W":t.includes("CONNECTOR")||t.includes("CONN")?"CONNECTOR":"ETC"},s=a(e.type||""),r=a(t.type||""),n=u.indexOf(s),i=u.indexOf(r),l=-1===n?999:n,o=-1===i?999:i;if(l!==o)return l-o;if(e.type!==t.type)return(e.type||"").localeCompare(t.type||"");const c=f(e.partName||"",e.remark||"");return c!==f(t.partName||"",t.remark||"")?c?1:-1:(e.refDes||"").localeCompare(t.refDes||"")});y(c),y(d);o.filter(e=>f(e.itemName,e.remark));return{bomItems:o,topCoordinates:c,bottomCoordinates:d,summary:{totalItems:o.length,manualRequiredCount:m,newPartCount:p,misapCount:x}}}const Ne=Object.freeze(Object.defineProperty({__proto__:null,loadLearningData:xe,processBOMAndCoordinates:ye,resetLearningDataCache:function(){de=null}},Symbol.toStringTag,{value:"Module"}));function be(){const[e,u]=t.useState("create"),[g,f]=t.useState("input"),[y,k]=t.useState({bomFile:null,coordFile:null}),[L,W]=t.useState({boardName:"",artworkManager:"",productionManager:"",productionQuantity:0}),[Q,Y]=t.useState([]),[ae,ie]=t.useState(null),[oe,ce]=t.useState(!1),[de,me]=t.useState(!1),[pe,xe]=t.useState(!1),[he,ue]=t.useState(!1),[ge,fe]=t.useState(null),[be,je]=t.useState(null),[we,_e]=t.useState([]),[ve,Ce]=t.useState(!1),[Se,Oe]=t.useState(null),[Te,De]=t.useState(null),[Ee,Me]=t.useState(0),[ke,Pe]=t.useState(""),[Re,Fe]=t.useState(!1),[Ie,Be]=t.useState(null),[Ue,$e]=t.useState(null),[Le,Ae]=t.useState(!1),[qe,We]=t.useState(!1),[Qe,ze]=t.useState(!1),{mismatchCount:Ve,missingInCoord:He,missingInBom:Ge}=t.useMemo(()=>{const e=ge?.processedData?.bomItems??[],t=ge?.processedData?.coordinates??[],a=new Set;e.forEach(e=>{(e.refList||"").split(",").map(e=>e.trim().toUpperCase()).filter(Boolean).forEach(e=>a.add(e))});const s=new Set;t.forEach(e=>{const t=e?.refDes;t&&s.add(t.trim().toUpperCase())});let r=0;a.forEach(e=>{s.has(e)||(r+=1)});let n=0;return s.forEach(e=>{a.has(e)||(n+=1)}),{mismatchCount:r+n,missingInCoord:r,missingInBom:n}},[ge?.processedData?.bomItems,ge?.processedData?.coordinates]),Xe=(()=>{const e=ge?.processedData?.bomItems||[];if(0===e.length)return!1;const t=new Map;return e.forEach(e=>{if(e.itemName?.includes("데이터 없음")||"데이터 없음"===e.itemType)return;const a=`${e.itemType}|${e.itemName}`;t.set(a,(t.get(a)||0)+1)}),Array.from(t.values()).some(e=>e>1)})(),Ye=r(),Ke=t.useRef(null),{currentUserRoles:Je}=i(),Ze=Je.includes("app_admin"),et=e=>`bom_temp_data_${e}`,tt=async()=>{try{const{data:{user:e}}=await Ye.auth.getUser();e&&localStorage.removeItem(et(e.id))}catch(e){}};t.useEffect(()=>{(async()=>{try{const{data:e}=await Ye.from("employees").select("id, name").order("name");e&&Y(e);const{data:{user:t}}=await Ye.auth.getUser();if(t&&t.email){const{data:e}=await Ye.from("employees").select("id, name").eq("email",t.email).single();ie({email:t.email,name:e?.name||t.email.split("@")[0]}),W(t=>t.boardName||t.productionManager||0!==t.productionQuantity||Qe?t:{...t,artworkManager:e?.id||""}),Qe||(async(e,t=!1)=>{try{if(Qe)return;const a=localStorage.getItem(et(e));if(!a)return;const s=JSON.parse(a);if(t&&(ge||L.boardName||L.productionManager||L.productionQuantity>0||y.bomFile||y.coordFile))return;const r=new Date(s.savedAt);if(((new Date).getTime()-r.getTime())/36e5>24)return void localStorage.removeItem(et(e));f(s.step),W(s.metadata),fe(s.processedResult),u("create")}catch(a){}})(t.id,!0)}}catch(e){}})()},[Ye]),t.useEffect(()=>{(async()=>{if(!ge||"preview"!==g)return;const{data:{user:e}}=await Ye.auth.getUser();e&&(e=>{if(ge&&e)try{const t={step:g,metadata:L,processedResult:ge,savedAt:(new Date).toISOString()};localStorage.setItem(et(e),JSON.stringify(t))}catch(t){}})(e.id)})()},[ge,L,g]),t.useEffect(()=>{(async()=>{if("list"===e)try{Ce(!0);const{data:e,error:t}=await Ye.from("cad_drawings").select("id, board_name, created_at, artwork_manager, production_manager").order("created_at",{ascending:!1});if(t)throw t;_e(e||[])}catch(t){m.error("저장된 BOM 목록을 불러오는데 실패했습니다.")}finally{Ce(!1)}})()},[e,Ye]),t.useEffect(()=>{if(y.bomFile){let e=y.bomFile.name;e=e.replace(/\.(xlsx|xls|csv)$/i,""),e=e.replace(/(\.|_|\s)?(part)?(\.|_|\s)?bom$/i,""),e=e.replace(/^\d+_bom_/,"");const t=new Date,a=t.getFullYear().toString().slice(2)+(t.getMonth()+1).toString().padStart(2,"0")+t.getDate().toString().padStart(2,"0");e=`${e}_${a}_정리본`,W(t=>({...t,boardName:e}))}},[y.bomFile]);const at=t.useCallback((e,t)=>{e.preventDefault(),e.stopPropagation(),"dragenter"===e.type||"dragover"===e.type?je(t):"dragleave"===e.type&&je(null)},[]),st=t.useCallback((e,t)=>{if(e.preventDefault(),e.stopPropagation(),je(null),e.dataTransfer.files&&e.dataTransfer.files[0]){const a=e.dataTransfer.files[0];k("bom"===t?e=>({...e,bomFile:a}):e=>({...e,coordFile:a}))}},[]),rt=t.useCallback((e,t)=>{if(e.target.files&&e.target.files[0]){const a=e.target.files[0];k("bom"===t?e=>({...e,bomFile:a}):e=>({...e,coordFile:a}))}},[]),nt=t.useCallback(e=>{k("bom"===e?e=>({...e,bomFile:null,bomUrl:void 0}):e=>({...e,coordFile:null,coordUrl:void 0}))},[]),it=()=>{f("input"),k({bomFile:null,coordFile:null}),W({boardName:"",artworkManager:"",productionManager:"",productionQuantity:0}),fe(null),Oe(null),De(null),Me(0),Pe(""),Fe(!1),ze(!0)};return a.jsxs("div",{className:"w-full",children:[a.jsx("div",{className:"mb-4",children:a.jsxs("div",{children:[a.jsx("h1",{className:"page-title",children:"BOM/좌표 정리"}),a.jsxs("div",{className:"flex justify-between items-center",style:{marginTop:"-2px",marginBottom:"-4px"},children:[a.jsx("p",{className:"page-subtitle mb-0",children:"BOM & Coordinate Management"}),a.jsxs("div",{className:"flex gap-2",children:[a.jsxs(n,{onClick:async()=>{await tt(),ze(!0),it(),u("create"),f("input"),setTimeout(()=>{ze(!1)},1e3)},className:"button-base "+("create"===e?"bg-hansl-600 hover:bg-hansl-700 text-white":"border border-gray-300 bg-white text-gray-700 hover:bg-gray-50"),children:[a.jsx(N,{className:"w-4 h-4 mr-2"}),"새로 만들기"]}),a.jsxs(n,{onClick:()=>{u("list"),f("input")},className:"button-base "+("list"===e?"bg-hansl-600 hover:bg-hansl-700 text-white":"border border-gray-300 bg-white text-gray-700 hover:bg-gray-50"),children:[a.jsx(z,{className:"w-4 h-4 mr-2"}),"저장된 목록"]})]})]})]})}),"list"===e&&a.jsx("div",{className:"space-y-4",children:a.jsx(p,{children:a.jsx(x,{className:"p-4 sm:p-6",children:ve?a.jsxs("div",{className:"flex items-center justify-center py-12",children:[a.jsx(A,{className:"w-6 h-6 text-hansl-600 animate-spin mr-2"}),a.jsx("span",{className:"text-sm text-gray-600",children:"목록을 불러오는 중..."})]}):0===we.length?a.jsxs("div",{className:"text-center py-12",children:[a.jsx(l,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),a.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"저장된 BOM이 없습니다."}),a.jsxs(n,{onClick:()=>u("create"),className:"button-base bg-hansl-600 hover:bg-hansl-700 text-white",children:[a.jsx(N,{className:"w-4 h-4 mr-2"}),"새 BOM 만들기"]})]}):a.jsxs("div",{className:"space-y-3",children:[a.jsx("div",{className:"flex justify-between items-center mb-4",children:a.jsxs("div",{children:[a.jsx("h3",{className:"page-title",children:"저장된 BOM 목록"}),a.jsx("p",{className:"page-subtitle",children:"저장된 BOM을 확인하고 다운로드할 수 있습니다."})]})}),a.jsx("div",{className:"border rounded-lg overflow-hidden bg-white shadow-sm",children:a.jsx("div",{className:"overflow-x-auto",children:a.jsxs(R,{className:"table-auto",children:[a.jsx(F,{className:"bg-gray-50 sticky top-0 z-10",children:a.jsxs(I,{className:"h-6",children:[a.jsx(B,{className:"w-[50px] text-center !py-1 !h-auto",children:a.jsx("span",{className:"card-description",children:"No"})}),a.jsx(B,{className:"min-w-[200px] !py-1 !h-auto",children:a.jsx("span",{className:"card-description",children:"보드명"})}),a.jsx(B,{className:"w-[100px] text-center !py-1 !h-auto",children:a.jsx("span",{className:"card-description",children:"아트웍 담당"})}),a.jsx(B,{className:"w-[100px] text-center !py-1 !h-auto",children:a.jsx("span",{className:"card-description",children:"생산 담당"})}),a.jsx(B,{className:"w-[100px] text-center !py-1 !h-auto",children:a.jsx("span",{className:"card-description",children:"생성일"})}),a.jsx(B,{className:"w-[120px] text-center !py-1 !h-auto",children:a.jsx("span",{className:"card-description",children:"액션"})})]})}),a.jsx(U,{children:we.map((e,t)=>a.jsxs(I,{className:"hover:bg-gray-50 cursor-pointer",onClick:()=>{$e(e.id),Ae(!0)},children:[a.jsx($,{className:"text-center py-1",children:a.jsx("span",{className:"card-subtitle",children:t+1})}),a.jsx($,{className:"py-1",children:a.jsx("span",{className:"text-[11px] font-medium text-gray-900",children:e.board_name})}),a.jsx($,{className:"text-center py-1",children:a.jsx("span",{className:"text-[10px] text-gray-600",children:e.artwork_manager||"-"})}),a.jsx($,{className:"text-center py-1",children:a.jsx("span",{className:"text-[10px] text-gray-600",children:e.production_manager||"-"})}),a.jsx($,{className:"text-center py-1",children:a.jsx("span",{className:"text-[10px] text-gray-500",children:new Date(e.created_at).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})})}),a.jsx($,{className:"text-center py-1",onClick:e=>e.stopPropagation(),children:a.jsxs("div",{className:"flex gap-1 justify-center",children:[a.jsxs(n,{onClick:()=>(async(e,t)=>{try{const{data:a,error:s}=await Ye.from("cad_drawings").select("artwork_manager, production_manager, production_quantity").eq("id",e).single();if(s)throw s;const{data:r,error:n}=await Ye.from("bom_items").select("*").eq("cad_drawing_id",e).order("line_number");if(n)throw n;const{data:i,error:l}=await Ye.from("part_placements").select("*").eq("cad_drawing_id",e);if(l)throw l;const o=(r||[]).map(e=>({lineNumber:e.line_number,itemType:e.item_type||"",itemName:e.item_name,specification:e.specification||"",setCount:e.set_count,totalQuantity:e.total_quantity||0,stockQuantity:e.stock_quantity||0,checkStatus:e.check_status||"□양호",refList:Array.isArray(e.ref_list)?e.ref_list.join(","):e.ref_list||"",alternativeItem:e.alternative_item||"",remark:e.remark||""})),c=(i||[]).map(e=>({ref:e.ref,partName:e.part_name,partType:e.part_type||"SMD",side:e.side,x:e.x_coordinate.toString(),y:e.y_coordinate.toString(),angle:e.angle?.toString()||"0"})),d={boardName:t,artworkManager:a?.artwork_manager||ae?.name||"",productionManager:a?.production_manager||"",productionQuantity:a?.production_quantity||(o[0]?.totalQuantity&&o[0]?.setCount?Math.round(o[0].totalQuantity/o[0].setCount):0)},p=c.filter(e=>e.side?.toUpperCase().includes("TOP")||e.layer?.toUpperCase().includes("TOP")),x=c.filter(e=>e.side?.toUpperCase().includes("BOT")||e.layer?.toUpperCase().includes("BOT")),h=await te(o,p,x,d),u=new Date,g=u.getFullYear().toString().slice(2)+String(u.getMonth()+1).padStart(2,"0")+String(u.getDate()).padStart(2,"0");se(h,`${t.trim().replace(/_\d{6}_정리본$/,"").replace(/_정리본$/,"").replace(/_\d{6}$/,"")}_${g}_정리본.xlsx`),m.success("엑셀 파일이 다운로드되었습니다.")}catch(a){m.error(`다운로드 중 오류가 발생했습니다: ${a.message}`)}})(e.id,e.board_name),variant:"outline",size:"sm",className:"h-6 px-2 text-[10px] text-green-600 hover:text-green-700 hover:bg-green-50 border-green-200",children:[a.jsx(q,{className:"w-3 h-3 mr-1"}),"Excel"]}),Ze&&a.jsx(n,{onClick:()=>(async(e,t)=>{if(!Ze)return void m.error("삭제 권한이 없습니다.");if(window.confirm(`"${t}" BOM을 삭제하시겠습니까?\n\n관련된 모든 데이터(BOM 항목, 좌표 데이터, 원본 파일 정보)가 함께 삭제됩니다.`))try{Be(e);const{error:s}=await Ye.from("bom_items").delete().eq("cad_drawing_id",e),{error:r}=await Ye.from("part_placements").delete().eq("cad_drawing_id",e),{data:n}=await Ye.from("bom_raw_files").select("bom_file_url, coordinate_file_url").eq("cad_drawing_id",e);if(n&&n.length>0)for(const e of n)try{if(e.bom_file_url){const t=e.bom_file_url.split("/bom-files/")[1]?.split("?")[0];t&&await Ye.storage.from("bom-files").remove([decodeURIComponent(t)])}if(e.coordinate_file_url){const t=e.coordinate_file_url.split("/bom-files/")[1]?.split("?")[0];t&&await Ye.storage.from("bom-files").remove([decodeURIComponent(t)])}}catch(a){}const{error:i}=await Ye.from("bom_raw_files").delete().eq("cad_drawing_id",e),{error:l}=await Ye.from("cad_drawings").delete().eq("id",e);if(l)throw l;_e(t=>t.filter(t=>t.id!==e)),m.success(`"${t}" BOM이 삭제되었습니다.`)}catch(s){m.error(`삭제 중 오류가 발생했습니다: ${s.message}`)}finally{Be(null)}})(e.id,e.board_name),variant:"outline",size:"sm",disabled:Ie===e.id,className:"h-6 px-2 text-[10px] text-red-600 hover:text-red-700 hover:bg-red-50 border-red-200",children:Ie===e.id?a.jsx(A,{className:"w-3 h-3 animate-spin"}):a.jsx(h,{className:"w-3 h-3"})})]})})]},e.id))}),a.jsx("tfoot",{className:"bg-gray-50 border-t",children:a.jsx("tr",{children:a.jsx("td",{colSpan:Ze?7:6,className:"py-2 px-4",children:a.jsxs("span",{className:"card-description",children:["총 ",we.length,"개 항목"]})})})})]})})})]})})})}),"create"===e&&a.jsxs(a.Fragment,{children:["input"===g&&a.jsxs("div",{className:"space-y-4",children:[Te&&a.jsxs("div",{className:"bg-red-50 border border-red-200 text-red-700 px-6 py-4 rounded-lg text-sm flex flex-col gap-2 shadow-sm animate-in fade-in slide-in-from-top-2",children:[a.jsxs("div",{className:"flex items-center gap-2 font-semibold",children:[a.jsx(o,{className:"w-5 h-5 flex-shrink-0 text-red-600"}),a.jsx("span",{children:"오류가 발생했습니다"})]}),a.jsx("p",{className:"pl-7",children:Te}),Te.includes("quota")&&a.jsx("p",{className:"pl-7 text-xs text-red-600 mt-1",children:"* OpenAI 결제 정보가 반영되기까지 최대 10~20분이 소요될 수 있습니다. 잠시 후 다시 시도해주세요."})]}),a.jsx(p,{children:a.jsx(x,{className:"py-4",children:a.jsxs("div",{className:"flex flex-col lg:flex-row gap-4 lg:gap-6 items-stretch",children:[a.jsxs("div",{className:"w-full lg:w-[50%] grid grid-cols-1 sm:grid-cols-2 gap-3",children:[a.jsxs("div",{className:s("border-2 border-dashed rounded-lg p-2 text-center transition-colors cursor-pointer relative flex flex-col items-center justify-center h-full","bom"===be?"border-primary bg-primary/5":"border-gray-200 hover:border-gray-300",y.bomFile?"bg-green-50 border-green-200":""),onDragEnter:e=>at(e,"bom"),onDragLeave:e=>at(e,"bom"),onDragOver:e=>at(e,"bom"),onDrop:e=>st(e,"bom"),onClick:()=>document.getElementById("bom-upload")?.click(),children:[a.jsx("input",{id:"bom-upload",type:"file",className:"hidden",accept:".xlsx,.xls",onChange:e=>rt(e,"bom")}),y.bomFile?a.jsxs("div",{className:"flex flex-col items-center gap-1 w-full px-1",children:[a.jsx("span",{className:"text-xs font-bold text-green-600",children:"BOM"}),a.jsx("p",{className:"text-[10px] font-medium text-green-700 w-full text-center break-all line-clamp-2",title:y.bomFile.name,children:y.bomFile.name}),a.jsx(n,{variant:"ghost",size:"sm",className:"absolute top-1 right-1 p-0 w-4 h-4 min-w-0",onClick:e=>{e.stopPropagation(),nt("bom")},children:a.jsx(c,{size:12})})]}):a.jsxs("div",{className:"flex flex-col items-center gap-1",children:[a.jsx("span",{className:"text-xs font-bold text-gray-400",children:"BOM"}),a.jsx("p",{className:"text-[10px] font-medium text-gray-700",children:"파일 업로드"})]})]}),a.jsxs("div",{className:s("border-2 border-dashed rounded-lg p-2 text-center transition-colors cursor-pointer relative flex flex-col items-center justify-center h-full","coord"===be?"border-primary bg-primary/5":"border-gray-200 hover:border-gray-300",y.coordFile?"bg-blue-50 border-blue-200":""),onDragEnter:e=>at(e,"coord"),onDragLeave:e=>at(e,"coord"),onDragOver:e=>at(e,"coord"),onDrop:e=>st(e,"coord"),onClick:()=>document.getElementById("coord-upload")?.click(),children:[a.jsx("input",{id:"coord-upload",type:"file",className:"hidden",accept:".xlsx,.xls,.txt,.csv",onChange:e=>rt(e,"coord")}),y.coordFile?a.jsxs("div",{className:"flex flex-col items-center gap-1 w-full px-1",children:[a.jsx("span",{className:"text-xs font-bold text-blue-600",children:"좌표"}),a.jsx("p",{className:"text-[10px] font-medium text-blue-700 w-full text-center break-all line-clamp-2",title:y.coordFile.name,children:y.coordFile.name}),a.jsx(n,{variant:"ghost",size:"sm",className:"absolute top-1 right-1 p-0 w-4 h-4 min-w-0",onClick:e=>{e.stopPropagation(),nt("coord")},children:a.jsx(c,{size:12})})]}):a.jsxs("div",{className:"flex flex-col items-center gap-1",children:[a.jsx("span",{className:"text-xs font-bold text-gray-400",children:"좌표"}),a.jsx("p",{className:"text-[10px] font-medium text-gray-700",children:"파일 업로드"})]})]})]}),a.jsxs("div",{className:"w-full lg:w-[50%] space-y-1",children:[a.jsxs("div",{className:"space-y-1 mb-3.5",children:[a.jsx(j,{className:"text-[10px] text-gray-500",children:"보드 이름 (자동)"}),a.jsx(b,{value:L.boardName||"BOM 파일 업로드 시 자동",disabled:!0,className:"w-full bg-gray-50 border border-[#d2d2d7] rounded-md text-xs shadow-sm",style:{height:"32px"}})]}),a.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2",children:[a.jsxs("div",{className:"space-y-1",children:[a.jsx(j,{className:"text-[10px] text-gray-500",children:"Artwork 담당자"}),a.jsxs(D,{open:pe,onOpenChange:xe,children:[a.jsx(E,{asChild:!0,children:a.jsxs(n,{variant:"outline",role:"combobox","aria-expanded":pe,className:"w-full justify-between text-xs h-8 min-h-[32px] px-2 bg-white border-[#d2d2d7] shadow-sm hover:bg-gray-50",children:[L.artworkManager?Q.find(e=>e.id===L.artworkManager)?.name||L.artworkManager:ae?.name||"담당자 선택",a.jsx(w,{className:"ml-2 h-3 w-3 shrink-0 opacity-50"})]})}),a.jsx(M,{className:"w-[200px] p-0",children:a.jsxs(_,{children:[a.jsx(v,{placeholder:"이름 검색...",className:"h-8 text-xs"}),a.jsxs(C,{children:[a.jsx(S,{children:"검색 결과 없음"}),a.jsx(O,{children:Q.map(e=>a.jsxs(T,{value:e.name,onSelect:()=>{W(t=>({...t,artworkManager:e.id})),xe(!1)},className:"text-xs",children:[a.jsx(V,{className:s("mr-2 h-3 w-3",L.artworkManager===e.id?"opacity-100":"opacity-0")}),e.name]},e.id))})]})]})})]})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsxs(j,{className:"text-[10px] text-gray-500",children:["생산 담당자 ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsxs(D,{open:he,onOpenChange:ue,children:[a.jsx(E,{asChild:!0,children:a.jsxs(n,{variant:"outline",role:"combobox","aria-expanded":he,className:"w-full justify-between text-xs h-8 min-h-[32px] px-2 bg-white border-[#d2d2d7] shadow-sm hover:bg-gray-50",children:[L.productionManager?Q.find(e=>e.id===L.productionManager)?.name:"담당자 선택",a.jsx(w,{className:"ml-2 h-3 w-3 shrink-0 opacity-50"})]})}),a.jsx(M,{className:"w-[200px] p-0",children:a.jsxs(_,{children:[a.jsx(v,{placeholder:"이름 검색...",className:"h-8 text-xs"}),a.jsxs(C,{children:[a.jsx(S,{children:"검색 결과 없음"}),a.jsx(O,{children:Q.map(e=>a.jsxs(T,{value:e.name,onSelect:()=>{W(t=>({...t,productionManager:e.id})),ue(!1)},className:"text-xs",children:[a.jsx(V,{className:s("mr-2 h-3 w-3",L.productionManager===e.id?"opacity-100":"opacity-0")}),e.name]},e.id))})]})]})})]})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsxs(j,{className:"text-[10px] text-gray-500",children:["생산 수량 ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsxs("div",{className:"relative",children:[a.jsx(b,{type:"number",min:"0",value:0===L.productionQuantity?"":L.productionQuantity,onChange:e=>W(t=>({...t,productionQuantity:parseInt(e.target.value)||0})),className:"w-full bg-white border border-[#d2d2d7] rounded-md text-xs shadow-sm hover:shadow-md transition-shadow duration-200 pr-8",style:{height:"32px"},placeholder:"0"}),a.jsx("span",{className:"absolute right-2.5 top-1/2 -translate-y-1/2 text-[10px] text-gray-500 font-medium pointer-events-none",children:"SET"})]})]}),a.jsx("div",{className:"flex items-end",children:a.jsx(n,{onClick:async()=>{if(!y.bomFile||!y.coordFile)return void m.error("BOM 파일과 좌표 파일을 모두 선택해주세요.");if(!L.boardName.trim())return void m.error("보드 이름을 입력해주세요.");if(!L.productionManager||"none"===L.productionManager)return void m.error("생산 담당자를 선택해주세요.");if(L.productionQuantity<=0)return void m.error("생산 수량을 입력해주세요 (1 이상).");let e=null,t=null;try{me(!0),f("processing"),De(null),Me(0),Pe("파일 업로드 준비 중...");const a=15e3+((y.bomFile?.size||0)+(y.coordFile?.size||0))/1024*50,s=500,r=90/(a/s);e=setInterval(()=>{Me(e=>{if(e>=95)return e;const t=.5*Math.random()+.8;return Math.min(e+r*t,95)})},s),t=setInterval(()=>{Pe(e=>"파일 업로드 준비 중..."===e?"BOM 파일 읽는 중...":"BOM 파일 읽는 중..."===e?"데이터 구조 분석 중...":"데이터 구조 분석 중..."===e?"좌표 데이터 매칭 중...":"좌표 데이터 매칭 중..."===e?"AI가 최종 정리 중입니다...":"AI가 최종 정리 중입니다..."===e?"거의 다 되었습니다. 잠시만요!":e)},a/5);const{data:{user:n}}=await Ye.auth.getUser();if(!n)throw new Error("로그인이 필요합니다.");const i=Date.now(),l=e=>{const t=e.lastIndexOf("."),a=t>-1?e.slice(t):"";return((t>-1?e.slice(0,t):e).replace(/[^a-zA-Z0-9\-_]/g,"_").replace(/_+/g,"_").replace(/^_|_$/g,"")||"file")+a},o=l(y.bomFile.name),c=l(y.coordFile.name),d=`raw/${i}_bom_${o}`,p=`raw/${i}_coord_${c}`,x=await Ye.storage.from("bom-files").upload(d,y.bomFile,{cacheControl:"3600",upsert:!0});if(x.error)throw x.error;const h=await Ye.storage.from("bom-files").upload(p,y.coordFile,{cacheControl:"3600",upsert:!0});if(h.error)throw await Ye.storage.from("bom-files").remove([d]),h.error;const{data:u}=await Ye.storage.from("bom-files").createSignedUrl(d,3600),{data:g}=await Ye.storage.from("bom-files").createSignedUrl(p,3600);if(!u?.signedUrl||!g?.signedUrl)throw new Error("파일 URL 생성 실패");Oe({bomPath:d,coordPath:p}),Pe("학습 데이터 기반 분석 중...");const N=await ye(y.bomFile,y.coordFile,L.productionQuantity);if(e&&clearInterval(e),t&&clearInterval(t),Me(100),Pe("완료!"),!N||!N.bomItems)throw new Error("BOM 처리 결과가 올바르지 않습니다.");const b={cadDrawingId:`cad_${Date.now()}`,processedData:{bomItems:N.bomItems,topCoordinates:N.topCoordinates,bottomCoordinates:N.bottomCoordinates,coordinates:[...N.topCoordinates,...N.bottomCoordinates],summary:N.summary}};fe(b),await new Promise(e=>setTimeout(e,500)),m.success("BOM 분석 및 정리가 완료되었습니다."),f("preview")}catch(a){const s=`처리 중 오류가 발생했습니다: ${a.message||a}`;De(s),e&&clearInterval(e),t&&clearInterval(t),me(!1),f("input"),window.scrollTo({top:0,behavior:"smooth"})}finally{"processing"===g&&Te&&me(!1)}},disabled:!y.bomFile||!y.coordFile||!L.boardName||!L.productionManager||L.productionQuantity<=0||de,className:"w-full bg-hansl-500 hover:bg-hansl-600 text-white shadow-sm text-xs disabled:bg-gray-300 disabled:cursor-not-allowed",style:{height:"32px"},children:"정리 및 생성"})})]})]})]})})}),!y.bomFile&&!y.coordFile&&a.jsxs("div",{className:"text-center py-6 sm:py-8 text-gray-500",children:[a.jsx(l,{className:"w-10 h-10 sm:w-12 sm:h-12 mx-auto mb-3 text-gray-300"}),a.jsx("p",{className:"text-xs sm:text-sm px-4",children:"BOM 파일과 좌표 파일을 업로드하여 시작하세요"})]})]}),"processing"===g&&a.jsx(p,{children:a.jsx(x,{className:"py-12 sm:py-16 lg:py-20",children:a.jsxs("div",{className:"flex flex-col items-center justify-center max-w-md mx-auto",children:[a.jsx(A,{className:"w-8 h-8 sm:w-10 sm:h-10 text-hansl-600 animate-spin mb-6"}),a.jsx("h3",{className:"text-base sm:text-lg lg:text-xl font-semibold text-center mb-2",children:ke||"AI가 BOM을 분석하고 있습니다"}),a.jsx("p",{className:"text-xs sm:text-sm text-gray-600 mb-6 text-center px-4",children:"잠시만 기다려주세요... (약 30초 ~ 1분 소요)"}),a.jsxs("div",{className:"w-full px-4",children:[a.jsx(P,{value:Ee,className:"h-2"}),a.jsxs("p",{className:"text-right text-xs text-gray-500 mt-1",children:[Math.round(Ee),"%"]})]})]})})}),"preview"===g&&ge&&a.jsx("div",{className:"space-y-4",children:a.jsx(p,{children:a.jsxs(x,{className:"p-4 sm:p-6 w-full max-w-full overflow-hidden",children:[a.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-end gap-3 mb-4",children:[a.jsxs("div",{children:[a.jsxs("h3",{className:"page-title",children:["데이터 미리보기 ",a.jsx("span",{className:"text-xs font-medium text-gray-500 ml-3",children:(L.boardName||"").trim().replace(/_\d{6}_정리본$/,"").replace(/_정리본$/,"").replace(/_\d{6}$/,"")})]}),a.jsx("p",{className:"page-subtitle",children:"데이터 클릭 수정 후 저장 바랍니다."})]}),a.jsxs("div",{className:"flex gap-2",children:[a.jsxs(n,{onClick:()=>Ke.current?.handleMerge(),disabled:!Xe&&!Re,className:"button-base border "+(Xe||Re?Re?"border-orange-300 bg-orange-50 text-orange-700 hover:bg-orange-100":"border-gray-300 bg-white text-gray-700 hover:bg-gray-50":"border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed"),children:[a.jsx(X,{className:"w-4 h-4 mr-2"}),Re?"합치기 해제":"동일 항목 합치기"]}),a.jsxs(n,{onClick:()=>Ke.current?.handleReset(),className:"button-base border border-gray-300 bg-white text-gray-700 hover:bg-gray-50",children:[a.jsx(H,{className:"w-4 h-4 mr-2"}),"초기화"]}),a.jsx(n,{onClick:()=>Ke.current?.handleSave(),disabled:qe,className:"button-base bg-hansl-500 hover:bg-hansl-600 text-white",children:qe?a.jsxs(a.Fragment,{children:[a.jsx(A,{className:"w-4 h-4 mr-2 animate-spin"}),"저장 중..."]}):a.jsxs(a.Fragment,{children:[a.jsx(G,{className:"w-4 h-4 mr-2"}),"저장"]})}),a.jsxs(n,{onClick:()=>Ke.current?.handleDownload(),className:"button-base bg-green-500 hover:bg-green-600 text-white",children:[a.jsx(q,{className:"w-4 h-4 mr-2"}),"Excel"]})]})]}),a.jsxs(K,{defaultValue:"bom",className:"w-full max-w-full",children:[a.jsxs(J,{className:"flex space-x-1 bg-gray-50 p-1 business-radius-card border border-gray-200 mb-4 w-full",children:[a.jsxs(Z,{value:"bom",className:"flex-1 flex items-center justify-center space-x-2 py-1.5 px-3 sm:px-4 business-radius-button !text-xs font-medium transition-colors data-[state=active]:text-hansl-600 data-[state=active]:bg-white data-[state=active]:shadow-sm data-[state=active]:border data-[state=active]:border-gray-200 data-[state=inactive]:text-gray-600 data-[state=inactive]:bg-transparent data-[state=inactive]:hover:text-gray-900 data-[state=inactive]:hover:bg-white/50",children:[a.jsx("span",{className:"whitespace-nowrap",children:"정리된 BOM"}),a.jsx("span",{className:"badge-stats data-[state=active]:bg-hansl-50 data-[state=active]:text-hansl-700 bg-gray-100 text-gray-600",children:(ge.processedData?.bomItems??[]).reduce((e,t)=>e+(t.setCount||0),0)}),(ge.processedData?.bomItems?.filter(e=>e.isManualRequired).length??0)>0&&a.jsxs("span",{className:"badge-stats bg-yellow-100 text-yellow-700 border border-yellow-300",children:["⚠️ 수동 작성: ",ge.processedData?.bomItems?.filter(e=>e.isManualRequired).length]}),Ve>0&&a.jsxs("span",{className:"badge-stats bg-red-100 text-red-700 border border-red-200",children:["REF 불일치: ",Ve]}),He>0&&a.jsxs("span",{className:"badge-stats bg-red-100 text-red-700 border border-red-200",children:["좌표에 없음: ",He,"개"]})]}),a.jsxs(Z,{value:"coord",className:"flex-1 flex items-center justify-center space-x-2 py-1.5 px-3 sm:px-4 business-radius-button !text-xs font-medium transition-colors data-[state=active]:text-hansl-600 data-[state=active]:bg-white data-[state=active]:shadow-sm data-[state=active]:border data-[state=active]:border-gray-200 data-[state=inactive]:text-gray-600 data-[state=inactive]:bg-transparent data-[state=inactive]:hover:text-gray-900 data-[state=inactive]:hover:bg-white/50",children:[a.jsx("span",{className:"whitespace-nowrap",children:"좌표 데이터"}),a.jsx("span",{className:"badge-stats data-[state=active]:bg-hansl-50 data-[state=active]:text-hansl-700 bg-gray-100 text-gray-600",children:ge.processedData?.coordinates?.filter(e=>"TOP"===e.layer).length||0}),a.jsx("span",{className:"badge-stats data-[state=active]:bg-orange-50 data-[state=active]:text-orange-700 bg-gray-100 text-gray-600",children:ge.processedData?.coordinates?.filter(e=>"BOTTOM"===e.layer).length||0}),Ge>0&&a.jsxs("span",{className:"badge-stats bg-red-100 text-red-700 border border-red-200",children:["BOM에 없음: ",Ge,"개"]})]})]}),a.jsx(ee,{value:"bom",className:"mt-0 w-full max-w-full overflow-hidden",children:a.jsx(re,{ref:Ke,bomItems:ge.processedData?.bomItems||[],coordinates:ge.processedData?.coordinates||[],boardName:L.boardName||"Board",productionQuantity:L.productionQuantity,artworkManager:Q.find(e=>e.id===L.artworkManager)?.name||ae?.name||"",productionManager:Q.find(e=>e.id===L.productionManager)?.name||"",onSave:async e=>{if(ge?.cadDrawingId)try{const{data:{user:t}}=await Ye.auth.getUser();if(!t)throw new Error("로그인이 필요합니다.");let a=ge.cadDrawingId;const s=Q.find(e=>e.id===L.artworkManager)?.name||ae?.name||"",r=Q.find(e=>e.id===L.productionManager)?.name||L.productionManager;if(a.startsWith("cad_")){const e=new Date,t=e.getFullYear().toString().slice(2)+String(e.getMonth()+1).padStart(2,"0")+String(e.getDate()).padStart(2,"0"),n=`${L.boardName.trim().replace(/_\d{6}_정리본$/,"").replace(/_정리본$/,"").replace(/_\d{6}$/,"")}_${t}_정리본`,{data:i,error:l}=await Ye.from("cad_drawings").insert({board_name:n,artwork_manager:s,production_manager:r,production_quantity:L.productionQuantity}).select("id").single();if(l)throw l;a=i.id}if(ge.cadDrawingId.startsWith("cad_")||await Ye.from("cad_drawings").update({artwork_manager:s,production_manager:r,production_quantity:L.productionQuantity}).eq("id",a),y.bomFile&&y.coordFile&&Se){let e="",s="";const{data:r}=await Ye.storage.from("bom-files").createSignedUrl(Se.bomPath,31536e3),{data:n}=await Ye.storage.from("bom-files").createSignedUrl(Se.coordPath,31536e3);r?.signedUrl&&(e=r.signedUrl),n?.signedUrl&&(s=n.signedUrl);const{data:i}=await Ye.from("bom_raw_files").select("id").eq("cad_drawing_id",a).single();if(i){const{error:a}=await Ye.from("bom_raw_files").update({bom_file_url:e,coordinate_file_url:s,bom_file_name:y.bomFile.name,coordinate_file_name:y.coordFile.name,uploaded_by:t.email||t.id}).eq("id",i.id);if(a)throw a}else{const{error:r}=await Ye.from("bom_raw_files").insert({cad_drawing_id:a,bom_file_url:e,coordinate_file_url:s,bom_file_name:y.bomFile.name,coordinate_file_name:y.coordFile.name,uploaded_by:t.email||t.id});if(r)throw r}}const{error:n}=await Ye.from("bom_items").delete().eq("cad_drawing_id",a);if(n)throw n;const{error:i}=await Ye.from("bom_items").insert(e.map(e=>({cad_drawing_id:a,line_number:e.lineNumber,item_type:e.itemType,item_name:e.itemName,specification:e.originalFootprint||"",set_count:e.setCount,total_quantity:e.totalQuantity,stock_quantity:e.stockQuantity||0,check_status:e.checkStatus,ref_list:Array.isArray(e.refList)?e.refList:e.refList?e.refList.split(",").map(e=>e.trim()):[],alternative_item:e.alternativeItem||"",remark:e.remark||""})));if(i)throw i;if(ge.processedData?.coordinates){const{error:e}=await Ye.from("part_placements").delete().eq("cad_drawing_id",a);if(e)throw e;const{error:t}=await Ye.from("part_placements").insert(ge.processedData.coordinates.map(e=>({cad_drawing_id:a,ref:e.refDes,part_name:e.partName,part_type:e.type,side:e.layer,x_coordinate:e.locationX||0,y_coordinate:e.locationY||0,angle:e.rotation||null})));if(t)throw t}if(Se){const{error:t}=await Ye.from("ai_learning_records").insert({cad_drawing_id:a,processed_bom_data:e,processed_coordinate_data:ge.processedData?.coordinates,cad_program_type:"unknown",created_at:(new Date).toISOString()});if(t);else{const{resetLearningDataCache:e}=await d(async()=>{const{resetLearningDataCache:e}=await Promise.resolve().then(()=>Ne);return{resetLearningDataCache:e}},void 0);e()}}fe(t=>({...t,cadDrawingId:a,processedData:{...t.processedData,bomItems:e}})),m.success("수정사항이 저장되었습니다."),tt(),it(),setTimeout(()=>{u("list")},1e3)}catch(t){m.error(`저장에 실패했습니다: ${t.message}`)}},onMergeStateChange:Fe,onBomChange:e=>{if(!ge?.processedData?.coordinates)return;const t=new Map;e.forEach(e=>{(e.refList||"").split(",").map(e=>e.trim()).filter(e=>e).forEach(a=>{t.set(a.toUpperCase(),{type:e.itemType||"",partName:e.itemName||""})})});const a=ge.processedData.coordinates.map(e=>{const a=(e.refDes||"").toUpperCase(),s=t.get(a);return s?{...e,type:s.type,partName:s.partName}:e});fe(t=>({...t,processedData:{...t.processedData,bomItems:e,coordinates:a}}))}})}),a.jsx(ee,{value:"coord",className:"mt-0 w-full max-w-full overflow-hidden",children:a.jsx(ne,{coordinates:ge.processedData?.coordinates||[],bomItems:ge.processedData?.bomItems||[]})})]})]})})})]}),a.jsx(le,{boardId:Ue,isOpen:Le,onClose:()=>{Ae(!1),$e(null)}})]})}export{be as default};
//# sourceMappingURL=BomCoordinateIntegrated-DFvr5P-C.js.map
