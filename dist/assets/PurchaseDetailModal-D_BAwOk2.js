import{c as e,r as t,j as a,l as s,a as r,s as i,B as n,X as l,F as c,t as d,q as m,v as o}from"./index-_Q47D3pG.js";import{b as u}from"./helpers-CsHcdtkA.js";import{a as _,k as p,f as h,C as x,P as g}from"./calendar-B5MGiWmf.js";import{P as v,a as b,b as f}from"./popover-D9WMVnl_.js";import{I as y,D as j,a as N,b as w,c as k}from"./input-CQ4yqQ5Y.js";import{t as q}from"./index-B5Y05e2r.js";import{C as S}from"./calendar-Bcldy8qi.js";import{C}from"./chevron-down-CEtsGlQW.js";import{P as D}from"./package-mkgyTfc2.js";import{C as I}from"./credit-card-DA7A61xW.js";import{T as $}from"./card-D7_9Yw1U.js";import{P as T}from"./plus-DodWBwvd.js";import{S as W}from"./save-DJXGevod.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const M=e("truck",[["path",{d:"M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2",key:"wrbu53"}],["path",{d:"M15 18H9",key:"1lyqi6"}],["path",{d:"M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14",key:"lysw3i"}],["circle",{cx:"17",cy:"18",r:"2",key:"332jqn"}],["circle",{cx:"7",cy:"18",r:"2",key:"19iecd"}]]);function P({children:e,onDateSelect:r,disabled:i=!1,placeholder:n="ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”",align:l="center",side:c="bottom"}){const[d,m]=t.useState(!1);return a.jsxs(v,{open:d,onOpenChange:m,children:[a.jsx(b,{asChild:!0,disabled:i,children:e}),a.jsx(f,{className:"w-auto p-0 border-gray-200 shadow-lg",align:l,side:c,sideOffset:8,children:a.jsxs("div",{className:"bg-white business-radius-card p-2",children:[a.jsx("div",{className:"mb-2 px-1",children:a.jsx("div",{className:"modal-label text-gray-600 text-center",children:n})}),a.jsx(_,{mode:"single",selected:void 0,onSelect:e=>{s.debug("ðŸ—“ï¸ Calendar onSelect ì§ì ‘ í˜¸ì¶œ:",{date:e,isToday:e&&(new Date).toDateString()===e.toDateString(),dateValue:e?.getTime(),todayValue:(new Date).getTime()}),(e=>{s.debug("ðŸ“… DatePickerPopover handleDateSelect í˜¸ì¶œ:",{date:e,isToday:e&&(new Date).toDateString()===e.toDateString(),dateString:e?.toDateString(),todayString:(new Date).toDateString()}),e?(s.debug("âœ… ë‚ ì§œ ì„ íƒë¨, onDateSelect í˜¸ì¶œ ì˜ˆì •"),r(e),m(!1),s.debug("ðŸ”š DatePickerPopover ì²˜ë¦¬ ì™„ë£Œ")):s.debug("âŒ ë‚ ì§œê°€ undefinedìž„")})(e)},locale:p,initialFocus:!0,className:"compact-calendar",disabled:!1,fromDate:new Date("2020-01-01"),toDate:new Date("2030-12-31"),defaultMonth:new Date,modifiers:{today:new Date},modifiersClassNames:{today:"bg-blue-500 text-white font-semibold cursor-pointer hover:bg-blue-600 rounded-md"}})]})})]})}function U({config:e,currentUserName:a,canPerformAction:i,onUpdate:n,onOptimisticUpdate:l}){const c=r(),d=t.useCallback(async(t,r,d)=>{if(!i)return s.warn("âŒ ê¶Œí•œ ì—†ìŒ",{canPerformAction:i,currentUserName:a}),void q.error(("statement_received"===e.field?"ê±°ëž˜ëª…ì„¸ì„œ":"ìž…ê³ ")+" í™•ì¸ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");const m="number"==typeof t?t:Number(t);if(Number.isNaN(m))return s.error("âŒ ìž˜ëª»ëœ ID",{itemId:t,numericId:m}),void q.error("ìœ íš¨í•˜ì§€ ì•Šì€ í•­ëª© ID ìž…ë‹ˆë‹¤.");if(d){const t=`í’ˆëª©ëª…: ${d.item_name||"-"}\nê·œê²©: ${d.specification||"-"}\nìˆ˜ëŸ‰: ${d.quantity?.toLocaleString()||0}\në‹¨ê°€: â‚©${d.unit_price_value?.toLocaleString()||0}\ní•©ê³„: â‚©${d.amount_value?.toLocaleString()||0}\në¹„ê³ : ${d.remark||"-"}\n\n${e.confirmMessage.confirm}`;if(!window.confirm(t))return}try{let t;"statement_received"===e.field?t={is_statement_received:!0,statement_received_date:r.toISOString(),statement_received_by_name:a}:"actual_received"===e.field&&(t={actual_received_date:r.toISOString()}),s.debug("ðŸ“ ì—…ë°ì´íŠ¸í•  ë°ì´í„°:",t);const{data:i,error:o}=await c.from("purchase_request_items").update(t).eq("id",m).select();if(s.debug("ðŸ“ DB ì—…ë°ì´íŠ¸ ê²°ê³¼:",{data:i,error:o}),o)throw s.error("âŒ DB ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",o),o;s.info("âœ… DB ì—…ë°ì´íŠ¸ ì„±ê³µ",i),l&&l({itemId:m,selectedDate:r,action:"confirm",itemInfo:d}),n&&n(),q.success(e.successMessage.confirm)}catch(o){s.error("âŒ ì „ì²´ ì²˜ë¦¬ ì‹¤íŒ¨",o),q.error(("statement_received"===e.field?"ê±°ëž˜ëª…ì„¸ì„œ":"ìž…ê³ ")+" í™•ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},[e,a,i,n,l,c]),m=t.useCallback(async(t,r)=>{if(!i)return s.warn("âŒ ì·¨ì†Œ ê¶Œí•œ ì—†ìŒ",{canPerformAction:i,currentUserName:a}),void q.error(("statement_received"===e.field?"ê±°ëž˜ëª…ì„¸ì„œ":"ìž…ê³ ")+" í™•ì¸ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");const d="number"==typeof t?t:Number(t);if(Number.isNaN(d))q.error("ìœ íš¨í•˜ì§€ ì•Šì€ í•­ëª© ID ìž…ë‹ˆë‹¤.");else{if(r){const t=`í’ˆëª©ëª…: ${r.item_name||"-"}\nê·œê²©: ${r.specification||"-"}\nìˆ˜ëŸ‰: ${r.quantity?.toLocaleString()||0}\në‹¨ê°€: â‚©${r.unit_price_value?.toLocaleString()||0}\ní•©ê³„: â‚©${r.amount_value?.toLocaleString()||0}\në¹„ê³ : ${r.remark||"-"}\n\n${e.confirmMessage.cancel}`;if(!window.confirm(t))return}try{let a;s.debug(`ðŸ”„ ${e.field} í™•ì¸ ì·¨ì†Œ ì‹œìž‘`,{itemId:t,itemName:r?.item_name}),"statement_received"===e.field?a={is_statement_received:!1,statement_received_date:null,statement_received_by_name:null}:"actual_received"===e.field&&(a={actual_received_date:null}),s.debug("ðŸ”„ ì·¨ì†Œ ì—…ë°ì´íŠ¸í•  ë°ì´í„°:",a);const{data:i,error:m}=await c.from("purchase_request_items").update(a).eq("id",d).select();if(s.debug("ðŸ”„ ì·¨ì†Œ DB ì—…ë°ì´íŠ¸ ê²°ê³¼:",{data:i,error:m}),m)throw s.error("âŒ DB ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",m),m;s.info(`âœ… ${e.field} í™•ì¸ ì·¨ì†Œ ì„±ê³µ`,i),l&&l({itemId:d,action:"cancel",itemInfo:r}),n&&n(),q.success(e.successMessage.cancel)}catch(m){s.error(`âŒ ${e.field} í™•ì¸ ì·¨ì†Œ ì‹¤íŒ¨`,m),q.error(("statement_received"===e.field?"ê±°ëž˜ëª…ì„¸ì„œ":"ìž…ê³ ")+" í™•ì¸ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}}},[e,i,n,l,c]),o=t.useCallback(t=>"statement_received"===e.field?t.is_statement_received:"actual_received"===e.field&&!!t.actual_received_date,[e.field]),u=t.useCallback(t=>"statement_received"===e.field?t.statement_received_date:"actual_received"===e.field?t.actual_received_date:null,[e.field]),_=t.useCallback(t=>"statement_received"===e.field?t.statement_received_by_name:(e.field,null),[e.field]);return{config:e,handleConfirm:d,handleCancel:m,isCompleted:o,getCompletedDate:u,getCompletedByName:_}}const O=t.memo(function({purchaseId:e,isOpen:_,onClose:p,embedded:v=!1,currentUserRoles:b=[],activeTab:f,onRefresh:O,onOptimisticUpdate:K,onDelete:F}){const[L,R]=t.useState(!1),[A,B]=t.useState(null),[z,E]=t.useState(!1),[H,V]=t.useState(null),[J,G]=t.useState([]),[Q,X]=t.useState([]),[Y,Z]=t.useState([]),[ee,te]=t.useState(""),[ae,se]=t.useState([]),re=t.useMemo(()=>{if(ae.length>0){const e=ae.length>1?12*(ae.length-1):0,t=48,a=ae.reduce((e,t)=>e+t,0)+e+t;return Math.max(a,720)}const e=[120,140,80,110,130,110,120];"purchase"===f&&e.push(120),"receipt"!==f&&"done"!==f||e.push(120),"receipt"===f&&e.push(140),"done"===f&&e.push(140,140,110),z&&e.push(110);const t=e.length>1?12*(e.length-1):0,a=e.reduce((e,t)=>e+t,0)+t+48;return Math.max(a,720)},[ae,f,z]),ie=t.useRef(null),ne=r();t.useEffect(()=>{_&&(async()=>{try{const e="https://qvhbigvdfyvhoegkhvef.supabase.co";if(!e||e.includes("placeholder"))return void s.warn("Supabase í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ - PurchaseDetailModal");const{data:{user:t}}=await ne.auth.getUser();if(t){let{data:e}=await ne.from("employees").select("*").eq("id",t.id).maybeSingle();if(!e&&t.email){const{data:a}=await ne.from("employees").select("*").eq("email",t.email).maybeSingle();e=a}if(e?.name&&te(e.name),e?.purchase_role){let t=[];t=Array.isArray(e.purchase_role)?e.purchase_role.map(e=>String(e).trim()):String(e.purchase_role).split(",").map(e=>e.trim()).filter(e=>e.length>0),Z(t)}}}catch(e){}})()},[_]);const le=Array.isArray(b)&&b.length>0?b:Y,ce=le.includes("final_approver")||le.includes("app_admin")||le.includes("ceo"),de=le.includes("lead buyer"),me=ce||de,oe="approved"===A?.final_manager_status?ce:ce||A?.requester_name===ee,ue=le.includes("app_admin")||le.includes("lead buyer")||le.includes("lead buyer"),_e=le.includes("app_admin")||A?.requester_name===ee,pe=le.includes("final_approver")||le.includes("app_admin")||le.includes("ceo"),he=A?.requester_name===ee,xe=le.includes("app_admin")||le.includes("lead buyer"),ge=t.useCallback(async()=>{if(e)try{const t=i(e);if(t){s.debug(`[PurchaseDetailModal] ë©”ëª¨ë¦¬ì—ì„œ ë°œì£¼ ${e} ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ`);const a={...t,id:String(t.id),is_po_generated:!1,vendor:{id:t.vendor_id,vendor_name:t.vendor_name||"ì•Œ ìˆ˜ ì—†ìŒ",is_active:!0},vendor_contacts:[]};return B(a),V(a),void G(t.items||[])}s.debug(`[PurchaseDetailModal] ë©”ëª¨ë¦¬ì—ì„œ ë°œì£¼ ${e} ì°¾ì§€ ëª»í•¨, DBì—ì„œ ìƒˆë¡œê³ ì¹¨`);const a=r(),{data:n,error:l}=await a.from("purchase_requests").select("\n          *,\n          vendors(id, vendor_name),\n          purchase_request_items(*)\n        ").eq("id",e).single();if(l)throw l;if(n){const e=(n.purchase_request_items||[]).sort((e,t)=>(e.line_number||999999)-(t.line_number||999999)),t={...n,items:e,vendor:n.vendors||{id:0,vendor_name:"ì•Œ ìˆ˜ ì—†ìŒ"},vendor_contacts:[]};B(t),V(t),G(e),s.debug("ëª¨ë‹¬ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ - ëª¨ë‹¬ ìƒíƒœ ìœ ì§€")}}catch(t){s.error("ëª¨ë‹¬ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨",t)}},[e]),[ve,be]=t.useState(!0),fe=e?Number(e):A?Number(A.id):NaN,ye=t.useCallback(({itemId:e,selectedDate:t,action:a})=>{const s=String(e),r=(new Date).toISOString(),i=t?t.toISOString():void 0,n=e=>e?e.map(e=>String(e.id)!==s?e:"confirm"===a?{...e,is_received:!0,actual_received_date:i,received_at:r}:{...e,is_received:!1,actual_received_date:void 0,received_at:void 0}):e;B(e=>{if(!e)return e;const t=n(e.items)||[],a=t.length,s=t.filter(e=>e.is_received).length,i=a>0&&s===a;return{...e,items:t,is_received:i,received_at:i?e.received_at||r:void 0}}),V(e=>{if(!e)return e;const t=n(e.items)||[];return{...e,items:t}}),G(e=>e&&0!==e.length?e.map(e=>e.id&&String(e.id)===s?"confirm"===a?{...e,is_received:!0,actual_received_date:i,received_at:r}:{...e,is_received:!1,actual_received_date:void 0,received_at:void 0}:e):e),Number.isNaN(fe)||K?.(fe,e=>{const t=n(e.items)||e.items||[],a=t.length||e.items?.length||0,s=t.filter(e=>e.is_received).length,i=a>0&&s===a;return{...e,items:t,is_received:i,received_at:i?e.received_at||r:void 0}})},[K,fe]),je=t.useCallback(({itemId:e,selectedDate:t,action:a})=>{const i=String(e),n=t?t.toISOString():void 0;let l=!1,c=null;if(B(e=>{if(!e)return e;const t=(e.items||[]).map(e=>String(e.id)!==i?e:"confirm"===a?{...e,is_statement_received:!0,statement_received_date:n,statement_received_by_name:ee}:{...e,is_statement_received:!1,statement_received_date:null,statement_received_by_name:null});return l=t.length>0&&t.every(e=>e.is_statement_received),c=l?n||e.statement_received_at||(new Date).toISOString():null,{...e,items:t,is_statement_received:l,statement_received_at:c}}),V(e=>{if(!e)return e;const t=(e.items||[]).map(e=>String(e.id)!==i?e:"confirm"===a?{...e,is_statement_received:!0,statement_received_date:n,statement_received_by_name:ee}:{...e,is_statement_received:!1,statement_received_date:null,statement_received_by_name:null});return{...e,items:t,is_statement_received:l,statement_received_at:c}}),G(e=>e?e.map(e=>String(e.id)!==i?e:"confirm"===a?{...e,is_statement_received:!0,statement_received_date:n,statement_received_by_name:ee}:{...e,is_statement_received:!1,statement_received_date:null,statement_received_by_name:null}):e),Number.isNaN(fe)||K?.(fe,e=>{const t=(e.items||[]).map(e=>String(e.id)!==i?e:"confirm"===a?{...e,is_statement_received:!0,statement_received_date:n,statement_received_by_name:ee}:{...e,is_statement_received:!1,statement_received_date:null,statement_received_by_name:null}),s=t.length>0&&t.every(e=>e.is_statement_received);return{...e,items:t,is_statement_received:s}}),A&&void 0!==l){r().from("purchase_requests").update({is_statement_received:l,statement_received_at:c}).eq("id",A.id).then(({error:e})=>{e&&s.error("ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸ purchase_requests ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",e)})}},[ee,K,fe,A]),Ne=U({config:{field:"statement_received",confirmMessage:{confirm:"ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸ì„ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",cancel:"ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"},successMessage:{confirm:"ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",cancel:"ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."},completedText:"âœ“ ì™„ë£Œ",waitingText:"ëŒ€ê¸°"},currentUserName:ee,canPerformAction:xe,onUpdate:ge,onOptimisticUpdate:je}),we=U({config:{field:"actual_received",confirmMessage:{confirm:"ì‹¤ì œ ìž…ê³  ì²˜ë¦¬ë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",cancel:"ì‹¤ì œ ìž…ê³  ì²˜ë¦¬ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"},successMessage:{confirm:"ì‹¤ì œ ìž…ê³  ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",cancel:"ì‹¤ì œ ìž…ê³  ì²˜ë¦¬ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."},completedText:"ìž…ê³ ì™„ë£Œ",waitingText:"ìž…ê³ ëŒ€ê¸°"},currentUserName:ee,canPerformAction:xe,onUpdate:ge,onOptimisticUpdate:ye});s.debug("Receipt Check",{activeTab:f,canReceiptCheck:xe,isAdmin:pe,isRequester:he,currentUserName:ee,requesterName:A?.requester_name,effectiveRoles:le});const ke=le.includes("middle_manager")||le.includes("app_admin")||le.includes("ceo"),qe=le.includes("final_approver")||le.includes("app_admin")||le.includes("ceo"),Se="inline-flex items-center gap-1 business-radius-badge !h-auto !min-h-0 !px-2.5 !py-0.5 badge-text leading-tight",Ce="inline-flex items-center gap-1 business-radius-badge px-2.5 py-0.5 badge-text leading-tight";s.debug("PurchaseDetailModal ê¶Œí•œ ì²´í¬",{purchaseOrderNumber:A?.purchase_order_number,currentUserRoles:b,userRoles:Y,effectiveRoles:le,canApproveMiddle:ke,canApproveFinal:qe,isEditing:z,middleManagerStatus:A?.middle_manager_status,finalManagerStatus:A?.final_manager_status}),t.useEffect(()=>{if(e&&_){const t=i(e);if(t){s.debug(`[PurchaseDetailModal] useEffect - ë©”ëª¨ë¦¬ì—ì„œ ë°œì£¼ ${e} ì¦‰ì‹œ ì„¤ì •`);const a={...t,id:String(t.id),is_po_generated:!1,vendor:{id:t.vendor_id,vendor_name:t.vendor_name||"ì•Œ ìˆ˜ ì—†ìŒ",is_active:!0},vendor_contacts:[]};B(a),V(a),G(t.items||[])}else We(e.toString());E(!1)}},[e,_]);const De=t.useCallback(()=>{if(!A?.purchase_request_items||0===A.purchase_request_items.length)return[];const e=A.purchase_request_items??[],t=[{key:"item_name",minWidth:80,maxWidth:500,baseWidth:80},{key:"specification",minWidth:120,maxWidth:700,baseWidth:120},{key:"quantity",minWidth:70,maxWidth:100,baseWidth:70},{key:"unit_price",minWidth:90,maxWidth:150,baseWidth:90},{key:"total_price",minWidth:100,maxWidth:180,baseWidth:100},{key:"remarks",minWidth:80,maxWidth:240,baseWidth:80},{key:"status",minWidth:80,maxWidth:120,baseWidth:80}];"receipt"===f&&t.push({key:"actual_receipt_date",minWidth:100,maxWidth:160,baseWidth:100}),"done"===f&&t.push({key:"transaction_confirm",minWidth:100,maxWidth:160,baseWidth:100},{key:"accounting_date",minWidth:100,maxWidth:160,baseWidth:100},{key:"processor",minWidth:80,maxWidth:120,baseWidth:80},{key:"utk_confirm",minWidth:80,maxWidth:120,baseWidth:80});const a=t.map((t,a)=>{let r=4;const i=(()=>{const e="pending"===f?["í’ˆëª©ëª…","ê·œê²©","ìˆ˜ëŸ‰","ë‹¨ê°€","í•©ê³„","ë¹„ê³ "]:["í’ˆëª©ëª…","ê·œê²©","ìˆ˜ëŸ‰","ë‹¨ê°€","í•©ê³„","ë¹„ê³ ","purchase"===f?"êµ¬ë§¤ìƒíƒœ":"receipt"===f||"done"===f?"ìž…ê³ ìƒíƒœ":"ìƒíƒœ"];return"receipt"===f?[...e,"ì‹¤ì œìž…ê³ ì¼"]:"done"===f?[...e,"ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸","íšŒê³„ìƒ ìž…ê³ ì¼","ì²˜ë¦¬ìž","UTK"]:e})();i[a]&&(r=Math.max(r,i[a].length)),e.forEach(e=>{let a="";switch(t.key){case"item_name":a=e.item_name||"";break;case"specification":a=e.specification||"";break;case"quantity":a=e.quantity?.toString()||"";break;case"unit_price":a=null!=e.unit_price_value?e.unit_price_value.toLocaleString():"";break;case"total_price":a=null!=e.amount_value?e.amount_value.toLocaleString():null!=e.quantity&&null!=e.unit_price_value?(Number(e.quantity)*Number(e.unit_price_value)).toLocaleString():"";break;case"remarks":a=e.remark||"";break;case"status":a=Ie(e)||"";break;case"actual_receipt_date":a=e.actual_received_date?u(e.actual_received_date):"";break;case"transaction_confirm":a=e.is_statement_received?"í™•ì¸ì™„ë£Œ":"ë¯¸í™•ì¸";break;case"accounting_date":a=e.statement_received_date?u(e.statement_received_date):"";break;case"processor":a=e.statement_received_by_name||"";break;case"utk_confirm":a=e.is_utk_checked?"ì™„ë£Œ":"ëŒ€ê¸°"}const s=a.split("").reduce((e,t)=>e+(/[ê°€-íž£]/.test(t)?1.5:1),0);r=Math.max(r,Math.ceil(s))});const n=Math.max(t.minWidth,Math.min(t.maxWidth,7*r+20));return s.debug(`Column ${t.key} calculated:`,{maxLength:r,calculatedWidth:n,range:`${t.minWidth}-${t.maxWidth}px`}),n});return se(a),s.debug("Optimal column widths calculated",{calculatedWidths:a}),a},[A,f]),Ie=e=>"purchase"===f?e.is_payment_completed?"êµ¬ë§¤ì™„ë£Œ":"êµ¬ë§¤ìš”ì²­":"receipt"===f?e.is_received?"ìž…ê³ ":"ìž…ê³ ëŒ€ê¸°":e.is_payment_completed?"êµ¬ë§¤ì™„ë£Œ":"êµ¬ë§¤ìš”ì²­",$e=()=>{if(ae.length>0)return ae.map(e=>`${e}px`).join(" ");const e=["80px","120px","70px","90px","100px","80px","80px"];return"receipt"===f?[...e,"100px"].join(" "):"done"===f?[...e,"100px","100px","80px","80px"].join(" "):e.join(" ")};t.useEffect(()=>{A&&A.purchase_request_items&&A.purchase_request_items.length>0&&!z&&requestAnimationFrame(()=>{De()})},[A,z,f,De]);const Te=e=>{e&&!z&&De(),E(e)},We=async e=>{try{const t=i(e);if(t){s.debug(`[PurchaseDetailModal] ë©”ëª¨ë¦¬ì—ì„œ ë°œì£¼ ${e} ì¦‰ì‹œ ë¡œë“œ ì™„ë£Œ`);const a={...t,id:String(t.id),is_po_generated:!1,vendor:{id:t.vendor_id,vendor_name:t.vendor_name||"ì•Œ ìˆ˜ ì—†ìŒ",is_active:!0},vendor_contacts:[]};return B(a),V(a),void G(t.items||[])}s.debug(`[PurchaseDetailModal] ë©”ëª¨ë¦¬ì—ì„œ ë°œì£¼ ${e} ì°¾ì§€ ëª»í•¨, DBì—ì„œ ë¡œë“œ`),R(!0);const a=r(),{data:n,error:l}=await a.from("purchase_requests").select("\n          *,\n          vendors(id, vendor_name),\n          purchase_request_items(*)\n        ").eq("id",e).single();if(l)throw l;if(n){const e=(n.purchase_request_items||[]).sort((e,t)=>(e.line_number||999999)-(t.line_number||999999)),t={...n,items:e,vendor:n.vendors||{id:0,vendor_name:"ì•Œ ìˆ˜ ì—†ìŒ"},vendor_contacts:[]};B(t),V(t),G(e)}}catch(t){s.error("[PurchaseDetailModal] ë°œì£¼ ìƒì„¸ ë¡œë“œ ì‹¤íŒ¨:",t),q.error("ë°œì£¼ ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}finally{R(!1)}},Me=e=>new Intl.NumberFormat("ko-KR").format(e),Pe=(e,t,a)=>{const s=[...J];if("amount_value"===t)s[e]={...s[e],amount_value:a};else if("quantity"===t||"unit_price_value"===t){const r="quantity"===t?a:s[e].quantity,i="unit_price_value"===t?a:s[e].unit_price_value;s[e]={...s[e],[t]:a,amount_value:r*i}}else s[e]={...s[e],[t]:a};G(s)},Ue=e=>{const t=J[e];t.id&&X([...Q,t.id]);const a=J.filter((t,a)=>a!==e).sort((e,t)=>(e.line_number||999999)-(t.line_number||999999));G(a)},Oe=async(e,t)=>{if(!ue)return void q.error("êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");const a=String(e),r="number"==typeof e?e:Number(e);if(Number.isNaN(r))return void q.error("ìœ íš¨í•˜ì§€ ì•Šì€ í•­ëª© ID ìž…ë‹ˆë‹¤.");const i=A?.items?.find(e=>String(e.id)===a);if(!i)return;const n=`í’ˆëª…: ${i.item_name}\nê·œê²©: ${i.specification||"ë¯¸ìž…ë ¥"}\nìˆ˜ëŸ‰: ${i.quantity?.toLocaleString()||0}${i.unit||""}\në‹¨ê°€: â‚©${i.unit_price_value?.toLocaleString()||0}\ní•©ê³„: â‚©${i.amount_value?.toLocaleString()||0}`,l=t?`ë‹¤ìŒ í’ˆëª©ì„ êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${n}`:`ë‹¤ìŒ í’ˆëª©ì˜ êµ¬ë§¤ì™„ë£Œë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${n}`;if(window.confirm(l))try{const{error:e}=await ne.from("purchase_request_items").update({is_payment_completed:t,payment_completed_at:t?(new Date).toISOString():null}).eq("id",r);if(e)throw e;if(A&&t){o(A.id,r)?s.debug("[PurchaseDetailModal] ë©”ëª¨ë¦¬ ìºì‹œ í’ˆëª© êµ¬ë§¤ì™„ë£Œ ì—…ë°ì´íŠ¸ ì™„ë£Œ",{purchaseId:A.id,itemId:r}):s.warn("[PurchaseDetailModal] ë©”ëª¨ë¦¬ ìºì‹œ í’ˆëª© ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{purchaseId:A.id,itemId:r})}if(B(e=>{if(!e)return null;const s=e.items?.map(e=>String(e.id)===a?{...e,is_payment_completed:t,payment_completed_at:t?(new Date).toISOString():null}:e);return{...e,items:s}}),A){const e=Number(A.id);Number.isNaN(e)||K?.(e,e=>{const s=(e.items||[]).map(e=>String(e.id)===a?{...e,is_payment_completed:t}:e),r=s.length||e.items?.length||0,i=s.filter(e=>e.is_payment_completed).length,n=r>0&&i===r;return{...e,items:s,is_payment_completed:n,payment_completed_at:n?(new Date).toISOString():null,payment_completed_by_name:n&&ee||e.payment_completed_by_name}})}q.success(t?"êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.":"êµ¬ë§¤ì™„ë£Œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."),await ge();const i=O?.(!0,{silent:!0});i instanceof Promise&&await i}catch(c){q.error("êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},Ke=async e=>{if(!A)return;const t="middle"===e?"1ì°¨ ìŠ¹ì¸":"ìµœì¢… ìŠ¹ì¸",a=`ë°œì£¼ë²ˆí˜¸: ${A.purchase_order_number}\n\n${t}ì„ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;if(window.confirm(a))try{const t="middle"===e?{middle_manager_status:"approved"}:{final_manager_status:"approved"},{error:a}=await ne.from("purchase_requests").update(t).eq("id",A.id);if(a)throw a;if(B("middle"===e?e=>e?{...e,middle_manager_status:"approved"}:null:e=>e?{...e,final_manager_status:"approved"}:null),A&&K){const t=Number(A.id);Number.isNaN(t)||K(t,t=>"middle"===e?{...t,middle_manager_status:"approved"}:{...t,final_manager_status:"approved"})}q.success(("middle"===e?"ì¤‘ê°„":"ìµœì¢…")+" ìŠ¹ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."),await ge();const s=O?.(!0,{silent:!0});s instanceof Promise&&await s}catch(s){q.error("ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},Fe=a.jsx("div",{className:"space-y-1 sm:space-y-4",children:L?a.jsx("div",{className:"flex items-center justify-center py-12",children:a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-hansl-600"})}):A?a.jsxs("div",{children:[a.jsx("div",{className:"bg-gray-50 rounded-lg p-2 sm:p-3 mb-1 sm:mb-2 border border-gray-100",children:a.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 items-center gap-3 sm:gap-0",children:[a.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-4",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[(()=>{if(!A)return null;if(A.payment_category){const e=A.payment_category.trim();return"ë°œì£¼"===e?a.jsx("span",{className:"badge-stats bg-green-500 text-white",children:"ë°œì£¼"}):"êµ¬ë§¤ìš”ì²­"===e?a.jsx("span",{className:"badge-stats bg-blue-500 text-white",children:"êµ¬ë§¤ìš”ì²­"}):"í˜„ìž¥ê²°ì œ"===e?a.jsx("span",{className:"badge-stats bg-gray-500 text-white",children:"í˜„ìž¥ê²°ì œ"}):a.jsx("span",{className:"badge-stats bg-blue-500 text-white",children:e})}return a.jsx("span",{className:"badge-stats bg-blue-500 text-white",children:"êµ¬ë§¤ìš”ì²­"})})(),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"modal-label",children:"ìš”ì²­ìž:"}),a.jsx("span",{className:"modal-value",children:A.requester_name})]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(S,{className:"w-3 h-3 text-gray-500"}),a.jsxs("span",{className:"modal-subtitle",children:["ì²­êµ¬ì¼: ",u(A.request_date)]})]})]}),a.jsxs("div",{className:"flex items-center justify-center gap-2 sm:gap-3 flex-wrap",children:[(()=>{const e=ke&&"pending"===A.middle_manager_status;return"F20251105_004"===A?.purchase_order_number&&s.debug("F20251105_004 1ì°¨ ìŠ¹ì¸ ë²„íŠ¼ ì¡°ê±´",{canApproveMiddle:ke,middleManagerStatus:A.middle_manager_status,shouldShow:e}),e})()&&a.jsx(n,{size:"sm",variant:"outline",onClick:()=>Ke("middle"),className:`${Se} border border-gray-400 bg-white hover:bg-gray-50 hover:border-gray-500`,children:"1ì°¨ ìŠ¹ì¸ ëŒ€ê¸°"}),"approved"===A.middle_manager_status&&a.jsxs("div",{className:"button-approved badge-text shadow-sm",children:[a.jsx(C,{className:"w-3 h-3"}),"1ì°¨ ìŠ¹ì¸ì™„ë£Œ"]}),"rejected"===A.middle_manager_status&&a.jsxs("div",{className:"button-rejected badge-text",children:[a.jsx(l,{className:"w-3 h-3"}),"1ì°¨ ë°˜ë ¤"]}),"pending"===A.middle_manager_status&&!ke&&a.jsx("div",{className:`${Ce} border border-gray-300 text-gray-600 bg-white`,children:"1ì°¨ ìŠ¹ì¸ëŒ€ê¸°"}),(()=>{const e=qe&&"approved"===A.middle_manager_status&&"pending"===A.final_manager_status;return"F20251105_004"===A?.purchase_order_number&&s.debug("F20251105_004 ìµœì¢… ìŠ¹ì¸ ë²„íŠ¼ ì¡°ê±´",{canApproveFinal:qe,middleManagerStatus:A.middle_manager_status,finalManagerStatus:A.final_manager_status,shouldShow:e}),e})()&&a.jsxs(n,{size:"sm",variant:"outline",onClick:()=>Ke("final"),className:`${Se} border border-gray-400 bg-white hover:bg-gray-50 hover:border-gray-500`,children:[a.jsx(C,{className:"w-3 h-3"}),"ìµœì¢… ìŠ¹ì¸"]}),"approved"===A.final_manager_status&&a.jsxs("div",{className:"button-approved badge-text",children:[a.jsx(C,{className:"w-3 h-3"}),"ìµœì¢… ìŠ¹ì¸ì™„ë£Œ"]}),"rejected"===A.final_manager_status&&a.jsxs("div",{className:"button-rejected badge-text",children:[a.jsx(l,{className:"w-3 h-3"}),"ìµœì¢… ë°˜ë ¤"]}),"approved"!==A.middle_manager_status&&"pending"===A.final_manager_status&&a.jsx("div",{className:`${Ce} border border-gray-300 text-gray-600 bg-white`,children:"ìµœì¢… ìŠ¹ì¸ëŒ€ê¸°"})]}),a.jsx("div",{})]})}),a.jsxs("div",{className:"flex flex-col lg:flex-row gap-3 sm:gap-6",children:[a.jsxs("div",{className:"lg:w-80 lg:flex-shrink-0 space-y-1 sm:space-y-4 relative",children:[a.jsxs("div",{className:"bg-white rounded-lg p-2 sm:p-3 border border-gray-100 shadow-sm",children:[a.jsx("div",{className:"mb-3",children:a.jsxs("h3",{className:"modal-section-title flex items-center",children:[a.jsx(c,{className:"w-4 h-4 mr-2 text-gray-600"}),A?.purchase_order_number||"POë²ˆí˜¸ ì—†ìŒ"]})}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"ë°œì£¼ì„œ ì¢…ë¥˜"}),z?a.jsx(y,{value:H?.request_type||"",onChange:e=>V(t=>t?{...t,request_type:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"ì¼ë°˜"}):a.jsx("p",{className:"modal-value",children:A.request_type||"ì¼ë°˜"})]}),a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"ê²°ì œ ì¢…ë¥˜"}),z?a.jsx(y,{value:H?.payment_category||"",onChange:e=>V(t=>t?{...t,payment_category:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"ë°œì£¼/êµ¬ë§¤ìš”ì²­/í˜„ìž¥ê²°ì œ"}):a.jsx("p",{className:"modal-value",children:A.payment_category||"-"})]})]}),a.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"ìž…ê³  ìš”ì²­ì¼"}),z?a.jsx(P,{onDateSelect:e=>{V(t=>t?{...t,delivery_request_date:h(e,"yyyy-MM-dd")}:null)},placeholder:"ìž…ê³  ìš”ì²­ì¼ì„ ì„ íƒí•˜ì„¸ìš”",align:"start",side:"bottom",children:a.jsxs(n,{variant:"outline",className:"mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] justify-start text-left font-normal business-radius-input",children:[a.jsx(S,{className:"mr-1 h-3 w-3"}),H?.delivery_request_date?u(H.delivery_request_date):"ë‚ ì§œ ì„ íƒ"]})}):a.jsx("p",{className:"modal-subtitle",children:u(A.delivery_request_date)})]}),a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label text-orange-500",children:"ë³€ê²½ ìž…ê³ ì¼"}),z?a.jsx(P,{onDateSelect:e=>{V(t=>t?{...t,revised_delivery_request_date:h(e,"yyyy-MM-dd")}:null)},placeholder:"ë³€ê²½ ìž…ê³ ì¼ì„ ì„ íƒí•˜ì„¸ìš”",align:"start",side:"bottom",children:a.jsxs(n,{variant:"outline",className:"mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] justify-start text-left font-normal business-radius-input",children:[a.jsx(S,{className:"mr-1 h-3 w-3"}),H?.revised_delivery_request_date?u(H.revised_delivery_request_date):"ë‚ ì§œ ì„ íƒ"]})}):a.jsx("p",{className:"modal-subtitle text-orange-700",children:A.revised_delivery_request_date?u(A.revised_delivery_request_date):"ë¯¸ì„¤ì •"})]})]})]})]}),a.jsxs("div",{className:"bg-white rounded-lg p-2 sm:p-3 border border-gray-100 shadow-sm",children:[a.jsxs("h3",{className:"modal-section-title mb-3 flex items-center",children:[a.jsx(d,{className:"w-4 h-4 mr-2 text-gray-600"}),"ì—…ì²´ ì •ë³´"]}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"ì—…ì²´ëª…"}),z?a.jsx(y,{value:H?.vendor?.vendor_name||H?.vendor_name||"",onChange:e=>V(t=>t?{...t,vendor_name:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"ì—…ì²´ ì„ íƒ"}):a.jsx("p",{className:"modal-value",children:A.vendor?.vendor_name||"-"})]}),a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"ì—…ì²´ ë‹´ë‹¹ìž"}),z?a.jsx(y,{value:H?.vendor_contacts?.[0]?.contact_name||"",onChange:e=>{V(t=>{if(!t)return null;const a=[...t.vendor_contacts||[]];return a[0]?a[0]={...a[0],contact_name:e.target.value}:a[0]={contact_name:e.target.value},{...t,vendor_contacts:a}})},className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"ë‹´ë‹¹ìž ì„ íƒ"}):a.jsx("p",{className:"modal-value",children:A.vendor_contacts?.[0]?.contact_name||"-"})]})]}),a.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"PJì—…ì²´"}),z?a.jsx(y,{value:H?.project_vendor||"",onChange:e=>V(t=>t?{...t,project_vendor:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"ìž…ë ¥"}):a.jsx("p",{className:"modal-value",children:A.project_vendor||"-"})]}),a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"Item"}),z?a.jsx(y,{value:H?.project_item||"",onChange:e=>V(t=>t?{...t,project_item:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"ìž…ë ¥"}):a.jsx("p",{className:"modal-subtitle",children:A.project_item||"-"})]})]}),a.jsx("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"ìˆ˜ì£¼ë²ˆí˜¸"}),z?a.jsx(y,{value:H?.order_number||"",onChange:e=>V(t=>t?{...t,order_number:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"ìž…ë ¥"}):a.jsx("p",{className:"modal-subtitle",children:A.order_number||"-"})]})})]})]})]}),a.jsx("div",{className:"lg:flex-1 lg:min-w-0 relative overflow-visible",children:a.jsxs("div",{className:"bg-white rounded-lg border border-gray-100 overflow-hidden shadow-sm",children:[a.jsxs("div",{className:"p-2 sm:p-3 bg-gray-50 border-b border-gray-100 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-0",children:[a.jsxs("h3",{className:"modal-section-title flex items-center",children:[a.jsx(D,{className:"w-4 h-4 mr-2 text-gray-600"}),"í’ˆëª© ë¦¬ìŠ¤íŠ¸",a.jsxs("span",{className:"ml-2 badge-stats bg-gray-500 text-white",children:[A.purchase_request_items?.length||0,"ê°œ"]})]}),!z&&a.jsxs(a.Fragment,{children:["purchase"===f&&ue&&a.jsxs(n,{size:"sm",onClick:async()=>{if(!A||!ue)return;const e=`ë°œì£¼ë²ˆí˜¸: ${A.purchase_order_number}\n\nëª¨ë“  í’ˆëª©ì„ êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;if(window.confirm(e))try{const e={is_payment_completed:!0,payment_completed_at:(new Date).toISOString()},{error:t}=await ne.from("purchase_request_items").update(e).eq("purchase_request_id",A.id).eq("is_payment_completed",!1);if(t)throw t;if(m(A.id)?s.debug("[PurchaseDetailModal] ë©”ëª¨ë¦¬ ìºì‹œ ì „ì²´ êµ¬ë§¤ì™„ë£Œ ì—…ë°ì´íŠ¸ ì™„ë£Œ",{purchaseId:A.id}):s.warn("[PurchaseDetailModal] ë©”ëª¨ë¦¬ ìºì‹œ ì „ì²´ êµ¬ë§¤ì™„ë£Œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{purchaseId:A.id}),B(e=>{if(!e)return null;const t=e.items?.map(e=>e.is_payment_completed?e:{...e,is_payment_completed:!0,payment_completed_at:(new Date).toISOString()});return{...e,items:t}}),A){const e=Number(A.id);Number.isNaN(e)||K?.(e,e=>{const t=(e.items||[]).map(e=>({...e,is_payment_completed:!0}));return{...e,items:t,is_payment_completed:!0,payment_completed_at:(new Date).toISOString(),payment_completed_by_name:ee||e.payment_completed_by_name}})}q.success("ëª¨ë“  í’ˆëª©ì´ êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."),await ge();const a=O?.(!0,{silent:!0});a instanceof Promise&&await a}catch(t){s.error("ì „ì²´ êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ ì˜¤ë¥˜",t),q.error("êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},className:"button-base bg-orange-500 hover:bg-orange-600 text-white",children:[a.jsx(I,{className:"w-3 h-3 mr-1"}),"ì „ì²´ êµ¬ë§¤ì™„ë£Œ"]}),"receipt"===f&&_e&&a.jsx(P,{onDateSelect:async e=>{if(!A||!_e)return;const t=`ë°œì£¼ë²ˆí˜¸: ${A.purchase_order_number}\n\nì „ì²´ ìž…ê³ ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;if(!window.confirm(t))return;const a=A?Number(A.id):NaN;try{const t={is_received:!0,received_at:(new Date).toISOString(),actual_received_date:e.toISOString()},{data:s,error:r}=await ne.from("purchase_request_items").update(t).eq("purchase_request_id",A.id).is("actual_received_date",null).select();if(r)throw r;B(t=>{if(!t)return null;const a=t.items?.map(t=>t.actual_received_date?t:{...t,is_received:!0,received_at:(new Date).toISOString(),actual_received_date:e.toISOString()});return{...t,items:a}}),Number.isNaN(a)||K?.(a,t=>{const a=(t.items||[]).map(t=>({...t,is_received:!0,actual_received_date:t.actual_received_date||e.toISOString()}));return{...t,items:a,is_received:!0,received_at:(new Date).toISOString()}}),q.success("ëª¨ë“  í’ˆëª©ì´ ìž…ê³ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."),await ge();const i=O?.(!0,{silent:!0});i instanceof Promise&&await i}catch(r){s.error("ì „ì²´ ìž…ê³ ì™„ë£Œ ì²˜ë¦¬ ì˜¤ë¥˜",r),q.error("ìž…ê³ ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},placeholder:"ì „ì²´ ìž…ê³ ì™„ë£Œ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”",align:"end",side:"bottom",children:a.jsxs(n,{size:"sm",className:"button-base button-action-primary",children:[a.jsx(M,{className:"w-3 h-3 mr-1"}),"ì „ì²´ ìž…ê³ ì™„ë£Œ"]})}),"done"===f&&xe&&a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(P,{onDateSelect:async e=>{if(!A||!xe)return;const t=e.toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"}),a=`ë°œì£¼ë²ˆí˜¸: ${A.purchase_order_number}\n\nëª¨ë“  í’ˆëª©ì˜ íšŒê³„ìƒ ìž…ê³ ì¼ì„ ${t}ë¡œ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;if(!window.confirm(a))return;const r=e.toISOString(),i=A?Number(A.id):NaN;try{const{error:e}=await ne.from("purchase_request_items").update({is_statement_received:!0,statement_received_date:r,statement_received_by_name:ee||null}).eq("purchase_request_id",A.id).eq("is_statement_received",!1);if(e)throw e;await ne.from("purchase_requests").update({is_statement_received:!0,statement_received_at:r}).eq("id",A.id),B(e=>{if(!e)return null;const t=e.items?.map(e=>e.is_statement_received?e:{...e,is_statement_received:!0,statement_received_date:r,statement_received_by_name:ee||null}),a=t&&t.length>0&&t.every(e=>e.is_statement_received);return{...e,items:t,is_statement_received:a,statement_received_at:a?r:e.statement_received_at}}),Number.isNaN(i)||K?.(i,e=>{const t=(e.items||[]).map(e=>({...e,is_statement_received:!0,statement_received_date:e.statement_received_date||r,statement_received_by_name:e.statement_received_by_name||ee||null}));return{...e,items:t,is_statement_received:!0,statement_received_at:r}}),q.success("ëª¨ë“  í’ˆëª©ì˜ íšŒê³„ìƒ ìž…ê³ ì¼ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤."),await ge();const t=O?.(!0,{silent:!0});t instanceof Promise&&await t}catch(n){s.error("ì „ì²´ ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸ ì²˜ë¦¬ ì˜¤ë¥˜",n),q.error("ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},placeholder:"ì „ì²´ íšŒê³„ìƒ ìž…ê³ ì¼ì„ ì„ íƒí•˜ì„¸ìš”",align:"end",side:"bottom",children:a.jsxs(n,{size:"sm",className:"button-base button-action-primary",children:[a.jsx(c,{className:"w-3 h-3 mr-1"}),"ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸"]})}),a.jsxs(n,{size:"sm",onClick:async()=>{if(!A||!xe)return;const e=`ë°œì£¼ë²ˆí˜¸: ${A.purchase_order_number}\n\nëª¨ë“  í’ˆëª©ì„ UTK í™•ì¸ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;if(window.confirm(e))try{const e=r(),{error:t}=await e.from("purchase_request_items").update({is_utk_checked:!0}).eq("purchase_request_id",A.id).eq("is_utk_checked",!1);if(t)throw t;if(await e.from("purchase_requests").update({is_utk_checked:!0}).eq("id",A.id),B(e=>{if(!e)return null;const t=e.items?.map(e=>e.is_utk_checked?e:{...e,is_utk_checked:!0});return{...e,items:t,is_utk_checked:!0}}),A){const e=Number(A.id);Number.isNaN(e)||K?.(e,e=>{const t=(e.items||[]).map(e=>({...e,is_utk_checked:!0}));return{...e,items:t,is_utk_checked:!0}})}q.success("ëª¨ë“  í’ˆëª©ì˜ UTK í™•ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."),await ge();const a=O?.(!0,{silent:!0});a instanceof Promise&&await a}catch(t){s.error("ì „ì²´ UTK í™•ì¸ ì²˜ë¦¬ ì˜¤ë¥˜",t),q.error("UTK í™•ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},className:"button-base bg-orange-500 hover:bg-orange-600 text-white",children:[a.jsx(x,{className:"w-3 h-3 mr-1"}),"UTK í™•ì¸"]})]})]})]}),a.jsx("div",{className:"block sm:hidden bg-gray-50 px-2 py-1 border-b border-gray-100",children:a.jsx("div",{className:"text-xs font-medium text-gray-600",children:"í’ˆëª© ëª©ë¡ (í„°ì¹˜í•˜ì—¬ ìŠ¤í¬ë¡¤)"})}),a.jsx("div",{className:"max-h-[50vh] sm:max-h-[40vh] w-full min-w-0 overflow-auto",children:a.jsxs("div",{style:{minWidth:`${re}px`},children:[a.jsx("div",{className:"bg-gray-50 px-2 sm:px-3 py-1 border-b border-gray-100 sticky top-0 z-10",children:a.jsxs("div",{ref:ie,className:"hidden sm:grid gap-3 modal-label",style:{gridTemplateColumns:$e()},children:[a.jsx("div",{children:"í’ˆëª©ëª…"}),a.jsx("div",{children:"ê·œê²©"}),a.jsx("div",{className:"text-center",children:"ìˆ˜ëŸ‰"}),a.jsx("div",{className:"text-right",children:"ë‹¨ê°€"}),a.jsx("div",{className:"text-right",children:"í•©ê³„"}),a.jsx("div",{className:"text-center",children:"ë¹„ê³ "}),z?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"text-center",children:"ì‚­ì œ"}),"receipt"===f&&a.jsx(a.Fragment,{children:a.jsx("div",{className:"text-center",children:"ì‹¤ì œìž…ê³ ì¼"})}),"done"===f&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"text-center",children:"ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸"}),a.jsx("div",{className:"text-center",children:"íšŒê³„ìƒ ìž…ê³ ì¼"}),a.jsx("div",{className:"text-center",children:"ì²˜ë¦¬ìž"}),a.jsx("div",{className:"text-center",children:"UTK"})]})]}):a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"text-center",children:"purchase"===f?"êµ¬ë§¤ìƒíƒœ":"receipt"===f||"done"===f?"ìž…ê³ ìƒíƒœ":"ìƒíƒœ"}),"done"===f&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"text-center",children:"ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸"}),a.jsx("div",{className:"text-center",children:"íšŒê³„ìƒ ìž…ê³ ì¼"}),a.jsx("div",{className:"text-center",children:"ì²˜ë¦¬ìž"}),a.jsx("div",{className:"text-center",children:"UTK"})]}),"receipt"===f&&a.jsx(a.Fragment,{children:a.jsx("div",{className:"text-center",children:"ì‹¤ì œìž…ê³ ì¼"})})]})]})}),a.jsx("div",{className:"divide-y divide-gray-100",children:(z?J:A.purchase_request_items)?.map((e,t)=>a.jsxs("div",{className:"px-2 sm:px-3 py-1.5 border-b border-gray-50 hover:bg-gray-50/50",children:[a.jsxs("div",{className:"hidden sm:grid items-center gap-3",style:{gridTemplateColumns:$e()},children:[a.jsx("div",{className:"min-w-0",children:z?a.jsx(y,{value:e.item_name,onChange:e=>Pe(t,"item_name",e.target.value),className:"modal-label border-gray-200 rounded-lg w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"í’ˆëª©ëª…",disabled:de&&!ce}):a.jsx("span",{className:"modal-value",children:e.item_name||"í’ˆëª©ëª… ì—†ìŒ"})}),a.jsx("div",{className:"min-w-0",children:z?a.jsx(y,{value:e.specification,onChange:e=>Pe(t,"specification",e.target.value),className:"modal-label border-gray-200 rounded-lg w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"ê·œê²©",disabled:de&&!ce}):a.jsx("span",{className:"modal-subtitle",children:e.specification||"-"})}),a.jsx("div",{className:"text-center min-w-0",children:z?a.jsx(y,{type:"number",value:e.quantity,onChange:e=>Pe(t,"quantity",Number(e.target.value)),className:"modal-label border-gray-200 rounded-lg text-center w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"ìˆ˜ëŸ‰",max:"99999"}):a.jsx("span",{className:"modal-subtitle",children:e.quantity||0})}),a.jsx("div",{className:"text-right min-w-0",children:z?a.jsx(y,{type:"number",value:e.unit_price_value,onChange:e=>Pe(t,"unit_price_value",Number(e.target.value)),className:"modal-label border-gray-200 rounded-lg text-right w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"ë‹¨ê°€",max:"100000000000"}):a.jsxs("span",{className:"modal-subtitle",children:["â‚©",Me(e.unit_price_value)]})}),a.jsx("div",{className:"text-right min-w-0",children:z?a.jsx(y,{type:"number",value:e.amount_value,onChange:e=>Pe(t,"amount_value",Number(e.target.value)),className:"modal-label border-gray-200 rounded-lg text-right w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"í•©ê³„",max:"10000000000",disabled:de&&!ce}):a.jsxs("span",{className:"modal-value",children:["â‚©",Me(e.amount_value||0)]})}),a.jsx("div",{className:"min-w-0 flex justify-center items-start pt-1 text-center",children:z?a.jsx(y,{value:e.remark||"",disabled:de&&!ce,onChange:e=>Pe(t,"remark",e.target.value),className:"modal-label border-gray-200 rounded-lg text-center w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"ë¹„ê³ "}):a.jsx("span",{className:"modal-subtitle text-center",children:e.remark||"-"})}),"pending"!==f&&a.jsx("div",{className:"text-center flex justify-center items-start pt-1",children:z?a.jsx(n,{size:"sm",variant:"ghost",onClick:()=>Ue(t),className:"text-red-600 hover:bg-red-50 rounded-lg p-1 h-6 w-6",children:a.jsx($,{className:"w-3 h-3"})}):a.jsxs(a.Fragment,{children:["purchase"===f&&a.jsx("div",{className:"flex justify-center",children:ue?a.jsx("button",{onClick:()=>Oe(e.id,!e.is_payment_completed),className:""+(e.is_payment_completed?"button-toggle-active bg-orange-500 hover:bg-orange-600 text-white":"button-toggle-inactive"),children:e.is_payment_completed?"êµ¬ë§¤ì™„ë£Œ":"êµ¬ë§¤ëŒ€ê¸°"}):a.jsx("span",{className:""+(e.is_payment_completed?"button-toggle-active bg-orange-500 text-white":"button-waiting-inactive"),children:e.is_payment_completed?"êµ¬ë§¤ì™„ë£Œ":"êµ¬ë§¤ëŒ€ê¸°"})}),"receipt"===f&&a.jsx("div",{className:"flex justify-center",children:xe?we.isCompleted(e)?a.jsx("button",{onClick:()=>{we.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-action-primary",children:we.config.completedText}):a.jsx(P,{onDateSelect:t=>{we.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"ì‹¤ì œ ìž…ê³ ëœ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”",align:"center",side:"bottom",children:a.jsx("button",{className:"button-toggle-inactive",children:we.config.waitingText})}):a.jsx("span",{className:""+(we.isCompleted(e)?"button-action-primary":"button-waiting-inactive"),children:we.isCompleted(e)?we.config.completedText:we.config.waitingText})}),"done"===f&&a.jsx("div",{className:"flex justify-center",children:a.jsx("span",{className:"button-base "+(we.isCompleted(e)?"bg-green-500 hover:bg-green-600 text-white":"border border-gray-300 text-gray-600 bg-white hover:bg-gray-50"),children:we.isCompleted(e)?"ìž…ê³ ì™„ë£Œ":"ìž…ê³ ëŒ€ê¸°"})}),"purchase"!==f&&"receipt"!==f&&"done"!==f&&a.jsx("div",{className:"flex justify-center",children:a.jsx("span",{className:"badge-text",children:"-"})})]})}),"receipt"===f&&a.jsx("div",{className:"text-center flex justify-center items-start pt-1 pl-2",children:we.getCompletedDate(e)?a.jsx("div",{className:"modal-subtitle text-green-700",children:new Date(we.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})}):a.jsx("span",{className:"modal-subtitle text-gray-400",children:"-"})}),"done"===f&&a.jsx("div",{className:"text-center flex justify-center items-start pt-1",children:xe?Ne.isCompleted(e)?a.jsx("button",{onClick:()=>{Ne.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-action-primary hover:bg-green-600",title:"í´ë¦­í•˜ì—¬ ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸ ì·¨ì†Œ",children:Ne.config.completedText}):a.jsx(P,{onDateSelect:t=>{Ne.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"íšŒê³„ìƒ ìž…ê³ ì¼ì„ ì„ íƒí•˜ì„¸ìš”",align:"center",side:"bottom",children:a.jsx("button",{className:"button-toggle-inactive",onClick:()=>{},children:Ne.config.waitingText})}):a.jsx("span",{className:""+(Ne.isCompleted(e)?"button-action-primary":"button-waiting-inactive"),children:Ne.isCompleted(e)?Ne.config.completedText:Ne.config.waitingText})}),"done"===f&&a.jsx("div",{className:"text-center flex justify-center items-start pt-1",children:Ne.getCompletedDate(e)?a.jsx("div",{className:"modal-subtitle text-blue-700",children:new Date(Ne.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})}):a.jsx("span",{className:"modal-subtitle text-gray-400",children:"-"})}),"done"===f&&a.jsx("div",{className:"text-center flex justify-center items-start pt-1",children:Ne.getCompletedByName(e)?a.jsx("span",{className:"modal-subtitle text-gray-600",children:Ne.getCompletedByName(e)}):a.jsx("span",{className:"modal-subtitle text-gray-400",children:"-"})}),"done"===f&&a.jsx("div",{className:"text-center flex justify-center items-start pt-1",children:xe?a.jsx("button",{onClick:()=>(async(e,t)=>{if(!xe)return void q.error("UTK í™•ì¸ ì²˜ë¦¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");const a=String(e),i="number"==typeof e?e:Number(e);if(Number.isNaN(i))return void q.error("ìœ íš¨í•˜ì§€ ì•Šì€ í•­ëª© ID ìž…ë‹ˆë‹¤.");const n=A?.items?.find(e=>String(e.id)===a);if(!n)return;const l=`í’ˆëª…: ${n.item_name}\nê·œê²©: ${n.specification||"ë¯¸ìž…ë ¥"}\nìˆ˜ëŸ‰: ${n.quantity?.toLocaleString()||0}${n.unit||""}\në‹¨ê°€: â‚©${n.unit_price_value?.toLocaleString()||0}\ní•©ê³„: â‚©${n.amount_value?.toLocaleString()||0}`,c=t?`ë‹¤ìŒ í’ˆëª©ì„ UTK í™•ì¸ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${l}`:`ë‹¤ìŒ í’ˆëª©ì˜ UTK í™•ì¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${l}`;if(window.confirm(c))try{const e=r();s.debug("UTK í™•ì¸ ì²˜ë¦¬ ì‹œìž‘",{itemId:i,isChecked:t,itemIdStr:a});const{data:n,error:l}=await e.from("purchase_request_items").update({is_utk_checked:t}).eq("id",i).select();if(l)throw s.error("UTK í™•ì¸ DB ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{error:l,itemId:i,isChecked:t}),l;if(s.debug("UTK í™•ì¸ DB ì—…ë°ì´íŠ¸ ì„±ê³µ",{data:n}),B(e=>{if(!e)return null;const s=e.items?.map(e=>String(e.id)===a?{...e,is_utk_checked:t}:e);return{...e,items:s}}),A){const e=Number(A.id);Number.isNaN(e)||K?.(e,e=>{const s=(e.items||[]).map(e=>String(e.id)===a?{...e,is_utk_checked:t}:e),r=s.length||e.items?.length||0,i=s.filter(e=>e.is_utk_checked).length,n=r>0&&i===r;return{...e,items:s,is_utk_checked:n}})}const c=A?.items?.every(e=>String(e.id)===a?t:!0===e.is_utk_checked);if(void 0!==c&&A){s.debug("purchase_requests ì—…ë°ì´íŠ¸ ì‹œìž‘",{purchaseId:A.id,allChecked:c});const{error:t}=await e.from("purchase_requests").update({is_utk_checked:c}).eq("id",A.id).select();t?s.error("purchase_requests ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{error:t,purchaseId:A.id,allChecked:c}):s.debug("purchase_requests ì—…ë°ì´íŠ¸ ì„±ê³µ",{purchaseId:A.id,allChecked:c})}q.success(t?"UTK í™•ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.":"UTK í™•ì¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."),await ge();const d=O?.(!0,{silent:!0});d instanceof Promise&&await d}catch(d){s.error("UTK í™•ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜",d),q.error("UTK í™•ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}})(e.id,!e.is_utk_checked),className:"button-base "+(e.is_utk_checked?"button-toggle-active bg-orange-500 hover:bg-orange-600 text-white":"button-toggle-inactive"),title:e.is_utk_checked?"UTK í™•ì¸ ì·¨ì†Œ":"UTK í™•ì¸ ì²˜ë¦¬",children:e.is_utk_checked?"ì™„ë£Œ":"ëŒ€ê¸°"}):a.jsx("span",{className:""+(e.is_utk_checked?"button-toggle-active bg-orange-500 text-white":"button-waiting-inactive"),children:e.is_utk_checked?"ì™„ë£Œ":"ëŒ€ê¸°"})})]}),a.jsxs("div",{className:"block sm:hidden space-y-2",children:[a.jsxs("div",{className:"flex justify-between items-start",children:[a.jsxs("div",{className:"flex-1 min-w-0",children:[z?a.jsx(y,{value:e.item_name,onChange:e=>Pe(t,"item_name",e.target.value),className:"modal-label border-gray-200 rounded-lg w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"í’ˆëª©ëª…",disabled:de&&!ce}):a.jsx("div",{className:"modal-value font-medium",children:e.item_name||"í’ˆëª©ëª… ì—†ìŒ"}),z?a.jsx(y,{value:e.specification,onChange:e=>Pe(t,"specification",e.target.value),className:"modal-label border-gray-200 rounded-lg mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"ê·œê²©",disabled:de&&!ce}):a.jsx("div",{className:"modal-subtitle text-gray-500",children:e.specification||"-"})]}),a.jsx("div",{className:"ml-3 text-right flex-shrink-0",children:z?a.jsx(y,{type:"number",value:e.amount_value,onChange:e=>Pe(t,"amount_value",Number(e.target.value)),className:"modal-label border-gray-200 rounded-lg text-right w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"í•©ê³„",disabled:de&&!ce}):a.jsxs("div",{className:"modal-value font-semibold",children:["â‚©",Me(e.amount_value||0)]})})]}),a.jsxs("div",{className:"grid grid-cols-3 gap-2 text-sm",children:[a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"ìˆ˜ëŸ‰:"}),z?a.jsx(y,{type:"number",value:e.quantity,onChange:e=>Pe(t,"quantity",Number(e.target.value)),className:"modal-label border-gray-200 rounded-lg mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"ìˆ˜ëŸ‰"}):a.jsx("div",{className:"modal-subtitle",children:e.quantity||0})]}),a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"ë‹¨ê°€:"}),z?a.jsx(y,{type:"number",value:e.unit_price_value,onChange:e=>Pe(t,"unit_price_value",Number(e.target.value)),className:"modal-label border-gray-200 rounded-lg mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"ë‹¨ê°€"}):a.jsxs("div",{className:"modal-subtitle",children:["â‚©",Me(e.unit_price_value)]})]}),a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"ìƒíƒœ:"}),a.jsx("div",{className:"mt-1",children:z?a.jsx(n,{size:"sm",variant:"ghost",onClick:()=>Ue(t),className:"text-red-600 hover:bg-red-50 rounded-lg p-1 h-6 w-6",children:a.jsx($,{className:"w-3 h-3"})}):a.jsxs(a.Fragment,{children:["purchase"===f&&a.jsx(a.Fragment,{children:ue?a.jsx("button",{onClick:()=>Oe(e.id,!e.is_payment_completed),className:"text-xs px-2 py-1 rounded "+(e.is_payment_completed?"bg-orange-500 text-white hover:bg-orange-600":"bg-gray-100 text-gray-600"),children:e.is_payment_completed?"êµ¬ë§¤ì™„ë£Œ":"êµ¬ë§¤ëŒ€ê¸°"}):a.jsx("span",{className:"text-xs px-2 py-1 rounded "+(e.is_payment_completed?"bg-orange-500 text-white":"bg-gray-100 text-gray-400"),children:e.is_payment_completed?"êµ¬ë§¤ì™„ë£Œ":"êµ¬ë§¤ëŒ€ê¸°"})}),"receipt"===f&&a.jsx(a.Fragment,{children:xe?we.isCompleted(e)?a.jsx("button",{onClick:()=>{we.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"text-xs px-2 py-1 rounded button-action-primary",children:we.config.completedText}):a.jsx(P,{onDateSelect:t=>{we.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"ì‹¤ì œ ìž…ê³ ëœ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”",align:"center",side:"bottom",children:a.jsx("button",{className:"text-xs px-2 py-1 rounded bg-gray-100 text-gray-600",children:we.config.waitingText})}):a.jsx("span",{className:"text-xs px-2 py-1 rounded "+(we.isCompleted(e)?"button-action-primary":"bg-gray-100 text-gray-400"),children:we.isCompleted(e)?we.config.completedText:we.config.waitingText})}),"done"===f&&a.jsx(a.Fragment,{children:a.jsx("span",{className:"button-base "+(we.isCompleted(e)?"bg-green-500 text-white":"border border-gray-300 text-gray-600 bg-white"),children:we.isCompleted(e)?"ìž…ê³ ì™„ë£Œ":"ìž…ê³ ëŒ€ê¸°"})}),"purchase"!==f&&"receipt"!==f&&"done"!==f&&a.jsx("span",{className:"text-xs text-gray-400",children:"-"})]})})]})]}),(e.remark||z)&&a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"ë¹„ê³ :"}),z?a.jsx(y,{value:e.remark||"",onChange:e=>Pe(t,"remark",e.target.value),className:"modal-label border-gray-200 rounded-lg mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"ë¹„ê³ "}):a.jsx("div",{className:"modal-subtitle text-gray-500 mt-1",children:e.remark||"-"})]}),!z&&"receipt"===f&&we.getCompletedDate(e)&&a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"ì‹¤ì œìž…ê³ ì¼:"}),a.jsxs("div",{className:"mt-1",children:[a.jsx("div",{className:"modal-subtitle text-green-700",children:new Date(we.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})}),a.jsx("div",{className:"text-[9px] text-gray-500",children:new Date(we.getCompletedDate(e)).toLocaleTimeString("ko-KR",{hour:"2-digit",minute:"2-digit"})})]})]}),!z&&"done"===f&&a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸:"}),a.jsx("div",{className:"flex items-center gap-2",children:xe?Ne.isCompleted(e)?a.jsx("button",{onClick:()=>{Ne.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"text-xs px-2 py-1 rounded button-action-primary hover:bg-green-600",title:"í´ë¦­í•˜ì—¬ ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸ ì·¨ì†Œ",children:Ne.config.completedText}):a.jsx(P,{onDateSelect:t=>{Ne.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"íšŒê³„ìƒ ìž…ê³ ì¼ì„ ì„ íƒí•˜ì„¸ìš”",align:"end",side:"bottom",children:a.jsx("button",{className:"text-xs px-2 py-1 rounded bg-gray-100 text-gray-600",onClick:()=>{},children:Ne.config.waitingText})}):a.jsx("span",{className:"text-xs px-2 py-1 rounded "+(Ne.isCompleted(e)?"button-action-primary":"bg-gray-100 text-gray-400"),children:Ne.isCompleted(e)?Ne.config.completedText:Ne.config.waitingText})})]}),!z&&"done"===f&&Ne.getCompletedDate(e)&&a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"íšŒê³„ìƒ ìž…ê³ ì¼:"}),a.jsx("div",{className:"mt-1",children:a.jsx("div",{className:"modal-subtitle text-blue-700",children:new Date(Ne.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})})})]}),!z&&"done"===f&&Ne.getCompletedByName(e)&&a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"ì²˜ë¦¬ìž:"}),a.jsx("div",{className:"mt-1",children:a.jsx("div",{className:"modal-subtitle text-gray-600",children:Ne.getCompletedByName(e)})})]})]})]},t))})]})}),a.jsxs("div",{className:"bg-gray-50 px-2 sm:px-3 border-t border-gray-100",children:[a.jsxs("div",{className:"hidden sm:grid items-center gap-3 py-0.5",style:{gridTemplateColumns:$e()},children:[a.jsx("div",{}),a.jsx("div",{}),a.jsx("div",{}),a.jsx("div",{className:"text-right",children:a.jsx("span",{className:"text-[12px] font-bold text-gray-900",children:"ì´ì•¡"})}),a.jsx("div",{className:"text-right",children:a.jsxs("span",{className:"text-[12px] font-bold text-gray-900",children:["â‚©",Me((z?J:A.purchase_request_items)?.reduce((e,t)=>e+(t.amount_value||0),0)||0)]})}),a.jsx("div",{}),a.jsx("div",{}),"receipt"===f&&a.jsx("div",{})]}),a.jsx("div",{className:"block sm:hidden py-0.5",children:a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsx("span",{className:"text-[13px] font-bold text-gray-900",children:"ì´ì•¡"}),a.jsxs("span",{className:"text-[13px] font-bold text-gray-900",children:["â‚©",Me((z?J:A.purchase_request_items)?.reduce((e,t)=>e+(t.amount_value||0),0)||0)]})]})})]}),z&&a.jsx("div",{className:"p-2 sm:p-3 border-t border-gray-100",children:a.jsxs(n,{size:"sm",variant:"outline",onClick:()=>{const e={item_name:"",specification:"",quantity:1,unit_price_value:0,amount_value:0,remark:"",line_number:J.reduce((e,t)=>{const a=t.line_number||0;return a>e?a:e},0)+1},t=[...J,e].sort((e,t)=>(e.line_number||999999)-(t.line_number||999999));G(t)},className:"w-full rounded-lg border-dashed border-2 border-gray-300 hover:border-gray-400 py-2 badge-text",children:[a.jsx(T,{className:"w-4 h-4 mr-1"}),"í•­ëª© ì¶”ê°€"]})})]})})]})]}):a.jsx("div",{className:"text-center py-12",children:a.jsx("span",{className:"modal-subtitle",children:"ë°œì£¼ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."})})});return v?Fe:a.jsx(j,{open:_,onOpenChange:p,children:a.jsxs(N,{className:"overflow-hidden bg-white rounded-lg shadow-sm border-0 w-full sm:w-auto max-w-[calc(100vw-48px)] sm:max-w-[calc(100vw-80px)] lg:max-w-[90vw] xl:max-w-[85vw] h-[95vh] sm:h-auto sm:max-h-[90vh] lg:max-h-[85vh] sm:rounded-lg flex flex-col",showCloseButton:!1,children:[a.jsx(w,{className:"sr-only",children:a.jsx(k,{children:"ë°œì£¼ ìƒì„¸ ì •ë³´"})}),a.jsxs("div",{className:"relative px-3 sm:px-6 pt-0 sm:pt-3 lg:pt-4 pb-0 sm:pb-2 lg:pb-3 flex-shrink-0",children:[a.jsx("button",{onClick:p,className:"button-base button-action-secondary absolute right-3 sm:right-6 top-0 sm:top-3 lg:top-4 w-6 h-6 sm:w-8 sm:h-8 rounded-full",children:a.jsx(l,{className:"w-4 h-4 text-gray-500"})}),a.jsx("div",{className:"pr-8 sm:pr-16",children:a.jsxs("div",{className:"flex items-start gap-4 mb-0 sm:mb-3",children:[a.jsx("div",{className:"min-w-0 flex-1",children:a.jsx("h1",{className:"page-title mb-0 sm:mb-1",children:"ë°œì£¼ ê¸°ë³¸ì •ë³´"})}),a.jsxs("div",{className:"flex items-center gap-3",children:[!z&&me&&a.jsxs(a.Fragment,{children:[a.jsxs(n,{size:"sm",variant:"outline",onClick:()=>Te(!0),className:"button-base button-action-secondary",children:[a.jsx(g,{className:"w-4 h-4 mr-2"}),"ìˆ˜ì •"]}),oe&&F&&a.jsxs(n,{size:"sm",variant:"outline",onClick:async()=>{if(A)try{s.debug("ë°œì£¼ ì‚­ì œ ì‹œìž‘",{purchaseOrderNumber:A.purchase_order_number}),await F(A),s.debug("ë°œì£¼ ì‚­ì œ ì™„ë£Œ - ëª¨ë‹¬ ë‹«ê¸° ë° ìƒˆë¡œê³ ì¹¨ ì§„í–‰"),p(),O&&(await O(!0),s.debug("ìƒìœ„ ì»´í¬ë„ŒíŠ¸ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ"))}catch(e){s.error("ë°œì£¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ",e),q.error("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},className:"button-base button-action-danger",children:[a.jsx($,{className:"w-4 h-4 mr-2"}),"ì‚­ì œ"]})]}),z&&a.jsxs(a.Fragment,{children:[a.jsxs(n,{size:"sm",variant:"outline",onClick:()=>{Te(!1),V(A),G(A?.items||[]),X([])},className:"button-base button-action-secondary",children:[a.jsx(l,{className:"w-4 h-4 mr-2"}),"ì·¨ì†Œ"]}),a.jsxs(n,{size:"sm",onClick:async()=>{if(A&&H)try{s.debug("ì €ìž¥ ì‹œìž‘",{purchaseId:A.id,editedItemsCount:J.length,deletedItemsCount:Q.length});const t=J.reduce((e,t)=>e+(t.amount_value||0),0);s.debug("ê³„ì‚°ëœ ì´ì•¡",{totalAmount:t});const{error:a}=await ne.from("purchase_requests").update({purchase_order_number:H.purchase_order_number||null,requester_name:H.requester_name||null,delivery_request_date:H.delivery_request_date||null,revised_delivery_request_date:H.revised_delivery_request_date||null,payment_category:H.payment_category||null,project_vendor:H.project_vendor||null,total_amount:Number(t),updated_at:(new Date).toISOString()}).eq("id",A.id);if(a)throw a;if(Q.length>0){const{error:e}=await ne.from("purchase_request_items").delete().in("id",Q);if(e)throw e}s.debug("ì €ìž¥í•  editedItems",{count:J.length});for(const e of J){if(s.debug("ì²˜ë¦¬ ì¤‘ì¸ item",{itemId:e.id,itemName:e.item_name,quantity:e.quantity,unitPrice:e.unit_price_value,amount:e.amount_value}),!e.item_name||!e.item_name.trim())throw new Error("í’ˆëª©ëª…ì€ í•„ìˆ˜ìž…ë‹ˆë‹¤.");if(!e.quantity||e.quantity<=0)throw new Error("ìˆ˜ëŸ‰ì€ 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.");if(null!==e.unit_price_value&&void 0!==e.unit_price_value&&e.unit_price_value<0)throw new Error("ë‹¨ê°€ëŠ” 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");if(null!==e.amount_value&&void 0!==e.amount_value&&e.amount_value<0)throw new Error("í•©ê³„ëŠ” 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");if(e.id){s.debug("ê¸°ì¡´ í•­ëª© ì—…ë°ì´íŠ¸",{itemId:e.id});const{error:t}=await ne.from("purchase_request_items").update({item_name:e.item_name.trim(),specification:e.specification||null,quantity:Number(e.quantity),unit_price_value:Number(e.unit_price_value),unit_price_currency:A.currency||"KRW",amount_value:Number(e.amount_value),amount_currency:A.currency||"KRW",remark:e.remark||null,updated_at:(new Date).toISOString()}).eq("id",e.id);if(t)throw s.error("ê¸°ì¡´ í•­ëª© ì—…ë°ì´íŠ¸ ì˜¤ë¥˜",t),t}else{s.debug("ìƒˆ í•­ëª© ìƒì„±",{itemName:e.item_name});const t={purchase_request_id:A.id,item_name:e.item_name.trim(),specification:e.specification||null,quantity:Number(e.quantity),unit_price_value:Number(e.unit_price_value),unit_price_currency:A.currency||"KRW",amount_value:Number(e.amount_value),amount_currency:A.currency||"KRW",remark:e.remark||null,line_number:e.line_number||J.indexOf(e)+1,created_at:(new Date).toISOString()};s.debug("ì‚½ìž…í•  ë°ì´í„°",{itemName:t.item_name});const{error:a}=await ne.from("purchase_request_items").insert(t);if(a)throw s.error("ìƒˆ í•­ëª© ìƒì„± ì˜¤ë¥˜",a),a;s.debug("ìƒˆ í•­ëª© ìƒì„± ì„±ê³µ")}}s.debug("ì €ìž¥ ì™„ë£Œ"),q.success("ë°œì£¼ ë‚´ì—­ì´ ì„±ê³µì ìœ¼ë¡œ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤."),Te(!1),X([]),await We(e?.toString()||"");const r=O?.(!0,{silent:!0});r instanceof Promise&&await r}catch(t){s.error("ì €ìž¥ ì¤‘ ì „ì²´ ì˜¤ë¥˜",t);const e=t instanceof Error?t.message:"ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤";q.error(`ì €ìž¥ ì‹¤íŒ¨: ${e}`)}else q.error("ì €ìž¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")},className:"button-base button-action-primary",children:[a.jsx(W,{className:"w-4 h-4 mr-2"}),"ì €ìž¥"]})]})]})]})})]}),a.jsx("div",{className:"overflow-y-auto flex-1 px-3 sm:px-6 pb-1 sm:pb-6 mt-0",children:Fe})]})})});export{P as D,O as P,M as T,U as u};
//# sourceMappingURL=PurchaseDetailModal-D_BAwOk2.js.map
