const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/FastPurchaseTable-CVBnasXs.js","assets/index-8K3knVZt.js","assets/index-7mea-Gv7.css","assets/index-Dq1t0Zt3.js","assets/PurchaseDetailModal-DyTPc5D-.js","assets/helpers-Buk9LCEc.js","assets/useConfirmDateAction-1NFMsWl7.js","assets/calendar-Cr2xbGyP.js","assets/chevron-right-CjNC4WBO.js","assets/chevron-down-DeRtiQCx.js","assets/popover-D9k1-8xC.js","assets/input-B83UN9Nh.js","assets/dialog-C4N171Jt.js","assets/calendar-Bj_7hBiu.js","assets/package-NxmLIEhr.js","assets/credit-card-DdUmOs9z.js","assets/trash-2-DCPSK1zj.js","assets/plus-B8RhjAew.js","assets/save-C14msmWh.js","assets/eye-DcMRRmiH.js","assets/PurchaseItemsModal-DVIivWcJ.js","assets/table-CbGNMq-p.js"])))=>i.map(i=>d[i]);
import{c as e,r as a,a as t,l as s,j as r,_ as n,B as l,X as c,U as i,u as o,e as u}from"./index-8K3knVZt.js";import{t as d,B as m}from"./index-Dq1t0Zt3.js";import{I as p}from"./input-B83UN9Nh.js";import{P as _,a as h,b as y}from"./popover-D9k1-8xC.js";import{S as b,a as v,b as g,c as f,d as x}from"./select-BFFG4y7B.js";import{F as j}from"./funnel-Bvh0aNyI.js";import{C as w}from"./calendar-Bj_7hBiu.js";import{P as N}from"./package-NxmLIEhr.js";import{C as k}from"./circle-check-big-BKBRnSsz.js";import{A as C}from"./arrow-up-down-6WZNEcWK.js";import{S as q,C as S,c as T}from"./card-J6May_Ry.js";import{P as D}from"./plus-B8RhjAew.js";import"./chevron-down-DeRtiQCx.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const P=e("building",[["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M9 22v-3a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v3",key:"cabbwy"}],["rect",{x:"4",y:"2",width:"16",height:"20",rx:"2",key:"1uxh74"}]]),E=e("dollar-sign",[["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}],["path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6",key:"1b0p4s"}]]),I={purchases:null,lastFetch:0,userInfo:null,CACHE_DURATION:3e5,filteredData:new Map,FILTER_CACHE_DURATION:3e4},M=e=>{I.filteredData.clear()},O=["정희웅"],R=a.lazy(()=>n(()=>import("./FastPurchaseTable-CVBnasXs.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19]))),U=a.memo(()=>r.jsx("div",{className:"p-4 space-y-4",children:[...Array(5)].map((e,a)=>r.jsxs("div",{className:"flex space-x-4 animate-pulse",children:[r.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4"}),r.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4"}),r.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4"}),r.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4"})]},a))}));U.displayName="TableSkeleton";const z=a.memo(({purchases:e,activeTab:t,currentUserRoles:s,onRefresh:n,onOptimisticUpdate:l,onPaymentComplete:c,onReceiptComplete:i})=>r.jsx(a.Suspense,{fallback:r.jsx(U,{}),children:r.jsx(R,{purchases:e,activeTab:t,currentUserRoles:s,onRefresh:n,onOptimisticUpdate:l,onPaymentComplete:c,onReceiptComplete:i})}));z.displayName="LazyPurchaseTable";const A=[{key:"date_range",label:"기간별",type:"date_range",icon:w,category:"날짜"},{key:"date_month",label:"월별",type:"date_month",icon:w,category:"날짜"},{key:"requester_name",label:"요청자",type:"searchable_select",icon:i,category:"사용자"},{key:"vendor_name",label:"업체",type:"searchable_select",icon:P,category:"사용자"},{key:"contact_name",label:"담당자",type:"searchable_select",icon:i,category:"사용자"},{key:"purchase_order_number",label:"발주번호",type:"text",icon:N,category:"텍스트"},{key:"item_name",label:"품명",type:"text",icon:N,category:"텍스트"},{key:"specification",label:"규격",type:"text",icon:N,category:"텍스트"},{key:"remark",label:"비고",type:"text",icon:N,category:"텍스트"},{key:"project_vendor",label:"PJ업체",type:"text",icon:P,category:"텍스트"},{key:"project_item",label:"PJ ITEM",type:"text",icon:N,category:"텍스트"},{key:"sales_order_number",label:"수주번호",type:"text",icon:N,category:"텍스트"},{key:"quantity",label:"수량",type:"number",icon:E,category:"숫자"},{key:"unit_price_value",label:"단가",type:"number",icon:E,category:"숫자"},{key:"total_amount",label:"합계",type:"number",icon:E,category:"숫자"},{key:"payment_category",label:"결제종류",type:"select",icon:k,category:"상태",options:["현장결제","구매요청","발주요청"]},{key:"payment_schedule",label:"지출예정일",type:"select_with_empty",icon:w,category:"상태"},{key:"is_payment_completed",label:"구매현황",type:"select",icon:k,category:"상태",options:["대기","완료"]},{key:"is_received",label:"입고현황",type:"select",icon:k,category:"상태",options:["대기","완료"]},{key:"is_statement_received",label:"거래명세서 확인",type:"select",icon:k,category:"상태",options:["대기","완료"]}],F=[{value:"contains",label:"포함"},{value:"equals",label:"같음"},{value:"starts_with",label:"시작함"},{value:"ends_with",label:"끝남"},{value:"is_empty",label:"비어있음"},{value:"is_not_empty",label:"비어있지 않음"}],L=[{value:"equals",label:"같음"},{value:"greater_than",label:"이상"},{value:"less_than",label:"이하"},{value:"between",label:"범위"},{value:"is_empty",label:"비어있음"},{value:"is_not_empty",label:"비어있지 않음"}],B=[{value:"equals",label:"같음"},{value:"after",label:"이후"},{value:"before",label:"이전"},{value:"between",label:"범위"},{value:"is_empty",label:"비어있음"},{value:"is_not_empty",label:"비어있지 않음"}],V=[{value:"equals",label:"같음"},{value:"not_equals",label:"아님"}],H=[{value:"request_date",label:"요청일"},{value:"purchase_order_number",label:"발주번호"},{value:"vendor_name",label:"업체명"},{value:"requester_name",label:"요청자"},{value:"total_amount",label:"합계"},{value:"delivery_request_date",label:"입고요청일"},{value:"created_at",label:"생성일"}];function W({activeFilters:e,sortConfig:t,searchTerm:s,onFiltersChange:n,onSortChange:i,onSearchChange:o,availableEmployees:u=[],availableVendors:d=[],availableContacts:w=[],availablePaymentSchedules:N=[]}){const[k,S]=a.useState(!1),[T,D]=a.useState(!1),[P,E]=a.useState(!1),[I,M]=a.useState({}),O=a.useRef(null);a.useEffect(()=>{P&&O.current&&O.current.focus()},[P]);const R=a=>{n(e.filter(e=>e.id!==a))},U=(e,a)=>{const t=H.find(a=>a.value===e);t&&(i({field:e,direction:a,label:t.label}),D(!1))};return r.jsxs("div",{className:"w-full space-y-3",children:[r.jsx("div",{className:"flex items-center justify-between",children:r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsxs(_,{open:k,onOpenChange:S,children:[r.jsx(h,{asChild:!0,children:r.jsxs(l,{variant:"outline",size:"sm",className:"button-base border border-gray-300 bg-white text-gray-700 hover:bg-gray-50",children:[r.jsx(j,{className:"w-4 h-4 mr-1"}),"필터",e.length>0&&r.jsx(m,{variant:"secondary",className:"ml-1 badge-stats-primary",children:e.length})]})}),r.jsx(y,{className:"w-80 p-4",align:"start",children:r.jsxs("div",{className:"space-y-4",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("h4",{className:"modal-subtitle",children:"필터"}),e.length>0&&r.jsx(l,{variant:"ghost",size:"sm",onClick:()=>{n([]),S(!1)},className:"button-base text-red-600 hover:text-red-700 hover:bg-red-50",children:"모든 필터 지우기"})]}),e.length>0&&r.jsxs("div",{className:"space-y-2",children:[e.map(e=>r.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-50 business-radius",children:[r.jsxs("span",{className:"card-description",children:[e.label,": ",e.value]}),r.jsx(l,{variant:"ghost",size:"sm",onClick:()=>R(e.id),className:"button-base h-6 w-6 p-0 hover:bg-red-50",children:r.jsx(c,{className:"w-3 h-3"})})]},e.id)),r.jsx("div",{className:"border-t border-gray-200 my-2"})]}),r.jsxs("div",{className:"space-y-3",children:[r.jsxs(b,{onValueChange:e=>{const a=A.find(a=>a.key===e);a&&M({id:`${e}_${Date.now()}`,field:e,condition:"contains",value:"",label:a.label})},children:[r.jsx(v,{children:r.jsx(g,{placeholder:"+ 필터 추가"})}),r.jsx(f,{children:Object.entries(A.reduce((e,a)=>(e[a.category]||(e[a.category]=[]),e[a.category].push(a),e),{})).map(([e,a])=>r.jsxs("div",{children:[r.jsx("div",{className:"px-2 py-1 text-xs font-semibold text-gray-500 uppercase",children:e}),a.map(e=>r.jsx(x,{value:e.key,children:r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(e.icon,{className:"w-4 h-4"}),e.label]})},e.key))]},e))})]}),I.field&&r.jsxs("div",{className:"space-y-3 p-3 border business-radius bg-white",children:[r.jsx("div",{className:"flex items-center gap-2",children:r.jsxs("span",{className:"card-title",children:[I.label," 필터"]})}),r.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[r.jsxs(b,{value:I.condition||"",onValueChange:e=>M(a=>({...a,condition:e})),children:[r.jsx(v,{children:r.jsx(g,{placeholder:"조건"})}),r.jsx(f,{children:(e=>{switch(e){case"text":case"searchable_select":default:return F;case"number":return L;case"date_range":case"date_month":return B;case"select":case"select_with_empty":return V}})(A.find(e=>e.key===I.field)?.type||"text").map(e=>r.jsx(x,{value:e.value,children:e.label},e.value))})]}),r.jsx("div",{children:(()=>{const e=A.find(e=>e.key===I.field);if(!e)return null;switch(e.type){case"text":return r.jsx(p,{placeholder:"값 입력",value:I.value||"",onChange:e=>M(a=>({...a,value:e.target.value})),className:"w-full"});case"number":return r.jsx(p,{type:"number",placeholder:"숫자 입력",value:I.value||"",onChange:e=>M(a=>({...a,value:e.target.value})),className:"w-full"});case"searchable_select":let a=[];return"requester_name"===e.key?a=u:"vendor_name"===e.key?a=d:"contact_name"===e.key&&(a=w),r.jsxs(b,{value:I.value||"",onValueChange:e=>M(a=>({...a,value:e})),children:[r.jsx(v,{children:r.jsx(g,{placeholder:"선택하세요"})}),r.jsx(f,{children:a.map(e=>r.jsx(x,{value:e,children:e},e))})]});case"select":return r.jsxs(b,{value:I.value||"",onValueChange:e=>M(a=>({...a,value:e})),children:[r.jsx(v,{children:r.jsx(g,{placeholder:"선택하세요"})}),r.jsx(f,{children:e.options?.map(e=>r.jsx(x,{value:e,children:e},e))})]});case"select_with_empty":const t=["공란",...N];return r.jsxs(b,{value:I.value||"",onValueChange:e=>M(a=>({...a,value:e})),children:[r.jsx(v,{children:r.jsx(g,{placeholder:"선택하세요"})}),r.jsx(f,{children:t.map(e=>r.jsx(x,{value:e,children:e},e))})]});default:return null}})()})]}),r.jsxs("div",{className:"flex gap-2",children:[r.jsx(l,{size:"sm",onClick:()=>{if(I.field&&void 0!==I.condition&&""!==I.value){const a={id:I.id,field:I.field,condition:I.condition,value:I.value,label:I.label};n([...e,a]),M({}),S(!1)}},disabled:!I.field||!I.condition||""===I.value,className:"button-base bg-blue-500 text-white hover:bg-blue-600",children:"적용"}),r.jsx(l,{variant:"outline",size:"sm",onClick:()=>M({}),className:"button-base border border-gray-300 bg-white text-gray-700",children:"취소"})]})]})]})]})})]}),r.jsxs(_,{open:T,onOpenChange:D,children:[r.jsx(h,{asChild:!0,children:r.jsxs(l,{variant:"outline",size:"sm",className:"button-base border border-gray-300 bg-white text-gray-700 hover:bg-gray-50",children:[r.jsx(C,{className:"w-4 h-4 mr-1"}),"정렬",t&&r.jsxs("span",{className:"ml-1 card-description",children:["(","asc"===t.direction?"↑":"↓",")"]})]})}),r.jsx(y,{className:"w-64 p-4",align:"start",children:r.jsxs("div",{className:"space-y-4",children:[r.jsx("h4",{className:"modal-subtitle",children:"정렬"}),r.jsx("div",{className:"space-y-2",children:H.map(e=>r.jsxs("div",{className:"space-y-1",children:[r.jsxs(l,{variant:"ghost",size:"sm",onClick:()=>U(e.value,"asc"),className:"button-base w-full justify-start "+(t?.field===e.value&&"asc"===t?.direction?"bg-blue-50 text-blue-700":"text-gray-700 hover:bg-gray-50"),children:[e.label," (오름차순) ↑"]}),r.jsxs(l,{variant:"ghost",size:"sm",onClick:()=>U(e.value,"desc"),className:"button-base w-full justify-start "+(t?.field===e.value&&"desc"===t?.direction?"bg-blue-50 text-blue-700":"text-gray-700 hover:bg-gray-50"),children:[e.label," (내림차순) ↓"]})]},e.value))}),t&&r.jsx("div",{className:"border-t pt-2",children:r.jsx(l,{variant:"outline",size:"sm",onClick:()=>i(null),className:"button-base w-full border border-gray-300 text-gray-700",children:"정렬 해제"})})]})})]}),r.jsx("div",{className:"flex items-center gap-2",children:P?r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(p,{ref:O,placeholder:"전체 검색...",value:s,onChange:e=>o(e.target.value),className:"w-64"}),r.jsx(l,{variant:"ghost",size:"sm",onClick:()=>{E(!1),o("")},className:"button-base h-8 w-8 p-0",children:r.jsx(c,{className:"w-4 h-4"})})]}):r.jsxs(l,{variant:"outline",size:"sm",onClick:()=>E(!0),className:"button-base border border-gray-300 bg-white text-gray-700 hover:bg-gray-50",children:[r.jsx(q,{className:"w-4 h-4 mr-1"}),"검색"]})})]})}),e.length>0&&r.jsx("div",{className:"flex flex-wrap gap-2",children:e.map(e=>r.jsxs(m,{variant:"secondary",className:"badge-base flex items-center gap-1 bg-blue-50 text-blue-700 border-blue-200",children:[e.label,": ",e.value,r.jsx(l,{variant:"ghost",size:"sm",onClick:()=>R(e.id),className:"h-4 w-4 p-0 hover:bg-blue-100 ml-1",children:r.jsx(c,{className:"w-3 h-3"})})]},e.id))})]})}const J=a.lazy(()=>n(()=>import("./PurchaseItemsModal-DVIivWcJ.js"),__vite__mapDeps([20,1,2,12,11,21,3,6,7,8,9,10,17,18,16]))),$=[{key:"pending",label:"승인대기"},{key:"purchase",label:"구매 현황"},{key:"receipt",label:"입고 현황"},{key:"done",label:"전체 항목"}];function G({onEmailToggle:e,showEmailButton:n=!0}){const c=o(),i=u(),p=t(),[_,h]=a.useState(null),[y,b]=a.useState(!1),[v,g]=a.useState([]),[f,x]=a.useState(null),[j,w]=a.useState(""),[k,C]=a.useState([]),[q,P]=a.useState([]),[E,R]=a.useState([]),[U,A]=a.useState([]),{purchases:F,loading:L,currentUserRoles:B,currentUserName:V,refreshPurchases:H,updatePurchaseOptimistic:G}=(()=>{const[e,r]=a.useState([]),[n,l]=a.useState(!0),[c,i]=a.useState([]),[o,u]=a.useState(""),[m,p]=a.useState(""),[_,h]=a.useState(""),y=t(),b=a.useRef(!1);a.useEffect(()=>{(async()=>{if(b.current)return;b.current=!0;const e=Date.now(),a=I.lastFetch&&e-I.lastFetch<I.CACHE_DURATION;try{if(a&&I.userInfo)try{const e=I.userInfo;if(e){let a=[];e.purchase_role&&(a=Array.isArray(e.purchase_role)?e.purchase_role.map(e=>String(e).trim()):String(e.purchase_role).split(",").map(e=>e.trim()).filter(e=>e.length>0)),i(a),u(e.name||e.full_name||""),p(e.email||""),h(e.id||"")}return}catch(t){s.error("캐시 데이터 사용 중 오류",t),I.purchases=null,I.userInfo=null,I.lastFetch=0}const r=await y.auth.getUser();if(r.data.user&&!r.error){let a=null;if(r.data.user.email&&(a=(await y.from("employees").select("*").eq("email",r.data.user.email).maybeSingle()).data),a){I.userInfo=a;let e=[];a.purchase_role&&(e=Array.isArray(a.purchase_role)?a.purchase_role.map(e=>String(e).trim()):String(a.purchase_role).split(",").map(e=>e.trim()).filter(e=>e.length>0)),i(e),u(a.name||a.full_name||""),p(a.email||""),h(a.id||"")}I.lastFetch=e}}catch(t){s.error("초기 데이터 로드 실패",t)}})()},[]);const v=a.useCallback(async(e,a)=>{const t=!a?.silent;t&&l(!0);try{const a=Date.now(),c=I.lastFetch&&a-I.lastFetch<I.CACHE_DURATION;if(e&&(M(),I.purchases=null,I.lastFetch=0),!e&&c&&I.purchases)try{return r(I.purchases),void(t&&l(!1))}catch(n){s.error("발주 데이터 캐시 사용 중 오류",n),I.purchases=null,I.lastFetch=0,M()}const{data:{user:i},error:o}=await y.auth.getUser();if(o||!i)return s.error("사용자 인증 실패",o),d.error("로그인이 필요합니다."),void(t&&l(!1));const{data:u,error:m}=await y.from("purchase_requests").select("\n          *,\n          purchase_request_items(*)\n        ").order("request_date",{ascending:!1}).limit(1e3);if(m)throw m;let p=[],_=[];if(u&&u.length>0){const[e,a]=await Promise.all([y.from("employees").select("id, name, email"),y.from("vendors").select("id, vendor_name, vendor_payment_schedule")]);p=e.data||[],_=a.data||[]}const h=(new Date).toISOString().split("T")[0],b=((u||[]).filter(e=>e.request_date?.startsWith(h)),(u||[]).map(e=>{const a=e.purchase_request_items?.[0]||{},t=p.find(a=>a.id===e.requester_id),s=_.find(a=>a.id===e.vendor_id);return{id:Number(e.id),purchase_order_number:e.purchase_order_number,request_date:e.request_date,delivery_request_date:e.delivery_request_date??null,revised_delivery_request_date:e.revised_delivery_request_date??null,progress_type:e.progress_type,payment_completed_at:e.payment_completed_at,payment_completed_by_name:e.payment_completed_by_name,payment_category:e.payment_category,currency:e.currency,request_type:e.request_type,vendor:void 0,vendor_name:e.vendor_name||"",vendor_payment_schedule:s?.vendor_payment_schedule||"",vendor_contacts:[],requester_id:e.requester_id,requester_name:e.requester_name,requester_full_name:t?.name||e.requester_name||"",item_name:a.item_name||"",specification:a.specification||"",quantity:Number(a.quantity)||0,unit_price_value:Number(a.unit_price_value)||0,amount_value:Number(a.amount_value)||0,remark:a.remark||"",project_vendor:e.project_vendor,sales_order_number:e.sales_order_number,project_item:e.project_item,line_number:Number(a.line_number)||1,contact_name:"",middle_manager_status:e.middle_manager_status,final_manager_status:e.final_manager_status,is_received:!!e.is_received,received_at:e.received_at,is_payment_completed:!!e.is_payment_completed,is_po_download:!!e.is_po_download,link:a.link,items:(e.purchase_request_items||[]).sort((e,a)=>(e.line_number||0)-(a.line_number||0)),total_amount:e.purchase_request_items?.reduce((e,a)=>e+(Number(a.amount_value)||0),0)||0,purchase_status:e.purchase_status||"pending"}}));r(b),I.purchases=b,I.lastFetch=a}catch(c){s.error("발주 목록 로드 실패",c),d.error("발주 목록을 불러올 수 없습니다.")}finally{t&&l(!1)}},[y]),g=a.useCallback((e,a)=>{r(t=>{const s=t.map(t=>t.id===e?a(t):t);return I.purchases=s,s})},[]);return a.useEffect(()=>{v()},[v]),{purchases:e,loading:n,currentUserRoles:c,currentUserName:o,currentUserEmail:m,currentUserId:_,refreshPurchases:v,updatePurchaseOptimistic:g}})(),K=B?.includes("app_admin"),{activeTab:Q,setActiveTab:X,filteredPurchases:Y,tabCounts:Z}=((e,s,r)=>{t();const[n,l]=a.useState("pending"),[c,i]=a.useState(""),o=s?.includes("app_admin");s?.includes("final_approver"),s?.includes("middle_manager");const u=s?.includes("purchase_manager"),d=s?.includes("raw_material_manager")||s?.includes("consumable_manager")||s?.includes("purchase_manager"),m=s?.includes("hr"),p=a.useMemo(()=>s&&0!==s.length?u?2:s.some(e=>["middle_manager","final_approver","app_admin","ceo"].includes(e))?3:1:1,[s,u]),_=a.useCallback(e=>{if(!r)return"all";if("purchase"===e)return d||m||o?"all":r;if("receipt"===e)return d||m||o?"all":r;switch(p){case 1:case 2:return"done"===e?"all":r;case 3:return"all";default:return r}},[r,p,d,m,o]);a.useEffect(()=>{if(!r)return;const e=_(n);i(e)},[n,r,p,_]);const h=a.useMemo(()=>s.includes("purchase_manager")||s.includes("app_admin")?e:e.filter(e=>!O.includes(e.requester_name)),[e,s]),y=a.useMemo(()=>((new Date).toISOString().split("T")[0],h.filter(e=>{let a=!1;switch(n){case"pending":const t=["pending","대기","",null,void 0].includes(e.middle_manager_status),s=["pending","대기","",null,void 0].includes(e.final_manager_status),r="rejected"===e.middle_manager_status,n="rejected"===e.final_manager_status;if(r||n)return!1;const l="approved"===e.middle_manager_status,c="approved"===e.final_manager_status;return(!l||!c)&&(a=t||s,a);case"purchase":{const t="구매 요청"===e.payment_category,s=(e.progress_type||"").includes("선진행"),r=(e.progress_type||"").includes("일반"),n="approved"===e.final_manager_status;return!e.is_payment_completed&&(a=!!t&&(s||r&&n),a)}case"receipt":{const t=(e.progress_type||"").includes("선진행"),s="approved"===e.final_manager_status;return!e.is_received&&(a=t||s,a)}case"done":return a=!0,a;default:return!0}})),[h,n]),b=a.useMemo(()=>{let e;return e=c&&"all"!==c&&"전체"!==c?y.filter(e=>e.requester_name===c):y,e},[y,c]),v=a.useMemo(()=>[...b].sort((e,a)=>{const t=e.request_date?new Date(e.request_date).getTime():0;return(a.request_date?new Date(a.request_date).getTime():0)-t}),[b]),g=a.useMemo(()=>{const e=h,a=e=>new Set(e.map(e=>e.purchase_order_number)).size,t=a=>{if("purchase"===a)return d||m||o?e:e.filter(e=>e.requester_name===r);if("receipt"===a)return d||m||o?e:e.filter(e=>e.requester_name===r);const t=_(a);return"all"===t||"전체"===t?e:e.filter(e=>e.requester_name===t)},s=t("pending"),n=t("purchase"),l=t("receipt"),c=t("done"),i=s.filter(e=>{(new Date).toISOString().split("T")[0];const a=["pending","대기","",null,void 0].includes(e.middle_manager_status),t=["pending","대기","",null,void 0].includes(e.final_manager_status),s="rejected"===e.middle_manager_status,r="rejected"===e.final_manager_status;if(s||r)return!1;const n="approved"===e.middle_manager_status,l="approved"===e.final_manager_status;return(!n||!l)&&(a||t)}),u=n.filter(e=>{(new Date).toISOString().split("T")[0];const a="구매 요청"===e.payment_category,t=(e.progress_type||"").includes("선진행"),s=(e.progress_type||"").includes("일반"),r="approved"===e.final_manager_status;return!e.is_payment_completed&&!!a&&(t||s&&r)}),p=l.filter(e=>{(new Date).toISOString().split("T")[0];const a=(e.progress_type||"").includes("선진행"),t="approved"===e.final_manager_status;return!e.is_received&&(a||t)});return{pending:a(i),purchase:a(u),receipt:a(p),done:a(c)}},[h,p,r,_,d,m,o]);return{activeTab:n,selectedEmployee:c,setActiveTab:l,setSelectedEmployee:i,filteredPurchases:v,tabCounts:g}})(F,B,V);a.useEffect(()=>{"purchase"===new URLSearchParams(i.search).get("tab")&&X("purchase")},[i.search,X]),a.useEffect(()=>{(async()=>{try{const{data:e}=await p.from("employees").select("name").not("name","is",null);if(e){const a=[...new Set(e.map(e=>e.name).filter(Boolean))];C(a)}const{data:a}=await p.from("vendors").select("vendor_name").not("vendor_name","is",null);if(a){const e=[...new Set(a.map(e=>e.vendor_name).filter(Boolean))];P(e)}const{data:t}=await p.from("vendor_contacts").select("contact_name").not("contact_name","is",null);if(t){const e=[...new Set(t.map(e=>e.contact_name).filter(Boolean))];R(e)}const{data:s}=await p.from("vendors").select("payment_schedule").not("payment_schedule","is",null);if(s){const e=[...new Set(s.map(e=>e.payment_schedule).filter(Boolean))];A(e)}}catch(e){s.error("필터 옵션 데이터 로드 실패",e)}})()},[p]);const ee=a.useRef(!1);a.useEffect(()=>{if(!ee.current)return void(ee.current=!0);(async()=>{try{await H(!0,{silent:!0})}catch(e){}})()},[Q,H]),a.useCallback(e=>e.is_received?r.jsx(m,{variant:null,className:"badge-success",children:"입고완료"}):"approved"===e.middle_manager_status&&"approved"===e.final_manager_status?r.jsx(m,{variant:null,className:"badge-primary",children:"구매진행"}):"rejected"===e.middle_manager_status||"rejected"===e.final_manager_status?r.jsx(m,{variant:null,className:"badge-danger",children:"반려"}):r.jsx(m,{variant:null,className:"badge-warning",children:"승인대기"}),[]);const ae=a.useCallback(e=>{let a=[...e];if(j.trim()){const e=j.toLowerCase().trim();a=a.filter(a=>a.purchase_order_number?.toLowerCase().includes(e)||a.vendor_name?.toLowerCase().includes(e)||a.requester_name?.toLowerCase().includes(e)||a.item_name?.toLowerCase().includes(e)||a.specification?.toLowerCase().includes(e)||a.remark?.toLowerCase().includes(e)||a.project_vendor?.toLowerCase().includes(e)||a.project_item?.toLowerCase().includes(e)||a.sales_order_number?.toLowerCase().includes(e))}return v.forEach(e=>{a=a.filter(a=>{const t=te(a,e.field);return se(t,e.condition,e.value)})}),a},[j,v]),te=(e,a)=>{switch(a){case"purchase_order_number":return e.purchase_order_number;case"payment_category":return e.payment_category;case"requester_name":return e.requester_name;case"vendor_name":return e.vendor_name;case"contact_name":return e.contact_name;case"item_name":return e.item_name;case"specification":return e.specification;case"quantity":return e.quantity;case"unit_price_value":return e.unit_price_value;case"total_amount":return e.total_amount;case"remark":return e.remark;case"project_vendor":return e.project_vendor;case"project_item":return e.project_item;case"sales_order_number":return e.sales_order_number;case"payment_schedule":return e.payment_schedule;case"is_payment_completed":return e.is_payment_completed?"완료":"대기";case"is_received":return e.is_received?"완료":"대기";case"is_statement_received":return e.is_statement_received?"완료":"대기";case"request_date":return e.request_date;case"delivery_request_date":return e.delivery_request_date;case"payment_completed_at":return e.payment_completed_at;default:return null}},se=(e,a,t)=>{if(null==e)return"is_empty"===a;const s=String(e).toLowerCase(),r=String(t).toLowerCase();switch(a){case"contains":return s.includes(r);case"equals":return s===r;case"starts_with":return s.startsWith(r);case"ends_with":return s.endsWith(r);case"is_empty":return!e||""===s.trim();case"is_not_empty":return!!e&&""!==s.trim();case"greater_than":return Number(e)>Number(t);case"less_than":return Number(e)<Number(t);case"between":default:return!0;case"after":return new Date(e)>new Date(t);case"before":return new Date(e)<new Date(t);case"not_equals":return s!==r}},re=a.useCallback(e=>f?[...e].sort((e,a)=>{const t=te(e,f.field),s=te(a,f.field);if(null==t)return 1;if(null==s)return-1;let r=0;return r="number"==typeof t&&"number"==typeof s?t-s:t instanceof Date&&s instanceof Date?t.getTime()-s.getTime():String(t).localeCompare(String(s)),"desc"===f.direction?-r:r}):e,[f]),ne=a.useMemo(()=>{let e=ae(Y);return e=re(e),e},[Y,ae,re]),le=a.useCallback(async e=>{try{const a=(new Date).toISOString(),[t,s]=await Promise.all([p.from("purchase_requests").update({is_received:!0,received_at:a}).eq("id",e),p.from("purchase_request_items").update({is_received:!0,delivery_status:"received"}).eq("purchase_request_id",e)]);if(t.error)throw t.error;if(s.error)throw s.error;d.success("입고완료 처리되었습니다."),await H()}catch(a){d.error("처리 중 오류가 발생했습니다.")}},[p,H]),ce=a.useCallback(async e=>{try{const a=(new Date).toISOString(),[t,s]=await Promise.all([p.from("purchase_requests").update({is_payment_completed:!0,payment_completed_at:a}).eq("id",e),p.from("purchase_request_items").update({is_payment_completed:!0}).eq("purchase_request_id",e)]);if(t.error)throw t.error;if(s.error)throw s.error;d.success("구매완료 처리되었습니다."),await H()}catch(a){d.error("처리 중 오류가 발생했습니다.")}},[p,H]);a.useCallback(e=>{h(e),b(!0)},[]);const ie=a.useMemo(()=>_?{..._,vendor_name:_.vendor_name||"",project_vendor:_.project_vendor||"",sales_order_number:_.sales_order_number||"",project_item:_.project_item||""}:null,[_]);return r.jsxs("div",{className:"w-full",children:[r.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4",children:[r.jsxs("div",{children:[r.jsx("h1",{className:"page-title",children:"발주요청 관리"}),r.jsx("p",{className:"page-subtitle",style:{marginTop:"-2px",marginBottom:"-4px"},children:"Purchase Management"})]}),r.jsxs(l,{onClick:()=>c("/purchase/new"),className:"mt-4 sm:mt-0 bg-hansl-500 hover:bg-hansl-600",children:[r.jsx(D,{className:"w-4 h-4 mr-2"}),"새 발주요청 작성"]})]}),r.jsx(W,{activeFilters:v,sortConfig:f,searchTerm:j,onFiltersChange:g,onSortChange:x,onSearchChange:w,availableEmployees:k,availableVendors:q,availableContacts:E,availablePaymentSchedules:U}),r.jsxs("div",{className:"space-y-3",children:[r.jsx("div",{className:"flex flex-col sm:flex-row sm:space-x-1 space-y-1 sm:space-y-0 bg-gray-50 p-1 business-radius-card border border-gray-200",children:$.map(e=>r.jsxs("button",{onClick:()=>{X(e.key)},className:"flex-1 flex items-center justify-center space-x-2 py-1.5 px-3 sm:px-4 business-radius-button button-text font-medium transition-colors "+(Q===e.key?"text-hansl-600 bg-white shadow-sm border border-gray-200":"text-gray-600 bg-transparent hover:text-gray-900 hover:bg-white/50"),children:[r.jsx("span",{className:"whitespace-nowrap",children:e.label}),r.jsx(m,{variant:"secondary",className:Q===e.key?"badge-stats-active":"badge-stats-secondary",children:Z[e.key]})]},e.key))}),r.jsx(S,{className:"overflow-hidden border border-gray-200",children:r.jsx(T,{className:"p-0",children:L?r.jsxs("div",{className:"flex items-center justify-center py-12",children:[r.jsx("div",{className:"w-8 h-8 border-2 border-hansl-500 border-t-transparent rounded-full animate-spin"}),r.jsx("span",{className:"ml-3 card-subtitle",children:"로딩 중..."})]}):0===ne.length?r.jsxs("div",{className:"text-center py-12",children:[r.jsx(N,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),r.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"발주요청서가 없습니다"}),r.jsx("p",{className:"card-subtitle",children:"새로운 발주요청서를 작성해보세요."})]}):r.jsx(z,{purchases:ne,activeTab:Q,currentUserRoles:B,onRefresh:H,onOptimisticUpdate:G,onPaymentComplete:ce,onReceiptComplete:le})})})]}),ie&&r.jsx(a.Suspense,{fallback:r.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white"})}),children:r.jsx(J,{isOpen:y,onClose:()=>{b(!1),h(null)},purchase:ie,isAdmin:K||!1,onUpdate:H,activeTab:Q})})]})}export{G as default};
//# sourceMappingURL=PurchaseListMain-BebeV6gh.js.map
