const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/exceljs.min-7cFO-Ls5.js","assets/index-CNRi0fa-.js","assets/index-DY4pY5Tj.css"])))=>i.map(i=>d[i]);
import{c as e,_ as t,a,r,j as i,l as n,B as s,w as l,x as d,y as o,z as c,A as m,C as u,X as _,F as p,D as h,E as g,P as x,G as v,H as f,I as b,J as y}from"./index-CNRi0fa-.js";import{a as j,b as N}from"./helpers-CsHcdtkA.js";import{t as w}from"./index-BN3EsZpb.js";import{a as C,k as q,C as S,f as k,P as D}from"./calendar-BvSAsNlz.js";import{P as I,a as $,b as O}from"./popover-D7zMeslD.js";import{I as A}from"./index-CQIOmfy_.js";import{T as F}from"./textarea-DLIaDXoW.js";import{P as W,L as T}from"./label-CWTZ56uz.js";import{D as z,a as P,b as M,c as E}from"./dialog-B2qgcx9J.js";import{S as L}from"./react-select.esm-Dqxm6wBO.js";import{C as U}from"./calendar-CNEk-R3F.js";import{C as R}from"./check-BEYEu3Qd.js";import{C as B}from"./credit-card-DjWSCKaa.js";import{T as V}from"./trash-2-Dtehvroz.js";import{S as K}from"./save-BkmGCXDu.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const H=e("dollar-sign",[["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}],["path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6",key:"1b0p4s"}]]),G=e("message-square-plus",[["path",{d:"M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z",key:"18887p"}],["path",{d:"M12 8v6",key:"1ib9pf"}],["path",{d:"M9 11h6",key:"1fldmi"}]]),Q=e("truck",[["path",{d:"M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2",key:"wrbu53"}],["path",{d:"M15 18H9",key:"1lyqi6"}],["path",{d:"M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14",key:"lysw3i"}],["circle",{cx:"17",cy:"18",r:"2",key:"332jqn"}],["circle",{cx:"7",cy:"18",r:"2",key:"19iecd"}]]),J=j;function Y(e){return e?["KRW","ì›","â‚©"].includes(e)?"â‚©":["USD","$","ë‹¬ëŸ¬"].includes(e)?"$":["EUR","â‚¬"].includes(e)?"â‚¬":["JPY","ì—”","Â¥"].includes(e)||["CNY","ìœ„ì•ˆ","å…ƒ"].includes(e)?"Â¥":e:""}async function X(e){const a=new((await t(()=>import("./exceljs.min-7cFO-Ls5.js").then(e=>e.e),__vite__mapDeps([0,1,2]))).Workbook),r=a.addWorksheet("ë°œì£¼ì„œ",{pageSetup:{paperSize:9,orientation:"portrait",fitToPage:!0,fitToWidth:1,fitToHeight:1,horizontalCentered:!0,verticalCentered:!0,margins:{left:.3,right:.3,top:.5,bottom:.5,header:.2,footer:.2}}});r.getRow(1).height=29.8;for(let t=2;t<=60;t++)r.getRow(t).height=15.75;r.getRow(1).eachCell(e=>{e.font={...e.font||{},name:"ë§‘ì€ ê³ ë”•",size:20}});for(let t=2;t<=60;t++)r.getRow(t).eachCell(e=>{e.font={...e.font||{},name:"ë§‘ì€ ê³ ë”•",size:11}});r.mergeCells("A1:G1"),r.mergeCells("A2:B2"),r.mergeCells("C2:D2"),r.mergeCells("F2:G2"),r.mergeCells("A3:B3"),r.mergeCells("C3:D3"),r.mergeCells("F3:G3"),r.mergeCells("A4:B4"),r.mergeCells("C4:D4"),r.mergeCells("F4:G4"),r.mergeCells("A5:B5"),r.mergeCells("C5:D5"),r.mergeCells("F5:G5"),r.mergeCells("A6:B6"),r.mergeCells("C6:D6"),r.mergeCells("F6:G6"),r.mergeCells("A7:B7"),r.mergeCells("C7:D7"),r.mergeCells("F7:G7");try{const e=await fetch("/logo_KOR.png"),t=await e.arrayBuffer(),i=a.addImage({buffer:t,extension:"png"}),n=r.getColumn("D").width||22,s=Math.max(1,7.2*n*.58)+4,l=34,d=3,o=.3;r.addImage(i,{tl:{col:d,row:o},ext:{width:s,height:l}})}catch(_){}r.getCell("D1").value="                ë°œ ì£¼ ì„œ",r.getCell("D1").alignment={horizontal:"left",vertical:"middle",indent:1},r.getCell("D1").font={bold:!0,size:20},r.getCell("A2").value="ì—…   ì²´   ëª…",r.getCell("A2").font={bold:!0},r.getCell("A3").value="ë‹´   ë‹¹   ì",r.getCell("A3").font={bold:!0},r.getCell("A4").value="ì²­   êµ¬   ì¼",r.getCell("A4").font={bold:!0},r.getCell("A5").value="TEL.",r.getCell("A5").font={bold:!0},r.getCell("A6").value="FAX.",r.getCell("A6").font={bold:!0},r.getCell("A7").value="ì…ê³ ìš”ì²­ì¼",r.getCell("A7").font={bold:!0},r.getCell("E2").value="êµ¬ë§¤ìš”ì²­ì",r.getCell("E2").font={bold:!0},r.getCell("E3").value="ì£¼         ì†Œ",r.getCell("E3").font={bold:!0},r.getCell("E4").value="ë°œ ì£¼ ë²ˆ í˜¸",r.getCell("E4").font={bold:!0},r.getCell("E5").value="TEL.",r.getCell("E5").font={bold:!0},r.getCell("E6").value="FAX.",r.getCell("E6").font={bold:!0},r.getCell("E7").value="ì§€ì¶œ ì˜ˆì •ì¼",r.getCell("E7").font={bold:!0},r.getCell("F7").value=e.vendor_payment_schedule||"",r.getCell("C2").value=e.vendor_name,r.getCell("C3").value=e.vendor_contact_name||"",r.getCell("C4").value=J(e.request_date),r.getCell("C5").value=e.vendor_phone||"",r.getCell("C6").value=e.vendor_fax||"",r.getCell("C7").value=J(e.delivery_request_date),r.getCell("F2").value=e.requester_name,r.getCell("F3").value="ëŒ€êµ¬ê´‘ì—­ì‹œ ë‹¬ì„œêµ¬ ì„±ì„œê³µë‹¨ë¶ë¡œ305",r.getCell("F4").value=e.purchase_order_number,r.getCell("F5").value="(053) 626-7805",r.getCell("F6").value="(053) 657-7905",r.getCell("F5").alignment={horizontal:"center",vertical:"middle"},r.getCell("F6").alignment={horizontal:"center",vertical:"middle"};const i=["No","í’ˆëª…","ê·œê²©","ìˆ˜ëŸ‰","ë‹¨ê°€","ê¸ˆì•¡","ë¹„ê³ "];for(let t=0;t<i.length;t++)r.getCell(String.fromCharCode(65+t)+"8").value=i[t],r.getCell(String.fromCharCode(65+t)+"8").font={bold:!0},6===t&&(r.getCell("G8").alignment={horizontal:"center",vertical:"middle"});const n=[...e.items].sort((e,t)=>e.line_number-t.line_number),s=n.length,l=9+Math.max(s,45);for(let t=0;t<n.length;t++){const e=n[t],a=9+t;r.getCell("A"+a).value=e.line_number;const i=r.getCell("B"+a);i.value=e.item_name,i.alignment={horizontal:"left",vertical:"middle"},r.getCell("C"+a).value=e.specification,r.getCell("C"+a).alignment={horizontal:"left",vertical:"middle"},r.getCell("D"+a).value=e.quantity;const s=Y(e.currency),l=void 0!==e.unit_price_value&&null!==e.unit_price_value?`${e.unit_price_value.toLocaleString()} ${s}`.trim():"";r.getCell("E"+a).value=l,r.getCell("E"+a).alignment={horizontal:"right",vertical:"middle"};const d=Y(e.currency),o=void 0!==e.amount_value&&null!==e.amount_value?`${e.amount_value.toLocaleString()} ${d}`.trim():"";r.getCell("F"+a).value=o,r.getCell("F"+a).alignment={horizontal:"right",vertical:"middle"};const c=r.getCell("G"+a);c.value=void 0!==e.remark&&null!==e.remark?String(e.remark):"",c.alignment={horizontal:"left",vertical:"middle",wrapText:!1,shrinkToFit:!0}}for(let t=s;t<45;t++){const e=9+t;for(let t=0;t<7;t++)r.getCell(String.fromCharCode(65+t)+e).value=""}r.mergeCells(`A${l}:E${l}`),r.getCell("A"+l).value="í•©ê³„",r.getCell("A"+l).font={bold:!0};const d=Y(e.items[0]?.currency),o=e.items.reduce((e,t)=>e+(t.amount_value||0),0);r.getCell("F"+l).value=`${o.toLocaleString()} ${d}`.trim(),r.getCell("F"+l).alignment={horizontal:"right",vertical:"middle"};const c=l;for(let t=1;t<=c;t++)for(let e=1;e<=7;e++){const a=String.fromCharCode(64+e)+t,i=r.getCell(a),n=t>=9&&t<l;(5===e||6===e)&&(n||t===l)||3===e&&n||(i.alignment={horizontal:"center",vertical:"middle"}),i.border={top:{style:1===t||2===t||8===t||t===l?"medium":"thin"},left:{style:1===e?"medium":"thin"},right:{style:7===e?"medium":"thin"},bottom:{style:8===t||t===l||t===c?"medium":"thin"}}}for(let t=0;t<s;t++){const e=9+t;r.getCell("C"+e).alignment={horizontal:"left",vertical:"middle"}}for(let t=2;t<=7;t++)r.getCell("B"+t).border={...r.getCell("B"+t).border,right:{style:"medium"}},r.getCell("D"+t).border={...r.getCell("D"+t).border,right:{style:"medium"}},t<=6&&(r.getCell("E"+t).border={...r.getCell("E"+t).border,right:{style:"medium"}});r.getCell("E7").border={...r.getCell("E7").border,top:{style:"thin"},right:{style:"medium"}},r.getCell("G7").border={...r.getCell("G7").border,top:{style:"thin"}};for(let t=1;t<=7;t++){const e=r.getCell("A"+t).border||{};r.getCell("A"+t).border={...e,left:{style:"medium"}}}const m=r.getCell("A"+l).border||{};r.getCell("A"+l).border={...m,left:{style:"medium"}};Object.entries({A:4.7,B:23,C:30,D:11,E:15,F:16,G:37}).forEach(([e,t])=>{r.getColumn(e).width=t}),r.getRow(1).height=29.8,r.getRow(1).eachCell(e=>{e.font={...e.font||{},name:"ë§‘ì€ ê³ ë”•",size:20}});for(let t=2;t<=c;t++){const e=r.getRow(t);e.height=15.75,e.eachCell(e=>{e.font={...e.font||{},name:"ë§‘ì€ ê³ ë”•",size:11}})}for(let t=9;t<=c;t++)r.getCell("G"+t).alignment={horizontal:"left",vertical:"middle",wrapText:!1,shrinkToFit:!0},r.getCell("B"+t).alignment={horizontal:"left",vertical:"middle"};const u=await a.xlsx.writeBuffer();return new Blob([u],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"})}const Z=a(),ee=async(e,t,a)=>{try{const{data:n,error:s}=await Z.from("purchase_requests").select("*").eq("purchase_order_number",e.purchase_order_number).single();if(s||!n)return void w.error("í•´ë‹¹ ë°œì£¼ìš”ì²­ë²ˆí˜¸ì˜ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");const{data:l,error:d}=await Z.from("purchase_request_items").select("*").eq("purchase_order_number",e.purchase_order_number).order("line_number");if(d||!l||0===l.length)return void w.error("í•´ë‹¹ ë°œì£¼ìš”ì²­ë²ˆí˜¸ì˜ í’ˆëª© ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");const o={vendor_name:e.vendor_name,vendor_phone:"",vendor_fax:"",vendor_contact_name:""};try{const t=n.vendor_id||e.vendor_id,a=n.contact_id||e.contact_id;if(t){const{data:e,error:a}=await Z.from("vendors").select("vendor_phone, vendor_fax").eq("id",t).single();e&&!a&&(o.vendor_phone=e.vendor_phone||"",o.vendor_fax=e.vendor_fax||"")}if(a){const{data:e,error:t}=await Z.from("vendor_contacts").select("contact_name, contact_phone, contact_email").eq("id",a).single();e&&!t&&(o.vendor_contact_name=e.contact_name||"")}}catch(r){}const c={purchase_order_number:n.purchase_order_number||"",request_date:n.request_date,delivery_request_date:n.delivery_request_date,requester_name:n.requester_name,vendor_name:o.vendor_name||"",vendor_contact_name:o.vendor_contact_name,vendor_phone:o.vendor_phone,vendor_fax:o.vendor_fax,project_vendor:n.project_vendor,sales_order_number:n.sales_order_number,project_item:n.project_item,items:l.map(e=>({line_number:e.line_number,item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark,currency:n.currency||"KRW"}))},m=await X(c),u=`ë°œì£¼ì„œ_${c.vendor_name}_${c.purchase_order_number}.xlsx`,_=window.URL.createObjectURL(m),p=document.createElement("a");p.href=_,p.download=u,document.body.appendChild(p),p.click(),document.body.removeChild(p),window.URL.revokeObjectURL(_),w.success("ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.");try{if(t&&t.includes("lead buyer")){const{error:t}=await Z.from("purchase_requests").update({is_po_download:!0}).eq("purchase_order_number",e.purchase_order_number);t||a?.()}}catch(i){}}catch(r){throw w.error("ì—‘ì…€ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."),r}};function te({children:e,onDateSelect:t,disabled:a=!1,placeholder:s="ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”",align:l="center",side:d="bottom"}){const[o,c]=r.useState(!1);return i.jsxs(I,{open:o,onOpenChange:c,children:[i.jsx($,{asChild:!0,disabled:a,children:e}),i.jsx(O,{className:"w-auto p-0 border-gray-200 shadow-lg",align:l,side:d,sideOffset:8,children:i.jsxs("div",{className:"bg-white business-radius-card p-2",children:[i.jsx("div",{className:"mb-2 px-1",children:i.jsx("div",{className:"modal-label text-gray-600 text-center",children:s})}),i.jsx(C,{mode:"single",selected:void 0,onSelect:e=>{n.debug("ğŸ—“ï¸ Calendar onSelect ì§ì ‘ í˜¸ì¶œ:",{date:e,isToday:e&&(new Date).toDateString()===e.toDateString(),dateValue:e?.getTime(),todayValue:(new Date).getTime()}),(e=>{n.debug("ğŸ“… DatePickerPopover handleDateSelect í˜¸ì¶œ:",{date:e,isToday:e&&(new Date).toDateString()===e.toDateString(),dateString:e?.toDateString(),todayString:(new Date).toDateString()}),e?(n.debug("âœ… ë‚ ì§œ ì„ íƒë¨, onDateSelect í˜¸ì¶œ ì˜ˆì •"),t(e),c(!1),n.debug("ğŸ”š DatePickerPopover ì²˜ë¦¬ ì™„ë£Œ")):n.debug("âŒ ë‚ ì§œê°€ undefinedì„")})(e)},locale:q,initialFocus:!0,className:"compact-calendar",disabled:!1,fromDate:new Date("2020-01-01"),toDate:new Date("2030-12-31"),defaultMonth:new Date,modifiers:{today:new Date},modifiersClassNames:{today:"bg-blue-500 text-white font-semibold cursor-pointer hover:bg-blue-600 rounded-md"}})]})})]})}function ae({children:e,onConfirm:t,disabled:a=!1,placeholder:n="ë‚ ì§œì™€ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”",align:l="center",side:d="bottom",defaultDate:o,defaultAmount:c}){const[m,u]=r.useState(!1),[_,p]=r.useState(o),[h,g]=r.useState(c?.toString()||"");return i.jsxs(I,{open:m,onOpenChange:u,children:[i.jsx($,{asChild:!0,disabled:a,children:e}),i.jsx(O,{className:"w-auto p-0 border-gray-200 shadow-lg",align:l,side:d,sideOffset:8,children:i.jsxs("div",{className:"bg-white business-radius-card p-3",children:[i.jsx("div",{className:"mb-2 px-1",children:i.jsx("div",{className:"modal-label text-gray-600 text-center",children:n})}),i.jsx(C,{mode:"single",selected:_,onSelect:p,locale:q,initialFocus:!0,className:"compact-calendar",disabled:!1,fromDate:new Date("2020-01-01"),toDate:new Date("2030-12-31"),defaultMonth:_||new Date,modifiers:{today:new Date},modifiersClassNames:{today:"bg-blue-500 text-white font-semibold cursor-pointer hover:bg-blue-600 rounded-md"}}),i.jsxs("div",{className:"mt-3 px-1",children:[i.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"ì§€ì¶œê¸ˆì•¡"}),i.jsx(A,{type:"text",value:h,onChange:e=>{const t=e.target.value.replace(/[^0-9]/g,"");if(t){const e=parseInt(t,10);g(e.toLocaleString())}else g("")},placeholder:"ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”",className:"w-full"})]}),i.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[i.jsx(s,{variant:"outline",size:"sm",onClick:()=>u(!1),children:"ì·¨ì†Œ"}),i.jsx(s,{size:"sm",onClick:()=>{if(!_)return;const e=parseFloat(h.replace(/,/g,""));isNaN(e)||e<=0||(t(_,e),u(!1),p(o),g(c?.toString()||""))},disabled:!_||!h||parseFloat(h.replace(/,/g,""))<=0,className:"button-base button-action-primary",children:"í™•ì¸"})]})]})})]})}function re({children:e,onConfirm:t,disabled:a=!1,placeholder:n="ë‚ ì§œì™€ ì‹¤ì œì…ê³ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”",align:l="center",side:d="bottom",defaultDate:o,defaultQuantity:c,maxQuantity:m,hideQuantityInput:u=!1,quantityInfoText:_="ìš”ì²­ì…ê³ ìˆ˜ëŸ‰ê³¼ ë™ì¼í•œ ìˆ˜ëŸ‰ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤"}){const[p,h]=r.useState(!1),[g,x]=r.useState(o),[v,f]=r.useState(c?.toString()||"");return i.jsxs(I,{open:p,onOpenChange:h,children:[i.jsx($,{asChild:!0,disabled:a,children:e}),i.jsx(O,{className:"w-auto p-0 border-gray-200 shadow-lg",align:l,side:d,sideOffset:8,children:i.jsxs("div",{className:"bg-white business-radius-card p-3",children:[i.jsx("div",{className:"mb-2 px-1",children:i.jsx("div",{className:"modal-label text-gray-600 text-center",children:n})}),u&&i.jsx("div",{className:"mb-2 px-1",children:i.jsxs("div",{className:"text-[10px] text-gray-500 text-center leading-tight",children:[i.jsx("div",{children:"ìš”ì²­ì…ê³ ìˆ˜ëŸ‰ê³¼ ë™ì¼í•œ"}),i.jsx("div",{children:"ìˆ˜ëŸ‰ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤"})]})}),i.jsx(C,{mode:"single",selected:g,onSelect:x,locale:q,initialFocus:!0,className:"compact-calendar",disabled:!1,fromDate:new Date("2020-01-01"),toDate:new Date("2030-12-31"),defaultMonth:g||new Date,modifiers:{today:new Date},modifiersClassNames:{today:"bg-blue-500 text-white font-semibold cursor-pointer hover:bg-blue-600 rounded-md"}}),!u&&i.jsxs("div",{className:"mt-3 px-1",children:[i.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"ì‹¤ì œì…ê³ ìˆ˜ëŸ‰"}),i.jsx(A,{type:"number",value:v,onChange:e=>{const t=e.target.value.replace(/[^0-9]/g,"");f(t)},placeholder:"ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”",className:"border-gray-200 rounded-lg text-center w-full !h-5 !px-1.5 !py-0.5 !text-[9px] font-normal text-gray-600 focus:border-blue-400",min:"0",max:m}),m&&i.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["ìµœëŒ€: ",m.toLocaleString()]})]}),i.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[i.jsx(s,{variant:"outline",size:"sm",onClick:()=>h(!1),className:"button-base",children:"ì·¨ì†Œ"}),i.jsx(s,{size:"sm",onClick:()=>{if(!g)return;if(u)return t(g,void 0),h(!1),x(o),void f(c?.toString()||"");const e=parseFloat(v.replace(/,/g,""));isNaN(e)||e<0||m&&e>m||(t(g,e),h(!1),x(o),f(c?.toString()||""))},disabled:!g||!u&&(!v||parseFloat(v.replace(/,/g,""))<0||void 0!==m&&parseFloat(v.replace(/,/g,""))>m),className:"button-base button-action-primary",children:"í™•ì¸"})]})]})})]})}function ie({config:e,currentUserName:t,canPerformAction:i,purchaseId:s,onUpdate:m,onOptimisticUpdate:u}){const _=a(),p=r.useCallback(async(a,r,o,c)=>{if(!i)return n.warn("âŒ ê¶Œí•œ ì—†ìŒ",{canPerformAction:i,currentUserName:t}),void w.error(("statement_received"===e.field?"ê±°ë˜ëª…ì„¸ì„œ":"ì…ê³ ")+" í™•ì¸ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");const p="number"==typeof a?a:Number(a);if(Number.isNaN(p))return n.error("âŒ ì˜ëª»ëœ ID",{itemId:a,numericId:p}),void w.error("ìœ íš¨í•˜ì§€ ì•Šì€ í•­ëª© ID ì…ë‹ˆë‹¤.");if(o){const t=`í’ˆëª©ëª…: ${o.item_name||"-"}\nê·œê²©: ${o.specification||"-"}\nìˆ˜ëŸ‰: ${o.quantity?.toLocaleString()||0}\në‹¨ê°€: â‚©${o.unit_price_value?.toLocaleString()||0}\ní•©ê³„: â‚©${o.amount_value?.toLocaleString()||0}\në¹„ê³ : ${o.remark||"-"}\n\n${e.confirmMessage.confirm}`;if(!window.confirm(t))return}try{let a;"statement_received"===e.field?a={is_statement_received:!0,statement_received_date:r.toISOString(),statement_received_by_name:t}:"actual_received"===e.field&&(a={actual_received_date:r.toISOString(),is_received:!0,received_quantity:void 0!==c?c:void 0!==o?.received_quantity?o.received_quantity:null}),n.debug("ğŸ“ ì—…ë°ì´íŠ¸í•  ë°ì´í„°:",a);const{data:i,error:h}=await _.from("purchase_request_items").update(a).eq("id",p).select();if(n.debug("ğŸ“ DB ì—…ë°ì´íŠ¸ ê²°ê³¼:",{data:i,error:h}),h)throw n.error("âŒ DB ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",h),h;if(n.info("âœ… DB ì—…ë°ì´íŠ¸ ì„±ê³µ",i),s)if("actual_received"===e.field){l(s,p,r.toISOString(),c)||n.warn("[useConfirmDateAction] ë©”ëª¨ë¦¬ ìºì‹œ ì…ê³ ì™„ë£Œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{purchaseId:s,itemId:p})}else if("statement_received"===e.field){d(s,p,r.toISOString(),t||void 0)||n.warn("[useConfirmDateAction] ë©”ëª¨ë¦¬ ìºì‹œ ê±°ë˜ëª…ì„¸ì„œ í™•ì¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{purchaseId:s,itemId:p})}u&&u({itemId:p,selectedDate:r,action:"confirm",receivedQuantity:void 0!==c?c:o?.received_quantity,itemInfo:o}),m&&m(),w.success(e.successMessage.confirm)}catch(h){n.error("âŒ ì „ì²´ ì²˜ë¦¬ ì‹¤íŒ¨",h),w.error(("statement_received"===e.field?"ê±°ë˜ëª…ì„¸ì„œ":"ì…ê³ ")+" í™•ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},[e,t,i,s,m,u,_]),h=r.useCallback(async(a,r)=>{if(!i)return n.warn("âŒ ì·¨ì†Œ ê¶Œí•œ ì—†ìŒ",{canPerformAction:i,currentUserName:t}),void w.error(("statement_received"===e.field?"ê±°ë˜ëª…ì„¸ì„œ":"ì…ê³ ")+" í™•ì¸ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");const l="number"==typeof a?a:Number(a);if(Number.isNaN(l))w.error("ìœ íš¨í•˜ì§€ ì•Šì€ í•­ëª© ID ì…ë‹ˆë‹¤.");else{if(r){const t=`í’ˆëª©ëª…: ${r.item_name||"-"}\nê·œê²©: ${r.specification||"-"}\nìˆ˜ëŸ‰: ${r.quantity?.toLocaleString()||0}\në‹¨ê°€: â‚©${r.unit_price_value?.toLocaleString()||0}\ní•©ê³„: â‚©${r.amount_value?.toLocaleString()||0}\në¹„ê³ : ${r.remark||"-"}\n\n${e.confirmMessage.cancel}`;if(!window.confirm(t))return}try{let t;n.debug(`ğŸ”„ ${e.field} í™•ì¸ ì·¨ì†Œ ì‹œì‘`,{itemId:a,itemName:r?.item_name}),"statement_received"===e.field?t={is_statement_received:!1,statement_received_date:null,statement_received_by_name:null}:"actual_received"===e.field&&(t={actual_received_date:null,is_received:!1}),n.debug("ğŸ”„ ì·¨ì†Œ ì—…ë°ì´íŠ¸í•  ë°ì´í„°:",t);const{data:i,error:d}=await _.from("purchase_request_items").update(t).eq("id",l).select();if(n.debug("ğŸ”„ ì·¨ì†Œ DB ì—…ë°ì´íŠ¸ ê²°ê³¼:",{data:i,error:d}),d)throw n.error("âŒ DB ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",d),d;if(n.info(`âœ… ${e.field} í™•ì¸ ì·¨ì†Œ ì„±ê³µ`,i),s)if("actual_received"===e.field){o(s,l)||n.warn("[useConfirmDateAction] ë©”ëª¨ë¦¬ ìºì‹œ ì…ê³ ì·¨ì†Œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{purchaseId:s,itemId:l})}else if("statement_received"===e.field){c(s,l)||n.warn("[useConfirmDateAction] ë©”ëª¨ë¦¬ ìºì‹œ ê±°ë˜ëª…ì„¸ì„œ ì·¨ì†Œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{purchaseId:s,itemId:l})}u&&u({itemId:l,action:"cancel",itemInfo:r}),m&&m(),w.success(e.successMessage.cancel)}catch(d){n.error(`âŒ ${e.field} í™•ì¸ ì·¨ì†Œ ì‹¤íŒ¨`,d),w.error(("statement_received"===e.field?"ê±°ë˜ëª…ì„¸ì„œ":"ì…ê³ ")+" í™•ì¸ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}}},[e,i,s,m,u,_]),g=r.useCallback(t=>"statement_received"===e.field?t.is_statement_received:"actual_received"===e.field&&t.is_received,[e.field]),x=r.useCallback(t=>"statement_received"===e.field?t.statement_received_date:"actual_received"===e.field?t.actual_received_date:null,[e.field]),v=r.useCallback(t=>"statement_received"===e.field?t.statement_received_by_name:(e.field,null),[e.field]);return{config:e,handleConfirm:p,handleCancel:h,isCompleted:g,getCompletedDate:x,getCompletedByName:v}}const ne=[{id:"statement_progress",label:"ê±°ë˜ëª…ì„¸ì„œ",description:"ê±°ë˜ëª…ì„¸ì„œ ìˆ˜ë ¹ ì§„í–‰ë¥ ",defaultVisible:!0},{id:"purchase_order_number",label:"ë°œì£¼ë²ˆí˜¸",description:"ë°œì£¼ìš”ì²­ ë²ˆí˜¸",defaultVisible:!0},{id:"payment_category",label:"ê²°ì œì¢…ë¥˜",description:"ê²°ì œ ë°©ì‹ (êµ¬ë§¤ìš”ì²­, ë°œì£¼, í˜„ì¥ê²°ì œ ë“±)",defaultVisible:!0},{id:"requester_name",label:"ìš”ì²­ì",description:"ë°œì£¼ë¥¼ ìš”ì²­í•œ ì‚¬ìš©ì",defaultVisible:!0},{id:"request_date",label:"ì²­êµ¬ì¼",description:"ë°œì£¼ ìš”ì²­ ë‚ ì§œ",defaultVisible:!0},{id:"utk_status",label:"UTK",description:"UTK í™•ì¸ ìƒíƒœ",defaultVisible:!0},{id:"vendor_name",label:"ì—…ì²´",description:"ê³µê¸‰ì—…ì²´ëª…",defaultVisible:!0},{id:"contact_name",label:"ë‹´ë‹¹ì",description:"ì—…ì²´ ë‹´ë‹¹ìëª…",defaultVisible:!0},{id:"delivery_request_date",label:"ì…ê³ ìš”ì²­ì¼",description:"ì…ê³  ìš”ì²­ ë‚ ì§œ",defaultVisible:!0},{id:"revised_delivery_date",label:"ë³€ê²½ì…ê³ ì¼",description:"ìˆ˜ì •ëœ ì…ê³  ë‚ ì§œ",defaultVisible:!0},{id:"item_name",label:"í’ˆëª…",description:"êµ¬ë§¤ í’ˆëª©ëª…",defaultVisible:!0},{id:"specification",label:"ê·œê²©",description:"í’ˆëª© ê·œê²© ì •ë³´",defaultVisible:!0},{id:"quantity",label:"ìˆ˜ëŸ‰",description:"êµ¬ë§¤ ìˆ˜ëŸ‰",defaultVisible:!0},{id:"unit_price",label:"ë‹¨ê°€",description:"í’ˆëª© ë‹¨ê°€",defaultVisible:!0},{id:"amount",label:"í•©ê³„",description:"ì´ ê¸ˆì•¡",defaultVisible:!0},{id:"remark",label:"ë¹„ê³ ",description:"ì¶”ê°€ ë©”ëª¨ ì‚¬í•­",defaultVisible:!0},{id:"link",label:"ë§í¬",description:"ê´€ë ¨ ë§í¬",defaultVisible:!0},{id:"project_vendor",label:"PJì—…ì²´",description:"í”„ë¡œì íŠ¸ ì—…ì²´",defaultVisible:!0},{id:"project_item",label:"PJ ITEM",description:"í”„ë¡œì íŠ¸ ì•„ì´í…œ",defaultVisible:!0},{id:"sales_order_number",label:"ìˆ˜ì£¼ë²ˆí˜¸",description:"ìˆ˜ì£¼ ë²ˆí˜¸",defaultVisible:!0},{id:"purchase_progress",label:"êµ¬ë§¤ì§„í–‰",description:"êµ¬ë§¤ ì§„í–‰ë¥ ",defaultVisible:!0},{id:"receipt_progress",label:"ì…ê³ ì§„í–‰",description:"ì…ê³  ì§„í–‰ë¥ ",defaultVisible:!0}],se=ne.reduce((e,t)=>(e[t.id]=t.defaultVisible,e),{});ne.reduce((e,t)=>(e[t.id]=t,e),{});const le=["purchase_order_number","vendor_name","item_name","specification"],de=["statement_progress","utk_status","unit_price","amount"],oe=["app_admin","ceo","final_approver","purchase_manager","lead buyer","accounting"],ce=[{title:"ê¸°ë³¸ ì •ë³´",columns:["statement_progress","purchase_order_number","payment_category","requester_name","request_date","utk_status"]},{title:"ì—…ì²´ ì •ë³´",columns:["vendor_name","contact_name","delivery_request_date","revised_delivery_date"]},{title:"í’ˆëª© ì •ë³´",columns:["item_name","specification","quantity","unit_price","amount","remark","link"]},{title:"í”„ë¡œì íŠ¸ ì •ë³´",columns:["project_vendor","project_item","sales_order_number"]},{title:"ì§„í–‰ ìƒíƒœ",columns:["purchase_progress","receipt_progress"]}];const me=r.memo(function({purchaseId:e,isOpen:t,onClose:o,embedded:c=!1,currentUserRoles:j=[],activeTab:C,onRefresh:q,onOptimisticUpdate:J,onDelete:Y}){const{allPurchases:X,lastFetch:Z}=m(),[ee,ne]=r.useState(!1),[se,le]=r.useState(null),[de,ce]=r.useState(!1),[me,ue]=r.useState(null),[_e,pe]=r.useState([]),[he,ge]=r.useState([]),[xe,ve]=r.useState([]),[fe,be]=r.useState(""),[ye,je]=r.useState([]),[Ne,we]=r.useState(null),[Ce,qe]=r.useState([]),[Se,ke]=r.useState(""),[De,Ie]=r.useState(!1),[$e,Oe]=r.useState(""),[Ae,Fe]=r.useState(""),[We,Te]=r.useState(!1);r.useEffect(()=>{De&&se&&(Oe(`[ìˆ˜ì •ìš”ì²­] ë°œì£¼ë²ˆí˜¸ ${se.purchase_order_number} ìˆ˜ì • ìš”ì²­í•©ë‹ˆë‹¤.`),Fe(""))},[De,se]);const ze=r.useMemo(()=>{if(se?.items&&se.items.length>0)return se.items;if(se?.purchase_request_items&&se.purchase_request_items.length>0)return se.purchase_request_items;if(e&&X){const t=X.find(t=>t.id===e);if(t)return t.items&&t.items.length>0?t.items:t.purchase_request_items||[]}return[]},[se,e,X,Z]);r.useMemo(()=>{if(ye.length>0){const e=ye.length>1?12*(ye.length-1):0,t=24,a=ye.reduce((e,t)=>e+t,0)+e+t;return Math.max(a,720)}const e=[120,200,70,90,100,150,80];"purchase"===C&&e.push(120),"receipt"!==C&&"done"!==C||e.push(120),"receipt"===C&&e.push(140),"done"===C&&e.push(100,80,110),de&&e.push(110);const t=e.length>1?12*(e.length-1):0,a=e.reduce((e,t)=>e+t,0)+t+48;return Math.max(a,720)},[ye,C,de]);const Pe=r.useRef(null),Me=a();r.useEffect(()=>{t&&(async()=>{try{const e="https://qvhbigvdfyvhoegkhvef.supabase.co";if(!e||e.includes("placeholder"))return void n.warn("Supabase í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ - PurchaseDetailModal");const{data:{user:t}}=await Me.auth.getUser();if(t){let{data:e}=await Me.from("employees").select("*").eq("id",t.id).maybeSingle();if(!e&&t.email){const{data:a}=await Me.from("employees").select("*").eq("email",t.email).maybeSingle();e=a}if(e?.name&&be(e.name),e?.purchase_role){let t=[];t=Array.isArray(e.purchase_role)?e.purchase_role.map(e=>String(e).trim()):String(e.purchase_role).split(",").map(e=>e.trim()).filter(e=>e.length>0),ve(t)}}}catch(e){}})()},[t]),r.useEffect(()=>{t&&(async()=>{try{const{data:e,error:t}=await Me.from("vendors").select("*").order("vendor_name",{ascending:!0});if(t)throw t;e&&qe(e)}catch(e){n.error("ì—…ì²´ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:",e)}})()},[t]);const Ee=Array.isArray(j)&&j.length>0?j:xe,Le=Ee.includes("final_approver")||Ee.includes("app_admin")||Ee.includes("ceo"),Ue=Ee.includes("lead buyer"),Re=Le||Ue,Be=Ee.some(e=>oe.includes(e)),Ve="approved"===se?.final_manager_status?Le:Le||se?.requester_name===fe,Ke=Ee.includes("app_admin")||Ee.includes("lead buyer")||Ee.includes("lead buyer"),He=Ee.includes("app_admin")||se?.requester_name===fe,Ge=Ee.includes("final_approver")||Ee.includes("app_admin")||Ee.includes("ceo"),Qe=se?.requester_name===fe,Je=Ee.includes("app_admin")||Ee.includes("lead buyer")||Ee.includes("accounting"),Ye=Ee.includes("app_admin")||Qe,Xe=r.useCallback(async()=>{if(e)try{const t=a(),{data:r,error:i}=await t.from("purchase_requests").select("\n          *,\n          vendors:vendor_id(id, vendor_name, is_active),\n          purchase_request_items(*),\n          contact:contact_id(id, contact_name, contact_email, contact_phone, position)\n        ").eq("id",e).single();if(i)throw i;let s=[];if(r&&r.vendor_id){const{data:e}=await t.from("vendor_contacts").select("id, contact_name, contact_email, contact_phone, position").eq("vendor_id",r.vendor_id).order("contact_name");if(e&&e.length>0){if(r.contact_id){const t=e.find(e=>e.id===r.contact_id),a=e.filter(e=>e.id!==r.contact_id);s=t?[t,...a]:e}else s=e;n.info("ğŸ” ì—…ì²´ì˜ ëª¨ë“  ë‹´ë‹¹ì ë¡œë“œ:",{vendor_id:r.vendor_id,contact_id:r.contact_id,allContacts_count:e.length,vendorContacts:s})}}else r&&r.contact&&(s=[r.contact]);if(r){const e=(r.purchase_request_items||[]).sort((e,t)=>(e.line_number||999999)-(t.line_number||999999)),t={...r,items:e,vendor:r.vendors||null,vendor_contacts:s,contact_id:r.contact_id,contact_name:s[0]?.contact_name||r.contact?.contact_name||null};le(t),ue(t),pe(e),n.info("ğŸ” refreshModalData DBì—ì„œ ë¡œë“œ ì™„ë£Œ:",{vendor_contacts:t.vendor_contacts,vendorContacts_from_query:s,purchase_updated:!0,vendor_id:r.vendor_id,has_vendor_contacts:s&&s.length>0})}}catch(t){n.error("ëª¨ë‹¬ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨",t)}},[e]);r.useEffect(()=>{if(!e||!X||!se)return;const t=X.find(t=>t.id===e);if(t){const e=t.items&&t.items.length>0?t.items:t.purchase_request_items||[],a={...se,...t,id:String(t.id),items:e,purchase_request_items:e};le(a),ue(a),pe(e.length>0?e:[])}},[X,Z]),r.useEffect(()=>{if(!t||!e||!X)return;const a=X.find(t=>t.id===e);if(a){const e=a.items&&a.items.length>0?a.items:a.purchase_request_items||[],t={...a,id:String(a.id),is_po_generated:!1,items:e,purchase_request_items:e,vendor:{id:a.vendor_id,vendor_name:a.vendor_name||"ì•Œ ìˆ˜ ì—†ìŒ",is_active:!0},vendor_contacts:[]};le(t),ue(t),pe(e.length>0?e:[])}},[t,e,X]);const[Ze,et]=r.useState(!0),tt=e?Number(e):se?Number(se.id):NaN,at=r.useCallback(({itemId:e,selectedDate:t,action:a,receivedQuantity:r})=>{const i=String(e),n=(new Date).toISOString(),s=t?t.toISOString():void 0,l=e=>e?e.map(e=>String(e.id)!==i?e:"confirm"===a?{...e,is_received:!0,actual_received_date:s,received_at:n,received_quantity:void 0!==r?r:e.received_quantity}:{...e,is_received:!1,actual_received_date:void 0,received_at:void 0,received_quantity:void 0}):e;le(e=>{if(!e)return e;const t=l(e.items)||[],a=l(e.purchase_request_items)||[],r=t.length,i=t.filter(e=>e.is_received).length,s=r>0&&i===r;return{...e,items:t,purchase_request_items:a,is_received:s,received_at:s?e.received_at||n:void 0,updated_at:(new Date).toISOString()}}),ue(e=>{if(!e)return e;const t=l(e.items)||[],a=l(e.purchase_request_items)||[];return{...e,items:t,purchase_request_items:a}}),pe(e=>e&&0!==e.length?e.map(e=>e.id&&String(e.id)===i?"confirm"===a?{...e,is_received:!0,actual_received_date:s,received_at:n,received_quantity:void 0!==r?r:e.received_quantity}:{...e,is_received:!1,actual_received_date:void 0,received_at:void 0,received_quantity:void 0}:e):e),Number.isNaN(tt)||J?.(tt,e=>{const t=l(e.items)||e.items||[],a=l(e.purchase_request_items)||e.purchase_request_items||[],r=t.length||e.items?.length||0,i=t.filter(e=>e.is_received).length,s=r>0&&i===r;return{...e,items:t,purchase_request_items:a,is_received:s,received_at:s?e.received_at||n:void 0,updated_at:(new Date).toISOString()}})},[J,tt]),rt=r.useCallback(({itemId:e,selectedDate:t,action:r})=>{const i=String(e),s=t?t.toISOString():void 0;let l=!1,d=null;if(le(e=>{if(!e)return e;const t=(e.items||[]).map(e=>String(e.id)!==i?e:"confirm"===r?{...e,is_statement_received:!0,statement_received_date:s,statement_received_by_name:fe}:{...e,is_statement_received:!1,statement_received_date:null,statement_received_by_name:null});return l=t.length>0&&t.every(e=>e.is_statement_received),d=l?s||e.statement_received_at||(new Date).toISOString():null,{...e,items:t,is_statement_received:l,statement_received_at:d}}),ue(e=>{if(!e)return e;const t=(e.items||[]).map(e=>String(e.id)!==i?e:"confirm"===r?{...e,is_statement_received:!0,statement_received_date:s,statement_received_by_name:fe}:{...e,is_statement_received:!1,statement_received_date:null,statement_received_by_name:null});return{...e,items:t,is_statement_received:l,statement_received_at:d}}),pe(e=>e?e.map(e=>String(e.id)!==i?e:"confirm"===r?{...e,is_statement_received:!0,statement_received_date:s,statement_received_by_name:fe}:{...e,is_statement_received:!1,statement_received_date:null,statement_received_by_name:null}):e),Number.isNaN(tt)||J?.(tt,e=>{const t=(e.items||[]).map(e=>String(e.id)!==i?e:"confirm"===r?{...e,is_statement_received:!0,statement_received_date:s,statement_received_by_name:fe}:{...e,is_statement_received:!1,statement_received_date:null,statement_received_by_name:null}),a=t.length>0&&t.every(e=>e.is_statement_received);return{...e,items:t,is_statement_received:a}}),se&&void 0!==l){a().from("purchase_requests").update({is_statement_received:l,statement_received_at:d}).eq("id",se.id).then(({error:e})=>{e&&n.error("ê±°ë˜ëª…ì„¸ì„œ í™•ì¸ purchase_requests ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",e)})}},[fe,J,tt,se]),it=ie({config:{field:"statement_received",confirmMessage:{confirm:"ê±°ë˜ëª…ì„¸ì„œ í™•ì¸ì„ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",cancel:"ê±°ë˜ëª…ì„¸ì„œ í™•ì¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"},successMessage:{confirm:"ê±°ë˜ëª…ì„¸ì„œ í™•ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",cancel:"ê±°ë˜ëª…ì„¸ì„œ í™•ì¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."},completedText:"âœ“ ì™„ë£Œ",waitingText:"ëŒ€ê¸°"},currentUserName:fe,canPerformAction:Je,purchaseId:se?.id,onUpdate:Xe,onOptimisticUpdate:rt}),nt=ie({config:{field:"actual_received",confirmMessage:{confirm:"ì‹¤ì œ ì…ê³  ì²˜ë¦¬ë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",cancel:"ì‹¤ì œ ì…ê³  ì²˜ë¦¬ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"},successMessage:{confirm:"ì‹¤ì œ ì…ê³  ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",cancel:"ì‹¤ì œ ì…ê³  ì²˜ë¦¬ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."},completedText:"ì…ê³ ì™„ë£Œ",waitingText:"ì…ê³ ëŒ€ê¸°"},currentUserName:fe,canPerformAction:Ye,purchaseId:se?.id,onUpdate:Xe,onOptimisticUpdate:at}),st=Ee.includes("middle_manager")||Ee.includes("app_admin")||Ee.includes("ceo"),lt=Ee.includes("final_approver")||Ee.includes("app_admin")||Ee.includes("ceo"),dt="inline-flex items-center gap-1 business-radius-badge !h-auto !min-h-0 !px-2.5 !py-0.5 badge-text leading-tight",ot="inline-flex items-center gap-1 business-radius-badge px-2.5 py-0.5 badge-text leading-tight";r.useEffect(()=>{if(e&&t){const t=u(e);if(t){const e={...t,id:String(t.id),is_po_generated:!1,vendor:t.vendor||(t.vendor_id?{id:t.vendor_id,vendor_name:t.vendor_name||"ì•Œ ìˆ˜ ì—†ìŒ",is_active:!0}:null),vendor_contacts:t.vendor_contacts||[]};le(e),ue(e),pe(t.items||[])}else pt(e.toString());ce(!1)}},[e,t]);const ct=r.useCallback(()=>{const e=se?.items&&se.items.length>0?se.items:se?.purchase_request_items&&se.purchase_request_items.length>0?se.purchase_request_items:[];if(0===e.length)return[];const t=[{key:"item_name",minWidth:80,maxWidth:500,baseWidth:80},{key:"specification",minWidth:80,maxWidth:200,baseWidth:150,isFixed:!1},{key:"quantity",minWidth:70,maxWidth:120,baseWidth:70},{key:"unit_price",minWidth:90,maxWidth:150,baseWidth:90},{key:"total_price",minWidth:100,maxWidth:180,baseWidth:100}];"ë°œì£¼"===se?.payment_category&&t.push({key:"tax_amount",minWidth:80,maxWidth:150,baseWidth:80}),t.push({key:"remarks",minWidth:150,maxWidth:150,baseWidth:150,isFixed:!0},{key:"status",minWidth:70,maxWidth:100,baseWidth:70}),"receipt"===C&&t.push({key:"actual_receipt_date",minWidth:100,maxWidth:160,baseWidth:100,isFixed:!1}),"done"===C&&"ë°œì£¼"===se?.payment_category&&t.push({key:"transaction_confirm",minWidth:85,maxWidth:120,baseWidth:85,isFixed:!1},{key:"accounting_date",minWidth:70,maxWidth:70,baseWidth:70,isFixed:!0},{key:"expenditure_info",minWidth:90,maxWidth:150,baseWidth:90,isFixed:!1});const a=t.map((t,a)=>{let r=4;const i=(()=>{const e="purchase"===C?"êµ¬ë§¤ìƒíƒœ":"receipt"===C||"done"===C?"ì…ê³ ìƒíƒœ":"ìƒíƒœ",t="receipt"===C||"done"===C?"ìš”ì²­/ì‹¤ì œ ì…ê³ ìˆ˜ëŸ‰":"ìš”ì²­ìˆ˜ëŸ‰",a="pending"===C?["í’ˆëª©ëª…","ê·œê²©",t,"ë‹¨ê°€","í•©ê³„","ë°œì£¼"===se?.payment_category?"ì„¸ì•¡":null,"ë¹„ê³ "].filter(e=>null!==e):["í’ˆëª©ëª…","ê·œê²©",t,"ë‹¨ê°€","í•©ê³„","ë°œì£¼"===se?.payment_category?"ì„¸ì•¡":null,"ë¹„ê³ ",e].filter(e=>null!==e);if("receipt"===C)return[...a,"ì‹¤ì œì…ê³ ì¼"];if("done"===C){const e=[...a];return"ë°œì£¼"===se?.payment_category&&e.push("ê±°ë˜ëª…ì„¸ì„œ í™•ì¸","íšŒê³„ìƒ ì…ê³ ì¼","ì§€ì¶œì •ë³´"),e}return a})();if(i[a]&&(r=Math.max(r,i[a].length)),e.forEach(e=>{let a="";switch(t.key){case"item_name":a=e.item_name||"";break;case"specification":a=e.specification||"";break;case"quantity":if("receipt"===C||"done"===C){const t=e.quantity||0,r=e.received_quantity??0;a=t>=100||r>=100?`${t}`:`${t}/${r}`}else a=e.quantity?.toString()||"";break;case"unit_price":a=null!=e.unit_price_value?e.unit_price_value.toLocaleString():"";break;case"total_price":a=null!=e.amount_value?e.amount_value.toLocaleString():null!=e.quantity&&null!=e.unit_price_value?(Number(e.quantity)*Number(e.unit_price_value)).toLocaleString():"";break;case"tax_amount":a=null!=e.tax_amount_value?e.tax_amount_value.toLocaleString():"";break;case"remarks":a=e.remark||"";break;case"status":a=mt(e)||"";break;case"actual_receipt_date":a=e.actual_received_date?N(e.actual_received_date):"";break;case"transaction_confirm":a=e.is_statement_received?"í™•ì¸ì™„ë£Œ":"ë¯¸í™•ì¸";break;case"accounting_date":a=e.statement_received_date?N(e.statement_received_date):"";break;case"expenditure_info":a=e.expenditure_date&&null!==e.expenditure_amount&&void 0!==e.expenditure_amount?"2025. 11. 25.":"ì§€ì¶œì…ë ¥"}const i=a.split("").reduce((e,t)=>e+(/[ê°€-í£]/.test(t)?1.5:1),0);r=Math.max(r,Math.ceil(i))}),t.isFixed)return t.baseWidth;let n=Math.max(t.minWidth,Math.min(t.maxWidth,7*r+20));return"expenditure_info"===t.key&&(n=110),n});return je(a),a},[se,C]),mt=e=>"purchase"===C?e.is_payment_completed?"êµ¬ë§¤ì™„ë£Œ":"êµ¬ë§¤ìš”ì²­":"receipt"===C?e.is_received?"ì…ê³ ":"ì…ê³ ëŒ€ê¸°":e.is_payment_completed?"êµ¬ë§¤ì™„ë£Œ":"êµ¬ë§¤ìš”ì²­",ut=()=>{if(ye.length>0){return ye.map(e=>`${e}px`).join(" ")}let e=["minmax(80px, 1fr)","200px","70px","90px","100px"];if("ë°œì£¼"===se?.payment_category&&e.push("100px"),e.push("150px"),e.push("80px"),"receipt"===C)return[...e,"100px"].join(" ");if("done"===C){const t=[...e];return"ë°œì£¼"===se?.payment_category&&t.push("100px","80px","110px"),t.join(" ")}return e.join(" ")};r.useEffect(()=>{const e=se?.items&&se.items.length>0||se?.purchase_request_items&&se.purchase_request_items.length>0;se&&e&&!de&&requestAnimationFrame(()=>{ct()})},[se,de,C,ct]);const _t=e=>{e&&!de&&(ue(se),pe(ze||[]),ge([]),ct()),ce(e)},pt=async e=>{try{const t=u(e);if(t){const e={...t,id:String(t.id),is_po_generated:!1,vendor:t.vendor||(t.vendor_id?{id:t.vendor_id,vendor_name:t.vendor_name||"ì•Œ ìˆ˜ ì—†ìŒ",is_active:!0}:null),vendor_contacts:t.vendor_contacts||[]};return le(e),ue(e),void pe(t.items||[])}ne(!0);const r=a(),{data:i,error:s}=await r.from("purchase_requests").select("\n          *,\n          vendors:vendor_id(id, vendor_name, is_active),\n          purchase_request_items(*),\n          contact:contact_id(id, contact_name, contact_email, contact_phone, position)\n        ").eq("id",e).single();if(s)throw s;let l=[];if(i&&i.vendor_id){const{data:e}=await r.from("vendor_contacts").select("id, contact_name, contact_email, contact_phone, position").eq("vendor_id",i.vendor_id).order("contact_name");if(e&&e.length>0){if(i.contact_id){const t=e.find(e=>e.id===i.contact_id),a=e.filter(e=>e.id!==i.contact_id);l=t?[t,...a]:e}else l=e;n.info("ğŸ” loadPurchaseDetail - ì—…ì²´ì˜ ëª¨ë“  ë‹´ë‹¹ì ë¡œë“œ:",{vendor_id:i.vendor_id,contact_id:i.contact_id,allContacts_count:e.length,vendorContacts:l})}}else i&&i.contact&&(l=[i.contact]);if(i){const e=(i.purchase_request_items||[]).sort((e,t)=>(e.line_number||999999)-(t.line_number||999999)),t={...i,items:e,vendor:i.vendors||null,vendor_contacts:l,contact_id:i.contact_id,contact_name:l[0]?.contact_name||i.contact?.contact_name||null};le(t),ue(t),pe(e)}}catch(t){n.error("[PurchaseDetailModal] ë°œì£¼ ìƒì„¸ ë¡œë“œ ì‹¤íŒ¨:",t),w.error("ë°œì£¼ ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}finally{ne(!1)}},ht=e=>new Intl.NumberFormat("ko-KR").format(e),gt=(e,t,a)=>{const r=[..._e];if("quantity"===t||"unit_price_value"===t){const i="quantity"===t?a:r[e].quantity,n="unit_price_value"===t?a:r[e].unit_price_value;r[e]={...r[e],[t]:a,amount_value:(i||0)*(n||0)}}else r[e]={...r[e],[t]:a};pe(r)},xt=e=>{const t=_e[e];t.id&&ge([...he,t.id]);const a=_e.filter((t,a)=>a!==e).sort((e,t)=>(e.line_number||999999)-(t.line_number||999999));pe(a)},vt=async(e,t)=>{if(!Ke)return n.warn("[handlePaymentToggle] ê¶Œí•œ ì—†ìŒ",{canPurchase:Ke,currentUserRoles:j}),void w.error("êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");const a=String(e),r="number"==typeof e?e:Number(e);if(Number.isNaN(r))return n.error("[handlePaymentToggle] ì˜ëª»ëœ ID",{itemId:e,numericId:r}),void w.error("ìœ íš¨í•˜ì§€ ì•Šì€ í•­ëª© ID ì…ë‹ˆë‹¤.");if(!se)return;const i=se.items&&se.items.length>0?se.items:[],s=se.purchase_request_items&&se.purchase_request_items.length>0?se.purchase_request_items:[],l=(i.length>0?i:s).find(e=>String(e.id)===a);if(!l)return;const d=`í’ˆëª…: ${l.item_name}\nê·œê²©: ${l.specification||"ë¯¸ì…ë ¥"}\nìˆ˜ëŸ‰: ${l.quantity?.toLocaleString()||0}${l.unit||""}\në‹¨ê°€: â‚©${l.unit_price_value?.toLocaleString()||0}\ní•©ê³„: â‚©${l.amount_value?.toLocaleString()||0}`,o=t?`ë‹¤ìŒ í’ˆëª©ì„ êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${d}`:`ë‹¤ìŒ í’ˆëª©ì˜ êµ¬ë§¤ì™„ë£Œë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${d}`;if(window.confirm(o))try{const{error:e}=await Me.from("purchase_request_items").update({is_payment_completed:t,payment_completed_at:t?(new Date).toISOString():null}).eq("id",r);if(e)throw e;if(se){(t?v(se.id,r):b(se.id,r))||n.warn("[PurchaseDetailModal] ë©”ëª¨ë¦¬ ìºì‹œ í’ˆëª© ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{purchaseId:se.id,itemId:r,isCompleted:t})}if(le(e=>{if(!e)return null;const r=e.items&&e.items.length>0?e.items:[],i=e.purchase_request_items&&e.purchase_request_items.length>0?e.purchase_request_items:[],n=(r.length>0?r:i).map(e=>String(e.id)===a?{...e,is_payment_completed:t,payment_completed_at:t?(new Date).toISOString():null}:e);return{...e,items:e.items?n:e.items,purchase_request_items:e.purchase_request_items?n:e.purchase_request_items}}),se){const e=Number(se.id);Number.isNaN(e)||J?.(e,e=>{const r=(e.items||[]).map(e=>String(e.id)===a?{...e,is_payment_completed:t}:e),i=r.length||e.items?.length||0,n=r.filter(e=>e.is_payment_completed).length,s=i>0&&n===i;return{...e,items:r,is_payment_completed:s,payment_completed_at:s?(new Date).toISOString():null,payment_completed_by_name:s&&fe||e.payment_completed_by_name}})}w.success(t?"êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.":"êµ¬ë§¤ì™„ë£Œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."),await Xe();const i=q?.(!0,{silent:!0});i instanceof Promise&&await i}catch(c){w.error("êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},ft=async(e,t,a)=>{if(!He)return void w.error("ì…ê³  ì²˜ë¦¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");const r=String(e),i="number"==typeof e?e:Number(e);if(Number.isNaN(i))return void w.error("ìœ íš¨í•˜ì§€ ì•Šì€ í•­ëª© ID ì…ë‹ˆë‹¤.");const s=se?Number(se.id):NaN;try{const{error:e}=await Me.from("purchase_request_items").update({is_received:!0,received_at:(new Date).toISOString(),actual_received_date:t.toISOString(),received_quantity:void 0!==a?a:null}).eq("id",i);if(e)throw e;if(se){l(se.id,i,t.toISOString(),a)||n.warn("[PurchaseDetailModal] ë©”ëª¨ë¦¬ ìºì‹œ ê°œë³„ í’ˆëª© ì…ê³ ì™„ë£Œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{purchaseId:se.id,itemId:i})}le(e=>{if(!e)return null;const i=e.items?.map(e=>String(e.id)===r?{...e,is_received:!0,received_at:(new Date).toISOString(),actual_received_date:t.toISOString(),received_quantity:void 0!==a?a:e.received_quantity}:e),n=e.purchase_request_items?.map(e=>String(e.id)===r?{...e,is_received:!0,received_at:(new Date).toISOString(),actual_received_date:t.toISOString(),received_quantity:void 0!==a?a:e.received_quantity}:e);return{...e,items:i,purchase_request_items:n,updated_at:(new Date).toISOString()}}),Number.isNaN(s)||J?.(s,e=>{const i=(e.items||[]).map(e=>String(e.id)===r?{...e,is_received:!0,actual_received_date:t.toISOString(),received_quantity:void 0!==a?a:e.received_quantity}:e),n=i.length||e.items?.length||0,s=i.filter(e=>e.is_received).length,l=n>0&&s===n;return{...e,items:i,is_received:l,received_at:l?(new Date).toISOString():e.received_at}});const d=se?.items?.find(e=>String(e.id)===r);w.success(`"${d?.item_name}" í’ˆëª©ì´ ì…ê³ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`),await Xe();const o=q?.(!0,{silent:!0});o instanceof Promise&&await o}catch(d){w.error("ì…ê³ ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},bt=async e=>{if(!se)return;const t="middle"===e?"1ì°¨ ìŠ¹ì¸":"ìµœì¢… ìŠ¹ì¸",a=`ë°œì£¼ë²ˆí˜¸: ${se.purchase_order_number}\n\n${t}ì„ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;if(window.confirm(a))try{const t="middle"===e?{middle_manager_status:"approved"}:{final_manager_status:"approved"},{error:a}=await Me.from("purchase_requests").update(t).eq("id",se.id);if(a)throw a;if(le("middle"===e?e=>e?{...e,middle_manager_status:"approved"}:null:e=>e?{...e,final_manager_status:"approved"}:null),se&&J){const t=Number(se.id);Number.isNaN(t)||J(t,t=>"middle"===e?{...t,middle_manager_status:"approved"}:{...t,final_manager_status:"approved"})}w.success(("middle"===e?"ì¤‘ê°„":"ìµœì¢…")+" ìŠ¹ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."),await Xe();const r=q?.(!0,{silent:!0});r instanceof Promise&&await r}catch(r){w.error("ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},yt=async(e,t,a)=>{if(!se||!Je)return void w.error("ì§€ì¶œ ì •ë³´ ì…ë ¥ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");const r=String(e),i="number"==typeof e?e:Number(e);if(Number.isNaN(i))return void n.error("ìœ íš¨í•˜ì§€ ì•Šì€ itemId",{itemId:e});const s=se.items?.find(e=>String(e.id)===r);if(!s)return;const l=se?Number(se.id):NaN;try{Number.isNaN(l)||J?.(l,e=>{const i=(e.items||[]).map(e=>String(e.id)===r?{...e,expenditure_date:t.toISOString(),expenditure_amount:a}:e);return{...e,items:i}}),le(e=>{if(!e)return null;const i=(e.items||e.purchase_request_items||[]).map(e=>String(e.id)===r?{...e,expenditure_date:t.toISOString(),expenditure_amount:a}:e),n=i.reduce((e,t)=>e+(t.expenditure_amount||0),0);return{...e,items:i,purchase_request_items:i,total_expenditure_amount:n,updated_at:(new Date).toISOString()}});const{error:e}=await Me.from("purchase_request_items").update({expenditure_date:t.toISOString(),expenditure_amount:a}).eq("id",i);if(e)throw n.error("ì§€ì¶œ ì •ë³´ DB ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{error:e,itemId:i}),e;const d=(se.items||se.purchase_request_items||[]).reduce((e,t)=>String(t.id)===r?e+a:e+(t.expenditure_amount||0),0);if(await Me.from("purchase_requests").update({total_expenditure_amount:d}).eq("id",l),se?.id){f(se.id,i,t.toISOString(),a)||n.warn("[PurchaseDetailModal] ë©”ëª¨ë¦¬ ìºì‹œ ì§€ì¶œ ì •ë³´ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{purchaseId:se.id,itemId:i})}w.success(`"${s.item_name}" í’ˆëª©ì˜ ì§€ì¶œ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`),await Xe();const o=q?.(!0,{silent:!0});o instanceof Promise&&await o}catch(d){n.error("ì§€ì¶œ ì •ë³´ ì…ë ¥ ì¤‘ ì˜¤ë¥˜",d),w.error("ì§€ì¶œ ì •ë³´ ì…ë ¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},jt=i.jsx("div",{className:"space-y-1 sm:space-y-4",children:ee?i.jsx("div",{className:"flex items-center justify-center py-12",children:i.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-hansl-600"})}):se?i.jsxs("div",{children:[i.jsx("div",{className:"bg-gray-50 rounded-lg p-2 sm:p-3 mb-1 sm:mb-2 border border-gray-100",children:i.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 items-center gap-3 sm:gap-0",children:[i.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-4",children:[i.jsxs("div",{className:"flex items-center gap-3",children:[(()=>{if(!se)return null;if(se.payment_category){const e=se.payment_category.trim();return"ë°œì£¼"===e?i.jsx("span",{className:"badge-stats bg-green-500 text-white",children:"ë°œì£¼"}):"êµ¬ë§¤ìš”ì²­"===e?i.jsx("span",{className:"badge-stats bg-blue-500 text-white",children:"êµ¬ë§¤ìš”ì²­"}):"í˜„ì¥ê²°ì œ"===e?i.jsx("span",{className:"badge-stats bg-gray-500 text-white",children:"í˜„ì¥ê²°ì œ"}):i.jsx("span",{className:"badge-stats bg-blue-500 text-white",children:e})}return i.jsx("span",{className:"badge-stats bg-blue-500 text-white",children:"êµ¬ë§¤ìš”ì²­"})})(),i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("span",{className:"modal-label",children:"ìš”ì²­ì:"}),i.jsx("span",{className:"modal-value",children:se.requester_name})]})]}),i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx(U,{className:"w-3 h-3 text-gray-500"}),i.jsxs("span",{className:"modal-subtitle",children:["ì²­êµ¬ì¼: ",N(se.request_date)]})]})]}),i.jsxs("div",{className:"flex items-center justify-center gap-2 sm:gap-3 flex-wrap",children:[st&&"pending"===se.middle_manager_status&&i.jsx(s,{size:"sm",variant:"outline",onClick:()=>bt("middle"),className:`${dt} border border-gray-400 bg-white hover:bg-gray-50 hover:border-gray-500`,children:"1ì°¨ ìŠ¹ì¸ ëŒ€ê¸°"}),"approved"===se.middle_manager_status&&i.jsxs("div",{className:"button-approved badge-text shadow-sm",children:[i.jsx(R,{className:"w-3 h-3"}),"1ì°¨ ìŠ¹ì¸ì™„ë£Œ"]}),"rejected"===se.middle_manager_status&&i.jsxs("div",{className:"button-rejected badge-text",children:[i.jsx(_,{className:"w-3 h-3"}),"1ì°¨ ë°˜ë ¤"]}),"pending"===se.middle_manager_status&&!st&&i.jsx("div",{className:`${ot} border border-gray-300 text-gray-600 bg-white`,children:"1ì°¨ ìŠ¹ì¸ëŒ€ê¸°"}),lt&&"approved"===se.middle_manager_status&&"pending"===se.final_manager_status&&i.jsxs(s,{size:"sm",variant:"outline",onClick:()=>bt("final"),className:`${dt} border border-gray-400 bg-white hover:bg-gray-50 hover:border-gray-500`,children:[i.jsx(R,{className:"w-3 h-3"}),"ìµœì¢… ìŠ¹ì¸"]}),"approved"===se.final_manager_status&&i.jsxs("div",{className:"button-approved badge-text",children:[i.jsx(R,{className:"w-3 h-3"}),"ìµœì¢… ìŠ¹ì¸ì™„ë£Œ"]}),"rejected"===se.final_manager_status&&i.jsxs("div",{className:"button-rejected badge-text",children:[i.jsx(_,{className:"w-3 h-3"}),"ìµœì¢… ë°˜ë ¤"]}),"approved"!==se.middle_manager_status&&"pending"===se.final_manager_status&&i.jsx("div",{className:`${ot} border border-gray-300 text-gray-600 bg-white`,children:"ìµœì¢… ìŠ¹ì¸ëŒ€ê¸°"})]}),i.jsx("div",{})]})}),i.jsxs("div",{className:"flex flex-col lg:flex-row gap-3 sm:gap-6",children:[i.jsxs("div",{className:"lg:w-80 lg:flex-shrink-0 space-y-1 sm:space-y-4 relative",children:[i.jsxs("div",{className:"bg-white rounded-lg p-2 sm:p-3 border border-gray-100 shadow-sm",children:[i.jsx("div",{className:"mb-3",children:i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsxs("h3",{className:"modal-section-title flex items-center",children:[i.jsx(p,{className:"w-4 h-4 mr-2 text-gray-600"}),se?.purchase_order_number||"POë²ˆí˜¸ ì—†ìŒ"]}),Je&&Be&&"done"===C&&i.jsxs("button",{onClick:async()=>{if(!se)return;const e=!(se.is_utk_checked||!1),t=e?`ë°œì£¼ë²ˆí˜¸: ${se.purchase_order_number}\n\nUTK í™•ì¸ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`:`ë°œì£¼ë²ˆí˜¸: ${se.purchase_order_number}\n\nUTK í™•ì¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;if(window.confirm(t))try{const t=a(),{error:r}=await t.from("purchase_requests").update({is_utk_checked:e}).eq("id",se.id);if(r)return n.error("UTK í™•ì¸ DB ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{error:r,purchaseId:se.id}),void w.error("UTK í™•ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");le(t=>t?{...t,is_utk_checked:e,updated_at:(new Date).toISOString()}:null),se.id&&h(se.id,t=>({...t,is_utk_checked:e})),w.success(e?"UTK í™•ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.":"UTK í™•ì¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."),await Xe();const i=q?.(!0,{silent:!0});i instanceof Promise&&await i}catch(r){n.error("UTK í™•ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜",r),w.error("UTK í™•ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},className:"button-base text-xs px-2 py-1 flex items-center "+(se?.is_utk_checked?"button-toggle-active bg-orange-500 hover:bg-orange-600 text-white":"button-toggle-inactive"),title:se?.is_utk_checked?"UTK í™•ì¸ ì·¨ì†Œ":"UTK í™•ì¸",children:[i.jsx(S,{className:"w-3 h-3 mr-1"}),"UTK ",se?.is_utk_checked?"ì™„ë£Œ":"í™•ì¸"]})]})}),i.jsxs("div",{className:"space-y-2",children:[i.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[i.jsxs("div",{className:"w-32",children:[i.jsx("span",{className:"modal-label",children:"ë°œì£¼ì„œ ì¢…ë¥˜"}),de?i.jsx(A,{value:me?.request_type||"",onChange:e=>ue(t=>t?{...t,request_type:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"ì¼ë°˜"}):i.jsx("p",{className:"modal-value",children:se.request_type||"ì¼ë°˜"})]}),i.jsxs("div",{className:"w-32",children:[i.jsx("span",{className:"modal-label",children:"ê²°ì œ ì¢…ë¥˜"}),de?i.jsx(A,{value:me?.payment_category||"",onChange:e=>ue(t=>t?{...t,payment_category:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"ë°œì£¼/êµ¬ë§¤ìš”ì²­/í˜„ì¥ê²°ì œ"}):i.jsx("p",{className:"modal-value",children:se.payment_category||"-"})]})]}),i.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[i.jsxs("div",{className:"w-32",children:[i.jsx("span",{className:"modal-label",children:"ì…ê³  ìš”ì²­ì¼"}),de?i.jsx(te,{onDateSelect:e=>{ue(t=>t?{...t,delivery_request_date:k(e,"yyyy-MM-dd")}:null)},placeholder:"ì…ê³  ìš”ì²­ì¼ì„ ì„ íƒí•˜ì„¸ìš”",align:"start",side:"bottom",children:i.jsxs(s,{variant:"outline",className:"mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] justify-start text-left font-normal business-radius-input",children:[i.jsx(U,{className:"mr-1 h-3 w-3"}),me?.delivery_request_date?N(me.delivery_request_date):"ë‚ ì§œ ì„ íƒ"]})}):i.jsx("p",{className:"modal-subtitle",children:N(se.delivery_request_date)})]}),i.jsxs("div",{className:"w-32",children:[i.jsx("span",{className:"modal-label text-orange-500",children:"ë³€ê²½ ì…ê³ ì¼"}),de?i.jsx(te,{onDateSelect:e=>{ue(t=>t?{...t,revised_delivery_request_date:k(e,"yyyy-MM-dd")}:null)},placeholder:"ë³€ê²½ ì…ê³ ì¼ì„ ì„ íƒí•˜ì„¸ìš”",align:"start",side:"bottom",children:i.jsxs(s,{variant:"outline",className:"mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] justify-start text-left font-normal business-radius-input",children:[i.jsx(U,{className:"mr-1 h-3 w-3"}),me?.revised_delivery_request_date?N(me.revised_delivery_request_date):"ë‚ ì§œ ì„ íƒ"]})}):i.jsx("p",{className:"modal-subtitle text-orange-700",children:se.revised_delivery_request_date?N(se.revised_delivery_request_date):"ë¯¸ì„¤ì •"})]})]})]})]}),i.jsxs("div",{className:"bg-white rounded-lg p-2 sm:p-3 border border-gray-100 shadow-sm",children:[i.jsxs("h3",{className:"modal-section-title mb-3 flex items-center",children:[i.jsx(g,{className:"w-4 h-4 mr-2 text-gray-600"}),"ì—…ì²´ ì •ë³´"]}),i.jsxs("div",{className:"space-y-2",children:[i.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[i.jsxs("div",{className:"w-32",children:[i.jsx("span",{className:"modal-label",children:"ì—…ì²´ëª…"}),de?i.jsx(L,{options:Ce.map(e=>({value:e.id.toString(),label:e.vendor_name})),value:me?.vendor_id?{value:me.vendor_id.toString(),label:me.vendor_name||Ce.find(e=>e.id===me.vendor_id)?.vendor_name||""}:null,onChange:e=>{if(n.info("ReactSelect onChange:",{option:e}),e){const t=Ce.find(t=>t.id.toString()===e.value);if(n.info("Selected vendor:",{selectedVendor:t}),t){a().from("vendor_contacts").select("id, contact_name, contact_email, contact_phone, position").eq("vendor_id",t.id).then(({data:e,error:a})=>{a&&n.error("ğŸ” ë‹´ë‹¹ì ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:",a),n.info("ğŸ” ì—…ì²´ ë³€ê²½ - ë‹´ë‹¹ì ëª©ë¡ ë¡œë“œ:",{vendor_id:t.id,vendor_name:t.vendor_name,contactsData:e,contactsCount:e?.length||0}),ue(a=>{const r=a?{...a,vendor_id:t.id,vendor_name:t.vendor_name,vendor:t,vendor_contacts:Array.isArray(e)?e:[],contact_id:void 0,contact_name:void 0}:null;return n.info("ğŸ” ì—…ì²´ ë³€ê²½ - editedPurchase ì—…ë°ì´íŠ¸ ì™„ë£Œ:",{vendor_id:t.id,vendor_name:t.vendor_name,contactsData:e,updated_vendor_contacts:r?.vendor_contacts,updated_full:r}),r})})}}else ue(e=>e?{...e,vendor_id:void 0,vendor_name:"",vendor:void 0,vendor_contacts:[],contact_id:void 0,contact_name:void 0}:null)},placeholder:"ì—…ì²´ ì„ íƒ",isClearable:!0,isSearchable:!0,menuPortalTarget:document.body,styles:{control:e=>({...e,minHeight:"20px",height:"20px",fontSize:"10px",borderRadius:"8px",borderColor:"#e5e7eb",borderWidth:"1px",backgroundColor:"#ffffff",boxShadow:"none",paddingLeft:"6px",paddingRight:"6px","&:hover":{borderColor:"#e5e7eb"},"&:focus-within":{borderColor:"#60a5fa",boxShadow:"none",outline:"none"}}),valueContainer:e=>({...e,height:"18px",padding:"0 2px",margin:"0"}),input:e=>({...e,margin:"0",padding:"0",fontSize:"10px"}),indicatorsContainer:e=>({...e,height:"18px",padding:"0"}),indicatorSeparator:()=>({display:"none"}),dropdownIndicator:e=>({...e,padding:"0 2px",svg:{width:"12px",height:"12px"}}),clearIndicator:e=>({...e,padding:"0 2px",svg:{width:"12px",height:"12px"}}),option:e=>({...e,fontSize:"10px",padding:"4px 8px"}),menuPortal:e=>({...e,zIndex:9999})},classNamePrefix:"vendor-select"}):i.jsx("p",{className:"modal-value",children:se.vendor?.vendor_name||"-"})]}),i.jsxs("div",{className:"w-32",children:[i.jsx("span",{className:"modal-label",children:"ì—…ì²´ ë‹´ë‹¹ì"}),de?me?.vendor_id?i.jsx(L,{options:(()=>{const e=Array.isArray(me.vendor_contacts)?me.vendor_contacts:[],t=e.filter((e,t,a)=>a.findIndex(t=>t.id===e.id)===t),a=t.filter((e,t,a)=>a.findIndex(t=>t.contact_name===e.contact_name)===t),r=a.map(e=>({value:e.id.toString(),label:e.contact_name||""}))||[];return n.info("ğŸ” ë‹´ë‹¹ì ë“œë¡­ë‹¤ìš´ ì˜µì…˜:",{vendor_id:me.vendor_id,vendor_contacts_raw:me.vendor_contacts,vendor_contacts_count:e.length,unique_by_id_count:t.length,final_unique_count:a.length,options:r}),r})(),value:(()=>{const e=(Array.isArray(me.vendor_contacts)?me.vendor_contacts:[])[0];return e?.id?{value:e.id.toString(),label:e.contact_name||""}:null})(),onChange:e=>{if(n.info("ğŸ” ë‹´ë‹¹ì ì„ íƒ ë³€ê²½:",{option:e}),e){const t=Array.isArray(me.vendor_contacts)?me.vendor_contacts:[],a=t.find(t=>t.id.toString()===e.value);a&&ue(e=>e?{...e,contact_id:a.id,contact_name:a.contact_name,vendor_contacts:[a,...t.filter(e=>e.id!==a.id)]}:null)}else ue(e=>e?{...e,contact_id:void 0,contact_name:void 0,vendor_contacts:Array.isArray(me.vendor_contacts)?me.vendor_contacts:[]}:null)},placeholder:"ë‹´ë‹¹ìë¥¼ ì„ íƒí•˜ì„¸ìš”",isClearable:!0,isSearchable:!0,noOptionsMessage:()=>"ë‹´ë‹¹ìê°€ ì—†ìŠµë‹ˆë‹¤",menuPortalTarget:document.body,styles:{control:e=>({...e,minHeight:"20px",height:"20px",fontSize:"10px",borderRadius:"8px",borderColor:"#e5e7eb",borderWidth:"1px",backgroundColor:"#ffffff",boxShadow:"none",paddingLeft:"6px",paddingRight:"6px","&:hover":{borderColor:"#e5e7eb"},"&:focus-within":{borderColor:"#60a5fa",boxShadow:"none",outline:"none"}}),valueContainer:e=>({...e,height:"18px",padding:"0 2px",margin:"0"}),input:e=>({...e,margin:"0",padding:"0",fontSize:"10px"}),indicatorsContainer:e=>({...e,height:"18px",padding:"0"}),indicatorSeparator:()=>({display:"none"}),dropdownIndicator:e=>({...e,padding:"0 2px",svg:{width:"12px",height:"12px"}}),clearIndicator:e=>({...e,padding:"0 2px",svg:{width:"12px",height:"12px"}}),option:e=>({...e,fontSize:"10px",padding:"4px 8px"}),menuPortal:e=>({...e,zIndex:9999})},classNamePrefix:"contact-select"}):i.jsx(A,{value:"",disabled:!0,className:"mt-1 rounded-lg border-gray-200 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"ì—…ì²´ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”"}):i.jsx("p",{className:"modal-value",children:(()=>{const e=Array.isArray(se.vendor_contacts)?se.vendor_contacts:[],t=se.contact_name||e[0]?.contact_name||"-";return n.info("ğŸ” vendor_contacts display ë Œë”ë§:",{purchase_id:se?.id,vendor_id:se?.vendor_id,contact_id:se?.contact_id,vendor_contacts:se.vendor_contacts,purchase_contact_name:se.contact_name,contactName:t,purchase_full:se}),t})()})]})]}),i.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[i.jsxs("div",{className:"w-32",children:[i.jsx("span",{className:"modal-label",children:"PJì—…ì²´"}),de?i.jsx(A,{value:me?.project_vendor||"",onChange:e=>ue(t=>t?{...t,project_vendor:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"ì…ë ¥"}):i.jsx("p",{className:"modal-value",children:se.project_vendor||"-"})]}),i.jsxs("div",{className:"w-32",children:[i.jsx("span",{className:"modal-label",children:"Item"}),de?i.jsx(A,{value:me?.project_item||"",onChange:e=>ue(t=>t?{...t,project_item:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"ì…ë ¥"}):i.jsx("p",{className:"modal-subtitle",children:se.project_item||"-"})]})]}),i.jsx("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:i.jsxs("div",{className:"w-32",children:[i.jsx("span",{className:"modal-label",children:"ìˆ˜ì£¼ë²ˆí˜¸"}),de?i.jsx(A,{value:me?.sales_order_number||"",onChange:e=>ue(t=>t?{...t,sales_order_number:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"ì…ë ¥"}):i.jsx("p",{className:"modal-subtitle",children:se.sales_order_number||"-"})]})})]})]})]}),i.jsx("div",{className:"lg:w-fit lg:min-w-0 relative overflow-visible",children:i.jsxs("div",{className:"bg-white rounded-lg border border-gray-100 shadow-sm",children:[i.jsxs("div",{className:"p-2 sm:p-3 bg-gray-50 border-b border-gray-100 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-0",children:[i.jsxs("h3",{className:"modal-section-title flex items-center",children:[i.jsx(x,{className:"w-4 h-4 mr-2 text-gray-600"}),"í’ˆëª© ë¦¬ìŠ¤íŠ¸",i.jsxs("span",{className:"ml-2 badge-stats bg-gray-500 text-white",children:[ze?.length||0,"ê°œ"]})]}),!de&&i.jsxs(i.Fragment,{children:["purchase"===C&&Ke&&i.jsxs(s,{size:"sm",onClick:async()=>{if(!se||!Ke)return;const e=`ë°œì£¼ë²ˆí˜¸: ${se.purchase_order_number}\n\nì „ì²´ êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;if(window.confirm(e)){se&&Number(se.id);try{const e=se.purchase_request_items||[],t=e.filter(e=>!e.is_payment_completed);if(0===t.length)return void w.info("ëª¨ë“  í’ˆëª©ì´ ì´ë¯¸ êµ¬ë§¤ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");n.info(`ì „ì²´ êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬: ${t.length}ê°œ í’ˆëª© (ì´ ${e.length}ê°œ ì¤‘)`);for(const r of t){const e={is_payment_completed:!0,payment_completed_at:(new Date).toISOString()},{error:t}=await Me.from("purchase_request_items").update(e).eq("id",r.id);if(t)throw t;v(se.id,r.id)||n.warn("[PurchaseDetailModal] ë©”ëª¨ë¦¬ ìºì‹œ ê°œë³„ í’ˆëª© êµ¬ë§¤ì™„ë£Œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{purchaseId:se.id,itemId:r.id})}w.success(`${t.length}ê°œ í’ˆëª©ì´ êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`),await Xe();const a=q?.(!0,{silent:!0});a instanceof Promise&&await a}catch(t){n.error("ì „ì²´ êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ ì˜¤ë¥˜",t),w.error("êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}}},className:"button-base bg-orange-500 hover:bg-orange-600 text-white",children:[i.jsx(B,{className:"w-3 h-3 mr-1"}),"ì „ì²´ êµ¬ë§¤ì™„ë£Œ"]}),"receipt"===C&&He&&i.jsx(re,{onConfirm:async(e,t)=>{if(!se||!He)return;const a=`ë°œì£¼ë²ˆí˜¸: ${se.purchase_order_number}\n\nì „ì²´ ì…ê³ ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;if(!window.confirm(a))return;const r=se?Number(se.id):NaN;try{const a=se.purchase_request_items||[],i=a.filter(e=>!e.is_received),s=()=>{Number.isNaN(r)||J?.(r,a=>{const r=(a.items||[]).map(a=>i.find(e=>String(e.id)===String(a.id))?{...a,is_received:!0,actual_received_date:a.actual_received_date||e.toISOString(),received_quantity:void 0!==t?t:a.quantity}:a),n=(a.purchase_request_items||[]).map(a=>i.find(e=>String(e.id)===String(a.id))?{...a,is_received:!0,actual_received_date:a.actual_received_date||e.toISOString(),received_quantity:void 0!==t?t:a.quantity}:a);return{...a,items:r,purchase_request_items:n,is_received:!0,received_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}})};if(0===i.length)return void w.info("ëª¨ë“  í’ˆëª©ì´ ì´ë¯¸ ì…ê³ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");n.info(`ì „ì²´ ì…ê³ ì™„ë£Œ ì²˜ë¦¬: ${i.length}ê°œ í’ˆëª© (ì´ ${a.length}ê°œ ì¤‘)`),s(),le(a=>{if(!a)return null;const r=a.items?.map(a=>i.find(e=>String(e.id)===String(a.id))?{...a,is_received:!0,received_at:(new Date).toISOString(),actual_received_date:e.toISOString(),received_quantity:void 0!==t?t:a.quantity}:a)||[],n=a.purchase_request_items?.map(a=>i.find(e=>String(e.id)===String(a.id))?{...a,is_received:!0,received_at:(new Date).toISOString(),actual_received_date:e.toISOString(),received_quantity:void 0!==t?t:a.quantity}:a)||[],s=r.length,l=r.filter(e=>e.is_received).length,d=s>0&&l===s;return{...a,items:r,purchase_request_items:n,is_received:d,received_at:d?(new Date).toISOString():a.received_at,updated_at:(new Date).toISOString()}});for(const r of i){const a={actual_received_date:e.toISOString(),is_received:!0,received_quantity:void 0!==t?t:r.quantity},{error:i}=await Me.from("purchase_request_items").update(a).eq("id",r.id);if(i)throw i;const s=void 0!==t?t:r.quantity;l(se.id,r.id,e.toISOString(),s)||n.warn("[PurchaseDetailModal] ë©”ëª¨ë¦¬ ìºì‹œ ê°œë³„ í’ˆëª© ì…ê³ ì™„ë£Œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{purchaseId:se.id,itemId:r.id})}w.success(`${i.length}ê°œ í’ˆëª©ì´ ì…ê³ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`),await Xe();const d=q?.(!0,{silent:!0});d instanceof Promise&&await d}catch(i){n.error("ì „ì²´ ì…ê³ ì™„ë£Œ ì²˜ë¦¬ ì˜¤ë¥˜",i),w.error("ì…ê³ ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},placeholder:"ì…ê³ ì¼ì„ ì„ íƒí•˜ì„¸ìš”",align:"end",side:"bottom",hideQuantityInput:!0,quantityInfoText:"ìš”ì²­ì…ê³ ìˆ˜ëŸ‰ê³¼ ë™ì¼í•œ ìˆ˜ëŸ‰ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤",children:i.jsxs(s,{size:"sm",className:"button-base button-action-primary",children:[i.jsx(Q,{className:"w-3 h-3 mr-1"}),"ì „ì²´ ì…ê³ ì™„ë£Œ"]})}),"done"===C&&Je&&Be&&"ë°œì£¼"===se.payment_category&&i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx(te,{onDateSelect:async e=>{if(!se||!Je)return;e.toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"});const t=`ë°œì£¼ë²ˆí˜¸: ${se.purchase_order_number}\n\nì „ì²´ ê±°ë˜ëª…ì„¸ì„œ í™•ì¸ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;if(!window.confirm(t))return;const a=e.toISOString();se&&Number(se.id);try{const e=se.purchase_request_items||[],t=e.filter(e=>!e.is_statement_received);if(0===t.length)return void w.info("ëª¨ë“  í’ˆëª©ì˜ ê±°ë˜ëª…ì„¸ì„œê°€ ì´ë¯¸ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.");n.info(`ì „ì²´ ê±°ë˜ëª…ì„¸ì„œ í™•ì¸ ì²˜ë¦¬: ${t.length}ê°œ í’ˆëª© (ì´ ${e.length}ê°œ ì¤‘)`);for(const i of t){const e={is_statement_received:!0,statement_received_date:a,statement_received_by_name:fe||null},{error:t}=await Me.from("purchase_request_items").update(e).eq("id",i.id);if(t)throw t;d(se.id,i.id,a,fe||void 0)||n.warn("[PurchaseDetailModal] ë©”ëª¨ë¦¬ ìºì‹œ ê°œë³„ í’ˆëª© ê±°ë˜ëª…ì„¸ì„œ í™•ì¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{purchaseId:se.id,itemId:i.id})}w.success(`${t.length}ê°œ í’ˆëª©ì˜ ê±°ë˜ëª…ì„¸ì„œ í™•ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`),await Xe();const r=q?.(!0,{silent:!0});r instanceof Promise&&await r}catch(r){n.error("ì „ì²´ ê±°ë˜ëª…ì„¸ì„œ í™•ì¸ ì²˜ë¦¬ ì˜¤ë¥˜",r),w.error("ê±°ë˜ëª…ì„¸ì„œ í™•ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},placeholder:"ì „ì²´ íšŒê³„ìƒ ì…ê³ ì¼ì„ ì„ íƒí•˜ì„¸ìš”",align:"end",side:"bottom",children:i.jsxs(s,{size:"sm",className:"button-base button-action-primary",children:[i.jsx(p,{className:"w-3 h-3 mr-1"}),"ê±°ë˜ëª…ì„¸ì„œ í™•ì¸"]})}),"ë°œì£¼"===se.payment_category&&i.jsx(ae,{onConfirm:async(e,t)=>{if(!se||!Je)return void w.error("ì§€ì¶œ ì •ë³´ ì…ë ¥ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");const a=`ë°œì£¼ë²ˆí˜¸: ${se.purchase_order_number}\n\nì¼ê´„ ì§€ì¶œ ì •ë³´ë¥¼ ì…ë ¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në‚ ì§œ: ${e.toLocaleDateString("ko-KR")}\nê¸ˆì•¡: ${t.toLocaleString()}ì›`;if(!window.confirm(a))return;const r=se?Number(se.id):NaN;try{Number.isNaN(r)||J?.(r,a=>{const r=(a.items||[]).map(a=>a.expenditure_date&&a.expenditure_amount?a:{...a,expenditure_date:e.toISOString(),expenditure_amount:t});return{...a,items:r}});const a=se.items||se.purchase_request_items||[],i=a.filter(e=>!e.expenditure_date||!e.expenditure_amount);if(0===i.length)return void w.info("ëª¨ë“  í’ˆëª©ì— ì´ë¯¸ ì§€ì¶œ ì •ë³´ê°€ ì…ë ¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.");le(a=>{if(!a)return null;const r=(a.items||a.purchase_request_items||[]).map(a=>a.expenditure_date&&a.expenditure_amount?a:{...a,expenditure_date:e.toISOString(),expenditure_amount:t}),i=r.reduce((e,t)=>e+(t.expenditure_amount||0),0);return{...a,items:r,purchase_request_items:r,total_expenditure_amount:i,updated_at:(new Date).toISOString()}});for(const r of i){const{error:a}=await Me.from("purchase_request_items").update({expenditure_date:e.toISOString(),expenditure_amount:t}).eq("id",r.id);if(a)throw n.error("ì¼ê´„ ì§€ì¶œ ì •ë³´ DB ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{error:a,itemId:r.id}),a}const s=a.reduce((e,a)=>i.find(e=>e.id===a.id)?e+t:e+(a.expenditure_amount||0),0);await Me.from("purchase_requests").update({total_expenditure_amount:s}).eq("id",r);for(const r of i){f(se.id,r.id,e.toISOString(),t)||n.warn("[PurchaseDetailModal] ë©”ëª¨ë¦¬ ìºì‹œ ì¼ê´„ ì§€ì¶œ ì •ë³´ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{purchaseId:se.id,itemId:r.id})}const l=u(se.id);if(l){const e=l.items&&l.items.length>0?l.items:l.purchase_request_items||[],t=e.reduce((e,t)=>e+(t.expenditure_amount||0),0);le(a=>({...a,items:e,purchase_request_items:e,total_expenditure_amount:t}))}w.success(`${i.length}ê°œ í’ˆëª©ì˜ ì§€ì¶œ ì •ë³´ê°€ ì¼ê´„ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.`),await Xe();const d=q?.(!0,{silent:!0});d instanceof Promise&&await d}catch(i){n.error("ì¼ê´„ ì§€ì¶œ ì •ë³´ ì…ë ¥ ì¤‘ ì˜¤ë¥˜",i),w.error("ì¼ê´„ ì§€ì¶œ ì •ë³´ ì…ë ¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},placeholder:"ì¼ê´„ ì§€ì¶œ ë‚ ì§œì™€ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”",align:"end",side:"bottom",children:i.jsxs(s,{size:"sm",className:"button-base button-action-primary",children:[i.jsx(H,{className:"w-3 h-3 mr-1"}),"ì¼ê´„ì§€ì¶œ"]})})]})]})]}),i.jsx("div",{className:"block sm:hidden bg-gray-50 px-2 py-1 border-b border-gray-100",children:i.jsx("div",{className:"text-xs font-medium text-gray-600",children:"í’ˆëª© ëª©ë¡ (í„°ì¹˜í•˜ì—¬ ìŠ¤í¬ë¡¤)"})}),i.jsx("div",{className:"max-h-[50vh] sm:max-h-[40vh] overflow-auto",children:i.jsxs("div",{className:"w-fit",children:[i.jsx("div",{className:"bg-gray-50 px-2 sm:px-3 py-1 border-b border-gray-100 sticky top-0 z-10 w-fit",children:i.jsxs("div",{ref:Pe,className:"hidden sm:grid gap-1 modal-label w-fit",style:{gridTemplateColumns:ut()},children:[i.jsx("div",{children:"í’ˆëª©ëª…"}),i.jsx("div",{children:"ê·œê²©"}),i.jsx("div",{className:"text-center",children:"receipt"!==C&&"done"!==C||de?"ìš”ì²­ìˆ˜ëŸ‰":i.jsxs("div",{className:"flex flex-col items-center leading-tight",children:[i.jsx("div",{className:"text-[9px]",children:"ìš”ì²­/ì‹¤ì œ"}),i.jsx("div",{className:"text-[10px]",children:"ì…ê³ ìˆ˜ëŸ‰"})]})}),i.jsx("div",{className:"text-right",children:"ë‹¨ê°€"}),i.jsx("div",{className:"text-right",children:"í•©ê³„"}),"ë°œì£¼"===se.payment_category&&i.jsx("div",{className:"text-right",children:"ì„¸ì•¡"}),i.jsx("div",{className:"text-center",children:"ë¹„ê³ "}),de?i.jsxs(i.Fragment,{children:[i.jsx("div",{className:"text-center",children:"ì‚­ì œ"}),"receipt"===C&&i.jsx(i.Fragment,{children:i.jsx("div",{className:"text-center",children:"ì‹¤ì œì…ê³ ì¼"})}),"done"===C&&i.jsx(i.Fragment,{children:"ë°œì£¼"===se.payment_category&&i.jsxs(i.Fragment,{children:[i.jsx("div",{className:"text-center",children:"ê±°ë˜ëª…ì„¸ì„œ í™•ì¸"}),i.jsx("div",{className:"text-center",children:"íšŒê³„ìƒ ì…ê³ ì¼"}),i.jsx("div",{className:"text-center",children:"ì§€ì¶œì •ë³´"})]})})]}):i.jsxs(i.Fragment,{children:[i.jsx("div",{className:"text-center",children:"purchase"===C?"êµ¬ë§¤ìƒíƒœ":"receipt"===C||"done"===C?"ì…ê³ ìƒíƒœ":"ìƒíƒœ"}),"done"===C&&i.jsx(i.Fragment,{children:"ë°œì£¼"===se.payment_category&&i.jsxs(i.Fragment,{children:[i.jsx("div",{className:"text-center",children:"ê±°ë˜ëª…ì„¸ì„œ í™•ì¸"}),i.jsx("div",{className:"text-center",children:"íšŒê³„ìƒ ì…ê³ ì¼"}),i.jsx("div",{className:"text-center",children:"ì§€ì¶œì •ë³´"})]})}),"receipt"===C&&i.jsx(i.Fragment,{children:i.jsx("div",{className:"text-center",children:"ì‹¤ì œì…ê³ ì¼"})})]})]})}),i.jsx("div",{className:"divide-y divide-gray-100 overflow-visible w-fit",children:(de?_e:ze)?.map((e,t)=>i.jsxs("div",{className:"px-2 sm:px-3 py-1 border-b border-gray-50 hover:bg-gray-50/50 relative overflow-visible",children:[i.jsxs("div",{className:"hidden sm:grid items-center gap-1 overflow-visible w-fit",style:{gridTemplateColumns:ut()},children:[i.jsx("div",{className:"min-w-0 relative overflow-visible flex items-center",children:de?i.jsx(A,{value:e.item_name,onChange:e=>gt(t,"item_name",e.target.value),onFocus:()=>we(`item_name_${t}`),onBlur:()=>we(null),className:"modal-label border-gray-200 rounded-lg w-full !px-1.5 !py-0.5 !text-[10px] focus:border-blue-400 transition-all duration-200 "+(Ne===`item_name_${t}`?"!h-auto !min-h-[20px] !absolute !z-[9999] !bg-white !shadow-lg !left-0 !right-0 !-translate-y-1/2 !top-1/2 !whitespace-normal":"!h-5 !truncate"),placeholder:"í’ˆëª©ëª…",disabled:Ue&&!Le}):i.jsx("div",{className:"modal-value",style:{whiteSpace:"normal",wordBreak:"break-all",overflowWrap:"break-word",hyphens:"none",WebkitHyphens:"none",MozHyphens:"none",msHyphens:"none",lineHeight:"1.4",maxHeight:"2.8em",overflow:"hidden",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical"},title:e.item_name||"í’ˆëª©ëª… ì—†ìŒ",children:e.item_name||"í’ˆëª©ëª… ì—†ìŒ"})}),i.jsx("div",{className:"min-w-0 relative overflow-visible flex items-center",style:{width:"200px",maxWidth:"200px",minWidth:"200px"},children:de?i.jsx(A,{value:e.specification,onChange:e=>gt(t,"specification",e.target.value),onFocus:()=>we(`specification_${t}`),onBlur:()=>we(null),className:"modal-label border-gray-200 rounded-lg w-full !px-1.5 !py-0.5 !text-[10px] focus:border-blue-400 transition-all duration-200 "+(Ne===`specification_${t}`?"!h-auto !min-h-[20px] !absolute !z-[9999] !bg-white !shadow-lg !left-1/2 !-translate-x-1/2 !-translate-y-1/2 !top-1/2 !whitespace-normal !w-[300px]":"!h-5 !truncate"),placeholder:"ê·œê²©",disabled:Ue&&!Le}):i.jsx("div",{className:"text-[11px] text-gray-600 font-medium",style:{whiteSpace:"normal",wordBreak:"break-all",overflowWrap:"break-word",hyphens:"none",WebkitHyphens:"none",MozHyphens:"none",msHyphens:"none",lineHeight:"1.4",maxHeight:"2.8em",overflow:"hidden",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical"},title:e.specification||"-",children:e.specification||"-"})}),i.jsx("div",{className:"text-center min-w-0 flex items-center justify-center",children:de?"receipt"===C||"done"===C?i.jsxs("div",{className:"flex flex-col items-center gap-0.5 w-full",children:[i.jsx(A,{type:"number",value:e.quantity,onChange:e=>gt(t,"quantity",Number(e.target.value)),className:"border-gray-200 rounded-lg text-center w-full !h-5 !px-1.5 !py-0.5 !text-[9px] font-normal text-gray-600 focus:border-blue-400",placeholder:"ìš”ì²­ìˆ˜ëŸ‰",max:"99999"}),i.jsxs("div",{className:"flex items-center gap-0.5 w-full",children:[i.jsx("span",{className:"text-[9px] text-gray-500",children:"/"}),i.jsx(A,{type:"number",value:e.received_quantity??"",onChange:e=>gt(t,"received_quantity",e.target.value?Number(e.target.value):null),className:"border-gray-200 rounded-lg text-center flex-1 !h-5 !px-1.5 !py-0.5 !text-[9px] font-normal text-gray-600 focus:border-blue-400",placeholder:"ì‹¤ì œì…ê³ ",max:"99999"})]})]}):i.jsx(A,{type:"number",value:e.quantity,onChange:e=>gt(t,"quantity",Number(e.target.value)),className:"border-gray-200 rounded-lg text-center w-full !h-5 !px-1.5 !py-0.5 !text-[9px] font-normal text-gray-600 focus:border-blue-400",placeholder:"ìˆ˜ëŸ‰",max:"99999"}):"receipt"===C||"done"===C?(()=>{const t=e.quantity||0,a=e.received_quantity??0,r=a>0;return t>=100||a>=100?i.jsxs("div",{className:"flex flex-col items-center leading-tight",children:[i.jsx("div",{className:"modal-subtitle "+(r?"text-gray-400":""),children:t}),i.jsxs("div",{className:"modal-subtitle "+(r?"":"text-gray-400"),children:["/",a]})]}):i.jsxs("span",{className:"modal-subtitle",children:[i.jsx("span",{className:r?"text-gray-400":"",children:t}),i.jsxs("span",{className:r?"":"text-gray-400",children:["/",a]})]})})():i.jsx("span",{className:"modal-subtitle",children:e.quantity||0})}),i.jsx("div",{className:"text-right min-w-0 flex items-center justify-end",children:de?i.jsx(A,{type:"number",value:e.unit_price_value,onChange:e=>gt(t,"unit_price_value",Number(e.target.value)),className:"border-gray-200 rounded-lg text-right w-full !h-5 !px-1.5 !py-0.5 !text-[9px] font-normal text-gray-600 focus:border-blue-400",placeholder:"ë‹¨ê°€",max:"100000000000"}):i.jsx("span",{className:"modal-subtitle",children:"done"!==C||Be?`â‚©${ht(e.unit_price_value)}`:"-"})}),i.jsx("div",{className:"text-right min-w-0 flex items-center justify-end",children:i.jsx("span",{className:de?"modal-subtitle":"modal-value",children:"done"!==C||Be?`â‚©${ht(e.amount_value||0)}`:"-"})}),"ë°œì£¼"===se?.payment_category&&i.jsx("div",{className:"text-right min-w-0 flex items-center justify-end",children:i.jsx("span",{className:de?"modal-subtitle":"modal-value",children:"done"!==C||Be?`â‚©${ht(e.tax_amount_value||0)}`:"-"})}),i.jsx("div",{className:"min-w-0 flex justify-center items-center text-center relative overflow-visible",style:{width:"150px",maxWidth:"150px",minWidth:"150px"},children:de?i.jsx(A,{value:e.remark||"",disabled:Ue&&!Le,onChange:e=>gt(t,"remark",e.target.value),onFocus:()=>we(`remark_${t}`),onBlur:()=>we(null),className:"modal-label border-gray-200 rounded-lg text-center w-full !px-1.5 !py-0.5 !text-[10px] focus:border-blue-400 transition-all duration-200 "+(Ne===`remark_${t}`?"!h-auto !min-h-[20px] !absolute !z-[9999] !bg-white !shadow-lg !left-0 !right-0 !-translate-y-1/2 !top-1/2 !whitespace-normal !text-left":"!h-5 !truncate"),placeholder:"ë¹„ê³ "}):i.jsx("div",{className:"text-[11px] text-gray-600 font-medium",style:{width:"150px",maxWidth:"150px",minWidth:"150px",boxSizing:"border-box",whiteSpace:"normal",wordBreak:"break-all",overflowWrap:"break-word",hyphens:"none",WebkitHyphens:"none",MozHyphens:"none",msHyphens:"none",lineHeight:"1.4",maxHeight:"2.8em",overflow:"hidden",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical"},title:e.remark||"-",children:e.remark||"-"})}),"pending"!==C&&i.jsx("div",{className:"text-center flex justify-center items-center",children:de?i.jsx(s,{size:"sm",variant:"ghost",onClick:()=>xt(t),className:"text-red-600 hover:bg-red-50 rounded-lg p-1 h-6 w-6",children:i.jsx(V,{className:"w-3 h-3"})}):i.jsxs(i.Fragment,{children:["purchase"===C&&i.jsx("div",{className:"flex justify-center",children:Ke?i.jsx("button",{onClick:()=>vt(e.id,!e.is_payment_completed),className:""+(e.is_payment_completed?"button-toggle-active bg-orange-500 hover:bg-orange-600 text-white":"button-toggle-inactive"),children:e.is_payment_completed?"êµ¬ë§¤ì™„ë£Œ":"êµ¬ë§¤ëŒ€ê¸°"}):i.jsx("span",{className:""+(e.is_payment_completed?"button-toggle-active bg-orange-500 text-white":"button-waiting-inactive"),children:e.is_payment_completed?"êµ¬ë§¤ì™„ë£Œ":"êµ¬ë§¤ëŒ€ê¸°"})}),"receipt"===C&&i.jsx("div",{className:"flex justify-center",children:He?nt.isCompleted(e)?i.jsx("button",{onClick:()=>{nt.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-action-primary",children:nt.config.completedText}):i.jsx(re,{onConfirm:(t,a)=>{ft(e.id,t,a)},placeholder:"ë‚ ì§œì™€ ì‹¤ì œì…ê³ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”",align:"center",side:"bottom",defaultQuantity:e.received_quantity??void 0,maxQuantity:e.quantity,children:i.jsx("button",{className:"button-toggle-inactive",children:nt.config.waitingText})}):i.jsx("span",{className:""+(nt.isCompleted(e)?"button-action-primary":"button-waiting-inactive"),children:nt.isCompleted(e)?nt.config.completedText:nt.config.waitingText})}),"done"===C&&i.jsx("div",{className:"flex justify-center",children:i.jsx("span",{className:"button-base "+(nt.isCompleted(e)?"bg-blue-500 hover:bg-blue-600 text-white":"border border-gray-300 text-gray-600 bg-white hover:bg-gray-50"),children:nt.isCompleted(e)?"ì…ê³ ì™„ë£Œ":"ì…ê³ ëŒ€ê¸°"})}),"purchase"!==C&&"receipt"!==C&&"done"!==C&&i.jsx("div",{className:"flex justify-center",children:i.jsx("span",{className:"badge-text",children:"-"})})]})}),"receipt"===C&&i.jsx("div",{className:"text-center flex justify-center items-center pl-2",children:nt.getCompletedDate(e)?i.jsx("div",{className:"modal-subtitle text-green-700",children:new Date(nt.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})}):i.jsx("span",{className:"modal-subtitle text-gray-400",children:"-"})}),"done"===C&&"ë°œì£¼"===se.payment_category&&i.jsx("div",{className:"text-center flex justify-center items-center",children:Je?it.isCompleted(e)?i.jsx("button",{onClick:()=>{it.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-action-primary hover:bg-green-600",title:"í´ë¦­í•˜ì—¬ ê±°ë˜ëª…ì„¸ì„œ í™•ì¸ ì·¨ì†Œ",children:it.config.completedText}):i.jsx(te,{onDateSelect:t=>{it.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"íšŒê³„ìƒ ì…ê³ ì¼ì„ ì„ íƒí•˜ì„¸ìš”",align:"center",side:"bottom",children:i.jsx("button",{className:"button-toggle-inactive",onClick:()=>{},children:it.config.waitingText})}):i.jsx("span",{className:""+(it.isCompleted(e)?"button-action-primary":"button-waiting-inactive"),children:it.isCompleted(e)?it.config.completedText:it.config.waitingText})}),"done"===C&&"ë°œì£¼"===se.payment_category&&i.jsx("div",{className:"text-center flex justify-center items-center",children:it.getCompletedDate(e)?i.jsx("div",{className:"modal-subtitle text-blue-700",children:new Date(it.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})}):i.jsx("span",{className:"modal-subtitle text-gray-400",children:"-"})}),"done"===C&&"ë°œì£¼"===se.payment_category&&i.jsx("div",{className:"text-center flex justify-center items-center",children:(()=>{const t=e.expenditure_date&&null!==e.expenditure_amount&&void 0!==e.expenditure_amount;return Je?t?i.jsxs("div",{className:"w-full px-1 leading-none",children:[i.jsx("div",{className:"text-blue-700 text-[9px] leading-[1.1] font-normal",children:(()=>{const t=new Date(e.expenditure_date);return`${t.getFullYear().toString().slice(-2)}.${(t.getMonth()+1).toString().padStart(2,"0")}.${t.getDate().toString().padStart(2,"0")}`})()}),i.jsx("div",{className:"text-gray-700 text-[9px] leading-[1.1] font-normal",children:Be?`â‚©${Number(e.expenditure_amount).toLocaleString()}`:"-"})]}):i.jsx(ae,{onConfirm:(t,a)=>yt(e.id,t,a),placeholder:"ì§€ì¶œ ë‚ ì§œì™€ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”",align:"center",side:"bottom",children:i.jsx("button",{className:"button-toggle-inactive",children:"ì§€ì¶œì…ë ¥"})}):t?i.jsxs("div",{className:"w-full px-1 leading-none",children:[i.jsx("div",{className:"text-blue-700 text-[9px] leading-[1.1] font-normal",children:(()=>{const t=new Date(e.expenditure_date);return`${t.getFullYear().toString().slice(-2)}.${(t.getMonth()+1).toString().padStart(2,"0")}.${t.getDate().toString().padStart(2,"0")}`})()}),i.jsx("div",{className:"text-gray-700 text-[9px] leading-[1.1] font-normal",children:Be?`â‚©${Number(e.expenditure_amount).toLocaleString()}`:"-"})]}):i.jsx("span",{className:"modal-subtitle text-gray-400",children:"-"})})()})]}),i.jsxs("div",{className:"block sm:hidden space-y-2",children:[i.jsxs("div",{className:"flex justify-between items-start",children:[i.jsxs("div",{className:"flex-1 min-w-0 relative",children:[de?i.jsx(A,{value:e.item_name,onChange:e=>gt(t,"item_name",e.target.value),onFocus:()=>we(`m_item_name_${t}`),onBlur:()=>we(null),className:"modal-label border-gray-200 rounded-lg w-full !px-1.5 !py-0.5 !text-[10px] focus:border-blue-400 transition-all duration-200 "+(Ne===`m_item_name_${t}`?"!h-auto !min-h-[20px] !absolute !z-[9999] !bg-white !shadow-lg !left-0 !right-0 !-translate-y-1/2 !top-1/2 !whitespace-normal":"!h-5 !truncate"),placeholder:"í’ˆëª©ëª…",disabled:Ue&&!Le}):i.jsx("div",{className:"modal-value font-medium",children:e.item_name||"í’ˆëª©ëª… ì—†ìŒ"}),de?i.jsx(A,{value:e.specification,onChange:e=>gt(t,"specification",e.target.value),onFocus:()=>we(`m_specification_${t}`),onBlur:()=>we(null),className:"modal-label border-gray-200 rounded-lg mt-1 w-full !px-1.5 !py-0.5 !text-[10px] focus:border-blue-400 transition-all duration-200 "+(Ne===`m_specification_${t}`?"!h-auto !min-h-[20px] !absolute !z-[9999] !bg-white !shadow-lg !left-0 !right-0 !-translate-y-1/2 !top-1/2 !whitespace-normal !w-full":"!h-5 !truncate"),placeholder:"ê·œê²©",disabled:Ue&&!Le}):i.jsx("div",{className:"modal-subtitle text-gray-500",children:e.specification||"-"})]}),i.jsx("div",{className:"ml-3 text-right flex-shrink-0",children:i.jsxs("div",{className:(de?"modal-subtitle":"modal-value")+" font-semibold",children:["â‚©",ht(e.amount_value||0)]})})]}),i.jsxs("div",{className:"grid grid-cols-3 gap-2 text-sm",children:[i.jsxs("div",{children:[i.jsx("span",{className:"text-gray-500 text-xs",children:"ìˆ˜ëŸ‰:"}),de?i.jsx(A,{type:"number",value:e.quantity,onChange:e=>gt(t,"quantity",Number(e.target.value)),className:"border-gray-200 rounded-lg mt-1 w-full !h-5 !px-1.5 !py-0.5 !text-[9px] font-normal text-gray-600 focus:border-blue-400",placeholder:"ìˆ˜ëŸ‰"}):i.jsx("div",{className:"modal-subtitle",children:e.quantity||0})]}),i.jsxs("div",{children:[i.jsx("span",{className:"text-gray-500 text-xs",children:"ë‹¨ê°€:"}),de?i.jsx(A,{type:"number",value:e.unit_price_value,onChange:e=>gt(t,"unit_price_value",Number(e.target.value)),className:"border-gray-200 rounded-lg mt-1 w-full !h-5 !px-1.5 !py-0.5 !text-[9px] font-normal text-gray-600 focus:border-blue-400",placeholder:"ë‹¨ê°€"}):i.jsx("div",{className:"modal-subtitle",children:"done"!==C||Be?`â‚©${ht(e.unit_price_value)}`:"-"})]}),i.jsxs("div",{children:[i.jsx("span",{className:"text-gray-500 text-xs",children:"ìƒíƒœ:"}),i.jsx("div",{className:"mt-1",children:de?i.jsx(s,{size:"sm",variant:"ghost",onClick:()=>xt(t),className:"text-red-600 hover:bg-red-50 rounded-lg p-1 h-6 w-6",children:i.jsx(V,{className:"w-3 h-3"})}):i.jsxs(i.Fragment,{children:["purchase"===C&&i.jsx(i.Fragment,{children:Ke?i.jsx("button",{onClick:()=>vt(e.id,!e.is_payment_completed),className:"text-xs px-2 py-1 rounded "+(e.is_payment_completed?"bg-orange-500 text-white hover:bg-orange-600":"bg-gray-100 text-gray-600"),children:e.is_payment_completed?"êµ¬ë§¤ì™„ë£Œ":"êµ¬ë§¤ëŒ€ê¸°"}):i.jsx("span",{className:"text-xs px-2 py-1 rounded "+(e.is_payment_completed?"bg-orange-500 text-white":"bg-gray-100 text-gray-400"),children:e.is_payment_completed?"êµ¬ë§¤ì™„ë£Œ":"êµ¬ë§¤ëŒ€ê¸°"})}),"receipt"===C&&i.jsx(i.Fragment,{children:Ye?nt.isCompleted(e)?i.jsx("button",{onClick:()=>{nt.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"text-xs px-2 py-1 rounded button-action-primary",children:nt.config.completedText}):i.jsx(te,{onDateSelect:t=>{nt.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"ì‹¤ì œ ì…ê³ ëœ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”",align:"center",side:"bottom",children:i.jsx("button",{className:"text-xs px-2 py-1 rounded bg-gray-100 text-gray-600",children:nt.config.waitingText})}):i.jsx("span",{className:"text-xs px-2 py-1 rounded "+(nt.isCompleted(e)?"button-action-primary":"bg-gray-100 text-gray-400"),children:nt.isCompleted(e)?nt.config.completedText:nt.config.waitingText})}),"done"===C&&i.jsx(i.Fragment,{children:i.jsx("span",{className:"button-base "+(nt.isCompleted(e)?"bg-green-500 text-white":"border border-gray-300 text-gray-600 bg-white"),children:nt.isCompleted(e)?"ì…ê³ ì™„ë£Œ":"ì…ê³ ëŒ€ê¸°"})}),"purchase"!==C&&"receipt"!==C&&"done"!==C&&i.jsx("span",{className:"text-xs text-gray-400",children:"-"})]})})]})]}),(e.remark||de)&&i.jsxs("div",{children:[i.jsx("span",{className:"text-gray-500 text-xs",children:"ë¹„ê³ :"}),de?i.jsx(A,{value:e.remark||"",onChange:e=>gt(t,"remark",e.target.value),className:"modal-label border-gray-200 rounded-lg mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"ë¹„ê³ "}):i.jsx("div",{className:"modal-subtitle text-gray-500 mt-1",children:e.remark||"-"})]}),!de&&"receipt"===C&&nt.getCompletedDate(e)&&i.jsxs("div",{children:[i.jsx("span",{className:"text-gray-500 text-xs",children:"ì‹¤ì œì…ê³ ì¼:"}),i.jsxs("div",{className:"mt-1",children:[i.jsx("div",{className:"modal-subtitle text-green-700",children:new Date(nt.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})}),i.jsx("div",{className:"text-[9px] text-gray-500",children:new Date(nt.getCompletedDate(e)).toLocaleTimeString("ko-KR",{hour:"2-digit",minute:"2-digit"})})]})]}),!de&&"done"===C&&"ë°œì£¼"===se.payment_category&&i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsx("span",{className:"text-gray-500 text-xs",children:"ê±°ë˜ëª…ì„¸ì„œ í™•ì¸:"}),i.jsx("div",{className:"flex items-center gap-2",children:Je?it.isCompleted(e)?i.jsx("button",{onClick:()=>{it.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"text-xs px-2 py-1 rounded button-action-primary hover:bg-green-600",title:"í´ë¦­í•˜ì—¬ ê±°ë˜ëª…ì„¸ì„œ í™•ì¸ ì·¨ì†Œ",children:it.config.completedText}):i.jsx(te,{onDateSelect:t=>{it.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"íšŒê³„ìƒ ì…ê³ ì¼ì„ ì„ íƒí•˜ì„¸ìš”",align:"end",side:"bottom",children:i.jsx("button",{className:"text-xs px-2 py-1 rounded bg-gray-100 text-gray-600",onClick:()=>{},children:it.config.waitingText})}):i.jsx("span",{className:"text-xs px-2 py-1 rounded "+(it.isCompleted(e)?"button-action-primary":"bg-gray-100 text-gray-400"),children:it.isCompleted(e)?it.config.completedText:it.config.waitingText})})]}),!de&&"done"===C&&"ë°œì£¼"===se.payment_category&&it.getCompletedDate(e)&&i.jsxs("div",{children:[i.jsx("span",{className:"text-gray-500 text-xs",children:"íšŒê³„ìƒ ì…ê³ ì¼:"}),i.jsx("div",{className:"mt-1",children:i.jsx("div",{className:"modal-subtitle text-blue-700",children:new Date(it.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})})})]})]})]},t))})]})}),i.jsxs("div",{className:"bg-gray-50 px-2 sm:px-3 border-t border-gray-100",children:[i.jsxs("div",{className:"hidden sm:grid items-center gap-1 py-2 w-fit",style:{gridTemplateColumns:ut()},children:[i.jsx("div",{}),i.jsx("div",{}),i.jsx("div",{}),i.jsx("div",{className:"text-right flex items-center justify-end",children:i.jsx("span",{className:"text-[11px] text-gray-600 font-medium",children:"ê³µê¸‰ê°€ì•¡"})}),i.jsx("div",{className:"text-right flex items-center justify-end",children:i.jsx("span",{className:"text-[12px] font-bold text-gray-900",children:"done"!==C||Be?`â‚©${ht((de?_e:ze)?.reduce((e,t)=>e+(t.amount_value||0),0)||0)}`:"-"})}),"ë°œì£¼"===se.payment_category&&i.jsx("div",{className:"text-right flex items-center justify-end",children:i.jsx("span",{className:"text-[12px] font-bold text-gray-900",children:"done"!==C||Be?`â‚©${ht((de?_e:ze)?.reduce((e,t)=>e+(t.tax_amount_value||0),0)||0)}`:"-"})}),i.jsx("div",{}),de?i.jsx("div",{}):i.jsx("div",{className:"done"===C&&"ë°œì£¼"===se.payment_category?"text-right flex items-center justify-end":"",children:"done"===C&&"ë°œì£¼"===se.payment_category&&i.jsx("span",{className:"text-[11px] text-gray-600 font-medium",children:"ì§€ì¶œì´í•©"})}),"receipt"===C&&i.jsx("div",{}),"done"===C&&i.jsx(i.Fragment,{children:"ë°œì£¼"===se.payment_category&&i.jsxs(i.Fragment,{children:[i.jsx("div",{className:"text-right flex items-center justify-end",children:i.jsx("div",{className:"text-[12px] font-bold text-blue-700",children:Be?`â‚©${ht((de?_e:ze)?.reduce((e,t)=>e+(Number(t.expenditure_amount)||0),0)||0)}`:"-"})}),i.jsx("div",{}),i.jsx("div",{})]})})]}),"ë°œì£¼"===se.payment_category&&i.jsxs("div",{className:"hidden sm:grid items-center gap-1 py-2 w-fit border-t border-gray-300",style:{gridTemplateColumns:ut()},children:[i.jsx("div",{}),i.jsx("div",{}),i.jsx("div",{}),i.jsx("div",{}),i.jsx("div",{className:"text-right flex items-center justify-end",children:i.jsx("span",{className:"text-[11px] text-gray-600 font-medium",children:"ì´ì•¡"})}),i.jsx("div",{className:"text-right flex items-center justify-end",children:i.jsx("span",{className:"text-[12px] font-bold text-blue-600",children:"done"!==C||Be?`â‚©${ht((de?_e:ze)?.reduce((e,t)=>e+(t.amount_value||0)+(t.tax_amount_value||0),0)||0)}`:"-"})}),i.jsx("div",{}),i.jsx("div",{}),"receipt"===C&&i.jsx("div",{}),"done"===C&&"ë°œì£¼"===se.payment_category&&i.jsxs(i.Fragment,{children:[i.jsx("div",{}),i.jsx("div",{}),i.jsx("div",{})]})]}),i.jsxs("div",{className:"block sm:hidden py-2 space-y-1",children:[i.jsxs("div",{className:"flex justify-between items-center",children:[i.jsx("span",{className:"text-[12px] text-gray-500",children:"í•©ê³„ ì´ì•¡"}),i.jsx("span",{className:"text-[13px] font-bold text-gray-900",children:"done"!==C||Be?`â‚©${ht((de?_e:ze)?.reduce((e,t)=>e+(t.amount_value||0),0)||0)}`:"-"})]}),"ë°œì£¼"===se.payment_category&&i.jsxs(i.Fragment,{children:[i.jsxs("div",{className:"flex justify-between items-center",children:[i.jsx("span",{className:"text-[12px] text-gray-500",children:"ì„¸ì•¡ ì´ì•¡"}),i.jsx("span",{className:"text-[13px] font-bold text-gray-900",children:"done"!==C||Be?`â‚©${ht((de?_e:ze)?.reduce((e,t)=>e+(t.tax_amount_value||0),0)||0)}`:"-"})]}),i.jsxs("div",{className:"flex justify-between items-center border-t pt-1",children:[i.jsx("span",{className:"text-[12px] text-gray-500",children:"í•©ê³„+ì„¸ì•¡"}),i.jsx("span",{className:"text-[13px] font-bold text-blue-600",children:"done"!==C||Be?`â‚©${ht((de?_e:ze)?.reduce((e,t)=>e+(t.amount_value||0)+(t.tax_amount_value||0),0)||0)}`:"-"})]})]}),"done"===C&&"ë°œì£¼"===se.payment_category&&i.jsxs("div",{className:"flex justify-between items-center border-t pt-1",children:[i.jsx("span",{className:"text-[12px] text-gray-500",children:"ì§€ì¶œ ì´í•©"}),i.jsx("span",{className:"text-[13px] font-bold text-blue-700",children:Be?`â‚©${ht((de?_e:ze)?.reduce((e,t)=>e+(Number(t.expenditure_amount)||0),0)||0)}`:"-"})]})]})]}),de&&i.jsx("div",{className:"p-2 sm:p-3 border-t border-gray-100",children:i.jsxs(s,{size:"sm",variant:"outline",onClick:()=>{const e={item_name:"",specification:"",quantity:1,unit_price_value:0,amount_value:0,remark:"",line_number:_e.reduce((e,t)=>{const a=t.line_number||0;return a>e?a:e},0)+1},t=[..._e,e].sort((e,t)=>(e.line_number||999999)-(t.line_number||999999));pe(t)},className:"w-full rounded-lg border-dashed border-2 border-gray-300 hover:border-gray-400 py-2 badge-text",children:[i.jsx(W,{className:"w-4 h-4 mr-1"}),"í•­ëª© ì¶”ê°€"]})})]})})]})]}):i.jsx("div",{className:"text-center py-12",children:i.jsx("span",{className:"modal-subtitle",children:"ë°œì£¼ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."})})});return c?jt:i.jsx(z,{open:t,onOpenChange:o,children:i.jsxs(P,{className:"overflow-hidden bg-white rounded-lg shadow-sm border-0 w-full sm:w-auto max-w-[calc(100vw-48px)] sm:max-w-[calc(100vw-80px)] lg:max-w-[90vw] xl:max-w-[85vw] h-[95vh] sm:h-auto sm:max-h-[90vh] lg:max-h-[85vh] sm:rounded-lg flex flex-col",showCloseButton:!1,children:[i.jsx(M,{className:"sr-only",children:i.jsx(E,{children:"ë°œì£¼ ìƒì„¸ ì •ë³´"})}),i.jsxs("div",{className:"relative px-3 sm:px-6 pt-0 sm:pt-3 lg:pt-4 pb-0 sm:pb-2 lg:pb-3 flex-shrink-0",children:[i.jsxs("div",{className:"absolute right-3 sm:right-6 top-3 sm:top-3 lg:top-4 flex items-center gap-2 z-10",children:[!Ge&&!de&&i.jsxs(I,{open:De,onOpenChange:Ie,children:[i.jsx($,{asChild:!0,children:i.jsxs(s,{variant:"outline",size:"sm",className:"button-base button-action-secondary h-8 text-xs px-3 gap-1.5",title:"ìˆ˜ì • ìš”ì²­",children:[i.jsx(G,{className:"w-3.5 h-3.5 text-gray-500"}),i.jsx("span",{children:"ìˆ˜ì • ìš”ì²­"})]})}),i.jsx(O,{className:"w-80 sm:w-96 p-4",align:"end",onOpenAutoFocus:e=>e.preventDefault(),children:i.jsxs("div",{className:"space-y-4",children:[i.jsxs("div",{className:"space-y-2",children:[i.jsx("h4",{className:"font-medium leading-none",children:"ìˆ˜ì • ìš”ì²­"}),i.jsx("p",{className:"text-xs text-muted-foreground",children:"í•´ë‹¹ ë°œì£¼ì„œì— ëŒ€í•œ ìˆ˜ì • ìš”ì²­ì‚¬í•­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."})]}),i.jsxs("div",{className:"space-y-3",children:[i.jsxs("div",{className:"space-y-1",children:[i.jsx(T,{htmlFor:"subject",className:"text-xs",children:"ì œëª©"}),i.jsx(A,{id:"subject",value:$e,onChange:e=>Oe(e.target.value),className:"h-8 text-xs",placeholder:"ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"})]}),i.jsxs("div",{className:"space-y-1",children:[i.jsx(T,{htmlFor:"message",className:"text-xs",children:"ë‚´ìš©"}),i.jsx("div",{className:"relative",onWheel:e=>e.stopPropagation(),children:i.jsx(F,{id:"message",value:Ae,onChange:e=>Fe(e.target.value),className:"min-h-[150px] text-xs font-mono overflow-auto",placeholder:"ìš”ì²­ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”",style:{resize:"none"}})})]})]}),i.jsxs("div",{className:"flex justify-end gap-2",children:[i.jsx(s,{variant:"outline",size:"sm",onClick:()=>Ie(!1),className:"h-8 text-xs",children:"ì·¨ì†Œ"}),i.jsx(s,{size:"sm",onClick:async()=>{if($e.trim()&&Ae.trim()){Te(!0);try{const{data:{user:e}}=await Me.auth.getUser();if(!e)return void w.error("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");const{error:t}=await Me.from("support_inquires").insert({user_id:e.id,user_email:e.email,user_name:fe,inquiry_type:"modify",subject:$e,message:Ae,status:"open",purchase_request_id:se?.id,purchase_order_number:se?.purchase_order_number,requester_id:se?.requester_id,purchase_info:JSON.stringify({vendor_name:se?.vendor_name,total_amount:se?.total_amount,item_count:se?.purchase_request_items?.length||0})});if(t)throw t;w.success("ìˆ˜ì • ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤."),Ie(!1),Oe(""),Fe("")}catch(e){n.error("ìˆ˜ì • ìš”ì²­ ì „ì†¡ ì‹¤íŒ¨",e),w.error("ìˆ˜ì • ìš”ì²­ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}finally{Te(!1)}}else w.error("ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.")},disabled:We,className:"h-8 text-xs bg-blue-600 hover:bg-blue-700",children:We?"ì „ì†¡ ì¤‘...":"ìš”ì²­ ì „ì†¡"})]})]})})]}),i.jsx("button",{onClick:o,className:"button-base button-action-secondary w-8 h-8 rounded-full flex items-center justify-center",children:i.jsx(_,{className:"w-4 h-4 text-gray-500"})})]}),i.jsx("div",{className:"pr-8 sm:pr-16",children:i.jsxs("div",{className:"flex items-start gap-4 mb-0 sm:mb-3",children:[i.jsx("div",{className:"min-w-0 flex-1",children:i.jsx("h1",{className:"page-title mb-0 sm:mb-1",children:"ë°œì£¼ ê¸°ë³¸ì •ë³´"})}),i.jsxs("div",{className:"flex items-center gap-3",children:[!de&&Re&&i.jsxs(i.Fragment,{children:[i.jsxs(s,{size:"sm",variant:"outline",onClick:()=>_t(!0),className:"button-base button-action-secondary",children:[i.jsx(D,{className:"w-4 h-4 mr-2"}),"ìˆ˜ì •"]}),Ve&&Y&&i.jsxs(s,{size:"sm",variant:"outline",onClick:async()=>{if(se)try{await Y(se),o(),q&&await q(!0)}catch(e){n.error("ë°œì£¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ",e),w.error("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},className:"button-base button-action-danger",children:[i.jsx(V,{className:"w-4 h-4 mr-2"}),"ì‚­ì œ"]})]}),de&&i.jsxs(i.Fragment,{children:[i.jsxs(s,{size:"sm",variant:"outline",onClick:()=>{_t(!1),ue(se),pe(se?.items||[]),ge([])},className:"button-base button-action-secondary",children:[i.jsx(_,{className:"w-4 h-4 mr-2"}),"ì·¨ì†Œ"]}),i.jsxs(s,{size:"sm",onClick:async()=>{if(se&&me){n.info("handleSave ì‹œì‘:",{purchaseId:se.id,vendor_id:me.vendor_id,vendor_name:me.vendor_name,vendor:me.vendor,editedPurchase:me});try{const e=a(),t=_e.reduce((e,t)=>e+(t.amount_value||0),0);n.info("Update payload:",{purchase_order_number:me.purchase_order_number||null,requester_name:me.requester_name||null,vendor_id:me.vendor_id||null,vendor_name:me.vendor_name||null,delivery_request_date:me.delivery_request_date||null,revised_delivery_request_date:me.revised_delivery_request_date||null,payment_category:me.payment_category||null,project_vendor:me.project_vendor||null,project_item:me.project_item||null,sales_order_number:me.sales_order_number||null,total_amount:Number(t),updated_at:(new Date).toISOString()});let r=null;me.contact_id?r=me.contact_id:Array.isArray(me.vendor_contacts)&&me.vendor_contacts.length>0&&(r=me.vendor_contacts[0].id||null);const{error:i}=await e.from("purchase_requests").update({purchase_order_number:me.purchase_order_number||null,requester_name:me.requester_name||null,vendor_id:me.vendor_id||null,vendor_name:me.vendor_name||null,contact_id:r,delivery_request_date:me.delivery_request_date||null,revised_delivery_request_date:me.revised_delivery_request_date||null,payment_category:me.payment_category||null,project_vendor:me.project_vendor||null,project_item:me.project_item||null,sales_order_number:me.sales_order_number||null,total_amount:Number(t),updated_at:(new Date).toISOString()}).eq("id",se.id);if(i)throw n.error("Purchase update error:",i),i;let s=null;if(n.info("ë‹´ë‹¹ì ì €ì¥ ì‹œì‘:",{vendor_id:me.vendor_id,vendor_contacts:me.vendor_contacts,isArray:Array.isArray(me.vendor_contacts)}),me.vendor_id&&Array.isArray(me.vendor_contacts)&&me.vendor_contacts.length>0){const t=me.vendor_contacts[0];if(n.info("ë‹´ë‹¹ì ì •ë³´:",{contact:t}),t.id){s=t.id;const{error:a}=await e.from("vendor_contacts").update({contact_name:t.contact_name||"",contact_email:t.contact_email||"",contact_phone:t.contact_phone||"",position:t.position||""}).eq("id",t.id);a?n.error("ë‹´ë‹¹ì ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:",a):le(e=>{const a=e?{...e,vendor_contacts:[t],contact_id:t.id,contact_name:t.contact_name}:null;return n.info("ğŸ” ë‹´ë‹¹ì ì—…ë°ì´íŠ¸ í›„ setPurchase:",{prev_vendor_contacts:e?.vendor_contacts,new_vendor_contacts:[t],updated_purchase:a}),a})}else if(t.contact_name){const{data:a,error:r}=await e.from("vendor_contacts").insert({vendor_id:me.vendor_id,contact_name:t.contact_name,contact_email:t.contact_email||"",contact_phone:t.contact_phone||"",position:t.position||""}).select().single();if(r)n.error("ë‹´ë‹¹ì ìƒì„± ì˜¤ë¥˜:",r);else if(a){s=a.id,me.vendor_contacts=[a],n.info("ë‹´ë‹¹ì ìƒì„± ì™„ë£Œ:",a),le(e=>{const t=e?{...e,vendor_contacts:[a],contact_id:a.id,contact_name:a.contact_name}:null;return n.info("ğŸ” ìƒˆ ë‹´ë‹¹ì ìƒì„± í›„ setPurchase:",{prev_vendor_contacts:e?.vendor_contacts,new_vendor_contacts:[a],newContact_full:a,updated_purchase:t}),t});const{error:t}=await e.from("purchase_requests").update({contact_id:a.id}).eq("id",se.id);t&&n.error("purchase_requests contact_id ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:",t)}}}if(he.length>0){const{error:t}=await e.from("purchase_request_items").delete().in("id",he);if(t)throw t}for(const a of _e){if(!a.item_name||!a.item_name.trim())throw new Error("í’ˆëª©ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");if(!a.quantity||a.quantity<=0)throw new Error("ìˆ˜ëŸ‰ì€ 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.");if(null!==a.unit_price_value&&void 0!==a.unit_price_value&&a.unit_price_value<0)throw new Error("ë‹¨ê°€ëŠ” 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");if(null!==a.amount_value&&void 0!==a.amount_value&&a.amount_value<0)throw new Error("í•©ê³„ëŠ” 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");if(a.id){const{error:t}=await e.from("purchase_request_items").update({item_name:a.item_name.trim(),specification:a.specification||null,quantity:Number(a.quantity),received_quantity:null!==a.received_quantity&&void 0!==a.received_quantity?Number(a.received_quantity):null,unit_price_value:Number(a.unit_price_value),unit_price_currency:se.currency||"KRW",amount_value:Number(a.amount_value),amount_currency:se.currency||"KRW",remark:a.remark||null,updated_at:(new Date).toISOString()}).eq("id",a.id);if(t)throw n.error("ê¸°ì¡´ í•­ëª© ì—…ë°ì´íŠ¸ ì˜¤ë¥˜",t),t}else{const t={purchase_request_id:se.id,item_name:a.item_name.trim(),specification:a.specification||null,quantity:Number(a.quantity),received_quantity:null!==a.received_quantity&&void 0!==a.received_quantity?Number(a.received_quantity):null,unit_price_value:Number(a.unit_price_value),unit_price_currency:se.currency||"KRW",amount_value:Number(a.amount_value),amount_currency:se.currency||"KRW",remark:a.remark||null,line_number:a.line_number||_e.indexOf(a)+1,created_at:(new Date).toISOString()},{error:r}=await e.from("purchase_request_items").insert(t);if(r)throw n.error("ìƒˆ í•­ëª© ìƒì„± ì˜¤ë¥˜",r),r}}const l=se?Number(se.id):NaN,d=me||se;if(!Number.isNaN(l)&&he.length>0&&(n.info("ğŸš€ [ë©”ëª¨ë¦¬ ìºì‹œ] ê°œë³„ í’ˆëª© ì‚­ì œ ì²˜ë¦¬ ì‹œì‘",{purchaseId:l,deletedItemIds:he,deletedCount:he.length}),he.forEach(e=>{y(l,e)?n.info("âœ… [handleSave] ê°œë³„ í’ˆëª© ì‚­ì œ ë©”ëª¨ë¦¬ ìºì‹œ ì—…ë°ì´íŠ¸ ì„±ê³µ",{purchaseId:l,itemId:e}):n.warn("[handleSave] ê°œë³„ í’ˆëª© ì‚­ì œ ë©”ëª¨ë¦¬ ìºì‹œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{purchaseId:l,itemId:e})})),!Number.isNaN(l)){const e=h(l,e=>{const t=_e.reduce((e,t)=>e+(t.amount_value||0),0);return n.info("ğŸš€ [ë©”ëª¨ë¦¬ ìºì‹œ] ë°œì£¼ ê¸°ë³¸ ì •ë³´ ì—…ë°ì´íŠ¸",{purchaseId:l,newTotalAmount:t,itemsCount:_e.length}),{...e,purchase_order_number:d?.purchase_order_number||e.purchase_order_number,requester_name:d?.requester_name||e.requester_name,vendor_id:d?.vendor_id||e.vendor_id,vendor_name:d?.vendor_name||e.vendor_name,vendor:d?.vendor||e.vendor,vendor_contacts:d?.vendor_contacts||e.vendor_contacts,delivery_request_date:d?.delivery_request_date||e.delivery_request_date,revised_delivery_request_date:d?.revised_delivery_request_date||e.revised_delivery_request_date,payment_category:d?.payment_category||e.payment_category,project_vendor:d?.project_vendor||e.project_vendor,project_item:d?.project_item||e.project_item,total_amount:t,updated_at:(new Date).toISOString()}});n.info("ğŸš€ [ë©”ëª¨ë¦¬ ìºì‹œ] ê¸°ë³¸ ì •ë³´ ì—…ë°ì´íŠ¸ ê²°ê³¼:",{memoryUpdated:e})}(()=>{!Number.isNaN(l)&&J&&J(l,e=>{const t=_e,a=t.reduce((e,t)=>e+(t.amount_value||0),0);return n.info("ğŸš€ [onOptimisticUpdate] ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸",{originalItemsCount:e.items?.length||e.purchase_request_items?.length||0,finalItemsCount:t.length,deletedItemsCount:he.length}),{...e,purchase_order_number:d?.purchase_order_number||e.purchase_order_number,requester_name:d?.requester_name||e.requester_name,vendor_id:d?.vendor_id||e.vendor_id,vendor_name:d?.vendor_name||e.vendor_name,vendor:d?.vendor||e.vendor,vendor_contacts:d?.vendor_contacts||e.vendor_contacts,delivery_request_date:d?.delivery_request_date||e.delivery_request_date,revised_delivery_request_date:d?.revised_delivery_request_date||e.revised_delivery_request_date,payment_category:d?.payment_category||e.payment_category,project_vendor:d?.project_vendor||e.project_vendor,project_item:d?.project_item||e.project_item,total_amount:a,items:t,purchase_request_items:t,updated_at:(new Date).toISOString()}})})(),w.success("ë°œì£¼ ë‚´ì—­ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."),_t(!1),ge([]),await Xe(),n.info("ğŸ” refreshModalData ì™„ë£Œ í›„ purchase:",{purchaseId:se?.id});const o=q?.(!0,{silent:!0});o instanceof Promise&&await o}catch(e){n.error("ì €ì¥ ì¤‘ ì „ì²´ ì˜¤ë¥˜",e);const t=e instanceof Error?e.message:"ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤";w.error(`ì €ì¥ ì‹¤íŒ¨: ${t}`)}}else w.error("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")},className:"button-base button-action-primary",children:[i.jsx(K,{className:"w-4 h-4 mr-2"}),"ì €ì¥"]})]})]})]})})]}),i.jsx("div",{className:"overflow-y-auto flex-1 px-3 sm:px-6 pb-1 sm:pb-6 mt-0",children:jt})]})})});export{oe as A,ce as C,se as D,me as P,le as R,Q as T,de as a,H as b,te as c,ee as d,X as g,ie as u};
//# sourceMappingURL=PurchaseDetailModal-L7WGQSP5.js.map
