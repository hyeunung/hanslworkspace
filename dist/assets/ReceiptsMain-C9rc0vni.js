import{c as F,r as m,a as B,j as e,b as w,X as W,F as oe,U as le,I as ce}from"./index-D7zhaxeg.js";import{C as Z,c as G,a as de,b as me}from"./card-DphZW_ic.js";import{t as d,B as q}from"./index-Byz6fgcv.js";import{I as se}from"./input-CTFTBxu1.js";import{D as re,a as ne,b as he,c as ue,d as ge}from"./dialog-LTqAfP5e.js";import{D as Y}from"./download-CClfhcQJ.js";import{T as K}from"./trash-2-B0it-y9E.js";import{C as pe}from"./calendar-QNyeR54B.js";import{T as xe}from"./textarea-CeoFyA1Y.js";import{L as te}from"./label-BuEHBg-5.js";import{P as fe}from"./plus-4dt1HSHA.js";import{F as we}from"./funnel-By3V72zV.js";import{S as ye}from"./search-CSgQkRs9.js";/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["circle",{cx:"10",cy:"12",r:"2",key:"737tya"}],["path",{d:"m20 17-1.296-1.296a2.41 2.41 0 0 0-3.408 0L9 22",key:"wt3hpn"}]],je=F("file-image",be);/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ve=[["path",{d:"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2",key:"143wyd"}],["path",{d:"M6 9V3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6",key:"1itne7"}],["rect",{x:"6",y:"14",width:"12",height:"8",rx:"1",key:"1ue0tg"}]],X=F("printer",ve);/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]],_e=F("rotate-ccw",Ne);/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ke=[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]],ae=F("upload",ke);/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const De=[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"11",x2:"11",y1:"8",y2:"14",key:"1vmskp"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]],Re=F("zoom-in",De);/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]],Me=F("zoom-out",Se);function Q(){const[a,r]=m.useState({canView:!1,canUpload:!1,canDownload:!1,canPrint:!1,canDelete:!1,canViewUploaderInfo:!1}),[l,t]=m.useState(null),[c,i]=m.useState(!0),h=B(),v=async()=>{try{const{data:{user:$}}=await h.auth.getUser();if(!$){i(!1);return}const{data:U}=await h.from("employees").select("purchase_role").eq("email",$.email).single(),k=U?.purchase_role||"";t(k);const _=k.includes("app_admin"),C=k.includes("hr"),P=k.includes("lead buyer"),y=_||C||P;r({canView:y,canUpload:y,canDownload:y,canPrint:y,canDelete:_,canViewUploaderInfo:_})}catch($){console.error("권한 확인 오류:",$)}finally{i(!1)}};return m.useEffect(()=>{v()},[]),{permissions:a,userRole:l,loading:c,refreshPermissions:v}}class Ee{constructor(){this.session=null,this.isMonitoring=!1,this.supabase=B()}async startSession(){try{console.log("🔍 [DebugMonitor] 디버깅 세션 시작...");const{data:{user:r},error:l}=await this.supabase.auth.getUser();if(l||!r)return console.error("❌ [DebugMonitor] 사용자 인증 실패:",l),null;const{data:t,error:c}=await this.supabase.from("employees").select("name, purchase_role").eq("email",r.email).single();return c?(console.error("❌ [DebugMonitor] 직원 정보 조회 실패:",c),null):(this.session={sessionId:`debug_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,userEmail:r.email||"",userName:t?.name||r.email||"",userRole:t?.purchase_role||"",browserInfo:{userAgent:navigator.userAgent,platform:navigator.platform,language:navigator.language,cookieEnabled:navigator.cookieEnabled},startTime:new Date().toISOString(),events:[]},this.isMonitoring=!0,this.logEvent("auth","success","디버깅 세션 시작",{userId:r.id,userEmail:r.email,userName:t?.name,userRole:t?.purchase_role}),this.startNetworkMonitoring(),this.startPermissionMonitoring(),console.log("✅ [DebugMonitor] 디버깅 세션 활성화:",this.session),this.session)}catch(r){return console.error("💥 [DebugMonitor] 세션 시작 실패:",r),null}}logEvent(r,l,t,c){if(!this.isMonitoring||!this.session)return;const i={timestamp:new Date().toISOString(),type:r,level:l,message:t,data:c||{}};this.session.events.push(i),console.log(`${l==="error"?"❌":l==="warn"?"⚠️":l==="success"?"✅":"ℹ️"} [DebugMonitor:${r}] ${t}`,c),this.session.events.length>100&&(this.session.events=this.session.events.slice(-50))}startNetworkMonitoring(){const r=window.fetch;window.fetch=async(...l)=>{const[t,c]=l,i=t.toString().includes("supabase")||t.toString().includes("purchase_receipts");if(i){const h={url:t.toString(),method:c?.method||"GET",headers:c?.headers,timestamp:new Date().toISOString()};this.logEvent("network","info",`네트워크 요청: ${h.method} ${h.url}`,h)}try{const h=await r.apply(window,l);if(i){const v={url:t.toString(),status:h.status,statusText:h.statusText,ok:h.ok,timestamp:new Date().toISOString()};this.logEvent("network",h.ok?"success":"error",`네트워크 응답: ${v.status} ${v.statusText}`,v)}return h}catch(h){throw i&&this.logEvent("network","error","네트워크 요청 실패",{url:t.toString(),error:h}),h}}}startPermissionMonitoring(){document.addEventListener("visibilitychange",()=>{document.hidden||this.checkPermissionStatus()}),setInterval(()=>{this.checkPermissionStatus()},300*1e3)}async checkPermissionStatus(){try{const{data:{user:r},error:l}=await this.supabase.auth.getUser();if(l||!r){this.logEvent("permission","error","사용자 인증 상태 확인 실패",{authError:l});return}const{data:t,error:c}=await this.supabase.from("employees").select("name, purchase_role").eq("email",r.email).single();if(c){this.logEvent("permission","error","직원 정보 조회 실패",{empError:c});return}const i=t?.purchase_role||"",h=i.includes("app_admin")||i.includes("hr")||i.includes("lead buyer");this.logEvent("permission","info","권한 상태 확인",{userId:r.id,userEmail:r.email,userName:t?.name,role:i,hasPermission:h}),this.session&&(this.session.userRole=i)}catch(r){this.logEvent("permission","error","권한 상태 확인 중 오류 발생",{error:r})}}trackPrintCompletion(r,l){this.logEvent("ui","info","인쇄완료 시도 시작",{receiptId:r,receiptName:l})}trackUpdateResult(r,l,t,c){this.logEvent("update",l?"success":"error",l?"인쇄완료 업데이트 성공":"인쇄완료 업데이트 실패",{receiptId:r,success:l,error:t,executionTime:c})}getSession(){return this.session}exportSessionData(){return this.session?JSON.stringify({...this.session,exportedAt:new Date().toISOString()},null,2):""}stopSession(){this.session&&(this.logEvent("auth","info","디버깅 세션 종료",{sessionDuration:Date.now()-new Date(this.session.startTime).getTime(),totalEvents:this.session.events.length}),console.log("📊 [DebugMonitor] 세션 요약:",{sessionId:this.session.sessionId,duration:Date.now()-new Date(this.session.startTime).getTime(),totalEvents:this.session.events.length,userInfo:{email:this.session.userEmail,name:this.session.userName,role:this.session.userRole}})),this.isMonitoring=!1,this.session=null}generateComparisonReport(){if(!this.session)return"세션이 활성화되지 않았습니다.";const r=this.session.events.filter(i=>i.type==="auth"),l=this.session.events.filter(i=>i.type==="permission"),t=this.session.events.filter(i=>i.type==="update"),c=this.session.events.filter(i=>i.level==="error");return`
# 영수증 인쇄완료 디버깅 리포트

## 세션 정보
- 세션 ID: ${this.session.sessionId}
- 사용자: ${this.session.userName} (${this.session.userEmail})
- 권한: ${this.session.userRole}
- 시작 시간: ${this.session.startTime}
- 브라우저: ${this.session.browserInfo.userAgent}

## 이벤트 통계
- 총 이벤트: ${this.session.events.length}
- 인증 이벤트: ${r.length}
- 권한 이벤트: ${l.length}
- 업데이트 이벤트: ${t.length}
- 오류 이벤트: ${c.length}

## 최근 오류
${c.slice(-5).map(i=>`- ${i.timestamp}: ${i.message}`).join(`
`)}

## 권한 체크 결과
${l.slice(-3).map(i=>`- ${i.timestamp}: ${JSON.stringify(i.data,null,2)}`).join(`
`)}

---
리포트 생성 시간: ${new Date().toISOString()}
    `.trim()}}const H=new Ee;function $e({receipt:a,isOpen:r,onClose:l,onDelete:t}){const[c,i]=m.useState(1),[h,v]=m.useState(0),[$,U]=m.useState(!1),[k,_]=m.useState(!1),[C,P]=m.useState({width:0,height:0}),[y,j]=m.useState(!1),N=B(),{permissions:D}=Q();m.useEffect(()=>{r&&(i(1),v(0),U(!1),j(!1))},[r]);const I=async()=>{try{const g=new URL(a.receipt_image_url).pathname.split("/"),p=g.indexOf("receipt-images");if(p===-1)throw new Error("잘못된 영수증 URL입니다");const b=g.slice(p+1).join("/"),{data:f,error:S}=await N.storage.from("receipt-images").download(b);if(S)throw S;const M=new Blob([f],{type:"image/jpeg"}),R=window.URL.createObjectURL(M),T=document.createElement("a");T.href=R,T.download=a.file_name||`영수증_${a.id}.jpg`,document.body.appendChild(T),T.click(),document.body.removeChild(T),window.URL.revokeObjectURL(R),d.success("영수증 이미지가 다운로드되었습니다.")}catch(n){console.error("다운로드 오류:",n),d.error("다운로드에 실패했습니다.")}},u=()=>{i(n=>Math.min(n+.25,3))},O=()=>{i(n=>Math.max(n-.25,.5))},L=()=>{v(n=>(n+90)%360)},A=n=>{const g=n.currentTarget;P({width:g.naturalWidth,height:g.naturalHeight}),j(!0)},z=()=>{if(!y)return{width:"100%",height:"100vh"};const n=window.innerWidth-64,g=window.innerHeight,p=n/C.width,b=g/C.height,f=Math.min(p,b);return{width:`${C.width*f}px`,height:`${C.height*f}px`}},s=m.useCallback(async()=>{console.log("🖨️ [ReceiptDebug] 인쇄완료 처리 시작:",{receiptId:a.id,receiptName:a.file_name,timestamp:new Date().toISOString(),userAgent:navigator.userAgent}),H.trackPrintCompletion(a.id,a.file_name);try{console.log("🔐 [ReceiptDebug] 사용자 인증 정보 확인 중...");const{data:{user:n},error:g}=await N.auth.getUser();if(g){console.error("❌ [ReceiptDebug] 인증 오류:",g),d.error("사용자 인증에 실패했습니다.");return}if(!n){console.error("❌ [ReceiptDebug] 사용자 정보 없음"),d.error("사용자 정보를 불러올 수 없습니다.");return}console.log("✅ [ReceiptDebug] 사용자 인증 성공:",{userId:n.id,email:n.email,lastSignIn:n.last_sign_in_at}),console.log("👤 [ReceiptDebug] 직원 정보 조회 중...");const{data:p,error:b}=await N.from("employees").select("name, purchase_role").eq("email",n.email).single();if(b){console.error("❌ [ReceiptDebug] 직원 정보 조회 실패:",b),d.error("직원 정보를 불러올 수 없습니다.");return}console.log("✅ [ReceiptDebug] 직원 정보 조회 성공:",{name:p?.name,email:n.email,role:p?.purchase_role});const f=p?.purchase_role||"",S=f.includes("app_admin")||f.includes("hr")||f.includes("lead buyer");if(console.log("🛡️ [ReceiptDebug] 권한 검증:",{role:f,hasPermission:S,isAppAdmin:f.includes("app_admin"),isHr:f.includes("hr"),isLeadBuyer:f.includes("lead buyer")}),!S){console.error("❌ [ReceiptDebug] 권한 부족:",{role:f}),d.error("인쇄완료 처리 권한이 없습니다.");return}const M={is_printed:!0,printed_at:new Date().toISOString(),printed_by:n.id,printed_by_name:p?.name||n.email};console.log("📝 [ReceiptDebug] 업데이트 데이터 준비:",M),console.log("🔄 [ReceiptDebug] 데이터베이스 업데이트 실행 중...");const R=performance.now(),{data:T,error:E}=await N.from("purchase_receipts").update(M).eq("id",a.id).select("*"),V=performance.now()-R;if(E){console.error("❌ [ReceiptDebug] 업데이트 실패:",{error:E,code:E.code,message:E.message,details:E.details,hint:E.hint,executionTime:`${V.toFixed(2)}ms`}),H.trackUpdateResult(a.id,!1,E,V),E.code==="42501"||E.message?.includes("policy")?d.error("데이터베이스 권한 오류가 발생했습니다. 관리자에게 문의하세요."):d.error(`업데이트 실패: ${E.message}`);return}const ee=T?.length||0;console.log("✅ [ReceiptDebug] 업데이트 성공:",{updateResult:T,executionTime:`${V.toFixed(2)}ms`,affectedRows:ee}),ee===0&&console.log("ℹ️ [ReceiptDebug] 이미 인쇄완료 상태였습니다."),H.trackUpdateResult(a.id,!0,null,V),d.success("인쇄 완료로 표시되었습니다."),console.log("🔄 [ReceiptDebug] 목록 새로고침 처리..."),t&&t(),console.log("🎉 [ReceiptDebug] 인쇄완료 처리 완료:",{receiptId:a.id,success:!0,timestamp:new Date().toISOString()})}catch(n){const g=n;console.error("💥 [ReceiptDebug] 예외 발생:",{error:n,message:g?.message,stack:g?.stack,receiptId:a.id,timestamp:new Date().toISOString()}),H.trackUpdateResult(a.id,!1,n),d.error(`인쇄 완료 처리에 실패했습니다: ${g?.message||"알 수 없는 오류"}`)}},[N,a.id,a.file_name,l,t]),o=m.useCallback(()=>{const n=window.open("","_blank");n&&(n.document.write(`
        <!DOCTYPE html>
        <html><head><title></title>
        <style>@page{margin:0;size:auto;}*{margin:0;padding:0;box-sizing:border-box;}body{display:flex;justify-content:center;align-items:center;min-height:100vh;background:white;margin:0;padding:0;}.receipt-image{max-width:100%;max-height:100vh;object-fit:contain;display:block;}@media print{@page{margin:0;}body{margin:0;padding:0;background:white;}.receipt-image{max-width:100%;max-height:100%;width:auto;height:auto;page-break-inside:avoid;}}</style>
        </head><body>
        <img src="${a.receipt_image_url}" alt="" class="receipt-image" onload="setTimeout(function(){window.print();window.close();},100);" onerror="window.close();" />
        </body></html>
      `),n.document.close(),setTimeout(()=>{console.log("🔔 [ReceiptDebug] 인쇄완료 확인 다이얼로그 표시 중...");const g=confirm("인쇄를 완료하셨습니까?");console.log("👤 [ReceiptDebug] 사용자 응답:",g?"확인 클릭":"취소 클릭"),g?(console.log("🚪 [ReceiptDebug] 모달 닫기 실행 중..."),l(),console.log("🎯 [ReceiptDebug] markAsPrinted 함수 호출 시작!"),s()):console.log("❌ [ReceiptDebug] 사용자가 취소함 - 인쇄완료 처리 안함")},1e3))},[a.receipt_image_url,s,l]),x=m.useCallback(async()=>{if(!D.canDelete){d.error("삭제 권한이 없습니다.");return}if(confirm("정말로 이 영수증을 삭제하시겠습니까?"))try{_(!0);const g=new URL(a.receipt_image_url).pathname.split("/"),p=g.indexOf("receipt-images");if(p!==-1){const f=g.slice(p+1).join("/"),{error:S}=await N.storage.from("receipt-images").remove([f]);S&&console.warn("스토리지 파일 삭제 실패:",S)}const{error:b}=await N.from("purchase_receipts").delete().eq("id",a.id);if(b)throw b;d.success("영수증이 삭제되었습니다."),l(),t&&t()}catch(n){console.error("삭제 오류:",n),d.error("삭제에 실패했습니다.")}finally{_(!1)}},[D.canDelete,a.id,a.receipt_image_url,l,t,N]);return e.jsx(re,{open:r,onOpenChange:l,children:e.jsx(ne,{className:"w-[100vw] max-w-none h-[100vh] p-0 overflow-hidden m-0 border-0 rounded-none",children:e.jsxs("div",{className:"flex h-full",children:[e.jsxs("div",{className:"flex-1 bg-white relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx("img",{src:a.receipt_image_url,alt:"영수증",className:"object-contain",style:{...z(),transform:`scale(${c}) rotate(${h}deg)`,transformOrigin:"center"},onLoad:A,onError:()=>U(!0)})}),e.jsx(w,{variant:"ghost",size:"sm",onClick:l,className:"absolute top-4 left-4 h-10 w-10 p-0 bg-gray-900/80 hover:bg-gray-900 text-white rounded-full",children:e.jsx(W,{className:"h-5 w-5"})}),e.jsx("div",{className:"absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-900/80 rounded-full px-4 py-2",children:e.jsxs("div",{className:"flex items-center gap-2 text-white",children:[e.jsx(w,{variant:"ghost",size:"sm",onClick:O,disabled:c<=.5,className:"h-8 w-8 p-0 text-white hover:bg-white/20",children:e.jsx(Me,{className:"w-4 h-4"})}),e.jsxs("span",{className:"text-sm min-w-[40px] text-center",children:[Math.round(c*100),"%"]}),e.jsx(w,{variant:"ghost",size:"sm",onClick:u,disabled:c>=3,className:"h-8 w-8 p-0 text-white hover:bg-white/20",children:e.jsx(Re,{className:"w-4 h-4"})}),e.jsx("div",{className:"w-px h-4 bg-white/30 mx-1"}),e.jsx(w,{variant:"ghost",size:"sm",onClick:L,className:"h-8 w-8 p-0 text-white hover:bg-white/20",children:e.jsx(_e,{className:"w-4 h-4"})})]})})]}),e.jsxs("div",{className:"w-16 bg-gray-900 flex flex-col items-center justify-center space-y-4",children:[e.jsx(w,{variant:"ghost",size:"sm",onClick:o,className:"w-12 h-12 p-0 text-white hover:bg-gray-700 rounded-lg",title:"인쇄",children:e.jsx(X,{className:"w-6 h-6"})}),e.jsx(w,{variant:"ghost",size:"sm",onClick:I,className:"w-12 h-12 p-0 text-white hover:bg-gray-700 rounded-lg",title:"다운로드",children:e.jsx(Y,{className:"w-6 h-6"})}),D.canDelete&&e.jsx(w,{variant:"ghost",size:"sm",onClick:x,disabled:k,className:"w-12 h-12 p-0 text-white hover:bg-red-600 rounded-lg",title:"삭제",children:k?e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsx(K,{className:"w-6 h-6"})})]})]})})})}function ie(a){if(a===0)return"0 B";const r=1024,l=["B","KB","MB","GB"],t=Math.floor(Math.log(a)/Math.log(r));return`${parseFloat((a/Math.pow(r,t)).toFixed(1))} ${l[t]}`}function J(a){if(!a)return"-";try{const r=new Date(a);return isNaN(r.getTime())?"-":r.toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})}catch{return"-"}}function Ce(a,r="receipt-images"){try{const t=new URL(a).pathname.split("/"),c=t.indexOf(r);return c===-1?null:t.slice(c+1).join("/")}catch{return null}}function Ie({receipt:a,onView:r,onPrint:l,onDownload:t,onDelete:c}){return e.jsx(Z,{className:"w-full border border-gray-200 hover:shadow-md transition-shadow cursor-pointer",onClick:()=>r(a),children:e.jsx(G,{className:"p-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[a.is_printed?e.jsx(q,{className:"bg-green-100 text-green-700 hover:bg-green-100 text-xs",children:"✓ 인쇄완료"}):e.jsx(q,{variant:"secondary",className:"bg-gray-100 text-gray-600 text-xs",children:"미완료"}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-gray-500",children:[e.jsx(pe,{className:"w-3 h-3"}),e.jsx("span",{children:J(a.uploaded_at)})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"w-4 h-4 text-hansl-600"}),e.jsx("span",{className:"font-semibold text-gray-900",children:a.file_name})]}),a.memo&&e.jsx("div",{className:"text-sm text-gray-900 bg-gray-50 rounded p-2",children:a.memo}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-1 text-gray-600",children:[e.jsx(le,{className:"w-3 h-3"}),e.jsx("span",{children:a.uploaded_by_name||a.uploaded_by})]}),e.jsx("span",{className:"text-gray-500",children:ie(a.file_size)})]}),e.jsxs("div",{className:`flex gap-2 pt-2 border-t border-gray-100 ${c?"grid grid-cols-3":"grid grid-cols-2"}`,children:[e.jsxs(w,{size:"sm",variant:"outline",onClick:i=>{i.stopPropagation(),l(a)},className:"flex-1",children:[e.jsx(X,{className:"w-4 h-4 mr-1"}),"인쇄"]}),e.jsxs(w,{size:"sm",variant:"outline",onClick:i=>{i.stopPropagation(),t(a)},className:"flex-1",children:[e.jsx(Y,{className:"w-4 h-4 mr-1"}),"다운로드"]}),c&&e.jsxs(w,{size:"sm",variant:"outline",onClick:i=>{i.stopPropagation(),c(a)},className:"flex-1 border-red-200 text-red-600 hover:bg-red-50",children:[e.jsx(K,{className:"w-4 h-4 mr-1"}),"삭제"]})]})]})})})}function Oe({isOpen:a,onClose:r,onSuccess:l}){const[t,c]=m.useState(null),[i,h]=m.useState(""),[v,$]=m.useState(!1),[U,k]=m.useState(!1),_=B(),{permissions:C}=Q(),P=m.useCallback(u=>{if(!u.type.startsWith("image/")){d.error("이미지 파일만 업로드할 수 있습니다.");return}if(u.size>10*1024*1024){d.error("파일 크기는 10MB 이하여야 합니다.");return}c(u)},[]),y=u=>{u.preventDefault(),k(!0)},j=u=>{u.preventDefault(),k(!1)},N=u=>{u.preventDefault(),k(!1);const O=Array.from(u.dataTransfer.files);O.length>0&&P(O[0])},D=m.useCallback(async()=>{if(!C.canUpload){d.error("업로드 권한이 없습니다.");return}if(!t){d.error("파일을 선택해주세요.");return}try{$(!0);const{data:{user:u},error:O}=await _.auth.getUser();if(O||!u)throw new Error("로그인이 필요합니다.");const{data:L,error:A}=await _.from("employees").select("name").eq("email",u.email).single(),z=L?.name||"",s=new Date,o=t.name.split(".").pop()||"jpg",x=`rec${s.getFullYear().toString().substring(2)}${(s.getMonth()+1).toString().padStart(2,"0")}${s.getDate().toString().padStart(2,"0")}${s.getHours().toString().padStart(2,"0")}${s.getMinutes().toString().padStart(2,"0")}.${o}`,n=`receipts/web/${s.getTime()}/${x}`,{error:g}=await _.storage.from("receipt-images").upload(n,t,{contentType:t.type,upsert:!1});if(g)throw g;const{data:{publicUrl:p}}=_.storage.from("receipt-images").getPublicUrl(n),{error:b}=await _.from("purchase_receipts").insert({receipt_image_url:p,file_name:x,file_size:t.size,uploaded_by:u.email,uploaded_by_name:z,memo:i||null,uploaded_at:new Date().toISOString()});if(b)throw b;d.success("영수증이 성공적으로 업로드되었습니다."),I(),l()}catch(u){console.error("업로드 오류:",u),d.error(`업로드 실패: ${u instanceof Error?u.message:u}`)}finally{$(!1)}},[t,i,C.canUpload,l]),I=m.useCallback(()=>{c(null),h(""),$(!1),k(!1),r()},[r]);return e.jsx(re,{open:a,onOpenChange:I,children:e.jsxs(ne,{className:"max-w-lg",children:[e.jsxs(he,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(ue,{className:"text-xl font-bold text-gray-900",children:"📎 영수증 업로드"}),e.jsx(w,{variant:"ghost",size:"sm",onClick:I,className:"h-8 w-8 p-0 hover:bg-gray-100",children:e.jsx(W,{className:"h-4 w-4"})})]}),e.jsx(ge,{className:"text-sm text-gray-600",children:"영수증 이미지를 업로드하고 메모를 추가할 수 있습니다."})]}),e.jsxs("div",{className:"space-y-6 pt-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(te,{className:"text-sm font-medium text-gray-700",children:"파일 선택"}),e.jsxs("div",{className:`relative border-2 border-dashed rounded-xl p-8 text-center transition-all duration-200 cursor-pointer ${U?"border-hansl-400 bg-hansl-50 scale-[1.02]":t?"border-green-400 bg-green-50":"border-gray-300 hover:border-hansl-300 hover:bg-gray-50"}`,onDragOver:y,onDragLeave:j,onDrop:N,children:[t?e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto",children:e.jsx(je,{className:"w-8 h-8 text-green-600"})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-medium text-green-800 truncate max-w-[200px] mx-auto",children:t.name}),e.jsxs("p",{className:"text-xs text-green-600",children:[(t.size/1024/1024).toFixed(2),"MB"]})]}),e.jsxs(w,{variant:"outline",size:"sm",onClick:()=>c(null),className:"mt-3 text-red-600 border-red-200 hover:bg-red-50",children:[e.jsx(W,{className:"w-3 h-3 mr-1"}),"제거"]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto",children:e.jsx(ae,{className:"w-8 h-8 text-gray-400"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700",children:"이미지를 드래그하여 놓거나 클릭하여 선택하세요"}),e.jsx("p",{className:"text-xs text-gray-500",children:"JPG, PNG, HEIC, WebP • 최대 10MB"})]})]}),!t&&e.jsx("input",{type:"file",accept:"image/*",onChange:u=>{const O=u.target.files?.[0];O&&P(O)},className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(te,{htmlFor:"memo",className:"text-sm font-medium text-gray-700",children:["메모 ",e.jsx("span",{className:"text-gray-400 text-xs",children:"(선택사항)"})]}),e.jsx(xe,{id:"memo",placeholder:"영수증에 대한 간단한 메모를 입력하세요",value:i,onChange:u=>h(u.target.value),className:"resize-none border-gray-200 focus:border-hansl-400 focus:ring-hansl-400",rows:3})]}),e.jsxs("div",{className:"flex gap-3 pt-6 border-t border-gray-100",children:[e.jsx(w,{variant:"outline",onClick:I,className:"flex-1 h-11 border-gray-200 hover:bg-gray-50",disabled:v,children:"취소"}),e.jsx(w,{onClick:D,disabled:!t||v,className:"flex-1 h-11 bg-hansl-600 hover:bg-hansl-700 text-white font-medium shadow-sm",children:v?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"업로드 중..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ae,{className:"w-4 h-4 mr-2"}),"업로드"]})})]})]})]})})}function Je(){const[a,r]=m.useState([]),[l,t]=m.useState(!0),[c,i]=m.useState(""),[h,v]=m.useState(""),[$,U]=m.useState(null),[k,_]=m.useState(!1),[C,P]=m.useState(!1),y=B(),{permissions:j,loading:N}=Q();m.useEffect(()=>{!N&&!j.canView&&d.error("영수증 관리에 접근할 권한이 없습니다.")},[j.canView,N]);const D=m.useCallback(async()=>{if(j.canView)try{t(!0);const{data:s,error:o}=await y.from("purchase_receipts").select(`
          id,
          receipt_image_url,
          file_name,
          file_size,
          uploaded_by,
          uploaded_by_name,
          uploaded_at,
          memo,
          is_printed,
          printed_at,
          printed_by,
          printed_by_name
        `).order("uploaded_at",{ascending:!1});if(o)throw o;r(s||[])}catch(s){console.error("영수증 조회 오류:",s),d.error("영수증 데이터를 불러오는데 실패했습니다.")}finally{t(!1)}},[j.canView,y]),I=m.useMemo(()=>{let s=[...a];if(c){const o=c.toLowerCase();s=s.filter(x=>x.file_name.toLowerCase().includes(o)||x.memo?.toLowerCase().includes(o)||J(x.uploaded_at).includes(c)||x.uploaded_at.includes(c))}return h&&(s=s.filter(o=>o.uploaded_at?new Date(o.uploaded_at).toISOString().split("T")[0]===h:!1)),s},[a,c,h]);m.useEffect(()=>{N||D()},[D,N]);const u=s=>{U(s),_(!0)},O=m.useCallback(async s=>{console.log("🖨️ [ReceiptsMain] 인쇄완료 처리 시작:",{receiptId:s,timestamp:new Date().toISOString(),location:"ReceiptsMain.tsx"});try{console.log("🔐 [ReceiptsMain] 사용자 인증 정보 확인 중...");const{data:{user:o},error:x}=await y.auth.getUser();if(x){console.error("❌ [ReceiptsMain] 인증 오류:",x),d.error("사용자 인증에 실패했습니다.");return}if(!o){console.error("❌ [ReceiptsMain] 사용자 정보 없음"),d.error("사용자 정보를 불러올 수 없습니다.");return}console.log("✅ [ReceiptsMain] 사용자 인증 성공:",{userId:o.id,email:o.email,lastSignIn:o.last_sign_in_at}),console.log("👤 [ReceiptsMain] 직원 정보 조회 중...");const{data:n,error:g}=await y.from("employees").select("name, purchase_role").eq("email",o.email).single();if(g){console.error("❌ [ReceiptsMain] 직원 정보 조회 실패:",g),d.error("직원 정보를 불러올 수 없습니다.");return}console.log("✅ [ReceiptsMain] 직원 정보 조회 성공:",{name:n?.name,email:o.email,role:n?.purchase_role});const p=n?.purchase_role||"",b=p.includes("app_admin")||p.includes("hr")||p.includes("lead buyer");if(console.log("🛡️ [ReceiptsMain] 권한 검증:",{role:p,hasPermission:b,isAppAdmin:p.includes("app_admin"),isHr:p.includes("hr"),isLeadBuyer:p.includes("lead buyer")}),!b){console.error("❌ [ReceiptsMain] 권한 부족:",{role:p}),d.error("인쇄완료 처리 권한이 없습니다.");return}const f={is_printed:!0,printed_at:new Date().toISOString(),printed_by:o.id,printed_by_name:n?.name||o.email};console.log("📝 [ReceiptsMain] 업데이트 데이터 준비:",f),console.log("🔄 [ReceiptsMain] 데이터베이스 업데이트 실행 중...");const S=performance.now(),{data:M,error:R}=await y.from("purchase_receipts").update(f).eq("id",s).select("*"),E=performance.now()-S;if(R){console.error("❌ [ReceiptsMain] 업데이트 실패:",{error:R,code:R.code,message:R.message,details:R.details,hint:R.hint,executionTime:`${E.toFixed(2)}ms`}),R.code==="42501"||R.message?.includes("policy")?d.error("데이터베이스 권한 오류가 발생했습니다. 관리자에게 문의하세요."):d.error(`업데이트 실패: ${R.message}`);return}console.log("✅ [ReceiptsMain] 업데이트 성공:",{updateResult:M,executionTime:`${E.toFixed(2)}ms`,affectedRows:M?.length||0}),d.success("인쇄 완료로 표시되었습니다."),console.log("🔄 [ReceiptsMain] 목록 새로고침 처리..."),D(),console.log("🎉 [ReceiptsMain] 인쇄완료 처리 완료:",{receiptId:s,success:!0,timestamp:new Date().toISOString()})}catch(o){const x=o;console.error("💥 [ReceiptsMain] 예외 발생:",{error:o,message:x?.message,stack:x?.stack,receiptId:s,timestamp:new Date().toISOString()}),d.error(`인쇄 완료 처리에 실패했습니다: ${x?.message||"알 수 없는 오류"}`)}},[y,D]),L=async s=>{if(!s.receipt_image_url){d.error("영수증 이미지가 없습니다.");return}try{const o=window.open("","_blank");if(!o){d.error("팝업이 차단되었습니다. 팝업을 허용해주세요.");return}o.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>영수증 인쇄</title>
          <style>
            * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
            }
            body {
              display: flex;
              justify-content: center;
              align-items: center;
              min-height: 100vh;
              background: white;
            }
            .receipt-image {
              max-width: 100%;
              max-height: 100vh;
              object-fit: contain;
            }
            @media print {
              body {
                margin: 0;
                padding: 0;
              }
              .receipt-image {
                max-width: 100%;
                max-height: 100%;
                width: auto;
                height: auto;
              }
            }
          </style>
        </head>
        <body>
          <img 
            src="${s.receipt_image_url}" 
            alt="영수증" 
            class="receipt-image"
            onload="window.print(); window.close();"
            onerror="alert('이미지를 불러올 수 없습니다.'); window.close();"
          />
        </body>
        </html>
      `),o.document.close(),setTimeout(()=>{confirm("인쇄를 완료하셨습니까?")&&O(s.id)},1e3)}catch(o){console.error("인쇄 오류:",o),d.error("인쇄에 실패했습니다.")}},A=async s=>{if(!s.receipt_image_url){d.error("영수증 이미지가 없습니다.");return}try{const x=new URL(s.receipt_image_url).pathname.split("/"),n=x.indexOf("receipt-images");if(n===-1)throw new Error("잘못된 영수증 URL입니다");const g=x.slice(n+1).join("/"),{data:p,error:b}=await y.storage.from("receipt-images").download(g);if(b)throw b;const f=new Blob([p],{type:"image/jpeg"}),S=window.URL.createObjectURL(f),M=document.createElement("a");M.href=S,M.download=s.file_name||`영수증_${s.id}.jpg`,document.body.appendChild(M),M.click(),document.body.removeChild(M),window.URL.revokeObjectURL(S),d.success("영수증 이미지가 다운로드되었습니다.")}catch(o){console.error("다운로드 오류:",o),d.error("다운로드에 실패했습니다.")}},z=m.useCallback(async s=>{if(!j.canDelete){d.error("삭제 권한이 없습니다.");return}if(confirm(`정말로 "${s.file_name}" 영수증을 삭제하시겠습니까?`))try{const o=Ce(s.receipt_image_url);if(o){const{error:n}=await y.storage.from("receipt-images").remove([o]);n&&console.warn("스토리지 파일 삭제 실패:",n)}const{error:x}=await y.from("purchase_receipts").delete().eq("id",s.id);if(x)throw x;d.success("영수증이 삭제되었습니다."),D()}catch(o){console.error("삭제 오류:",o),d.error("삭제에 실패했습니다.")}},[j.canDelete,D]);return e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"영수증 관리"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"업로드된 영수증을 확인하고 관리할 수 있습니다"})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-4 sm:mt-0",children:[e.jsxs(w,{onClick:()=>{console.log("업로드 버튼 클릭됨"),P(!0),console.log("모달 상태 변경됨:",!0)},className:"bg-hansl-600 hover:bg-hansl-700 text-white",children:[e.jsx(fe,{className:"w-4 h-4 mr-2"}),"영수증 업로드"]}),e.jsxs(q,{variant:"secondary",className:"text-sm",children:["총 ",I.length,"건"]})]})]}),e.jsxs(Z,{className:"mb-4 border border-gray-200",children:[e.jsx(de,{className:"bg-white border-b border-gray-200 py-3",children:e.jsxs(me,{className:"flex items-center text-gray-900 text-sm font-medium",children:[e.jsx(we,{className:"w-4 h-4 mr-2"}),"검색 필터"]})}),e.jsx(G,{className:"py-3",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-1",children:"검색"}),e.jsxs("div",{className:"relative",children:[e.jsx(ye,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 w-3 h-3 text-gray-400"}),e.jsx(se,{placeholder:"파일명, 메모, 업로드일...",value:c,onChange:s=>i(s.target.value),className:"pl-7 text-sm h-9"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-1",children:"업로드 날짜"}),e.jsx(se,{type:"date",value:h,onChange:s=>v(s.target.value),className:"text-sm h-9"})]}),e.jsx("div",{className:"flex items-end",children:e.jsx(w,{variant:"outline",onClick:()=>{i(""),v("")},className:"h-9 text-sm",children:"초기화"})})]})})]}),e.jsx(Z,{className:"overflow-hidden border border-gray-200",children:e.jsx(G,{className:"p-0",children:l||N?e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx("div",{className:"w-8 h-8 border-2 border-hansl-500 border-t-transparent rounded-full animate-spin"}),e.jsx("span",{className:"ml-3 text-gray-600",children:"로딩 중..."})]}):j.canView?I.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ce,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"영수증이 없습니다"}),e.jsx("p",{className:"text-gray-600",children:"업로드된 영수증이 없거나 검색 조건에 맞는 결과가 없습니다."})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"hidden md:block overflow-x-auto",children:e.jsxs("table",{className:"w-full min-w-fit",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"인쇄완료"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"업로드일"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"파일명"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"메모"}),j.canViewUploaderInfo&&e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"등록인"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"크기"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"액션"}),j.canDelete&&e.jsx("th",{className:"px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"삭제"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:I.map(s=>e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors cursor-pointer",onClick:()=>u(s),children:[e.jsx("td",{className:"px-4 py-3 text-sm text-center",children:s.is_printed?e.jsx(q,{className:"bg-green-100 text-green-700 hover:bg-green-100",children:"✓ 완료"}):e.jsx(q,{variant:"secondary",className:"bg-gray-100 text-gray-600",children:"미완료"})}),e.jsx("td",{className:"px-4 py-3 text-sm text-center text-gray-600",children:J(s.uploaded_at)}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900",children:s.file_name}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900",children:s.memo||"-"}),j.canViewUploaderInfo&&e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:s.uploaded_by_name||s.uploaded_by}),e.jsx("td",{className:"px-4 py-3 text-sm text-center text-gray-600",children:ie(s.file_size)}),e.jsx("td",{className:"px-4 py-3 text-sm text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx(w,{size:"sm",variant:"ghost",onClick:o=>{o.stopPropagation(),L(s)},className:"h-8 w-8 p-0",title:"인쇄",children:e.jsx(X,{className:"w-4 h-4"})}),e.jsx(w,{size:"sm",variant:"ghost",onClick:o=>{o.stopPropagation(),A(s)},className:"h-8 w-8 p-0",title:"다운로드",children:e.jsx(Y,{className:"w-4 h-4"})})]})}),j.canDelete&&e.jsx("td",{className:"px-4 py-3 text-sm text-center",children:e.jsx(w,{size:"sm",variant:"ghost",onClick:o=>{o.stopPropagation(),z(s)},className:"h-8 w-8 p-0 text-red-600 hover:bg-red-50",title:"삭제",children:e.jsx(K,{className:"w-4 h-4"})})})]},s.id))})]})}),e.jsx("div",{className:"md:hidden space-y-3 p-4",children:I.map(s=>e.jsx(Ie,{receipt:s,onView:u,onPrint:L,onDownload:A,onDelete:j.canDelete?z:void 0},s.id))})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"w-12 h-12 text-red-400 mx-auto mb-4",children:"🔒"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"접근 권한 없음"}),e.jsx("p",{className:"text-gray-600",children:"영수증 관리에 접근할 권한이 없습니다."})]})})}),$&&e.jsx($e,{receipt:$,isOpen:k,onClose:()=>{_(!1),U(null)},onDelete:()=>{D()}}),e.jsx(Oe,{isOpen:C,onClose:()=>P(!1),onSuccess:()=>{D()}})]})}export{Je as default};
//# sourceMappingURL=ReceiptsMain-C9rc0vni.js.map
