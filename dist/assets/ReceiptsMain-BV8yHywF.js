import{c as e,r as t,a as s,l as a,j as r,B as i,X as n,H as l,U as c,I as o}from"./index-C7cUK919.js";import{C as d,c as m,a as h,b as x}from"./card-BZF5vWQb.js";import{t as p,B as g}from"./index-DnVeObT1.js";import{D as u,a as f,b as y,c as w,i as j,I as b}from"./input-DVH5FPaw.js";import{D as N}from"./download-BpDxG1t0.js";import{T as v}from"./trash-2-BsWb-Sza.js";import{C as _}from"./calendar-zagxOyBn.js";import{T as k}from"./textarea-DUt95QSO.js";import{L as C}from"./label-PzZMZiut.js";import{P as S}from"./plus-CpnnSD9F.js";import{S as D}from"./search-AlGf2FeB.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const z=e("file-image",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["circle",{cx:"10",cy:"12",r:"2",key:"737tya"}],["path",{d:"m20 17-1.296-1.296a2.41 2.41 0 0 0-3.408 0L9 22",key:"wt3hpn"}]]),U=e("funnel",[["path",{d:"M10 20a1 1 0 0 0 .553.895l2 1A1 1 0 0 0 14 21v-7a2 2 0 0 1 .517-1.341L21.74 4.67A1 1 0 0 0 21 3H3a1 1 0 0 0-.742 1.67l7.225 7.989A2 2 0 0 1 10 14z",key:"sc7q7i"}]]),L=e("printer",[["path",{d:"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2",key:"143wyd"}],["path",{d:"M6 9V3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6",key:"1itne7"}],["rect",{x:"6",y:"14",width:"12",height:"8",rx:"1",key:"1ue0tg"}]]),M=e("rotate-ccw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]),O=e("upload",[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]]),$=e("zoom-in",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"11",x2:"11",y1:"8",y2:"14",key:"1vmskp"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]]),I=e("zoom-out",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]]);function P(){const[e,a]=t.useState({canView:!1,canUpload:!1,canDownload:!1,canPrint:!1,canDelete:!1,canViewUploaderInfo:!1}),[r,i]=t.useState(null),[n,l]=t.useState(!0),c=s(),o=async()=>{try{const{data:{user:e}}=await c.auth.getUser();if(!e)return void l(!1);const{data:t}=await c.from("employees").select("purchase_role").eq("email",e.email).single(),s=t?.purchase_role||"";i(s);const r=s.includes("app_admin"),n=s.includes("hr"),o=s.includes("lead buyer"),d=r||n||o;a({canView:d,canUpload:d,canDownload:d,canPrint:d,canDelete:r,canViewUploaderInfo:r})}catch(e){}finally{l(!1)}};return t.useEffect(()=>{o()},[]),{permissions:e,userRole:r,loading:n,refreshPermissions:o}}function R({receipt:e,isOpen:l,onClose:c,onDelete:o}){const[d,m]=t.useState(1),[h,x]=t.useState(0),[g,y]=t.useState(!1),[w,j]=t.useState(!1),[b,_]=t.useState({width:0,height:0}),[k,C]=t.useState(!1),S=s(),{permissions:D}=P();t.useEffect(()=>{l&&(m(1),x(0),y(!1),C(!1))},[l]);const z=t.useCallback(async()=>{a.debug("인쇄완료 처리 시작",{receiptId:e.id,receiptName:e.file_name});try{const{data:{user:t},error:s}=await S.auth.getUser();if(s)return a.error("인증 오류",s),void p.error("사용자 인증에 실패했습니다.");if(!t)return a.error("사용자 정보 없음"),void p.error("사용자 정보를 불러올 수 없습니다.");const{data:r,error:i}=await S.from("employees").select("name, purchase_role").eq("email",t.email).single();if(i)return a.error("직원 정보 조회 실패",i),void p.error("직원 정보를 불러올 수 없습니다.");const n=r?.purchase_role||"";if(!(n.includes("app_admin")||n.includes("hr")||n.includes("lead buyer")))return a.error("권한 부족",{role:n}),void p.error("인쇄완료 처리 권한이 없습니다.");const l={is_printed:!0,printed_at:(new Date).toISOString(),printed_by:t.id,printed_by_name:r?.name||t.email},c=performance.now(),{data:d,error:m}=await S.from("purchase_receipts").update(l).eq("id",e.id).select("*");performance.now();if(m)return a.error("업데이트 실패",m),void("42501"===m.code||m.message?.includes("policy")?p.error("데이터베이스 권한 오류가 발생했습니다. 관리자에게 문의하세요."):p.error(`업데이트 실패: ${m.message}`));p.success("인쇄 완료로 표시되었습니다."),o&&o(),a.debug("인쇄완료 처리 완료",{receiptId:e.id})}catch(t){const s=t;a.error("인쇄완료 처리 예외",s,{receiptId:e.id}),p.error(`인쇄 완료 처리에 실패했습니다: ${s?.message||"알 수 없는 오류"}`)}},[S,e.id,e.file_name,c,o]),U=t.useCallback(()=>{const t=window.open("","_blank");t&&(t.document.write(`\n        <!DOCTYPE html>\n        <html><head><title></title>\n        <style>@page{margin:0;size:auto;}*{margin:0;padding:0;box-sizing:border-box;}body{display:flex;justify-content:center;align-items:center;min-height:100vh;background:white;margin:0;padding:0;}.receipt-image{max-width:100%;max-height:100vh;object-fit:contain;display:block;}@media print{@page{margin:0;}body{margin:0;padding:0;background:white;}.receipt-image{max-width:100%;max-height:100%;width:auto;height:auto;page-break-inside:avoid;}}</style>\n        </head><body>\n        <img src="${e.receipt_image_url}" alt="" class="receipt-image" onload="setTimeout(function(){window.print();window.close();},100);" onerror="window.close();" />\n        </body></html>\n      `),t.document.close(),setTimeout(()=>{confirm("인쇄를 완료하셨습니까?")?(a.debug("모달 닫기 실행 중"),c(),a.debug("markAsPrinted 함수 호출 시작"),z()):a.debug("사용자가 취소함 - 인쇄완료 처리 안함")},1e3))},[e.receipt_image_url,z,c]),O=t.useCallback(async()=>{if(D.canDelete){if(confirm("정말로 이 영수증을 삭제하시겠습니까?"))try{j(!0);const t=new URL(e.receipt_image_url).pathname.split("/"),s=t.indexOf("receipt-images");if(-1!==s){const e=t.slice(s+1).join("/"),{error:r}=await S.storage.from("receipt-images").remove([e]);r&&a.warn("스토리지 파일 삭제 실패",{error:r})}const{error:r}=await S.from("purchase_receipts").delete().eq("id",e.id);if(r)throw r;p.success("영수증이 삭제되었습니다."),c(),o&&o()}catch(t){a.error("삭제 오류",t),p.error("삭제에 실패했습니다.")}finally{j(!1)}}else p.error("삭제 권한이 없습니다.")},[D.canDelete,e.id,e.receipt_image_url,c,o,S]);return r.jsx(u,{open:l,onOpenChange:c,children:r.jsx(f,{className:"w-[100vw] max-w-none h-[100vh] p-0 overflow-hidden m-0 border-0 rounded-none",children:r.jsxs("div",{className:"flex h-full",children:[r.jsxs("div",{className:"flex-1 bg-white relative overflow-hidden",children:[r.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:r.jsx("img",{src:e.receipt_image_url,alt:"영수증",className:"object-contain",style:{...(()=>{if(!k)return{width:"100%",height:"100vh"};const e=window.innerWidth-64,t=window.innerHeight,s=e/b.width,a=t/b.height,r=Math.min(s,a);return{width:b.width*r+"px",height:b.height*r+"px"}})(),transform:`scale(${d}) rotate(${h}deg)`,transformOrigin:"center"},onLoad:e=>{const t=e.currentTarget;_({width:t.naturalWidth,height:t.naturalHeight}),C(!0)},onError:()=>y(!0)})}),r.jsx(i,{variant:"ghost",size:"sm",onClick:c,className:"absolute top-4 left-4 h-10 w-10 p-0 bg-gray-900/80 hover:bg-gray-900 text-white rounded-full",children:r.jsx(n,{className:"h-5 w-5"})}),r.jsx("div",{className:"absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-900/80 rounded-full px-4 py-2",children:r.jsxs("div",{className:"flex items-center gap-2 text-white",children:[r.jsx(i,{variant:"ghost",size:"sm",onClick:()=>{m(e=>Math.max(e-.25,.5))},disabled:d<=.5,className:"h-8 w-8 p-0 text-white hover:bg-white/20",children:r.jsx(I,{className:"w-4 h-4"})}),r.jsxs("span",{className:"text-sm min-w-[40px] text-center",children:[Math.round(100*d),"%"]}),r.jsx(i,{variant:"ghost",size:"sm",onClick:()=>{m(e=>Math.min(e+.25,3))},disabled:d>=3,className:"h-8 w-8 p-0 text-white hover:bg-white/20",children:r.jsx($,{className:"w-4 h-4"})}),r.jsx("div",{className:"w-px h-4 bg-white/30 mx-1"}),r.jsx(i,{variant:"ghost",size:"sm",onClick:()=>{x(e=>(e+90)%360)},className:"h-8 w-8 p-0 text-white hover:bg-white/20",children:r.jsx(M,{className:"w-4 h-4"})})]})})]}),r.jsxs("div",{className:"w-16 bg-gray-900 flex flex-col items-center justify-center space-y-4",children:[r.jsx(i,{variant:"ghost",size:"sm",onClick:U,className:"w-12 h-12 p-0 text-white hover:bg-gray-700 rounded-lg",title:"인쇄",children:r.jsx(L,{className:"w-6 h-6"})}),r.jsx(i,{variant:"ghost",size:"sm",onClick:async()=>{try{const t=new URL(e.receipt_image_url).pathname.split("/"),s=t.indexOf("receipt-images");if(-1===s)throw new Error("잘못된 영수증 URL입니다");const a=t.slice(s+1).join("/"),{data:r,error:i}=await S.storage.from("receipt-images").download(a);if(i)throw i;const n=new Blob([r],{type:"image/jpeg"}),l=window.URL.createObjectURL(n),c=document.createElement("a");c.href=l,c.download=e.file_name||`영수증_${e.id}.jpg`,document.body.appendChild(c),c.click(),document.body.removeChild(c),window.URL.revokeObjectURL(l),p.success("영수증 이미지가 다운로드되었습니다.")}catch(t){a.error("다운로드 오류",t),p.error("다운로드에 실패했습니다.")}},className:"w-12 h-12 p-0 text-white hover:bg-gray-700 rounded-lg",title:"다운로드",children:r.jsx(N,{className:"w-6 h-6"})}),D.canDelete&&r.jsx(i,{variant:"ghost",size:"sm",onClick:O,disabled:w,className:"w-12 h-12 p-0 text-white hover:bg-red-600 rounded-lg",title:"삭제",children:w?r.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):r.jsx(v,{className:"w-6 h-6"})})]})]})})})}function T(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return`${parseFloat((e/Math.pow(1024,t)).toFixed(1))} ${["B","KB","MB","GB"][t]}`}function V(e){if(!e)return"-";try{const t=new Date(e);return isNaN(t.getTime())?"-":t.toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})}catch{return"-"}}function E({receipt:e,onView:t,onPrint:s,onDownload:a,onDelete:n}){return r.jsx(d,{className:"w-full border border-gray-200 hover:shadow-md transition-shadow cursor-pointer",onClick:()=>t(e),children:r.jsx(m,{className:"p-4",children:r.jsxs("div",{className:"space-y-3",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[e.is_printed?r.jsx(g,{className:"bg-green-100 text-green-700 hover:bg-green-100 text-xs",children:"✓ 인쇄완료"}):r.jsx(g,{variant:"secondary",className:"bg-gray-100 text-gray-600 text-xs",children:"미완료"}),r.jsxs("div",{className:"flex items-center gap-1 text-xs text-gray-500",children:[r.jsx(_,{className:"w-3 h-3"}),r.jsx("span",{children:V(e.uploaded_at)})]})]}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(l,{className:"w-4 h-4 text-hansl-600"}),r.jsx("span",{className:"font-semibold text-gray-900",children:e.file_name})]}),e.memo&&r.jsx("div",{className:"text-sm text-gray-900 bg-gray-50 rounded p-2",children:e.memo}),r.jsxs("div",{className:"flex items-center justify-between text-sm",children:[r.jsxs("div",{className:"flex items-center gap-1 text-gray-600",children:[r.jsx(c,{className:"w-3 h-3"}),r.jsx("span",{children:e.uploaded_by_name||e.uploaded_by})]}),r.jsx("span",{className:"text-gray-500",children:T(e.file_size)})]}),r.jsxs("div",{className:"flex gap-2 pt-2 border-t border-gray-100 "+(n?"grid grid-cols-3":"grid grid-cols-2"),children:[r.jsxs(i,{size:"sm",variant:"outline",onClick:t=>{t.stopPropagation(),s(e)},className:"flex-1",children:[r.jsx(L,{className:"w-4 h-4 mr-1"}),"인쇄"]}),r.jsxs(i,{size:"sm",variant:"outline",onClick:t=>{t.stopPropagation(),a(e)},className:"flex-1",children:[r.jsx(N,{className:"w-4 h-4 mr-1"}),"다운로드"]}),n&&r.jsxs(i,{size:"sm",variant:"outline",onClick:t=>{t.stopPropagation(),n(e)},className:"flex-1 border-red-200 text-red-600 hover:bg-red-50",children:[r.jsx(v,{className:"w-4 h-4 mr-1"}),"삭제"]})]})]})})})}function q({isOpen:e,onClose:a,onSuccess:l}){const[c,o]=t.useState(null),[d,m]=t.useState(""),[h,x]=t.useState(!1),[g,b]=t.useState(!1),N=s(),{permissions:v}=P(),_=t.useCallback(e=>{e.type.startsWith("image/")?e.size>10485760?p.error("파일 크기는 10MB 이하여야 합니다."):o(e):p.error("이미지 파일만 업로드할 수 있습니다.")},[]),S=t.useCallback(async()=>{if(v.canUpload)if(c)try{x(!0);const{data:{user:e},error:t}=await N.auth.getUser();if(t||!e)throw new Error("로그인이 필요합니다.");const{data:s,error:a}=await N.from("employees").select("name").eq("email",e.email).single(),r=s?.name||"",i=new Date,n=c.name.split(".").pop()||"jpg",o=`rec${i.getFullYear().toString().substring(2)}${(i.getMonth()+1).toString().padStart(2,"0")}${i.getDate().toString().padStart(2,"0")}${i.getHours().toString().padStart(2,"0")}${i.getMinutes().toString().padStart(2,"0")}.${n}`,m=`receipts/web/${i.getTime()}/${o}`,{error:h}=await N.storage.from("receipt-images").upload(m,c,{contentType:c.type,upsert:!1});if(h)throw h;const{data:{publicUrl:g}}=N.storage.from("receipt-images").getPublicUrl(m),{error:u}=await N.from("purchase_receipts").insert({receipt_image_url:g,file_name:o,file_size:c.size,uploaded_by:e.email,uploaded_by_name:r,memo:d||null,uploaded_at:(new Date).toISOString()});if(u)throw u;p.success("영수증이 성공적으로 업로드되었습니다."),D(),l()}catch(e){p.error(`업로드 실패: ${e instanceof Error?e.message:e}`)}finally{x(!1)}else p.error("파일을 선택해주세요.");else p.error("업로드 권한이 없습니다.")},[c,d,v.canUpload,l]),D=t.useCallback(()=>{o(null),m(""),x(!1),b(!1),a()},[a]);return r.jsx(u,{open:e,onOpenChange:D,children:r.jsxs(f,{className:"max-w-lg",children:[r.jsxs(y,{className:"space-y-3",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx(w,{className:"text-xl font-bold text-gray-900",children:"📎 영수증 업로드"}),r.jsx(i,{variant:"ghost",size:"sm",onClick:D,className:"h-8 w-8 p-0 hover:bg-gray-100",children:r.jsx(n,{className:"h-4 w-4"})})]}),r.jsx(j,{className:"text-sm text-gray-600",children:"영수증 이미지를 업로드하고 메모를 추가할 수 있습니다."})]}),r.jsxs("div",{className:"space-y-6 pt-2",children:[r.jsxs("div",{className:"space-y-2",children:[r.jsx(C,{className:"text-sm font-medium text-gray-700",children:"파일 선택"}),r.jsxs("div",{className:"relative border-2 border-dashed rounded-xl p-8 text-center transition-all duration-200 cursor-pointer "+(g?"border-hansl-400 bg-hansl-50 scale-[1.02]":c?"border-green-400 bg-green-50":"border-gray-300 hover:border-hansl-300 hover:bg-gray-50"),onDragOver:e=>{e.preventDefault(),b(!0)},onDragLeave:e=>{e.preventDefault(),b(!1)},onDrop:e=>{e.preventDefault(),b(!1);const t=Array.from(e.dataTransfer.files);t.length>0&&_(t[0])},children:[c?r.jsxs("div",{className:"space-y-3",children:[r.jsx("div",{className:"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto",children:r.jsx(z,{className:"w-8 h-8 text-green-600"})}),r.jsxs("div",{className:"space-y-1",children:[r.jsx("p",{className:"text-sm font-medium text-green-800 truncate max-w-[200px] mx-auto",children:c.name}),r.jsxs("p",{className:"text-xs text-green-600",children:[(c.size/1024/1024).toFixed(2),"MB"]})]}),r.jsxs(i,{variant:"outline",size:"sm",onClick:()=>o(null),className:"mt-3 text-red-600 border-red-200 hover:bg-red-50",children:[r.jsx(n,{className:"w-3 h-3 mr-1"}),"제거"]})]}):r.jsxs("div",{className:"space-y-4",children:[r.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto",children:r.jsx(O,{className:"w-8 h-8 text-gray-400"})}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("p",{className:"text-sm font-medium text-gray-700",children:"이미지를 드래그하여 놓거나 클릭하여 선택하세요"}),r.jsx("p",{className:"text-xs text-gray-500",children:"JPG, PNG, HEIC, WebP • 최대 10MB"})]})]}),!c&&r.jsx("input",{type:"file",accept:"image/*",onChange:e=>{const t=e.target.files?.[0];t&&_(t)},className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer"})]})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs(C,{htmlFor:"memo",className:"text-sm font-medium text-gray-700",children:["메모 ",r.jsx("span",{className:"text-gray-400 text-xs",children:"(선택사항)"})]}),r.jsx(k,{id:"memo",placeholder:"영수증에 대한 간단한 메모를 입력하세요",value:d,onChange:e=>m(e.target.value),className:"resize-none border-gray-200 focus:border-hansl-400 focus:ring-hansl-400",rows:3})]}),r.jsxs("div",{className:"flex gap-3 pt-6 border-t border-gray-100",children:[r.jsx(i,{variant:"outline",onClick:D,className:"flex-1 h-11 border-gray-200 hover:bg-gray-50",disabled:h,children:"취소"}),r.jsx(i,{onClick:S,disabled:!c||h,className:"flex-1 h-11 bg-hansl-600 hover:bg-hansl-700 text-white font-medium shadow-sm",children:h?r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"업로드 중..."]}):r.jsxs(r.Fragment,{children:[r.jsx(O,{className:"w-4 h-4 mr-2"}),"업로드"]})})]})]})]})})}function B(){const[e,n]=t.useState([]),[l,c]=t.useState(!0),[u,f]=t.useState(""),[y,w]=t.useState(""),[j,_]=t.useState(null),[k,C]=t.useState(!1),[z,M]=t.useState(!1),O=s(),{permissions:$,loading:I}=P();t.useEffect(()=>{I||$.canView||p.error("영수증 관리에 접근할 권한이 없습니다.")},[$.canView,I]);const B=t.useCallback(async()=>{if($.canView)try{c(!0);const{data:e,error:t}=await O.from("purchase_receipts").select("\n          id,\n          receipt_image_url,\n          file_name,\n          file_size,\n          uploaded_by,\n          uploaded_by_name,\n          uploaded_at,\n          memo,\n          is_printed,\n          printed_at,\n          printed_by,\n          printed_by_name\n        ").order("uploaded_at",{ascending:!1});if(t)throw t;n(e||[])}catch(e){p.error("영수증 데이터를 불러오는데 실패했습니다.")}finally{c(!1)}},[$.canView,O]),H=t.useMemo(()=>{let t=[...e];if(u){const e=u.toLowerCase();t=t.filter(t=>t.file_name.toLowerCase().includes(e)||t.memo?.toLowerCase().includes(e)||V(t.uploaded_at).includes(u)||t.uploaded_at.includes(u))}return y&&(t=t.filter(e=>{if(!e.uploaded_at)return!1;return new Date(e.uploaded_at).toISOString().split("T")[0]===y})),t},[e,u,y]);t.useEffect(()=>{I||B()},[B,I]);const F=e=>{_(e),C(!0)},A=t.useCallback(async e=>{a.debug("영수증 인쇄 완료 처리 시작",{receiptId:e,timestamp:(new Date).toISOString(),location:"ReceiptsMain.tsx"});try{const{data:{user:t},error:s}=await O.auth.getUser();if(s)return void p.error("사용자 인증에 실패했습니다.");if(!t)return void p.error("사용자 정보를 불러올 수 없습니다.");a.debug("사용자 인증 정보 확인 완료",{userId:t.id,email:t.email,lastSignIn:t.last_sign_in_at});const{data:r,error:i}=await O.from("employees").select("name, purchase_role").eq("email",t.email).single();if(i)return void p.error("직원 정보를 불러올 수 없습니다.");a.debug("직원 정보 조회 완료",{name:r?.name,email:t.email,role:r?.purchase_role});const n=r?.purchase_role||"",l=n.includes("app_admin")||n.includes("hr")||n.includes("lead buyer");if(a.debug("권한 검증 결과",{role:n,hasPermission:l,isAppAdmin:n.includes("app_admin"),isHr:n.includes("hr"),isLeadBuyer:n.includes("lead buyer")}),!l)return void p.error("인쇄완료 처리 권한이 없습니다.");const c={is_printed:!0,printed_at:(new Date).toISOString(),printed_by:t.id,printed_by_name:r?.name||t.email},o=performance.now(),{data:d,error:m}=await O.from("purchase_receipts").update(c).eq("id",e).select("*"),h=performance.now()-o;if(m)return a.error("영수증 인쇄완료 업데이트 실패",m,{error:m,code:m.code,message:m.message,details:m.details,hint:m.hint,executionTime:`${h.toFixed(2)}ms`}),void("42501"===m.code||m.message?.includes("policy")?p.error("데이터베이스 권한 오류가 발생했습니다. 관리자에게 문의하세요."):p.error(`업데이트 실패: ${m.message}`));a.debug("영수증 인쇄완료 업데이트 성공",{updateResult:d,executionTime:`${h.toFixed(2)}ms`,affectedRows:d?.length||0}),p.success("인쇄 완료로 표시되었습니다."),B(),a.debug("영수증 인쇄완료 처리 성공",{receiptId:e,success:!0,timestamp:(new Date).toISOString()})}catch(t){const s=t;a.error("영수증 인쇄완료 처리 중 예외 발생",t,{error:t,message:s?.message,stack:s?.stack,receiptId:e,timestamp:(new Date).toISOString()}),p.error(`인쇄 완료 처리에 실패했습니다: ${s?.message||"알 수 없는 오류"}`)}},[O,B]),W=async e=>{if(e.receipt_image_url)try{const t=window.open("","_blank");if(!t)return void p.error("팝업이 차단되었습니다. 팝업을 허용해주세요.");t.document.write(`\n        <!DOCTYPE html>\n        <html>\n        <head>\n          <title>영수증 인쇄</title>\n          <style>\n            * {\n              margin: 0;\n              padding: 0;\n              box-sizing: border-box;\n            }\n            body {\n              display: flex;\n              justify-content: center;\n              align-items: center;\n              min-height: 100vh;\n              background: white;\n            }\n            .receipt-image {\n              max-width: 100%;\n              max-height: 100vh;\n              object-fit: contain;\n            }\n            @media print {\n              body {\n                margin: 0;\n                padding: 0;\n              }\n              .receipt-image {\n                max-width: 100%;\n                max-height: 100%;\n                width: auto;\n                height: auto;\n              }\n            }\n          </style>\n        </head>\n        <body>\n          <img \n            src="${e.receipt_image_url}" \n            alt="영수증" \n            class="receipt-image"\n            onload="window.print(); window.close();"\n            onerror="alert('이미지를 불러올 수 없습니다.'); window.close();"\n          />\n        </body>\n        </html>\n      `),t.document.close(),setTimeout(()=>{confirm("인쇄를 완료하셨습니까?")&&A(e.id)},1e3)}catch(t){p.error("인쇄에 실패했습니다.")}else p.error("영수증 이미지가 없습니다.")},G=async e=>{if(e.receipt_image_url)try{const t=new URL(e.receipt_image_url).pathname.split("/"),s=t.indexOf("receipt-images");if(-1===s)throw new Error("잘못된 영수증 URL입니다");const a=t.slice(s+1).join("/"),{data:r,error:i}=await O.storage.from("receipt-images").download(a);if(i)throw i;const n=new Blob([r],{type:"image/jpeg"}),l=window.URL.createObjectURL(n),c=document.createElement("a");c.href=l,c.download=e.file_name||`영수증_${e.id}.jpg`,document.body.appendChild(c),c.click(),document.body.removeChild(c),window.URL.revokeObjectURL(l),p.success("영수증 이미지가 다운로드되었습니다.")}catch(t){p.error("다운로드에 실패했습니다.")}else p.error("영수증 이미지가 없습니다.")},Y=t.useCallback(async e=>{if($.canDelete){if(confirm(`정말로 "${e.file_name}" 영수증을 삭제하시겠습니까?`))try{const t=function(e,t="receipt-images"){try{const s=new URL(e).pathname.split("/"),a=s.indexOf(t);return-1===a?null:s.slice(a+1).join("/")}catch{return null}}(e.receipt_image_url);if(t){a.debug("Storage 파일 삭제 시작",{filePath:t});const{error:e}=await O.storage.from("receipt-images").remove([t]);e&&a.warn("Storage 파일 삭제 실패",e,{filePath:t})}const{error:s}=await O.from("purchase_receipts").delete().eq("id",e.id);if(s)throw s;p.success("영수증이 삭제되었습니다."),B()}catch(t){p.error("삭제에 실패했습니다.")}}else p.error("삭제 권한이 없습니다.")},[$.canDelete,B]);return r.jsxs("div",{className:"w-full",children:[r.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4",children:[r.jsxs("div",{children:[r.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"영수증 관리"}),r.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"업로드된 영수증을 확인하고 관리할 수 있습니다"})]}),r.jsxs("div",{className:"flex items-center gap-2 mt-4 sm:mt-0",children:[r.jsxs(i,{onClick:()=>{M(!0)},className:"bg-hansl-600 hover:bg-hansl-700 text-white",children:[r.jsx(S,{className:"w-4 h-4 mr-2"}),"영수증 업로드"]}),r.jsxs(g,{variant:"secondary",className:"text-sm",children:["총 ",H.length,"건"]})]})]}),r.jsxs(d,{className:"mb-4 border border-gray-200",children:[r.jsx(h,{className:"bg-white border-b border-gray-200 py-3",children:r.jsxs(x,{className:"flex items-center text-gray-900 text-sm font-medium",children:[r.jsx(U,{className:"w-4 h-4 mr-2"}),"검색 필터"]})}),r.jsx(m,{className:"py-3",children:r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2",children:[r.jsxs("div",{children:[r.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-1",children:"검색"}),r.jsxs("div",{className:"relative",children:[r.jsx(D,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 w-3 h-3 text-gray-400"}),r.jsx(b,{placeholder:"파일명, 메모, 업로드일...",value:u,onChange:e=>f(e.target.value),className:"pl-7 text-sm h-9"})]})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-1",children:"업로드 날짜"}),r.jsx(b,{type:"date",value:y,onChange:e=>w(e.target.value),className:"text-sm h-9"})]}),r.jsx("div",{className:"flex items-end",children:r.jsx(i,{variant:"outline",onClick:()=>{f(""),w("")},className:"h-9 text-sm",children:"초기화"})})]})})]}),r.jsx(d,{className:"overflow-hidden border border-gray-200",children:r.jsx(m,{className:"p-0",children:l||I?r.jsxs("div",{className:"flex items-center justify-center py-12",children:[r.jsx("div",{className:"w-8 h-8 border-2 border-hansl-500 border-t-transparent rounded-full animate-spin"}),r.jsx("span",{className:"ml-3 text-gray-600",children:"로딩 중..."})]}):$.canView?0===H.length?r.jsxs("div",{className:"text-center py-12",children:[r.jsx(o,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),r.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"영수증이 없습니다"}),r.jsx("p",{className:"text-gray-600",children:"업로드된 영수증이 없거나 검색 조건에 맞는 결과가 없습니다."})]}):r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"hidden md:block overflow-x-auto",children:r.jsxs("table",{className:"w-full min-w-fit",children:[r.jsx("thead",{className:"bg-gray-50",children:r.jsxs("tr",{children:[r.jsx("th",{className:"px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"인쇄완료"}),r.jsx("th",{className:"px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"업로드일"}),r.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"파일명"}),r.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"메모"}),$.canViewUploaderInfo&&r.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"등록인"}),r.jsx("th",{className:"px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"크기"}),r.jsx("th",{className:"px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"액션"}),$.canDelete&&r.jsx("th",{className:"px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider",children:"삭제"})]})}),r.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:H.map(e=>r.jsxs("tr",{className:"hover:bg-gray-50 transition-colors cursor-pointer",onClick:()=>F(e),children:[r.jsx("td",{className:"px-4 py-3 text-sm text-center",children:e.is_printed?r.jsx(g,{className:"bg-green-100 text-green-700 hover:bg-green-100",children:"✓ 완료"}):r.jsx(g,{variant:"secondary",className:"bg-gray-100 text-gray-600",children:"미완료"})}),r.jsx("td",{className:"px-4 py-3 text-sm text-center text-gray-600",children:V(e.uploaded_at)}),r.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900",children:e.file_name}),r.jsx("td",{className:"px-4 py-3 text-sm text-gray-900",children:e.memo||"-"}),$.canViewUploaderInfo&&r.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:e.uploaded_by_name||e.uploaded_by}),r.jsx("td",{className:"px-4 py-3 text-sm text-center text-gray-600",children:T(e.file_size)}),r.jsx("td",{className:"px-4 py-3 text-sm text-center",children:r.jsxs("div",{className:"flex items-center justify-center gap-1",children:[r.jsx(i,{size:"sm",variant:"ghost",onClick:t=>{t.stopPropagation(),W(e)},className:"h-8 w-8 p-0",title:"인쇄",children:r.jsx(L,{className:"w-4 h-4"})}),r.jsx(i,{size:"sm",variant:"ghost",onClick:t=>{t.stopPropagation(),G(e)},className:"h-8 w-8 p-0",title:"다운로드",children:r.jsx(N,{className:"w-4 h-4"})})]})}),$.canDelete&&r.jsx("td",{className:"px-4 py-3 text-sm text-center",children:r.jsx(i,{size:"sm",variant:"ghost",onClick:t=>{t.stopPropagation(),Y(e)},className:"h-8 w-8 p-0 text-red-600 hover:bg-red-50",title:"삭제",children:r.jsx(v,{className:"w-4 h-4"})})})]},e.id))})]})}),r.jsx("div",{className:"md:hidden space-y-3 p-4",children:H.map(e=>r.jsx(E,{receipt:e,onView:F,onPrint:W,onDownload:G,onDelete:$.canDelete?Y:void 0},e.id))})]}):r.jsxs("div",{className:"text-center py-12",children:[r.jsx("div",{className:"w-12 h-12 text-red-400 mx-auto mb-4",children:"🔒"}),r.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"접근 권한 없음"}),r.jsx("p",{className:"text-gray-600",children:"영수증 관리에 접근할 권한이 없습니다."})]})})}),j&&r.jsx(R,{receipt:j,isOpen:k,onClose:()=>{C(!1),_(null)},onDelete:()=>{B()}}),r.jsx(q,{isOpen:z,onClose:()=>M(!1),onSuccess:()=>{B()}})]})}export{B as default};
//# sourceMappingURL=ReceiptsMain-BV8yHywF.js.map
