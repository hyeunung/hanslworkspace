import{r as e,j as t}from"./ui-components-CWOoty1N.js";import{a,l as s,t as r,C as i,B as n,A as l,X as c,Y as d,I as m,$ as o,b as u,a0 as p,a1 as _,Q as h,P as x,k as g,m as v,d as b}from"./index-BoCLkSMB.js";import{f as y}from"./helpers-Buk9LCEc.js";import{u as f}from"./useConfirmDateAction-CRS4IpTm.js";import{C as j}from"./credit-card-C8FmGSFH.js";import{T as N}from"./trash-2-DArXqw6O.js";import{P as w}from"./pen-D0DAF3mt.js";import{S as k}from"./save-BakkRVdz.js";import{f as q}from"./date-utils-DDl0vnal.js";import"./excel-libs-CEylypxp.js";import"./supabase-BBTAdlcZ.js";import"./react-vendor-DlOlWAvO.js";function S({purchaseId:S,isOpen:C,onClose:D,embedded:T=!1,currentUserRoles:W=[],activeTab:I,onRefresh:$,onOptimisticUpdate:K,onDelete:U}){const[O,M]=e.useState(!1),[R,F]=e.useState(null),[L,P]=e.useState(!1),[z,A]=e.useState(null),[E,B]=e.useState([]),[J,Q]=e.useState([]),[Y,G]=e.useState([]),[H,V]=e.useState(""),[X,Z]=e.useState([]),ee=e.useMemo(()=>{if(X.length>0){const e=X.length>1?12*(X.length-1):0,t=48,a=X.reduce((e,t)=>e+t,0)+e+t;return Math.max(a,720)}const e=[120,140,80,110,130,110,120];"purchase"===I&&e.push(120),"receipt"!==I&&"done"!==I||e.push(120),"receipt"===I&&e.push(140),"done"===I&&e.push(140,140,110),L&&e.push(110);const t=e.length>1?12*(e.length-1):0,a=e.reduce((e,t)=>e+t,0)+t+48;return Math.max(a,720)},[X,I,L]),te=e.useRef(null),ae=a();e.useEffect(()=>{C&&(async()=>{try{const e="https://qvhbigvdfyvhoegkhvef.supabase.co";if(!e||e.includes("placeholder"))return void s.warn("Supabase 환경 변수가 설정되지 않음 - PurchaseDetailModal");const{data:{user:t}}=await ae.auth.getUser();if(t){let{data:e}=await ae.from("employees").select("*").eq("id",t.id).maybeSingle();if(!e&&t.email){const{data:a}=await ae.from("employees").select("*").eq("email",t.email).maybeSingle();e=a}if(e?.name&&V(e.name),e?.purchase_role){let t=[];t=Array.isArray(e.purchase_role)?e.purchase_role.map(e=>String(e).trim()):String(e.purchase_role).split(",").map(e=>e.trim()).filter(e=>e.length>0),G(t)}}}catch(e){}})()},[C]);const se=Array.isArray(W)&&W.length>0?W:Y,re=se.includes("final_approver")||se.includes("app_admin")||se.includes("ceo"),ie="approved"===R?.final_manager_status?re:re||R?.requester_name===H,ne=se.includes("app_admin")||se.includes("lead_buyer")||se.includes("lead buyer"),le=se.includes("app_admin")||R?.requester_name===H,ce=se.includes("final_approver")||se.includes("app_admin")||se.includes("ceo"),de=R?.requester_name===H,me=ce||de,oe=e.useCallback(async()=>{if(S)try{const e=a(),{data:t,error:r}=await e.from("purchase_requests").select("\n          *,\n          vendors(id, vendor_name),\n          purchase_request_items(*)\n        ").eq("id",S).single();if(r)throw r;if(t){const e=(t.purchase_request_items||[]).sort((e,t)=>(e.line_number||999999)-(t.line_number||999999)),a={...t,items:e,vendor:t.vendors||{id:0,vendor_name:"알 수 없음"},vendor_contacts:[]};F(a),A(a),B(e),s.debug("모달 데이터 새로고침 완료 - 모달 상태 유지")}}catch(e){s.error("모달 데이터 새로고침 실패",e)}},[S]),[ue,pe]=e.useState(!0),_e=S?Number(S):R?Number(R.id):NaN,he=e.useCallback(({itemId:e,selectedDate:t,action:a})=>{const s=String(e),r=(new Date).toISOString(),i=t?t.toISOString():void 0,n=e=>e?e.map(e=>String(e.id)!==s?e:"confirm"===a?{...e,is_received:!0,actual_received_date:i,received_at:r}:{...e,is_received:!1,actual_received_date:void 0,received_at:void 0}):e;F(e=>{if(!e)return e;const t=n(e.items)||[],a=t.length,s=t.filter(e=>e.is_received).length,i=a>0&&s===a;return{...e,items:t,is_received:i,received_at:i?e.received_at||r:void 0}}),A(e=>{if(!e)return e;const t=n(e.items)||[];return{...e,items:t}}),B(e=>e&&0!==e.length?e.map(e=>e.id&&String(e.id)===s?"confirm"===a?{...e,is_received:!0,actual_received_date:i,received_at:r}:{...e,is_received:!1,actual_received_date:void 0,received_at:void 0}:e):e),Number.isNaN(_e)||K?.(_e,e=>{const t=n(e.items)||e.items||[],a=t.length||e.items?.length||0,s=t.filter(e=>e.is_received).length,i=a>0&&s===a;return{...e,items:t,is_received:i,received_at:i?e.received_at||r:void 0}})},[K,_e]),xe=e.useCallback(({itemId:e,selectedDate:t,action:r})=>{const i=String(e),n=t?t.toISOString():void 0;let l=!1,c=null;if(F(e=>{if(!e)return e;const t=(e.items||[]).map(e=>String(e.id)!==i?e:"confirm"===r?{...e,is_statement_received:!0,statement_received_date:n,statement_received_by_name:H}:{...e,is_statement_received:!1,statement_received_date:null,statement_received_by_name:null});return l=t.length>0&&t.every(e=>e.is_statement_received),c=l?n||e.statement_received_at||(new Date).toISOString():null,{...e,items:t,is_statement_received:l,statement_received_at:c}}),A(e=>{if(!e)return e;const t=(e.items||[]).map(e=>String(e.id)!==i?e:"confirm"===r?{...e,is_statement_received:!0,statement_received_date:n,statement_received_by_name:H}:{...e,is_statement_received:!1,statement_received_date:null,statement_received_by_name:null});return{...e,items:t,is_statement_received:l,statement_received_at:c}}),B(e=>e?e.map(e=>String(e.id)!==i?e:"confirm"===r?{...e,is_statement_received:!0,statement_received_date:n,statement_received_by_name:H}:{...e,is_statement_received:!1,statement_received_date:null,statement_received_by_name:null}):e),Number.isNaN(_e)||K?.(_e,e=>{const t=(e.items||[]).map(e=>String(e.id)!==i?e:"confirm"===r?{...e,is_statement_received:!0,statement_received_date:n,statement_received_by_name:H}:{...e,is_statement_received:!1,statement_received_date:null,statement_received_by_name:null}),a=t.length>0&&t.every(e=>e.is_statement_received);return{...e,items:t,is_statement_received:a}}),R&&void 0!==l){a().from("purchase_requests").update({is_statement_received:l,statement_received_at:c}).eq("id",R.id).then(({error:e})=>{e&&s.error("거래명세서 확인 purchase_requests 업데이트 실패",e)})}},[H,K,_e,R]),ge=f({config:{field:"statement_received",confirmMessage:{confirm:"거래명세서 확인을 처리하시겠습니까?",cancel:"거래명세서 확인을 취소하시겠습니까?"},successMessage:{confirm:"거래명세서 확인이 완료되었습니다.",cancel:"거래명세서 확인이 취소되었습니다."},completedText:"✓ 완료",waitingText:"대기"},currentUserName:H,canPerformAction:me,onUpdate:oe,onOptimisticUpdate:xe}),ve=f({config:{field:"actual_received",confirmMessage:{confirm:"실제 입고 처리를 진행하시겠습니까?",cancel:"실제 입고 처리를 취소하시겠습니까?"},successMessage:{confirm:"실제 입고 처리가 완료되었습니다.",cancel:"실제 입고 처리가 취소되었습니다."},completedText:"입고완료",waitingText:"입고대기"},currentUserName:H,canPerformAction:me,onUpdate:oe,onOptimisticUpdate:he});s.debug("Receipt Check",{activeTab:I,canReceiptCheck:me,isAdmin:ce,isRequester:de,currentUserName:H,requesterName:R?.requester_name,effectiveRoles:se});const be=se.includes("middle_manager")||se.includes("app_admin")||se.includes("ceo"),ye=se.includes("final_approver")||se.includes("app_admin")||se.includes("ceo"),fe="inline-flex items-center gap-1 business-radius-badge !h-auto !min-h-0 !px-2.5 !py-0.5 badge-text leading-tight",je="inline-flex items-center gap-1 business-radius-badge px-2.5 py-0.5 badge-text leading-tight";s.debug("PurchaseDetailModal 권한 체크",{currentUserRoles:W,userRoles:Y,effectiveRoles:se,canApproveMiddle:be,canApproveFinal:ye,isEditing:L,middleManagerStatus:R?.middle_manager_status,finalManagerStatus:R?.final_manager_status}),e.useEffect(()=>{S&&C&&(Se(S.toString()),P(!1))},[S,C]);const Ne=e.useCallback(()=>{if(!R?.items||0===R.items.length)return[];const e=R.items??[],t=[{key:"item_name",minWidth:80,maxWidth:500,baseWidth:80},{key:"specification",minWidth:120,maxWidth:700,baseWidth:120},{key:"quantity",minWidth:70,maxWidth:100,baseWidth:70},{key:"unit_price",minWidth:90,maxWidth:150,baseWidth:90},{key:"total_price",minWidth:100,maxWidth:180,baseWidth:100},{key:"remarks",minWidth:80,maxWidth:240,baseWidth:80},{key:"status",minWidth:80,maxWidth:120,baseWidth:80}];"receipt"===I&&t.push({key:"actual_receipt_date",minWidth:100,maxWidth:160,baseWidth:100}),"done"===I&&t.push({key:"transaction_confirm",minWidth:100,maxWidth:160,baseWidth:100},{key:"accounting_date",minWidth:100,maxWidth:160,baseWidth:100},{key:"processor",minWidth:80,maxWidth:120,baseWidth:80},{key:"utk_confirm",minWidth:80,maxWidth:120,baseWidth:80});const a=t.map((t,a)=>{let r=4;const i=(()=>{const e=["품목명","규격","수량","단가","합계","비고","purchase"===I?"구매상태":"receipt"===I||"done"===I?"입고상태":"상태"];return"receipt"===I?[...e,"실제입고일"]:"done"===I?[...e,"거래명세서 확인","회계상 입고일","처리자","UTK"]:e})();i[a]&&(r=Math.max(r,i[a].length)),e.forEach(e=>{let a="";switch(t.key){case"item_name":a=e.item_name||"";break;case"specification":a=e.specification||"";break;case"quantity":a=e.quantity?.toString()||"";break;case"unit_price":a=null!=e.unit_price_value?e.unit_price_value.toLocaleString():"";break;case"total_price":a=null!=e.amount_value?e.amount_value.toLocaleString():null!=e.quantity&&null!=e.unit_price_value?(Number(e.quantity)*Number(e.unit_price_value)).toLocaleString():"";break;case"remarks":a=e.remark||"";break;case"status":a=we(e)||"";break;case"actual_receipt_date":a=e.actual_received_date?y(e.actual_received_date):"";break;case"transaction_confirm":a=e.is_statement_received?"확인완료":"미확인";break;case"accounting_date":a=e.statement_received_date?y(e.statement_received_date):"";break;case"processor":a=e.statement_received_by_name||"";break;case"utk_confirm":a=e.is_utk_checked?"완료":"대기"}const s=a.split("").reduce((e,t)=>e+(/[가-힣]/.test(t)?1.5:1),0);r=Math.max(r,Math.ceil(s))});const n=Math.max(t.minWidth,Math.min(t.maxWidth,7*r+20));return s.debug(`Column ${t.key} calculated:`,{maxLength:r,calculatedWidth:n,range:`${t.minWidth}-${t.maxWidth}px`}),n});return Z(a),s.debug("Optimal column widths calculated",{calculatedWidths:a}),a},[R,I]),we=e=>"purchase"===I?"ordered"===e.purchase_status?"발주":"구매요청":"receipt"===I?"received"===e.receipt_status?"입고":"입고대기":"ordered"===e.purchase_status?"발주":"구매요청",ke=()=>{if(X.length>0)return X.map(e=>`${e}px`).join(" ");const e=["80px","120px","70px","90px","100px","80px","80px"];return"receipt"===I?[...e,"100px"].join(" "):"done"===I?[...e,"100px","100px","80px","80px"].join(" "):e.join(" ")};e.useEffect(()=>{R&&R.items&&R.items.length>0&&!L&&Ne()},[R,L,I,Ne]);const qe=e=>{e&&!L&&Ne(),P(e)},Se=async e=>{try{M(!0);const t=a(),{data:s,error:r}=await t.from("purchase_requests").select("\n          *,\n          vendors(id, vendor_name),\n          purchase_request_items(*)\n        ").eq("id",e).single();if(r)throw r;if(s){const e=(s.purchase_request_items||[]).sort((e,t)=>(e.line_number||999999)-(t.line_number||999999)),t={...s,items:e,vendor:s.vendors||{id:0,vendor_name:"알 수 없음"},vendor_contacts:[]};F(t),A(t),B(e)}}catch(t){r.error("발주 상세 정보를 불러오는데 실패했습니다.")}finally{M(!1)}},Ce=e=>new Intl.NumberFormat("ko-KR").format(e),De=(e,t,a)=>{const s=[...E];if("amount_value"===t)s[e]={...s[e],amount_value:a};else if("quantity"===t||"unit_price_value"===t){const r="quantity"===t?a:s[e].quantity,i="unit_price_value"===t?a:s[e].unit_price_value;s[e]={...s[e],[t]:a,amount_value:r*i}}else s[e]={...s[e],[t]:a};B(s)},Te=e=>{const t=E[e];t.id&&Q([...J,t.id]);const a=E.filter((t,a)=>a!==e).sort((e,t)=>(e.line_number||999999)-(t.line_number||999999));B(a)},We=async(e,t)=>{if(!ne)return void r.error("구매완료 처리 권한이 없습니다.");const a=String(e),s="number"==typeof e?e:Number(e);if(Number.isNaN(s))return void r.error("유효하지 않은 항목 ID 입니다.");const i=R?.items?.find(e=>String(e.id)===a);if(!i)return;const n=`품명: ${i.item_name}\n규격: ${i.specification||"미입력"}\n수량: ${i.quantity?.toLocaleString()||0}${i.unit||""}\n단가: ₩${i.unit_price_value?.toLocaleString()||0}\n합계: ₩${i.amount_value?.toLocaleString()||0}`,l=t?`다음 품목을 구매완료 처리하시겠습니까?\n\n${n}`:`다음 품목의 구매완료를 취소하시겠습니까?\n\n${n}`;if(window.confirm(l))try{const{error:e}=await ae.from("purchase_request_items").update({is_payment_completed:t,payment_completed_at:t?(new Date).toISOString():null}).eq("id",s);if(e)throw e;if(F(e=>{if(!e)return null;const s=e.items?.map(e=>String(e.id)===a?{...e,is_payment_completed:t,payment_completed_at:t?(new Date).toISOString():null}:e);return{...e,items:s}}),R){const e=Number(R.id);Number.isNaN(e)||K?.(e,e=>{const s=(e.items||[]).map(e=>String(e.id)===a?{...e,is_payment_completed:t}:e),r=s.length||e.items?.length||0,i=s.filter(e=>e.is_payment_completed).length,n=r>0&&i===r;return{...e,items:s,is_payment_completed:n,payment_completed_at:n?(new Date).toISOString():null,payment_completed_by_name:n&&H||e.payment_completed_by_name}})}r.success(t?"구매완료 처리되었습니다.":"구매완료가 취소되었습니다."),await oe();const i=$?.(!0,{silent:!0});i instanceof Promise&&await i}catch(c){r.error("구매완료 처리 중 오류가 발생했습니다.")}},Ie=async e=>{if(!R)return;const t="middle"===e?"1차 승인":"최종 승인",a=`발주번호: ${R.purchase_order_number}\n\n${t}을 진행하시겠습니까?`;if(window.confirm(a))try{const t="middle"===e?{middle_manager_status:"approved"}:{final_manager_status:"approved"},{error:a}=await ae.from("purchase_requests").update(t).eq("id",R.id);if(a)throw a;F("middle"===e?e=>e?{...e,middle_manager_status:"approved"}:null:e=>e?{...e,final_manager_status:"approved"}:null),r.success(("middle"===e?"중간":"최종")+" 승인이 완료되었습니다.")}catch(s){r.error("승인 처리 중 오류가 발생했습니다.")}},$e=t.jsx("div",{className:"space-y-1 sm:space-y-4",children:O?t.jsx("div",{className:"flex items-center justify-center py-12",children:t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-hansl-600"})}):R?t.jsxs("div",{children:[t.jsx("div",{className:"bg-gray-50 rounded-lg p-2 sm:p-3 mb-1 sm:mb-2 border border-gray-100",children:t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 items-center gap-3 sm:gap-0",children:[t.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-4",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[(()=>{if(!R)return null;if(R.payment_category){const e=R.payment_category.trim();return"발주"===e?t.jsx(b,{variant:null,className:"badge-success",children:"발주"}):"구매요청"===e?t.jsx(b,{variant:null,className:"badge-primary",children:"구매요청"}):"현장결제"===e?t.jsx(b,{variant:null,className:"badge-secondary",children:"현장결제"}):t.jsx(b,{variant:null,className:"badge-primary",children:e})}return t.jsx(b,{variant:null,className:"badge-primary",children:"구매요청"})})(),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"modal-label",children:"요청자:"}),t.jsx("span",{className:"modal-value",children:R.requester_name})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(i,{className:"w-3 h-3 text-gray-500"}),t.jsxs("span",{className:"modal-subtitle",children:["청구일: ",y(R.request_date)]})]})]}),t.jsxs("div",{className:"flex items-center justify-center gap-2 sm:gap-3 flex-wrap",children:[be&&"pending"===R.middle_manager_status&&t.jsx(n,{size:"sm",variant:"outline",onClick:()=>Ie("middle"),className:`${fe} border border-gray-400 bg-white hover:bg-gray-50 hover:border-gray-500`,children:"1차 승인 대기"}),"approved"===R.middle_manager_status&&t.jsxs("div",{className:"button-approved badge-text shadow-sm",children:[t.jsx(l,{className:"w-3 h-3"}),"1차 승인완료"]}),"rejected"===R.middle_manager_status&&t.jsxs("div",{className:"button-rejected badge-text",children:[t.jsx(c,{className:"w-3 h-3"}),"1차 반려"]}),"pending"===R.middle_manager_status&&!be&&t.jsx("div",{className:`${je} border border-gray-300 text-gray-600 bg-white`,children:"1차 승인대기"}),ye&&"approved"===R.middle_manager_status&&"pending"===R.final_manager_status&&t.jsxs(n,{size:"sm",variant:"outline",onClick:()=>Ie("final"),className:`${fe} border border-gray-400 bg-white hover:bg-gray-50 hover:border-gray-500`,children:[t.jsx(l,{className:"w-3 h-3"}),"최종 승인"]}),"approved"===R.final_manager_status&&t.jsxs("div",{className:"button-approved badge-text",children:[t.jsx(l,{className:"w-3 h-3"}),"최종 승인완료"]}),"rejected"===R.final_manager_status&&t.jsxs("div",{className:"button-rejected badge-text",children:[t.jsx(c,{className:"w-3 h-3"}),"최종 반려"]}),"approved"!==R.middle_manager_status&&"pending"===R.final_manager_status&&t.jsx("div",{className:`${je} border border-gray-300 text-gray-600 bg-white`,children:"최종 승인대기"})]}),t.jsx("div",{})]})}),t.jsxs("div",{className:"flex flex-col lg:flex-row gap-3 sm:gap-6",children:[t.jsxs("div",{className:"lg:w-80 lg:flex-shrink-0 space-y-1 sm:space-y-4 relative",children:[t.jsxs("div",{className:"bg-white rounded-lg p-2 sm:p-3 border border-gray-100 shadow-sm",children:[t.jsx("div",{className:"mb-3",children:t.jsxs("h3",{className:"modal-section-title flex items-center",children:[t.jsx(d,{className:"w-4 h-4 mr-2 text-gray-600"}),R?.purchase_order_number||"PO번호 없음"]})}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[t.jsxs("div",{className:"w-32",children:[t.jsx("span",{className:"modal-label",children:"발주서 종류"}),L?t.jsx(m,{value:z?.request_type||"",onChange:e=>A(t=>t?{...t,request_type:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"일반"}):t.jsx("p",{className:"modal-value",children:R.request_type||"일반"})]}),t.jsxs("div",{className:"w-32",children:[t.jsx("span",{className:"modal-label",children:"결제 종류"}),L?t.jsx(m,{value:z?.payment_category||"",onChange:e=>A(t=>t?{...t,payment_category:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"발주/구매요청/현장결제"}):t.jsx("p",{className:"modal-value",children:R.payment_category||"-"})]})]}),t.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[t.jsxs("div",{className:"w-32",children:[t.jsx("span",{className:"modal-label",children:"입고 요청일"}),L?t.jsx(o,{onDateSelect:e=>{A(t=>t?{...t,delivery_request_date:q(e,"yyyy-MM-dd")}:null)},placeholder:"입고 요청일을 선택하세요",align:"start",side:"bottom",children:t.jsxs(n,{variant:"outline",className:"mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] justify-start text-left font-normal business-radius-input",children:[t.jsx(i,{className:"mr-1 h-3 w-3"}),z?.delivery_request_date?y(z.delivery_request_date):"날짜 선택"]})}):t.jsx("p",{className:"modal-subtitle",children:y(R.delivery_request_date)})]}),t.jsxs("div",{className:"w-32",children:[t.jsx("span",{className:"modal-label text-orange-500",children:"변경 입고일"}),L?t.jsx(o,{onDateSelect:e=>{A(t=>t?{...t,revised_delivery_request_date:q(e,"yyyy-MM-dd")}:null)},placeholder:"변경 입고일을 선택하세요",align:"start",side:"bottom",children:t.jsxs(n,{variant:"outline",className:"mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] justify-start text-left font-normal business-radius-input",children:[t.jsx(i,{className:"mr-1 h-3 w-3"}),z?.revised_delivery_request_date?y(z.revised_delivery_request_date):"날짜 선택"]})}):t.jsx("p",{className:"modal-subtitle text-orange-700",children:R.revised_delivery_request_date?y(R.revised_delivery_request_date):"미설정"})]})]})]})]}),t.jsxs("div",{className:"bg-white rounded-lg p-2 sm:p-3 border border-gray-100 shadow-sm",children:[t.jsxs("h3",{className:"modal-section-title mb-3 flex items-center",children:[t.jsx(u,{className:"w-4 h-4 mr-2 text-gray-600"}),"업체 정보"]}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[t.jsxs("div",{className:"w-32",children:[t.jsx("span",{className:"modal-label",children:"업체명"}),L?t.jsx(m,{value:z?.vendor?.vendor_name||z?.vendor_name||"",onChange:e=>A(t=>t?{...t,vendor_name:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"업체 선택"}):t.jsx("p",{className:"modal-value",children:R.vendor?.vendor_name||"-"})]}),t.jsxs("div",{className:"w-32",children:[t.jsx("span",{className:"modal-label",children:"업체 담당자"}),L?t.jsx(m,{value:z?.vendor_contacts?.[0]?.contact_name||"",onChange:e=>{A(t=>{if(!t)return null;const a=[...t.vendor_contacts||[]];return a[0]?a[0]={...a[0],contact_name:e.target.value}:a[0]={contact_name:e.target.value},{...t,vendor_contacts:a}})},className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"담당자 선택"}):t.jsx("p",{className:"modal-value",children:R.vendor_contacts?.[0]?.contact_name||"-"})]})]}),t.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[t.jsxs("div",{className:"w-32",children:[t.jsx("span",{className:"modal-label",children:"PJ업체"}),L?t.jsx(m,{value:z?.project_vendor||"",onChange:e=>A(t=>t?{...t,project_vendor:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"입력"}):t.jsx("p",{className:"modal-value",children:R.project_vendor||"-"})]}),t.jsxs("div",{className:"w-32",children:[t.jsx("span",{className:"modal-label",children:"Item"}),L?t.jsx(m,{value:z?.project_item||"",onChange:e=>A(t=>t?{...t,project_item:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"입력"}):t.jsx("p",{className:"modal-subtitle",children:R.project_item||"-"})]})]}),t.jsx("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:t.jsxs("div",{className:"w-32",children:[t.jsx("span",{className:"modal-label",children:"수주번호"}),L?t.jsx(m,{value:z?.order_number||"",onChange:e=>A(t=>t?{...t,order_number:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"입력"}):t.jsx("p",{className:"modal-subtitle",children:R.order_number||"-"})]})})]})]})]}),t.jsx("div",{className:"lg:flex-1 lg:min-w-0 relative overflow-visible",children:t.jsxs("div",{className:"bg-white rounded-lg border border-gray-100 overflow-hidden shadow-sm",children:[t.jsxs("div",{className:"p-2 sm:p-3 bg-gray-50 border-b border-gray-100 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-0",children:[t.jsxs("h3",{className:"modal-section-title flex items-center",children:[t.jsx(p,{className:"w-4 h-4 mr-2 text-gray-600"}),"품목 리스트",t.jsxs("span",{className:"ml-2 badge-secondary",children:[R.items?.length||0,"개"]})]}),!L&&t.jsxs(t.Fragment,{children:["purchase"===I&&ne&&t.jsxs(n,{size:"sm",onClick:async()=>{if(!R||!ne)return;const e=`발주번호: ${R.purchase_order_number}\n\n모든 품목을 구매완료 처리하시겠습니까?`;if(window.confirm(e))try{const e={is_payment_completed:!0,payment_completed_at:(new Date).toISOString()},{error:t}=await ae.from("purchase_request_items").update(e).eq("purchase_request_id",R.id).eq("is_payment_completed",!1);if(t)throw t;if(F(e=>{if(!e)return null;const t=e.items?.map(e=>e.is_payment_completed?e:{...e,is_payment_completed:!0,payment_completed_at:(new Date).toISOString()});return{...e,items:t}}),R){const e=Number(R.id);Number.isNaN(e)||K?.(e,e=>{const t=(e.items||[]).map(e=>({...e,is_payment_completed:!0}));return{...e,items:t,is_payment_completed:!0,payment_completed_at:(new Date).toISOString(),payment_completed_by_name:H||e.payment_completed_by_name}})}r.success("모든 품목이 구매완료 처리되었습니다."),await oe();const a=$?.(!0,{silent:!0});a instanceof Promise&&await a}catch(t){s.error("전체 구매완료 처리 오류",t),r.error("구매완료 처리 중 오류가 발생했습니다.")}},className:"button-base bg-orange-500 hover:bg-orange-600 text-white",children:[t.jsx(j,{className:"w-3 h-3 mr-1"}),"전체 구매완료"]}),"receipt"===I&&le&&t.jsx(o,{onDateSelect:async e=>{if(!R||!le)return;const t=`발주번호: ${R.purchase_order_number}\n\n전체 입고완료 처리하시겠습니까?`;if(!window.confirm(t))return;const a=R?Number(R.id):NaN,i=()=>{Number.isNaN(a)||K?.(a,t=>{const a=(t.items||[]).map(t=>({...t,is_received:!0,actual_received_date:t.actual_received_date||e.toISOString()}));return{...t,items:a,is_received:!0,received_at:(new Date).toISOString()}})};try{const t={is_received:!0,received_at:(new Date).toISOString(),actual_received_date:e.toISOString()},{data:a,error:s}=await ae.from("purchase_request_items").update(t).eq("purchase_request_id",R.id).is("actual_received_date",null).select();if(s)throw s;F(t=>{if(!t)return null;const a=t.items?.map(t=>t.actual_received_date?t:{...t,is_received:!0,received_at:(new Date).toISOString(),actual_received_date:e.toISOString()});return{...t,items:a}}),i(),r.success("모든 품목이 입고완료 처리되었습니다."),await oe();const n=$?.(!0,{silent:!0});n instanceof Promise&&await n,i()}catch(n){s.error("전체 입고완료 처리 오류",n),r.error("입고완료 처리 중 오류가 발생했습니다.")}},placeholder:"전체 입고완료 날짜를 선택하세요",align:"end",side:"bottom",children:t.jsxs(n,{size:"sm",className:"button-base button-action-primary",children:[t.jsx(_,{className:"w-3 h-3 mr-1"}),"전체 입고완료"]})}),"done"===I&&me&&t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(o,{onDateSelect:async e=>{if(!R||!me)return;const t=e.toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"}),a=`발주번호: ${R.purchase_order_number}\n\n모든 품목의 회계상 입고일을 ${t}로 등록하시겠습니까?`;if(!window.confirm(a))return;const i=e.toISOString(),n=R?Number(R.id):NaN;try{const{error:e}=await ae.from("purchase_request_items").update({is_statement_received:!0,statement_received_date:i,statement_received_by_name:H||null}).eq("purchase_request_id",R.id).eq("is_statement_received",!1);if(e)throw e;await ae.from("purchase_requests").update({is_statement_received:!0,statement_received_at:i}).eq("id",R.id),F(e=>{if(!e)return null;const t=e.items?.map(e=>e.is_statement_received?e:{...e,is_statement_received:!0,statement_received_date:i,statement_received_by_name:H||null}),a=t&&t.length>0&&t.every(e=>e.is_statement_received);return{...e,items:t,is_statement_received:a,statement_received_at:a?i:e.statement_received_at}}),Number.isNaN(n)||K?.(n,e=>{const t=(e.items||[]).map(e=>({...e,is_statement_received:!0,statement_received_date:e.statement_received_date||i,statement_received_by_name:e.statement_received_by_name||H||null}));return{...e,items:t,is_statement_received:!0,statement_received_at:i}}),r.success("모든 품목의 회계상 입고일이 등록되었습니다."),await oe();const t=$?.(!0,{silent:!0});t instanceof Promise&&await t}catch(l){s.error("전체 거래명세서 확인 처리 오류",l),r.error("거래명세서 확인 처리 중 오류가 발생했습니다.")}},placeholder:"전체 회계상 입고일을 선택하세요",align:"end",side:"bottom",children:t.jsxs(n,{size:"sm",className:"button-base button-action-primary",children:[t.jsx(d,{className:"w-3 h-3 mr-1"}),"전체 거래명세서 확인"]})}),t.jsxs(n,{size:"sm",onClick:async()=>{if(!R||!me)return;const e=`발주번호: ${R.purchase_order_number}\n\n모든 품목을 UTK 확인 처리하시겠습니까?`;if(window.confirm(e))try{const e=a(),{error:t}=await e.from("purchase_request_items").update({is_utk_checked:!0}).eq("purchase_request_id",R.id).eq("is_utk_checked",!1);if(t)throw t;if(await e.from("purchase_requests").update({is_utk_checked:!0}).eq("id",R.id),F(e=>{if(!e)return null;const t=e.items?.map(e=>e.is_utk_checked?e:{...e,is_utk_checked:!0});return{...e,items:t,is_utk_checked:!0}}),R){const e=Number(R.id);Number.isNaN(e)||K?.(e,e=>{const t=(e.items||[]).map(e=>({...e,is_utk_checked:!0}));return{...e,items:t,is_utk_checked:!0}})}r.success("모든 품목의 UTK 확인이 완료되었습니다."),await oe();const s=$?.(!0,{silent:!0});s instanceof Promise&&await s}catch(t){s.error("전체 UTK 확인 처리 오류",t),r.error("UTK 확인 처리 중 오류가 발생했습니다.")}},className:"button-base bg-orange-500 hover:bg-orange-600 text-white",children:[t.jsx(h,{className:"w-3 h-3 mr-1"}),"UTK 전체 확인 완료"]})]})]})]}),t.jsx("div",{className:"block sm:hidden bg-gray-50 px-2 py-1 border-b border-gray-100",children:t.jsx("div",{className:"text-xs font-medium text-gray-600",children:"품목 목록 (터치하여 스크롤)"})}),t.jsx("div",{className:"max-h-[50vh] sm:max-h-[40vh] w-full min-w-0 overflow-auto",children:t.jsxs("div",{style:{minWidth:`${ee}px`},children:[t.jsx("div",{className:"bg-gray-50 px-2 sm:px-3 py-1 border-b border-gray-100 sticky top-0 z-10",children:t.jsxs("div",{ref:te,className:"hidden sm:grid gap-3 modal-label",style:{gridTemplateColumns:ke()},children:[t.jsx("div",{children:"품목명"}),t.jsx("div",{children:"규격"}),t.jsx("div",{className:"text-center",children:"수량"}),t.jsx("div",{className:"text-right",children:"단가"}),t.jsx("div",{className:"text-right",children:"합계"}),t.jsx("div",{className:"text-center",children:"비고"}),L?t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"text-center",children:"삭제"}),"receipt"===I&&t.jsx(t.Fragment,{children:t.jsx("div",{className:"text-center",children:"실제입고일"})}),"done"===I&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"text-center",children:"거래명세서 확인"}),t.jsx("div",{className:"text-center",children:"회계상 입고일"}),t.jsx("div",{className:"text-center",children:"처리자"}),t.jsx("div",{className:"text-center",children:"UTK"})]})]}):t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"text-center",children:"purchase"===I?"구매상태":"receipt"===I||"done"===I?"입고상태":"상태"}),"done"===I&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"text-center",children:"거래명세서 확인"}),t.jsx("div",{className:"text-center",children:"회계상 입고일"}),t.jsx("div",{className:"text-center",children:"처리자"}),t.jsx("div",{className:"text-center",children:"UTK"})]}),"receipt"===I&&t.jsx(t.Fragment,{children:t.jsx("div",{className:"text-center",children:"실제입고일"})})]})]})}),t.jsx("div",{className:"divide-y divide-gray-100",children:(L?E:R.items)?.map((e,i)=>t.jsxs("div",{className:"px-2 sm:px-3 py-1.5 border-b border-gray-50 hover:bg-gray-50/50 transition-colors",children:[t.jsxs("div",{className:"hidden sm:grid items-center gap-3",style:{gridTemplateColumns:ke()},children:[t.jsx("div",{className:"min-w-0",children:L?t.jsx(m,{value:e.item_name,onChange:e=>De(i,"item_name",e.target.value),className:"modal-label border-gray-200 rounded-lg w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"품목명"}):t.jsx("span",{className:"modal-value",children:e.item_name||"품목명 없음"})}),t.jsx("div",{className:"min-w-0",children:L?t.jsx(m,{value:e.specification,onChange:e=>De(i,"specification",e.target.value),className:"modal-label border-gray-200 rounded-lg w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"규격"}):t.jsx("span",{className:"modal-subtitle",children:e.specification||"-"})}),t.jsx("div",{className:"text-center min-w-0",children:L?t.jsx(m,{type:"number",value:e.quantity,onChange:e=>De(i,"quantity",Number(e.target.value)),className:"modal-label border-gray-200 rounded-lg text-center w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"수량",max:"99999"}):t.jsx("span",{className:"modal-subtitle",children:e.quantity||0})}),t.jsx("div",{className:"text-right min-w-0",children:L?t.jsx(m,{type:"number",value:e.unit_price_value,onChange:e=>De(i,"unit_price_value",Number(e.target.value)),className:"modal-label border-gray-200 rounded-lg text-right w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"단가",max:"100000000000"}):t.jsxs("span",{className:"modal-subtitle",children:["₩",Ce(e.unit_price_value)]})}),t.jsx("div",{className:"text-right min-w-0",children:L?t.jsx(m,{type:"number",value:e.amount_value,onChange:e=>De(i,"amount_value",Number(e.target.value)),className:"modal-label border-gray-200 rounded-lg text-right w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"합계",max:"10000000000"}):t.jsxs("span",{className:"modal-value",children:["₩",Ce(e.amount_value||0)]})}),t.jsx("div",{className:"min-w-0 flex justify-center items-start pt-1 text-center",children:L?t.jsx(m,{value:e.remark||"",onChange:e=>De(i,"remark",e.target.value),className:"modal-label border-gray-200 rounded-lg text-center w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"비고"}):t.jsx("span",{className:"modal-subtitle text-center",children:e.remark||"-"})}),t.jsx("div",{className:"text-center flex justify-center items-start pt-1",children:L?t.jsx(n,{size:"sm",variant:"ghost",onClick:()=>Te(i),className:"text-red-600 hover:bg-red-50 rounded-lg p-1 h-6 w-6",children:t.jsx(N,{className:"w-3 h-3"})}):t.jsxs(t.Fragment,{children:["purchase"===I&&t.jsx("div",{className:"flex justify-center",children:ne?t.jsx("button",{onClick:()=>We(e.id,!e.is_payment_completed),className:"transition-colors "+(e.is_payment_completed?"button-toggle-active bg-orange-500 hover:bg-orange-600 text-white":"button-toggle-inactive"),children:e.is_payment_completed?"구매완료":"구매대기"}):t.jsx("span",{className:""+(e.is_payment_completed?"button-toggle-active bg-orange-500 text-white":"button-waiting-inactive"),children:e.is_payment_completed?"구매완료":"구매대기"})}),"receipt"===I&&t.jsx("div",{className:"flex justify-center",children:me?ve.isCompleted(e)?t.jsx("button",{onClick:()=>{ve.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-action-primary",children:ve.config.completedText}):t.jsx(o,{onDateSelect:t=>{ve.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"실제 입고된 날짜를 선택하세요",align:"center",side:"bottom",children:t.jsx("button",{className:"button-toggle-inactive",children:ve.config.waitingText})}):t.jsx("span",{className:""+(ve.isCompleted(e)?"button-action-primary":"button-waiting-inactive"),children:ve.isCompleted(e)?ve.config.completedText:ve.config.waitingText})}),"done"===I&&t.jsx("div",{className:"flex justify-center",children:t.jsx("span",{className:"button-base "+(ve.isCompleted(e)?"bg-green-500 hover:bg-green-600 text-white":"border border-gray-300 text-gray-600 bg-white hover:bg-gray-50"),children:ve.isCompleted(e)?"입고완료":"입고대기"})}),"purchase"!==I&&"receipt"!==I&&"done"!==I&&t.jsx("div",{className:"flex justify-center",children:t.jsx("span",{className:"badge-text",children:"-"})})]})}),"receipt"===I&&t.jsx("div",{className:"text-center flex justify-center items-start pt-1 pl-2",children:ve.getCompletedDate(e)?t.jsx("div",{className:"modal-subtitle text-green-700",children:new Date(ve.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})}):t.jsx("span",{className:"modal-subtitle text-gray-400",children:"-"})}),"done"===I&&t.jsx("div",{className:"text-center flex justify-center items-start pt-1",children:me?ge.isCompleted(e)?t.jsx("button",{onClick:()=>{ge.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-action-primary hover:bg-green-600 transition-colors",title:"클릭하여 거래명세서 확인 취소",children:ge.config.completedText}):t.jsx(o,{onDateSelect:t=>{ge.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"회계상 입고일을 선택하세요",align:"center",side:"bottom",children:t.jsx("button",{className:"button-toggle-inactive",onClick:()=>{},children:ge.config.waitingText})}):t.jsx("span",{className:""+(ge.isCompleted(e)?"button-action-primary":"button-waiting-inactive"),children:ge.isCompleted(e)?ge.config.completedText:ge.config.waitingText})}),"done"===I&&t.jsx("div",{className:"text-center flex justify-center items-start pt-1",children:ge.getCompletedDate(e)?t.jsx("div",{className:"modal-subtitle text-blue-700",children:new Date(ge.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})}):t.jsx("span",{className:"modal-subtitle text-gray-400",children:"-"})}),"done"===I&&t.jsx("div",{className:"text-center flex justify-center items-start pt-1",children:ge.getCompletedByName(e)?t.jsx("span",{className:"modal-subtitle text-gray-600",children:ge.getCompletedByName(e)}):t.jsx("span",{className:"modal-subtitle text-gray-400",children:"-"})}),"done"===I&&t.jsx("div",{className:"text-center flex justify-center items-start pt-1",children:me?t.jsx("button",{onClick:()=>(async(e,t)=>{if(!me)return void r.error("UTK 확인 처리 권한이 없습니다.");const i=String(e),n="number"==typeof e?e:Number(e);if(Number.isNaN(n))return void r.error("유효하지 않은 항목 ID 입니다.");const l=R?.items?.find(e=>String(e.id)===i);if(!l)return;const c=`품명: ${l.item_name}\n규격: ${l.specification||"미입력"}\n수량: ${l.quantity?.toLocaleString()||0}${l.unit||""}\n단가: ₩${l.unit_price_value?.toLocaleString()||0}\n합계: ₩${l.amount_value?.toLocaleString()||0}`,d=t?`다음 품목을 UTK 확인 처리하시겠습니까?\n\n${c}`:`다음 품목의 UTK 확인을 취소하시겠습니까?\n\n${c}`;if(window.confirm(d))try{const e=a();s.debug("UTK 확인 처리 시작",{itemId:n,isChecked:t,itemIdStr:i});const{data:l,error:c}=await e.from("purchase_request_items").update({is_utk_checked:t}).eq("id",n).select();if(c)throw s.error("UTK 확인 DB 업데이트 실패",{error:c,itemId:n,isChecked:t}),c;if(s.debug("UTK 확인 DB 업데이트 성공",{data:l}),F(e=>{if(!e)return null;const a=e.items?.map(e=>String(e.id)===i?{...e,is_utk_checked:t}:e);return{...e,items:a}}),R){const e=Number(R.id);Number.isNaN(e)||K?.(e,e=>{const a=(e.items||[]).map(e=>String(e.id)===i?{...e,is_utk_checked:t}:e),s=a.length||e.items?.length||0,r=a.filter(e=>e.is_utk_checked).length,n=s>0&&r===s;return{...e,items:a,is_utk_checked:n}})}const d=R?.items?.every(e=>String(e.id)===i?t:!0===e.is_utk_checked);if(void 0!==d&&R){s.debug("purchase_requests 업데이트 시작",{purchaseId:R.id,allChecked:d});const{error:t}=await e.from("purchase_requests").update({is_utk_checked:d}).eq("id",R.id).select();t?s.error("purchase_requests 업데이트 실패",{error:t,purchaseId:R.id,allChecked:d}):s.debug("purchase_requests 업데이트 성공",{purchaseId:R.id,allChecked:d})}r.success(t?"UTK 확인이 완료되었습니다.":"UTK 확인이 취소되었습니다."),await oe();const m=$?.(!0,{silent:!0});m instanceof Promise&&await m}catch(m){s.error("UTK 확인 처리 중 오류",m),r.error("UTK 확인 처리 중 오류가 발생했습니다.")}})(e.id,!e.is_utk_checked),className:"button-base transition-colors "+(e.is_utk_checked?"button-toggle-active bg-orange-500 hover:bg-orange-600 text-white":"button-toggle-inactive"),title:e.is_utk_checked?"UTK 확인 취소":"UTK 확인 처리",children:e.is_utk_checked?"완료":"대기"}):t.jsx("span",{className:""+(e.is_utk_checked?"button-toggle-active bg-orange-500 text-white":"button-waiting-inactive"),children:e.is_utk_checked?"완료":"대기"})})]}),t.jsxs("div",{className:"block sm:hidden space-y-2",children:[t.jsxs("div",{className:"flex justify-between items-start",children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[L?t.jsx(m,{value:e.item_name,onChange:e=>De(i,"item_name",e.target.value),className:"modal-label border-gray-200 rounded-lg w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"품목명"}):t.jsx("div",{className:"modal-value font-medium",children:e.item_name||"품목명 없음"}),L?t.jsx(m,{value:e.specification,onChange:e=>De(i,"specification",e.target.value),className:"modal-label border-gray-200 rounded-lg mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"규격"}):t.jsx("div",{className:"modal-subtitle text-gray-500",children:e.specification||"-"})]}),t.jsx("div",{className:"ml-3 text-right flex-shrink-0",children:L?t.jsx(m,{type:"number",value:e.amount_value,onChange:e=>De(i,"amount_value",Number(e.target.value)),className:"modal-label border-gray-200 rounded-lg text-right w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"합계"}):t.jsxs("div",{className:"modal-value font-semibold",children:["₩",Ce(e.amount_value||0)]})})]}),t.jsxs("div",{className:"grid grid-cols-3 gap-2 text-sm",children:[t.jsxs("div",{children:[t.jsx("span",{className:"text-gray-500 text-xs",children:"수량:"}),L?t.jsx(m,{type:"number",value:e.quantity,onChange:e=>De(i,"quantity",Number(e.target.value)),className:"modal-label border-gray-200 rounded-lg mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"수량"}):t.jsx("div",{className:"modal-subtitle",children:e.quantity||0})]}),t.jsxs("div",{children:[t.jsx("span",{className:"text-gray-500 text-xs",children:"단가:"}),L?t.jsx(m,{type:"number",value:e.unit_price_value,onChange:e=>De(i,"unit_price_value",Number(e.target.value)),className:"modal-label border-gray-200 rounded-lg mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"단가"}):t.jsxs("div",{className:"modal-subtitle",children:["₩",Ce(e.unit_price_value)]})]}),t.jsxs("div",{children:[t.jsx("span",{className:"text-gray-500 text-xs",children:"상태:"}),t.jsx("div",{className:"mt-1",children:L?t.jsx(n,{size:"sm",variant:"ghost",onClick:()=>Te(i),className:"text-red-600 hover:bg-red-50 rounded-lg p-1 h-6 w-6",children:t.jsx(N,{className:"w-3 h-3"})}):t.jsxs(t.Fragment,{children:["purchase"===I&&t.jsx(t.Fragment,{children:ne?t.jsx("button",{onClick:()=>We(e.id,!e.is_payment_completed),className:"text-xs px-2 py-1 rounded transition-colors "+(e.is_payment_completed?"bg-orange-500 text-white hover:bg-orange-600":"bg-gray-100 text-gray-600"),children:e.is_payment_completed?"구매완료":"구매대기"}):t.jsx("span",{className:"text-xs px-2 py-1 rounded "+(e.is_payment_completed?"bg-orange-500 text-white":"bg-gray-100 text-gray-400"),children:e.is_payment_completed?"구매완료":"구매대기"})}),"receipt"===I&&t.jsx(t.Fragment,{children:me?ve.isCompleted(e)?t.jsx("button",{onClick:()=>{ve.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"text-xs px-2 py-1 rounded button-action-primary",children:ve.config.completedText}):t.jsx(o,{onDateSelect:t=>{ve.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"실제 입고된 날짜를 선택하세요",align:"center",side:"bottom",children:t.jsx("button",{className:"text-xs px-2 py-1 rounded bg-gray-100 text-gray-600",children:ve.config.waitingText})}):t.jsx("span",{className:"text-xs px-2 py-1 rounded "+(ve.isCompleted(e)?"button-action-primary":"bg-gray-100 text-gray-400"),children:ve.isCompleted(e)?ve.config.completedText:ve.config.waitingText})}),"done"===I&&t.jsx(t.Fragment,{children:t.jsx("span",{className:"button-base "+(ve.isCompleted(e)?"bg-green-500 text-white":"border border-gray-300 text-gray-600 bg-white"),children:ve.isCompleted(e)?"입고완료":"입고대기"})}),"purchase"!==I&&"receipt"!==I&&"done"!==I&&t.jsx("span",{className:"text-xs text-gray-400",children:"-"})]})})]})]}),(e.remark||L)&&t.jsxs("div",{children:[t.jsx("span",{className:"text-gray-500 text-xs",children:"비고:"}),L?t.jsx(m,{value:e.remark||"",onChange:e=>De(i,"remark",e.target.value),className:"modal-label border-gray-200 rounded-lg mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"비고"}):t.jsx("div",{className:"modal-subtitle text-gray-500 mt-1",children:e.remark||"-"})]}),!L&&"receipt"===I&&ve.getCompletedDate(e)&&t.jsxs("div",{children:[t.jsx("span",{className:"text-gray-500 text-xs",children:"실제입고일:"}),t.jsxs("div",{className:"mt-1",children:[t.jsx("div",{className:"modal-subtitle text-green-700",children:new Date(ve.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})}),t.jsx("div",{className:"text-[9px] text-gray-500",children:new Date(ve.getCompletedDate(e)).toLocaleTimeString("ko-KR",{hour:"2-digit",minute:"2-digit"})})]})]}),!L&&"done"===I&&t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-500 text-xs",children:"거래명세서 확인:"}),t.jsx("div",{className:"flex items-center gap-2",children:me?ge.isCompleted(e)?t.jsx("button",{onClick:()=>{ge.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"text-xs px-2 py-1 rounded button-action-primary hover:bg-green-600 transition-colors",title:"클릭하여 거래명세서 확인 취소",children:ge.config.completedText}):t.jsx(o,{onDateSelect:t=>{ge.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"회계상 입고일을 선택하세요",align:"end",side:"bottom",children:t.jsx("button",{className:"text-xs px-2 py-1 rounded bg-gray-100 text-gray-600",onClick:()=>{},children:ge.config.waitingText})}):t.jsx("span",{className:"text-xs px-2 py-1 rounded "+(ge.isCompleted(e)?"button-action-primary":"bg-gray-100 text-gray-400"),children:ge.isCompleted(e)?ge.config.completedText:ge.config.waitingText})})]}),!L&&"done"===I&&ge.getCompletedDate(e)&&t.jsxs("div",{children:[t.jsx("span",{className:"text-gray-500 text-xs",children:"회계상 입고일:"}),t.jsx("div",{className:"mt-1",children:t.jsx("div",{className:"modal-subtitle text-blue-700",children:new Date(ge.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})})})]}),!L&&"done"===I&&ge.getCompletedByName(e)&&t.jsxs("div",{children:[t.jsx("span",{className:"text-gray-500 text-xs",children:"처리자:"}),t.jsx("div",{className:"mt-1",children:t.jsx("div",{className:"modal-subtitle text-gray-600",children:ge.getCompletedByName(e)})})]})]})]},i))})]})}),t.jsxs("div",{className:"bg-gray-50 px-2 sm:px-3 border-t border-gray-100",children:[t.jsxs("div",{className:"hidden sm:grid items-center gap-3 py-0.5",style:{gridTemplateColumns:ke()},children:[t.jsx("div",{}),t.jsx("div",{}),t.jsx("div",{}),t.jsx("div",{className:"text-right",children:t.jsx("span",{className:"text-[12px] font-bold text-gray-900",children:"총액"})}),t.jsx("div",{className:"text-right",children:t.jsxs("span",{className:"text-[12px] font-bold text-gray-900",children:["₩",Ce((L?E:R.items)?.reduce((e,t)=>e+(t.amount_value||0),0)||0)]})}),t.jsx("div",{}),t.jsx("div",{}),"receipt"===I&&t.jsx("div",{})]}),t.jsx("div",{className:"block sm:hidden py-0.5",children:t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{className:"text-[13px] font-bold text-gray-900",children:"총액"}),t.jsxs("span",{className:"text-[13px] font-bold text-gray-900",children:["₩",Ce((L?E:R.items)?.reduce((e,t)=>e+(t.amount_value||0),0)||0)]})]})})]}),L&&t.jsx("div",{className:"p-2 sm:p-3 border-t border-gray-100",children:t.jsxs(n,{size:"sm",variant:"outline",onClick:()=>{const e={item_name:"",specification:"",quantity:1,unit_price_value:0,amount_value:0,remark:"",line_number:E.reduce((e,t)=>{const a=t.line_number||0;return a>e?a:e},0)+1},t=[...E,e].sort((e,t)=>(e.line_number||999999)-(t.line_number||999999));B(t)},className:"w-full rounded-lg border-dashed border-2 border-gray-300 hover:border-gray-400 py-2 badge-text",children:[t.jsx(x,{className:"w-4 h-4 mr-1"}),"항목 추가"]})})]})})]})]}):t.jsx("div",{className:"text-center py-12",children:t.jsx("span",{className:"modal-subtitle",children:"발주 정보를 불러올 수 없습니다."})})});return T?$e:t.jsx(g,{open:C,onOpenChange:D,children:t.jsxs(v,{className:"overflow-hidden bg-white rounded-lg shadow-sm border-0 w-full sm:w-auto max-w-[calc(100vw-48px)] sm:max-w-[calc(100vw-80px)] lg:max-w-[90vw] xl:max-w-[85vw] h-[95vh] sm:h-auto sm:max-h-[90vh] lg:max-h-[85vh] sm:rounded-lg flex flex-col",showCloseButton:!1,children:[t.jsxs("div",{className:"relative px-3 sm:px-6 pt-0 sm:pt-3 lg:pt-4 pb-0 sm:pb-2 lg:pb-3 flex-shrink-0",children:[t.jsx("button",{onClick:D,className:"button-base button-action-secondary absolute right-3 sm:right-6 top-0 sm:top-3 lg:top-4 w-6 h-6 sm:w-8 sm:h-8 rounded-full",children:t.jsx(c,{className:"w-4 h-4 text-gray-500"})}),t.jsx("div",{className:"pr-8 sm:pr-16",children:t.jsxs("div",{className:"flex items-start gap-4 mb-0 sm:mb-3",children:[t.jsx("div",{className:"min-w-0 flex-1",children:t.jsx("h1",{className:"page-title mb-0 sm:mb-1",children:"발주 기본정보"})}),t.jsxs("div",{className:"flex items-center gap-3",children:[!L&&re&&t.jsxs(t.Fragment,{children:[t.jsxs(n,{size:"sm",variant:"outline",onClick:()=>qe(!0),className:"button-base button-action-secondary",children:[t.jsx(w,{className:"w-4 h-4 mr-2"}),"수정"]}),ie&&U&&t.jsxs(n,{size:"sm",variant:"outline",onClick:()=>R&&U(R),className:"button-base button-action-danger",children:[t.jsx(N,{className:"w-4 h-4 mr-2"}),"삭제"]})]}),L&&t.jsxs(t.Fragment,{children:[t.jsxs(n,{size:"sm",variant:"outline",onClick:()=>{qe(!1),A(R),B(R?.items||[]),Q([])},className:"button-base button-action-secondary",children:[t.jsx(c,{className:"w-4 h-4 mr-2"}),"취소"]}),t.jsxs(n,{size:"sm",onClick:async()=>{if(R&&z)try{s.debug("저장 시작",{purchaseId:R.id,editedItemsCount:E.length,deletedItemsCount:J.length});const e=E.reduce((e,t)=>e+(t.amount_value||0),0);s.debug("계산된 총액",{totalAmount:e});const{error:t}=await ae.from("purchase_requests").update({purchase_order_number:z.purchase_order_number||null,requester_name:z.requester_name||null,delivery_request_date:z.delivery_request_date||null,revised_delivery_request_date:z.revised_delivery_request_date||null,payment_category:z.payment_category||null,project_vendor:z.project_vendor||null,total_amount:Number(e),updated_at:(new Date).toISOString()}).eq("id",R.id);if(t)throw t;if(J.length>0){const{error:e}=await ae.from("purchase_request_items").delete().in("id",J);if(e)throw e}s.debug("저장할 editedItems",{count:E.length});for(const r of E){if(s.debug("처리 중인 item",{itemId:r.id,itemName:r.item_name,quantity:r.quantity,unitPrice:r.unit_price_value,amount:r.amount_value}),!r.item_name||!r.item_name.trim())throw new Error("품목명은 필수입니다.");if(!r.quantity||r.quantity<=0)throw new Error("수량은 0보다 커야 합니다.");if(null!==r.unit_price_value&&void 0!==r.unit_price_value&&r.unit_price_value<0)throw new Error("단가는 0 이상이어야 합니다.");if(null!==r.amount_value&&void 0!==r.amount_value&&r.amount_value<0)throw new Error("합계는 0 이상이어야 합니다.");if(r.id){s.debug("기존 항목 업데이트",{itemId:r.id});const{error:e}=await ae.from("purchase_request_items").update({item_name:r.item_name.trim(),specification:r.specification||null,quantity:Number(r.quantity),unit_price_value:Number(r.unit_price_value),unit_price_currency:R.currency||"KRW",amount_value:Number(r.amount_value),amount_currency:R.currency||"KRW",remark:r.remark||null,updated_at:(new Date).toISOString()}).eq("id",r.id);if(e)throw s.error("기존 항목 업데이트 오류",e),e}else{s.debug("새 항목 생성",{itemName:r.item_name});const e={purchase_request_id:R.id,item_name:r.item_name.trim(),specification:r.specification||null,quantity:Number(r.quantity),unit_price_value:Number(r.unit_price_value),unit_price_currency:R.currency||"KRW",amount_value:Number(r.amount_value),amount_currency:R.currency||"KRW",remark:r.remark||null,line_number:r.line_number||E.indexOf(r)+1,created_at:(new Date).toISOString()};s.debug("삽입할 데이터",{itemName:e.item_name});const{error:t}=await ae.from("purchase_request_items").insert(e);if(t)throw s.error("새 항목 생성 오류",t),t;s.debug("새 항목 생성 성공")}}s.debug("저장 완료"),r.success("발주 내역이 성공적으로 저장되었습니다."),qe(!1),Q([]),await Se(S?.toString()||"");const a=$?.(!0,{silent:!0});a instanceof Promise&&await a}catch(e){s.error("저장 중 전체 오류",e);const t=e instanceof Error?e.message:"알 수 없는 오류가 발생했습니다";r.error(`저장 실패: ${t}`)}else r.error("저장할 데이터가 없습니다.")},className:"button-base button-action-primary",children:[t.jsx(k,{className:"w-4 h-4 mr-2"}),"저장"]})]})]})]})})]}),t.jsx("div",{className:"overflow-y-auto flex-1 px-3 sm:px-6 pb-1 sm:pb-6 mt-0",children:$e})]})})}export{S as default};
//# sourceMappingURL=PurchaseDetailModal-tHeaZ7gC.js.map
