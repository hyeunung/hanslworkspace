import{r as e,j as a}from"./ui-components-CWOoty1N.js";import{c as s,a as t,l as r,t as i,k as n,m as l,B as c,X as o,D as d,H as m,J as h,d as p,C as x,Y as g,U as u,n as w,o as y,Z as b,P as j,M as f,N,S as v,I as _,_ as k}from"./index-BoCLkSMB.js";import{T as C}from"./trash-2-DArXqw6O.js";import{f as S,a as D}from"./helpers-Buk9LCEc.js";import{T as z}from"./textarea-_JP0YxTe.js";import{L as U}from"./label-dl7Y4Hku.js";import"./excel-libs-CEylypxp.js";import"./supabase-BBTAdlcZ.js";import"./react-vendor-DlOlWAvO.js";import"./date-utils-DDl0vnal.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const O=s("file-image",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["circle",{cx:"10",cy:"12",r:"2",key:"737tya"}],["path",{d:"m20 17-1.296-1.296a2.41 2.41 0 0 0-3.408 0L9 22",key:"wt3hpn"}]]),L=s("funnel",[["path",{d:"M10 20a1 1 0 0 0 .553.895l2 1A1 1 0 0 0 14 21v-7a2 2 0 0 1 .517-1.341L21.74 4.67A1 1 0 0 0 21 3H3a1 1 0 0 0-.742 1.67l7.225 7.989A2 2 0 0 1 10 14z",key:"sc7q7i"}]]),M=s("printer",[["path",{d:"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2",key:"143wyd"}],["path",{d:"M6 9V3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6",key:"1itne7"}],["rect",{x:"6",y:"14",width:"12",height:"8",rx:"1",key:"1ue0tg"}]]),P=s("rotate-ccw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]),$=s("upload",[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]]),I=s("zoom-in",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"11",x2:"11",y1:"8",y2:"14",key:"1vmskp"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]]),R=s("zoom-out",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]]);function T(){const[a,s]=e.useState({canView:!1,canUpload:!1,canDownload:!1,canPrint:!1,canDelete:!1,canViewUploaderInfo:!1}),[r,i]=e.useState(null),[n,l]=e.useState(!0),c=t(),o=async()=>{try{const{data:{user:e}}=await c.auth.getUser();if(!e)return void l(!1);const{data:a}=await c.from("employees").select("purchase_role").eq("email",e.email).single(),t=a?.purchase_role||"";i(t);const r=t.includes("app_admin"),n=t.includes("hr"),o=t.includes("lead buyer"),d=r||n||o;s({canView:d,canUpload:d,canDownload:d,canPrint:d,canDelete:r,canViewUploaderInfo:r})}catch(e){}finally{l(!1)}};return e.useEffect(()=>{o()},[]),{permissions:a,userRole:r,loading:n,refreshPermissions:o}}function V({receipt:s,isOpen:m,onClose:h,onDelete:p}){const[x,g]=e.useState(1),[u,w]=e.useState(0),[y,b]=e.useState(!1),[j,f]=e.useState(!1),[N,v]=e.useState({width:0,height:0}),[_,k]=e.useState(!1),S=t(),{permissions:D}=T();e.useEffect(()=>{m&&(g(1),w(0),b(!1),k(!1))},[m]);const z=e.useCallback(async()=>{r.debug("ì¸ì‡„ì™„ë£Œ ì²˜ë¦¬ ì‹œì‘",{receiptId:s.id,receiptName:s.file_name});try{const{data:{user:e},error:a}=await S.auth.getUser();if(a)return r.error("ì¸ì¦ ì˜¤ë¥˜",a),void i.error("ì‚¬ìš©ì ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");if(!e)return r.error("ì‚¬ìš©ì ì •ë³´ ì—†ìŒ"),void i.error("ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");const{data:t,error:n}=await S.from("employees").select("name, purchase_role").eq("email",e.email).single();if(n)return r.error("ì§ì› ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨",n),void i.error("ì§ì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");const l=t?.purchase_role||"";if(!(l.includes("app_admin")||l.includes("hr")||l.includes("lead buyer")))return r.error("ê¶Œí•œ ë¶€ì¡±",{role:l}),void i.error("ì¸ì‡„ì™„ë£Œ ì²˜ë¦¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");const c={is_printed:!0,printed_at:(new Date).toISOString(),printed_by:e.id,printed_by_name:t?.name||e.email},o=performance.now(),{data:d,error:m}=await S.from("purchase_receipts").update(c).eq("id",s.id).select("*");performance.now();if(m)return r.error("ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",m),void("42501"===m.code||m.message?.includes("policy")?i.error("ë°ì´í„°ë² ì´ìŠ¤ ê¶Œí•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”."):i.error(`ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${m.message}`));i.success("ì¸ì‡„ ì™„ë£Œë¡œ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤."),p&&p(),r.debug("ì¸ì‡„ì™„ë£Œ ì²˜ë¦¬ ì™„ë£Œ",{receiptId:s.id})}catch(e){const a=e;r.error("ì¸ì‡„ì™„ë£Œ ì²˜ë¦¬ ì˜ˆì™¸",a,{receiptId:s.id}),i.error(`ì¸ì‡„ ì™„ë£Œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${a?.message||"ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"}`)}},[S,s.id,s.file_name,h,p]),U=e.useCallback(()=>{const e=window.open("","_blank");e&&(e.document.write(`\n        <!DOCTYPE html>\n        <html><head><title></title>\n        <style>@page{margin:0;size:auto;}*{margin:0;padding:0;box-sizing:border-box;}body{display:flex;justify-content:center;align-items:center;min-height:100vh;background:white;margin:0;padding:0;}.receipt-image{max-width:100%;max-height:100vh;object-fit:contain;display:block;}@media print{@page{margin:0;}body{margin:0;padding:0;background:white;}.receipt-image{max-width:100%;max-height:100%;width:auto;height:auto;page-break-inside:avoid;}}</style>\n        </head><body>\n        <img src="${s.receipt_image_url}" alt="" class="receipt-image" onload="setTimeout(function(){window.print();window.close();},100);" onerror="window.close();" />\n        </body></html>\n      `),e.document.close(),setTimeout(()=>{confirm("ì¸ì‡„ë¥¼ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆê¹Œ?")?(r.debug("ëª¨ë‹¬ ë‹«ê¸° ì‹¤í–‰ ì¤‘"),h(),r.debug("markAsPrinted í•¨ìˆ˜ í˜¸ì¶œ ì‹œì‘"),z()):r.debug("ì‚¬ìš©ìê°€ ì·¨ì†Œí•¨ - ì¸ì‡„ì™„ë£Œ ì²˜ë¦¬ ì•ˆí•¨")},1e3))},[s.receipt_image_url,z,h]),O=e.useCallback(async()=>{if(D.canDelete){if(confirm("ì •ë§ë¡œ ì´ ì˜ìˆ˜ì¦ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"))try{f(!0);const e=new URL(s.receipt_image_url).pathname.split("/"),a=e.indexOf("receipt-images");if(-1!==a){const s=e.slice(a+1).join("/"),{error:t}=await S.storage.from("receipt-images").remove([s]);t&&r.warn("ìŠ¤í† ë¦¬ì§€ íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨",{error:t})}const{error:t}=await S.from("purchase_receipts").delete().eq("id",s.id);if(t)throw t;i.success("ì˜ìˆ˜ì¦ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."),h(),p&&p()}catch(e){r.error("ì‚­ì œ ì˜¤ë¥˜",e),i.error("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}finally{f(!1)}}else i.error("ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")},[D.canDelete,s.id,s.receipt_image_url,h,p,S]);return a.jsx(n,{open:m,onOpenChange:h,children:a.jsx(l,{className:"w-[100vw] max-w-none h-[100vh] p-0 overflow-hidden m-0 border-0 rounded-none",children:a.jsxs("div",{className:"flex h-full",children:[a.jsxs("div",{className:"flex-1 bg-white relative overflow-hidden",children:[a.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:a.jsx("img",{src:s.receipt_image_url,alt:"ì˜ìˆ˜ì¦",className:"object-contain",style:{...(()=>{if(!_)return{width:"100%",height:"100vh"};const e=window.innerWidth-64,a=window.innerHeight,s=e/N.width,t=a/N.height,r=Math.min(s,t);return{width:N.width*r+"px",height:N.height*r+"px"}})(),transform:`scale(${x}) rotate(${u}deg)`,transformOrigin:"center"},onLoad:e=>{const a=e.currentTarget;v({width:a.naturalWidth,height:a.naturalHeight}),k(!0)},onError:()=>b(!0)})}),a.jsx(c,{variant:"ghost",size:"sm",onClick:h,className:"absolute top-4 left-4 h-10 w-10 p-0 bg-gray-900/80 hover:bg-gray-900 text-white rounded-full",children:a.jsx(o,{className:"h-5 w-5"})}),a.jsx("div",{className:"absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-900/80 rounded-full px-4 py-2",children:a.jsxs("div",{className:"flex items-center gap-2 text-white",children:[a.jsx(c,{variant:"ghost",size:"sm",onClick:()=>{g(e=>Math.max(e-.25,.5))},disabled:x<=.5,className:"h-7 w-7 p-0 text-white hover:bg-white/20",children:a.jsx(R,{className:"w-4 h-4"})}),a.jsxs("span",{className:"modal-subtitle min-w-[40px] text-center",children:[Math.round(100*x),"%"]}),a.jsx(c,{variant:"ghost",size:"sm",onClick:()=>{g(e=>Math.min(e+.25,3))},disabled:x>=3,className:"h-7 w-7 p-0 text-white hover:bg-white/20",children:a.jsx(I,{className:"w-4 h-4"})}),a.jsx("div",{className:"w-px h-4 bg-white/30 mx-1"}),a.jsx(c,{variant:"ghost",size:"sm",onClick:()=>{w(e=>(e+90)%360)},className:"h-7 w-7 p-0 text-white hover:bg-white/20",children:a.jsx(P,{className:"w-4 h-4"})})]})})]}),a.jsxs("div",{className:"w-16 bg-gray-900 flex flex-col items-center justify-center space-y-4",children:[a.jsx(c,{variant:"ghost",size:"sm",onClick:U,className:"w-10 h-10 p-0 text-white hover:bg-gray-700 rounded-lg",title:"ì¸ì‡„",children:a.jsx(M,{className:"w-6 h-6"})}),a.jsx(c,{variant:"ghost",size:"sm",onClick:async()=>{try{const e=new URL(s.receipt_image_url).pathname.split("/"),a=e.indexOf("receipt-images");if(-1===a)throw new Error("ì˜ëª»ëœ ì˜ìˆ˜ì¦ URLì…ë‹ˆë‹¤");const t=e.slice(a+1).join("/"),{data:r,error:n}=await S.storage.from("receipt-images").download(t);if(n)throw n;const l=new Blob([r],{type:"image/jpeg"}),c=window.URL.createObjectURL(l),o=document.createElement("a");o.href=c,o.download=s.file_name||`ì˜ìˆ˜ì¦_${s.id}.jpg`,document.body.appendChild(o),o.click(),document.body.removeChild(o),window.URL.revokeObjectURL(c),i.success("ì˜ìˆ˜ì¦ ì´ë¯¸ì§€ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.")}catch(e){r.error("ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜",e),i.error("ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}},className:"w-10 h-10 p-0 text-white hover:bg-gray-700 rounded-lg",title:"ë‹¤ìš´ë¡œë“œ",children:a.jsx(d,{className:"w-6 h-6"})}),D.canDelete&&a.jsx(c,{variant:"ghost",size:"sm",onClick:O,disabled:j,className:"w-10 h-10 p-0 text-white hover:bg-red-600 rounded-lg",title:"ì‚­ì œ",children:j?a.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):a.jsx(C,{className:"w-6 h-6"})})]})]})})})}function E({receipt:e,onView:s,onPrint:t,onDownload:r,onDelete:i}){return a.jsx(m,{className:"w-full border border-gray-200 hover:shadow-md transition-shadow cursor-pointer",onClick:()=>s(e),children:a.jsx(h,{className:"p-4",children:a.jsxs("div",{className:"space-y-3",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[e.is_printed?a.jsx(p,{className:"bg-green-100 text-green-700 hover:bg-green-100 badge-text",children:"âœ“ ì¸ì‡„ì™„ë£Œ"}):a.jsx(p,{variant:"secondary",className:"bg-gray-100 text-gray-600 badge-text",children:"ë¯¸ì™„ë£Œ"}),a.jsxs("div",{className:"flex items-center gap-1 badge-text text-gray-500",children:[a.jsx(x,{className:"w-3 h-3"}),a.jsx("span",{children:S(e.uploaded_at)})]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(g,{className:"w-4 h-4 text-hansl-600"}),a.jsx("span",{className:"card-title text-gray-900",children:e.file_name})]}),e.memo&&a.jsx("div",{className:"card-subtitle text-gray-900 bg-gray-50 rounded p-2",children:e.memo}),a.jsxs("div",{className:"flex items-center justify-between card-subtitle",children:[a.jsxs("div",{className:"flex items-center gap-1 text-gray-600",children:[a.jsx(u,{className:"w-3 h-3"}),a.jsx("span",{children:e.uploaded_by_name||e.uploaded_by})]}),a.jsx("span",{className:"text-gray-500",children:D(e.file_size)})]}),a.jsxs("div",{className:"flex gap-2 pt-2 border-t border-gray-100 "+(i?"grid grid-cols-3":"grid grid-cols-2"),children:[a.jsxs(c,{size:"sm",variant:"outline",onClick:a=>{a.stopPropagation(),t(e)},className:"flex-1",children:[a.jsx(M,{className:"w-4 h-4 mr-1"}),"ì¸ì‡„"]}),a.jsxs(c,{size:"sm",variant:"outline",onClick:a=>{a.stopPropagation(),r(e)},className:"flex-1",children:[a.jsx(d,{className:"w-4 h-4 mr-1"}),"ë‹¤ìš´ë¡œë“œ"]}),i&&a.jsxs(c,{size:"sm",variant:"outline",onClick:a=>{a.stopPropagation(),i(e)},className:"flex-1 border-red-200 text-red-600 hover:bg-red-50",children:[a.jsx(C,{className:"w-4 h-4 mr-1"}),"ì‚­ì œ"]})]})]})})})}function q({isOpen:s,onClose:r,onSuccess:d}){const[m,h]=e.useState(null),[p,x]=e.useState(""),[g,u]=e.useState(!1),[j,f]=e.useState(!1),N=t(),{permissions:v}=T(),_=e.useCallback(e=>{e.type.startsWith("image/")?e.size>10485760?i.error("íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤."):h(e):i.error("ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")},[]),k=e.useCallback(async()=>{if(v.canUpload)if(m)try{u(!0);const{data:{user:e},error:a}=await N.auth.getUser();if(a||!e)throw new Error("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");const{data:s,error:t}=await N.from("employees").select("name").eq("email",e.email).single(),r=s?.name||"",n=new Date,l=m.name.split(".").pop()||"jpg",c=`rec${n.getFullYear().toString().substring(2)}${(n.getMonth()+1).toString().padStart(2,"0")}${n.getDate().toString().padStart(2,"0")}${n.getHours().toString().padStart(2,"0")}${n.getMinutes().toString().padStart(2,"0")}.${l}`,o=`receipts/web/${n.getTime()}/${c}`,{error:h}=await N.storage.from("receipt-images").upload(o,m,{contentType:m.type,upsert:!1});if(h)throw h;const{data:{publicUrl:x}}=N.storage.from("receipt-images").getPublicUrl(o),{error:g}=await N.from("purchase_receipts").insert({receipt_image_url:x,file_name:c,file_size:m.size,uploaded_by:e.email,uploaded_by_name:r,memo:p||null,uploaded_at:(new Date).toISOString()});if(g)throw g;i.success("ì˜ìˆ˜ì¦ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤."),C(),d()}catch(e){i.error(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${e instanceof Error?e.message:e}`)}finally{u(!1)}else i.error("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");else i.error("ì—…ë¡œë“œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")},[m,p,v.canUpload,d]),C=e.useCallback(()=>{h(null),x(""),u(!1),f(!1),r()},[r]);return a.jsx(n,{open:s,onOpenChange:C,children:a.jsxs(l,{className:"max-w-lg",children:[a.jsxs(w,{className:"space-y-3",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(y,{className:"modal-title",children:"ğŸ“ ì˜ìˆ˜ì¦ ì—…ë¡œë“œ"}),a.jsx(c,{variant:"ghost",size:"sm",onClick:C,className:"h-7 w-7 p-0 hover:bg-gray-100",children:a.jsx(o,{className:"h-4 w-4"})})]}),a.jsx(b,{className:"modal-subtitle",children:"ì˜ìˆ˜ì¦ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³  ë©”ëª¨ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."})]}),a.jsxs("div",{className:"space-y-6 pt-2",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(U,{className:"modal-label",children:"íŒŒì¼ ì„ íƒ"}),a.jsxs("div",{className:"relative border-2 border-dashed rounded-xl p-8 text-center transition-all duration-200 cursor-pointer "+(j?"border-hansl-400 bg-hansl-50 scale-[1.02]":m?"border-green-400 bg-green-50":"border-gray-300 hover:border-hansl-300 hover:bg-gray-50"),onDragOver:e=>{e.preventDefault(),f(!0)},onDragLeave:e=>{e.preventDefault(),f(!1)},onDrop:e=>{e.preventDefault(),f(!1);const a=Array.from(e.dataTransfer.files);a.length>0&&_(a[0])},children:[m?a.jsxs("div",{className:"space-y-3",children:[a.jsx("div",{className:"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto",children:a.jsx(O,{className:"w-8 h-8 text-green-600"})}),a.jsxs("div",{className:"space-y-1",children:[a.jsx("p",{className:"modal-value text-green-800 truncate max-w-[200px] mx-auto",children:m.name}),a.jsxs("p",{className:"badge-text text-green-600",children:[(m.size/1024/1024).toFixed(2),"MB"]})]}),a.jsxs(c,{variant:"outline",size:"sm",onClick:()=>h(null),className:"mt-3 text-red-600 border-red-200 hover:bg-red-50",children:[a.jsx(o,{className:"w-3 h-3 mr-1"}),"ì œê±°"]})]}):a.jsxs("div",{className:"space-y-4",children:[a.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto",children:a.jsx($,{className:"w-8 h-8 text-gray-400"})}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("p",{className:"modal-value",children:"ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ë†“ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”"}),a.jsx("p",{className:"badge-text text-gray-500",children:"JPG, PNG, HEIC, WebP â€¢ ìµœëŒ€ 10MB"})]})]}),!m&&a.jsx("input",{type:"file",accept:"image/*",onChange:e=>{const a=e.target.files?.[0];a&&_(a)},className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer"})]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs(U,{htmlFor:"memo",className:"modal-label",children:["ë©”ëª¨ ",a.jsx("span",{className:"text-gray-400 badge-text",children:"(ì„ íƒì‚¬í•­)"})]}),a.jsx(z,{id:"memo",placeholder:"ì˜ìˆ˜ì¦ì— ëŒ€í•œ ê°„ë‹¨í•œ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”",value:p,onChange:e=>x(e.target.value),className:"resize-none border-gray-200 focus:border-hansl-400 focus:ring-hansl-400",rows:3})]}),a.jsxs("div",{className:"flex gap-3 pt-6 border-t border-gray-100",children:[a.jsx(c,{variant:"outline",onClick:C,className:"flex-1 h-9 border-gray-200 hover:bg-gray-50",disabled:g,children:"ì·¨ì†Œ"}),a.jsx(c,{onClick:k,disabled:!m||g,className:"flex-1 h-9 bg-hansl-600 hover:bg-hansl-700 text-white badge-text shadow-sm",children:g?a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"ì—…ë¡œë“œ ì¤‘..."]}):a.jsxs(a.Fragment,{children:[a.jsx($,{className:"w-4 h-4 mr-2"}),"ì—…ë¡œë“œ"]})})]})]})]})})}function H(){const[s,n]=e.useState([]),[l,o]=e.useState(!0),[x,g]=e.useState(""),[u,w]=e.useState(""),[y,b]=e.useState(null),[z,U]=e.useState(!1),[O,P]=e.useState(!1),$=t(),{permissions:I,loading:R}=T();e.useEffect(()=>{R||I.canView||i.error("ì˜ìˆ˜ì¦ ê´€ë¦¬ì— ì ‘ê·¼í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")},[I.canView,R]);const H=e.useCallback(async()=>{if(I.canView)try{o(!0);const{data:e,error:a}=await $.from("purchase_receipts").select("\n          id,\n          receipt_image_url,\n          file_name,\n          file_size,\n          uploaded_by,\n          uploaded_by_name,\n          uploaded_at,\n          memo,\n          is_printed,\n          printed_at,\n          printed_by,\n          printed_by_name\n        ").order("uploaded_at",{ascending:!1});if(a)throw a;n(e||[])}catch(e){i.error("ì˜ìˆ˜ì¦ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}finally{o(!1)}},[I.canView,$]),B=e.useMemo(()=>{let e=[...s];if(x){const a=x.toLowerCase();e=e.filter(e=>e.file_name.toLowerCase().includes(a)||e.memo?.toLowerCase().includes(a)||S(e.uploaded_at).includes(x)||e.uploaded_at.includes(x))}return u&&(e=e.filter(e=>{if(!e.uploaded_at)return!1;return new Date(e.uploaded_at).toISOString().split("T")[0]===u})),e},[s,x,u]);e.useEffect(()=>{R||H()},[H,R]);const A=e=>{b(e),U(!0)},F=e.useCallback(async e=>{r.debug("ì˜ìˆ˜ì¦ ì¸ì‡„ ì™„ë£Œ ì²˜ë¦¬ ì‹œì‘",{receiptId:e,timestamp:(new Date).toISOString(),location:"ReceiptsMain.tsx"});try{const{data:{user:a},error:s}=await $.auth.getUser();if(s)return void i.error("ì‚¬ìš©ì ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");if(!a)return void i.error("ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");r.debug("ì‚¬ìš©ì ì¸ì¦ ì •ë³´ í™•ì¸ ì™„ë£Œ",{userId:a.id,email:a.email,lastSignIn:a.last_sign_in_at});const{data:t,error:n}=await $.from("employees").select("name, purchase_role").eq("email",a.email).single();if(n)return void i.error("ì§ì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");r.debug("ì§ì› ì •ë³´ ì¡°íšŒ ì™„ë£Œ",{name:t?.name,email:a.email,role:t?.purchase_role});const l=t?.purchase_role||"",c=l.includes("app_admin")||l.includes("hr")||l.includes("lead buyer");if(r.debug("ê¶Œí•œ ê²€ì¦ ê²°ê³¼",{role:l,hasPermission:c,isAppAdmin:l.includes("app_admin"),isHr:l.includes("hr"),isLeadBuyer:l.includes("lead buyer")}),!c)return void i.error("ì¸ì‡„ì™„ë£Œ ì²˜ë¦¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");const o={is_printed:!0,printed_at:(new Date).toISOString(),printed_by:a.id,printed_by_name:t?.name||a.email},d=performance.now(),{data:m,error:h}=await $.from("purchase_receipts").update(o).eq("id",e).select("*"),p=performance.now()-d;if(h)return r.error("ì˜ìˆ˜ì¦ ì¸ì‡„ì™„ë£Œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",h,{error:h,code:h.code,message:h.message,details:h.details,hint:h.hint,executionTime:`${p.toFixed(2)}ms`}),void("42501"===h.code||h.message?.includes("policy")?i.error("ë°ì´í„°ë² ì´ìŠ¤ ê¶Œí•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”."):i.error(`ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${h.message}`));r.debug("ì˜ìˆ˜ì¦ ì¸ì‡„ì™„ë£Œ ì—…ë°ì´íŠ¸ ì„±ê³µ",{updateResult:m,executionTime:`${p.toFixed(2)}ms`,affectedRows:m?.length||0}),i.success("ì¸ì‡„ ì™„ë£Œë¡œ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤."),H(),r.debug("ì˜ìˆ˜ì¦ ì¸ì‡„ì™„ë£Œ ì²˜ë¦¬ ì„±ê³µ",{receiptId:e,success:!0,timestamp:(new Date).toISOString()})}catch(a){const s=a;r.error("ì˜ìˆ˜ì¦ ì¸ì‡„ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸ ë°œìƒ",a,{error:a,message:s?.message,stack:s?.stack,receiptId:e,timestamp:(new Date).toISOString()}),i.error(`ì¸ì‡„ ì™„ë£Œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${s?.message||"ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"}`)}},[$,H]),W=async e=>{if(e.receipt_image_url)try{const a=window.open("","_blank");if(!a)return void i.error("íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");a.document.write(`\n        <!DOCTYPE html>\n        <html>\n        <head>\n          <title>ì˜ìˆ˜ì¦ ì¸ì‡„</title>\n          <style>\n            * {\n              margin: 0;\n              padding: 0;\n              box-sizing: border-box;\n            }\n            body {\n              display: flex;\n              justify-content: center;\n              align-items: center;\n              min-height: 100vh;\n              background: white;\n            }\n            .receipt-image {\n              max-width: 100%;\n              max-height: 100vh;\n              object-fit: contain;\n            }\n            @media print {\n              body {\n                margin: 0;\n                padding: 0;\n              }\n              .receipt-image {\n                max-width: 100%;\n                max-height: 100%;\n                width: auto;\n                height: auto;\n              }\n            }\n          </style>\n        </head>\n        <body>\n          <img \n            src="${e.receipt_image_url}" \n            alt="ì˜ìˆ˜ì¦" \n            class="receipt-image"\n            onload="window.print(); window.close();"\n            onerror="alert('ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); window.close();"\n          />\n        </body>\n        </html>\n      `),a.document.close(),setTimeout(()=>{confirm("ì¸ì‡„ë¥¼ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆê¹Œ?")&&F(e.id)},1e3)}catch(a){i.error("ì¸ì‡„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}else i.error("ì˜ìˆ˜ì¦ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.")},Y=async e=>{if(e.receipt_image_url)try{const a=new URL(e.receipt_image_url).pathname.split("/"),s=a.indexOf("receipt-images");if(-1===s)throw new Error("ì˜ëª»ëœ ì˜ìˆ˜ì¦ URLì…ë‹ˆë‹¤");const t=a.slice(s+1).join("/"),{data:r,error:n}=await $.storage.from("receipt-images").download(t);if(n)throw n;const l=new Blob([r],{type:"image/jpeg"}),c=window.URL.createObjectURL(l),o=document.createElement("a");o.href=c,o.download=e.file_name||`ì˜ìˆ˜ì¦_${e.id}.jpg`,document.body.appendChild(o),o.click(),document.body.removeChild(o),window.URL.revokeObjectURL(c),i.success("ì˜ìˆ˜ì¦ ì´ë¯¸ì§€ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.")}catch(a){i.error("ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}else i.error("ì˜ìˆ˜ì¦ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.")},G=e.useCallback(async e=>{if(I.canDelete){if(confirm(`ì •ë§ë¡œ "${e.file_name}" ì˜ìˆ˜ì¦ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`))try{const a=function(e,a="receipt-images"){try{const s=new URL(e).pathname.split("/"),t=s.indexOf(a);return-1===t?null:s.slice(t+1).join("/")}catch{return null}}(e.receipt_image_url);if(a){r.debug("Storage íŒŒì¼ ì‚­ì œ ì‹œì‘",{filePath:a});const{error:e}=await $.storage.from("receipt-images").remove([a]);e&&r.warn("Storage íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨",e,{filePath:a})}const{error:s}=await $.from("purchase_receipts").delete().eq("id",e.id);if(s)throw s;i.success("ì˜ìˆ˜ì¦ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."),H()}catch(a){i.error("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}}else i.error("ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")},[I.canDelete,H]);return a.jsxs("div",{className:"w-full",children:[a.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"page-title",children:"ì˜ìˆ˜ì¦ ê´€ë¦¬"}),a.jsx("p",{className:"page-subtitle",style:{marginTop:"-2px",marginBottom:"-4px"},children:"Receipt Management"})]}),a.jsxs("div",{className:"flex items-center gap-2 mt-4 sm:mt-0",children:[a.jsxs(c,{onClick:()=>{P(!0)},className:"bg-hansl-600 hover:bg-hansl-700 text-white",children:[a.jsx(j,{className:"w-4 h-4 mr-2"}),"ì˜ìˆ˜ì¦ ì—…ë¡œë“œ"]}),a.jsxs(p,{variant:"secondary",className:"modal-subtitle",children:["ì´ ",B.length,"ê±´"]})]})]}),a.jsxs(m,{className:"mb-4 border border-gray-200",children:[a.jsx(f,{className:"bg-white border-b border-gray-200 py-3",children:a.jsxs(N,{className:"flex items-center modal-section-title",children:[a.jsx(L,{className:"w-4 h-4 mr-2"}),"ê²€ìƒ‰ í•„í„°"]})}),a.jsx(h,{className:"py-3",children:a.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block modal-label mb-1",children:"ê²€ìƒ‰"}),a.jsxs("div",{className:"relative",children:[a.jsx(v,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 w-3 h-3 text-gray-400"}),a.jsx(_,{placeholder:"íŒŒì¼ëª…, ë©”ëª¨, ì—…ë¡œë“œì¼...",value:x,onChange:e=>g(e.target.value),className:"pl-7 modal-subtitle h-9"})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block modal-label mb-1",children:"ì—…ë¡œë“œ ë‚ ì§œ"}),a.jsx(_,{type:"date",value:u,onChange:e=>w(e.target.value),className:"modal-subtitle h-9"})]}),a.jsx("div",{className:"flex items-end",children:a.jsx(c,{variant:"outline",onClick:()=>{g(""),w("")},className:"h-9 modal-subtitle",children:"ì´ˆê¸°í™”"})})]})})]}),a.jsx(m,{className:"overflow-hidden border border-gray-200",children:a.jsx(h,{className:"p-0",children:l||R?a.jsxs("div",{className:"flex items-center justify-center py-12",children:[a.jsx("div",{className:"w-8 h-8 border-2 border-hansl-500 border-t-transparent rounded-full animate-spin"}),a.jsx("span",{className:"ml-3 card-subtitle",children:"ë¡œë”© ì¤‘..."})]}):I.canView?0===B.length?a.jsxs("div",{className:"text-center py-12",children:[a.jsx(k,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),a.jsx("h3",{className:"modal-section-title mb-2",children:"ì˜ìˆ˜ì¦ì´ ì—†ìŠµë‹ˆë‹¤"}),a.jsx("p",{className:"card-subtitle",children:"ì—…ë¡œë“œëœ ì˜ìˆ˜ì¦ì´ ì—†ê±°ë‚˜ ê²€ìƒ‰ ì¡°ê±´ì— ë§ëŠ” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤."})]}):a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"hidden md:block overflow-x-auto",children:a.jsxs("table",{className:"w-full min-w-fit",children:[a.jsx("thead",{className:"bg-gray-50",children:a.jsxs("tr",{children:[a.jsx("th",{className:"px-4 py-3 text-center header-title text-gray-600 uppercase tracking-wider",children:"ì¸ì‡„ì™„ë£Œ"}),a.jsx("th",{className:"px-4 py-3 text-center header-title text-gray-600 uppercase tracking-wider",children:"ì—…ë¡œë“œì¼"}),a.jsx("th",{className:"px-4 py-3 text-left header-title text-gray-600 uppercase tracking-wider",children:"íŒŒì¼ëª…"}),a.jsx("th",{className:"px-4 py-3 text-left header-title text-gray-600 uppercase tracking-wider",children:"ë©”ëª¨"}),I.canViewUploaderInfo&&a.jsx("th",{className:"px-4 py-3 text-left header-title text-gray-600 uppercase tracking-wider",children:"ë“±ë¡ì¸"}),a.jsx("th",{className:"px-4 py-3 text-center header-title text-gray-600 uppercase tracking-wider",children:"í¬ê¸°"}),a.jsx("th",{className:"px-4 py-3 text-center header-title text-gray-600 uppercase tracking-wider",children:"ì•¡ì…˜"}),I.canDelete&&a.jsx("th",{className:"px-4 py-3 text-center header-title text-gray-600 uppercase tracking-wider",children:"ì‚­ì œ"})]})}),a.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:B.map(e=>a.jsxs("tr",{className:"hover:bg-gray-50 transition-colors cursor-pointer",onClick:()=>A(e),children:[a.jsx("td",{className:"px-4 py-3 modal-subtitle text-center",children:e.is_printed?a.jsx(p,{className:"bg-green-100 text-green-700 hover:bg-green-100",children:"âœ“ ì™„ë£Œ"}):a.jsx(p,{variant:"secondary",className:"bg-gray-100 text-gray-600",children:"ë¯¸ì™„ë£Œ"})}),a.jsx("td",{className:"px-4 py-3 modal-subtitle text-center text-gray-600",children:S(e.uploaded_at)}),a.jsx("td",{className:"px-4 py-3 modal-value text-gray-900",children:e.file_name}),a.jsx("td",{className:"px-4 py-3 modal-subtitle text-gray-900",children:e.memo||"-"}),I.canViewUploaderInfo&&a.jsx("td",{className:"px-4 py-3 modal-subtitle text-gray-600",children:e.uploaded_by_name||e.uploaded_by}),a.jsx("td",{className:"px-4 py-3 modal-subtitle text-center text-gray-600",children:D(e.file_size)}),a.jsx("td",{className:"px-4 py-3 modal-subtitle text-center",children:a.jsxs("div",{className:"flex items-center justify-center gap-1",children:[a.jsx(c,{size:"sm",variant:"ghost",onClick:a=>{a.stopPropagation(),W(e)},className:"h-8 w-8 p-0",title:"ì¸ì‡„",children:a.jsx(M,{className:"w-4 h-4"})}),a.jsx(c,{size:"sm",variant:"ghost",onClick:a=>{a.stopPropagation(),Y(e)},className:"h-8 w-8 p-0",title:"ë‹¤ìš´ë¡œë“œ",children:a.jsx(d,{className:"w-4 h-4"})})]})}),I.canDelete&&a.jsx("td",{className:"px-4 py-3 modal-subtitle text-center",children:a.jsx(c,{size:"sm",variant:"ghost",onClick:a=>{a.stopPropagation(),G(e)},className:"h-8 w-8 p-0 text-red-600 hover:bg-red-50",title:"ì‚­ì œ",children:a.jsx(C,{className:"w-4 h-4"})})})]},e.id))})]})}),a.jsx("div",{className:"md:hidden space-y-3 p-4",children:B.map(e=>a.jsx(E,{receipt:e,onView:A,onPrint:W,onDownload:Y,onDelete:I.canDelete?G:void 0},e.id))})]}):a.jsxs("div",{className:"text-center py-12",children:[a.jsx("div",{className:"w-12 h-12 text-red-400 mx-auto mb-4",children:"ğŸ”’"}),a.jsx("h3",{className:"modal-section-title mb-2",children:"ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ"}),a.jsx("p",{className:"card-subtitle",children:"ì˜ìˆ˜ì¦ ê´€ë¦¬ì— ì ‘ê·¼í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."})]})})}),y&&a.jsx(V,{receipt:y,isOpen:z,onClose:()=>{U(!1),b(null)},onDelete:()=>{H()}}),a.jsx(q,{isOpen:O,onClose:()=>P(!1),onSuccess:()=>{H()}})]})}export{H as default};
//# sourceMappingURL=ReceiptsMain-CadMu-Oe.js.map
