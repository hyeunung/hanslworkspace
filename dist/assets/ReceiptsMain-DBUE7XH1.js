import{e,r as a,c as t,l as s,j as r,B as n,X as i,J as l,U as o,K as c}from"./index-DsAL4iro.js";import{T as d,C as m,c as h,a as p,b as g}from"./card-C_LMoGjm.js";import{D as u,a as x,b as f,c as b,k as w,P as j,I as y}from"./dialog-B22Nto94.js";import{t as v}from"./index-Dz8943Z0.js";import{C as N}from"./chevron-left-DiNSaEMF.js";import{C as _}from"./chevron-right-3Zn4N5p9.js";import{Z as k,a as C,U as S}from"./zoom-out-S--gI9zw.js";import{R as D}from"./rotate-ccw-DdxgAANC.js";import{D as U}from"./download-ayaITdR2.js";import{b as $,c as L}from"./helpers-CmqE03mo.js";import{C as z}from"./calendar-TX1shQE9.js";import{T as E}from"./textarea-CLkwskUf.js";import{L as R}from"./label-CAHWWo0C.js";import{S as O}from"./search-8TWKvsJc.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const I=e("funnel",[["path",{d:"M10 20a1 1 0 0 0 .553.895l2 1A1 1 0 0 0 14 21v-7a2 2 0 0 1 .517-1.341L21.74 4.67A1 1 0 0 0 21 3H3a1 1 0 0 0-.742 1.67l7.225 7.989A2 2 0 0 1 10 14z",key:"sc7q7i"}]]),P=e("images",[["path",{d:"m22 11-1.296-1.296a2.4 2.4 0 0 0-3.408 0L11 16",key:"9kzy35"}],["path",{d:"M4 8a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2",key:"1t0f0t"}],["circle",{cx:"13",cy:"7",r:"1",fill:"currentColor",key:"1obus6"}],["rect",{x:"8",y:"2",width:"14",height:"14",rx:"2",key:"1gvhby"}]]),T=e("printer",[["path",{d:"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2",key:"143wyd"}],["path",{d:"M6 9V3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6",key:"1itne7"}],["rect",{x:"6",y:"14",width:"12",height:"8",rx:"1",key:"1ue0tg"}]]);function M(){const[e,s]=a.useState({canView:!1,canUpload:!1,canDownload:!1,canPrint:!1,canDelete:!1,canViewUploaderInfo:!1}),[r,n]=a.useState(null),[i,l]=a.useState(!0),o=t(),c=async()=>{try{const{data:{user:e}}=await o.auth.getUser();if(!e)return void l(!1);const{data:a}=await o.from("employees").select("purchase_role").eq("email",e.email).single(),t=a?.purchase_role||"";n(t);const r=t.includes("app_admin"),i=t.includes("hr"),c=t.includes("lead buyer"),d=r||i||c;s({canView:d,canUpload:d,canDownload:d,canPrint:d,canDelete:r,canViewUploaderInfo:r})}catch(e){n(null),s({canView:!1,canUpload:!1,canDownload:!1,canPrint:!1,canDelete:!1,canViewUploaderInfo:!1})}finally{l(!1)}};return a.useEffect(()=>{c()},[]),{permissions:e,userRole:r,loading:i,refreshPermissions:c}}function V({receipt:e,groupReceipts:l,isOpen:o,onClose:c,onDelete:m}){const h=l&&l.length>0?l:[e],[p,g]=a.useState(0),[w,j]=a.useState(1),[y,S]=a.useState(0),[$,L]=a.useState(!1),[z,E]=a.useState(!1),[R,O]=a.useState({width:0,height:0}),[I,P]=a.useState(!1),V=t(),{permissions:q}=M(),A=h[p]||e,B=h.length>1;a.useEffect(()=>{o&&(g(0),j(1),S(0),L(!1),P(!1))},[o]),a.useEffect(()=>{j(1),S(0),L(!1),P(!1)},[p]);const H=a.useCallback(()=>{p<h.length-1&&g(e=>e+1)},[p,h.length]),F=a.useCallback(()=>{p>0&&g(e=>e-1)},[p]);a.useEffect(()=>{if(!o||!B)return;const e=e=>{"ArrowLeft"===e.key&&F(),"ArrowRight"===e.key&&H()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[o,B,F,H]);const W=a.useCallback(async()=>{try{const{data:{user:e},error:a}=await V.auth.getUser();if(a||!e)return void v.error("ì‚¬ìš©ì ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");const{data:t,error:r}=await V.from("employees").select("name, purchase_role").eq("email",e.email).single();if(r)return void v.error("ì§ì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");const n=t?.purchase_role||"";if(!(n.includes("app_admin")||n.includes("hr")||n.includes("lead buyer")))return void v.error("ì¸ì‡„ì™„ë£Œ ì²˜ë¦¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");const i={is_printed:!0,printed_at:(new Date).toISOString(),printed_by:e.id,printed_by_name:t?.name||e.email},l=h.map(e=>e.id),{error:o}=await V.from("purchase_receipts").update(i).in("id",l);if(o)return s.error("ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",o),void v.error(`ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${o.message}`);v.success("ì¸ì‡„ ì™„ë£Œë¡œ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤."),m&&m()}catch(e){const a=e;s.error("ì¸ì‡„ì™„ë£Œ ì²˜ë¦¬ ì˜ˆì™¸",a),v.error(`ì¸ì‡„ ì™„ë£Œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${a?.message||"ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"}`)}},[V,h,c,m]),Y=a.useCallback(()=>{const e=h.filter(e=>e.receipt_image_url).map(e=>e.receipt_image_url);if(0===e.length)return;const a=window.open("","_blank");if(!a)return void v.error("íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.");const t=e.map((a,t)=>`<div class="page${t===e.length-1?"":" page-break"}"><img src="${a}" alt="" class="receipt-image" onload="onImgLoad()" onerror="onImgError()" /></div>`).join("\n");a.document.write(`\n      <!DOCTYPE html>\n      <html><head><title></title>\n      <style>\n        *{margin:0;padding:0;box-sizing:border-box;}\n        body{background:white;}\n        .page{display:flex;justify-content:center;align-items:center;min-height:100vh;}\n        .page-break{page-break-after:always;}\n        .receipt-image{max-width:100%;max-height:100vh;object-fit:contain;}\n        @media print{\n          @page{margin:0;size:auto;}\n          body{margin:0;padding:0;}\n          .page{min-height:auto;}\n          .page-break{page-break-after:always;}\n          .receipt-image{max-width:100%;max-height:100%;width:auto;height:auto;}\n        }\n      </style>\n      <script>\n        var loaded=0,total=${e.length};\n        function onImgLoad(){loaded++;if(loaded>=total)setTimeout(function(){window.print();window.close();},200);}\n        function onImgError(){loaded++;if(loaded>=total){alert('ì¼ë¶€ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');window.close();}}\n      <\/script>\n      </head><body>${t}</body></html>\n    `),a.document.close(),setTimeout(()=>{confirm("ì¸ì‡„ë¥¼ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆê¹Œ?")&&(c(),W())},1e3)},[h,W,c]),G=a.useCallback(async()=>{if(!q.canDelete)return void v.error("ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");const e=h.length>1?`${h.length}ì¥ì˜ ì˜ìˆ˜ì¦ì„`:"ì´ ì˜ìˆ˜ì¦ì„";if(confirm(`ì •ë§ë¡œ ${e} ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`))try{E(!0);for(const e of h){const a=new URL(e.receipt_image_url).pathname.split("/"),t=a.indexOf("receipt-images");if(-1!==t){const e=a.slice(t+1).join("/"),{error:r}=await V.storage.from("receipt-images").remove([e]);r&&s.warn("ìŠ¤í† ë¦¬ì§€ íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨",{error:r})}const{error:r}=await V.from("purchase_receipts").delete().eq("id",e.id);if(r)throw r}v.success("ì˜ìˆ˜ì¦ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."),c(),m&&m()}catch(a){s.error("ì‚­ì œ ì˜¤ë¥˜",a),v.error("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}finally{E(!1)}},[q.canDelete,h,c,m,V]);return r.jsx(u,{open:o,onOpenChange:c,children:r.jsxs(x,{className:"w-[100vw] max-w-none h-[100vh] p-0 overflow-hidden m-0 border-0 rounded-none",children:[r.jsx(f,{className:"sr-only",children:r.jsx(b,{children:"ì˜ìˆ˜ì¦ ìƒì„¸ ë³´ê¸°"})}),r.jsxs("div",{className:"flex h-full",children:[r.jsxs("div",{className:"flex-1 bg-white relative overflow-hidden",children:[r.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:r.jsx("img",{src:A.receipt_image_url,alt:"ì˜ìˆ˜ì¦",className:"object-contain",style:{...(()=>{if(!I)return{width:"100%",height:"100vh"};const e=window.innerWidth-64,a=window.innerHeight,t=e/R.width,s=a/R.height,r=Math.min(t,s);return{width:R.width*r+"px",height:R.height*r+"px"}})(),transform:`scale(${w}) rotate(${y}deg)`,transformOrigin:"center"},onLoad:e=>{const a=e.currentTarget;O({width:a.naturalWidth,height:a.naturalHeight}),P(!0)},onError:()=>L(!0)})}),r.jsx(n,{variant:"ghost",size:"sm",onClick:c,className:"absolute top-4 left-4 h-10 w-10 p-0 bg-gray-900/80 hover:bg-gray-900 text-white rounded-full",children:r.jsx(i,{className:"h-5 w-5"})}),B&&r.jsx("div",{className:"absolute top-4 left-1/2 transform -translate-x-1/2 bg-gray-900/80 text-white rounded-full px-3 py-1.5",children:r.jsxs("span",{className:"text-[11px] font-medium",children:[p+1," / ",h.length]})}),B&&p>0&&r.jsx(n,{variant:"ghost",size:"sm",onClick:F,className:"absolute left-4 top-1/2 -translate-y-1/2 h-12 w-12 p-0 bg-gray-900/60 hover:bg-gray-900/80 text-white rounded-full",children:r.jsx(N,{className:"h-6 w-6"})}),B&&p<h.length-1&&r.jsx(n,{variant:"ghost",size:"sm",onClick:H,className:"absolute right-20 top-1/2 -translate-y-1/2 h-12 w-12 p-0 bg-gray-900/60 hover:bg-gray-900/80 text-white rounded-full",children:r.jsx(_,{className:"h-6 w-6"})}),r.jsx("div",{className:"absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-900/80 rounded-full px-4 py-2",children:r.jsxs("div",{className:"flex items-center gap-2 text-white",children:[r.jsx(n,{variant:"ghost",size:"sm",onClick:()=>j(e=>Math.max(e-.25,.5)),disabled:w<=.5,className:"h-7 w-7 p-0 text-white hover:bg-white/20",children:r.jsx(k,{className:"w-4 h-4"})}),r.jsxs("span",{className:"modal-subtitle min-w-[40px] text-center",children:[Math.round(100*w),"%"]}),r.jsx(n,{variant:"ghost",size:"sm",onClick:()=>j(e=>Math.min(e+.25,3)),disabled:w>=3,className:"h-7 w-7 p-0 text-white hover:bg-white/20",children:r.jsx(C,{className:"w-4 h-4"})}),r.jsx("div",{className:"w-px h-4 bg-white/30 mx-1"}),r.jsx(n,{variant:"ghost",size:"sm",onClick:()=>S(e=>(e+90)%360),className:"h-7 w-7 p-0 text-white hover:bg-white/20",children:r.jsx(D,{className:"w-4 h-4"})})]})}),B&&r.jsx("div",{className:"absolute bottom-16 left-1/2 transform -translate-x-1/2 bg-gray-900/80 rounded-lg px-2 py-1.5 flex items-center gap-1.5",children:h.map((e,a)=>r.jsx("button",{onClick:()=>g(a),className:"w-10 h-10 rounded overflow-hidden border-2 transition-all "+(a===p?"border-white scale-110":"border-transparent opacity-60 hover:opacity-100"),children:r.jsx("img",{src:e.receipt_image_url,alt:"",className:"w-full h-full object-cover"})},e.id))})]}),r.jsxs("div",{className:"w-16 bg-gray-900 flex flex-col items-center justify-center space-y-4",children:[r.jsxs(n,{variant:"ghost",size:"sm",onClick:Y,className:"w-10 h-10 p-0 text-white hover:bg-gray-700 rounded-lg relative",title:B?`${h.length}ì¥ ì¸ì‡„`:"ì¸ì‡„",children:[r.jsx(T,{className:"w-6 h-6"}),B&&r.jsx("span",{className:"absolute -top-1 -right-1 bg-blue-500 text-white text-[8px] w-4 h-4 rounded-full flex items-center justify-center font-bold",children:h.length})]}),r.jsx(n,{variant:"ghost",size:"sm",onClick:async()=>{try{const e=new URL(A.receipt_image_url).pathname.split("/"),a=e.indexOf("receipt-images");if(-1===a)throw new Error("ì˜ëª»ëœ ì˜ìˆ˜ì¦ URLì…ë‹ˆë‹¤");const t=e.slice(a+1).join("/"),{data:s,error:r}=await V.storage.from("receipt-images").download(t);if(r)throw r;const n=new Blob([s],{type:"image/jpeg"}),i=window.URL.createObjectURL(n),l=document.createElement("a");l.href=i,l.download=A.file_name||`ì˜ìˆ˜ì¦_${A.id}.jpg`,document.body.appendChild(l),l.click(),document.body.removeChild(l),window.URL.revokeObjectURL(i),v.success("ì˜ìˆ˜ì¦ ì´ë¯¸ì§€ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.")}catch(e){s.error("ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜",e),v.error("ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}},className:"w-10 h-10 p-0 text-white hover:bg-gray-700 rounded-lg",title:"ë‹¤ìš´ë¡œë“œ",children:r.jsx(U,{className:"w-6 h-6"})}),q.canDelete&&r.jsx(n,{variant:"ghost",size:"sm",onClick:G,disabled:z,className:"w-10 h-10 p-0 text-white hover:bg-red-600 rounded-lg",title:"ì‚­ì œ",children:z?r.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):r.jsx(d,{className:"w-6 h-6"})})]})]})]})})}function q({receipt:e,groupCount:a=1,onView:t,onPrint:s,onDownload:i,onDelete:c}){return r.jsx(m,{className:"w-full border border-gray-200 hover:shadow-md transition-shadow cursor-pointer",onClick:()=>t(e),children:r.jsx(h,{className:"p-4",children:r.jsxs("div",{className:"space-y-3",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{className:"flex items-center gap-1.5",children:[e.is_printed?r.jsx("span",{className:"badge-stats bg-green-100 text-green-700 badge-text",children:"âœ“ ì¸ì‡„ì™„ë£Œ"}):r.jsx("span",{className:"badge-stats bg-gray-100 text-gray-600 badge-text",children:"ë¯¸ì™„ë£Œ"}),a>1&&r.jsxs("span",{className:"inline-flex items-center gap-0.5 badge-stats bg-blue-100 text-blue-700 badge-text",children:[r.jsx(P,{className:"w-3 h-3"}),a,"ì¥"]})]}),r.jsxs("div",{className:"flex items-center gap-1 badge-text text-gray-500",children:[r.jsx(z,{className:"w-3 h-3"}),r.jsx("span",{children:$(e.uploaded_at)})]})]}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(l,{className:"w-4 h-4 text-hansl-600"}),r.jsx("span",{className:"card-title text-gray-900",children:e.file_name})]}),e.memo&&r.jsx("div",{className:"card-subtitle text-gray-900 bg-gray-50 rounded p-2",children:e.memo}),r.jsxs("div",{className:"flex items-center justify-between card-subtitle",children:[r.jsxs("div",{className:"flex items-center gap-1 text-gray-600",children:[r.jsx(o,{className:"w-3 h-3"}),r.jsx("span",{children:e.uploaded_by_name||e.uploaded_by})]}),r.jsx("span",{className:"text-gray-500",children:L(e.file_size)})]}),r.jsxs("div",{className:"flex gap-2 pt-2 border-t border-gray-100 "+(c?"grid grid-cols-3":"grid grid-cols-2"),children:[r.jsxs(n,{size:"sm",variant:"outline",onClick:a=>{a.stopPropagation(),s(e)},className:"flex-1",children:[r.jsx(T,{className:"w-4 h-4 mr-1"}),"ì¸ì‡„",a>1?` (${a})`:""]}),r.jsxs(n,{size:"sm",variant:"outline",onClick:a=>{a.stopPropagation(),i(e)},className:"flex-1",children:[r.jsx(U,{className:"w-4 h-4 mr-1"}),"ë‹¤ìš´ë¡œë“œ"]}),c&&r.jsxs(n,{size:"sm",variant:"outline",onClick:a=>{a.stopPropagation(),c(e)},className:"flex-1 border-red-200 text-red-600 hover:bg-red-50",children:[r.jsx(d,{className:"w-4 h-4 mr-1"}),"ì‚­ì œ"]})]})]})})})}function A({isOpen:e,onClose:s,onSuccess:l}){const[o,c]=a.useState([]),[d,m]=a.useState(""),[h,p]=a.useState(!1),[g,y]=a.useState(!1),N=t(),{permissions:_}=M(),k=a.useCallback(e=>{if(!e.type.startsWith("image/"))return void v.error("ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");if(e.size>10485760)return void v.error("íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.");const a={file:e,preview:URL.createObjectURL(e),id:crypto.randomUUID()};c(e=>[...e,a])},[]),C=a.useCallback(e=>{Array.from(e).forEach(e=>k(e))},[k]),D=a.useCallback(e=>{c(a=>{const t=a.find(a=>a.id===e);return t&&URL.revokeObjectURL(t.preview),a.filter(a=>a.id!==e)})},[]),U=a.useCallback(async()=>{if(_.canUpload)if(0!==o.length)try{p(!0);const{data:{user:e},error:a}=await N.auth.getUser();if(a||!e)throw new Error("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");const{data:t}=await N.from("employees").select("name").eq("email",e.email).single(),s=t?.name||"",r=o.length>1?crypto.randomUUID():null;for(const i of o){const a=new Date,t=i.file.name.split(".").pop()||"jpg",n=`rec${a.getFullYear().toString().substring(2)}${(a.getMonth()+1).toString().padStart(2,"0")}${a.getDate().toString().padStart(2,"0")}${a.getHours().toString().padStart(2,"0")}${a.getMinutes().toString().padStart(2,"0")}${a.getSeconds().toString().padStart(2,"0")}.${t}`,l=`receipts/web/${a.getTime()}_${i.id.slice(0,8)}/${n}`,{error:o}=await N.storage.from("receipt-images").upload(l,i.file,{contentType:i.file.type,upsert:!1});if(o)throw o;const{data:{publicUrl:c}}=N.storage.from("receipt-images").getPublicUrl(l),{error:m}=await N.from("purchase_receipts").insert({receipt_image_url:c,file_name:n,file_size:i.file.size,uploaded_by:e.email,uploaded_by_name:s,memo:d||null,uploaded_at:(new Date).toISOString(),group_id:r});if(m)throw m}const n=o.length>1?`${o.length}ì¥ì´`:"ì˜ìˆ˜ì¦ì´";v.success(`${n} ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`),$(),l()}catch(e){v.error(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${e instanceof Error?e.message:e}`)}finally{p(!1)}else v.error("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");else v.error("ì—…ë¡œë“œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")},[o,d,_.canUpload,l]),$=a.useCallback(()=>{o.forEach(e=>URL.revokeObjectURL(e.preview)),c([]),m(""),p(!1),y(!1),s()},[s,o]);return r.jsx(u,{open:e,onOpenChange:$,children:r.jsxs(x,{children:[r.jsxs(f,{children:[r.jsx(b,{className:"modal-title",children:"ğŸ“ ì˜ìˆ˜ì¦ ì—…ë¡œë“œ"}),r.jsx(w,{className:"modal-subtitle",children:"ì˜ìˆ˜ì¦ ì´ë¯¸ì§€ë¥¼ ì—¬ëŸ¬ ì¥ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê°™ì€ í•­ëª©ì´ë©´ í•¨ê»˜ ë¬¶ì–´ì„œ ê´€ë¦¬ë©ë‹ˆë‹¤."})]}),r.jsxs("div",{className:"px-8 py-4 space-y-4",children:[r.jsxs("div",{className:"space-y-2",children:[r.jsxs(R,{className:"modal-label",children:["íŒŒì¼ ì„ íƒ ",r.jsx("span",{className:"text-gray-400 badge-text",children:"(ì—¬ëŸ¬ ì¥ ê°€ëŠ¥)"})]}),r.jsxs("div",{className:"relative border-2 border-dashed business-radius-card p-6 text-center transition-all duration-200 cursor-pointer "+(g?"border-hansl-400 bg-hansl-50":o.length>0?"border-green-400 bg-green-50":"border-gray-300 hover:border-hansl-300 hover:bg-gray-50"),onDragOver:e=>{e.preventDefault(),y(!0)},onDragLeave:e=>{e.preventDefault(),y(!1)},onDrop:e=>{e.preventDefault(),y(!1);const a=Array.from(e.dataTransfer.files);a.length>0&&C(a)},children:[o.length>0?r.jsxs("div",{className:"space-y-3",children:[r.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[o.map(e=>r.jsxs("div",{className:"relative group",children:[r.jsx("img",{src:e.preview,alt:e.file.name,className:"w-full h-24 object-cover business-radius-card border border-gray-200"}),r.jsx("button",{onClick:a=>{a.stopPropagation(),D(e.id)},className:"absolute -top-1.5 -right-1.5 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity",children:r.jsx(i,{className:"w-3 h-3"})}),r.jsx("p",{className:"mt-1 text-[9px] text-gray-500 truncate",children:e.file.name})]},e.id)),r.jsxs("label",{className:"flex flex-col items-center justify-center h-24 border-2 border-dashed border-gray-300 business-radius-card cursor-pointer hover:border-hansl-400 hover:bg-hansl-50 transition-colors",children:[r.jsx(j,{className:"w-5 h-5 text-gray-400"}),r.jsx("span",{className:"text-[9px] text-gray-400 mt-1",children:"ì¶”ê°€"}),r.jsx("input",{type:"file",accept:"image/*",multiple:!0,onChange:e=>{e.target.files&&C(e.target.files),e.target.value=""},className:"hidden"})]})]}),r.jsxs("p",{className:"text-[10px] text-green-600 font-medium",children:[o.length,"ì¥ ì„ íƒë¨ ",o.length>1&&"(í•˜ë‚˜ì˜ ê·¸ë£¹ìœ¼ë¡œ ë¬¶ì…ë‹ˆë‹¤)"]})]}):r.jsxs("div",{className:"space-y-3",children:[r.jsx("div",{className:"w-14 h-14 bg-gray-100 rounded-full flex items-center justify-center mx-auto",children:r.jsx(S,{className:"w-7 h-7 text-gray-400"})}),r.jsxs("div",{className:"space-y-1",children:[r.jsx("p",{className:"modal-value",children:"ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ë†“ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”"}),r.jsx("p",{className:"badge-text text-gray-500",children:"JPG, PNG, HEIC, WebP â€¢ ìµœëŒ€ 10MB â€¢ ì—¬ëŸ¬ ì¥ ì„ íƒ ê°€ëŠ¥"})]})]}),0===o.length&&r.jsx("input",{type:"file",accept:"image/*",multiple:!0,onChange:e=>{e.target.files&&C(e.target.files),e.target.value=""},className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer"})]})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs(R,{htmlFor:"memo",className:"modal-label",children:["ë©”ëª¨ ",r.jsx("span",{className:"text-gray-400 badge-text",children:"(ì„ íƒì‚¬í•­)"})]}),r.jsx(E,{id:"memo",placeholder:"ì˜ìˆ˜ì¦ì— ëŒ€í•œ ê°„ë‹¨í•œ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”",value:d,onChange:e=>m(e.target.value),className:"resize-none border-gray-200 focus:border-hansl-400 focus:ring-hansl-400 business-radius-input",rows:3})]})]}),r.jsxs("div",{className:"flex justify-end gap-2 px-8 py-4 border-t border-gray-100",children:[r.jsx(n,{variant:"outline",onClick:$,className:"button-base w-20 border-gray-200 hover:bg-gray-50",disabled:h,children:"ì·¨ì†Œ"}),r.jsx(n,{onClick:U,disabled:0===o.length||h,className:"button-base w-20 bg-hansl-600 hover:bg-hansl-700 text-white",children:h?r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"ì—…ë¡œë“œ ì¤‘..."]}):r.jsxs(r.Fragment,{children:[r.jsx(S,{className:"w-4 h-4 mr-2"}),"ì—…ë¡œë“œ ",o.length>1&&`(${o.length}ì¥)`]})})]})]})})}function B(e,a="receipt-images"){try{const t=new URL(e).pathname.split("/"),s=t.indexOf(a);return-1===s?null:t.slice(s+1).join("/")}catch{return null}}function H(){const[e,i]=a.useState([]),[l,o]=a.useState(!0),[u,x]=a.useState(""),[f,b]=a.useState(""),[w,N]=a.useState(null),[_,k]=a.useState([]),[C,S]=a.useState(!1),[D,z]=a.useState(!1),E=t(),{permissions:R,loading:H}=M();a.useEffect(()=>{H||R.canView||v.error("ì˜ìˆ˜ì¦ ê´€ë¦¬ì— ì ‘ê·¼í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")},[R.canView,H]);const F=a.useCallback(async()=>{if(R.canView)try{o(!0);const{data:e,error:a}=await E.from("purchase_receipts").select("\n          id,\n          receipt_image_url,\n          file_name,\n          file_size,\n          uploaded_by,\n          uploaded_by_name,\n          uploaded_at,\n          memo,\n          is_printed,\n          printed_at,\n          printed_by,\n          printed_by_name,\n          group_id\n        ").order("uploaded_at",{ascending:!1});if(a)throw a;i(e||[])}catch(e){v.error("ì˜ìˆ˜ì¦ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}finally{o(!1)}},[R.canView,E]),W=a.useMemo(()=>{let a=[...e];if(u){const e=u.toLowerCase();a=a.filter(a=>a.file_name.toLowerCase().includes(e)||a.memo?.toLowerCase().includes(e)||$(a.uploaded_at).includes(u)||a.uploaded_at.includes(u))}return f&&(a=a.filter(e=>{if(!e.uploaded_at)return!1;return new Date(e.uploaded_at).toISOString().split("T")[0]===f})),a},[e,u,f]),Y=a.useMemo(()=>function(e){const a=new Map,t=[];for(const r of e)if(r.group_id){const e=a.get(r.group_id)||[];e.push(r),a.set(r.group_id,e)}else t.push(r);const s=[];for(const[r,n]of a)n.sort((e,a)=>new Date(e.uploaded_at).getTime()-new Date(a.uploaded_at).getTime()),s.push({group_id:r,receipts:n,primary:n[0],count:n.length});for(const r of t)s.push({group_id:null,receipts:[r],primary:r,count:1});return s.sort((e,a)=>new Date(a.primary.uploaded_at).getTime()-new Date(e.primary.uploaded_at).getTime()),s}(W),[W]);a.useEffect(()=>{H||F()},[F,H]);const G=e=>{N(e.primary),k(e.receipts),S(!0)},J=a.useCallback(async e=>{try{const{data:{user:a},error:t}=await E.auth.getUser();if(t||!a)return void v.error("ì‚¬ìš©ì ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");const{data:r,error:n}=await E.from("employees").select("name, purchase_role").eq("email",a.email).single();if(n)return void v.error("ì§ì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");const i=r?.purchase_role||"";if(!(i.includes("app_admin")||i.includes("hr")||i.includes("lead buyer")))return void v.error("ì¸ì‡„ì™„ë£Œ ì²˜ë¦¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");const l={is_printed:!0,printed_at:(new Date).toISOString(),printed_by:a.id,printed_by_name:r?.name||a.email},{error:o}=await E.from("purchase_receipts").update(l).in("id",e);if(o)return s.error("ì˜ìˆ˜ì¦ ì¸ì‡„ì™„ë£Œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",o),void v.error(`ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${o.message}`);v.success("ì¸ì‡„ ì™„ë£Œë¡œ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤."),F()}catch(a){const e=a;s.error("ì˜ìˆ˜ì¦ ì¸ì‡„ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸ ë°œìƒ",a),v.error(`ì¸ì‡„ ì™„ë£Œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${e?.message||"ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"}`)}},[E,F]),K=e=>{const a=e.receipts.filter(e=>e.receipt_image_url).map(e=>e.receipt_image_url);if(0===a.length)return void v.error("ì˜ìˆ˜ì¦ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");const t=e.receipts.map(e=>e.id);!function(e,a){const t=window.open("","_blank");if(!t)return void v.error("íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");const s=e.map((a,t)=>`<div class="page${t===e.length-1?"":" page-break"}"><img src="${a}" alt="ì˜ìˆ˜ì¦ ${t+1}" class="receipt-image" /></div>`).join("\n");t.document.write(`\n    <!DOCTYPE html>\n    <html>\n    <head>\n      <title>ì˜ìˆ˜ì¦ ì¸ì‡„</title>\n      <style>\n        * { margin: 0; padding: 0; box-sizing: border-box; }\n        body { background: white; }\n        .page {\n          display: flex;\n          justify-content: center;\n          align-items: center;\n          min-height: 100vh;\n        }\n        .page-break { page-break-after: always; }\n        .receipt-image {\n          max-width: 100%;\n          max-height: 100vh;\n          object-fit: contain;\n        }\n        @media print {\n          @page { margin: 0; size: auto; }\n          body { margin: 0; padding: 0; }\n          .page { min-height: auto; }\n          .page-break { page-break-after: always; }\n          .receipt-image {\n            max-width: 100%;\n            max-height: 100%;\n            width: auto;\n            height: auto;\n          }\n        }\n      </style>\n      <script>\n        var loaded = 0;\n        var total = ${e.length};\n        function onImgLoad() {\n          loaded++;\n          if (loaded >= total) {\n            setTimeout(function(){ window.print(); window.close(); }, 200);\n          }\n        }\n        function onImgError() {\n          loaded++;\n          if (loaded >= total) {\n            alert('ì¼ë¶€ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');\n            window.close();\n          }\n        }\n      <\/script>\n    </head>\n    <body>\n      ${s.replace(/onload="[^"]*"/g,"").replace(/<img /g,'<img onload="onImgLoad()" onerror="onImgError()" ')}\n    </body>\n    </html>\n  `),t.document.close(),a&&setTimeout(()=>{confirm("ì¸ì‡„ë¥¼ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆê¹Œ?")&&a()},1e3)}(a,()=>J(t))},Z=async e=>{if(e.receipt_image_url)try{const a=new URL(e.receipt_image_url).pathname.split("/"),t=a.indexOf("receipt-images");if(-1===t)throw new Error("ì˜ëª»ëœ ì˜ìˆ˜ì¦ URLì…ë‹ˆë‹¤");const s=a.slice(t+1).join("/"),{data:r,error:n}=await E.storage.from("receipt-images").download(s);if(n)throw n;const i=new Blob([r],{type:"image/jpeg"}),l=window.URL.createObjectURL(i),o=document.createElement("a");o.href=l,o.download=e.file_name||`ì˜ìˆ˜ì¦_${e.id}.jpg`,document.body.appendChild(o),o.click(),document.body.removeChild(o),window.URL.revokeObjectURL(l),v.success("ì˜ìˆ˜ì¦ ì´ë¯¸ì§€ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.")}catch(a){v.error("ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}else v.error("ì˜ìˆ˜ì¦ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.")},Q=a.useCallback(async e=>{if(!R.canDelete)return void v.error("ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");const a=e.count>1?`${e.count}ì¥ì˜ ì˜ìˆ˜ì¦ì„`:`"${e.primary.file_name}" ì˜ìˆ˜ì¦ì„`;if(confirm(`ì •ë§ë¡œ ${a} ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`))try{for(const a of e.receipts){const e=B(a.receipt_image_url);if(e){const{error:a}=await E.storage.from("receipt-images").remove([e]);a&&s.warn("Storage íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨",{storageError:a,filePath:e})}const{error:t}=await E.from("purchase_receipts").delete().eq("id",a.id);if(t)throw t}v.success("ì˜ìˆ˜ì¦ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."),F()}catch(t){v.error("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}},[R.canDelete,F]);return r.jsxs("div",{className:"w-full",children:[r.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4",children:[r.jsxs("div",{children:[r.jsx("h1",{className:"page-title",children:"ì˜ìˆ˜ì¦ ê´€ë¦¬"}),r.jsx("p",{className:"page-subtitle",style:{marginTop:"-2px",marginBottom:"-4px"},children:"Receipt Management"})]}),r.jsxs("div",{className:"flex items-center gap-2 mt-4 sm:mt-0",children:[r.jsxs(n,{onClick:()=>{z(!0)},className:"button-base bg-hansl-600 hover:bg-hansl-700 text-white",children:[r.jsx(j,{className:"w-4 h-4 mr-1"}),"ì˜ìˆ˜ì¦ ì—…ë¡œë“œ"]}),r.jsxs("span",{className:"badge-stats bg-gray-100 text-gray-600 modal-subtitle",children:["ì´ ",Y.length,"ê±´"]})]})]}),r.jsxs(m,{className:"mb-4 border border-gray-200",children:[r.jsx(p,{className:"bg-white border-b border-gray-200 py-3",children:r.jsxs(g,{className:"flex items-center modal-section-title",children:[r.jsx(I,{className:"w-4 h-4 mr-2"}),"ê²€ìƒ‰ í•„í„°"]})}),r.jsx(h,{className:"py-3",children:r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2",children:[r.jsxs("div",{children:[r.jsx("label",{className:"block modal-label mb-1",children:"ê²€ìƒ‰"}),r.jsxs("div",{className:"relative",children:[r.jsx(O,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 w-3 h-3 text-gray-400"}),r.jsx(y,{placeholder:"íŒŒì¼ëª…, ë©”ëª¨, ì—…ë¡œë“œì¼...",value:u,onChange:e=>x(e.target.value),className:"pl-7 modal-subtitle h-9"})]})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block modal-label mb-1",children:"ì—…ë¡œë“œ ë‚ ì§œ"}),r.jsx(y,{type:"date",value:f,onChange:e=>b(e.target.value),className:"modal-subtitle h-9"})]}),r.jsx("div",{className:"flex items-end",children:r.jsx(n,{variant:"outline",onClick:()=>{x(""),b("")},className:"h-9 modal-subtitle",children:"ì´ˆê¸°í™”"})})]})})]}),r.jsx(m,{className:"overflow-hidden border border-gray-200",children:r.jsx(h,{className:"p-0",children:l||H?r.jsxs("div",{className:"flex items-center justify-center py-12",children:[r.jsx("div",{className:"w-8 h-8 border-2 border-hansl-500 border-t-transparent rounded-full animate-spin"}),r.jsx("span",{className:"ml-3 card-subtitle",children:"ë¡œë”© ì¤‘..."})]}):R.canView?0===Y.length?r.jsxs("div",{className:"text-center py-12",children:[r.jsx(c,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),r.jsx("h3",{className:"modal-section-title mb-2",children:"ì˜ìˆ˜ì¦ì´ ì—†ìŠµë‹ˆë‹¤"}),r.jsx("p",{className:"card-subtitle",children:"ì—…ë¡œë“œëœ ì˜ìˆ˜ì¦ì´ ì—†ê±°ë‚˜ ê²€ìƒ‰ ì¡°ê±´ì— ë§ëŠ” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤."})]}):r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"hidden md:block overflow-x-auto",children:r.jsxs("table",{className:"w-full min-w-fit",children:[r.jsx("thead",{className:"bg-gray-50",children:r.jsxs("tr",{children:[r.jsx("th",{className:"px-4 py-3 text-center header-title text-gray-600 uppercase tracking-wider",children:"ì¸ì‡„ì™„ë£Œ"}),r.jsx("th",{className:"px-4 py-3 text-center header-title text-gray-600 uppercase tracking-wider",children:"ì—…ë¡œë“œì¼"}),r.jsx("th",{className:"px-4 py-3 text-left header-title text-gray-600 uppercase tracking-wider",children:"ë©”ëª¨"}),R.canViewUploaderInfo&&r.jsx("th",{className:"px-4 py-3 text-left header-title text-gray-600 uppercase tracking-wider",children:"ë“±ë¡ì¸"}),r.jsx("th",{className:"px-4 py-3 text-center header-title text-gray-600 uppercase tracking-wider",children:"í¬ê¸°"}),r.jsx("th",{className:"px-4 py-3 text-center header-title text-gray-600 uppercase tracking-wider",children:"ì•¡ì…˜"}),R.canDelete&&r.jsx("th",{className:"px-4 py-3 text-center header-title text-gray-600 uppercase tracking-wider",children:"ì‚­ì œ"})]})}),r.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:Y.map(e=>{const a=e.primary,t=(e=>e.receipts.every(e=>e.is_printed))(e),s=e.receipts.reduce((e,a)=>e+(a.file_size||0),0);return r.jsxs("tr",{className:"hover:bg-gray-50 transition-colors cursor-pointer",onClick:()=>G(e),children:[r.jsx("td",{className:"px-4 py-3 modal-subtitle text-center",children:t?r.jsx("span",{className:"badge-stats bg-green-100 text-green-700",children:"âœ“ ì™„ë£Œ"}):r.jsx("span",{className:"badge-stats bg-gray-100 text-gray-600",children:"ë¯¸ì™„ë£Œ"})}),r.jsx("td",{className:"px-4 py-3 modal-subtitle text-center text-gray-600",children:$(a.uploaded_at)}),r.jsx("td",{className:"px-4 py-3 modal-subtitle text-gray-900",children:r.jsxs("div",{className:"flex items-center gap-1.5",children:[a.memo||"-",e.count>1&&r.jsxs("span",{className:"inline-flex items-center gap-0.5 badge-stats bg-blue-100 text-blue-700",children:[r.jsx(P,{className:"w-3 h-3"}),e.count,"ì¥"]})]})}),R.canViewUploaderInfo&&r.jsx("td",{className:"px-4 py-3 modal-subtitle text-gray-600",children:a.uploaded_by_name||a.uploaded_by}),r.jsx("td",{className:"px-4 py-3 modal-subtitle text-center text-gray-600",children:L(s)}),r.jsx("td",{className:"px-4 py-3 modal-subtitle text-center",children:r.jsxs("div",{className:"flex items-center justify-center gap-1",children:[r.jsx(n,{size:"sm",variant:"ghost",onClick:a=>{a.stopPropagation(),K(e)},className:"h-8 w-8 p-0",title:e.count>1?`${e.count}ì¥ ì¸ì‡„`:"ì¸ì‡„",children:r.jsx(T,{className:"w-4 h-4"})}),r.jsx(n,{size:"sm",variant:"ghost",onClick:e=>{e.stopPropagation(),Z(a)},className:"h-8 w-8 p-0",title:"ë‹¤ìš´ë¡œë“œ",children:r.jsx(U,{className:"w-4 h-4"})})]})}),R.canDelete&&r.jsx("td",{className:"px-4 py-3 modal-subtitle text-center",children:r.jsx(n,{size:"sm",variant:"ghost",onClick:a=>{a.stopPropagation(),Q(e)},className:"h-8 w-8 p-0 text-red-600 hover:bg-red-50",title:"ì‚­ì œ",children:r.jsx(d,{className:"w-4 h-4"})})})]},e.group_id||a.id)})})]})}),r.jsx("div",{className:"md:hidden space-y-3 p-4",children:Y.map(e=>r.jsx(q,{receipt:e.primary,groupCount:e.count,onView:()=>G(e),onPrint:()=>K(e),onDownload:Z,onDelete:R.canDelete?()=>Q(e):void 0},e.group_id||e.primary.id))})]}):r.jsxs("div",{className:"text-center py-12",children:[r.jsx("div",{className:"w-12 h-12 text-red-400 mx-auto mb-4",children:"ğŸ”’"}),r.jsx("h3",{className:"modal-section-title mb-2",children:"ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ"}),r.jsx("p",{className:"card-subtitle",children:"ì˜ìˆ˜ì¦ ê´€ë¦¬ì— ì ‘ê·¼í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."})]})})}),w&&r.jsx(V,{receipt:w,groupReceipts:_,isOpen:C,onClose:()=>{S(!1),N(null),k([])},onDelete:()=>{F()}}),r.jsx(A,{isOpen:D,onClose:()=>z(!1),onSuccess:()=>{F()}})]})}export{H as default};
//# sourceMappingURL=ReceiptsMain-DBUE7XH1.js.map
