import{a as W,l as b,r as j,j as e,B as g,X as Y,_ as Z}from"./index-7TSmMYOj.js";import{I as k,S as ee,a as se,b as ae,c as re,d as F,D as te,e as ce,f as ne,g as ie,h as le}from"./dialog-DRJyiOdL.js";import{D as oe,u as de,S as I,a as xe,b as me,E as he,c as ue,d as D,e as L,T as R,f as $,M as je,g as pe,h as B,i as ge,F as fe,j as w,k as y,l as v,m as N,n as S}from"./form-BiQPU9Il.js";import{P as be}from"./plus-BrwI3oKx.js";import{S as _e,T as K}from"./trash-2-C5cctltA.js";import{B as H,t as h}from"./index-CzKTV7wm.js";import{T as we,a as ye,b as q,c as E,d as ve,e as V}from"./table-B8W55NVc.js";import{E as P}from"./card-DSqWHh4Z.js";import{T as Ne}from"./textarea-DPlRHJ79.js";import{u as Se}from"./index.esm-D3zOs70r.js";import"./chevron-right-BiaQLDg8.js";class Ve{constructor(){this.supabase=W()}async getVendors(r){try{let s=this.supabase.from("vendors").select(`
          *,
          vendor_contacts (*)
        `).order("vendor_name");r?.search&&(s=s.or(`
          vendor_name.ilike.%${r.search}%,
          business_number.ilike.%${r.search}%,
          representative.ilike.%${r.search}%,
          contact_phone.ilike.%${r.search}%,
          email.ilike.%${r.search}%
        `)),r?.is_active!==void 0&&(s=s.eq("is_active",r.is_active));const{data:c,error:t}=await s;if(t)throw t;return{success:!0,data:c||[]}}catch(s){return b.error("업체 목록 조회 실패",s),{success:!1,error:s instanceof Error?s.message:"알 수 없는 오류가 발생했습니다."}}}async getVendor(r){try{const{data:s,error:c}=await this.supabase.from("vendors").select("*").eq("id",r).single();if(c)throw c;return{success:!0,data:s}}catch(s){return b.error("업체 조회 실패",s),{success:!1,error:s instanceof Error?s.message:"알 수 없는 오류가 발생했습니다."}}}async createVendor(r){try{if(r.business_number){const{data:n}=await this.supabase.from("vendors").select("id").eq("business_number",r.business_number).single();if(n)return{success:!1,error:"이미 등록된 사업자번호입니다."}}const{data:s}=await this.supabase.from("vendors").select("id").eq("vendor_name",r.vendor_name).single();if(s)return{success:!1,error:"이미 등록된 업체명입니다."};const{data:c,error:t}=await this.supabase.from("vendors").insert({...r,is_active:!0}).select().single();if(t)throw t;return{success:!0,data:c}}catch(s){return b.error("업체 생성 실패",s),{success:!1,error:s instanceof Error?s.message:"알 수 없는 오류가 발생했습니다."}}}async updateVendor(r,s){try{if(s.business_number){const{data:n}=await this.supabase.from("vendors").select("id").eq("business_number",s.business_number).neq("id",r).single();if(n)return{success:!1,error:"이미 등록된 사업자번호입니다."}}if(s.vendor_name){const{data:n}=await this.supabase.from("vendors").select("id").eq("vendor_name",s.vendor_name).neq("id",r).single();if(n)return{success:!1,error:"이미 등록된 업체명입니다."}}const{data:c,error:t}=await this.supabase.from("vendors").update(s).eq("id",r).select().single();if(t)throw t;return{success:!0,data:c}}catch(c){return b.error("업체 수정 실패",c),{success:!1,error:c instanceof Error?c.message:"알 수 없는 오류가 발생했습니다."}}}async deleteVendor(r){try{const{data:s}=await this.supabase.from("purchase_requests").select("id").eq("vendor_id",r).limit(1);if(s&&s.length>0){const{error:c}=await this.supabase.from("vendors").update({is_active:!1}).eq("id",r);if(c)throw c;return{success:!0}}else{const{error:c}=await this.supabase.from("vendors").delete().eq("id",r);if(c)throw c;return{success:!0}}}catch(s){return b.error("업체 삭제 실패",s),{success:!1,error:s instanceof Error?s.message:"알 수 없는 오류가 발생했습니다."}}}async toggleVendorStatus(r){try{const{data:s,error:c}=await this.supabase.from("vendors").select("is_active").eq("id",r).single();if(c)throw c;const{data:t,error:n}=await this.supabase.from("vendors").update({is_active:!s.is_active}).eq("id",r).select().single();if(n)throw n;return{success:!0,data:t}}catch(s){return b.error("업체 상태 변경 실패",s),{success:!1,error:s instanceof Error?s.message:"알 수 없는 오류가 발생했습니다."}}}async getVendorContacts(r){try{const{data:s,error:c}=await this.supabase.from("vendor_contacts").select("*").eq("vendor_id",r).order("contact_name");if(c)throw c;return{success:!0,data:s||[]}}catch(s){return b.error("업체 연락처 조회 실패",s),{success:!1,error:s instanceof Error?s.message:"알 수 없는 오류가 발생했습니다."}}}async getVendorsForExport(){try{const{data:r,error:s}=await this.supabase.from("vendors").select("*").order("vendor_name");if(s)throw s;return{success:!0,data:(r||[]).map(t=>({업체명:t.vendor_name,사업자번호:t.business_number||"",대표자:t.representative||"",연락처:t.contact_phone||"",주소:t.address||"",이메일:t.email||"",상태:t.is_active?"활성":"비활성",등록일:t.created_at?new Date(t.created_at).toLocaleDateString("ko-KR"):""}))}}catch(r){return b.error("업체 Excel 내보내기 실패",r),{success:!1,error:r instanceof Error?r.message:"알 수 없는 오류가 발생했습니다."}}}}const C=new Ve;function ke({filters:x,onFiltersChange:r,onExport:s,onCreateNew:c}){const[t,n]=j.useState(x.search||""),u=d=>{d.preventDefault(),r({...x,search:t.trim()||void 0})},o=d=>{r({...x,is_active:d==="all"?void 0:d==="active"})},f=()=>{n(""),r({})},p=x.search||x.is_active!==void 0;return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"업체 관리"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(g,{variant:"outline",onClick:s,className:"flex items-center gap-2",children:[e.jsx(oe,{className:"w-4 h-4"}),"Excel 내보내기"]}),e.jsxs(g,{onClick:c,className:"flex items-center gap-2",children:[e.jsx(be,{className:"w-4 h-4"}),"업체 등록"]})]})]}),e.jsx("div",{className:"bg-white p-4 rounded-lg border space-y-4",children:e.jsxs("form",{onSubmit:u,className:"flex gap-4 items-end",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"검색"}),e.jsxs("div",{className:"relative",children:[e.jsx(_e,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx(k,{type:"text",placeholder:"업체명, 사업자번호, 대표자, 연락처, 이메일로 검색",value:t,onChange:d=>n(d.target.value),className:"pl-10"})]})]}),e.jsxs("div",{className:"sm:min-w-[120px]",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"상태"}),e.jsxs(ee,{value:x.is_active===void 0?"all":x.is_active?"active":"inactive",onValueChange:o,children:[e.jsx(se,{children:e.jsx(ae,{})}),e.jsxs(re,{children:[e.jsx(F,{value:"all",children:"전체"}),e.jsx(F,{value:"active",children:"활성"}),e.jsx(F,{value:"inactive",children:"비활성"})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(g,{type:"submit",children:"검색"}),p&&e.jsxs(g,{type:"button",variant:"outline",onClick:f,className:"flex items-center gap-1",children:[e.jsx(Y,{className:"w-4 h-4"}),"초기화"]})]})]})})]})}function Ce({vendors:x,onEdit:r,onView:s,onRefresh:c}){const[t,n]=j.useState(null),{sortedData:u,sortConfig:o,handleSort:f}=de(x,"vendor_name","asc"),p=async a=>{n(a.id);try{const l=await C.toggleVendorStatus(a.id);l.success?(h.success(`업체가 ${a.is_active?"비활성화":"활성화"}되었습니다.`),c()):h.error(l.error||"상태 변경에 실패했습니다.")}catch{h.error("상태 변경 중 오류가 발생했습니다.")}finally{n(null)}},d=async a=>{if(confirm(`정말로 '${a.vendor_name}' 업체를 삭제하시겠습니까?`)){n(a.id);try{const l=await C.deleteVendor(a.id);l.success?(h.success("업체가 삭제되었습니다."),c()):h.error(l.error||"삭제에 실패했습니다.")}catch{h.error("삭제 중 오류가 발생했습니다.")}finally{n(null)}}},i=a=>a?new Date(a).toLocaleDateString("ko-KR"):"-";return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"hidden md:block border rounded-lg overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(we,{children:[e.jsx(ye,{children:e.jsxs(q,{children:[e.jsx(E,{className:"w-[100px] min-w-[100px]",children:e.jsx(I,{sortKey:"vendor_name",currentSortKey:o.key,sortDirection:o.direction,onSort:()=>f("vendor_name"),children:"업체명"})}),e.jsx(E,{className:"w-[60px] min-w-[60px] text-center",children:"담당자"}),e.jsx(E,{children:"담당자 정보"}),e.jsx(E,{className:"w-[70px] min-w-[70px]",children:e.jsx(I,{sortKey:"created_at",currentSortKey:o.key,sortDirection:o.direction,onSort:()=>f("created_at"),children:"등록일"})}),e.jsx(E,{className:"w-[50px] min-w-[50px] text-center",children:"작업"})]})}),e.jsx(ve,{children:x.length===0?e.jsx(q,{children:e.jsx(V,{colSpan:5,className:"text-center py-8 text-gray-500",children:"등록된 업체가 없습니다."})}):u.map(a=>e.jsxs(q,{children:[e.jsx(V,{className:"font-medium text-[11px] px-2 py-1.5",children:a.vendor_name}),e.jsx(V,{className:"text-center text-[11px] px-1 py-1.5",children:e.jsxs(H,{variant:"outline",className:"text-[10px] px-1 py-0",children:[a.vendor_contacts?.length||0,"명"]})}),e.jsx(V,{className:"px-2 py-1.5",children:e.jsxs("div",{className:"space-y-0.5",children:[a.vendor_contacts&&a.vendor_contacts.length>0?a.vendor_contacts.slice(0,2).map((l,_)=>e.jsxs("div",{className:"text-[10px]",children:[e.jsx("span",{className:"font-medium",children:l.contact_name}),e.jsx("span",{className:"text-gray-500 ml-1",children:l.contact_phone}),l.contact_email&&e.jsx("span",{className:"text-gray-500 ml-1 truncate inline-block max-w-[180px]",children:l.contact_email})]},_)):e.jsx("span",{className:"text-gray-400 text-[10px]",children:"담당자 없음"}),a.vendor_contacts&&a.vendor_contacts.length>2&&e.jsxs("span",{className:"text-[10px] text-gray-500",children:["외 ",a.vendor_contacts.length-2,"명"]})]})}),e.jsx(V,{className:"text-[11px] px-2 py-1.5",children:i(a.created_at)}),e.jsx(V,{className:"px-1 py-1.5 text-center",children:e.jsxs(xe,{children:[e.jsx(me,{asChild:!0,children:e.jsx(g,{variant:"ghost",className:"h-7 w-7 p-0",disabled:t===a.id,children:e.jsx(he,{className:"h-3 w-3"})})}),e.jsxs(ue,{align:"end",children:[e.jsxs(D,{onClick:()=>s(a),children:[e.jsx(P,{className:"mr-2 h-4 w-4"}),"상세 보기"]}),e.jsxs(D,{onClick:()=>r(a),children:[e.jsx(L,{className:"mr-2 h-4 w-4"}),"수정"]}),e.jsx(D,{onClick:()=>p(a),children:a.is_active?e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"mr-2 h-4 w-4"}),"비활성화"]}):e.jsxs(e.Fragment,{children:[e.jsx($,{className:"mr-2 h-4 w-4"}),"활성화"]})}),e.jsxs(D,{onClick:()=>d(a),className:"text-red-600",children:[e.jsx(K,{className:"mr-2 h-4 w-4"}),"삭제"]})]})]})})]},a.id))})]})})}),e.jsx("div",{className:"block md:hidden space-y-3",children:u.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"등록된 업체가 없습니다."}):u.map(a=>e.jsxs(je,{children:[e.jsx(pe,{children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:a.vendor_name}),e.jsxs(H,{variant:"outline",children:[a.vendor_contacts?.length||0,"명"]})]})}),e.jsx(B,{label:"담당자",value:e.jsxs("div",{className:"space-y-1",children:[a.vendor_contacts&&a.vendor_contacts.length>0?a.vendor_contacts.slice(0,2).map((l,_)=>e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium",children:l.contact_name}),e.jsx("div",{className:"text-gray-500 text-xs",children:l.contact_phone}),l.contact_email&&e.jsx("div",{className:"text-gray-500 text-xs",children:l.contact_email})]},_)):e.jsx("span",{className:"text-gray-400",children:"담당자 없음"}),a.vendor_contacts&&a.vendor_contacts.length>2&&e.jsxs("span",{className:"text-sm text-gray-500",children:["외 ",a.vendor_contacts.length-2,"명"]})]})}),e.jsx(B,{label:"등록일",value:i(a.created_at)}),e.jsxs(ge,{children:[e.jsx(g,{size:"sm",variant:"outline",onClick:()=>s(a),children:e.jsx(P,{className:"w-4 h-4"})}),e.jsx(g,{size:"sm",variant:"outline",onClick:()=>r(a),children:e.jsx(L,{className:"w-4 h-4"})}),e.jsx(g,{size:"sm",variant:"outline",onClick:()=>p(a),disabled:t===a.id,children:a.is_active?e.jsx(R,{className:"w-4 h-4"}):e.jsx($,{className:"w-4 h-4"})}),e.jsx(g,{size:"sm",variant:"outline",className:"text-red-600",onClick:()=>d(a),disabled:t===a.id,children:e.jsx(K,{className:"w-4 h-4"})})]})]},a.id))})]})}function Ee({isOpen:x,onClose:r,vendor:s,onSave:c,mode:t}){const[n,u]=j.useState(!1),o=Se({defaultValues:{vendor_name:"",business_number:"",representative:"",contact_phone:"",address:"",email:""}});j.useEffect(()=>{s&&x?o.reset({vendor_name:s.vendor_name||"",business_number:s.business_number||"",representative:s.representative||"",contact_phone:s.contact_phone||"",address:s.address||"",email:s.email||""}):!s&&x&&o.reset({vendor_name:"",business_number:"",representative:"",contact_phone:"",address:"",email:""})},[s,x,o]);const f=async i=>{u(!0);try{let a;t==="create"?a=await C.createVendor(i):t==="edit"&&s&&(a=await C.updateVendor(s.id,i)),a?.success?(h.success(t==="create"?"업체가 등록되었습니다.":"업체 정보가 수정되었습니다."),c(),r()):h.error(a?.error||"처리 중 오류가 발생했습니다.")}catch{h.error("처리 중 오류가 발생했습니다.")}finally{u(!1)}},p=()=>{switch(t){case"create":return"업체 등록";case"edit":return"업체 수정";case"view":return"업체 상세";default:return"업체"}},d=t==="view";return e.jsx(te,{open:x,onOpenChange:r,children:e.jsxs(ce,{className:"w-full max-w-[95vw] sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ne,{children:e.jsx(ie,{children:p()})}),e.jsx(fe,{...o,children:e.jsxs("form",{onSubmit:o.handleSubmit(f),className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(w,{control:o.control,name:"vendor_name",rules:{required:"업체명을 입력해주세요."},render:({field:i})=>e.jsxs(y,{children:[e.jsx(v,{children:"업체명 *"}),e.jsx(N,{children:e.jsx(k,{...i,placeholder:"업체명을 입력하세요",disabled:d})}),e.jsx(S,{})]})}),e.jsx(w,{control:o.control,name:"business_number",render:({field:i})=>e.jsxs(y,{children:[e.jsx(v,{children:"사업자번호"}),e.jsx(N,{children:e.jsx(k,{...i,placeholder:"000-00-00000",disabled:d})}),e.jsx(S,{})]})}),e.jsx(w,{control:o.control,name:"representative",render:({field:i})=>e.jsxs(y,{children:[e.jsx(v,{children:"대표자"}),e.jsx(N,{children:e.jsx(k,{...i,placeholder:"대표자명을 입력하세요",disabled:d})}),e.jsx(S,{})]})}),e.jsx(w,{control:o.control,name:"contact_phone",render:({field:i})=>e.jsxs(y,{children:[e.jsx(v,{children:"연락처"}),e.jsx(N,{children:e.jsx(k,{...i,placeholder:"010-0000-0000",disabled:d})}),e.jsx(S,{})]})}),e.jsx(w,{control:o.control,name:"email",render:({field:i})=>e.jsxs(y,{children:[e.jsx(v,{children:"이메일"}),e.jsx(N,{children:e.jsx(k,{...i,type:"email",placeholder:"company@example.com",disabled:d})}),e.jsx(S,{})]})})]}),e.jsx(w,{control:o.control,name:"address",render:({field:i})=>e.jsxs(y,{children:[e.jsx(v,{children:"주소"}),e.jsx(N,{children:e.jsx(Ne,{...i,placeholder:"주소를 입력하세요",className:"min-h-[80px]",disabled:d})}),e.jsx(S,{})]})}),t==="view"&&s&&e.jsx("div",{className:"pt-4 border-t",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"상태:"}),e.jsx("span",{className:`ml-2 px-2 py-1 rounded text-xs ${s.is_active?"bg-green-100 text-green-800":"bg-gray-100 text-gray-600"}`,children:s.is_active?"활성":"비활성"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"등록일:"}),e.jsx("span",{className:"ml-2",children:s.created_at?new Date(s.created_at).toLocaleDateString("ko-KR"):"-"})]})]})}),e.jsxs(le,{className:"gap-2",children:[e.jsx(g,{type:"button",variant:"outline",onClick:r,children:t==="view"?"닫기":"취소"}),!d&&e.jsx(g,{type:"submit",disabled:n,children:n?t==="create"?"등록 중...":"수정 중...":t==="create"?"등록":"수정"})]})]})})]})})}function Pe(){const[x,r]=j.useState([]),[s,c]=j.useState([]),[t,n]=j.useState(!0),[u,o]=j.useState({}),[f,p]=j.useState(!1),[d,i]=j.useState(null),[a,l]=j.useState("create"),_=async()=>{n(!0);try{const m=await C.getVendors(u);m.success&&m.data?(r(m.data),c(m.data)):h.error(m.error||"업체 목록을 불러오는데 실패했습니다.")}catch{h.error("업체 목록을 불러오는 중 오류가 발생했습니다.")}finally{n(!1)}};j.useEffect(()=>{_()},[u]);const z=()=>{i(null),l("create"),p(!0)},O=m=>{i(m),l("edit"),p(!0)},X=m=>{i(m),l("view"),p(!0)},A=()=>{p(!1),i(null)},G=()=>{_()},J=async()=>{try{const m=await C.getVendorsForExport();if(m.success&&m.data){const T=await Z(()=>import("./xlsx-DGuHH-KN.js"),[]),Q=T.utils.json_to_sheet(m.data),M=T.utils.book_new();T.utils.book_append_sheet(M,Q,"업체 목록");const U=`업체_목록_${new Date().toISOString().slice(0,10)}.xlsx`;T.writeFile(M,U),h.success("Excel 파일이 다운로드되었습니다.")}else h.error(m.error||"Excel 내보내기에 실패했습니다.")}catch{h.error("Excel 내보내기 중 오류가 발생했습니다.")}};return t&&x.length===0?e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"}),e.jsx("p",{className:"mt-2 text-gray-600",children:"업체 목록을 불러오는 중..."})]})}):e.jsx(e.Fragment,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsx(ke,{filters:u,onFiltersChange:o,onExport:J,onCreateNew:z}),e.jsxs("div",{className:"bg-white rounded-lg border",children:[e.jsx("div",{className:"p-4 border-b",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h3",{className:"text-lg font-medium",children:"업체 목록"}),e.jsxs("span",{className:"px-3 py-1 bg-blue-50 text-blue-600 text-sm font-semibold rounded-full",children:["총 ",s.length,"개"]})]}),e.jsx("div",{className:"text-sm text-gray-500",children:t&&"업데이트 중..."})]})}),e.jsx(Ce,{vendors:s,onEdit:O,onView:X,onRefresh:_})]}),e.jsx(Ee,{isOpen:f,onClose:A,vendor:d,onSave:G,mode:a})]})})}export{Pe as default};
//# sourceMappingURL=VendorMain-X8uCNsrO.js.map
