import{c as e,r as t,j as a,l as r,B as s,a as i,z as n,A as l,C as d,D as c,E as o,F as m,X as u,G as p,H as h,I as _,J as x,K as g,L as v,M as f}from"./index-CNdtkslX.js";import{b}from"./helpers-CsHcdtkA.js";import{a as y,k as j,C as N,f as w,P as q}from"./calendar-BkEvKLf4.js";import{P as S,a as k,b as C}from"./popover-CNkqbfNY.js";import{I as D,D as I,a as $,b as W,c as O}from"./input-eTJsnnVC.js";import{t as T}from"./index-s0sfJlYN.js";import{C as M}from"./calendar-7BrgMhOb.js";import{C as P}from"./chevron-down-CVFXLMF5.js";import{P as F}from"./package-DJFApW8C.js";import{C as L}from"./credit-card-Dethm74P.js";import{T as U}from"./card-CTE-qjnR.js";import{P as z}from"./plus-CvWzAUg_.js";import{S as K}from"./save-DQCMExT9.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const B=e("dollar-sign",[["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}],["path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6",key:"1b0p4s"}]]),H=e("truck",[["path",{d:"M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2",key:"wrbu53"}],["path",{d:"M15 18H9",key:"1lyqi6"}],["path",{d:"M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14",key:"lysw3i"}],["circle",{cx:"17",cy:"18",r:"2",key:"332jqn"}],["circle",{cx:"7",cy:"18",r:"2",key:"19iecd"}]]);function A({children:e,onDateSelect:s,disabled:i=!1,placeholder:n="ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”",align:l="center",side:d="bottom"}){const[c,o]=t.useState(!1);return a.jsxs(S,{open:c,onOpenChange:o,children:[a.jsx(k,{asChild:!0,disabled:i,children:e}),a.jsx(C,{className:"w-auto p-0 border-gray-200 shadow-lg",align:l,side:d,sideOffset:8,children:a.jsxs("div",{className:"bg-white business-radius-card p-2",children:[a.jsx("div",{className:"mb-2 px-1",children:a.jsx("div",{className:"modal-label text-gray-600 text-center",children:n})}),a.jsx(y,{mode:"single",selected:void 0,onSelect:e=>{r.debug("ðŸ—“ï¸ Calendar onSelect ì§ì ‘ í˜¸ì¶œ:",{date:e,isToday:e&&(new Date).toDateString()===e.toDateString(),dateValue:e?.getTime(),todayValue:(new Date).getTime()}),(e=>{r.debug("ðŸ“… DatePickerPopover handleDateSelect í˜¸ì¶œ:",{date:e,isToday:e&&(new Date).toDateString()===e.toDateString(),dateString:e?.toDateString(),todayString:(new Date).toDateString()}),e?(r.debug("âœ… ë‚ ì§œ ì„ íƒë¨, onDateSelect í˜¸ì¶œ ì˜ˆì •"),s(e),o(!1),r.debug("ðŸ”š DatePickerPopover ì²˜ë¦¬ ì™„ë£Œ")):r.debug("âŒ ë‚ ì§œê°€ undefinedìž„")})(e)},locale:j,initialFocus:!0,className:"compact-calendar",disabled:!1,fromDate:new Date("2020-01-01"),toDate:new Date("2030-12-31"),defaultMonth:new Date,modifiers:{today:new Date},modifiersClassNames:{today:"bg-blue-500 text-white font-semibold cursor-pointer hover:bg-blue-600 rounded-md"}})]})})]})}function R({children:e,onConfirm:r,disabled:i=!1,placeholder:n="ë‚ ì§œì™€ ê¸ˆì•¡ì„ ìž…ë ¥í•˜ì„¸ìš”",align:l="center",side:d="bottom",defaultDate:c,defaultAmount:o}){const[m,u]=t.useState(!1),[p,h]=t.useState(c),[_,x]=t.useState(o?.toString()||"");return a.jsxs(S,{open:m,onOpenChange:u,children:[a.jsx(k,{asChild:!0,disabled:i,children:e}),a.jsx(C,{className:"w-auto p-0 border-gray-200 shadow-lg",align:l,side:d,sideOffset:8,children:a.jsxs("div",{className:"bg-white business-radius-card p-3",children:[a.jsx("div",{className:"mb-2 px-1",children:a.jsx("div",{className:"modal-label text-gray-600 text-center",children:n})}),a.jsx(y,{mode:"single",selected:p,onSelect:h,locale:j,initialFocus:!0,className:"compact-calendar",disabled:!1,fromDate:new Date("2020-01-01"),toDate:new Date("2030-12-31"),defaultMonth:p||new Date,modifiers:{today:new Date},modifiersClassNames:{today:"bg-blue-500 text-white font-semibold cursor-pointer hover:bg-blue-600 rounded-md"}}),a.jsxs("div",{className:"mt-3 px-1",children:[a.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"ì§€ì¶œê¸ˆì•¡"}),a.jsx(D,{type:"text",value:_,onChange:e=>{const t=e.target.value.replace(/[^0-9]/g,"");if(t){const e=parseInt(t,10);x(e.toLocaleString())}else x("")},placeholder:"ê¸ˆì•¡ì„ ìž…ë ¥í•˜ì„¸ìš”",className:"w-full"})]}),a.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[a.jsx(s,{variant:"outline",size:"sm",onClick:()=>u(!1),children:"ì·¨ì†Œ"}),a.jsx(s,{size:"sm",onClick:()=>{if(!p)return;const e=parseFloat(_.replace(/,/g,""));isNaN(e)||e<=0||(r(p,e),u(!1),h(c),x(o?.toString()||""))},disabled:!p||!_||parseFloat(_.replace(/,/g,""))<=0,className:"button-base button-action-primary",children:"í™•ì¸"})]})]})})]})}function E({config:e,currentUserName:a,canPerformAction:s,purchaseId:o,onUpdate:m,onOptimisticUpdate:u}){const p=i(),h=t.useCallback(async(t,i,d)=>{if(!s)return r.warn("âŒ ê¶Œí•œ ì—†ìŒ",{canPerformAction:s,currentUserName:a}),void T.error(("statement_received"===e.field?"ê±°ëž˜ëª…ì„¸ì„œ":"ìž…ê³ ")+" í™•ì¸ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");const c="number"==typeof t?t:Number(t);if(Number.isNaN(c))return r.error("âŒ ìž˜ëª»ëœ ID",{itemId:t,numericId:c}),void T.error("ìœ íš¨í•˜ì§€ ì•Šì€ í•­ëª© ID ìž…ë‹ˆë‹¤.");if(d){const t=`í’ˆëª©ëª…: ${d.item_name||"-"}\nê·œê²©: ${d.specification||"-"}\nìˆ˜ëŸ‰: ${d.quantity?.toLocaleString()||0}\në‹¨ê°€: â‚©${d.unit_price_value?.toLocaleString()||0}\ní•©ê³„: â‚©${d.amount_value?.toLocaleString()||0}\në¹„ê³ : ${d.remark||"-"}\n\n${e.confirmMessage.confirm}`;if(!window.confirm(t))return}try{let t;"statement_received"===e.field?t={is_statement_received:!0,statement_received_date:i.toISOString(),statement_received_by_name:a}:"actual_received"===e.field&&(t={actual_received_date:i.toISOString(),is_received:!0}),r.debug("ðŸ“ ì—…ë°ì´íŠ¸í•  ë°ì´í„°:",t);const{data:s,error:h}=await p.from("purchase_request_items").update(t).eq("id",c).select();if(r.debug("ðŸ“ DB ì—…ë°ì´íŠ¸ ê²°ê³¼:",{data:s,error:h}),h)throw r.error("âŒ DB ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",h),h;if(r.info("âœ… DB ì—…ë°ì´íŠ¸ ì„±ê³µ",s),o)if("actual_received"===e.field){n(o,c,i.toISOString())||r.warn("[useConfirmDateAction] ë©”ëª¨ë¦¬ ìºì‹œ ìž…ê³ ì™„ë£Œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{purchaseId:o,itemId:c})}else if("statement_received"===e.field){l(o,c,i.toISOString(),a||void 0)||r.warn("[useConfirmDateAction] ë©”ëª¨ë¦¬ ìºì‹œ ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{purchaseId:o,itemId:c})}u&&u({itemId:c,selectedDate:i,action:"confirm",itemInfo:d}),m&&m(),T.success(e.successMessage.confirm)}catch(h){r.error("âŒ ì „ì²´ ì²˜ë¦¬ ì‹¤íŒ¨",h),T.error(("statement_received"===e.field?"ê±°ëž˜ëª…ì„¸ì„œ":"ìž…ê³ ")+" í™•ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},[e,a,s,o,m,u,p]),_=t.useCallback(async(t,i)=>{if(!s)return r.warn("âŒ ì·¨ì†Œ ê¶Œí•œ ì—†ìŒ",{canPerformAction:s,currentUserName:a}),void T.error(("statement_received"===e.field?"ê±°ëž˜ëª…ì„¸ì„œ":"ìž…ê³ ")+" í™•ì¸ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");const n="number"==typeof t?t:Number(t);if(Number.isNaN(n))T.error("ìœ íš¨í•˜ì§€ ì•Šì€ í•­ëª© ID ìž…ë‹ˆë‹¤.");else{if(i){const t=`í’ˆëª©ëª…: ${i.item_name||"-"}\nê·œê²©: ${i.specification||"-"}\nìˆ˜ëŸ‰: ${i.quantity?.toLocaleString()||0}\në‹¨ê°€: â‚©${i.unit_price_value?.toLocaleString()||0}\ní•©ê³„: â‚©${i.amount_value?.toLocaleString()||0}\në¹„ê³ : ${i.remark||"-"}\n\n${e.confirmMessage.cancel}`;if(!window.confirm(t))return}try{let a;r.debug(`ðŸ”„ ${e.field} í™•ì¸ ì·¨ì†Œ ì‹œìž‘`,{itemId:t,itemName:i?.item_name}),"statement_received"===e.field?a={is_statement_received:!1,statement_received_date:null,statement_received_by_name:null}:"actual_received"===e.field&&(a={actual_received_date:null,is_received:!1}),r.debug("ðŸ”„ ì·¨ì†Œ ì—…ë°ì´íŠ¸í•  ë°ì´í„°:",a);const{data:s,error:l}=await p.from("purchase_request_items").update(a).eq("id",n).select();if(r.debug("ðŸ”„ ì·¨ì†Œ DB ì—…ë°ì´íŠ¸ ê²°ê³¼:",{data:s,error:l}),l)throw r.error("âŒ DB ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",l),l;if(r.info(`âœ… ${e.field} í™•ì¸ ì·¨ì†Œ ì„±ê³µ`,s),o)if("actual_received"===e.field){d(o,n)||r.warn("[useConfirmDateAction] ë©”ëª¨ë¦¬ ìºì‹œ ìž…ê³ ì·¨ì†Œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{purchaseId:o,itemId:n})}else if("statement_received"===e.field){c(o,n)||r.warn("[useConfirmDateAction] ë©”ëª¨ë¦¬ ìºì‹œ ê±°ëž˜ëª…ì„¸ì„œ ì·¨ì†Œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{purchaseId:o,itemId:n})}u&&u({itemId:n,action:"cancel",itemInfo:i}),m&&m(),T.success(e.successMessage.cancel)}catch(l){r.error(`âŒ ${e.field} í™•ì¸ ì·¨ì†Œ ì‹¤íŒ¨`,l),T.error(("statement_received"===e.field?"ê±°ëž˜ëª…ì„¸ì„œ":"ìž…ê³ ")+" í™•ì¸ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}}},[e,s,o,m,u,p]),x=t.useCallback(t=>"statement_received"===e.field?t.is_statement_received:"actual_received"===e.field&&t.is_received,[e.field]),g=t.useCallback(t=>"statement_received"===e.field?t.statement_received_date:"actual_received"===e.field?t.actual_received_date:null,[e.field]),v=t.useCallback(t=>"statement_received"===e.field?t.statement_received_by_name:(e.field,null),[e.field]);return{config:e,handleConfirm:h,handleCancel:_,isCompleted:x,getCompletedDate:g,getCompletedByName:v}}const V=t.memo(function({purchaseId:e,isOpen:d,onClose:c,embedded:y=!1,currentUserRoles:j=[],activeTab:S,onRefresh:k,onOptimisticUpdate:C,onDelete:V}){const{allPurchases:J,lastFetch:G}=o(),[Q,X]=t.useState(!1),[Y,Z]=t.useState(null),[ee,te]=t.useState(!1),[ae,re]=t.useState(null),[se,ie]=t.useState([]),[ne,le]=t.useState([]),[de,ce]=t.useState([]),[oe,me]=t.useState(""),[ue,pe]=t.useState([]),[he,_e]=t.useState(null),xe=t.useMemo(()=>{if(Y?.items&&Y.items.length>0)return Y.items;if(Y?.purchase_request_items&&Y.purchase_request_items.length>0)return Y.purchase_request_items;if(e&&J){const t=J.find(t=>t.id===e);if(t)return t.items&&t.items.length>0?t.items:t.purchase_request_items||[]}return[]},[Y,e,J,G]);t.useMemo(()=>{if(ue.length>0){const e=ue.length>1?12*(ue.length-1):0,t=24,a=ue.reduce((e,t)=>e+t,0)+e+t;return Math.max(a,720)}const e=[120,200,70,90,100,150,80];"purchase"===S&&e.push(120),"receipt"!==S&&"done"!==S||e.push(120),"receipt"===S&&e.push(140),"done"===S&&e.push(100,80,110),ee&&e.push(110);const t=e.length>1?12*(e.length-1):0,a=e.reduce((e,t)=>e+t,0)+t+48;return Math.max(a,720)},[ue,S,ee]);const ge=t.useRef(null),ve=i();t.useEffect(()=>{d&&(async()=>{try{const e="https://qvhbigvdfyvhoegkhvef.supabase.co";if(!e||e.includes("placeholder"))return void r.warn("Supabase í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ - PurchaseDetailModal");const{data:{user:t}}=await ve.auth.getUser();if(t){let{data:e}=await ve.from("employees").select("*").eq("id",t.id).maybeSingle();if(!e&&t.email){const{data:a}=await ve.from("employees").select("*").eq("email",t.email).maybeSingle();e=a}if(e?.name&&me(e.name),e?.purchase_role){let t=[];t=Array.isArray(e.purchase_role)?e.purchase_role.map(e=>String(e).trim()):String(e.purchase_role).split(",").map(e=>e.trim()).filter(e=>e.length>0),ce(t)}}}catch(e){}})()},[d]);const fe=Array.isArray(j)&&j.length>0?j:de,be=fe.includes("final_approver")||fe.includes("app_admin")||fe.includes("ceo"),ye=fe.includes("lead buyer"),je=be||ye,Ne="approved"===Y?.final_manager_status?be:be||Y?.requester_name===oe,we=fe.includes("app_admin")||fe.includes("lead buyer")||fe.includes("lead buyer"),qe=fe.includes("app_admin")||Y?.requester_name===oe;fe.includes("final_approver")||fe.includes("app_admin")||fe.includes("ceo");const Se=fe.includes("app_admin")||fe.includes("lead buyer"),ke=t.useCallback(async()=>{if(e)try{const t=m(e);if(t){const e=t.items&&t.items.length>0?t.items:t.purchase_request_items||[],a={...t,id:String(t.id),is_po_generated:!1,items:e,purchase_request_items:e,vendor:{id:t.vendor_id,vendor_name:t.vendor_name||"ì•Œ ìˆ˜ ì—†ìŒ",is_active:!0},vendor_contacts:[]};return Z(a),re(a),void ie(e.length>0?e:[])}const a=i(),{data:r,error:s}=await a.from("purchase_requests").select("\n          *,\n          vendors(id, vendor_name),\n          purchase_request_items(*)\n        ").eq("id",e).single();if(s)throw s;if(r){const e=(r.purchase_request_items||[]).sort((e,t)=>(e.line_number||999999)-(t.line_number||999999)),t={...r,items:e,vendor:r.vendors||{id:0,vendor_name:"ì•Œ ìˆ˜ ì—†ìŒ"},vendor_contacts:[]};Z(t),re(t),ie(e)}}catch(t){r.error("ëª¨ë‹¬ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨",t)}},[e]);t.useEffect(()=>{if(!e||!J||!Y)return;const t=J.find(t=>t.id===e);if(t){const e=t.items&&t.items.length>0?t.items:t.purchase_request_items||[],a={...Y,...t,id:String(t.id),items:e,purchase_request_items:e};Z(a),re(a),ie(e.length>0?e:[])}},[J,G]),t.useEffect(()=>{if(!d||!e||!J)return;const t=J.find(t=>t.id===e);if(t){const e=t.items&&t.items.length>0?t.items:t.purchase_request_items||[],a={...t,id:String(t.id),is_po_generated:!1,items:e,purchase_request_items:e,vendor:{id:t.vendor_id,vendor_name:t.vendor_name||"ì•Œ ìˆ˜ ì—†ìŒ",is_active:!0},vendor_contacts:[]};Z(a),re(a),ie(e.length>0?e:[])}},[d,e,J]);const[Ce,De]=t.useState(!0),Ie=e?Number(e):Y?Number(Y.id):NaN,$e=t.useCallback(({itemId:e,selectedDate:t,action:a})=>{const r=String(e),s=(new Date).toISOString(),i=t?t.toISOString():void 0,n=e=>e?e.map(e=>String(e.id)!==r?e:"confirm"===a?{...e,is_received:!0,actual_received_date:i,received_at:s}:{...e,is_received:!1,actual_received_date:void 0,received_at:void 0}):e;Z(e=>{if(!e)return e;const t=n(e.items)||[],a=t.length,r=t.filter(e=>e.is_received).length,i=a>0&&r===a;return{...e,items:t,is_received:i,received_at:i?e.received_at||s:void 0}}),re(e=>{if(!e)return e;const t=n(e.items)||[];return{...e,items:t}}),ie(e=>e&&0!==e.length?e.map(e=>e.id&&String(e.id)===r?"confirm"===a?{...e,is_received:!0,actual_received_date:i,received_at:s}:{...e,is_received:!1,actual_received_date:void 0,received_at:void 0}:e):e),Number.isNaN(Ie)||C?.(Ie,e=>{const t=n(e.items)||e.items||[],a=t.length||e.items?.length||0,r=t.filter(e=>e.is_received).length,i=a>0&&r===a;return{...e,items:t,is_received:i,received_at:i?e.received_at||s:void 0}})},[C,Ie]),We=t.useCallback(({itemId:e,selectedDate:t,action:a})=>{const s=String(e),n=t?t.toISOString():void 0;let l=!1,d=null;if(Z(e=>{if(!e)return e;const t=(e.items||[]).map(e=>String(e.id)!==s?e:"confirm"===a?{...e,is_statement_received:!0,statement_received_date:n,statement_received_by_name:oe}:{...e,is_statement_received:!1,statement_received_date:null,statement_received_by_name:null});return l=t.length>0&&t.every(e=>e.is_statement_received),d=l?n||e.statement_received_at||(new Date).toISOString():null,{...e,items:t,is_statement_received:l,statement_received_at:d}}),re(e=>{if(!e)return e;const t=(e.items||[]).map(e=>String(e.id)!==s?e:"confirm"===a?{...e,is_statement_received:!0,statement_received_date:n,statement_received_by_name:oe}:{...e,is_statement_received:!1,statement_received_date:null,statement_received_by_name:null});return{...e,items:t,is_statement_received:l,statement_received_at:d}}),ie(e=>e?e.map(e=>String(e.id)!==s?e:"confirm"===a?{...e,is_statement_received:!0,statement_received_date:n,statement_received_by_name:oe}:{...e,is_statement_received:!1,statement_received_date:null,statement_received_by_name:null}):e),Number.isNaN(Ie)||C?.(Ie,e=>{const t=(e.items||[]).map(e=>String(e.id)!==s?e:"confirm"===a?{...e,is_statement_received:!0,statement_received_date:n,statement_received_by_name:oe}:{...e,is_statement_received:!1,statement_received_date:null,statement_received_by_name:null}),r=t.length>0&&t.every(e=>e.is_statement_received);return{...e,items:t,is_statement_received:r}}),Y&&void 0!==l){i().from("purchase_requests").update({is_statement_received:l,statement_received_at:d}).eq("id",Y.id).then(({error:e})=>{e&&r.error("ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸ purchase_requests ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",e)})}},[oe,C,Ie,Y]),Oe=E({config:{field:"statement_received",confirmMessage:{confirm:"ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸ì„ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",cancel:"ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"},successMessage:{confirm:"ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",cancel:"ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."},completedText:"âœ“ ì™„ë£Œ",waitingText:"ëŒ€ê¸°"},currentUserName:oe,canPerformAction:Se,purchaseId:Y?.id,onUpdate:ke,onOptimisticUpdate:We}),Te=E({config:{field:"actual_received",confirmMessage:{confirm:"ì‹¤ì œ ìž…ê³  ì²˜ë¦¬ë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",cancel:"ì‹¤ì œ ìž…ê³  ì²˜ë¦¬ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"},successMessage:{confirm:"ì‹¤ì œ ìž…ê³  ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",cancel:"ì‹¤ì œ ìž…ê³  ì²˜ë¦¬ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."},completedText:"ìž…ê³ ì™„ë£Œ",waitingText:"ìž…ê³ ëŒ€ê¸°"},currentUserName:oe,canPerformAction:Se,purchaseId:Y?.id,onUpdate:ke,onOptimisticUpdate:$e}),Me=fe.includes("middle_manager")||fe.includes("app_admin")||fe.includes("ceo"),Pe=fe.includes("final_approver")||fe.includes("app_admin")||fe.includes("ceo"),Fe="inline-flex items-center gap-1 business-radius-badge !h-auto !min-h-0 !px-2.5 !py-0.5 badge-text leading-tight",Le="inline-flex items-center gap-1 business-radius-badge px-2.5 py-0.5 badge-text leading-tight";t.useEffect(()=>{if(e&&d){const t=m(e);if(t){const e={...t,id:String(t.id),is_po_generated:!1,vendor:{id:t.vendor_id,vendor_name:t.vendor_name||"ì•Œ ìˆ˜ ì—†ìŒ",is_active:!0},vendor_contacts:[]};Z(e),re(e),ie(t.items||[])}else He(e.toString());te(!1)}},[e,d]);const Ue=t.useCallback(()=>{const e=Y?.items&&Y.items.length>0?Y.items:Y?.purchase_request_items&&Y.purchase_request_items.length>0?Y.purchase_request_items:[];if(0===e.length)return[];const t=[{key:"item_name",minWidth:80,maxWidth:500,baseWidth:80},{key:"specification",minWidth:200,maxWidth:200,baseWidth:200,isFixed:!0},{key:"quantity",minWidth:70,maxWidth:100,baseWidth:70},{key:"unit_price",minWidth:90,maxWidth:150,baseWidth:90},{key:"total_price",minWidth:100,maxWidth:180,baseWidth:100},{key:"remarks",minWidth:150,maxWidth:150,baseWidth:150,isFixed:!0},{key:"status",minWidth:80,maxWidth:120,baseWidth:80}];"receipt"===S&&t.push({key:"actual_receipt_date",minWidth:100,maxWidth:160,baseWidth:100,isFixed:!1}),"done"===S&&t.push({key:"transaction_confirm",minWidth:100,maxWidth:160,baseWidth:100,isFixed:!1},{key:"accounting_date",minWidth:80,maxWidth:80,baseWidth:80,isFixed:!0},{key:"expenditure_info",minWidth:100,maxWidth:200,baseWidth:100,isFixed:!1});const a=t.map((t,a)=>{let r=4;const s=(()=>{const e="pending"===S?["í’ˆëª©ëª…","ê·œê²©","ìˆ˜ëŸ‰","ë‹¨ê°€","í•©ê³„","ë¹„ê³ "]:["í’ˆëª©ëª…","ê·œê²©","ìˆ˜ëŸ‰","ë‹¨ê°€","í•©ê³„","ë¹„ê³ ","purchase"===S?"êµ¬ë§¤ìƒíƒœ":"receipt"===S||"done"===S?"ìž…ê³ ìƒíƒœ":"ìƒíƒœ"];return"receipt"===S?[...e,"ì‹¤ì œìž…ê³ ì¼"]:"done"===S?[...e,"ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸","íšŒê³„ìƒ ìž…ê³ ì¼","ì§€ì¶œì •ë³´"]:e})();if(s[a]&&(r=Math.max(r,s[a].length)),e.forEach(e=>{let a="";switch(t.key){case"item_name":a=e.item_name||"";break;case"specification":a=e.specification||"";break;case"quantity":a=e.quantity?.toString()||"";break;case"unit_price":a=null!=e.unit_price_value?e.unit_price_value.toLocaleString():"";break;case"total_price":a=null!=e.amount_value?e.amount_value.toLocaleString():null!=e.quantity&&null!=e.unit_price_value?(Number(e.quantity)*Number(e.unit_price_value)).toLocaleString():"";break;case"remarks":a=e.remark||"";break;case"status":a=ze(e)||"";break;case"actual_receipt_date":a=e.actual_received_date?b(e.actual_received_date):"";break;case"transaction_confirm":a=e.is_statement_received?"í™•ì¸ì™„ë£Œ":"ë¯¸í™•ì¸";break;case"accounting_date":a=e.statement_received_date?b(e.statement_received_date):"";break;case"expenditure_info":a=e.expenditure_date&&null!==e.expenditure_amount&&void 0!==e.expenditure_amount?"2025. 11. 25.":"ì§€ì¶œìž…ë ¥"}const s=a.split("").reduce((e,t)=>e+(/[ê°€-íž£]/.test(t)?1.5:1),0);r=Math.max(r,Math.ceil(s))}),t.isFixed)return t.baseWidth;let i=Math.max(t.minWidth,Math.min(t.maxWidth,7*r+20));return"expenditure_info"===t.key&&(i=110),i});return pe(a),a},[Y,S]),ze=e=>"purchase"===S?e.is_payment_completed?"êµ¬ë§¤ì™„ë£Œ":"êµ¬ë§¤ìš”ì²­":"receipt"===S?e.is_received?"ìž…ê³ ":"ìž…ê³ ëŒ€ê¸°":e.is_payment_completed?"êµ¬ë§¤ì™„ë£Œ":"êµ¬ë§¤ìš”ì²­",Ke=()=>{if(ue.length>0){return ue.map(e=>`${e}px`).join(" ")}let e=["minmax(80px, 1fr)","200px","70px","90px","100px","150px"];return e.push("80px"),"receipt"===S?[...e,"100px"].join(" "):"done"===S?[...e,"100px","80px","110px"].join(" "):e.join(" ")};t.useEffect(()=>{const e=Y?.items&&Y.items.length>0||Y?.purchase_request_items&&Y.purchase_request_items.length>0;Y&&e&&!ee&&requestAnimationFrame(()=>{Ue()})},[Y,ee,S,Ue]);const Be=e=>{e&&!ee&&(re(Y),ie(xe||[]),le([]),Ue()),te(e)},He=async e=>{try{const t=m(e);if(t){const e={...t,id:String(t.id),is_po_generated:!1,vendor:{id:t.vendor_id,vendor_name:t.vendor_name||"ì•Œ ìˆ˜ ì—†ìŒ",is_active:!0},vendor_contacts:[]};return Z(e),re(e),void ie(t.items||[])}X(!0);const a=i(),{data:r,error:s}=await a.from("purchase_requests").select("\n          *,\n          vendors(id, vendor_name),\n          purchase_request_items(*)\n        ").eq("id",e).single();if(s)throw s;if(r){const e=(r.purchase_request_items||[]).sort((e,t)=>(e.line_number||999999)-(t.line_number||999999)),t={...r,items:e,vendor:r.vendors||{id:0,vendor_name:"ì•Œ ìˆ˜ ì—†ìŒ"},vendor_contacts:[]};Z(t),re(t),ie(e)}}catch(t){r.error("[PurchaseDetailModal] ë°œì£¼ ìƒì„¸ ë¡œë“œ ì‹¤íŒ¨:",t),T.error("ë°œì£¼ ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}finally{X(!1)}},Ae=e=>new Intl.NumberFormat("ko-KR").format(e),Re=(e,t,a)=>{const r=[...se];if("quantity"===t||"unit_price_value"===t){const s="quantity"===t?a:r[e].quantity,i="unit_price_value"===t?a:r[e].unit_price_value;r[e]={...r[e],[t]:a,amount_value:(s||0)*(i||0)}}else r[e]={...r[e],[t]:a};ie(r)},Ee=e=>{const t=se[e];t.id&&le([...ne,t.id]);const a=se.filter((t,a)=>a!==e).sort((e,t)=>(e.line_number||999999)-(t.line_number||999999));ie(a)},Ve=async(e,t)=>{if(!we)return r.warn("[handlePaymentToggle] ê¶Œí•œ ì—†ìŒ",{canPurchase:we,currentUserRoles:j}),void T.error("êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");const a=String(e),s="number"==typeof e?e:Number(e);if(Number.isNaN(s))return r.error("[handlePaymentToggle] ìž˜ëª»ëœ ID",{itemId:e,numericId:s}),void T.error("ìœ íš¨í•˜ì§€ ì•Šì€ í•­ëª© ID ìž…ë‹ˆë‹¤.");if(!Y)return;const i=Y.items&&Y.items.length>0?Y.items:[],n=Y.purchase_request_items&&Y.purchase_request_items.length>0?Y.purchase_request_items:[],l=(i.length>0?i:n).find(e=>String(e.id)===a);if(!l)return;const d=`í’ˆëª…: ${l.item_name}\nê·œê²©: ${l.specification||"ë¯¸ìž…ë ¥"}\nìˆ˜ëŸ‰: ${l.quantity?.toLocaleString()||0}${l.unit||""}\në‹¨ê°€: â‚©${l.unit_price_value?.toLocaleString()||0}\ní•©ê³„: â‚©${l.amount_value?.toLocaleString()||0}`,c=t?`ë‹¤ìŒ í’ˆëª©ì„ êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${d}`:`ë‹¤ìŒ í’ˆëª©ì˜ êµ¬ë§¤ì™„ë£Œë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${d}`;if(window.confirm(c))try{const{error:e}=await ve.from("purchase_request_items").update({is_payment_completed:t,payment_completed_at:t?(new Date).toISOString():null}).eq("id",s);if(e)throw e;if(Y){(t?x(Y.id,s):v(Y.id,s))||r.warn("[PurchaseDetailModal] ë©”ëª¨ë¦¬ ìºì‹œ í’ˆëª© ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{purchaseId:Y.id,itemId:s,isCompleted:t})}if(Z(e=>{if(!e)return null;const r=e.items&&e.items.length>0?e.items:[],s=e.purchase_request_items&&e.purchase_request_items.length>0?e.purchase_request_items:[],i=(r.length>0?r:s).map(e=>String(e.id)===a?{...e,is_payment_completed:t,payment_completed_at:t?(new Date).toISOString():null}:e);return{...e,items:e.items?i:e.items,purchase_request_items:e.purchase_request_items?i:e.purchase_request_items}}),Y){const e=Number(Y.id);Number.isNaN(e)||C?.(e,e=>{const r=(e.items||[]).map(e=>String(e.id)===a?{...e,is_payment_completed:t}:e),s=r.length||e.items?.length||0,i=r.filter(e=>e.is_payment_completed).length,n=s>0&&i===s;return{...e,items:r,is_payment_completed:n,payment_completed_at:n?(new Date).toISOString():null,payment_completed_by_name:n&&oe||e.payment_completed_by_name}})}T.success(t?"êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.":"êµ¬ë§¤ì™„ë£Œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."),await ke();const i=k?.(!0,{silent:!0});i instanceof Promise&&await i}catch(o){T.error("êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},Je=async e=>{if(!Y)return;const t="middle"===e?"1ì°¨ ìŠ¹ì¸":"ìµœì¢… ìŠ¹ì¸",a=`ë°œì£¼ë²ˆí˜¸: ${Y.purchase_order_number}\n\n${t}ì„ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;if(window.confirm(a))try{const t="middle"===e?{middle_manager_status:"approved"}:{final_manager_status:"approved"},{error:a}=await ve.from("purchase_requests").update(t).eq("id",Y.id);if(a)throw a;if(Z("middle"===e?e=>e?{...e,middle_manager_status:"approved"}:null:e=>e?{...e,final_manager_status:"approved"}:null),Y&&C){const t=Number(Y.id);Number.isNaN(t)||C(t,t=>"middle"===e?{...t,middle_manager_status:"approved"}:{...t,final_manager_status:"approved"})}T.success(("middle"===e?"ì¤‘ê°„":"ìµœì¢…")+" ìŠ¹ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."),await ke();const r=k?.(!0,{silent:!0});r instanceof Promise&&await r}catch(r){T.error("ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},Ge=async(e,t,a)=>{if(!Y||!Se)return void T.error("ì§€ì¶œ ì •ë³´ ìž…ë ¥ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");const s=String(e),i="number"==typeof e?e:Number(e);if(Number.isNaN(i))return void r.error("ìœ íš¨í•˜ì§€ ì•Šì€ itemId",{itemId:e});const n=Y.items?.find(e=>String(e.id)===s);if(!n)return;const l=Y?Number(Y.id):NaN;try{Number.isNaN(l)||C?.(l,e=>{const r=(e.items||[]).map(e=>String(e.id)===s?{...e,expenditure_date:t.toISOString(),expenditure_amount:a}:e);return{...e,items:r}}),Z(e=>{if(!e)return null;const r=(e.items||e.purchase_request_items||[]).map(e=>String(e.id)===s?{...e,expenditure_date:t.toISOString(),expenditure_amount:a}:e),i=r.reduce((e,t)=>e+(t.expenditure_amount||0),0);return{...e,items:r,purchase_request_items:r,total_expenditure_amount:i,updated_at:(new Date).toISOString()}});const{error:e}=await ve.from("purchase_request_items").update({expenditure_date:t.toISOString(),expenditure_amount:a}).eq("id",i);if(e)throw r.error("ì§€ì¶œ ì •ë³´ DB ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{error:e,itemId:i}),e;const d=(Y.items||Y.purchase_request_items||[]).reduce((e,t)=>String(t.id)===s?e+a:e+(t.expenditure_amount||0),0);if(await ve.from("purchase_requests").update({total_expenditure_amount:d}).eq("id",l),Y?.id){g(Y.id,i,t.toISOString(),a)||r.warn("[PurchaseDetailModal] ë©”ëª¨ë¦¬ ìºì‹œ ì§€ì¶œ ì •ë³´ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{purchaseId:Y.id,itemId:i})}T.success(`"${n.item_name}" í’ˆëª©ì˜ ì§€ì¶œ ì •ë³´ê°€ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.`),await ke();const c=k?.(!0,{silent:!0});c instanceof Promise&&await c}catch(d){r.error("ì§€ì¶œ ì •ë³´ ìž…ë ¥ ì¤‘ ì˜¤ë¥˜",d),T.error("ì§€ì¶œ ì •ë³´ ìž…ë ¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},Qe=a.jsx("div",{className:"space-y-1 sm:space-y-4",children:Q?a.jsx("div",{className:"flex items-center justify-center py-12",children:a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-hansl-600"})}):Y?a.jsxs("div",{children:[a.jsx("div",{className:"bg-gray-50 rounded-lg p-2 sm:p-3 mb-1 sm:mb-2 border border-gray-100",children:a.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 items-center gap-3 sm:gap-0",children:[a.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-4",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[(()=>{if(!Y)return null;if(Y.payment_category){const e=Y.payment_category.trim();return"ë°œì£¼"===e?a.jsx("span",{className:"badge-stats bg-green-500 text-white",children:"ë°œì£¼"}):"êµ¬ë§¤ìš”ì²­"===e?a.jsx("span",{className:"badge-stats bg-blue-500 text-white",children:"êµ¬ë§¤ìš”ì²­"}):"í˜„ìž¥ê²°ì œ"===e?a.jsx("span",{className:"badge-stats bg-gray-500 text-white",children:"í˜„ìž¥ê²°ì œ"}):a.jsx("span",{className:"badge-stats bg-blue-500 text-white",children:e})}return a.jsx("span",{className:"badge-stats bg-blue-500 text-white",children:"êµ¬ë§¤ìš”ì²­"})})(),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"modal-label",children:"ìš”ì²­ìž:"}),a.jsx("span",{className:"modal-value",children:Y.requester_name})]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(M,{className:"w-3 h-3 text-gray-500"}),a.jsxs("span",{className:"modal-subtitle",children:["ì²­êµ¬ì¼: ",b(Y.request_date)]})]})]}),a.jsxs("div",{className:"flex items-center justify-center gap-2 sm:gap-3 flex-wrap",children:[Me&&"pending"===Y.middle_manager_status&&a.jsx(s,{size:"sm",variant:"outline",onClick:()=>Je("middle"),className:`${Fe} border border-gray-400 bg-white hover:bg-gray-50 hover:border-gray-500`,children:"1ì°¨ ìŠ¹ì¸ ëŒ€ê¸°"}),"approved"===Y.middle_manager_status&&a.jsxs("div",{className:"button-approved badge-text shadow-sm",children:[a.jsx(P,{className:"w-3 h-3"}),"1ì°¨ ìŠ¹ì¸ì™„ë£Œ"]}),"rejected"===Y.middle_manager_status&&a.jsxs("div",{className:"button-rejected badge-text",children:[a.jsx(u,{className:"w-3 h-3"}),"1ì°¨ ë°˜ë ¤"]}),"pending"===Y.middle_manager_status&&!Me&&a.jsx("div",{className:`${Le} border border-gray-300 text-gray-600 bg-white`,children:"1ì°¨ ìŠ¹ì¸ëŒ€ê¸°"}),Pe&&"approved"===Y.middle_manager_status&&"pending"===Y.final_manager_status&&a.jsxs(s,{size:"sm",variant:"outline",onClick:()=>Je("final"),className:`${Fe} border border-gray-400 bg-white hover:bg-gray-50 hover:border-gray-500`,children:[a.jsx(P,{className:"w-3 h-3"}),"ìµœì¢… ìŠ¹ì¸"]}),"approved"===Y.final_manager_status&&a.jsxs("div",{className:"button-approved badge-text",children:[a.jsx(P,{className:"w-3 h-3"}),"ìµœì¢… ìŠ¹ì¸ì™„ë£Œ"]}),"rejected"===Y.final_manager_status&&a.jsxs("div",{className:"button-rejected badge-text",children:[a.jsx(u,{className:"w-3 h-3"}),"ìµœì¢… ë°˜ë ¤"]}),"approved"!==Y.middle_manager_status&&"pending"===Y.final_manager_status&&a.jsx("div",{className:`${Le} border border-gray-300 text-gray-600 bg-white`,children:"ìµœì¢… ìŠ¹ì¸ëŒ€ê¸°"})]}),a.jsx("div",{})]})}),a.jsxs("div",{className:"flex flex-col lg:flex-row gap-3 sm:gap-6",children:[a.jsxs("div",{className:"lg:w-80 lg:flex-shrink-0 space-y-1 sm:space-y-4 relative",children:[a.jsxs("div",{className:"bg-white rounded-lg p-2 sm:p-3 border border-gray-100 shadow-sm",children:[a.jsx("div",{className:"mb-3",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("h3",{className:"modal-section-title flex items-center",children:[a.jsx(p,{className:"w-4 h-4 mr-2 text-gray-600"}),Y?.purchase_order_number||"POë²ˆí˜¸ ì—†ìŒ"]}),Se&&"done"===S&&a.jsxs("button",{onClick:async()=>{if(!Y)return;const e=!(Y.is_utk_checked||!1),t=e?`ë°œì£¼ë²ˆí˜¸: ${Y.purchase_order_number}\n\nUTK í™•ì¸ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`:`ë°œì£¼ë²ˆí˜¸: ${Y.purchase_order_number}\n\nUTK í™•ì¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;if(window.confirm(t))try{const t=i(),{error:a}=await t.from("purchase_requests").update({is_utk_checked:e}).eq("id",Y.id);if(a)return r.error("UTK í™•ì¸ DB ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{error:a,purchaseId:Y.id}),void T.error("UTK í™•ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");Z(t=>t?{...t,is_utk_checked:e,updated_at:(new Date).toISOString()}:null),Y.id&&h(Y.id,t=>({...t,is_utk_checked:e})),T.success(e?"UTK í™•ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.":"UTK í™•ì¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."),await ke();const s=k?.(!0,{silent:!0});s instanceof Promise&&await s}catch(a){r.error("UTK í™•ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜",a),T.error("UTK í™•ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},className:"button-base text-xs px-2 py-1 flex items-center "+(Y?.is_utk_checked?"button-toggle-active bg-orange-500 hover:bg-orange-600 text-white":"button-toggle-inactive"),title:Y?.is_utk_checked?"UTK í™•ì¸ ì·¨ì†Œ":"UTK í™•ì¸",children:[a.jsx(N,{className:"w-3 h-3 mr-1"}),"UTK ",Y?.is_utk_checked?"ì™„ë£Œ":"í™•ì¸"]})]})}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"ë°œì£¼ì„œ ì¢…ë¥˜"}),ee?a.jsx(D,{value:ae?.request_type||"",onChange:e=>re(t=>t?{...t,request_type:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"ì¼ë°˜"}):a.jsx("p",{className:"modal-value",children:Y.request_type||"ì¼ë°˜"})]}),a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"ê²°ì œ ì¢…ë¥˜"}),ee?a.jsx(D,{value:ae?.payment_category||"",onChange:e=>re(t=>t?{...t,payment_category:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"ë°œì£¼/êµ¬ë§¤ìš”ì²­/í˜„ìž¥ê²°ì œ"}):a.jsx("p",{className:"modal-value",children:Y.payment_category||"-"})]})]}),a.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"ìž…ê³  ìš”ì²­ì¼"}),ee?a.jsx(A,{onDateSelect:e=>{re(t=>t?{...t,delivery_request_date:w(e,"yyyy-MM-dd")}:null)},placeholder:"ìž…ê³  ìš”ì²­ì¼ì„ ì„ íƒí•˜ì„¸ìš”",align:"start",side:"bottom",children:a.jsxs(s,{variant:"outline",className:"mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] justify-start text-left font-normal business-radius-input",children:[a.jsx(M,{className:"mr-1 h-3 w-3"}),ae?.delivery_request_date?b(ae.delivery_request_date):"ë‚ ì§œ ì„ íƒ"]})}):a.jsx("p",{className:"modal-subtitle",children:b(Y.delivery_request_date)})]}),a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label text-orange-500",children:"ë³€ê²½ ìž…ê³ ì¼"}),ee?a.jsx(A,{onDateSelect:e=>{re(t=>t?{...t,revised_delivery_request_date:w(e,"yyyy-MM-dd")}:null)},placeholder:"ë³€ê²½ ìž…ê³ ì¼ì„ ì„ íƒí•˜ì„¸ìš”",align:"start",side:"bottom",children:a.jsxs(s,{variant:"outline",className:"mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] justify-start text-left font-normal business-radius-input",children:[a.jsx(M,{className:"mr-1 h-3 w-3"}),ae?.revised_delivery_request_date?b(ae.revised_delivery_request_date):"ë‚ ì§œ ì„ íƒ"]})}):a.jsx("p",{className:"modal-subtitle text-orange-700",children:Y.revised_delivery_request_date?b(Y.revised_delivery_request_date):"ë¯¸ì„¤ì •"})]})]})]})]}),a.jsxs("div",{className:"bg-white rounded-lg p-2 sm:p-3 border border-gray-100 shadow-sm",children:[a.jsxs("h3",{className:"modal-section-title mb-3 flex items-center",children:[a.jsx(_,{className:"w-4 h-4 mr-2 text-gray-600"}),"ì—…ì²´ ì •ë³´"]}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"ì—…ì²´ëª…"}),ee?a.jsx(D,{value:ae?.vendor?.vendor_name||ae?.vendor_name||"",onChange:e=>re(t=>t?{...t,vendor_name:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"ì—…ì²´ ì„ íƒ"}):a.jsx("p",{className:"modal-value",children:Y.vendor?.vendor_name||"-"})]}),a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"ì—…ì²´ ë‹´ë‹¹ìž"}),ee?a.jsx(D,{value:ae?.vendor_contacts?.[0]?.contact_name||"",onChange:e=>{re(t=>{if(!t)return null;const a=[...t.vendor_contacts||[]];return a[0]?a[0]={...a[0],contact_name:e.target.value}:a[0]={contact_name:e.target.value},{...t,vendor_contacts:a}})},className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"ë‹´ë‹¹ìž ì„ íƒ"}):a.jsx("p",{className:"modal-value",children:Y.vendor_contacts?.[0]?.contact_name||"-"})]})]}),a.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"PJì—…ì²´"}),ee?a.jsx(D,{value:ae?.project_vendor||"",onChange:e=>re(t=>t?{...t,project_vendor:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"ìž…ë ¥"}):a.jsx("p",{className:"modal-value",children:Y.project_vendor||"-"})]}),a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"Item"}),ee?a.jsx(D,{value:ae?.project_item||"",onChange:e=>re(t=>t?{...t,project_item:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"ìž…ë ¥"}):a.jsx("p",{className:"modal-subtitle",children:Y.project_item||"-"})]})]}),a.jsx("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"ìˆ˜ì£¼ë²ˆí˜¸"}),ee?a.jsx(D,{value:ae?.order_number||"",onChange:e=>re(t=>t?{...t,order_number:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"ìž…ë ¥"}):a.jsx("p",{className:"modal-subtitle",children:Y.order_number||"-"})]})})]})]})]}),a.jsx("div",{className:"lg:w-fit lg:min-w-0 relative overflow-visible",children:a.jsxs("div",{className:"bg-white rounded-lg border border-gray-100 shadow-sm",children:[a.jsxs("div",{className:"p-2 sm:p-3 bg-gray-50 border-b border-gray-100 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-0",children:[a.jsxs("h3",{className:"modal-section-title flex items-center",children:[a.jsx(F,{className:"w-4 h-4 mr-2 text-gray-600"}),"í’ˆëª© ë¦¬ìŠ¤íŠ¸",a.jsxs("span",{className:"ml-2 badge-stats bg-gray-500 text-white",children:[xe?.length||0,"ê°œ"]})]}),!ee&&a.jsxs(a.Fragment,{children:["purchase"===S&&we&&a.jsxs(s,{size:"sm",onClick:async()=>{if(!Y||!we)return;const e=`ë°œì£¼ë²ˆí˜¸: ${Y.purchase_order_number}\n\nì „ì²´ êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;if(window.confirm(e)){Y&&Number(Y.id);try{const e=Y.purchase_request_items||[],t=e.filter(e=>!e.is_payment_completed);if(0===t.length)return void T.info("ëª¨ë“  í’ˆëª©ì´ ì´ë¯¸ êµ¬ë§¤ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");r.info(`ì „ì²´ êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬: ${t.length}ê°œ í’ˆëª© (ì´ ${e.length}ê°œ ì¤‘)`);for(const s of t){const e={is_payment_completed:!0,payment_completed_at:(new Date).toISOString()},{error:t}=await ve.from("purchase_request_items").update(e).eq("id",s.id);if(t)throw t;x(Y.id,s.id)||r.warn("[PurchaseDetailModal] ë©”ëª¨ë¦¬ ìºì‹œ ê°œë³„ í’ˆëª© êµ¬ë§¤ì™„ë£Œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{purchaseId:Y.id,itemId:s.id})}T.success(`${t.length}ê°œ í’ˆëª©ì´ êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`),await ke();const a=k?.(!0,{silent:!0});a instanceof Promise&&await a}catch(t){r.error("ì „ì²´ êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ ì˜¤ë¥˜",t),T.error("êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}}},className:"button-base bg-orange-500 hover:bg-orange-600 text-white",children:[a.jsx(L,{className:"w-3 h-3 mr-1"}),"ì „ì²´ êµ¬ë§¤ì™„ë£Œ"]}),"receipt"===S&&qe&&a.jsx(A,{onDateSelect:async e=>{if(!Y||!qe)return;const t=`ë°œì£¼ë²ˆí˜¸: ${Y.purchase_order_number}\n\nì „ì²´ ìž…ê³ ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;if(window.confirm(t)){Y&&Number(Y.id);try{const t=Y.purchase_request_items||[],a=t.filter(e=>!e.is_received);if(0===a.length)return void T.info("ëª¨ë“  í’ˆëª©ì´ ì´ë¯¸ ìž…ê³ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");r.info(`ì „ì²´ ìž…ê³ ì™„ë£Œ ì²˜ë¦¬: ${a.length}ê°œ í’ˆëª© (ì´ ${t.length}ê°œ ì¤‘)`);for(const i of a){const t={actual_received_date:e.toISOString(),is_received:!0},{error:a}=await ve.from("purchase_request_items").update(t).eq("id",i.id);if(a)throw a;n(Y.id,i.id,e.toISOString())||r.warn("[PurchaseDetailModal] ë©”ëª¨ë¦¬ ìºì‹œ ê°œë³„ í’ˆëª© ìž…ê³ ì™„ë£Œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{purchaseId:Y.id,itemId:i.id})}T.success(`${a.length}ê°œ í’ˆëª©ì´ ìž…ê³ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`),await ke();const s=k?.(!0,{silent:!0});s instanceof Promise&&await s}catch(a){r.error("ì „ì²´ ìž…ê³ ì™„ë£Œ ì²˜ë¦¬ ì˜¤ë¥˜",a),T.error("ìž…ê³ ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}}},placeholder:"ì „ì²´ ìž…ê³ ì™„ë£Œ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”",align:"end",side:"bottom",children:a.jsxs(s,{size:"sm",className:"button-base button-action-primary",children:[a.jsx(H,{className:"w-3 h-3 mr-1"}),"ì „ì²´ ìž…ê³ ì™„ë£Œ"]})}),"done"===S&&Se&&a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(A,{onDateSelect:async e=>{if(!Y||!Se)return;e.toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"});const t=`ë°œì£¼ë²ˆí˜¸: ${Y.purchase_order_number}\n\nì „ì²´ ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;if(!window.confirm(t))return;const a=e.toISOString();Y&&Number(Y.id);try{const e=Y.purchase_request_items||[],t=e.filter(e=>!e.is_statement_received);if(0===t.length)return void T.info("ëª¨ë“  í’ˆëª©ì˜ ê±°ëž˜ëª…ì„¸ì„œê°€ ì´ë¯¸ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.");r.info(`ì „ì²´ ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸ ì²˜ë¦¬: ${t.length}ê°œ í’ˆëª© (ì´ ${e.length}ê°œ ì¤‘)`);for(const i of t){const e={is_statement_received:!0,statement_received_date:a,statement_received_by_name:oe||null},{error:t}=await ve.from("purchase_request_items").update(e).eq("id",i.id);if(t)throw t;l(Y.id,i.id,a,oe||void 0)||r.warn("[PurchaseDetailModal] ë©”ëª¨ë¦¬ ìºì‹œ ê°œë³„ í’ˆëª© ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{purchaseId:Y.id,itemId:i.id})}T.success(`${t.length}ê°œ í’ˆëª©ì˜ ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`),await ke();const s=k?.(!0,{silent:!0});s instanceof Promise&&await s}catch(s){r.error("ì „ì²´ ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸ ì²˜ë¦¬ ì˜¤ë¥˜",s),T.error("ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},placeholder:"ì „ì²´ íšŒê³„ìƒ ìž…ê³ ì¼ì„ ì„ íƒí•˜ì„¸ìš”",align:"end",side:"bottom",children:a.jsxs(s,{size:"sm",className:"button-base button-action-primary",children:[a.jsx(p,{className:"w-3 h-3 mr-1"}),"ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸"]})}),a.jsx(R,{onConfirm:async(e,t)=>{if(!Y||!Se)return void T.error("ì§€ì¶œ ì •ë³´ ìž…ë ¥ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");const a=`ë°œì£¼ë²ˆí˜¸: ${Y.purchase_order_number}\n\nì¼ê´„ ì§€ì¶œ ì •ë³´ë¥¼ ìž…ë ¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në‚ ì§œ: ${e.toLocaleDateString("ko-KR")}\nê¸ˆì•¡: ${t.toLocaleString()}ì›`;if(!window.confirm(a))return;const s=Y?Number(Y.id):NaN;try{Number.isNaN(s)||C?.(s,a=>{const r=(a.items||[]).map(a=>a.expenditure_date&&a.expenditure_amount?a:{...a,expenditure_date:e.toISOString(),expenditure_amount:t});return{...a,items:r}});const a=Y.items||Y.purchase_request_items||[],i=a.filter(e=>!e.expenditure_date||!e.expenditure_amount);if(0===i.length)return void T.info("ëª¨ë“  í’ˆëª©ì— ì´ë¯¸ ì§€ì¶œ ì •ë³´ê°€ ìž…ë ¥ë˜ì–´ ìžˆìŠµë‹ˆë‹¤.");Z(a=>{if(!a)return null;const r=(a.items||a.purchase_request_items||[]).map(a=>a.expenditure_date&&a.expenditure_amount?a:{...a,expenditure_date:e.toISOString(),expenditure_amount:t}),s=r.reduce((e,t)=>e+(t.expenditure_amount||0),0);return{...a,items:r,purchase_request_items:r,total_expenditure_amount:s,updated_at:(new Date).toISOString()}});for(const s of i){const{error:a}=await ve.from("purchase_request_items").update({expenditure_date:e.toISOString(),expenditure_amount:t}).eq("id",s.id);if(a)throw r.error("ì¼ê´„ ì§€ì¶œ ì •ë³´ DB ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{error:a,itemId:s.id}),a}const n=a.reduce((e,a)=>i.find(e=>e.id===a.id)?e+t:e+(a.expenditure_amount||0),0);await ve.from("purchase_requests").update({total_expenditure_amount:n}).eq("id",s);for(const s of i){g(Y.id,s.id,e.toISOString(),t)||r.warn("[PurchaseDetailModal] ë©”ëª¨ë¦¬ ìºì‹œ ì¼ê´„ ì§€ì¶œ ì •ë³´ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{purchaseId:Y.id,itemId:s.id})}const l=m(Y.id);if(l){const e=l.items&&l.items.length>0?l.items:l.purchase_request_items||[],t=e.reduce((e,t)=>e+(t.expenditure_amount||0),0);Z(a=>({...a,items:e,purchase_request_items:e,total_expenditure_amount:t}))}T.success(`${i.length}ê°œ í’ˆëª©ì˜ ì§€ì¶œ ì •ë³´ê°€ ì¼ê´„ ìž…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.`),await ke();const d=k?.(!0,{silent:!0});d instanceof Promise&&await d}catch(i){r.error("ì¼ê´„ ì§€ì¶œ ì •ë³´ ìž…ë ¥ ì¤‘ ì˜¤ë¥˜",i),T.error("ì¼ê´„ ì§€ì¶œ ì •ë³´ ìž…ë ¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},placeholder:"ì¼ê´„ ì§€ì¶œ ë‚ ì§œì™€ ê¸ˆì•¡ì„ ìž…ë ¥í•˜ì„¸ìš”",align:"end",side:"bottom",children:a.jsxs(s,{size:"sm",className:"button-base button-action-primary",children:[a.jsx(B,{className:"w-3 h-3 mr-1"}),"ì¼ê´„ì§€ì¶œ"]})})]})]})]}),a.jsx("div",{className:"block sm:hidden bg-gray-50 px-2 py-1 border-b border-gray-100",children:a.jsx("div",{className:"text-xs font-medium text-gray-600",children:"í’ˆëª© ëª©ë¡ (í„°ì¹˜í•˜ì—¬ ìŠ¤í¬ë¡¤)"})}),a.jsx("div",{className:"max-h-[50vh] sm:max-h-[40vh] overflow-auto",children:a.jsxs("div",{className:"w-fit",children:[a.jsx("div",{className:"bg-gray-50 px-2 sm:px-3 py-1 border-b border-gray-100 sticky top-0 z-10 w-fit",children:a.jsxs("div",{ref:ge,className:"hidden sm:grid gap-2 modal-label w-fit",style:{gridTemplateColumns:Ke()},children:[a.jsx("div",{children:"í’ˆëª©ëª…"}),a.jsx("div",{children:"ê·œê²©"}),a.jsx("div",{className:"text-center",children:"ìˆ˜ëŸ‰"}),a.jsx("div",{className:"text-right",children:"ë‹¨ê°€"}),a.jsx("div",{className:"text-right",children:"í•©ê³„"}),a.jsx("div",{className:"text-center",children:"ë¹„ê³ "}),ee?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"text-center",children:"ì‚­ì œ"}),"receipt"===S&&a.jsx(a.Fragment,{children:a.jsx("div",{className:"text-center",children:"ì‹¤ì œìž…ê³ ì¼"})}),"done"===S&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"text-center",children:"ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸"}),a.jsx("div",{className:"text-center",children:"íšŒê³„ìƒ ìž…ê³ ì¼"}),a.jsx("div",{className:"text-center",children:"ì§€ì¶œì •ë³´"})]})]}):a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"text-center",children:"purchase"===S?"êµ¬ë§¤ìƒíƒœ":"receipt"===S||"done"===S?"ìž…ê³ ìƒíƒœ":"ìƒíƒœ"}),"done"===S&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"text-center",children:"ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸"}),a.jsx("div",{className:"text-center",children:"íšŒê³„ìƒ ìž…ê³ ì¼"}),a.jsx("div",{className:"text-center",children:"ì§€ì¶œì •ë³´"})]}),"receipt"===S&&a.jsx(a.Fragment,{children:a.jsx("div",{className:"text-center",children:"ì‹¤ì œìž…ê³ ì¼"})})]})]})}),a.jsx("div",{className:"divide-y divide-gray-100 overflow-visible w-fit",children:(ee?se:xe)?.map((e,t)=>a.jsxs("div",{className:"px-2 sm:px-3 py-1 border-b border-gray-50 hover:bg-gray-50/50 relative overflow-visible",children:[a.jsxs("div",{className:"hidden sm:grid items-center gap-2 overflow-visible w-fit",style:{gridTemplateColumns:Ke()},children:[a.jsx("div",{className:"min-w-0 relative overflow-visible flex items-center",children:ee?a.jsx(D,{value:e.item_name,onChange:e=>Re(t,"item_name",e.target.value),onFocus:()=>_e(`item_name_${t}`),onBlur:()=>_e(null),className:"modal-label border-gray-200 rounded-lg w-full !px-1.5 !py-0.5 !text-[10px] focus:border-blue-400 transition-all duration-200 "+(he===`item_name_${t}`?"!h-auto !min-h-[20px] !absolute !z-[9999] !bg-white !shadow-lg !left-0 !right-0 !-translate-y-1/2 !top-1/2 !whitespace-normal":"!h-5 !truncate"),placeholder:"í’ˆëª©ëª…",disabled:ye&&!be}):a.jsx("div",{className:"modal-value",style:{whiteSpace:"normal",wordBreak:"break-all",overflowWrap:"break-word",hyphens:"none",WebkitHyphens:"none",MozHyphens:"none",msHyphens:"none",lineHeight:"1.4",maxHeight:"2.8em",overflow:"hidden",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical"},title:e.item_name||"í’ˆëª©ëª… ì—†ìŒ",children:e.item_name||"í’ˆëª©ëª… ì—†ìŒ"})}),a.jsx("div",{className:"min-w-0 relative overflow-visible flex items-center",style:{width:"200px",maxWidth:"200px",minWidth:"200px"},children:ee?a.jsx(D,{value:e.specification,onChange:e=>Re(t,"specification",e.target.value),onFocus:()=>_e(`specification_${t}`),onBlur:()=>_e(null),className:"modal-label border-gray-200 rounded-lg w-full !px-1.5 !py-0.5 !text-[10px] focus:border-blue-400 transition-all duration-200 "+(he===`specification_${t}`?"!h-auto !min-h-[20px] !absolute !z-[9999] !bg-white !shadow-lg !left-1/2 !-translate-x-1/2 !-translate-y-1/2 !top-1/2 !whitespace-normal !w-[300px]":"!h-5 !truncate"),placeholder:"ê·œê²©",disabled:ye&&!be}):a.jsx("div",{className:"text-[11px] text-gray-600 font-medium",style:{whiteSpace:"normal",wordBreak:"break-all",overflowWrap:"break-word",hyphens:"none",WebkitHyphens:"none",MozHyphens:"none",msHyphens:"none",lineHeight:"1.4",maxHeight:"2.8em",overflow:"hidden",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical"},title:e.specification||"-",children:e.specification||"-"})}),a.jsx("div",{className:"text-center min-w-0 flex items-center justify-center",children:ee?a.jsx(D,{type:"number",value:e.quantity,onChange:e=>Re(t,"quantity",Number(e.target.value)),className:"border-gray-200 rounded-lg text-center w-full !h-5 !px-1.5 !py-0.5 !text-[9px] font-normal text-gray-600 focus:border-blue-400",placeholder:"ìˆ˜ëŸ‰",max:"99999"}):a.jsx("span",{className:"modal-subtitle",children:e.quantity||0})}),a.jsx("div",{className:"text-right min-w-0 flex items-center justify-end",children:ee?a.jsx(D,{type:"number",value:e.unit_price_value,onChange:e=>Re(t,"unit_price_value",Number(e.target.value)),className:"border-gray-200 rounded-lg text-right w-full !h-5 !px-1.5 !py-0.5 !text-[9px] font-normal text-gray-600 focus:border-blue-400",placeholder:"ë‹¨ê°€",max:"100000000000"}):a.jsxs("span",{className:"modal-subtitle",children:["â‚©",Ae(e.unit_price_value)]})}),a.jsx("div",{className:"text-right min-w-0 flex items-center justify-end",children:a.jsxs("span",{className:ee?"modal-subtitle":"modal-value",children:["â‚©",Ae(e.amount_value||0)]})}),a.jsx("div",{className:"min-w-0 flex justify-center items-center text-center relative overflow-visible",style:{width:"150px",maxWidth:"150px",minWidth:"150px"},children:ee?a.jsx(D,{value:e.remark||"",disabled:ye&&!be,onChange:e=>Re(t,"remark",e.target.value),onFocus:()=>_e(`remark_${t}`),onBlur:()=>_e(null),className:"modal-label border-gray-200 rounded-lg text-center w-full !px-1.5 !py-0.5 !text-[10px] focus:border-blue-400 transition-all duration-200 "+(he===`remark_${t}`?"!h-auto !min-h-[20px] !absolute !z-[9999] !bg-white !shadow-lg !left-0 !right-0 !-translate-y-1/2 !top-1/2 !whitespace-normal !text-left":"!h-5 !truncate"),placeholder:"ë¹„ê³ "}):a.jsx("div",{className:"text-[11px] text-gray-600 font-medium",style:{width:"150px",maxWidth:"150px",minWidth:"150px",boxSizing:"border-box",whiteSpace:"normal",wordBreak:"break-all",overflowWrap:"break-word",hyphens:"none",WebkitHyphens:"none",MozHyphens:"none",msHyphens:"none",lineHeight:"1.4",maxHeight:"2.8em",overflow:"hidden",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical"},title:e.remark||"-",children:e.remark||"-"})}),"pending"!==S&&a.jsx("div",{className:"text-center flex justify-center items-center",children:ee?a.jsx(s,{size:"sm",variant:"ghost",onClick:()=>Ee(t),className:"text-red-600 hover:bg-red-50 rounded-lg p-1 h-6 w-6",children:a.jsx(U,{className:"w-3 h-3"})}):a.jsxs(a.Fragment,{children:["purchase"===S&&a.jsx("div",{className:"flex justify-center",children:we?a.jsx("button",{onClick:()=>Ve(e.id,!e.is_payment_completed),className:""+(e.is_payment_completed?"button-toggle-active bg-orange-500 hover:bg-orange-600 text-white":"button-toggle-inactive"),children:e.is_payment_completed?"êµ¬ë§¤ì™„ë£Œ":"êµ¬ë§¤ëŒ€ê¸°"}):a.jsx("span",{className:""+(e.is_payment_completed?"button-toggle-active bg-orange-500 text-white":"button-waiting-inactive"),children:e.is_payment_completed?"êµ¬ë§¤ì™„ë£Œ":"êµ¬ë§¤ëŒ€ê¸°"})}),"receipt"===S&&a.jsx("div",{className:"flex justify-center",children:Se?Te.isCompleted(e)?a.jsx("button",{onClick:()=>{Te.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-action-primary",children:Te.config.completedText}):a.jsx(A,{onDateSelect:t=>{Te.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"ì‹¤ì œ ìž…ê³ ëœ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”",align:"center",side:"bottom",children:a.jsx("button",{className:"button-toggle-inactive",children:Te.config.waitingText})}):a.jsx("span",{className:""+(Te.isCompleted(e)?"button-action-primary":"button-waiting-inactive"),children:Te.isCompleted(e)?Te.config.completedText:Te.config.waitingText})}),"done"===S&&a.jsx("div",{className:"flex justify-center",children:a.jsx("span",{className:"button-base "+(Te.isCompleted(e)?"bg-green-500 hover:bg-green-600 text-white":"border border-gray-300 text-gray-600 bg-white hover:bg-gray-50"),children:Te.isCompleted(e)?"ìž…ê³ ì™„ë£Œ":"ìž…ê³ ëŒ€ê¸°"})}),"purchase"!==S&&"receipt"!==S&&"done"!==S&&a.jsx("div",{className:"flex justify-center",children:a.jsx("span",{className:"badge-text",children:"-"})})]})}),"receipt"===S&&a.jsx("div",{className:"text-center flex justify-center items-center pl-2",children:Te.getCompletedDate(e)?a.jsx("div",{className:"modal-subtitle text-green-700",children:new Date(Te.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})}):a.jsx("span",{className:"modal-subtitle text-gray-400",children:"-"})}),"done"===S&&a.jsx("div",{className:"text-center flex justify-center items-center",children:Se?Oe.isCompleted(e)?a.jsx("button",{onClick:()=>{Oe.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-action-primary hover:bg-green-600",title:"í´ë¦­í•˜ì—¬ ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸ ì·¨ì†Œ",children:Oe.config.completedText}):a.jsx(A,{onDateSelect:t=>{Oe.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"íšŒê³„ìƒ ìž…ê³ ì¼ì„ ì„ íƒí•˜ì„¸ìš”",align:"center",side:"bottom",children:a.jsx("button",{className:"button-toggle-inactive",onClick:()=>{},children:Oe.config.waitingText})}):a.jsx("span",{className:""+(Oe.isCompleted(e)?"button-action-primary":"button-waiting-inactive"),children:Oe.isCompleted(e)?Oe.config.completedText:Oe.config.waitingText})}),"done"===S&&a.jsx("div",{className:"text-center flex justify-center items-center",children:Oe.getCompletedDate(e)?a.jsx("div",{className:"modal-subtitle text-blue-700",children:new Date(Oe.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})}):a.jsx("span",{className:"modal-subtitle text-gray-400",children:"-"})}),"done"===S&&a.jsx("div",{className:"text-center flex justify-center items-center",children:(()=>{const t=e.expenditure_date&&null!==e.expenditure_amount&&void 0!==e.expenditure_amount;return Se?t?a.jsxs("div",{className:"w-full px-1 leading-none",children:[a.jsx("div",{className:"text-blue-700 text-[9px] leading-[1.1] font-normal",children:new Date(e.expenditure_date).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})}),a.jsxs("div",{className:"text-gray-700 text-[9px] leading-[1.1] font-normal",children:["â‚©",Number(e.expenditure_amount).toLocaleString()]})]}):a.jsx(R,{onConfirm:(t,a)=>Ge(e.id,t,a),placeholder:"ì§€ì¶œ ë‚ ì§œì™€ ê¸ˆì•¡ì„ ìž…ë ¥í•˜ì„¸ìš”",align:"center",side:"bottom",children:a.jsx("button",{className:"button-toggle-inactive",children:"ì§€ì¶œìž…ë ¥"})}):t?a.jsxs("div",{className:"w-full px-1 leading-none",children:[a.jsx("div",{className:"text-blue-700 text-[9px] leading-[1.1] font-normal",children:new Date(e.expenditure_date).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})}),a.jsxs("div",{className:"text-gray-700 text-[9px] leading-[1.1] font-normal",children:["â‚©",Number(e.expenditure_amount).toLocaleString()]})]}):a.jsx("span",{className:"modal-subtitle text-gray-400",children:"-"})})()})]}),a.jsxs("div",{className:"block sm:hidden space-y-2",children:[a.jsxs("div",{className:"flex justify-between items-start",children:[a.jsxs("div",{className:"flex-1 min-w-0 relative",children:[ee?a.jsx(D,{value:e.item_name,onChange:e=>Re(t,"item_name",e.target.value),onFocus:()=>_e(`m_item_name_${t}`),onBlur:()=>_e(null),className:"modal-label border-gray-200 rounded-lg w-full !px-1.5 !py-0.5 !text-[10px] focus:border-blue-400 transition-all duration-200 "+(he===`m_item_name_${t}`?"!h-auto !min-h-[20px] !absolute !z-[9999] !bg-white !shadow-lg !left-0 !right-0 !-translate-y-1/2 !top-1/2 !whitespace-normal":"!h-5 !truncate"),placeholder:"í’ˆëª©ëª…",disabled:ye&&!be}):a.jsx("div",{className:"modal-value font-medium",children:e.item_name||"í’ˆëª©ëª… ì—†ìŒ"}),ee?a.jsx(D,{value:e.specification,onChange:e=>Re(t,"specification",e.target.value),onFocus:()=>_e(`m_specification_${t}`),onBlur:()=>_e(null),className:"modal-label border-gray-200 rounded-lg mt-1 w-full !px-1.5 !py-0.5 !text-[10px] focus:border-blue-400 transition-all duration-200 "+(he===`m_specification_${t}`?"!h-auto !min-h-[20px] !absolute !z-[9999] !bg-white !shadow-lg !left-0 !right-0 !-translate-y-1/2 !top-1/2 !whitespace-normal !w-full":"!h-5 !truncate"),placeholder:"ê·œê²©",disabled:ye&&!be}):a.jsx("div",{className:"modal-subtitle text-gray-500",children:e.specification||"-"})]}),a.jsx("div",{className:"ml-3 text-right flex-shrink-0",children:a.jsxs("div",{className:(ee?"modal-subtitle":"modal-value")+" font-semibold",children:["â‚©",Ae(e.amount_value||0)]})})]}),a.jsxs("div",{className:"grid grid-cols-3 gap-2 text-sm",children:[a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"ìˆ˜ëŸ‰:"}),ee?a.jsx(D,{type:"number",value:e.quantity,onChange:e=>Re(t,"quantity",Number(e.target.value)),className:"border-gray-200 rounded-lg mt-1 w-full !h-5 !px-1.5 !py-0.5 !text-[9px] font-normal text-gray-600 focus:border-blue-400",placeholder:"ìˆ˜ëŸ‰"}):a.jsx("div",{className:"modal-subtitle",children:e.quantity||0})]}),a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"ë‹¨ê°€:"}),ee?a.jsx(D,{type:"number",value:e.unit_price_value,onChange:e=>Re(t,"unit_price_value",Number(e.target.value)),className:"border-gray-200 rounded-lg mt-1 w-full !h-5 !px-1.5 !py-0.5 !text-[9px] font-normal text-gray-600 focus:border-blue-400",placeholder:"ë‹¨ê°€"}):a.jsxs("div",{className:"modal-subtitle",children:["â‚©",Ae(e.unit_price_value)]})]}),a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"ìƒíƒœ:"}),a.jsx("div",{className:"mt-1",children:ee?a.jsx(s,{size:"sm",variant:"ghost",onClick:()=>Ee(t),className:"text-red-600 hover:bg-red-50 rounded-lg p-1 h-6 w-6",children:a.jsx(U,{className:"w-3 h-3"})}):a.jsxs(a.Fragment,{children:["purchase"===S&&a.jsx(a.Fragment,{children:we?a.jsx("button",{onClick:()=>Ve(e.id,!e.is_payment_completed),className:"text-xs px-2 py-1 rounded "+(e.is_payment_completed?"bg-orange-500 text-white hover:bg-orange-600":"bg-gray-100 text-gray-600"),children:e.is_payment_completed?"êµ¬ë§¤ì™„ë£Œ":"êµ¬ë§¤ëŒ€ê¸°"}):a.jsx("span",{className:"text-xs px-2 py-1 rounded "+(e.is_payment_completed?"bg-orange-500 text-white":"bg-gray-100 text-gray-400"),children:e.is_payment_completed?"êµ¬ë§¤ì™„ë£Œ":"êµ¬ë§¤ëŒ€ê¸°"})}),"receipt"===S&&a.jsx(a.Fragment,{children:Se?Te.isCompleted(e)?a.jsx("button",{onClick:()=>{Te.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"text-xs px-2 py-1 rounded button-action-primary",children:Te.config.completedText}):a.jsx(A,{onDateSelect:t=>{Te.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"ì‹¤ì œ ìž…ê³ ëœ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”",align:"center",side:"bottom",children:a.jsx("button",{className:"text-xs px-2 py-1 rounded bg-gray-100 text-gray-600",children:Te.config.waitingText})}):a.jsx("span",{className:"text-xs px-2 py-1 rounded "+(Te.isCompleted(e)?"button-action-primary":"bg-gray-100 text-gray-400"),children:Te.isCompleted(e)?Te.config.completedText:Te.config.waitingText})}),"done"===S&&a.jsx(a.Fragment,{children:a.jsx("span",{className:"button-base "+(Te.isCompleted(e)?"bg-green-500 text-white":"border border-gray-300 text-gray-600 bg-white"),children:Te.isCompleted(e)?"ìž…ê³ ì™„ë£Œ":"ìž…ê³ ëŒ€ê¸°"})}),"purchase"!==S&&"receipt"!==S&&"done"!==S&&a.jsx("span",{className:"text-xs text-gray-400",children:"-"})]})})]})]}),(e.remark||ee)&&a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"ë¹„ê³ :"}),ee?a.jsx(D,{value:e.remark||"",onChange:e=>Re(t,"remark",e.target.value),className:"modal-label border-gray-200 rounded-lg mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"ë¹„ê³ "}):a.jsx("div",{className:"modal-subtitle text-gray-500 mt-1",children:e.remark||"-"})]}),!ee&&"receipt"===S&&Te.getCompletedDate(e)&&a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"ì‹¤ì œìž…ê³ ì¼:"}),a.jsxs("div",{className:"mt-1",children:[a.jsx("div",{className:"modal-subtitle text-green-700",children:new Date(Te.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})}),a.jsx("div",{className:"text-[9px] text-gray-500",children:new Date(Te.getCompletedDate(e)).toLocaleTimeString("ko-KR",{hour:"2-digit",minute:"2-digit"})})]})]}),!ee&&"done"===S&&a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸:"}),a.jsx("div",{className:"flex items-center gap-2",children:Se?Oe.isCompleted(e)?a.jsx("button",{onClick:()=>{Oe.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"text-xs px-2 py-1 rounded button-action-primary hover:bg-green-600",title:"í´ë¦­í•˜ì—¬ ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸ ì·¨ì†Œ",children:Oe.config.completedText}):a.jsx(A,{onDateSelect:t=>{Oe.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"íšŒê³„ìƒ ìž…ê³ ì¼ì„ ì„ íƒí•˜ì„¸ìš”",align:"end",side:"bottom",children:a.jsx("button",{className:"text-xs px-2 py-1 rounded bg-gray-100 text-gray-600",onClick:()=>{},children:Oe.config.waitingText})}):a.jsx("span",{className:"text-xs px-2 py-1 rounded "+(Oe.isCompleted(e)?"button-action-primary":"bg-gray-100 text-gray-400"),children:Oe.isCompleted(e)?Oe.config.completedText:Oe.config.waitingText})})]}),!ee&&"done"===S&&Oe.getCompletedDate(e)&&a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"íšŒê³„ìƒ ìž…ê³ ì¼:"}),a.jsx("div",{className:"mt-1",children:a.jsx("div",{className:"modal-subtitle text-blue-700",children:new Date(Oe.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})})})]})]})]},t))})]})}),a.jsxs("div",{className:"bg-gray-50 px-2 sm:px-3 border-t border-gray-100",children:[a.jsxs("div",{className:"hidden sm:grid items-center gap-2 py-0.5 w-fit",style:{gridTemplateColumns:Ke()},children:[a.jsx("div",{}),a.jsx("div",{}),a.jsx("div",{}),a.jsx("div",{className:"text-right",children:a.jsx("span",{className:"text-[12px] font-bold text-gray-900",children:"ì´ì•¡"})}),a.jsx("div",{className:"text-right",children:a.jsxs("span",{className:"text-[12px] font-bold text-gray-900",children:["â‚©",Ae((ee?se:xe)?.reduce((e,t)=>e+(t.amount_value||0),0)||0)]})}),a.jsx("div",{}),a.jsx("div",{}),"receipt"===S&&a.jsx("div",{}),"done"===S&&a.jsxs(a.Fragment,{children:[a.jsx("div",{}),a.jsx("div",{}),a.jsx("div",{})]})]}),a.jsx("div",{className:"block sm:hidden py-0.5",children:a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsx("span",{className:"text-[13px] font-bold text-gray-900",children:"ì´ì•¡"}),a.jsxs("span",{className:"text-[13px] font-bold text-gray-900",children:["â‚©",Ae((ee?se:xe)?.reduce((e,t)=>e+(t.amount_value||0),0)||0)]})]})}),"done"===S&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"hidden sm:grid items-center gap-2 py-0.5 w-fit border-t border-gray-200 pt-1",style:{gridTemplateColumns:Ke()},children:[a.jsx("div",{}),a.jsx("div",{}),a.jsx("div",{}),a.jsx("div",{}),a.jsx("div",{}),a.jsx("div",{}),a.jsx("div",{}),a.jsx("div",{}),a.jsx("div",{className:"text-right",children:a.jsx("span",{className:"text-[12px] font-bold text-gray-900",children:"ì§€ì¶œ ì´í•©"})}),a.jsx("div",{className:"text-center",children:a.jsxs("span",{className:"text-[12px] font-bold text-gray-900",children:["â‚©",Ae((ee?se:xe)?.reduce((e,t)=>e+(t.expenditure_amount||0),0)||0)]})})]}),a.jsx("div",{className:"block sm:hidden py-0.5 border-t border-gray-200 pt-1",children:a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsx("span",{className:"text-[13px] font-bold text-gray-900",children:"ì§€ì¶œ ì´í•©"}),a.jsxs("span",{className:"text-[13px] font-bold text-gray-900",children:["â‚©",Ae((ee?se:xe)?.reduce((e,t)=>e+(t.expenditure_amount||0),0)||0)]})]})})]})]}),ee&&a.jsx("div",{className:"p-2 sm:p-3 border-t border-gray-100",children:a.jsxs(s,{size:"sm",variant:"outline",onClick:()=>{const e={item_name:"",specification:"",quantity:1,unit_price_value:0,amount_value:0,remark:"",line_number:se.reduce((e,t)=>{const a=t.line_number||0;return a>e?a:e},0)+1},t=[...se,e].sort((e,t)=>(e.line_number||999999)-(t.line_number||999999));ie(t)},className:"w-full rounded-lg border-dashed border-2 border-gray-300 hover:border-gray-400 py-2 badge-text",children:[a.jsx(z,{className:"w-4 h-4 mr-1"}),"í•­ëª© ì¶”ê°€"]})})]})})]})]}):a.jsx("div",{className:"text-center py-12",children:a.jsx("span",{className:"modal-subtitle",children:"ë°œì£¼ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."})})});return y?Qe:a.jsx(I,{open:d,onOpenChange:c,children:a.jsxs($,{className:"overflow-hidden bg-white rounded-lg shadow-sm border-0 w-full sm:w-auto max-w-[calc(100vw-48px)] sm:max-w-[calc(100vw-80px)] lg:max-w-[90vw] xl:max-w-[85vw] h-[95vh] sm:h-auto sm:max-h-[90vh] lg:max-h-[85vh] sm:rounded-lg flex flex-col",showCloseButton:!1,children:[a.jsx(W,{className:"sr-only",children:a.jsx(O,{children:"ë°œì£¼ ìƒì„¸ ì •ë³´"})}),a.jsxs("div",{className:"relative px-3 sm:px-6 pt-0 sm:pt-3 lg:pt-4 pb-0 sm:pb-2 lg:pb-3 flex-shrink-0",children:[a.jsx("button",{onClick:c,className:"button-base button-action-secondary absolute right-3 sm:right-6 top-0 sm:top-3 lg:top-4 w-6 h-6 sm:w-8 sm:h-8 rounded-full",children:a.jsx(u,{className:"w-4 h-4 text-gray-500"})}),a.jsx("div",{className:"pr-8 sm:pr-16",children:a.jsxs("div",{className:"flex items-start gap-4 mb-0 sm:mb-3",children:[a.jsx("div",{className:"min-w-0 flex-1",children:a.jsx("h1",{className:"page-title mb-0 sm:mb-1",children:"ë°œì£¼ ê¸°ë³¸ì •ë³´"})}),a.jsxs("div",{className:"flex items-center gap-3",children:[!ee&&je&&a.jsxs(a.Fragment,{children:[a.jsxs(s,{size:"sm",variant:"outline",onClick:()=>Be(!0),className:"button-base button-action-secondary",children:[a.jsx(q,{className:"w-4 h-4 mr-2"}),"ìˆ˜ì •"]}),Ne&&V&&a.jsxs(s,{size:"sm",variant:"outline",onClick:async()=>{if(Y)try{await V(Y),c(),k&&await k(!0)}catch(e){r.error("ë°œì£¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ",e),T.error("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},className:"button-base button-action-danger",children:[a.jsx(U,{className:"w-4 h-4 mr-2"}),"ì‚­ì œ"]})]}),ee&&a.jsxs(a.Fragment,{children:[a.jsxs(s,{size:"sm",variant:"outline",onClick:()=>{Be(!1),re(Y),ie(Y?.items||[]),le([])},className:"button-base button-action-secondary",children:[a.jsx(u,{className:"w-4 h-4 mr-2"}),"ì·¨ì†Œ"]}),a.jsxs(s,{size:"sm",onClick:async()=>{if(Y&&ae)try{const e=se.reduce((e,t)=>e+(t.amount_value||0),0),{error:t}=await ve.from("purchase_requests").update({purchase_order_number:ae.purchase_order_number||null,requester_name:ae.requester_name||null,delivery_request_date:ae.delivery_request_date||null,revised_delivery_request_date:ae.revised_delivery_request_date||null,payment_category:ae.payment_category||null,project_vendor:ae.project_vendor||null,total_amount:Number(e),updated_at:(new Date).toISOString()}).eq("id",Y.id);if(t)throw t;if(ne.length>0){const{error:e}=await ve.from("purchase_request_items").delete().in("id",ne);if(e)throw e}for(const n of se){if(!n.item_name||!n.item_name.trim())throw new Error("í’ˆëª©ëª…ì€ í•„ìˆ˜ìž…ë‹ˆë‹¤.");if(!n.quantity||n.quantity<=0)throw new Error("ìˆ˜ëŸ‰ì€ 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.");if(null!==n.unit_price_value&&void 0!==n.unit_price_value&&n.unit_price_value<0)throw new Error("ë‹¨ê°€ëŠ” 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");if(null!==n.amount_value&&void 0!==n.amount_value&&n.amount_value<0)throw new Error("í•©ê³„ëŠ” 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");if(n.id){const{error:e}=await ve.from("purchase_request_items").update({item_name:n.item_name.trim(),specification:n.specification||null,quantity:Number(n.quantity),unit_price_value:Number(n.unit_price_value),unit_price_currency:Y.currency||"KRW",amount_value:Number(n.amount_value),amount_currency:Y.currency||"KRW",remark:n.remark||null,updated_at:(new Date).toISOString()}).eq("id",n.id);if(e)throw r.error("ê¸°ì¡´ í•­ëª© ì—…ë°ì´íŠ¸ ì˜¤ë¥˜",e),e}else{const e={purchase_request_id:Y.id,item_name:n.item_name.trim(),specification:n.specification||null,quantity:Number(n.quantity),unit_price_value:Number(n.unit_price_value),unit_price_currency:Y.currency||"KRW",amount_value:Number(n.amount_value),amount_currency:Y.currency||"KRW",remark:n.remark||null,line_number:n.line_number||se.indexOf(n)+1,created_at:(new Date).toISOString()},{error:t}=await ve.from("purchase_request_items").insert(e);if(t)throw r.error("ìƒˆ í•­ëª© ìƒì„± ì˜¤ë¥˜",t),t}}const a=Y?Number(Y.id):NaN,s=ae||Y;if(!Number.isNaN(a)&&ne.length>0&&(r.info("ðŸš€ [ë©”ëª¨ë¦¬ ìºì‹œ] ê°œë³„ í’ˆëª© ì‚­ì œ ì²˜ë¦¬ ì‹œìž‘",{purchaseId:a,deletedItemIds:ne,deletedCount:ne.length}),ne.forEach(e=>{f(a,e)?r.info("âœ… [handleSave] ê°œë³„ í’ˆëª© ì‚­ì œ ë©”ëª¨ë¦¬ ìºì‹œ ì—…ë°ì´íŠ¸ ì„±ê³µ",{purchaseId:a,itemId:e}):r.warn("[handleSave] ê°œë³„ í’ˆëª© ì‚­ì œ ë©”ëª¨ë¦¬ ìºì‹œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨",{purchaseId:a,itemId:e})})),!Number.isNaN(a)){const e=h(a,e=>{const t=se.reduce((e,t)=>e+(t.amount_value||0),0);return r.info("ðŸš€ [ë©”ëª¨ë¦¬ ìºì‹œ] ë°œì£¼ ê¸°ë³¸ ì •ë³´ ì—…ë°ì´íŠ¸",{purchaseId:a,newTotalAmount:t,itemsCount:se.length}),{...e,purchase_order_number:s?.purchase_order_number||e.purchase_order_number,requester_name:s?.requester_name||e.requester_name,delivery_request_date:s?.delivery_request_date||e.delivery_request_date,revised_delivery_request_date:s?.revised_delivery_request_date||e.revised_delivery_request_date,payment_category:s?.payment_category||e.payment_category,project_vendor:s?.project_vendor||e.project_vendor,total_amount:t,updated_at:(new Date).toISOString()}});r.info("ðŸš€ [ë©”ëª¨ë¦¬ ìºì‹œ] ê¸°ë³¸ ì •ë³´ ì—…ë°ì´íŠ¸ ê²°ê³¼:",{memoryUpdated:e})}(()=>{!Number.isNaN(a)&&C&&C(a,e=>{const t=se,a=t.reduce((e,t)=>e+(t.amount_value||0),0);return r.info("ðŸš€ [onOptimisticUpdate] ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸",{originalItemsCount:e.items?.length||e.purchase_request_items?.length||0,finalItemsCount:t.length,deletedItemsCount:ne.length}),{...e,purchase_order_number:s?.purchase_order_number||e.purchase_order_number,requester_name:s?.requester_name||e.requester_name,delivery_request_date:s?.delivery_request_date||e.delivery_request_date,revised_delivery_request_date:s?.revised_delivery_request_date||e.revised_delivery_request_date,payment_category:s?.payment_category||e.payment_category,project_vendor:s?.project_vendor||e.project_vendor,total_amount:a,items:t,purchase_request_items:t,updated_at:(new Date).toISOString()}})})(),T.success("ë°œì£¼ ë‚´ì—­ì´ ì„±ê³µì ìœ¼ë¡œ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤."),Be(!1),le([]),await ke();const i=k?.(!0,{silent:!0});i instanceof Promise&&await i}catch(e){r.error("ì €ìž¥ ì¤‘ ì „ì²´ ì˜¤ë¥˜",e);const t=e instanceof Error?e.message:"ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤";T.error(`ì €ìž¥ ì‹¤íŒ¨: ${t}`)}else T.error("ì €ìž¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")},className:"button-base button-action-primary",children:[a.jsx(K,{className:"w-4 h-4 mr-2"}),"ì €ìž¥"]})]})]})]})})]}),a.jsx("div",{className:"overflow-y-auto flex-1 px-3 sm:px-6 pb-1 sm:pb-6 mt-0",children:Qe})]})})});export{A as D,V as P,H as T,B as a,E as u};
//# sourceMappingURL=PurchaseDetailModal-BPXxEKHD.js.map
