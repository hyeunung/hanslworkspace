import{c as e,E as a,j as s,a as t,r,B as i,X as n}from"./index-DiF3elcH.js";import{D as l,a as c,b as m,c as d,I as o}from"./input-CgYAtweH.js";import{T as u,a as h,b as x,c as p,d as j,e as _}from"./table-Cgd8pHK3.js";import{B as v,t as f}from"./index-Dk6oRHuE.js";import{E as g}from"./eye-Cu2PNAgS.js";import{D as b}from"./download-D4krxTe_.js";import{D as N}from"./date-picker-popover-CinueKpy.js";import{P as y,f as w}from"./format-C8k3hUOA.js";import{P as k}from"./plus-B37kt1M3.js";import{S as q}from"./save-BphKfier.js";import{T as C}from"./trash-2-BB0SMaTO.js";import"./chevron-down-CKc8e7Sq.js";import"./popover-C-74q-Ds.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const S=e("file-x",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"m14.5 12.5-5 5",key:"b62r18"}],["path",{d:"m9.5 12.5 5 5",key:"1rk7el"}]]),U=({itemId:e,receiptUrl:r,itemName:i,paymentCategory:n,onUpdate:l})=>{const[c,m]=a.useState(!1);if("현장 결제"!==n&&"현장결제"!==n)return null;return r?s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("button",{onClick:()=>{if(!r)return;const e=document.createElement("div");e.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: rgba(0, 0, 0, 0.9);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      z-index: 9999;\n      cursor: pointer;\n    ";const a=document.createElement("img");a.src=r,a.style.cssText="\n      max-width: 90%;\n      max-height: 90%;\n      object-fit: contain;\n      border-radius: 8px;\n    ",e.appendChild(a),e.onclick=()=>document.body.removeChild(e),document.body.appendChild(e)},className:"inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-semibold text-white bg-blue-500 hover:bg-blue-600 rounded-md transition-colors",title:"영수증 미리보기",children:[s.jsx(g,{className:"w-4 h-4"}),s.jsx("span",{children:"보기"})]}),s.jsxs("button",{onClick:async()=>{if(r){m(!0);try{const a=new URL(r).pathname.split("/"),s=a.indexOf("receipt-images");if(-1===s)throw new Error("잘못된 영수증 URL입니다");const n=a.slice(s+1).join("/"),l=t(),{data:c,error:m}=await l.storage.from("receipt-images").download(n);if(m)throw m;const d=new Blob([c],{type:"image/jpeg"}),o=window.URL.createObjectURL(d),u=document.createElement("a");u.href=o,u.download=`영수증_${i}_${e}_${Date.now()}.jpg`,document.body.appendChild(u),u.click(),document.body.removeChild(u),window.URL.revokeObjectURL(o),"undefined"!=typeof window&&"function"==typeof window.alert&&alert("✅ 영수증이 다운로드되었습니다.")}catch(a){alert(`❌ 다운로드 실패: ${a instanceof Error?a.message:a}`)}finally{m(!1)}}},disabled:c,className:"inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-semibold text-white bg-green-500 hover:bg-green-600 disabled:bg-gray-400 disabled:cursor-not-allowed rounded-md transition-colors",title:"영수증 다운로드",children:[s.jsx(b,{className:"w-4 h-4"}),s.jsx("span",{children:c?"다운로드 중...":"다운로드"})]})]}):s.jsxs("div",{className:"flex items-center gap-2 text-gray-400",children:[s.jsx(S,{className:"w-4 h-4"}),s.jsx("span",{className:"text-sm",children:"영수증 없음"})]})};function z({isOpen:e,onClose:a,purchase:g,isAdmin:b,onUpdate:S}){const[z,L]=r.useState(g.items||[]),[E,D]=r.useState(!1),[M,O]=r.useState(""),R=t();r.useEffect(()=>{e&&(async()=>{try{const{data:{user:e}}=await R.auth.getUser();if(e?.email){const{data:a}=await R.from("employees").select("name").eq("email",e.email).single();O(a?.name?a.name:e.email)}if(g.id){const{data:e}=await R.from("purchase_request_items").select("*").eq("purchase_request_id",g.id).order("line_number");e&&L(e)}}catch(e){O("사용자")}})()},[e,R,g.id]);const I=(e,a,s)=>{const t=[...z];t[e]={...t[e],[a]:"quantity"===a||"unit_price_value"===a||"amount_value"===a?Number(s):s},"quantity"!==a&&"unit_price_value"!==a||(t[e].amount_value=t[e].quantity*(t[e].unit_price_value||0)),L(t)},$=z,B=$.reduce((e,a)=>e+(a.amount_value||0),0);return s.jsx(l,{open:e,onOpenChange:a,children:s.jsxs(c,{className:"w-full max-w-[95vw] sm:max-w-6xl max-h-[80vh] overflow-hidden flex flex-col bg-white",children:[s.jsx(m,{className:"flex-shrink-0",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs(d,{className:"modal-title",children:["발주 상세 항목 - ",g.purchase_order_number]}),s.jsxs("div",{className:"flex items-center gap-2",children:[b&&!E&&s.jsxs(i,{variant:"outline",size:"sm",onClick:()=>{D(!0),L([...g.items||[]])},children:[s.jsx(y,{className:"h-4 w-4 mr-1"}),"편집"]}),E&&s.jsxs(s.Fragment,{children:[s.jsxs(i,{variant:"outline",size:"sm",onClick:()=>{const e={line_number:z.length+1,item_name:"",specification:"",quantity:0,unit_price_value:0,amount_value:0,remark:"",is_received:!1};L([...z,e])},children:[s.jsx(k,{className:"h-4 w-4 mr-1"}),"품목 추가"]}),s.jsxs(i,{variant:"default",size:"sm",onClick:async()=>{try{await R.from("purchase_request_items").delete().eq("purchase_request_id",g.id);const e=z.map(e=>({purchase_request_id:g.id,purchase_order_number:g.purchase_order_number,line_number:e.line_number,item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark,link:e.link,is_received:e.is_received||!1,delivery_status:e.delivery_status||"pending"})),{error:s}=await R.from("purchase_request_items").insert(e);if(s)throw s;const t=z.reduce((e,a)=>e+(a.amount_value||0),0);await R.from("purchase_requests").update({total_amount:t}).eq("id",g.id),f.success("품목이 수정되었습니다."),D(!1),S(),a()}catch(e){f.error("저장 중 오류가 발생했습니다.")}},children:[s.jsx(q,{className:"h-4 w-4 mr-1"}),"저장"]}),s.jsx(i,{variant:"ghost",size:"sm",onClick:()=>{D(!1),L(g.items||[])},children:"취소"})]}),s.jsx(i,{variant:"ghost",size:"icon",onClick:a,className:"h-6 w-6",children:s.jsx(n,{className:"h-4 w-4"})})]})]})}),s.jsxs("div",{className:"flex-shrink-0 grid grid-cols-2 md:grid-cols-4 gap-3 py-3 border-b",children:[s.jsxs("div",{children:[s.jsx("p",{className:"modal-label",children:"업체명"}),s.jsx("p",{className:"modal-value",children:g.vendor_name})]}),s.jsxs("div",{children:[s.jsx("p",{className:"modal-label",children:"요청자"}),s.jsx("p",{className:"modal-value",children:g.requester_name})]}),s.jsxs("div",{children:[s.jsx("p",{className:"modal-label",children:"프로젝트"}),s.jsx("p",{className:"modal-value truncate",title:g.project_vendor,children:g.project_vendor})]}),s.jsxs("div",{children:[s.jsx("p",{className:"modal-label",children:"납기일"}),s.jsx("p",{className:"modal-value",children:g.delivery_request_date&&w(new Date(g.delivery_request_date),"yyyy-MM-dd")})]})]}),s.jsx("div",{className:"flex-1 overflow-auto",children:s.jsxs(u,{children:[s.jsx(h,{className:"sticky top-0 bg-white z-10",children:s.jsxs(x,{children:[s.jsx(p,{className:"w-12",children:"No."}),s.jsx(p,{children:"품목"}),s.jsx(p,{children:"규격"}),s.jsx(p,{className:"text-right",children:"수량"}),s.jsx(p,{className:"text-right",children:"단가"}),s.jsx(p,{className:"text-right",children:"금액"}),s.jsx(p,{children:"입고상태"}),s.jsx(p,{children:"영수증"}),s.jsx(p,{className:"text-center",children:"거래명세서 확인"}),s.jsx(p,{className:"text-center",children:"회계상 입고일"}),s.jsx(p,{children:"비고"}),E&&s.jsx(p,{className:"w-20",children:"삭제"})]})}),s.jsx(j,{children:$.map((e,a)=>s.jsxs(x,{children:[s.jsx(_,{className:"modal-value",children:e.line_number||a+1}),s.jsx(_,{children:E?s.jsx(o,{value:e.item_name,onChange:e=>I(a,"item_name",e.target.value),className:"h-7 modal-label"}):s.jsx("div",{className:"sm:max-w-[200px]",children:s.jsx("p",{className:"modal-value truncate",title:e.item_name,children:e.item_name})})}),s.jsx(_,{children:E?s.jsx(o,{value:e.specification,onChange:e=>I(a,"specification",e.target.value),className:"h-7 modal-label"}):s.jsx("div",{className:"sm:max-w-[150px] truncate",title:e.specification,children:e.specification})}),s.jsx(_,{className:"text-right",children:E?s.jsx(o,{type:"number",value:e.quantity,onChange:e=>I(a,"quantity",e.target.value),className:"h-7 text-xs text-right"}):s.jsx("span",{className:"modal-value",children:e.quantity.toLocaleString()})}),s.jsx(_,{className:"text-right",children:E?s.jsx(o,{type:"number",value:e.unit_price_value,onChange:e=>I(a,"unit_price_value",e.target.value),className:"h-7 text-xs text-right"}):s.jsxs("span",{className:"modal-subtitle",children:[(e.unit_price_value||0).toLocaleString()," ",g.currency]})}),s.jsx(_,{className:"text-right",children:E?s.jsx(o,{type:"number",value:e.amount_value,onChange:e=>I(a,"amount_value",e.target.value),className:"h-7 modal-label text-right"}):s.jsxs("span",{className:"modal-value",children:[(e.amount_value||0).toLocaleString()," ",g.currency]})}),s.jsx(_,{children:e.is_received?s.jsx(v,{variant:null,className:"badge-success",children:"입고완료"}):s.jsx(v,{variant:null,className:"badge-secondary",children:"대기"})}),s.jsx(_,{className:"text-center",children:s.jsx(U,{itemId:Number(e.id),receiptUrl:e.receipt_image_url,itemName:e.item_name,paymentCategory:g.payment_category,onUpdate:S})}),s.jsx(_,{className:"text-center",children:e.is_statement_received?s.jsx(v,{variant:null,className:"badge-success",children:"완료"}):s.jsx(N,{onDateSelect:a=>(async(e,a)=>{const s=String(e),t="number"==typeof e?e:Number(e);if(Number.isNaN(t))f.error("유효하지 않은 항목 ID 입니다.");else try{const{error:e}=await R.from("purchase_request_items").update({is_statement_received:!0,statement_received_date:a.toISOString(),statement_received_by_name:M}).eq("id",t);if(e)throw e;const{data:r}=await R.from("purchase_request_items").select("*").eq("purchase_request_id",g.id).order("line_number");r&&L(r),S();const i=z.find(e=>e.id===s);f.success(`"${i?.item_name}" 거래명세서 확인이 완료되었습니다.`)}catch(r){f.error("거래명세서 확인 처리 중 오류가 발생했습니다.")}})(e.id,a),placeholder:"날짜 선택",children:s.jsx(i,{variant:"outline",size:"sm",className:"button-base border border-gray-300 text-gray-600 bg-white hover:bg-gray-50",children:"대기"})})}),s.jsx(_,{className:"text-center",children:e.statement_received_date?s.jsx("span",{className:"modal-subtitle",children:w(new Date(e.statement_received_date),"yyyy-MM-dd")}):s.jsx("span",{className:"modal-subtitle",children:"-"})}),s.jsx(_,{children:E?s.jsx(o,{value:e.remark||"",onChange:e=>I(a,"remark",e.target.value),className:"h-7 modal-label",placeholder:"비고"}):s.jsx("div",{className:"sm:max-w-[150px]",children:s.jsx("span",{className:"modal-subtitle truncate block",title:e.remark,children:e.remark||"-"})})}),E&&s.jsx(_,{children:s.jsx(i,{variant:"ghost",size:"icon",onClick:()=>(e=>{const a=z.filter((a,s)=>s!==e);a.forEach((e,a)=>{e.line_number=a+1}),L(a)})(a),className:"h-7 w-7 text-red-500 hover:text-red-700",children:s.jsx(C,{className:"h-4 w-4"})})})]},e.id||a))})]})}),s.jsxs("div",{className:"flex-shrink-0 border-t pt-4 flex justify-between items-center",children:[s.jsxs("div",{className:"modal-subtitle",children:["총 ",$.length,"개 품목"]}),s.jsxs("div",{className:"modal-value-large",children:["총 금액: ",B.toLocaleString()," ",g.currency]})]})]})})}export{z as default};
//# sourceMappingURL=PurchaseItemsModal-CwB-90mk.js.map
