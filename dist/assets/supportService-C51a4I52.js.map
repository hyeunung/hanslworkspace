{"version":3,"file":"supportService-C51a4I52.js","sources":["../../src/services/supportService.ts"],"sourcesContent":["import { createClient } from '@/lib/supabase/client'\nimport { logger } from '@/lib/logger'\n\nexport interface SupportAttachment {\n  url: string\n  name: string\n  size: number\n  path: string\n}\n\nexport interface SupportInquiry {\n  id?: number\n  created_at?: string\n  updated_at?: string\n  user_id?: string\n  user_email?: string\n  user_name?: string\n  inquiry_type: 'bug' | 'modify' | 'delete' | 'other' | 'annual_leave' | 'attendance'\n  subject: string\n  message: string\n  status?: 'open' | 'in_progress' | 'resolved' | 'closed'\n  handled_by?: string\n  resolution_note?: string\n  purchase_request_id?: number | null\n  purchase_info?: string\n  purchase_order_number?: string\n  processed_at?: string\n  requester_id?: string\n  purchase_requests?: any\n  attachments?: SupportAttachment[]\n}\n\nexport interface CreateSupportInquiryPayload {\n  inquiry_type: 'bug' | 'modify' | 'delete' | 'other' | 'annual_leave' | 'attendance'\n  subject: string\n  message: string\n  purchase_request_id?: number\n  purchase_info?: string\n  purchase_order_number?: string\n  attachments?: SupportAttachment[]\n}\n\nclass SupportService {\n  private supabase = createClient()\n  private readonly BUCKET_NAME = 'support-attachments'\n\n  // 이미지 첨부파일 업로드\n  async uploadAttachment(file: File): Promise<{ success: boolean; data?: SupportAttachment; error?: string }> {\n    try {\n      const { data: { user }, error: authError } = await this.supabase.auth.getUser()\n      if (authError || !user) return { success: false, error: '로그인이 필요합니다.' }\n\n      // 파일 확장자 추출\n      const fileExt = file.name.split('.').pop()?.toLowerCase() || 'jpg'\n      const timestamp = Date.now()\n      const randomStr = Math.random().toString(36).substring(2, 8)\n      const fileName = `support_${timestamp}_${randomStr}.${fileExt}`\n      const filePath = `inquiries/${user.id}/${fileName}`\n\n      // Storage에 업로드\n      const { error: uploadError } = await this.supabase.storage\n        .from(this.BUCKET_NAME)\n        .upload(filePath, file, {\n          contentType: file.type,\n          upsert: false,\n        })\n\n      if (uploadError) {\n        logger.error('첨부파일 업로드 에러', uploadError)\n        throw uploadError\n      }\n\n      // Public URL 생성\n      const { data: { publicUrl } } = this.supabase.storage\n        .from(this.BUCKET_NAME)\n        .getPublicUrl(filePath)\n\n      return {\n        success: true,\n        data: {\n          url: publicUrl,\n          name: file.name,\n          size: file.size,\n          path: filePath\n        }\n      }\n    } catch (e) {\n      return { success: false, error: e instanceof Error ? e.message : '파일 업로드 실패' }\n    }\n  }\n\n  // 첨부파일 삭제\n  async deleteAttachment(path: string): Promise<{ success: boolean; error?: string }> {\n    try {\n      const { error } = await this.supabase.storage\n        .from(this.BUCKET_NAME)\n        .remove([path])\n\n      if (error) throw error\n      return { success: true }\n    } catch (e) {\n      return { success: false, error: e instanceof Error ? e.message : '파일 삭제 실패' }\n    }\n  }\n\n  // 문의 정렬: 완료되지 않은 문의를 먼저, 그 안에서 최신순\n  private sortInquiriesByStatus(inquiries: SupportInquiry[]): SupportInquiry[] {\n    return inquiries.sort((a, b) => {\n      // 완료 상태: resolved, closed\n      const aCompleted = a.status === 'resolved' || a.status === 'closed'\n      const bCompleted = b.status === 'resolved' || b.status === 'closed'\n      \n      // 완료되지 않은 문의를 먼저\n      if (aCompleted !== bCompleted) {\n        return aCompleted ? 1 : -1\n      }\n      \n      // 같은 그룹 내에서는 최신순 (created_at 내림차순)\n      const aDate = new Date(a.created_at || 0).getTime()\n      const bDate = new Date(b.created_at || 0).getTime()\n      return bDate - aDate\n    })\n  }\n\n  // 문의 생성\n  async createInquiry(payload: CreateSupportInquiryPayload): Promise<{ success: boolean; error?: string }> {\n    try {\n      const { data: { user }, error: authError } = await this.supabase.auth.getUser()\n      if (authError || !user) return { success: false, error: '로그인이 필요합니다.' }\n\n      const { data: employee } = await this.supabase\n        .from('employees')\n        .select('id, name, email')\n        .eq('email', user.email)\n        .maybeSingle()\n\n      const { error } = await this.supabase\n        .from('support_inquires')\n        .insert({\n          user_id: user.id,\n          user_email: employee?.email || user.email,\n          user_name: employee?.name || '',\n          requester_id: employee?.id,\n          inquiry_type: payload.inquiry_type,\n          subject: payload.subject,\n          message: payload.message,\n          purchase_request_id: payload.purchase_request_id ?? null,\n          purchase_info: payload.purchase_info,\n          purchase_order_number: payload.purchase_order_number,\n          status: 'open',\n          attachments: payload.attachments || []\n        })\n\n      if (error) {\n        logger.error('문의 등록 에러', error, {\n          code: error.code,\n          details: error.details,\n          hint: error.hint\n        })\n        return { success: false, error: error.message }\n      }\n      return { success: true }\n    } catch (e) {\n      return { success: false, error: e instanceof Error ? e.message : '문의 접수 실패' }\n    }\n  }\n\n  // 내 문의 목록 조회\n  async getMyInquiries(): Promise<{ success: boolean; data: SupportInquiry[]; error?: string }> {\n    try {\n      const { data: { user }, error: authError } = await this.supabase.auth.getUser()\n      if (authError || !user) {\n        return { success: false, data: [], error: '로그인이 필요합니다.' }\n      }\n\n\n      const { data, error } = await this.supabase\n        .from('support_inquires')\n        .select('*')\n        .eq('user_id', user.id)\n        .order('created_at', { ascending: false })\n\n\n      if (error) {\n        throw error\n      }\n\n      // 완료되지 않은 문의를 먼저, 그 안에서 최신순 정렬\n      const sortedData = this.sortInquiriesByStatus(data || [])\n\n      return { success: true, data: sortedData }\n    } catch (e) {\n      return { success: false, data: [], error: e instanceof Error ? e.message : '문의 조회 실패' }\n    }\n  }\n\n  // 모든 문의 목록 조회 (관리자용)\n  async getAllInquiries(): Promise<{ success: boolean; data: SupportInquiry[]; error?: string }> {\n    try {\n      const { data, error } = await this.supabase\n        .from('support_inquires')\n        .select('*')\n        .order('created_at', { ascending: false })\n\n\n      if (error) {\n        throw error\n      }\n\n      // 완료되지 않은 문의를 먼저, 그 안에서 최신순 정렬\n      const sortedData = this.sortInquiriesByStatus(data || [])\n\n      return { success: true, data: sortedData }\n    } catch (e) {\n      return { success: false, data: [], error: e instanceof Error ? e.message : '문의 조회 실패' }\n    }\n  }\n\n  // 문의 상태 업데이트 (관리자용)\n  async updateInquiryStatus(\n    inquiryId: number, \n    status: 'open' | 'in_progress' | 'resolved' | 'closed',\n    resolution_note?: string\n  ): Promise<{ success: boolean; error?: string }> {\n    try {\n      const { data: { user }, error: authError } = await this.supabase.auth.getUser()\n      if (authError || !user) return { success: false, error: '로그인이 필요합니다.' }\n\n      const { data: employee } = await this.supabase\n        .from('employees')\n        .select('name')\n        .eq('email', user.email)\n        .single()\n\n      const updateData: any = {\n        status,\n        handled_by: employee?.name || user.email,\n        updated_at: new Date().toISOString()\n      }\n\n      // resolved나 closed 상태로 변경 시 처리 시간 기록\n      if (status === 'resolved' || status === 'closed') {\n        updateData.processed_at = new Date().toISOString()\n      }\n\n      // resolution_note가 있으면 추가\n      if (resolution_note) {\n        updateData.resolution_note = resolution_note\n      }\n\n      const { error } = await this.supabase\n        .from('support_inquires')\n        .update(updateData)\n        .eq('id', inquiryId)\n\n      if (error) throw error\n\n      return { success: true }\n    } catch (e) {\n      return { success: false, error: e instanceof Error ? e.message : '상태 업데이트 실패' }\n    }\n  }\n\n\n  // 내가 요청한 발주 목록 조회 (수정/삭제 요청용)\n  async getMyPurchaseRequests(startDate?: string, endDate?: string) {\n    try {\n      const { data: { user }, error: authError } = await this.supabase.auth.getUser()\n      if (authError || !user) return { success: false, data: [], error: '로그인이 필요합니다.' }\n\n      const { data: employee } = await this.supabase\n        .from('employees')\n        .select('name')\n        .eq('email', user.email)\n        .single()\n\n      if (!employee) {\n        return { success: false, data: [], error: '사용자 정보를 찾을 수 없습니다.' }\n      }\n\n      let query = this.supabase\n        .from('purchase_requests')\n        .select('id,purchase_order_number,vendor_name,request_date,created_at,requester_name,middle_manager_status,final_manager_status,purchase_request_items(item_name,specification,quantity)')\n        .eq('requester_name', employee.name)\n        // 승인대기 항목은 request_date가 비어있는 경우가 있어 created_at 기준으로 정렬/필터링\n        .order('created_at', { ascending: false })\n\n      // 날짜 필터 적용\n      if (startDate) {\n        query = query.gte('created_at', `${startDate}T00:00:00`)\n      }\n      if (endDate) {\n        query = query.lte('created_at', `${endDate}T23:59:59.999`)\n      }\n\n      const { data, error } = await query.limit(100)\n\n      if (error) throw error\n\n      return { success: true, data: data || [] }\n    } catch (e) {\n      return { success: false, data: [], error: e instanceof Error ? e.message : '발주요청 조회 실패' }\n    }\n  }\n\n  // 실시간 구독 설정\n  subscribeToInquiries(callback: (payload: any) => void) {\n    return this.supabase\n      .channel('support_inquires_changes')\n      .on(\n        'postgres_changes',\n        {\n          event: '*',\n          schema: 'public',\n          table: 'support_inquires'\n        },\n        callback\n      )\n      .subscribe()\n  }\n\n  // 발주요청 품목 수정\n  async updatePurchaseRequestItem(\n    itemId: string,\n    updates: {\n      item_name?: string\n      specification?: string\n      quantity?: number\n      unit_price_value?: number\n      amount_value?: number\n      remark?: string\n    }\n  ): Promise<{ success: boolean; error?: string }> {\n    try {\n      const updateData: any = {}\n      \n      if (updates.item_name !== undefined) updateData.item_name = updates.item_name\n      if (updates.specification !== undefined) updateData.specification = updates.specification\n      if (updates.quantity !== undefined) updateData.quantity = updates.quantity\n      if (updates.remark !== undefined) updateData.remark = updates.remark\n      if (updates.unit_price_value !== undefined) {\n        updateData.unit_price_value = updates.unit_price_value\n        updateData.unit_price_currency = 'KRW'\n      }\n      if (updates.amount_value !== undefined) {\n        updateData.amount_value = updates.amount_value\n        updateData.amount_currency = 'KRW'\n      }\n      \n      const { error } = await this.supabase\n        .from('purchase_request_items')\n        .update(updateData)\n        .eq('id', itemId)\n\n      if (error) throw error\n      return { success: true }\n    } catch (e) {\n      return { success: false, error: e instanceof Error ? e.message : '품목 수정 실패' }\n    }\n  }\n\n  // 발주요청 품목 삭제\n  async deletePurchaseRequestItem(itemId: string): Promise<{ success: boolean; error?: string }> {\n    try {\n      const { error } = await this.supabase\n        .from('purchase_request_items')\n        .delete()\n        .eq('id', itemId)\n\n      if (error) throw error\n      return { success: true }\n    } catch (e) {\n      return { success: false, error: e instanceof Error ? e.message : '품목 삭제 실패' }\n    }\n  }\n\n  // 발주요청 전체 삭제\n  async deletePurchaseRequest(requestId: string): Promise<{ success: boolean; error?: string }> {\n    try {\n      // 먼저 관련 품목들 삭제\n      const { data: deletedItems, error: itemsError } = await this.supabase\n        .from('purchase_request_items')\n        .delete()\n        .eq('purchase_request_id', requestId)\n        .select()\n\n      if (itemsError) {\n        console.error('[deletePurchaseRequest] 품목 삭제 실패', {\n          requestId,\n          error: itemsError\n        })\n        throw itemsError\n      }\n\n      console.log('[deletePurchaseRequest] 품목 삭제 성공', {\n        requestId,\n        deletedItemsCount: deletedItems?.length || 0\n      })\n\n      // 발주요청 삭제\n      const { data: deletedRequest, error: requestError } = await this.supabase\n        .from('purchase_requests')\n        .delete()\n        .eq('id', requestId)\n        .select()\n\n      if (requestError) {\n        console.error('[deletePurchaseRequest] 발주요청 삭제 실패', {\n          requestId,\n          error: requestError,\n          note: '품목은 이미 삭제되었지만 발주요청은 삭제되지 않았습니다.'\n        })\n        throw requestError\n      }\n\n      console.log('[deletePurchaseRequest] 발주요청 삭제 성공', {\n        requestId,\n        deletedRequest: deletedRequest?.[0]\n      })\n\n      return { success: true }\n    } catch (e) {\n      const errorMessage = e instanceof Error ? e.message : '발주요청 삭제 실패'\n      console.error('[deletePurchaseRequest] 전체 삭제 실패', {\n        requestId,\n        error: errorMessage\n      })\n      return { success: false, error: errorMessage }\n    }\n  }\n\n  // 발주요청 상세 조회\n  async getPurchaseRequestDetail(requestId: string): Promise<{ success: boolean; data?: any; error?: string }> {\n    try {\n      const { data, error } = await this.supabase\n        .from('purchase_requests')\n        .select('*,purchase_request_items(id,line_number,item_name,specification,quantity,unit_price_value,amount_value,remark,link)')\n        .eq('id', requestId)\n        .single()\n\n      if (error) throw error\n\n      return { success: true, data }\n    } catch (e) {\n      return { success: false, error: e instanceof Error ? e.message : '발주요청 조회 실패' }\n    }\n  }\n\n  // 문의 삭제\n  async deleteInquiry(inquiryId: number): Promise<{ success: boolean; error?: string }> {\n    try {\n      const { data: { user }, error: authError } = await this.supabase.auth.getUser()\n      if (authError || !user) return { success: false, error: '로그인이 필요합니다.' }\n\n      // 관리자 권한 확인\n      const { data: employee } = await this.supabase\n        .from('employees')\n        .select('purchase_role')\n        .eq('email', user.email)\n        .single()\n\n      const isAdmin = employee?.purchase_role?.includes('app_admin')\n\n      // 관리자가 아닌 경우에만 본인 문의 확인\n      if (!isAdmin) {\n        // 문의 정보 확인 (본인 것인지)\n        const { data: inquiry, error: fetchError } = await this.supabase\n          .from('support_inquires')\n          .select('user_id, status, resolution_note')\n          .eq('id', inquiryId)\n          .single()\n\n        if (fetchError || !inquiry) {\n          return { success: false, error: '문의를 찾을 수 없습니다.' }\n        }\n\n        // 본인 문의가 아니면 삭제 불가\n        if (inquiry.user_id !== user.id) {\n          return { success: false, error: '본인의 문의만 삭제할 수 있습니다.' }\n        }\n\n        // 일반 사용자는 답변이 있거나 처리중인 문의는 삭제 불가\n        if (inquiry.resolution_note) {\n          return { success: false, error: '답변이 완료된 문의는 삭제할 수 없습니다.' }\n        }\n\n        if (inquiry.status !== 'open') {\n          return { success: false, error: '처리가 진행된 문의는 삭제할 수 없습니다.' }\n        }\n      }\n      // 관리자는 모든 문의 삭제 가능 (제한 없음)\n\n      // 삭제 실행\n      const { error } = await this.supabase\n        .from('support_inquires')\n        .delete()\n        .eq('id', inquiryId)\n\n      if (error) throw error\n      return { success: true }\n    } catch (e) {\n      return { success: false, error: e instanceof Error ? e.message : '문의 삭제 실패' }\n    }\n  }\n}\n\nexport const supportService = new SupportService()"],"names":["supportService","constructor","this","supabase","createClient","BUCKET_NAME","uploadAttachment","file","data","user","error","authError","auth","getUser","success","fileExt","name","split","pop","toLowerCase","timestamp","Date","now","fileName","Math","random","toString","substring","filePath","id","uploadError","storage","from","upload","contentType","type","upsert","logger","publicUrl","getPublicUrl","url","size","path","e","Error","message","deleteAttachment","remove","sortInquiriesByStatus","inquiries","sort","a","b","aCompleted","status","aDate","created_at","getTime","createInquiry","payload","employee","select","eq","email","maybeSingle","insert","user_id","user_email","user_name","requester_id","inquiry_type","subject","purchase_request_id","purchase_info","purchase_order_number","attachments","code","details","hint","getMyInquiries","order","ascending","getAllInquiries","updateInquiryStatus","inquiryId","resolution_note","single","updateData","handled_by","updated_at","toISOString","processed_at","update","getMyPurchaseRequests","startDate","endDate","query","gte","lte","limit","subscribeToInquiries","callback","channel","on","event","schema","table","subscribe","updatePurchaseRequestItem","itemId","updates","item_name","specification","quantity","remark","unit_price_value","unit_price_currency","amount_value","amount_currency","deletePurchaseRequestItem","delete","deletePurchaseRequest","requestId","deletedItems","itemsError","deletedRequest","requestError","getPurchaseRequestDetail","deleteInquiry","isAdmin","purchase_role","includes","inquiry","fetchError"],"mappings":"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"}