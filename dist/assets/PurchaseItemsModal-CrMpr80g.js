import{r as e,a as s,j as a,B as t,X as i}from"./index-C7cUK919.js";import{D as r,a as n,b as l,c,I as m}from"./input-DVH5FPaw.js";import{T as d,a as x,b as u,c as h,d as o,e as j}from"./table-C8xx2Q1-.js";import{B as p,t as _}from"./index-DnVeObT1.js";import{P as v,f}from"./format-CxO3pnnf.js";import{P as N}from"./plus-CpnnSD9F.js";import{S as g}from"./save-DDV9iGIr.js";import{T as y}from"./trash-2-BsWb-Sza.js";function w({isOpen:w,onClose:b,purchase:k,isAdmin:q,onUpdate:C}){const[z,S]=e.useState(k.items||[]),[L,A]=e.useState(!1),B=s(),D=(e,s,a)=>{const t=[...z];t[e]={...t[e],[s]:"quantity"===s||"unit_price_value"===s||"amount_value"===s?Number(a):a},"quantity"!==s&&"unit_price_value"!==s||(t[e].amount_value=t[e].quantity*(t[e].unit_price_value||0)),S(t)},M=L?z:k.items||[],O=M.reduce((e,s)=>e+(s.amount_value||0),0);return a.jsx(r,{open:w,onOpenChange:b,children:a.jsxs(n,{className:"w-full max-w-[95vw] sm:max-w-6xl max-h-[80vh] overflow-hidden flex flex-col bg-white",children:[a.jsx(l,{className:"flex-shrink-0",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs(c,{className:"text-xl font-bold",children:["발주 상세 항목 - ",k.purchase_order_number]}),a.jsxs("div",{className:"flex items-center gap-2",children:[q&&!L&&a.jsxs(t,{variant:"outline",size:"sm",onClick:()=>{A(!0),S([...k.items||[]])},children:[a.jsx(v,{className:"h-4 w-4 mr-1"}),"편집"]}),L&&a.jsxs(a.Fragment,{children:[a.jsxs(t,{variant:"outline",size:"sm",onClick:()=>{const e={line_number:z.length+1,item_name:"",specification:"",quantity:0,unit_price_value:0,amount_value:0,remark:"",is_received:!1};S([...z,e])},children:[a.jsx(N,{className:"h-4 w-4 mr-1"}),"품목 추가"]}),a.jsxs(t,{variant:"default",size:"sm",onClick:async()=>{try{await B.from("purchase_request_items").delete().eq("purchase_request_id",k.id);const e=z.map(e=>({purchase_request_id:k.id,purchase_order_number:k.purchase_order_number,line_number:e.line_number,item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark,link:e.link,is_received:e.is_received||!1,delivery_status:e.delivery_status||"pending"})),{error:s}=await B.from("purchase_request_items").insert(e);if(s)throw s;const a=z.reduce((e,s)=>e+(s.amount_value||0),0);await B.from("purchase_requests").update({total_amount:a}).eq("id",k.id),_.success("품목이 수정되었습니다."),A(!1),C(),b()}catch(e){_.error("저장 중 오류가 발생했습니다.")}},children:[a.jsx(g,{className:"h-4 w-4 mr-1"}),"저장"]}),a.jsx(t,{variant:"ghost",size:"sm",onClick:()=>{A(!1),S(k.items||[])},children:"취소"})]}),a.jsx(t,{variant:"ghost",size:"icon",onClick:b,className:"h-6 w-6",children:a.jsx(i,{className:"h-4 w-4"})})]})]})}),a.jsxs("div",{className:"flex-shrink-0 grid grid-cols-2 md:grid-cols-4 gap-4 py-4 border-b",children:[a.jsxs("div",{children:[a.jsx("p",{className:"text-sm text-gray-500",children:"업체명"}),a.jsx("p",{className:"font-medium",children:k.vendor_name})]}),a.jsxs("div",{children:[a.jsx("p",{className:"text-sm text-gray-500",children:"요청자"}),a.jsx("p",{className:"font-medium",children:k.requester_name})]}),a.jsxs("div",{children:[a.jsx("p",{className:"text-sm text-gray-500",children:"프로젝트"}),a.jsx("p",{className:"font-medium truncate",title:k.project_vendor,children:k.project_vendor})]}),a.jsxs("div",{children:[a.jsx("p",{className:"text-sm text-gray-500",children:"납기일"}),a.jsx("p",{className:"font-medium",children:k.delivery_request_date&&f(new Date(k.delivery_request_date),"yyyy-MM-dd")})]})]}),a.jsx("div",{className:"flex-1 overflow-auto",children:a.jsxs(d,{children:[a.jsx(x,{className:"sticky top-0 bg-white z-10",children:a.jsxs(u,{children:[a.jsx(h,{className:"w-12",children:"No."}),a.jsx(h,{children:"품목"}),a.jsx(h,{children:"규격"}),a.jsx(h,{className:"text-right",children:"수량"}),a.jsx(h,{className:"text-right",children:"단가"}),a.jsx(h,{className:"text-right",children:"금액"}),a.jsx(h,{children:"입고상태"}),a.jsx(h,{children:"영수증"}),a.jsx(h,{children:"비고"}),L&&a.jsx(h,{className:"w-20",children:"삭제"})]})}),a.jsx(o,{children:M.map((e,s)=>a.jsxs(u,{children:[a.jsx(j,{className:"font-medium",children:e.line_number||s+1}),a.jsx(j,{children:L?a.jsx(m,{value:e.item_name,onChange:e=>D(s,"item_name",e.target.value),className:"h-8 text-sm"}):a.jsx("div",{className:"sm:max-w-[200px]",children:a.jsx("p",{className:"font-medium truncate",title:e.item_name,children:e.item_name})})}),a.jsx(j,{children:L?a.jsx(m,{value:e.specification,onChange:e=>D(s,"specification",e.target.value),className:"h-8 text-sm"}):a.jsx("div",{className:"sm:max-w-[150px] truncate",title:e.specification,children:e.specification})}),a.jsx(j,{className:"text-right",children:L?a.jsx(m,{type:"number",value:e.quantity,onChange:e=>D(s,"quantity",e.target.value),className:"h-8 text-sm text-right"}):a.jsx("span",{className:"font-medium",children:e.quantity.toLocaleString()})}),a.jsx(j,{className:"text-right",children:L?a.jsx(m,{type:"number",value:e.unit_price_value,onChange:e=>D(s,"unit_price_value",e.target.value),className:"h-8 text-sm text-right"}):a.jsxs("span",{children:[(e.unit_price_value||0).toLocaleString()," ",k.currency]})}),a.jsx(j,{className:"text-right",children:L?a.jsx(m,{type:"number",value:e.amount_value,onChange:e=>D(s,"amount_value",e.target.value),className:"h-8 text-sm text-right font-medium"}):a.jsxs("span",{className:"font-medium",children:[(e.amount_value||0).toLocaleString()," ",k.currency]})}),a.jsx(j,{children:e.is_received?a.jsx(p,{className:"bg-green-100 text-green-800",children:"입고완료"}):a.jsx(p,{variant:"outline",children:"대기"})}),a.jsx(j,{children:L?a.jsx(m,{value:e.remark||"",onChange:e=>D(s,"remark",e.target.value),className:"h-8 text-sm",placeholder:"비고"}):a.jsx("div",{className:"sm:max-w-[150px]",children:a.jsx("span",{className:"text-sm text-gray-500 truncate block",title:e.remark,children:e.remark||"-"})})}),L&&a.jsx(j,{children:a.jsx(t,{variant:"ghost",size:"icon",onClick:()=>(e=>{const s=z.filter((s,a)=>a!==e);s.forEach((e,s)=>{e.line_number=s+1}),S(s)})(s),className:"h-8 w-8 text-red-500 hover:text-red-700",children:a.jsx(y,{className:"h-4 w-4"})})})]},e.id||s))})]})}),a.jsxs("div",{className:"flex-shrink-0 border-t pt-4 flex justify-between items-center",children:[a.jsxs("div",{className:"text-sm text-gray-500",children:["총 ",M.length,"개 품목"]}),a.jsxs("div",{className:"text-lg font-bold",children:["총 금액: ",O.toLocaleString()," ",k.currency]})]})]})})}export{w as default};
//# sourceMappingURL=PurchaseItemsModal-CrMpr80g.js.map
