const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/exceljs.min-Dd0dGkz7.js","assets/index-TtRH6l16.js","assets/index-B8I1hY2t.css","assets/PurchaseItemsModal-C5Lm9NXq.js","assets/input-csRifHlE.js","assets/index-Rc7R4liR.js","assets/PurchaseDetailModal-CZ632JHB.js","assets/helpers-CsHcdtkA.js","assets/calendar-qhHdpx5D.js","assets/chevron-right-DUcfZMBU.js","assets/chevron-down-BuO6WR8i.js","assets/popover-CzBgR5Tq.js","assets/calendar-C7lftRiE.js","assets/package-CvaLdhiN.js","assets/credit-card-CLnBl6Q6.js","assets/card-CbBAUqDt.js","assets/plus-CGmVGTEU.js","assets/save-FoAicKDD.js"])))=>i.map(i=>d[i]);
import{c as e,r as a,a as t,l as s,j as r,_ as l,e as n,f as i,g as c,h as d,i as o,k as m,B as u,X as p,U as h,u as x,m as g}from"./index-TtRH6l16.js";import{t as _,B as y}from"./index-Rc7R4liR.js";import{P as b}from"./PurchaseDetailModal-CZ632JHB.js";import{f,a as v}from"./helpers-CsHcdtkA.js";import{E as j}from"./eye-CJhwnejH.js";import{f as w,R as N,P as C,W as k,C as $,T as D,g as q,h as S,O as F,i as M,I as A}from"./input-csRifHlE.js";import{P as R,a as E,b as I}from"./popover-CzBgR5Tq.js";import{S as T,a as P,b as z,c as O,d as Y}from"./select-DKdrgw4L.js";import{C as U,f as B,a as L}from"./calendar-qhHdpx5D.js";import{C as W,a as J,b as G,c as K,d as V}from"./command-t3Xagjfk.js";import{C as H}from"./calendar-C7lftRiE.js";import{P as Z}from"./package-CvaLdhiN.js";import{C as X}from"./chevron-down-BuO6WR8i.js";import{A as Q}from"./arrow-up-down-BoJWI3GP.js";import{S as ee,C as ae,a as te,b as se,c as re}from"./card-CbBAUqDt.js";import{P as le}from"./plus-CGmVGTEU.js";import"./credit-card-CLnBl6Q6.js";import"./save-FoAicKDD.js";import"./chevron-right-DUcfZMBU.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=e("building",[["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M9 22v-3a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v3",key:"cabbwy"}],["rect",{x:"4",y:"2",width:"16",height:"20",rx:"2",key:"1uxh74"}]]),ie=e("dollar-sign",[["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}],["path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6",key:"1b0p4s"}]]),ce=e("info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]),de=e("sliders-vertical",[["line",{x1:"4",x2:"4",y1:"21",y2:"14",key:"1p332r"}],["line",{x1:"4",x2:"4",y1:"10",y2:"3",key:"gb41h5"}],["line",{x1:"12",x2:"12",y1:"21",y2:"12",key:"hf2csr"}],["line",{x1:"12",x2:"12",y1:"8",y2:"3",key:"1kfi7u"}],["line",{x1:"20",x2:"20",y1:"21",y2:"16",key:"1lhrwl"}],["line",{x1:"20",x2:"20",y1:"12",y2:"3",key:"16vvfq"}],["line",{x1:"2",x2:"6",y1:"14",y2:"14",key:"1uebub"}],["line",{x1:"10",x2:"14",y1:"8",y2:"8",key:"1yglbp"}],["line",{x1:"18",x2:"22",y1:"16",y2:"16",key:"1jxqpz"}]]),oe={purchases:null,lastFetch:0,userInfo:null,CACHE_DURATION:3e5,filteredData:new Map,FILTER_CACHE_DURATION:3e4},me=()=>{const e=Date.now(),r=oe.lastFetch&&e-oe.lastFetch<oe.CACHE_DURATION&&oe.purchases&&oe.purchases.length>0,[l,n]=a.useState(r?oe.purchases:[]),[i,c]=a.useState(!r),[d,o]=a.useState([]),[m,u]=a.useState(""),[p,h]=a.useState(""),[x,g]=a.useState(""),y=t(),b=a.useRef(!1),f=a.useRef(r);a.useEffect(()=>{(async()=>{if(b.current)return;b.current=!0;const e=Date.now(),a=oe.lastFetch&&e-oe.lastFetch<oe.CACHE_DURATION;try{if(a&&oe.userInfo)try{const e=oe.userInfo;if(e){let a=[];if(e.purchase_role)if(Array.isArray(e.purchase_role))a=e.purchase_role.map(e=>String(e).trim());else{a=String(e.purchase_role).split(",").map(e=>e.trim()).filter(e=>e.length>0)}o(a),u(e.name||e.full_name||""),h(e.email||""),g(e.id||"")}return}catch(t){s.error("캐시 데이터 사용 중 오류",t),oe.purchases=null,oe.userInfo=null,oe.lastFetch=0}const r=await y.auth.getUser();if(r.data.user&&!r.error){let a=null;if(r.data.user.email){a=(await y.from("employees").select("*").eq("email",r.data.user.email).maybeSingle()).data}if(a){oe.userInfo=a;let e=[];if(a.purchase_role)if(Array.isArray(a.purchase_role))e=a.purchase_role.map(e=>String(e).trim());else{e=String(a.purchase_role).split(",").map(e=>e.trim()).filter(e=>e.length>0)}o(e),u(a.name||a.full_name||""),h(a.email||""),g(a.id||"")}oe.lastFetch=e}}catch(t){s.error("초기 데이터 로드 실패",t)}})()},[]);const v=a.useCallback(async(e,a)=>{const t=!a?.silent&&!f.current;try{const r=Date.now(),l=oe.lastFetch&&r-oe.lastFetch<oe.CACHE_DURATION;if(e)oe.filteredData.clear(),oe.purchases=null,oe.lastFetch=0,f.current=!1,t&&c(!0);else{if(l&&oe.purchases)return n(oe.purchases),c(!1),f.current=!0,void(a?.silent||setTimeout(async()=>{try{await v(!0,{silent:!0})}catch(e){s.debug("백그라운드 데이터 업데이트 실패 (무시됨)",e)}},100));t&&!f.current&&c(!0)}const{data:{user:i},error:d}=await y.auth.getUser();if(d||!i)return s.error("사용자 인증 실패",d),_.error("로그인이 필요합니다."),void(t&&c(!1));const{data:o,error:m}=await y.from("purchase_requests").select("\n          *,\n          purchase_request_items(*)\n        ").order("request_date",{ascending:!1}).limit(1e3);if(m)throw m;let u=[],p=[],h=[];if(o&&o.length>0){const[e,a,t]=await Promise.all([y.from("employees").select("id, name, email"),y.from("vendors").select("id, vendor_name, vendor_payment_schedule"),y.from("vendor_contacts").select("id, contact_name")]);u=e.data||[],p=a.data||[],h=t.data||[]}const x=(new Date).toISOString().split("T")[0],g=((o||[]).filter(e=>e.request_date?.startsWith(x)),(o||[]).map(e=>{const a=e.purchase_request_items?.[0]||{},t=u.find(a=>a.id===e.requester_id),s=p.find(a=>a.id===e.vendor_id),r=h.find(a=>a.id===e.contact_id);return{id:Number(e.id),purchase_order_number:e.purchase_order_number,request_date:e.request_date,delivery_request_date:e.delivery_request_date??null,revised_delivery_request_date:e.revised_delivery_request_date??null,progress_type:e.progress_type,payment_completed_at:e.payment_completed_at,payment_completed_by_name:e.payment_completed_by_name,payment_category:e.payment_category,currency:e.currency,request_type:e.request_type,vendor:void 0,vendor_name:e.vendor_name||"",vendor_payment_schedule:s?.vendor_payment_schedule||"",vendor_contacts:[],requester_id:e.requester_id,requester_name:e.requester_name,requester_full_name:t?.name||e.requester_name||"",item_name:a.item_name||"",specification:a.specification||"",quantity:Number(a.quantity)||0,unit_price_value:Number(a.unit_price_value)||0,amount_value:Number(a.amount_value)||0,remark:a.remark||"",project_vendor:e.project_vendor,sales_order_number:e.sales_order_number,project_item:e.project_item,line_number:Number(a.line_number)||1,contact_name:r?.contact_name||"",middle_manager_status:e.middle_manager_status,final_manager_status:e.final_manager_status,is_received:!!e.is_received,received_at:e.received_at,is_payment_completed:!!e.is_payment_completed,is_utk_checked:!!e.is_utk_checked,is_statement_received:!!e.is_statement_received,is_po_download:!!e.is_po_download,link:a.link,items:(e.purchase_request_items||[]).sort((e,a)=>(e.line_number||0)-(a.line_number||0)),total_amount:e.purchase_request_items?.reduce((e,a)=>e+(Number(a.amount_value)||0),0)||0}}));n(g),oe.purchases=g,oe.lastFetch=r,f.current=!0}catch(r){s.error("발주 목록 로드 실패",r),_.error("발주 목록을 불러올 수 없습니다.")}finally{c(!1)}},[y]),j=a.useCallback((e,a)=>{n(t=>{const s=t.map(t=>t.id===e?a(t):t);return oe.purchases=s,s})},[]);return a.useEffect(()=>{f.current?setTimeout(()=>{v(!0,{silent:!0}).catch(()=>{})},100):v()},[v]),{purchases:l,loading:i,currentUserRoles:d,currentUserName:m,currentUserEmail:p,currentUserId:x,refreshPurchases:v,updatePurchaseOptimistic:j}},ue=a.memo(({purchase:e})=>{const a=e.is_received?"completed":"approved"===e.middle_manager_status&&"approved"===e.final_manager_status?"inProgress":"rejected"===e.middle_manager_status||"rejected"===e.final_manager_status?"rejected":"pending",{text:t,className:s}={completed:{text:"입고완료",className:"badge-success"},inProgress:{text:"구매진행",className:"badge-primary"},rejected:{text:"반려",className:"badge-danger"},pending:{text:"승인대기",className:"badge-warning"}}[a];return r.jsx(y,{variant:null,className:s,children:t})});ue.displayName="StatusBadge";const pe=a.memo(({purchase:e,onClick:a})=>{const t=(e=>{if(!e.items||0===e.items.length)return{received:0,total:0,percentage:0};const a=e.items.length,t=e.items.filter(e=>null!==e.actual_received_date&&void 0!==e.actual_received_date).length;return{received:t,total:a,percentage:a>0?Math.round(t/a*100):0}})(e),s="선진행"===e.progress_type||e.progress_type?.includes("선진행");return r.jsxs("div",{className:"bg-white rounded-lg border p-4 space-y-3 cursor-pointer transition-all hover:shadow-md "+(s?"border-red-400 bg-red-50 hover:bg-red-100":"hover:bg-gray-50"),onClick:()=>a(e),children:[r.jsxs("div",{className:"flex items-start justify-between",children:[r.jsxs("div",{children:[r.jsxs("div",{className:"flex items-center gap-2",children:[s?r.jsx(y,{variant:null,className:"badge-danger",children:"선진행"}):r.jsx(y,{variant:null,className:"badge-secondary",children:"일반"}),r.jsx("span",{className:"card-title text-gray-900",children:e.purchase_order_number||"-"})]}),r.jsxs("div",{className:"badge-text text-gray-500 mt-1",children:[f(e.request_date)," 요청"]})]}),r.jsx(ue,{purchase:e})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs("div",{className:"flex items-center justify-between card-subtitle",children:[r.jsx("span",{className:"text-gray-600",children:"요청자"}),r.jsx("span",{className:"card-title",children:e.requester_name})]}),r.jsxs("div",{className:"flex items-center justify-between card-subtitle",children:[r.jsx("span",{className:"text-gray-600",children:"업체"}),r.jsx("span",{className:"card-title",children:e.vendor_name})]}),e.project_vendor&&r.jsxs("div",{className:"flex items-center justify-between card-subtitle",children:[r.jsx("span",{className:"text-gray-600",children:"PJ업체"}),r.jsx("span",{className:"card-title truncate max-w-[150px]",children:e.project_vendor})]}),e.project_item&&r.jsxs("div",{className:"flex items-center justify-between card-subtitle",children:[r.jsx("span",{className:"text-gray-600",children:"PJ ITEM"}),r.jsx("span",{className:"card-title truncate max-w-[150px]",children:e.project_item})]}),e.sales_order_number&&r.jsxs("div",{className:"flex items-center justify-between card-subtitle",children:[r.jsx("span",{className:"text-gray-600",children:"수주번호"}),r.jsx("span",{className:"card-title truncate max-w-[150px]",children:e.sales_order_number})]}),e.item_name&&r.jsxs("div",{className:"flex items-center justify-between card-subtitle",children:[r.jsx("span",{className:"text-gray-600",children:"품목"}),r.jsx("span",{className:"card-title truncate max-w-[150px]",children:e.item_name})]}),r.jsxs("div",{className:"flex items-center justify-between card-subtitle",children:[r.jsx("span",{className:"text-gray-600",children:"금액"}),r.jsxs("span",{className:"font-semibold text-gray-900",children:[(e.amount_value||e.total_amount)?.toLocaleString()," ",e.currency]})]})]}),r.jsxs("div",{className:"space-y-1",children:[r.jsxs("div",{className:"flex items-center justify-between badge-text",children:[r.jsx("span",{className:"text-gray-600",children:"입고현황"}),r.jsxs("span",{className:"text-gray-700",children:[t.received,"/",t.total," (",t.percentage,"%)"]})]}),r.jsx("div",{className:"bg-gray-200 rounded-full h-2",children:r.jsx("div",{className:"h-2 rounded-full transition-all "+(100===t.percentage?"bg-green-500":t.percentage>0?"bg-hansl-500":"bg-gray-300"),style:{width:`${t.percentage}%`}})})]}),void 0!==e.is_payment_completed&&r.jsxs("div",{className:"flex items-center justify-between card-subtitle",children:[r.jsx("span",{className:"text-gray-600",children:"결제"}),e.is_payment_completed?r.jsx(y,{variant:null,className:"badge-success",children:"완료"}):r.jsx(y,{variant:null,className:"badge-secondary",children:"대기"})]}),r.jsx("div",{className:"pt-2 border-t",children:r.jsxs("div",{className:"flex items-center justify-center badge-text text-gray-500",children:[r.jsx(j,{className:"w-3 h-3 mr-1"}),"클릭하여 상세보기"]})})]})});pe.displayName="MobilePurchaseCard";const he=v;function xe(e){return e?["KRW","원","₩"].includes(e)?"₩":["USD","$","달러"].includes(e)?"$":["EUR","€"].includes(e)?"€":["JPY","엔","¥"].includes(e)||["CNY","위안","元"].includes(e)?"¥":e:""}var ge="AlertDialog",[_e,ye]=i(ge,[w]),be=w(),fe=e=>{const{__scopeAlertDialog:a,...t}=e,s=be(a);return r.jsx(N,{...s,...t,modal:!0})};fe.displayName=ge;a.forwardRef((e,a)=>{const{__scopeAlertDialog:t,...s}=e,l=be(t);return r.jsx(M,{...l,...s,ref:a})}).displayName="AlertDialogTrigger";var ve=e=>{const{__scopeAlertDialog:a,...t}=e,s=be(a);return r.jsx(C,{...s,...t})};ve.displayName="AlertDialogPortal";var je=a.forwardRef((e,a)=>{const{__scopeAlertDialog:t,...s}=e,l=be(t);return r.jsx(F,{...l,...s,ref:a})});je.displayName="AlertDialogOverlay";var we="AlertDialogContent",[Ne,Ce]=_e(we),ke=d("AlertDialogContent"),$e=a.forwardRef((e,t)=>{const{__scopeAlertDialog:s,children:l,...i}=e,d=be(s),o=a.useRef(null),m=n(t,o),u=a.useRef(null);return r.jsx(k,{contentName:we,titleName:De,docsSlug:"alert-dialog",children:r.jsx(Ne,{scope:s,cancelRef:u,children:r.jsxs($,{role:"alertdialog",...d,...i,ref:m,onOpenAutoFocus:c(i.onOpenAutoFocus,e=>{e.preventDefault(),u.current?.focus({preventScroll:!0})}),onPointerDownOutside:e=>e.preventDefault(),onInteractOutside:e=>e.preventDefault(),children:[r.jsx(ke,{children:l}),r.jsx(Ee,{contentRef:o})]})})})});$e.displayName=we;var De="AlertDialogTitle",qe=a.forwardRef((e,a)=>{const{__scopeAlertDialog:t,...s}=e,l=be(t);return r.jsx(D,{...l,...s,ref:a})});qe.displayName=De;var Se="AlertDialogDescription",Fe=a.forwardRef((e,a)=>{const{__scopeAlertDialog:t,...s}=e,l=be(t);return r.jsx(q,{...l,...s,ref:a})});Fe.displayName=Se;var Me=a.forwardRef((e,a)=>{const{__scopeAlertDialog:t,...s}=e,l=be(t);return r.jsx(S,{...l,...s,ref:a})});Me.displayName="AlertDialogAction";var Ae="AlertDialogCancel",Re=a.forwardRef((e,a)=>{const{__scopeAlertDialog:t,...s}=e,{cancelRef:l}=Ce(Ae,t),i=be(t),c=n(a,l);return r.jsx(S,{...i,...s,ref:c})});Re.displayName=Ae;var Ee=({contentRef:e})=>{const t=`\`${we}\` requires a description for the component to be accessible for screen reader users.\n\nYou can add a description to the \`${we}\` by passing a \`${Se}\` component as a child, which also benefits sighted users by adding visible context to the dialog.\n\nAlternatively, you can use your own component as a description by assigning it an \`id\` and passing the same value to the \`aria-describedby\` prop in \`${we}\`. If the description is confusing or duplicative for sighted users, you can use the \`@radix-ui/react-visually-hidden\` primitive as a wrapper around your description component.\n\nFor more information, see https://radix-ui.com/primitives/docs/components/alert-dialog`;return a.useEffect(()=>{document.getElementById(e.current?.getAttribute("aria-describedby"))},[t,e]),null},Ie=je,Te=$e,Pe=Me,ze=Re,Oe=qe,Ye=Fe;const Ue=fe,Be=ve,Le=a.forwardRef(({className:e,...a},t)=>r.jsx(Ie,{className:o("fixed inset-0 z-50 bg-black/40 backdrop-blur-sm","data-[state=open]:animate-in data-[state=closed]:animate-out","data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",e),...a,ref:t}));Le.displayName=Ie.displayName;const We=a.forwardRef(({className:e,...a},t)=>r.jsxs(Be,{children:[r.jsx(Le,{}),r.jsx(Te,{ref:t,className:o("fixed left-[50%] top-[50%] z-50","w-full max-w-md translate-x-[-50%] translate-y-[-50%]","grid gap-4 bg-white border border-gray-200","rounded-lg p-6 shadow-professional-xl","duration-200","data-[state=open]:animate-in data-[state=closed]:animate-out","data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0","data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95","data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%]","data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%]",e),...a})]}));We.displayName=Te.displayName;const Je=({className:e,...a})=>r.jsx("div",{className:o("flex flex-col space-y-2 text-left",e),...a});Je.displayName="AlertDialogHeader";const Ge=({className:e,...a})=>r.jsx("div",{className:o("flex flex-col-reverse sm:flex-row sm:justify-end gap-3",e),...a});Ge.displayName="AlertDialogFooter";const Ke=a.forwardRef(({className:e,...a},t)=>r.jsx(Oe,{ref:t,className:o("text-lg font-semibold text-gray-800 tracking-tight",e),...a}));Ke.displayName=Oe.displayName;const Ve=a.forwardRef(({className:e,...a},t)=>r.jsx(Ye,{ref:t,className:o("text-sm text-gray-600",e),...a}));Ve.displayName=Ye.displayName;const He=a.forwardRef(({className:e,...a},t)=>r.jsx(Pe,{ref:t,className:o(m(),e),...a}));He.displayName=Pe.displayName;const Ze=a.forwardRef(({className:e,...a},t)=>r.jsx(ze,{ref:t,className:o(m({variant:"outline"}),"mt-2 sm:mt-0",e),...a}));Ze.displayName=ze.displayName;const Xe=a.memo(({purchase:e})=>{const a=e.is_received?"completed":"approved"===e.middle_manager_status&&"approved"===e.final_manager_status?"inProgress":"rejected"===e.middle_manager_status||"rejected"===e.final_manager_status?"rejected":"pending",{text:t,className:s}={completed:{text:"입고완료",className:"badge-success"},inProgress:{text:"구매진행",className:"badge-primary"},rejected:{text:"반려",className:"badge-danger"},pending:{text:"승인대기",className:"badge-warning"}}[a];return r.jsx(y,{className:s,children:t})});Xe.displayName="StatusBadge";const Qe=e=>e?["KRW","원","₩"].includes(e)?"₩":["USD","$","달러"].includes(e)?"$":["EUR","€"].includes(e)?"€":["JPY","엔","¥"].includes(e)||["CNY","위안","元"].includes(e)?"¥":e:"₩",ea="text-center w-20 min-w-[85px] max-w-[85px]",aa="pl-2 w-38 min-w-[155px] max-w-[155px]",ta="pl-2 w-36 min-w-[140px] max-w-[140px]",sa="text-center w-20 min-w-[85px] max-w-[85px]",ra="w-16 min-w-[68px] max-w-[68px]",la="w-20 min-w-[85px] max-w-[85px]",na="w-28 min-w-[115px] max-w-[115px]",ia="w-16 min-w-[68px] max-w-[68px]",ca="w-20 min-w-[85px] max-w-[85px]",da="w-20 min-w-[85px] max-w-[85px]",oa="w-28 min-w-[120px] max-w-[120px]",ma="w-64 min-w-[260px] max-w-[260px]",ua="text-center w-14 min-w-[60px] max-w-[60px]",pa="text-right w-24 min-w-[100px] max-w-[100px]",ha="text-right w-24 min-w-[100px] max-w-[100px]",xa="w-28 min-w-[115px] max-w-[115px]",ga="w-24 min-w-[100px] max-w-[100px]",_a="w-24 min-w-[105px] max-w-[105px]",ya="w-28 min-w-[115px] max-w-[115px]",ba="w-44 min-w-[180px] max-w-[180px]",fa="text-center w-20 min-w-[85px] max-w-[85px]",va="text-center w-20 min-w-[85px] max-w-[85px]",ja="text-center w-24 min-w-[100px] max-w-[100px]",wa="w-20 min-w-[85px] max-w-[85px]",Na="text-center w-12 min-w-[50px] max-w-[50px]",Ca=a.memo(({purchase:e})=>{const a="approved"===e.middle_manager_status,t="rejected"===e.middle_manager_status,s="approved"===e.final_manager_status,l="rejected"===e.final_manager_status;return t||l?r.jsxs("div",{className:"flex flex-col items-center gap-0.5",children:[r.jsx("div",{className:"flex items-center gap-0.5",children:r.jsx("div",{className:"w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse"})}),r.jsx(y,{variant:null,className:"badge-danger",children:"반려"})]}):a&&s?r.jsxs("div",{className:"flex flex-col items-center gap-0.5",children:[r.jsx("div",{className:"flex items-center gap-0.5",children:r.jsx("div",{className:"w-1.5 h-1.5 bg-green-500 rounded-full"})}),r.jsx(y,{variant:null,className:"badge-success",children:"승인완료"})]}):!a||s||l?r.jsxs("div",{className:"flex flex-col items-center gap-0.5",children:[r.jsxs("div",{className:"flex items-center gap-1",children:[r.jsx("div",{className:"w-1.5 h-1.5 bg-gray-300 rounded-full"}),r.jsx("div",{className:"w-3 h-0.5 bg-gray-300"}),r.jsx("div",{className:"w-1.5 h-1.5 bg-gray-300 rounded-full"})]}),r.jsx(y,{variant:null,className:"badge-secondary",children:"승인대기"})]}):r.jsxs("div",{className:"flex flex-col items-center gap-0.5",children:[r.jsxs("div",{className:"flex items-center gap-1",children:[r.jsx("div",{className:"w-1.5 h-1.5 bg-green-500 rounded-full"}),r.jsx("div",{className:"w-3 h-0.5 bg-gray-300"}),r.jsx("div",{className:"w-1.5 h-1.5 bg-gray-300 rounded-full"})]}),r.jsx(y,{variant:null,className:"badge-warning",children:"1차 승인"})]})});Ca.displayName="ApprovalStatusBadge";a.memo(({type:e})=>"선진행"===e||e?.includes("선진행")?r.jsx(y,{variant:null,className:"badge-danger",children:"선진행"}):r.jsx(y,{variant:null,className:"badge-secondary",children:"일반"})).displayName="ProgressTypeBadge";const ka=a.memo(({purchase:e,onClick:a,activeTab:t,isLeadBuyer:s,onPaymentComplete:l,onReceiptComplete:n,onExcelDownload:i})=>{const c=(e=>{if(!e.items||0===e.items.length)return{received:0,total:1,percentage:0};const a=e.items.length,t=e.items.filter(e=>null!==e.actual_received_date&&void 0!==e.actual_received_date).length;return{received:t,total:a,percentage:a>0?Math.round(t/a*100):0}})(e),d=(e=>{if(e.is_payment_completed)return{completed:1,total:1,percentage:100};if(!e.items||0===e.items.length)return{completed:0,total:1,percentage:0};const a=e.items.length,t=e.items.filter(e=>!0===e.is_payment_completed).length;return{completed:t,total:a,percentage:a>0?Math.round(t/a*100):0}})(e),o=(e=>{if(!e.items||0===e.items.length)return{completed:0,total:1,percentage:0};const a=e.items.length,t=e.items.filter(e=>!0===e.is_statement_received).length;return{completed:t,total:a,percentage:a>0?Math.round(t/a*100):0}})(e),m="선진행"===e.progress_type||e.progress_type?.includes("선진행");return r.jsxs("tr",{className:"border-b hover:bg-gray-100 cursor-pointer transition-colors "+(m?"bg-red-50 hover:bg-red-100":""),onClick:()=>a(e),children:["pending"===t&&r.jsx("td",{className:`px-2 py-1.5 whitespace-nowrap ${ea}`,children:r.jsx(Ca,{purchase:e})}),"purchase"===t&&r.jsx("td",{className:`px-2 py-1.5 ${fa}`,children:r.jsxs("div",{className:"flex items-center justify-center gap-1",children:[r.jsx("div",{className:"bg-gray-200 rounded-full h-1.5 w-8",children:r.jsx("div",{className:"h-1.5 rounded-full "+(100===d.percentage?"bg-blue-500":d.percentage>0?"bg-blue-400":"bg-gray-300"),style:{width:`${d.percentage}%`}})}),r.jsxs("span",{className:"card-title text-gray-600",children:[d.percentage,"%"]})]})}),"receipt"===t&&r.jsx("td",{className:`px-2 py-1.5 ${fa}`,children:r.jsxs("div",{className:"flex items-center justify-center gap-1",children:[r.jsx("div",{className:"bg-gray-200 rounded-full h-1.5 w-8",children:r.jsx("div",{className:"h-1.5 rounded-full "+(100===c.percentage?"bg-green-500":c.percentage>0?"bg-hansl-500":"bg-gray-300"),style:{width:`${c.percentage}%`}})}),r.jsxs("span",{className:"card-title text-gray-600",children:[c.percentage,"%"]})]})}),"done"===t&&r.jsx("td",{className:`px-2 py-1.5 ${fa}`,children:r.jsxs("div",{className:"flex items-center justify-center gap-1",children:[r.jsx("div",{className:"bg-gray-200 rounded-full h-1.5 w-8",children:r.jsx("div",{className:"h-1.5 rounded-full "+(100===o.percentage?"bg-green-500":o.percentage>0?"bg-hansl-500":"bg-gray-300"),style:{width:`${o.percentage}%`}})}),r.jsxs("span",{className:"card-title text-gray-600",children:[o.percentage,"%"]})]})}),r.jsx("td",{className:`px-2 py-1.5 card-title whitespace-nowrap ${"purchase"===t?ta:aa}`,children:r.jsxs("div",{className:"flex items-center gap-1",children:[i&&r.jsx("img",{src:"/excels-icon.svg",alt:"엑셀 다운로드",width:"16",height:"16",className:`inline-block align-middle transition-transform p-0.5 rounded\n                ${e.is_po_download?"border border-gray-400":""}\n                ${"선진행"===e.progress_type||e.progress_type?.includes("선진행")||"approved"===e.middle_manager_status&&"approved"===e.final_manager_status?e.is_po_download?"cursor-pointer":"cursor-pointer hover:scale-110":"opacity-40 grayscale cursor-not-allowed"}`,onClick:async a=>{("선진행"===e.progress_type||e.progress_type?.includes("선진행")||"approved"===e.middle_manager_status&&"approved"===e.final_manager_status)&&(a.stopPropagation(),await i(e))},style:{pointerEvents:"선진행"===e.progress_type||e.progress_type?.includes("선진행")||"approved"===e.middle_manager_status&&"approved"===e.final_manager_status?"auto":"none"},title:e.is_po_download?"다운로드 완료":"엑셀 발주서 다운로드"}),r.jsxs("span",{className:"block truncate",title:e.purchase_order_number||"",children:[e.purchase_order_number||"-",e.items&&e.items.length>1&&r.jsxs("span",{className:"text-gray-500 ml-0.5",children:["(",e.items.length,")"]})]})]})}),("pending"===t||"purchase"===t||"receipt"===t||"done"===t||!t)&&r.jsx("td",{className:`px-2 py-1.5 card-title whitespace-nowrap ${sa}`,children:r.jsx(y,{variant:null,className:"구매요청"===e.payment_category||"구매 요청"===e.payment_category?"badge-primary":"발주"===e.payment_category?"badge-success":("현장결제"===e.payment_category||"현장 결제"===e.payment_category||e.payment_category,"badge-secondary"),children:"발주"===e.payment_category?"발주요청":"구매 요청"===e.payment_category?"구매요청":"현장 결제"===e.payment_category?"현장결제":e.payment_category||"-"})}),r.jsx("td",{className:`px-2 py-1.5 card-title whitespace-nowrap ${ra}`,children:r.jsx("span",{className:"block truncate",title:e.requester_name||"",children:e.requester_name||"-"})}),r.jsx("td",{className:`pl-2 pr-0 py-1.5 card-title whitespace-nowrap ${la}`,children:f(e.request_date)}),"done"===t&&r.jsx("td",{className:`pl-0 pr-2 py-1.5 card-title whitespace-nowrap text-center ${Na}`,children:r.jsx(y,{variant:null,className:e.is_utk_checked?"bg-orange-500 text-white":"bg-white border border-gray-300 text-gray-600",children:e.is_utk_checked?"완료":"대기"})}),r.jsx("td",{className:`pl-2 pr-2 py-1.5 card-title ${na}`,children:r.jsx("span",{className:"block truncate",title:e.vendor_name||"",children:e.vendor_name||"-"})}),r.jsx("td",{className:`px-2 py-1.5 card-title whitespace-nowrap ${ia}`,children:r.jsx("span",{className:"block truncate",title:e.contact_name||"",children:e.contact_name||"-"})}),r.jsx("td",{className:`px-2 py-1.5 card-title whitespace-nowrap ${ca} ${e.revised_delivery_request_date?"text-gray-400":""}`,children:f(e.delivery_request_date)}),("receipt"===t||"done"===t||!t)&&r.jsx("td",{className:`px-2 py-1.5 card-title whitespace-nowrap ${da}`,children:f(e.revised_delivery_request_date)}),r.jsx("td",{className:`px-2 py-1.5 card-title ${oa}`,children:r.jsx("span",{className:"block truncate",title:e.item_name||"",children:e.item_name||"-"})}),r.jsx("td",{className:`px-2 py-1.5 card-title ${ma}`,children:r.jsx("span",{className:"block truncate",title:e.specification||"",children:e.specification||"-"})}),r.jsx("td",{className:`px-2 py-1.5 card-title whitespace-nowrap ${ua}`,children:e.quantity||0}),r.jsx("td",{className:`px-2 py-1.5 card-title whitespace-nowrap ${pa}`,children:e.unit_price_value?`${e.unit_price_value.toLocaleString()} ${Qe(e.currency||"KRW")}`:`0 ${Qe(e.currency||"KRW")}`}),r.jsx("td",{className:`px-2 py-1.5 card-amount whitespace-nowrap ${ha}`,children:e.amount_value?`${e.amount_value.toLocaleString()} ${Qe(e.currency||"KRW")}`:e.total_amount?`${e.total_amount.toLocaleString()} ${Qe(e.currency||"KRW")}`:`0 ${Qe(e.currency||"KRW")}`}),"pending"===t&&r.jsxs(r.Fragment,{children:[r.jsx("td",{className:`px-2 py-1.5 card-title ${xa}`,children:r.jsx("span",{className:"block truncate",title:e.remark||"",children:e.remark||"-"})}),r.jsx("td",{className:`px-2 py-1.5 card-title ${_a}`,children:r.jsx("span",{className:"block truncate",title:e.project_vendor||"",children:e.project_vendor||"-"})}),r.jsx("td",{className:`px-2 py-1.5 card-title ${ba}`,children:r.jsx("span",{className:"block truncate",title:e.project_item||"",children:e.project_item||"-"})}),r.jsx("td",{className:`px-2 py-1.5 card-title whitespace-nowrap ${ya}`,children:r.jsx("span",{className:"block truncate",title:e.sales_order_number||"",children:e.sales_order_number||"-"})})]}),"purchase"===t&&r.jsxs(r.Fragment,{children:[r.jsx("td",{className:`px-2 py-1.5 card-title ${xa}`,children:r.jsx("span",{className:"block truncate",title:e.remark||"",children:e.remark||"-"})}),r.jsx("td",{className:`px-2 py-1.5 card-title ${wa}`,children:e.link?r.jsx("a",{href:e.link,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:text-blue-800 underline truncate block",title:e.link,children:"링크 보기"}):r.jsx("span",{className:"text-gray-400",children:"-"})}),"receipt"!==t&&r.jsx("td",{className:`px-2 py-1.5 card-title whitespace-nowrap ${ga}`,children:r.jsx("span",{className:"block truncate",title:e.vendor_payment_schedule||"",children:e.vendor_payment_schedule||"-"})})]}),"receipt"===t&&r.jsxs(r.Fragment,{children:[r.jsx("td",{className:`px-2 py-1.5 card-title ${xa}`,children:r.jsx("span",{className:"block truncate",title:e.remark||"",children:e.remark||"-"})}),r.jsx("td",{className:`px-2 py-1.5 card-title ${_a}`,children:r.jsx("span",{className:"block truncate",title:e.project_vendor||"",children:e.project_vendor||"-"})}),r.jsx("td",{className:`px-2 py-1.5 card-title ${ba}`,children:r.jsx("span",{className:"block truncate",title:e.project_item||"",children:e.project_item||"-"})}),r.jsx("td",{className:`px-2 py-1.5 card-title whitespace-nowrap ${ya}`,children:r.jsx("span",{className:"block truncate",title:e.sales_order_number||"",children:e.sales_order_number||"-"})})]}),("done"===t||!t)&&r.jsxs(r.Fragment,{children:[r.jsx("td",{className:`px-2 py-1.5 card-title ${xa}`,children:r.jsx("span",{className:"block truncate",title:e.remark||"",children:e.remark||"-"})}),r.jsx("td",{className:`px-2 py-1.5 card-title ${wa}`,children:e.link?r.jsx("a",{href:e.link,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:text-blue-800 underline truncate block",title:e.link,children:"링크 보기"}):r.jsx("span",{className:"text-gray-400",children:"-"})}),r.jsx("td",{className:`px-2 py-1.5 card-title ${_a}`,children:r.jsx("span",{className:"block truncate",title:e.project_vendor||"",children:e.project_vendor||"-"})}),r.jsx("td",{className:`px-2 py-1.5 card-title ${ba}`,children:r.jsx("span",{className:"block truncate",title:e.project_item||"",children:e.project_item||"-"})}),r.jsx("td",{className:`px-2 py-1.5 card-title whitespace-nowrap ${ya}`,children:r.jsx("span",{className:"block truncate",title:e.sales_order_number||"",children:e.sales_order_number||"-"})}),r.jsx("td",{className:`px-2 py-1.5 card-title whitespace-nowrap ${ga}`,children:r.jsx("span",{className:"block truncate",title:e.vendor_payment_schedule||"",children:e.vendor_payment_schedule||"-"})}),r.jsx("td",{className:`px-2 py-1.5 ${va}`,children:r.jsx("span",{className:"text-gray-400 card-title",children:"-"})}),r.jsx("td",{className:`px-2 py-1.5 ${ja}`,children:r.jsxs("div",{className:"flex items-center justify-center gap-1",children:[r.jsx("div",{className:"bg-gray-200 rounded-full h-1.5 w-8",children:r.jsx("div",{className:"h-1.5 rounded-full "+(100===c.percentage?"bg-green-500":c.percentage>0?"bg-hansl-500":"bg-gray-300"),style:{width:`${c.percentage}%`}})}),r.jsxs("span",{className:"card-title text-gray-600",children:[c.percentage,"%"]})]})})]})]})});ka.displayName="TableRow";const $a=a.memo(({purchases:e,activeTab:n="done",currentUserRoles:i=[],onRefresh:c,onOptimisticUpdate:d,onPaymentComplete:o,onReceiptComplete:m})=>{const[u,p]=a.useState(null),[h,x]=a.useState(!1),[g,y]=a.useState(!1),[f,v]=a.useState(null),j=t(),w=i&&(i.includes("lead buyer")||i.includes("app_admin"));i.includes("final_approver")||i.includes("app_admin")||i.includes("ceo");const N=a.useCallback(e=>{p(e.id),x(!0)},[]),C=a.useCallback(()=>{x(!1),p(null)},[]),k=a.useCallback(async e=>{try{const{data:s,error:r}=await j.from("purchase_requests").select("*").eq("purchase_order_number",e.purchase_order_number).single();if(r||!s)return void _.error("해당 발주요청번호의 데이터를 찾을 수 없습니다.");const{data:n,error:d}=await j.from("purchase_request_items").select("*").eq("purchase_order_number",e.purchase_order_number).order("line_number");if(d||!n||0===n.length)return void _.error("해당 발주요청번호의 품목 데이터를 찾을 수 없습니다.");const o={vendor_name:e.vendor_name,vendor_phone:"",vendor_fax:"",vendor_contact_name:"",vendor_payment_schedule:""};try{const a=s.vendor_id||e.vendor_id,t=s.contact_id||e.contact_id;if(a){const{data:e}=await j.from("vendors").select("vendor_phone, vendor_fax, vendor_payment_schedule").eq("id",a).single();e&&(o.vendor_phone=e.vendor_phone||"",o.vendor_fax=e.vendor_fax||"",o.vendor_payment_schedule=e.vendor_payment_schedule||"")}if(t){const{data:e}=await j.from("vendor_contacts").select("contact_name, contact_phone, contact_email").eq("id",t).single();e&&(o.vendor_contact_name=e.contact_name||"")}}catch(a){}const m={purchase_order_number:s.purchase_order_number||"",request_date:s.request_date,delivery_request_date:s.delivery_request_date,requester_name:s.requester_name,vendor_name:o.vendor_name||"",vendor_contact_name:o.vendor_contact_name,vendor_phone:o.vendor_phone,vendor_fax:o.vendor_fax,project_vendor:s.project_vendor,sales_order_number:s.sales_order_number,project_item:s.project_item,vendor_payment_schedule:o.vendor_payment_schedule,items:n.map(e=>({line_number:e.line_number,item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark,currency:s.currency||"KRW"}))},u=await async function(e){const a=new((await l(()=>import("./exceljs.min-Dd0dGkz7.js").then(e=>e.e),__vite__mapDeps([0,1,2]))).Workbook),t=a.addWorksheet("발주서",{pageSetup:{paperSize:9,orientation:"portrait",fitToPage:!0,fitToWidth:1,fitToHeight:1,horizontalCentered:!0,verticalCentered:!0,margins:{left:.3,right:.3,top:.5,bottom:.5,header:.2,footer:.2}}});t.getRow(1).height=29.8;for(let l=2;l<=60;l++)t.getRow(l).height=15.75;t.getRow(1).eachCell(e=>{e.font={...e.font||{},name:"맑은 고딕",size:20}});for(let l=2;l<=60;l++)t.getRow(l).eachCell(e=>{e.font={...e.font||{},name:"맑은 고딕",size:11}});t.mergeCells("A1:G1"),t.mergeCells("A2:B2"),t.mergeCells("C2:D2"),t.mergeCells("F2:G2"),t.mergeCells("A3:B3"),t.mergeCells("C3:D3"),t.mergeCells("F3:G3"),t.mergeCells("A4:B4"),t.mergeCells("C4:D4"),t.mergeCells("F4:G4"),t.mergeCells("A5:B5"),t.mergeCells("C5:D5"),t.mergeCells("F5:G5"),t.mergeCells("A6:B6"),t.mergeCells("C6:D6"),t.mergeCells("F6:G6"),t.mergeCells("A7:B7"),t.mergeCells("C7:D7"),t.mergeCells("F7:G7");try{const e=await fetch("/logo_KOR.png"),s=await e.arrayBuffer(),r=a.addImage({buffer:s,extension:"png"}),l=t.getColumn("D").width||22,n=Math.max(1,7.2*l*.58)+4,i=34,c=3,d=.3;t.addImage(r,{tl:{col:c,row:d},ext:{width:n,height:i}})}catch(p){}t.getCell("D1").value="                발 주 서",t.getCell("D1").alignment={horizontal:"left",vertical:"middle",indent:1},t.getCell("D1").font={bold:!0,size:20},t.getCell("A2").value="업   체   명",t.getCell("A2").font={bold:!0},t.getCell("A3").value="담   당   자",t.getCell("A3").font={bold:!0},t.getCell("A4").value="청   구   일",t.getCell("A4").font={bold:!0},t.getCell("A5").value="TEL.",t.getCell("A5").font={bold:!0},t.getCell("A6").value="FAX.",t.getCell("A6").font={bold:!0},t.getCell("A7").value="입고요청일",t.getCell("A7").font={bold:!0},t.getCell("E2").value="구매요청자",t.getCell("E2").font={bold:!0},t.getCell("E3").value="주         소",t.getCell("E3").font={bold:!0},t.getCell("E4").value="발 주 번 호",t.getCell("E4").font={bold:!0},t.getCell("E5").value="TEL.",t.getCell("E5").font={bold:!0},t.getCell("E6").value="FAX.",t.getCell("E6").font={bold:!0},t.getCell("E7").value="지출 예정일",t.getCell("E7").font={bold:!0},t.getCell("F7").value=e.vendor_payment_schedule||"",t.getCell("C2").value=e.vendor_name,t.getCell("C3").value=e.vendor_contact_name||"",t.getCell("C4").value=he(e.request_date),t.getCell("C5").value=e.vendor_phone||"",t.getCell("C6").value=e.vendor_fax||"",t.getCell("C7").value=he(e.delivery_request_date),t.getCell("F2").value=e.requester_name,t.getCell("F3").value="대구광역시 달서구 성서공단북로305",t.getCell("F4").value=e.purchase_order_number,t.getCell("F5").value="(053) 626-7805",t.getCell("F6").value="(053) 657-7905",t.getCell("F5").alignment={horizontal:"center",vertical:"middle"},t.getCell("F6").alignment={horizontal:"center",vertical:"middle"};const s=["No","품명","규격","수량","단가","금액","비고"];for(let l=0;l<s.length;l++)t.getCell(String.fromCharCode(65+l)+"8").value=s[l],t.getCell(String.fromCharCode(65+l)+"8").font={bold:!0},6===l&&(t.getCell("G8").alignment={horizontal:"center",vertical:"middle"});const r=[...e.items].sort((e,a)=>e.line_number-a.line_number),n=r.length,i=9+Math.max(n,45);for(let l=0;l<r.length;l++){const e=r[l],a=9+l;t.getCell("A"+a).value=e.line_number;const s=t.getCell("B"+a);s.value=e.item_name,s.alignment={horizontal:"left",vertical:"middle"},t.getCell("C"+a).value=e.specification,t.getCell("C"+a).alignment={horizontal:"left",vertical:"middle"},t.getCell("D"+a).value=e.quantity;const n=xe(e.currency),i=void 0!==e.unit_price_value&&null!==e.unit_price_value?`${e.unit_price_value.toLocaleString()} ${n}`.trim():"";t.getCell("E"+a).value=i,t.getCell("E"+a).alignment={horizontal:"right",vertical:"middle"};const c=xe(e.currency),d=void 0!==e.amount_value&&null!==e.amount_value?`${e.amount_value.toLocaleString()} ${c}`.trim():"";t.getCell("F"+a).value=d,t.getCell("F"+a).alignment={horizontal:"right",vertical:"middle"};const o=t.getCell("G"+a);o.value=void 0!==e.remark&&null!==e.remark?String(e.remark):"",o.alignment={horizontal:"left",vertical:"middle",wrapText:!1,shrinkToFit:!0}}for(let l=n;l<45;l++){const e=9+l;for(let a=0;a<7;a++)t.getCell(String.fromCharCode(65+a)+e).value=""}t.mergeCells(`A${i}:E${i}`),t.getCell("A"+i).value="합계",t.getCell("A"+i).font={bold:!0};const c=xe(e.items[0]?.currency),d=e.items.reduce((e,a)=>e+(a.amount_value||0),0);t.getCell("F"+i).value=`${d.toLocaleString()} ${c}`.trim(),t.getCell("F"+i).alignment={horizontal:"right",vertical:"middle"};const o=i;for(let l=1;l<=o;l++)for(let e=1;e<=7;e++){const a=String.fromCharCode(64+e)+l,s=t.getCell(a),r=l>=9&&l<i;(5===e||6===e)&&(r||l===i)||3===e&&r||(s.alignment={horizontal:"center",vertical:"middle"}),s.border={top:{style:1===l||2===l||8===l||l===i?"medium":"thin"},left:{style:1===e?"medium":"thin"},right:{style:7===e?"medium":"thin"},bottom:{style:8===l||l===i||l===o?"medium":"thin"}}}for(let l=0;l<n;l++){const e=9+l;t.getCell("C"+e).alignment={horizontal:"left",vertical:"middle"}}for(let l=2;l<=7;l++)t.getCell("B"+l).border={...t.getCell("B"+l).border,right:{style:"medium"}},t.getCell("D"+l).border={...t.getCell("D"+l).border,right:{style:"medium"}},l<=6&&(t.getCell("E"+l).border={...t.getCell("E"+l).border,right:{style:"medium"}});t.getCell("E7").border={...t.getCell("E7").border,top:{style:"thin"},right:{style:"medium"}},t.getCell("G7").border={...t.getCell("G7").border,top:{style:"thin"}};for(let l=1;l<=7;l++){const e=t.getCell("A"+l).border||{};t.getCell("A"+l).border={...e,left:{style:"medium"}}}const m=t.getCell("A"+i).border||{};t.getCell("A"+i).border={...m,left:{style:"medium"}},Object.entries({A:4.7,B:23,C:30,D:11,E:15,F:16,G:37}).forEach(([e,a])=>{t.getColumn(e).width=a}),t.getRow(1).height=29.8,t.getRow(1).eachCell(e=>{e.font={...e.font||{},name:"맑은 고딕",size:20}});for(let l=2;l<=o;l++){const e=t.getRow(l);e.height=15.75,e.eachCell(e=>{e.font={...e.font||{},name:"맑은 고딕",size:11}})}for(let l=9;l<=o;l++)t.getCell("G"+l).alignment={horizontal:"left",vertical:"middle",wrapText:!1,shrinkToFit:!0},t.getCell("B"+l).alignment={horizontal:"left",vertical:"middle"};const u=await a.xlsx.writeBuffer();return new Blob([u],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"})}(m),p=`발주서_${m.vendor_name}_${m.purchase_order_number}.xlsx`,h=window.URL.createObjectURL(u),x=document.createElement("a");x.href=h,x.download=p,document.body.appendChild(x),x.click(),document.body.removeChild(x),window.URL.revokeObjectURL(h),_.success("엑셀 파일이 다운로드되었습니다.");try{if(i&&i.includes("lead buyer")){const{error:a}=await j.from("purchase_requests").update({is_po_download:!0}).eq("purchase_order_number",e.purchase_order_number);a||c?.()}}catch(t){}}catch(a){_.error("엑셀 다운로드에 실패했습니다.")}},[j]),$=a.useCallback(async()=>{if(f){s.debug("발주 삭제 확인",{id:f.id,purchase_order_number:f.purchase_order_number,requester_name:f.requester_name,final_manager_status:f.final_manager_status});try{const e="https://qvhbigvdfyvhoegkhvef.supabase.co";if(!e||!"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2aGJpZ3ZkZnl2aG9lZ2todmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc4MTQzNjAsImV4cCI6MjA2MzM5MDM2MH0.7VZlSwnNuE0MaQpDjuzeZFgjJrDBQOWA_COyqaM8Rbg"||e.includes("placeholder"))return s.warn("Supabase 환경 변수가 설정되지 않음 - FastPurchaseTable"),void _.error("환경 설정 오류가 발생했습니다.");const{data:{user:a},error:t}=await j.auth.getUser();if(t||!a)return void _.error("로그인이 필요합니다.");const{data:r,error:l}=await j.from("employees").select("name, email, purchase_role").eq("email",a.email).single();if(s.debug("사용자 권한 확인",{employee:r?.name,roles:r?.purchase_role,email:r?.email}),l||!r)return void _.error("사용자 권한을 확인할 수 없습니다.");let n=[];if(r.purchase_role)if(Array.isArray(r.purchase_role))n=r.purchase_role.map(e=>String(e).trim());else{n=String(r.purchase_role).split(",").map(e=>e.trim()).filter(e=>e.length>0)}const i=n.includes("final_approver")||n.includes("app_admin")||n.includes("ceo"),d="approved"===f.final_manager_status,o=f.requester_name===r.name,m=d?i:i||o;if(s.debug("삭제 권한 확인",{canEdit:i,isApproved:d,isRequester:o,canDeleteThis:m,userRoles:n}),!m)return void _.error("삭제 권한이 없습니다.");const{data:u,error:p}=await j.from("purchase_request_items").delete().eq("purchase_request_id",f.id).select();if(p)throw s.error("아이템 삭제 중 오류 발생",p,{code:p.code,message:p.message,details:p.details,hint:p.hint}),p;s.debug("아이템 삭제 완료",{deletedItemsCount:u?.length||0,purchaseRequestId:f.id});const{data:h,error:x}=await j.from("purchase_requests").delete().eq("id",f.id).select();if(x)throw s.error("발주요청 삭제 중 오류 발생",x,{code:x.code,message:x.message,details:x.details,hint:x.hint}),x;s.debug("발주요청 삭제 완료",{deletedRequestId:f.id,purchase_order_number:f.purchase_order_number}),_.success("발주요청 내역이 삭제되었습니다."),c?.()}catch(e){const a=e;s.error("발주요청 삭제 중 예외 발생",a,{name:a?.name,message:a?.message,code:a?.code,details:a?.details,hint:a?.hint,stack:a?.stack}),_.error(`삭제 중 오류가 발생했습니다: ${a?.message||"알 수 없는 오류"}`)}y(!1),v(null)}},[j,f,c]),D=a.useMemo(()=>{if("pending"===n)return r.jsx("thead",{className:"bg-gray-50",children:r.jsxs("tr",{children:[r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap ${ea}`,children:"승인상태"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap text-left ${aa}`,children:"발주번호"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap ${sa}`,children:"결제종류"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap text-left ${ra}`,children:"요청자"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap text-left ${la}`,children:"청구일"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 text-left ${na}`,children:"업체"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap text-left ${ia}`,children:"담당자"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap text-left ${ca}`,children:"입고요청일"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 text-left ${oa}`,children:"품명"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 text-left ${ma}`,children:"규격"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap ${ua}`,children:"수량"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap ${pa}`,children:"단가"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap ${ha}`,children:"합계"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap text-left ${xa}`,children:"비고"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap text-left ${_a}`,children:"PJ업체"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap text-left ${ba}`,children:"PJ ITEM"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap text-left ${ya}`,children:"수주번호"})]})});const e=r.jsxs(r.Fragment,{children:[r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap text-left ${"purchase"===n?ta:aa}`,children:"발주번호"}),("purchase"===n||"receipt"===n||"done"===n||!n)&&r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap ${sa}`,children:"결제종류"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap text-left ${ra}`,children:"요청자"}),r.jsx("th",{className:`pl-2 pr-0 py-1.5 modal-label text-gray-900 whitespace-nowrap text-left ${la}`,children:"청구일"}),"done"===n&&r.jsx("th",{className:`pl-0 pr-2 py-1.5 modal-label text-gray-900 whitespace-nowrap text-center ${Na}`,children:"UTK"}),r.jsx("th",{className:`pl-2 pr-2 py-1.5 modal-label text-gray-900 whitespace-nowrap text-left ${na}`,children:"업체"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap text-left ${ia}`,children:"담당자"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap text-left ${ca}`,children:"입고요청일"}),("receipt"===n||"done"===n||!n)&&r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap text-left ${da}`,children:"변경 입고일"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 text-left ${oa}`,children:"품명"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 text-left ${ma}`,children:"규격"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap ${ua}`,children:"수량"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap ${pa}`,children:"단가"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap ${ha}`,children:"합계"})]});let a=null;return a="purchase"===n?r.jsxs(r.Fragment,{children:[r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap text-left ${xa}`,children:"비고"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap text-left ${wa}`,children:"링크"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap text-left ${ga}`,children:"지출예정일"})]}):"receipt"===n?r.jsxs(r.Fragment,{children:[r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap text-left ${xa}`,children:"비고"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap text-left ${_a}`,children:"PJ업체"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap text-left ${ba}`,children:"PJ ITEM"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap text-left ${ya}`,children:"수주번호"})]}):r.jsxs(r.Fragment,{children:[r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap text-left ${xa}`,children:"비고"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap text-left ${wa}`,children:"링크"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap text-left ${_a}`,children:"PJ업체"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap text-left ${ba}`,children:"PJ ITEM"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap text-left ${ya}`,children:"수주번호"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap text-left ${ga}`,children:"지출예정일"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap ${va}`,children:"구매진행"}),r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap ${ja}`,children:"입고진행"})]}),r.jsx("thead",{className:"bg-gray-50",children:r.jsxs("tr",{children:["purchase"===n&&r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap ${fa}`,children:"구매진행"}),"receipt"===n&&r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap ${fa}`,children:"입고진행"}),"done"===n&&r.jsx("th",{className:`px-2 py-1.5 modal-label text-gray-900 whitespace-nowrap ${fa}`,children:"거래명세서"}),e,a]})})},[n]);return r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"hidden md:block w-full",children:r.jsx("div",{className:"overflow-x-auto border rounded-lg",children:r.jsxs("table",{className:"w-full min-w-[1790px] border-collapse",children:[D,r.jsx("tbody",{children:e.map(e=>r.jsx(ka,{purchase:e,onClick:N,activeTab:n,isLeadBuyer:w,onPaymentComplete:o,onReceiptComplete:m,onExcelDownload:k},e.id))})]})})}),r.jsx("div",{className:"hidden sm:block md:hidden w-full",children:r.jsx("div",{className:"overflow-x-auto border rounded-lg",children:r.jsxs("table",{className:"w-full min-w-[600px] card-title",children:[r.jsx("thead",{className:"bg-gray-50",children:r.jsxs("tr",{children:[r.jsx("th",{className:"text-left p-2 modal-label text-gray-900 w-24",children:"발주번호"}),r.jsx("th",{className:"text-left p-2 modal-label text-gray-900 w-16",children:"요청자"}),r.jsx("th",{className:"text-left p-2 modal-label text-gray-900 w-20",children:"업체"}),r.jsx("th",{className:"text-left p-2 modal-label text-gray-900 w-32",children:"품명"}),r.jsx("th",{className:"text-right p-2 modal-label text-gray-900 w-20",children:"금액"}),r.jsx("th",{className:"text-center p-2 modal-label text-gray-900 w-16",children:"상태"})]})}),r.jsx("tbody",{children:e.map(e=>r.jsxs("tr",{className:"border-b hover:bg-gray-50 cursor-pointer",onClick:()=>N(e),children:[r.jsx("td",{className:"p-2 modal-value",children:e.purchase_order_number||"-"}),r.jsx("td",{className:"p-2",children:e.requester_name}),r.jsx("td",{className:"p-2 truncate",title:e.vendor_name,children:e.vendor_name}),r.jsx("td",{className:"p-2 truncate",title:e.item_name,children:e.item_name||"-"}),r.jsx("td",{className:"p-2 text-right card-amount",children:e.amount_value?`${e.amount_value.toLocaleString()} ${Qe(e.currency||"KRW")}`:e.total_amount?`${e.total_amount.toLocaleString()} ${Qe(e.currency||"KRW")}`:`0 ${Qe(e.currency||"KRW")}`}),r.jsx("td",{className:"p-2 text-center",children:r.jsx(Xe,{purchase:e})})]},e.id))})]})})}),r.jsx("div",{className:"sm:hidden space-y-3",children:e.map(e=>r.jsx(pe,{purchase:e,onClick:()=>N(e)},e.id))}),r.jsx(b,{purchaseId:u,isOpen:h,onClose:C,currentUserRoles:i,activeTab:n,onRefresh:c,onOptimisticUpdate:d,onDelete:e=>{v(e),y(!0)}}),r.jsx(Ue,{open:g,onOpenChange:y,children:r.jsxs(We,{children:[r.jsxs(Je,{children:[r.jsx(Ke,{children:"발주요청 내역 삭제"}),r.jsxs(Ve,{children:["발주요청번호 ",f?.purchase_order_number,"를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다."]})]}),r.jsxs(Ge,{children:[r.jsx(Ze,{children:"취소"}),r.jsx(He,{onClick:$,className:"bg-red-600 hover:bg-red-700",children:"삭제"})]})]})})]})});$a.displayName="FastPurchaseTable";const Da=[{key:"date_range",label:"기간별",type:"date_range",icon:H,category:"날짜"},{key:"date_month",label:"월별",type:"date_month",icon:H,category:"날짜"},{key:"requester_name",label:"요청자",type:"searchable_select",icon:h,category:"사용자"},{key:"vendor_name",label:"업체",type:"searchable_select",icon:ne,category:"사용자"},{key:"contact_name",label:"담당자",type:"searchable_select",icon:h,category:"사용자"},{key:"purchase_order_number",label:"발주번호",type:"text",icon:Z,category:"텍스트"},{key:"item_name",label:"품명",type:"text",icon:Z,category:"텍스트"},{key:"specification",label:"규격",type:"text",icon:Z,category:"텍스트"},{key:"remark",label:"비고",type:"text",icon:Z,category:"텍스트"},{key:"project_vendor",label:"PJ업체",type:"text",icon:ne,category:"텍스트"},{key:"project_item",label:"PJ ITEM",type:"text",icon:Z,category:"텍스트"},{key:"sales_order_number",label:"수주번호",type:"text",icon:Z,category:"텍스트"},{key:"quantity",label:"수량",type:"number",icon:ie,category:"숫자"},{key:"unit_price_value",label:"단가",type:"number",icon:ie,category:"숫자"},{key:"total_amount",label:"합계",type:"number",icon:ie,category:"숫자"},{key:"payment_category",label:"결제종류",type:"select",icon:U,category:"상태",options:["현장결제","구매요청","발주요청"]},{key:"payment_schedule",label:"지출예정일",type:"select_with_empty",icon:H,category:"상태"},{key:"is_payment_completed",label:"구매현황",type:"select",icon:X,category:"상태",options:["대기","완료"]},{key:"is_received",label:"입고현황",type:"select",icon:X,category:"상태",options:["대기","완료"]},{key:"is_statement_received",label:"거래명세서 확인",type:"select",icon:X,category:"상태",options:["대기","완료"]},{key:"is_utk_checked",label:"UTK 확인",type:"select",icon:U,category:"상태",options:["대기","완료"]}],qa=[{value:"request_date",label:"청구일"},{value:"delivery_request_date",label:"입고요청일"},{value:"payment_completed_at",label:"구매완료일"},{value:"received_at",label:"입고완료일"},{value:"created_at",label:"생성일"},{value:"statement_received_at",label:"거래명세서입고일"}],Sa=[{value:"request_date",label:"요청일"},{value:"purchase_order_number",label:"발주번호"},{value:"vendor_name",label:"업체명"},{value:"requester_name",label:"요청자"},{value:"total_amount",label:"합계"},{value:"delivery_request_date",label:"입고요청일"},{value:"created_at",label:"생성일"}];function Fa({activeFilters:e,sortConfig:t,searchTerm:s,onFiltersChange:l,onSortChange:n,onSearchChange:i,availableEmployees:c=[],availableVendors:d=[],availableContacts:o=[],availablePaymentSchedules:m=[]}){const[h,x]=a.useState(!1),[g,_]=a.useState(!1),[b,f]=a.useState(!1),[v,j]=a.useState({}),[w,N]=a.useState(!1),[C,k]=a.useState(!1),[$,D]=a.useState({}),[q,S]=a.useState(),[F,M]=a.useState({}),[U,Z]=a.useState({}),ae=a.useRef(null);a.useEffect(()=>{b&&ae.current&&ae.current.focus()},[b]),a.useEffect(()=>{g&&Z({field:t?.field||"",direction:t?.direction||"asc"})},[g,t]);const te=a=>{l(e.filter(e=>e.id!==a))},se=()=>{const e=Da.find(e=>e.key===v.field);if(!e)return null;switch(e.type){case"text":return r.jsx(A,{placeholder:"값 입력",value:v.value||"",onChange:e=>j(a=>({...a,value:e.target.value})),className:"w-full business-radius-input border border-gray-300 bg-white text-gray-700 card-description h-auto",style:{padding:"2px 10px",fontSize:"10px",fontWeight:"500"}});case"number":return r.jsx(A,{type:"number",placeholder:"숫자 입력",value:v.value||"",onChange:e=>j(a=>({...a,value:e.target.value})),className:"w-full business-radius-input border border-gray-300 bg-white text-gray-700 card-description h-auto",style:{padding:"2px 10px",fontSize:"10px",fontWeight:"500"}});case"searchable_select":let a=[],t="선택";return"requester_name"===e.key?(a=c,t="요청자"):"vendor_name"===e.key?(a=d,t="업체"):"contact_name"===e.key&&(a=o,t="담당자"),r.jsxs(R,{children:[r.jsx(E,{asChild:!0,children:r.jsxs(u,{variant:"outline",role:"combobox",className:"w-full button-base business-radius-button border border-gray-300 bg-white text-gray-700 justify-between [&>svg]:hidden",children:[r.jsx("span",{className:"truncate text-left",style:{fontSize:"12px",fontWeight:"500"},children:v.value||t}),r.jsx(ee,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),r.jsx(I,{className:"w-[200px] p-0 border-0 shadow-lg",align:"start",children:r.jsxs(W,{className:"border-0",children:[r.jsx(J,{placeholder:`${t} 검색...`,className:"h-auto border-0 focus:ring-0 focus:outline-none card-description placeholder:card-description",style:{padding:"2px 10px"}}),r.jsxs(G,{children:[t,"를 찾을 수 없습니다."]}),r.jsx(K,{className:"max-h-[200px] overflow-y-auto",children:a.map(e=>r.jsxs(V,{value:e,onSelect:e=>{j(a=>({...a,value:e}))},className:"cursor-pointer",children:[r.jsx(X,{className:"mr-2 h-3 w-3 "+(v.value===e?"opacity-100":"opacity-0")}),r.jsx("span",{className:"card-description",children:e})]},e))})]})})]});case"select":return r.jsxs(T,{value:v.value||"",onValueChange:e=>j(a=>({...a,value:e})),children:[r.jsx(P,{className:"button-base business-radius-button border border-gray-300 bg-white text-gray-700 [&>svg]:hidden text-center",children:r.jsx(z,{placeholder:"선택"})}),r.jsx(O,{children:e.options?.map(e=>r.jsx(Y,{value:e,children:r.jsx("span",{className:"card-description",children:e})},e))})]});case"select_with_empty":const s=["공란",...m];return r.jsxs(T,{value:v.value||"",onValueChange:e=>j(a=>({...a,value:e})),children:[r.jsx(P,{className:"button-base business-radius-button border border-gray-300 bg-white text-gray-700 [&>svg]:hidden text-center",children:r.jsx(z,{placeholder:"지출예정일"})}),r.jsx(O,{children:s.map(e=>r.jsx(Y,{value:e,children:r.jsx("span",{className:"card-description",children:e})},e))})]});case"date_range":return r.jsxs(R,{open:w,onOpenChange:e=>{if(e)if(v.value)if(v.value.includes("~")){const[e,a]=v.value.split("~");D({from:new Date(e),to:new Date(a)})}else D({from:new Date(v.value),to:void 0});else D({});N(e)},children:[r.jsx(E,{asChild:!0,children:r.jsx(u,{variant:"outline",className:"w-full button-base business-radius-button border border-gray-300 bg-white text-gray-700 justify-between h-auto",children:r.jsxs("div",{className:"flex items-center gap-1.5 min-h-[32px]",children:[r.jsx(H,{className:"w-3 h-3 flex-shrink-0"}),r.jsx("span",{className:"card-description leading-tight whitespace-pre-line",children:v.value?(()=>{if(v.value.includes("~")){const[e,a]=v.value.split("~");return`${B(new Date(e),"yy/MM/dd")}\n~ ${B(new Date(a),"yy/MM/dd")}`}return B(new Date(v.value),"yy/MM/dd")})():"날짜 선택"})]})})}),r.jsx(I,{className:"w-auto p-0",align:"start",children:r.jsxs("div",{className:"space-y-3",children:[r.jsxs("div",{className:"p-3 pb-0",children:[r.jsx("div",{className:"text-xs font-medium text-gray-600 mb-2",children:"날짜 범위 선택"}),r.jsx(L,{mode:"range",selected:$,onSelect:e=>{e&&D(e)},numberOfMonths:1,initialFocus:!0,className:"compact-calendar"})]}),r.jsxs("div",{className:"flex gap-2 p-3 pt-0",children:[r.jsx(u,{onClick:()=>{D({}),N(!1)},variant:"outline",className:"button-base border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 flex-1",children:"취소"}),r.jsx(u,{onClick:()=>{if($.from){if($.to){const e=`${B($.from,"yyyy-MM-dd")}~${B($.to,"yyyy-MM-dd")}`;j(a=>({...a,value:e}))}else j(e=>({...e,value:B($.from,"yyyy-MM-dd")}));N(!1)}},disabled:!$.from,className:"button-base bg-blue-500 text-white hover:bg-blue-600 flex-1",children:"확인"})]})]})})]});case"date_month":return r.jsxs(R,{open:C,onOpenChange:e=>{if(e)if(v.value)if(v.value.includes("~")){const[e,a]=v.value.split("~");M({from:new Date(`${e}-01`),to:new Date(`${a}-01`)})}else M({from:new Date(`${v.value}-01`),to:void 0});else M({});k(e)},children:[r.jsx(E,{asChild:!0,children:r.jsx(u,{variant:"outline",className:"w-full button-base business-radius-button border border-gray-300 bg-white text-gray-700 justify-between h-auto",children:r.jsxs("div",{className:"flex items-center gap-1.5",children:[r.jsx(H,{className:"w-3 h-3 flex-shrink-0"}),r.jsx("span",{className:"card-description leading-tight whitespace-pre-line",children:v.value?(()=>{if(v.value.includes("~")){const[e,a]=v.value.split("~"),[t,s]=e.split("-"),[r,l]=a.split("-");return`${t.slice(-2)}/${s}\n~ ${r.slice(-2)}/${l}`}{const[e,a]=v.value.split("-");return`${e.slice(-2)}/${a}`}})():"월 선택"})]})})}),r.jsx(I,{className:"w-auto p-0",align:"start",children:r.jsxs("div",{className:"space-y-3",children:[r.jsxs("div",{className:"p-3 pb-0",children:[r.jsx("div",{className:"text-xs font-medium text-gray-600 mb-3",children:"월 선택"}),r.jsxs("div",{className:"flex gap-4",children:[r.jsxs("div",{className:"flex-1",children:[r.jsx("div",{className:"text-xs text-gray-500 mb-2",children:"시작 월 선택"}),r.jsx("div",{className:"mb-3",children:r.jsxs("div",{className:"flex items-center justify-between mb-2",children:[r.jsx(u,{onClick:()=>{const e=F.from?F.from.getFullYear():(new Date).getFullYear(),a=new Date(e-1,F.from?F.from.getMonth():0,1);M(e=>({...e,from:a}))},variant:"outline",size:"sm",className:"button-base border border-gray-300 bg-white text-gray-600 hover:bg-gray-50",children:"‹"}),r.jsxs("span",{className:"text-sm font-medium text-gray-700",children:[F.from?F.from.getFullYear():(new Date).getFullYear(),"년"]}),r.jsx(u,{onClick:()=>{const e=F.from?F.from.getFullYear():(new Date).getFullYear(),a=new Date(e+1,F.from?F.from.getMonth():0,1);M(e=>({...e,from:a}))},variant:"outline",size:"sm",className:"button-base border border-gray-300 bg-white text-gray-600 hover:bg-gray-50",children:"›"})]})}),r.jsx("div",{className:"grid grid-cols-3 gap-2",children:Array.from({length:12},(e,a)=>{const t=F.from?F.from.getFullYear():(new Date).getFullYear(),s=new Date(t,a,1),l=F.from&&F.from.getFullYear()===t&&F.from.getMonth()===a;return r.jsxs(u,{onClick:()=>{M(e=>({...e,from:s}))},variant:"outline",className:"button-base text-xs h-8 "+(l?"bg-blue-500 text-white border-blue-500 hover:bg-blue-600":"border-gray-300 bg-white text-gray-700 hover:bg-gray-50"),children:[a+1,"월"]},a)})})]}),F.from&&r.jsxs("div",{className:"flex-1",children:[r.jsx("div",{className:"text-xs text-gray-500 mb-2",children:"종료 월 선택 (선택사항)"}),r.jsx("div",{className:"mb-3",children:r.jsxs("div",{className:"flex items-center justify-between mb-2",children:[r.jsx(u,{onClick:()=>{const e=F.to?F.to.getFullYear():F.from.getFullYear(),a=new Date(e-1,F.to?F.to.getMonth():11,1);M(e=>({...e,to:a}))},variant:"outline",size:"sm",className:"button-base border border-gray-300 bg-white text-gray-600 hover:bg-gray-50",children:"‹"}),r.jsxs("span",{className:"text-sm font-medium text-gray-700",children:[F.to?F.to.getFullYear():F.from.getFullYear(),"년"]}),r.jsx(u,{onClick:()=>{const e=F.to?F.to.getFullYear():F.from.getFullYear(),a=new Date(e+1,F.to?F.to.getMonth():11,1);M(e=>({...e,to:a}))},variant:"outline",size:"sm",className:"button-base border border-gray-300 bg-white text-gray-600 hover:bg-gray-50",children:"›"})]})}),r.jsx("div",{className:"grid grid-cols-3 gap-2",children:Array.from({length:12},(e,a)=>{const t=F.to?F.to.getFullYear():F.from.getFullYear(),s=new Date(t,a,1),l=F.to&&F.to.getFullYear()===t&&F.to.getMonth()===a,n=s<F.from;return r.jsxs(u,{onClick:()=>{n||M(e=>({...e,to:s}))},variant:"outline",disabled:n,className:"button-base text-xs h-8 "+(l?"bg-blue-500 text-white border-blue-500 hover:bg-blue-600":n?"border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed":"border-gray-300 bg-white text-gray-700 hover:bg-gray-50"),children:[a+1,"월"]},a)})}),r.jsx("div",{className:"mt-3",children:r.jsx(u,{onClick:()=>{M(e=>({...e,to:void 0}))},variant:"outline",size:"sm",className:"button-base border border-gray-300 bg-white text-gray-600 hover:bg-gray-50 text-xs",children:"종료 월 제거"})})]})]})]}),r.jsxs("div",{className:"flex gap-2 p-3 pt-0",children:[r.jsx(u,{onClick:()=>{M({}),k(!1)},variant:"outline",className:"button-base border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 flex-1",children:"취소"}),r.jsx(u,{onClick:()=>{if(F.from){if(F.to){const e=`${B(F.from,"yyyy-MM")}~${B(F.to,"yyyy-MM")}`;j(a=>({...a,value:e}))}else j(e=>({...e,value:B(F.from,"yyyy-MM")}));k(!1)}},disabled:!F.from,className:"button-base bg-blue-500 text-white hover:bg-blue-600 flex-1",children:"확인"})]})]})})]});default:return null}};return r.jsxs("div",{className:"w-full space-y-3",children:[r.jsx("div",{className:"flex items-center justify-between",children:r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsxs(R,{open:h,onOpenChange:x,children:[r.jsx(E,{asChild:!0,children:r.jsxs(u,{variant:"outline",className:"button-base border border-gray-300 bg-white text-gray-700 hover:bg-gray-50",children:[r.jsx(de,{className:"w-4 h-4 mr-1"}),r.jsx("span",{className:"button-text",children:"필터"}),e.length>0&&r.jsx(y,{variant:"secondary",className:"ml-1 badge-stats-primary",children:e.length})]})}),r.jsx(I,{className:"w-64 p-3",align:"start",children:r.jsxs("div",{className:"space-y-3",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("h4",{className:"card-title",children:"필터"}),e.length>0&&r.jsx(u,{variant:"ghost",onClick:()=>{l([]),x(!1)},className:"button-base text-red-600 hover:text-red-700 hover:bg-red-50",children:r.jsx("span",{className:"button-text",children:"모두 지우기"})})]}),e.length>0&&r.jsxs("div",{className:"space-y-2",children:[e.map(e=>r.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-50 business-radius",children:[r.jsxs("span",{className:"card-description",children:[e.label,e.dateField&&r.jsxs("span",{className:"text-blue-600",children:["(",qa.find(a=>a.value===e.dateField)?.label,")"]}),": ",e.value]}),r.jsx(u,{variant:"ghost",onClick:()=>te(e.id),className:"button-base h-6 w-6 p-0 hover:bg-red-50",children:r.jsx(p,{className:"w-3 h-3"})})]},e.id)),r.jsx("div",{className:"border-t border-gray-200 my-2"})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs(T,{onValueChange:e=>{const a=Da.find(a=>a.key===e);if(!a)return;let t="contains";"date_range"!==a.type&&"date_month"!==a.type||(t="equals"),j({id:`${e}_${Date.now()}`,field:e,condition:t,value:"",label:a.label})},children:[r.jsx(P,{className:"button-base business-radius-button border border-gray-300 bg-white text-gray-700 [&>svg]:hidden text-center",children:r.jsx(z,{placeholder:"+ 필터 추가"})}),r.jsx(O,{className:"w-64 max-h-80 overflow-y-auto",style:{scrollbarWidth:"auto",scrollbarColor:"#9ca3af #f3f4f6",WebkitScrollbarWidth:"8px"},children:Object.entries(Da.reduce((e,a)=>(e[a.category]||(e[a.category]=[]),e[a.category].push(a),e),{})).map(([e,a])=>r.jsxs("div",{children:[r.jsx("div",{className:"px-2 py-1 card-description uppercase",children:e}),a.map(e=>r.jsx(Y,{value:e.key,children:r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(e.icon,{className:"w-4 h-4"}),r.jsx("span",{className:"card-description",children:e.label})]})},e.key))]},e))})]}),v.field&&r.jsxs("div",{className:"space-y-2 p-3 border business-radius bg-white",children:[r.jsx("div",{className:"flex items-center gap-2",children:r.jsxs("span",{className:"card-title",children:[v.label," 필터"]})}),"date_range"===v.field||"date_month"===v.field?r.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[r.jsx("div",{className:"flex items-start",children:r.jsxs(T,{value:v.dateField||"",onValueChange:e=>j(a=>({...a,dateField:e})),children:[r.jsx(P,{className:"w-full button-base business-radius-button border border-gray-300 bg-white text-gray-700 [&>svg]:hidden text-center justify-center",children:r.jsx(z,{placeholder:"날짜 항목",className:"text-center"})}),r.jsx(O,{children:qa.map(e=>r.jsx(Y,{value:e.value,children:r.jsx("span",{className:"card-description",children:e.label})},e.value))})]})}),r.jsx("div",{className:"flex items-start",children:se()})]}):r.jsx("div",{children:se()}),r.jsxs("div",{className:"flex gap-2",children:[r.jsx(u,{onClick:()=>{const a="date_range"===v.field||"date_month"===v.field,t=a&&!v.dateField;let s=v.condition;if(!s)if(a)s="equals";else{const e=Da.find(e=>e.key===v.field);s="select"===e?.type||"select_with_empty"===e?.type||"searchable_select"===e?.type?"equals":"contains"}if(v.field&&void 0!==s&&""!==v.value&&!t){const a={id:v.id,field:v.field,condition:s,value:v.value,label:v.label,dateField:v.dateField};l([...e,a]),j({}),x(!1)}},disabled:!v.field||""===v.value||("date_range"===v.field||"date_month"===v.field)&&!v.dateField,className:"button-base bg-blue-500 text-white hover:bg-blue-600 flex-1",children:"적용"}),r.jsx(u,{variant:"outline",onClick:()=>j({}),className:"button-base border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 flex-1",children:"취소"})]})]})]})]})})]}),r.jsxs(R,{open:g,onOpenChange:_,children:[r.jsx(E,{asChild:!0,children:r.jsxs(u,{variant:"outline",className:"button-base border border-gray-300 bg-white text-gray-700 hover:bg-gray-50",children:[r.jsx(Q,{className:"w-4 h-4 mr-1"}),r.jsx("span",{className:"button-text",children:"정렬"}),t&&r.jsxs("span",{className:"ml-1 card-description",children:["(","asc"===t.direction?"↑":"↓",")"]})]})}),r.jsx(I,{className:"w-56 p-3",align:"start",children:r.jsxs("div",{className:"space-y-3",children:[r.jsx("h4",{className:"card-title",children:"정렬 설정"}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs("div",{children:[r.jsx("label",{className:"text-xs text-gray-500 mb-1 block",children:"정렬 기준"}),r.jsxs(T,{value:U.field||"",onValueChange:e=>{Z(a=>({...a,field:e}))},children:[r.jsx(P,{className:"button-base business-radius-button border border-gray-300 bg-white text-gray-700 [&>svg]:hidden",children:r.jsx(z,{placeholder:"선택하세요"})}),r.jsx(O,{children:Sa.map(e=>r.jsx(Y,{value:e.value,children:r.jsx("span",{className:"card-description",children:e.label})},e.value))})]})]}),U.field&&r.jsxs("div",{children:[r.jsx("label",{className:"text-xs text-gray-500 mb-1 block",children:"정렬 방향"}),r.jsxs(T,{value:U.direction||"",onValueChange:e=>{Z(a=>({...a,direction:e}))},children:[r.jsx(P,{className:"button-base business-radius-button border border-gray-300 bg-white text-gray-700 [&>svg]:hidden",children:r.jsx(z,{placeholder:"선택하세요"})}),r.jsxs(O,{children:[r.jsx(Y,{value:"asc",children:r.jsx("span",{className:"card-description",children:"오름차순 ↑"})}),r.jsx(Y,{value:"desc",children:r.jsx("span",{className:"card-description",children:"내림차순 ↓"})})]})]})]}),r.jsxs("div",{className:"flex gap-2 pt-2",children:[r.jsx(u,{onClick:()=>{if(U.field&&U.direction){const e=Sa.find(e=>e.value===U.field);e&&n({field:U.field,direction:U.direction,label:e.label})}_(!1),Z({})},disabled:!U.field||!U.direction,className:"button-base bg-blue-500 hover:bg-blue-600 text-white flex-1",children:"적용"}),r.jsx(u,{onClick:()=>{n(null),Z({}),_(!1)},className:"button-base border border-gray-300 bg-white text-gray-700 hover:bg-gray-50",children:"초기화"})]})]}),t&&r.jsx("div",{className:"border-t pt-2",children:r.jsx(u,{variant:"outline",onClick:()=>n(null),className:"button-base w-full border border-gray-300 text-gray-700",children:r.jsx("span",{className:"button-text",children:"정렬 해제"})})})]})})]}),r.jsx("div",{className:"flex items-center gap-2",children:b?r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(A,{ref:ae,placeholder:"전체 검색...",value:s,onChange:e=>i(e.target.value),className:"w-64 business-radius-input button-base border border-gray-300 bg-white text-gray-700"}),r.jsx(u,{variant:"ghost",onClick:()=>{f(!1),i("")},className:"button-base h-8 w-8 p-0",children:r.jsx(p,{className:"w-4 h-4"})})]}):r.jsxs(u,{variant:"outline",onClick:()=>f(!0),className:"button-base border border-gray-300 bg-white text-gray-700 hover:bg-gray-50",children:[r.jsx(ee,{className:"w-4 h-4 mr-1"}),r.jsx("span",{className:"button-text",children:"검색"})]})}),r.jsxs(u,{variant:"outline",onClick:()=>{i(""),l([]),n({field:"created_at",direction:"desc",label:"생성일"}),f(!1)},className:"button-base border border-gray-300 bg-white text-blue-600 hover:bg-blue-50 hover:border-blue-300",children:["↻ ",r.jsx("span",{className:"button-text text-blue-600",children:"초기화"})]})]})}),e.length>0&&r.jsx("div",{className:"flex flex-wrap gap-2",children:e.map(e=>r.jsxs(y,{variant:"secondary",className:"badge-base flex items-center gap-1 bg-blue-50 text-blue-700 border-blue-200",children:[e.label,e.dateField&&r.jsxs("span",{className:"text-blue-600",children:["(",qa.find(a=>a.value===e.dateField)?.label,")"]}),": ",e.value,r.jsx(u,{variant:"ghost",size:"sm",onClick:()=>te(e.id),className:"h-4 w-4 p-0 hover:bg-blue-100 ml-1",children:r.jsx(p,{className:"w-3 h-3"})})]},e.id))})]})}const Ma=a.lazy(()=>l(()=>import("./PurchaseItemsModal-C5Lm9NXq.js"),__vite__mapDeps([3,1,2,4,5,6,7,8,9,10,11,12,13,14,15,16,17]))),Aa=[{key:"pending",label:"승인대기"},{key:"purchase",label:"구매 현황"},{key:"receipt",label:"입고 현황"},{key:"done",label:"전체 항목"}];function Ra({showEmailButton:e=!0}){const l=x(),n=g(),i=t(),[c,d]=a.useState(null),[o,m]=a.useState(!1),[p,h]=a.useState([]),[b,f]=a.useState({field:"created_at",direction:"desc",label:"생성일"}),[v,j]=a.useState(""),[w,N]=a.useState([]),[C,k]=a.useState([]),[$,D]=a.useState([]),[q,S]=a.useState([]),{purchases:F,loading:M,currentUserRoles:A,currentUserName:R,refreshPurchases:E,updatePurchaseOptimistic:I}=me(),T=A?.includes("app_admin"),[P,z]=a.useState("pending"),[O,Y]=a.useState(""),U=a.useMemo(()=>{const e=["정희웅"];return A?.includes("purchase_manager")||A?.includes("app_admin")?F:F.filter(a=>!e.includes(a.requester_name))},[F,A]),B=a.useMemo(()=>A&&0!==A.length?A.includes("purchase_manager")?2:A.some(e=>["final_approver","app_admin","ceo","middle_manager","hr"].includes(e))?3:1:1,[A]),L=a.useCallback(e=>{if(!R)return"all";switch(B){case 1:case 2:return"done"===e?"all":R;case 3:return"all";default:return R}},[R,B]);a.useEffect(()=>{if(!R)return;const e=L(P);Y(e)},[P,R,L]),a.useEffect(()=>{const e=new URLSearchParams(n.search).get("tab");e&&["pending","purchase","receipt","done"].includes(e)&&z(e)},[n.search]),a.useEffect(()=>{(async()=>{try{const{data:e}=await i.from("employees").select("name");if(e){const a=[...new Set(e.map(e=>e.name).filter(Boolean))];N(a)}const{data:a}=await i.from("vendors").select("vendor_name");if(a){const e=[...new Set(a.map(e=>e.vendor_name).filter(Boolean))];k(e)}const{data:t}=await i.from("vendor_contacts").select("contact_name");if(t){const e=[...new Set(t.map(e=>e.contact_name).filter(Boolean))];D(e)}const{data:s}=await i.from("vendors").select("vendor_payment_schedule");if(s){const e=[...new Set(s.map(e=>e.vendor_payment_schedule).filter(Boolean))];S(e)}}catch(e){s.error("필터 옵션 데이터 로드 실패",e)}})()},[i]),a.useCallback(e=>e.is_received?r.jsx(y,{variant:null,className:"badge-success",children:"입고완료"}):"approved"===e.middle_manager_status&&"approved"===e.final_manager_status?r.jsx(y,{variant:null,className:"badge-primary",children:"구매진행"}):"rejected"===e.middle_manager_status||"rejected"===e.final_manager_status?r.jsx(y,{variant:null,className:"badge-danger",children:"반려"}):r.jsx(y,{variant:null,className:"badge-warning",children:"승인대기"}),[]);const W=a.useCallback((e,a)=>{switch(a){case"purchase_order_number":return e.purchase_order_number;case"payment_category":return e.payment_category;case"requester_name":return e.requester_name;case"vendor_name":return e.vendor_name;case"contact_name":return e.contact_name;case"item_name":return e.item_name;case"specification":return e.specification;case"quantity":return e.quantity;case"unit_price_value":return e.unit_price_value;case"total_amount":return e.total_amount;case"remark":return e.remark;case"project_vendor":return e.project_vendor;case"project_item":return e.project_item;case"sales_order_number":return e.sales_order_number;case"payment_schedule":return e.vendor_payment_schedule;case"is_payment_completed":return e.is_payment_completed?"완료":"대기";case"is_received":return e.is_received?"완료":"대기";case"is_statement_received":return e.is_statement_received?"완료":"대기";case"is_utk_checked":return e.is_utk_checked?"완료":"대기";case"request_date":return e.request_date;case"delivery_request_date":return e.delivery_request_date;case"payment_completed_at":return e.payment_completed_at;case"received_at":return e.received_at;case"created_at":return e.created_at;case"statement_received_at":return e.statement_received_at;default:return null}},[]),J=a.useCallback((e,a,t,r)=>{if(null==e)return"is_empty"===a;if("date_range"===r&&t&&t.includes("~")){if(!e)return!1;const[a,s]=t.split("~"),r=new Date(e),l=new Date(a),n=new Date(s);return r>=l&&r<=n}if("date_month"===r&&t&&t.includes("~")){if(!e)return!1;const[a,s]=t.split("~"),r=new Date(e),l=new Date(`${a}-01`),n=new Date(`${s}-01`),i=new Date(n.getFullYear(),n.getMonth()+1,0,23,59,59);return r>=l&&r<=i}if(r&&("date_month"===r||r.endsWith("_month"))){if(!t)return!0;const a=new Date(e),[s,r]=t.split("-");return a.getFullYear()===parseInt(s)&&a.getMonth()+1===parseInt(r)}const l=String(e).toLowerCase(),n=String(t).toLowerCase();switch(a){case"contains":return l.includes(n);case"equals":if("date_range"===r||t.match(/^\d{4}-\d{2}-\d{2}/)){if(!e)return!1;try{const a=new Date(e).toISOString().split("T")[0];return a===t.split("T")[0]}catch(i){return s.error("날짜 비교 오류:",i),!1}}return l===n;case"starts_with":return l.startsWith(n);case"ends_with":return l.endsWith(n);case"is_empty":return!e||""===l.trim();case"is_not_empty":return!!e&&""!==l.trim();case"greater_than":return Number(e)>Number(t);case"less_than":return Number(e)<Number(t);case"between":default:return!0;case"after":return new Date(e)>new Date(t);case"before":return new Date(e)<new Date(t);case"not_equals":return l!==n}},[]),G=a.useMemo(()=>{let e=U.filter(e=>{if(!(e=>{if(O&&"all"!==O&&"전체"!==O&&e.requester_name!==O)return!1;if(v&&""!==v.trim()){const a=v.trim().toLowerCase();if(![e.purchase_order_number,e.vendor_name,e.item_name,e.specification,e.requester_name,e.remark,e.project_vendor,e.project_item,e.sales_order_number,e.unit_price_value?.toString(),e.amount_value?.toString()].map(e=>(e||"").toLowerCase()).join(" ").includes(a))return!1}return!0})(e))return!1;switch(P){case"pending":{if(A&&A.includes("consumable_manager")&&"구매 요청"!==e.payment_category)return!1;const a=["pending","대기","",null,void 0].includes(e.middle_manager_status),t=("승인"===e.middle_manager_status||"approved"===e.middle_manager_status)&&"approved"!==e.final_manager_status&&"승인"!==e.final_manager_status,s=("approved"===e.final_manager_status||"승인"===e.final_manager_status)&&e.final_manager_approved_at&&(()=>{const a=new Date(e.final_manager_approved_at),t=new Date;return a.getFullYear()===t.getFullYear()&&a.getMonth()===t.getMonth()&&a.getDate()===t.getDate()})();return"rejected"!==e.middle_manager_status&&"rejected"!==e.final_manager_status&&(a||t||s)}case"purchase":{const a="구매 요청"===e.payment_category,t=!e.is_payment_completed;if(!a||!t)return!1;const s=(e.progress_type||"").includes("선진행"),r=(e.progress_type||"").includes("일반"),l="approved"===e.final_manager_status;return s||r&&l}case"receipt":{if(e.is_received)return!1;const a=(e.progress_type||"").includes("선진행"),t="approved"===e.final_manager_status;return a||t}default:return!0}});if(!(p.length>0||""!==v.trim())){const a=new Date;a.setDate(a.getDate()-60),e=e.filter(e=>{if(!e.request_date)return!1;return new Date(e.request_date)>=a})}return p.length>0&&(e=e.filter(e=>p.every(a=>{const t=("date_range"===a.field||"date_month"===a.field)&&a.dateField||a.field,s=W(e,t),r="date_month"===a.field?"date_month":"date_range"===a.field?"date_range":void 0;return J(s,a.condition,a.value,r)}))),e=b?[...e].sort((e,a)=>{const t=W(e,b.field),s=W(a,b.field);if(null==t)return 1;if(null==s)return-1;let r=0;return r="number"==typeof t&&"number"==typeof s?t-s:t instanceof Date&&s instanceof Date?t.getTime()-s.getTime():String(t).localeCompare(String(s)),"desc"===b.direction?-r:r}):"pending"===P?[...e].sort((e,a)=>{const t=e=>"승인"!==e.middle_manager_status&&"approved"!==e.middle_manager_status?1:"승인"!==e.middle_manager_status&&"approved"!==e.middle_manager_status||"approved"===e.final_manager_status||"승인"===e.final_manager_status?"approved"===e.final_manager_status||"승인"===e.final_manager_status?3:4:2,s=t(e),r=t(a);if(s!==r)return s-r;const l=e.request_date?new Date(e.request_date).getTime():0;return(a.request_date?new Date(a.request_date).getTime():0)-l}):[...e].sort((e,a)=>{const t=e.request_date?new Date(e.request_date).getTime():0;return(a.request_date?new Date(a.request_date).getTime():0)-t}),e},[U,P,O,v,p,b,A,W,J]),K=a.useMemo(()=>{const e=e=>new Set(e.map(e=>e.purchase_order_number)).size,a=U.filter(e=>{const a=["pending","대기","",null,void 0].includes(e.middle_manager_status),t=("승인"===e.middle_manager_status||"approved"===e.middle_manager_status)&&"approved"!==e.final_manager_status&&"승인"!==e.final_manager_status,s=("approved"===e.final_manager_status||"승인"===e.final_manager_status)&&e.final_manager_approved_at&&(()=>{const a=new Date(e.final_manager_approved_at),t=new Date;return a.getFullYear()===t.getFullYear()&&a.getMonth()===t.getMonth()&&a.getDate()===t.getDate()})();return"rejected"!==e.middle_manager_status&&"rejected"!==e.final_manager_status&&(a||t||s)}),t=U.filter(e=>{const a="구매 요청"===e.payment_category,t=!e.is_payment_completed;if(!a||!t)return!1;const s=(e.progress_type||"").includes("선진행"),r=(e.progress_type||"").includes("일반"),l="approved"===e.final_manager_status;return s||r&&l}),s=U.filter(e=>{if(e.is_received)return!1;const a=(e.progress_type||"").includes("선진행"),t="approved"===e.final_manager_status;return a||t});return{pending:e(a),purchase:e(t),receipt:e(s),done:e(U)}},[U]),V=a.useMemo(()=>{const e=p.length>0||""!==v.trim();let a=U;if(e)p.length>0&&(a=a.filter(e=>p.every(a=>{const t=("date_range"===a.field||"date_month"===a.field)&&a.dateField||a.field,s=W(e,t),r="date_month"===a.field?"date_month":"date_range"===a.field?"date_range":void 0;return J(s,a.condition,a.value,r)})));else{const e=new Date;e.setDate(e.getDate()-60),a=a.filter(a=>{if(!a.request_date)return!1;return new Date(a.request_date)>=e})}if(v.trim()){const e=v.toLowerCase().trim();a=a.filter(a=>[a.purchase_order_number,a.vendor_name,a.item_name,a.specification,a.requester_name,a.remark,a.project_vendor,a.project_item,a.sales_order_number].map(e=>(e||"").toLowerCase()).join(" ").includes(e))}const t=e=>new Set(e.map(e=>e.purchase_order_number)).size,s=a.filter(e=>{const a=["pending","대기","",null,void 0].includes(e.middle_manager_status),t=("승인"===e.middle_manager_status||"approved"===e.middle_manager_status)&&"approved"!==e.final_manager_status&&"승인"!==e.final_manager_status,s=("approved"===e.final_manager_status||"승인"===e.final_manager_status)&&e.final_manager_approved_at&&(()=>{const a=new Date(e.final_manager_approved_at),t=new Date;return a.getFullYear()===t.getFullYear()&&a.getMonth()===t.getMonth()&&a.getDate()===t.getDate()})();return"rejected"!==e.middle_manager_status&&"rejected"!==e.final_manager_status&&(a||t||s)}),r=a.filter(e=>{const a="구매 요청"===e.payment_category,t=!e.is_payment_completed;if(!a||!t)return!1;const s=(e.progress_type||"").includes("선진행"),r=(e.progress_type||"").includes("일반"),l="approved"===e.final_manager_status;return s||r&&l}),l=a.filter(e=>{if(e.is_received)return!1;const a=(e.progress_type||"").includes("선진행"),t="approved"===e.final_manager_status;return a||t});return{pending:t(s),purchase:t(r),receipt:t(l),done:t(a)}},[U,p,v,W,J]),H=a.useMemo(()=>{const e=p.filter(e=>"date_month"===e.field||"date_range"===e.field&&e.dateField&&e.dateField.includes("_month"));if(0===e.length)return null;const a=e[0].value;if(a&&a.includes("~")){const[e,t]=a.split("~"),s=new Date(`${e}-01`),r=new Date(`${t}-01`),l=[];let n=0;const i=new Date(s);for(;i<=r;){const e=i.getFullYear(),a=i.getMonth()+1,t=`${e}-${a.toString().padStart(2,"0")}`,s=G.filter(t=>{const s=new Date(t.request_date);return s.getFullYear()===e&&s.getMonth()+1===a}),r=s.reduce((e,a)=>e+(a.amount_value||a.total_amount||0),0);l.push({year:e,month:a,monthStr:t,total:r,count:s.length}),n+=r,i.setMonth(i.getMonth()+1)}return{type:"range",months:l,grandTotal:n}}{const[e,t]=a.split("-"),s=G.filter(a=>{const s=new Date(a.request_date);return s.getFullYear()===parseInt(e)&&s.getMonth()+1===parseInt(t)}),r=s.reduce((e,a)=>e+(a.amount_value||a.total_amount||0),0);return{type:"single",year:parseInt(e),month:parseInt(t),total:r,count:s.length}}},[p,G]),X=a.useCallback(async e=>{try{const a=(new Date).toISOString(),[t,s]=await Promise.all([i.from("purchase_requests").update({is_received:!0,received_at:a}).eq("id",e),i.from("purchase_request_items").update({is_received:!0,delivery_status:"received"}).eq("purchase_request_id",e)]);if(t.error)throw t.error;if(s.error)throw s.error;_.success("입고완료 처리되었습니다."),await E()}catch(a){_.error("처리 중 오류가 발생했습니다.")}},[i,E]),Q=a.useCallback(async e=>{try{const a=(new Date).toISOString(),[t,s]=await Promise.all([i.from("purchase_requests").update({is_payment_completed:!0,payment_completed_at:a}).eq("id",e),i.from("purchase_request_items").update({is_payment_completed:!0}).eq("purchase_request_id",e)]);if(t.error)throw t.error;if(s.error)throw s.error;_.success("구매완료 처리되었습니다."),await E()}catch(a){_.error("처리 중 오류가 발생했습니다.")}},[i,E]);a.useCallback(e=>{d(e),m(!0)},[]);const ee=a.useMemo(()=>c?{...c,vendor_name:c.vendor_name||"",project_vendor:c.project_vendor||"",sales_order_number:c.sales_order_number||"",project_item:c.project_item||""}:null,[c]);return r.jsxs("div",{className:"w-full",children:[r.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4",children:[r.jsxs("div",{children:[r.jsx("h1",{className:"page-title",children:"발주요청 관리"}),r.jsx("p",{className:"page-subtitle",style:{marginTop:"-2px",marginBottom:"-4px"},children:"Purchase Management"})]}),r.jsxs(u,{onClick:()=>l("/purchase/new"),className:"mt-4 sm:mt-0 bg-hansl-500 hover:bg-hansl-600",children:[r.jsx(le,{className:"w-4 h-4 mr-2"}),"새 발주요청 작성"]})]}),r.jsxs("div",{className:"mb-3",children:[r.jsx(Fa,{activeFilters:p,sortConfig:b,searchTerm:v,onFiltersChange:h,onSortChange:f,onSearchChange:j,availableEmployees:w,availableVendors:C,availableContacts:$,availablePaymentSchedules:q}),0===p.length&&!v.trim()&&r.jsxs("div",{className:"mt-2 flex items-center gap-1.5 text-xs text-gray-500",children:[r.jsx(ce,{className:"w-3.5 h-3.5"}),r.jsx("span",{children:"최근 60일 데이터만 표시됩니다. 더 오래된 데이터를 보려면 필터를 적용해주세요."})]})]}),r.jsxs("div",{className:"space-y-3",children:[r.jsx("div",{className:"flex flex-col sm:flex-row sm:space-x-1 space-y-1 sm:space-y-0 bg-gray-50 p-1 business-radius-card border border-gray-200",children:Aa.map(e=>r.jsxs("button",{onClick:()=>{z(e.key)},className:"flex-1 flex items-center justify-center space-x-2 py-1.5 px-3 sm:px-4 business-radius-button button-text font-medium transition-colors "+(P===e.key?"text-hansl-600 bg-white shadow-sm border border-gray-200":"text-gray-600 bg-transparent hover:text-gray-900 hover:bg-white/50"),children:[r.jsx("span",{className:"whitespace-nowrap",children:e.label}),r.jsx(y,{variant:"secondary",className:P===e.key?"badge-stats-active":"badge-stats-secondary",children:p.length>0||""!==v.trim()?V[e.key]:K[e.key]})]},e.key))}),H&&r.jsx("div",{className:"mb-3",children:"single"===H.type?r.jsxs("div",{className:"inline-flex items-center gap-2 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 business-radius-badge px-3 py-2 shadow-sm",children:[r.jsxs("div",{className:"flex items-center gap-1.5",children:[r.jsx("div",{className:"w-1.5 h-1.5 bg-blue-500 rounded-full"}),r.jsxs("span",{className:"card-subtitle text-gray-700",children:[H.year,"년 ",H.month,"월"]}),r.jsxs("span",{className:"badge-text text-gray-500",children:[H.count,"건"]})]}),r.jsx("div",{className:"h-4 w-px bg-blue-300"}),r.jsxs("span",{className:"modal-value text-blue-700 font-semibold",children:["₩",H.total.toLocaleString()]})]}):r.jsxs(ae,{className:"business-radius-card border border-gray-200 shadow-sm",children:[r.jsx(te,{className:"pb-3 pt-4 px-4",children:r.jsxs("div",{className:"flex items-center gap-4",children:[r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("div",{className:"w-1.5 h-1.5 bg-blue-500 rounded-full"}),r.jsx(se,{className:"section-title text-gray-800",children:"월별 발주요청 총액"})]}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsxs("span",{className:"badge-text text-gray-600",children:["(",H.months.reduce((e,a)=>e+a.count,0),"건)"]}),r.jsx("div",{className:"h-4 w-px bg-gray-300"}),r.jsxs("span",{className:"modal-value text-gray-500 font-bold",children:["₩",H.grandTotal.toLocaleString()]})]})]})}),r.jsx(re,{className:"px-4 pb-4",children:r.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2",children:H.months.map(e=>r.jsx("div",{className:"bg-gray-50 business-radius-card px-3 py-1.5 border border-gray-200 hover:border-blue-300 hover:bg-blue-50 transition-all flex-shrink-0",children:r.jsxs("div",{className:"flex items-baseline gap-1.5",children:[r.jsxs("span",{className:"modal-value font-bold text-gray-800 whitespace-nowrap",children:[e.month,"월"]}),r.jsxs("span",{className:"text-[9px] text-gray-500 whitespace-nowrap",children:["(",e.count,")"]}),r.jsxs("span",{className:"modal-value text-gray-500 font-bold whitespace-nowrap ml-1",children:["₩",e.total.toLocaleString()]})]})},e.monthStr))})})]})}),r.jsx(ae,{className:"overflow-hidden border border-gray-200",children:r.jsx(re,{className:"p-0",children:M?r.jsxs("div",{className:"flex items-center justify-center py-12",children:[r.jsx("div",{className:"w-8 h-8 border-2 border-hansl-500 border-t-transparent rounded-full animate-spin"}),r.jsx("span",{className:"ml-3 card-subtitle",children:"로딩 중..."})]}):0===G.length?r.jsxs("div",{className:"text-center py-12",children:[r.jsx(Z,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),r.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"발주요청서가 없습니다"}),r.jsx("p",{className:"card-subtitle",children:"새로운 발주요청서를 작성해보세요."})]}):r.jsx($a,{purchases:G,activeTab:P,currentUserRoles:A,onRefresh:E,onOptimisticUpdate:I,onPaymentComplete:Q,onReceiptComplete:X})})})]}),ee&&r.jsx(a.Suspense,{fallback:r.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white"})}),children:r.jsx(Ma,{isOpen:o,onClose:()=>{m(!1),d(null)},purchase:ee,isAdmin:T||!1,onUpdate:E,activeTab:P})})]})}export{Ra as default};
//# sourceMappingURL=PurchaseListMain-LDekvatK.js.map
