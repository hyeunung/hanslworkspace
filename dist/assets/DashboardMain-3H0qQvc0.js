import{c as W,a as X,u as de,r as b,j as e,X as oe,B as C,S as V}from"./index-DURjiRtV.js";import{t as k,B as L}from"./index-DgYLmkP3.js";import{C as U,a as I,b as B,c as z,S as Q}from"./card-D7c8b6xy.js";import{D as ue,a as me}from"./dialog-BOugK96I.js";import{I as H}from"./input-DR32zq7D.js";import{E as fe}from"./exceljs.min-BrYFFAnx.js";import{T as ee,P as be}from"./PurchaseDetailModal-BvNLZqrd.js";import{P as he}from"./package-BOBhWn-U.js";import{C as pe}from"./circle-check-big-BuVt1Qd6.js";import{E as ve}from"./eye-Dp6JYudF.js";import{D as G}from"./download-BDmPU3NL.js";import"./helpers-CWDchwQL.js";import"./format-NvEY_HGk.js";import"./chevron-down-Diu47hfg.js";import"./popover-D9IINcEu.js";import"./calendar-DMR6LWZU.js";import"./credit-card-XsL0DUkR.js";import"./trash-2-CdcJ6l8T.js";import"./plus-W5OE0DJN.js";import"./save-CLakp-ew.js";/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]],se=W("arrow-right",je);/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],Z=W("circle-check",Ne);/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const we=[["path",{d:"M12 6v6l4 2",key:"mmk7yg"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],ae=W("clock",we);/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=[["path",{d:"M7 10v12",key:"1qc93n"}],["path",{d:"M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z",key:"emmmcr"}]],Se=W("thumbs-up",qe);/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const De=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]],ke=W("triangle-alert",De);class Ce{constructor(){this.supabase=X()}parseRoles(t){let n=[];return t&&(Array.isArray(t)?n=t.map(r=>String(r).trim()):n=String(t).split(",").map(a=>a.trim()).filter(a=>a.length>0)),n}async getDashboardData(t){const[n,r,a,u,i,_,m]=await Promise.all([this.getDashboardStats(t),this.getUrgentRequests(t),this.getMyRecentRequests(t),this.getPendingApprovals(t),this.getQuickActions(t),this.getTodaySummary(t),this.getMyPurchaseStatus(t)]);return{employee:t,stats:n,urgentRequests:r,myRecentRequests:a,pendingApprovals:u,quickActions:i,todaySummary:_,myPurchaseStatus:m}}async getDashboardStats(t){const n=new Date().toISOString().split("T")[0],r=this.parseRoles(t.purchase_role),[a,u,i,_,m,h]=await Promise.all([this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("requester_name",t.name),this.getPendingCount(t,r),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("is_received",!0).gte("received_at",new Date(new Date().getFullYear(),new Date().getMonth(),1).toISOString()),this.getUrgentCount(t,r),this.getTodayActionsCount(t,n)]);return{total:a.count||0,myRequests:u.count||0,pending:i,completed:_.count||0,urgent:m,todayActions:h}}async getUrgentRequests(t){const n=new Date(Date.now()-2592e5).toISOString(),r=this.parseRoles(t.purchase_role);if(r.length===0)return[];let a=this.supabase.from("purchase_requests").select("*,vendors(vendor_name),purchase_request_items(id)").lt("created_at",n);if(r.includes("app_admin"))a=a.or("middle_manager_status.eq.pending,final_manager_status.eq.pending,purchase_status.eq.pending");else if(r.includes("middle_manager"))a=a.eq("middle_manager_status","pending");else if(r.includes("final_approver")||r.includes("ceo"))a=a.eq("middle_manager_status","approved").eq("final_manager_status","pending");else if(r.includes("lead buyer"))a=a.eq("final_manager_status","approved").eq("purchase_status","pending");else return[];const{data:u}=await a.order("created_at",{ascending:!0}).limit(5);return(u||[]).map(i=>({...i,vendor_name:i.vendors?.vendor_name,total_items:i.purchase_request_items?.length||0,daysOverdue:Math.floor((Date.now()-new Date(i.created_at).getTime())/(1e3*60*60*24)),priority:this.calculatePriority(i),urgentReason:this.getUrgentReason(i,r)}))}async getMyRecentRequests(t){const{data:n}=await this.supabase.from("purchase_requests").select("*,vendors(vendor_name),purchase_request_items(id)").eq("requester_name",t.name).or("and(middle_manager_status.eq.approved,final_manager_status.eq.pending),and(final_manager_status.eq.approved,purchase_status.eq.pending)").order("created_at",{ascending:!1}).limit(5);return(n||[]).map(r=>({...r,vendor_name:r.vendors?.vendor_name,total_items:r.purchase_request_items?.length||0,progress_percentage:this.calculateProgress(r),current_step:this.getCurrentStep(r),next_action:this.getNextAction(r),estimated_completion:this.estimateCompletion(r)}))}async getPendingApprovals(t){const n=this.parseRoles(t.purchase_role);let r=null;const a=await this.supabase.from("purchase_requests").select("*").order("request_date",{ascending:!1}).limit(100);if(a.error){a.error;const m=await this.supabase.from("purchase_requests").select("*").order("request_date",{ascending:!1}).limit(100);if(m.error)return[];r=m.data||[]}else r=a.data||[];let u=r||[];const i=m=>m==="pending"||m==="대기"||m===""||m===null||m===void 0;return u=u.filter(m=>{const h=i(m.middle_manager_status),y=i(m.final_manager_status),c=m.middle_manager_status==="rejected",w=m.final_manager_status==="rejected";return c||w?!1:h||y}),n.length===0?[]:await Promise.all(u.map(async m=>{const{data:h}=await this.supabase.from("purchase_request_items").select("*").eq("purchase_request_id",m.id);let y=m.vendor_name;if(!y&&m.vendor_id){const{data:q}=await this.supabase.from("vendors").select("vendor_name").eq("id",m.vendor_id).single();y=q?.vendor_name}const c=h||[],w=c.reduce((q,P)=>{const T=Number(P?.amount_value)||(Number(P?.quantity)||0)*(Number(P?.unit_price_value)||0);return q+T},0);return{...m,vendor_name:y,purchase_request_items:c,total_amount:w}}))}async getQuickActions(t){const n=this.parseRoles(t.purchase_role),r=[];if(n.includes("app_admin")||n.includes("middle_manager")||n.includes("final_approver")||n.includes("ceo")){const a=await this.getPendingCount(t,n);a>0&&r.push({id:"approve",type:"approve",label:"승인 대기",description:`${a}건의 승인 대기 중`,count:a,color:"red"})}if(n.includes("lead buyer")||n.includes("lead buyer")){const{count:a}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("final_manager_status","approved").eq("purchase_status","pending");a&&a>0&&r.push({id:"purchase",type:"purchase",label:"구매 처리",description:`${a}건의 구매 대기 중`,count:a,color:"yellow"})}return r}async getTodaySummary(t){const n=new Date().toISOString().split("T")[0],r=new Date(Date.now()+1440*60*1e3).toISOString().split("T")[0],[a,u,i]=await Promise.all([this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).gte("updated_at",n).lt("updated_at",r).or("middle_manager_status.eq.approved,final_manager_status.eq.approved"),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("requester_name",t.name).gte("created_at",n).lt("created_at",r),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("is_received",!0).gte("received_at",n).lt("received_at",r)]);return{approved:a.count||0,requested:u.count||0,received:i.count||0}}async getMyPurchaseStatus(t){const n=t.name||t.email,r=new Date(Date.now()-10080*60*1e3).toISOString(),a=await this.supabase.from("purchase_requests").select("*,vendors(vendor_name),purchase_request_items(item_name,quantity,specification,amount_value)").eq("requester_name",n).order("created_at",{ascending:!1}).limit(100);if(a.error)return console.error("getMyPurchaseStatus 에러:",a.error),{waitingPurchase:[],waitingDelivery:[],recentCompleted:[]};const u=a.data||[],i=u.filter(h=>{const y=(h.payment_category||"").trim().replace(/\s+/g,""),c=["구매요청","발주요청"].includes(y),w=!h.is_payment_completed,q=(h.progress_type||"").includes("선진행");if(c&&w&&q)return!0;const P=(h.progress_type||"").includes("일반")||!h.progress_type||h.progress_type==="",T=h.final_manager_status==="approved";return c&&w&&P&&T}).slice(0,10),_=u.filter(h=>{const y=!h.is_received,c=(h.progress_type||"").includes("선진행");if(y&&c)return!0;const w=h.final_manager_status==="approved";return y&&w}).slice(0,10),m=u.filter(h=>{if(h.is_received!==!0||!h.received_at)return!1;const y=new Date(h.received_at),c=new Date(r);return y>=c}).slice(0,10);return{waitingPurchase:i,waitingDelivery:_,recentCompleted:m}}async quickApprove(t,n){try{const r=this.parseRoles(n.purchase_role),{data:a}=await this.supabase.from("purchase_requests").select("middle_manager_status, final_manager_status").eq("id",t).single();if(!a)return{success:!1,error:"요청을 찾을 수 없습니다."};let u={};const i=h=>h==="pending"||h==="대기"||h===""||h===null||h===void 0;if(r.includes("app_admin")?i(a.middle_manager_status)?u={middle_manager_status:"approved"}:a.middle_manager_status==="approved"&&i(a.final_manager_status)&&(u={final_manager_status:"approved"}):r.includes("middle_manager")?i(a.middle_manager_status)&&(u={middle_manager_status:"approved"}):r.includes("final_approver")||r.includes("ceo")?a.middle_manager_status==="approved"&&i(a.final_manager_status)&&(u={final_manager_status:"approved"}):(r.includes("raw_material_manager")||r.includes("consumable_manager"))&&a.middle_manager_status==="approved"&&i(a.final_manager_status)&&(u={final_manager_status:"approved"}),Object.keys(u).length===0)return{success:!1,error:"승인할 수 있는 상태가 아닙니다."};const{data:_,error:m}=await this.supabase.from("purchase_requests").update(u).eq("id",t).select().single();if(m)throw m;return{success:!0}}catch(r){return{success:!1,error:r.message}}}async getPendingCount(t,n){if(n.includes("app_admin")){const[r,a,u]=await Promise.all([this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).or("middle_manager_status.in.(pending,대기),middle_manager_status.is.null"),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("middle_manager_status","approved").or("final_manager_status.in.(pending,대기),final_manager_status.is.null"),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("final_manager_status","approved").or("purchase_status.in.(pending,대기),purchase_status.is.null")]);return(r.count||0)+(a.count||0)+(u.count||0)}if(n.includes("middle_manager")){const{count:r,error:a}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).or("middle_manager_status.in.(pending,대기),middle_manager_status.is.null");return a?0:r||0}if(n.includes("final_approver")||n.includes("ceo")){const{count:r,error:a}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("middle_manager_status","approved").or("final_manager_status.in.(pending,대기),final_manager_status.is.null");return a?0:r||0}if(n.includes("lead buyer")){const{count:r,error:a}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("final_manager_status","approved").or("purchase_status.in.(pending,대기),purchase_status.is.null");return a?0:r||0}return 0}async getUrgentCount(t,n){if(n.length===0)return 0;const r=new Date(Date.now()-4320*60*1e3).toISOString();let a=this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).lt("created_at",r);if(n.includes("app_admin"))a=a.or("middle_manager_status.eq.pending,final_manager_status.eq.pending,purchase_status.eq.pending");else if(n.includes("middle_manager"))a=a.eq("middle_manager_status","pending");else if(n.includes("final_approver")||n.includes("ceo"))a=a.eq("middle_manager_status","approved").eq("final_manager_status","pending");else if(n.includes("lead buyer"))a=a.eq("final_manager_status","approved").eq("purchase_status","pending");else return 0;const{count:u}=await a;return u||0}async getTodayActionsCount(t,n){const r=new Date(Date.now()+864e5).toISOString().split("T")[0],{count:a}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).gte("updated_at",n).lt("updated_at",r).or(`middle_manager_id.eq.${t.id},final_manager_id.eq.${t.id}`);return a||0}async getTotalDeliveryWaitingCount(){const{count:t}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("is_received",!1).or("is_payment_completed.eq.true,progress_type.ilike.%선진행%");return t||0}calculatePriority(t){const n=Math.floor((Date.now()-new Date(t.created_at).getTime())/864e5);return n>=7?"high":n>=5?"medium":"low"}getUrgentReason(t,n){return n.includes("middle_manager")&&t.middle_manager_status==="pending"||(n.includes("final_approver")||n.includes("ceo"))&&t.final_manager_status==="pending"?"overdue_approval":t.is_received?"payment_pending":"delivery_delay"}calculateProgress(t){let n=0;return t.middle_manager_status==="approved"&&(n+=25),t.final_manager_status==="approved"&&(n+=25),t.is_payment_completed&&(n+=25),t.is_received&&(n+=25),n}getCurrentStep(t){return t.is_received?"completed":t.is_payment_completed?"delivery":t.final_manager_status==="approved"?"purchase":"approval"}getNextAction(t){return t.middle_manager_status==="pending"?"중간 승인 대기 중":t.final_manager_status==="pending"?"최종 승인 대기 중":t.is_payment_completed?t.is_received?"완료":"입고 대기 중":"구매 처리 대기 중"}estimateCompletion(t){const n=new Date(t.created_at);Math.floor((new Date().getTime()-n.getTime())/(1e3*60*60*24));let a=7;return t.progress_type==="긴급"&&(a=3),new Date(n.getTime()+a*24*60*60*1e3).toLocaleDateString("ko-KR")}async getUndownloadedOrders(t){const n=this.parseRoles(t.purchase_role);if(!n.includes("lead buyer")&&!n.includes("lead buyer"))return[];const{data:r,error:a}=await this.supabase.from("purchase_requests").select("*,purchase_request_items(id,item_name,specification,quantity,unit_price_value,amount_value)").order("created_at",{ascending:!1}).limit(100);if(a)return console.error("Failed to fetch undownloaded orders:",a),[];const u=(r||[]).filter(i=>{const _=i.progress_type==="선진행"||i.middle_manager_status==="approved"&&i.final_manager_status==="approved",m=!i.is_po_download||i.is_po_download===!1||i.is_po_download===null;return _&&m});return u.sort((i,_)=>new Date(i.created_at).getTime()-new Date(_.created_at).getTime()),u.slice(0,10)}}const K=new Ce;function Pe({isOpen:o,onClose:t,item:n,type:r,onRefresh:a}){const u=de(),i=X(),[_,m]=b.useState([]),[h,y]=b.useState(!1),[c,w]=b.useState(n);if(b.useEffect(()=>{w(n)},[n]),b.useEffect(()=>{(async()=>{const{data:{user:j}}=await i.auth.getUser();if(console.log("Fetching roles for user:",j?.email),j?.email){const{data:S}=await i.from("employees").select("purchase_role").eq("email",j.email).single();if(console.log("Employee data:",S),S?.purchase_role){const R=Array.isArray(S.purchase_role)?S.purchase_role:S.purchase_role.split(",").map(M=>M.trim());console.log("Parsed roles:",R),m(R)}else console.log("No purchase_role found for employee")}})()},[r]),!c)return null;const q=c.purchase_request_items||[],P=q.reduce((g,j)=>g+(Number(j.amount_value)||0),0);q.reduce((g,j)=>g+(Number(j.quantity)||0),0),console.log("🔍 PurchaseStatusModal Debug:",{type:r,currentUserRoles:_,item:c.purchase_order_number,showPurchaseButton:r==="purchase",showDeliveryButton:r==="delivery",hasAdminPermission:_.includes("app_admin"),hasLeadBuyerPermission:_.includes("lead buyer"),hasReceiverPermission:_.includes("receiver"),itemData:{is_payment_completed:c.is_payment_completed,is_received:c.is_received}});const x=(()=>{switch(r){case"pending":return{icon:e.jsx(ae,{className:"w-6 h-6 text-orange-600"}),title:"승인 대기",status:"승인 처리 대기중",color:"bg-orange-50 text-orange-700 border-orange-200"};case"purchase":return{icon:e.jsx(V,{className:"w-6 h-6 text-yellow-600"}),title:"구매 대기",status:"구매 처리 대기중",color:"bg-yellow-50 text-yellow-700 border-yellow-200"};case"delivery":return{icon:e.jsx(ee,{className:"w-6 h-6 text-blue-600"}),title:"입고 대기",status:"입고 처리 대기중",color:"bg-blue-50 text-blue-700 border-blue-200"};case"completed":return{icon:e.jsx(pe,{className:"w-6 h-6 text-green-600"}),title:"처리 완료",status:"모든 처리 완료",color:"bg-green-50 text-green-700 border-green-200"};default:return{icon:e.jsx(he,{className:"w-6 h-6 text-gray-600"}),title:"상태 확인",status:"상태 확인 필요",color:"bg-gray-50 text-gray-700 border-gray-200"}}})();return e.jsx(ue,{open:o,onOpenChange:t,children:e.jsxs(me,{className:"overflow-hidden bg-white rounded-3xl shadow-2xl border-0",style:{maxWidth:"1280px",width:"90vw",maxHeight:"50vh"},showCloseButton:!1,children:[e.jsxs("div",{className:"relative px-6 pt-6 pb-4",children:[e.jsx("button",{onClick:t,className:"absolute right-6 top-6 w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-all duration-200",children:e.jsx(oe,{className:"w-4 h-4 text-gray-500"})}),e.jsx("div",{className:"pr-16",children:e.jsxs("div",{className:"flex items-start gap-4 mb-2",children:[e.jsx("div",{className:"w-10 h-10 rounded-2xl bg-blue-50 flex items-center justify-center flex-shrink-0",children:x.icon}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("h1",{className:"modal-title mb-1",children:c.purchase_order_number||"PO번호 없음"}),e.jsx("p",{className:"modal-subtitle",children:c.vendor_name||"업체명 없음"})]}),e.jsx("div",{className:`px-3 py-1.5 rounded-full badge-text ${x.color}`,children:x.title})]})})]}),e.jsxs("div",{className:"overflow-y-auto max-h-[calc(50vh-160px)] px-6 pb-4 space-y-3",children:[e.jsx("div",{className:"bg-gray-50 rounded-xl p-3 border border-gray-100",children:e.jsxs("div",{className:"grid grid-cols-3 gap-x-4 gap-y-2 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"요청자:"})," ",e.jsx("span",{className:"font-medium",children:c.requester_name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"요청일:"})," ",e.jsx("span",{className:"font-medium",children:new Date(c.request_date||c.created_at).toLocaleDateString("ko-KR")})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"납기요청일:"})," ",e.jsx("span",{className:"font-medium",children:c.delivery_request_date?new Date(c.delivery_request_date).toLocaleDateString("ko-KR"):"미지정"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"업체명:"})," ",e.jsx("span",{className:"font-medium",children:c.vendor_name||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"결제유형:"})," ",e.jsx("span",{className:"font-medium",children:c.payment_category||"일반"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"진행구분:"})," ",e.jsx("span",{className:"font-medium",children:c.progress_type||"일반"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"프로젝트업체:"})," ",e.jsx("span",{className:"font-medium",children:c.project_vendor||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"판매주문번호:"})," ",e.jsx("span",{className:"font-medium",children:c.sales_order_number||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"배송지:"})," ",e.jsx("span",{className:"font-medium",children:c.shipping_address||"본사"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"통화:"})," ",e.jsx("span",{className:"font-medium",children:c.currency||"KRW"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"템플릿:"})," ",e.jsx("span",{className:"font-medium",children:c.po_template_type||"일반"})]}),c.revised_delivery_request_date&&e.jsxs("div",{children:[e.jsx("span",{className:"text-orange-500",children:"변경입고일:"})," ",e.jsx("span",{className:"font-medium text-orange-900",children:new Date(c.revised_delivery_request_date).toLocaleDateString("ko-KR")})]})]})}),e.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 overflow-hidden",children:[e.jsx("div",{className:"bg-gray-50 px-3 py-2 border-b border-gray-100",children:e.jsxs("h3",{className:"text-sm font-medium text-gray-700",children:["주문 품목 (",q.length,"개, 총 ₩",P.toLocaleString(),")"]})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-xs table-fixed",children:[e.jsxs("colgroup",{children:[e.jsx("col",{className:"w-[25%]"}),e.jsx("col",{className:"w-[20%]"}),e.jsx("col",{className:"w-[10%]"}),e.jsx("col",{className:"w-[15%]"}),e.jsx("col",{className:"w-[15%]"}),(r==="delivery"||r==="purchase")&&e.jsx("col",{className:"w-[15%]"})]}),e.jsx("thead",{className:"bg-gray-50 border-b border-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left p-2 font-medium text-gray-600",children:"품목명"}),e.jsx("th",{className:"text-left p-2 font-medium text-gray-600",children:"규격"}),e.jsx("th",{className:"text-right p-2 font-medium text-gray-600",children:"수량"}),e.jsx("th",{className:"text-right p-2 font-medium text-gray-600",children:"단가"}),e.jsx("th",{className:"text-right p-2 font-medium text-gray-600",children:"금액"}),r==="delivery"&&e.jsx("th",{className:"text-center p-2 font-medium text-gray-600",children:"입고상태"}),r==="purchase"&&e.jsx("th",{className:"text-center p-2 font-medium text-gray-600",children:"구매상태"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:q.map((g,j)=>{const S=g.quantity>0?(Number(g.amount_value)||0)/g.quantity:0;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsxs("td",{className:"p-2",children:[e.jsx("div",{className:"font-medium text-gray-900",children:g.item_name||"품목명 없음"}),g.remark&&e.jsxs("div",{className:"text-xs text-amber-600 mt-1",children:["비고: ",g.remark]})]}),e.jsx("td",{className:"p-2 text-gray-600",children:g.specification||"-"}),e.jsx("td",{className:"p-2 text-right font-medium",children:g.quantity||0}),e.jsxs("td",{className:"p-2 text-right",children:["₩",S.toLocaleString()]}),e.jsxs("td",{className:"p-2 text-right font-medium",children:["₩",(Number(g.amount_value)||0).toLocaleString()]}),r==="delivery"&&e.jsx("td",{className:"p-2 text-center",children:g.is_received?e.jsxs("span",{className:"inline-flex items-center gap-1 bg-green-50 text-green-700 px-2 py-1 rounded text-xs border border-green-200",children:[e.jsx(Z,{className:"w-3 h-3"}),"완료"]}):e.jsxs("span",{className:"inline-flex items-center gap-1 bg-gray-50 text-gray-600 px-2 py-1 rounded text-xs border border-gray-200",children:[e.jsx(ae,{className:"w-3 h-3"}),"대기"]})}),r==="purchase"&&e.jsx("td",{className:"p-2 text-center",children:g.is_payment_completed?e.jsxs("span",{className:"inline-flex items-center gap-1 bg-green-50 text-green-700 px-2 py-1 rounded text-xs border border-green-200",children:[e.jsx(Z,{className:"w-3 h-3"}),"완료"]}):(_.includes("app_admin")||_.includes("lead buyer")||_.includes("receiver"))&&e.jsx(C,{size:"sm",onClick:async()=>{if(confirm("이 품목을 구매완료 처리하시겠습니까?"))try{const{error:R}=await i.from("purchase_request_items").update({is_payment_completed:!0,payment_completed_at:new Date().toISOString()}).eq("id",g.id);if(R)throw R;w(M=>({...M,purchase_request_items:M.purchase_request_items?.map($=>$.id===g.id?{...$,is_payment_completed:!0,payment_completed_at:new Date().toISOString()}:$)})),k.success("품목 구매완료 처리되었습니다."),a?.()}catch{k.error("처리 중 오류가 발생했습니다.")}},className:"bg-yellow-600 hover:bg-yellow-700 text-white px-2 py-1 text-xs font-medium",children:"구매완료"})})]},j)})})]})})]}),r==="delivery"&&q.length>1&&e.jsx("div",{className:"bg-blue-50 rounded-xl p-3 border border-blue-100",children:(()=>{const g=q.filter(R=>R.is_received).length,j=q.length,S=g/j*100;return e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"text-sm font-medium text-blue-700",children:"입고 진행률"}),e.jsx("div",{className:"flex-1 bg-blue-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-500",style:{width:`${S}%`}})}),e.jsxs("div",{className:"text-sm font-medium text-blue-700",children:[g,"/",j," (",S.toFixed(0),"%)"]})]})})()})]}),e.jsx("div",{className:"sticky bottom-0 bg-white border-t border-gray-100 px-6 py-6",children:e.jsxs("div",{className:"flex items-center justify-between gap-6",children:[r==="purchase"&&(_.includes("app_admin")||_.includes("lead buyer")||_.includes("receiver"))&&e.jsxs(C,{onClick:async()=>{y(!0);try{const{error:g}=await i.from("purchase_requests").update({is_payment_completed:!0,payment_completed_at:new Date().toISOString()}).eq("id",c.id);if(g)throw g;w(j=>({...j,is_payment_completed:!0,payment_completed_at:new Date().toISOString()})),k.success("구매완료 처리되었습니다."),a?.()}catch{k.error("처리 중 오류가 발생했습니다.")}finally{y(!1)}},disabled:h,className:"bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-8 py-4 rounded-2xl shadow-lg transition-all duration-200 modal-subtitle",children:[h?e.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-3"}):e.jsx(Z,{className:"w-5 h-5 mr-3"}),"구매 완료 처리"]}),e.jsxs("div",{className:"flex items-center gap-4 ml-auto",children:[e.jsxs(C,{variant:"outline",onClick:()=>{u(`/purchase?highlight=${c.id}`),t()},className:"border-gray-300 text-gray-700 hover:bg-gray-50 hover:text-gray-900 hover:border-gray-400 px-8 py-4 rounded-2xl modal-subtitle transition-all duration-200",children:["발주 목록에서 보기",e.jsx(se,{className:"w-5 h-5 ml-3"})]}),e.jsx(C,{onClick:t,className:"bg-gray-900 hover:bg-gray-800 text-white px-10 py-4 rounded-2xl modal-subtitle transition-all duration-200 shadow-lg",children:"완료"})]})]})})]})})}function Ze(){const[o,t]=b.useState(null),[n,r]=b.useState(!0),[a,u]=b.useState(null),[i,_]=b.useState(null),[m,h]=b.useState(!1),[y,c]=b.useState([]),[w,q]=b.useState([]),[P,T]=b.useState(new Set),[x,g]=b.useState(null),[j,S]=b.useState(!1),[R,M]=b.useState(null),[$,te]=b.useState(null),[ge,re]=b.useState(!1),[O,F]=b.useState({undownloaded:"",pending:"",purchase:"",delivery:""}),Y=de(),ne=X(),E=b.useCallback(async(s=!0)=>{try{s&&r(!0);const l=X(),{data:{user:d},error:N}=await l.auth.getUser();if(N){console.error("Auth error:",N),k.error("인증 정보를 불러올 수 없습니다.");return}if(!d){console.error("No user found in auth"),k.error("로그인이 필요합니다.");return}const{data:p,error:f}=await l.from("employees").select("*").eq("email",d.email).single();if(f||!p){console.error("Employee fetch error:",f);const v={id:d.id,name:d.email?.split("@")[0]||"Guest User",email:d.email||"",purchase_role:null};try{const D=await K.getDashboardData(v);t(D)}catch(D){console.error("❌ 대시보드 데이터 로딩 에러:",D)}r(!1);return}console.log("🔍 조회된 Employee 데이터:",{id:p.id,name:p.name,email:p.email,employee_number:p.employee_number,employeeID:p.employeeID,purchase_role:p.purchase_role}),console.log("========== 대시보드 데이터 로딩 시작 =========="),console.log("1️⃣ 현재 사용자:",p.name,"/ Email:",p.email),console.log("2️⃣ Purchase Role:",p.purchase_role);try{const v=await K.getDashboardData(p),D=await K.getTotalDeliveryWaitingCount();t(v)}catch(v){console.error("❌ 대시보드 데이터 로딩 에러:",v),k.error("대시보드 데이터를 불러오는데 실패했습니다.")}if(p.purchase_role){const v=Array.isArray(p.purchase_role)?p.purchase_role.map(D=>String(D).trim()):String(p.purchase_role).split(",").map(D=>D.trim()).filter(D=>D.length>0);if(c(v),v.includes("lead buyer")||v.includes("lead buyer")){const D=await K.getUndownloadedOrders(p);q(D)}}}catch{}finally{s&&r(!1)}},[]);b.useEffect(()=>{E()},[E]);const le=async s=>{if(console.log("handleQuickApprove 호출:",{requestId:s,hasData:!!o,hasEmployee:!!o?.employee,employee:o?.employee}),!o?.employee){console.error("handleQuickApprove 에러: data.employee가 없음",{data:o}),k.error("사용자 정보를 찾을 수 없습니다.");return}if(!confirm("정말로 승인하시겠습니까?"))return;u(s);const l=o;t(d=>d&&{...d,pendingApprovals:d.pendingApprovals.filter(N=>N.id!==s),stats:{...d.stats,pending:Math.max(0,d.stats.pending-1)}});try{const d=await K.quickApprove(s,o.employee);d.success?(k.success("승인이 완료되었습니다."),setTimeout(()=>{E(!1)},1e3)):(t(l),k.error(d.error||"승인 처리 중 오류가 발생했습니다."))}catch{t(l),k.error("승인 처리 중 오류가 발생했습니다.")}finally{u(null)}},ie=(s,l)=>{M(s),te(l),re(!0)},J=(s,l)=>l.trim()?s.filter(d=>{const N=d.purchase_order_number||"",p=d.vendor_name||"",f=(d.purchase_request_items||[]).map(v=>v.item_name||"").join(" ");return[N,p,f].join(" ").toLowerCase().includes(l.toLowerCase())}):s,ce=async s=>{try{T(A=>new Set(A).add(s.id));const l=new fe.Workbook,d=l.addWorksheet("발주서");d.columns=[{header:"발주번호",key:"purchase_order_number",width:20},{header:"업체명",key:"vendor_name",width:30},{header:"품목명",key:"item_name",width:40},{header:"규격",key:"specification",width:30},{header:"수량",key:"quantity",width:15},{header:"단가",key:"unit_price",width:20},{header:"금액",key:"amount",width:20},{header:"요청일",key:"request_date",width:15},{header:"진행상태",key:"progress_type",width:15}],(s.purchase_request_items||[]).forEach(A=>{d.addRow({purchase_order_number:s.purchase_order_number,vendor_name:s.vendor_name||s.vendors?.vendor_name||"",item_name:A.item_name||"",specification:A.specification||"",quantity:A.quantity||0,unit_price:A.unit_price_value||0,amount:A.amount_value||0,request_date:s.request_date||"",progress_type:s.progress_type||""})}),d.getRow(1).font={bold:!0},d.getRow(1).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFE0E0E0"}};const p=await l.xlsx.writeBuffer(),f=new Blob([p],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),v=window.URL.createObjectURL(f),D=document.createElement("a");D.href=v,D.download=`발주서_${s.purchase_order_number}_${new Date().toISOString().slice(0,10)}.xlsx`,D.click(),window.URL.revokeObjectURL(v),(y.includes("lead buyer")||y.includes("lead buyer"))&&(await ne.from("purchase_requests").update({is_po_download:!0}).eq("id",s.id),q(A=>A.filter(ye=>ye.id!==s.id))),k.success("발주서가 다운로드되었습니다.")}catch(l){console.error("Excel download error:",l),k.error("다운로드 중 오류가 발생했습니다.")}finally{T(l=>{const d=new Set(l);return d.delete(s.id),d})}},xe=s=>{switch(s){case"high":return"bg-red-100 text-red-800 border-red-200";case"medium":return"bg-yellow-100 text-yellow-800 border-yellow-200";case"low":return"bg-green-100 text-green-800 border-green-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}};if(n)return e.jsx("div",{className:"flex items-center justify-center h-screen bg-gray-50",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-12 h-12 border-3 border-hansl-500 border-t-transparent rounded-full animate-spin mx-auto"}),e.jsx("p",{className:"mt-4 card-subtitle",children:"대시보드를 불러오고 있습니다..."})]})});if(!o?.employee)return e.jsx("div",{className:"flex items-center justify-center h-screen bg-gray-50",children:e.jsxs("div",{className:"text-center bg-white p-8 rounded-lg border border-gray-200",children:[e.jsx("h3",{className:"modal-subtitle mb-2",children:"사용자 정보를 찾을 수 없습니다"}),e.jsx("p",{className:"card-subtitle",children:"로그인을 다시 시도해주세요."})]})});const _e=(Array.isArray(o.employee.purchase_role)?o.employee.purchase_role.map(s=>String(s).trim()):o.employee.purchase_role?String(o.employee.purchase_role).split(",").map(s=>s.trim()).filter(s=>s.length>0):[]).some(s=>["middle_manager","final_approver","app_admin","raw_material_manager","consumable_manager"].includes(s));return e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsxs("div",{className:"w-full px-4 lg:px-6",children:[e.jsx("div",{className:"mb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"header-title",children:"대시보드"}),e.jsxs("p",{className:"header-subtitle mt-0.5",children:[o.employee.name,"님, 환영합니다. 📊"]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(L,{variant:"outline",className:"badge-text",children:new Date().toLocaleDateString("ko-KR",{month:"long",day:"numeric",weekday:"short"})})})]})}),o.urgentRequests.length>0&&e.jsxs(U,{className:"mb-3 border-red-200 bg-red-50",children:[e.jsx(I,{className:"pb-2 pt-3",children:e.jsxs(B,{className:"flex items-center gap-2 text-red-800 card-title",children:[e.jsx(ke,{className:"w-4 h-4"}),"긴급 처리 필요 (",o.urgentRequests.length,"건)"]})}),e.jsx(z,{className:"p-3",children:e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2",children:o.urgentRequests.slice(0,5).map(s=>e.jsx("div",{className:"bg-white rounded-lg p-2 border border-red-200 min-w-[280px] flex-shrink-0",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-1 mb-1",children:[e.jsx(L,{className:`${xe(s.priority)} badge-text h-4 px-1`,children:s.priority==="high"?"높음":s.priority==="medium"?"보통":"낮음"}),e.jsx("span",{className:"card-subtitle truncate max-w-[120px]",children:s.vendor_name||"업체명 없음"}),e.jsxs("span",{className:"card-date",children:[s.daysOverdue,"일 지연"]})]}),e.jsxs("div",{className:"card-description",children:[e.jsxs("span",{children:["발주: ",s.purchase_order_number||s.id.slice(0,8)]}),e.jsxs("span",{className:"ml-1",children:["• ",s.total_items,"개"]})]})]}),e.jsxs("div",{className:"flex gap-1 shrink-0",children:[e.jsxs(C,{size:"sm",variant:"outline",onClick:()=>Y(`/purchase?highlight=${s.id}`),className:"h-6 px-2 badge-text",children:[e.jsx(ve,{className:"w-3 h-3 mr-0.5"}),"보기"]}),e.jsxs(C,{size:"sm",onClick:()=>le(s.id),disabled:a===s.id,className:"bg-red-600 hover:bg-red-700 h-6 px-2 badge-text",children:[e.jsx(Se,{className:"w-3 h-3 mr-0.5"}),a===s.id?"처리중":"승인"]})]})]})},s.id))})})]}),e.jsx("div",{className:"mb-2",children:e.jsxs("h2",{className:"section-title mb-2 flex items-center gap-1.5",children:[e.jsx(he,{className:"w-3.5 h-3.5 text-gray-600"}),"전체 현황"]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3",children:[(y.includes("lead buyer")||y.includes("lead buyer"))&&w.length>0&&e.jsxs(U,{className:"w-full col-span-1 row-span-2 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[e.jsx(I,{className:"py-3 px-4 bg-gray-50 border-b",children:e.jsxs(B,{className:"section-title flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{className:"w-4 h-4 text-orange-600"}),e.jsx("span",{children:"미다운로드 발주서"})]}),e.jsx(L,{className:"bg-orange-100 text-orange-700 border-orange-200 px-2 py-0.5",children:w.length})]})}),e.jsx(z,{className:"p-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Q,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx(H,{placeholder:"발주번호, 업체명, 품목으로 검색...",value:O.undownloaded,onChange:s=>F(l=>({...l,undownloaded:s.target.value})),className:"pl-10 h-8 text-xs"})]}),e.jsx("div",{className:"space-y-2 h-[36rem] overflow-y-auto",children:J(w,O.undownloaded).slice(0,10).map(s=>{const l=s.purchase_request_items||[],d=l[0]||{};l.reduce((f,v)=>f+(Number(v.amount_value)||0),0),l.reduce((f,v)=>f+(Number(v.quantity)||0),0);const N=Math.floor((Date.now()-new Date(s.created_at).getTime())/(1e3*60*60*24)),p=s.progress_type==="선진행";return e.jsx("div",{className:`border rounded-lg p-2 transition-all cursor-pointer hover:shadow-sm ${p?"bg-red-50 hover:bg-red-100 border-red-200":"bg-white hover:bg-gray-50 border-gray-200"}`,onClick:()=>{g(s),S(!0)},children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx("span",{className:"card-title",children:s.purchase_order_number||`PO-${s.id.slice(0,8)}`}),e.jsx("span",{className:"card-subtitle truncate",children:s.vendor_name||"업체명 없음"}),e.jsxs("span",{className:"card-description truncate",children:[d.item_name||"품목",l.length>1&&e.jsxs("span",{className:"text-gray-400",children:[" 외 ",l.length-1,"건"]})]}),N>3&&e.jsxs(L,{variant:"outline",className:"badge-text px-1.5 py-0 flex-shrink-0",children:[N,"일"]})]}),e.jsx("div",{children:e.jsx(C,{size:"sm",variant:"outline",className:"h-7 px-2 badge-text border-orange-200 hover:bg-orange-50",onClick:f=>{f.stopPropagation(),ce(s)},disabled:P.has(s.id),children:P.has(s.id)?e.jsx("div",{className:"w-3 h-3 border border-orange-600 border-t-transparent rounded-full animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"w-3 h-3 mr-1"}),"다운로드"]})})})]})},s.id)})})]})})]}),_e&&e.jsxs(U,{className:"w-full col-span-1 row-span-2",children:[e.jsx(I,{className:"pb-2 pt-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(B,{className:"section-title flex items-center gap-1.5",children:[e.jsx(ae,{className:"w-3.5 h-3.5 text-orange-500"}),"승인 대기",o.pendingApprovals.length>0&&e.jsx(L,{variant:"destructive",className:"badge-text h-4 px-1",children:o.pendingApprovals.length})]}),o.pendingApprovals.length>0&&e.jsx(C,{size:"sm",variant:"ghost",onClick:()=>Y("/purchase"),className:"h-6 px-2",children:e.jsx(se,{className:"w-3 h-3"})})]})}),e.jsx(z,{className:"p-3",children:o.pendingApprovals.length===0?e.jsxs("div",{className:"text-center py-4 text-gray-400",children:[e.jsx(pe,{className:"w-6 h-6 mx-auto mb-1"}),e.jsx("p",{className:"card-description",children:"대기 항목 없음"})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Q,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx(H,{placeholder:"발주번호, 업체명, 품목으로 검색...",value:O.pending,onChange:s=>F(l=>({...l,pending:s.target.value})),className:"pl-10 h-8 text-xs"})]}),e.jsx("div",{className:"space-y-1.5 h-[36rem] overflow-y-auto",children:J(o.pendingApprovals,O.pending).slice(0,10).map(s=>{const l=s.purchase_request_items||[],d=l[0]||{};s.total_amount||l.reduce((p,f)=>p+(Number(f.amount_value)||0),0);const N=s.progress_type==="선진행";return e.jsx("div",{className:`border rounded-lg p-2 hover:shadow-sm transition-all cursor-pointer ${N?"bg-red-50 border-red-200":"hover:bg-orange-50/30"}`,onClick:p=>{p.target.closest("button")||(_(Number(s.id)),h(!0))},children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx("span",{className:"card-title",children:s.purchase_order_number}),e.jsx("span",{className:"card-subtitle truncate",children:s.vendor_name||"업체"}),e.jsxs("span",{className:"card-description truncate",children:[d.item_name||"품목"," ",l.length>1&&`외 ${l.length-1}건`]})]}),e.jsx(C,{size:"sm",onClick:p=>{p.stopPropagation(),le(s.id)},disabled:a===s.id,className:`h-7 px-2 text-white badge-text shrink-0 ${s.middle_manager_status==="approved"?"bg-blue-600 hover:bg-blue-700":"bg-green-600 hover:bg-green-700"}`,children:a===s.id?e.jsx("div",{className:"w-3 h-3 border border-white border-t-transparent rounded-full animate-spin"}):e.jsxs(e.Fragment,{children:[s.middle_manager_status==="approved"?"최종":"1차"," 승인"]})})]})},s.id)})})]})})]}),e.jsxs(U,{className:"w-full col-span-1 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[e.jsx(I,{className:"py-3 px-4 bg-gray-50 border-b",children:e.jsxs(B,{className:"section-title flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(V,{className:"w-4 h-4 text-yellow-600"}),e.jsx("span",{children:"구매 대기"})]}),o.myPurchaseStatus&&o.myPurchaseStatus.waitingPurchase&&o.myPurchaseStatus.waitingPurchase.length>0&&e.jsx(L,{className:"bg-yellow-100 text-yellow-700 border-yellow-200 px-2 py-0.5",children:o.myPurchaseStatus.waitingPurchase.length})]})}),e.jsx(z,{className:"p-4",children:!o.myPurchaseStatus||!o.myPurchaseStatus.waitingPurchase||o.myPurchaseStatus.waitingPurchase.length===0?e.jsxs("div",{className:"text-center py-12 text-gray-400",children:[e.jsx(V,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"card-subtitle",children:"구매 대기 항목이 없습니다"})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Q,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx(H,{placeholder:"발주번호, 업체명, 품목으로 검색...",value:O.purchase,onChange:s=>F(l=>({...l,purchase:s.target.value})),className:"pl-10 h-8 text-xs"})]}),e.jsx("div",{className:"space-y-2 h-[36rem] overflow-y-auto",children:J(o.myPurchaseStatus.waitingPurchase,O.purchase).slice(0,10).map(s=>{const l=s.purchase_request_items||[],d=l[0];l.reduce((p,f)=>p+(Number(f.amount_value)||0),0);const N=(s.progress_type||"").includes("선진행");return e.jsx("div",{className:`border rounded-lg p-3 transition-all hover:shadow-sm ${N?"bg-red-50 hover:bg-red-100 border-red-200":"bg-white hover:bg-gray-50 border-gray-200"}`,children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1 cursor-pointer",onClick:()=>ie(s,"purchase"),children:[e.jsx("span",{className:"card-title",children:s.purchase_order_number||`PO-${s.id.slice(0,8)}`}),e.jsx("span",{className:"card-subtitle truncate",children:s.vendor_name||"업체명 없음"}),e.jsxs("span",{className:"card-description truncate",children:[d?.item_name||"품목",l.length>1&&e.jsxs("span",{className:"text-gray-400",children:[" 외 ",l.length-1,"건"]})]})]}),(y.includes("lead buyer")||y.includes("app_admin")||y.includes("receiver"))&&!s.is_payment_completed&&e.jsx(C,{size:"sm",onClick:async p=>{if(p.stopPropagation(),!!confirm("이 발주를 구매완료 처리하시겠습니까?"))try{const{error:f}=await ne.from("purchase_requests").update({is_payment_completed:!0,payment_completed_at:new Date().toISOString()}).eq("id",s.id);if(f)throw f;k.success("구매완료 처리되었습니다."),E(!1)}catch{k.error("처리 중 오류가 발생했습니다.")}},className:"bg-yellow-600 hover:bg-yellow-700 text-white h-7 px-2 badge-text shrink-0",children:"구매완료"}),s.is_payment_completed&&e.jsx("div",{className:"bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-medium shrink-0",children:"완료됨"})]})},s.id)})})]})})]}),e.jsxs(U,{className:"w-full col-span-1 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[e.jsx(I,{className:"py-3 px-4 bg-gray-50 border-b",children:e.jsxs(B,{className:"section-title flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ee,{className:"w-4 h-4 text-blue-600"}),e.jsx("span",{children:"입고 대기"})]}),o.myPurchaseStatus.waitingDelivery.length>0&&e.jsx(L,{className:"bg-blue-100 text-blue-700 border-blue-200 px-2 py-0.5",children:o.myPurchaseStatus.waitingDelivery.length})]})}),e.jsx(z,{className:"p-4",children:o.myPurchaseStatus.waitingDelivery.length===0?e.jsxs("div",{className:"text-center py-12 text-gray-400",children:[e.jsx(ee,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),e.jsx("p",{className:"card-subtitle",children:"입고 대기 항목이 없습니다"})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Q,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx(H,{placeholder:"발주번호, 업체명, 품목으로 검색...",value:O.delivery,onChange:s=>F(l=>({...l,delivery:s.target.value})),className:"pl-10 h-8 text-xs"})]}),e.jsx("div",{className:"space-y-2 h-[36rem] overflow-y-auto",children:J(o.myPurchaseStatus.waitingDelivery,O.delivery).slice(0,10).map(s=>{const l=s.purchase_request_items||[],d=l[0],N=l.length;l.filter(f=>f.is_received).length,l.reduce((f,v)=>f+(Number(v.amount_value)||0),0);const p=(s.progress_type||"").includes("선진행");return e.jsx("div",{className:`border rounded-lg p-3 transition-all cursor-pointer hover:shadow-sm ${p?"bg-red-50 hover:bg-red-100 border-red-200":"bg-white hover:bg-gray-50 border-gray-200"}`,onClick:()=>ie(s,"delivery"),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"card-title",children:s.purchase_order_number||`PO-${s.id.slice(0,8)}`}),e.jsx("span",{className:"card-subtitle truncate",children:s.vendor_name||"업체명 없음"}),e.jsxs("span",{className:"card-description truncate",children:[d?.item_name||"품목",N>1&&e.jsxs("span",{className:"text-gray-400",children:[" 외 ",N-1,"건"]})]})]})},s.id)})})]})})]})]})]}),e.jsx(be,{purchaseId:i,isOpen:m,onClose:()=>{h(!1),_(null)},currentUserRoles:y,onRefresh:()=>{E(),h(!1),_(null)}}),e.jsx(Pe,{isOpen:ge,onClose:()=>{re(!1),M(null),te(null)},item:R,type:$,onRefresh:()=>E(!1)}),j&&x&&e.jsx(ue,{open:j,onOpenChange:()=>{S(!1),g(null)},children:e.jsxs(me,{className:"overflow-hidden bg-white rounded-3xl shadow-2xl border-0",style:{maxWidth:"1280px",width:"90vw",maxHeight:"50vh"},showCloseButton:!1,children:[e.jsxs("div",{className:"relative px-6 pt-6 pb-4",children:[e.jsx("button",{onClick:()=>{S(!1),g(null)},className:"absolute right-6 top-6 w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-all duration-200",children:e.jsx(oe,{className:"w-4 h-4 text-gray-500"})}),e.jsx("div",{className:"pr-16",children:e.jsxs("div",{className:"flex items-start gap-4 mb-2",children:[e.jsx("div",{className:"w-10 h-10 rounded-2xl bg-orange-50 flex items-center justify-center flex-shrink-0",children:e.jsx(G,{className:"w-6 h-6 text-orange-600"})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("h1",{className:"modal-title mb-1",children:x.purchase_order_number||"PO번호 없음"}),e.jsx("p",{className:"modal-subtitle",children:x.vendor_name||"업체명 없음"})]}),e.jsx("div",{className:"px-3 py-1.5 rounded-full badge-text bg-orange-50 text-orange-700 border-orange-200",children:"미다운로드"})]})})]}),e.jsxs("div",{className:"overflow-y-auto max-h-[calc(50vh-160px)] px-6 pb-4 space-y-3",children:[e.jsx("div",{className:"bg-gray-50 rounded-xl p-3 border border-gray-100",children:e.jsxs("div",{className:"grid grid-cols-3 gap-x-4 gap-y-2 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"요청자:"})," ",e.jsx("span",{className:"font-medium",children:x.requester_name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"요청일:"})," ",e.jsx("span",{className:"font-medium",children:new Date(x.request_date||x.created_at).toLocaleDateString("ko-KR")})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"납기요청일:"})," ",e.jsx("span",{className:"font-medium",children:x.delivery_request_date?new Date(x.delivery_request_date).toLocaleDateString("ko-KR"):"미지정"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"업체명:"})," ",e.jsx("span",{className:"font-medium",children:x.vendor_name||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"결제유형:"})," ",e.jsx("span",{className:"font-medium",children:x.payment_category||"일반"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"진행구분:"})," ",e.jsx("span",{className:"font-medium",children:x.progress_type||"일반"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"프로젝트업체:"})," ",e.jsx("span",{className:"font-medium",children:x.project_vendor||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"판매주문번호:"})," ",e.jsx("span",{className:"font-medium",children:x.sales_order_number||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"배송지:"})," ",e.jsx("span",{className:"font-medium",children:x.shipping_address||"본사"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"통화:"})," ",e.jsx("span",{className:"font-medium",children:x.currency||"KRW"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"템플릿:"})," ",e.jsx("span",{className:"font-medium",children:x.po_template_type||"일반"})]}),x.revised_delivery_request_date&&e.jsxs("div",{children:[e.jsx("span",{className:"text-orange-500",children:"변경입고일:"})," ",e.jsx("span",{className:"font-medium text-orange-900",children:new Date(x.revised_delivery_request_date).toLocaleDateString("ko-KR")})]})]})}),e.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 overflow-hidden",children:[e.jsx("div",{className:"bg-gray-50 px-3 py-2 border-b border-gray-100",children:e.jsxs("h3",{className:"text-sm font-medium text-gray-700",children:["주문 품목 (",(x.purchase_request_items||[]).length,"개, 총 ₩",(x.purchase_request_items||[]).reduce((s,l)=>s+(Number(l.amount_value)||0),0).toLocaleString(),")"]})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-xs table-fixed",children:[e.jsxs("colgroup",{children:[e.jsx("col",{className:"w-[30%]"}),e.jsx("col",{className:"w-[25%]"}),e.jsx("col",{className:"w-[10%]"}),e.jsx("col",{className:"w-[15%]"}),e.jsx("col",{className:"w-[20%]"})]}),e.jsx("thead",{className:"bg-gray-50 border-b border-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left p-2 font-medium text-gray-600",children:"품목명"}),e.jsx("th",{className:"text-left p-2 font-medium text-gray-600",children:"규격"}),e.jsx("th",{className:"text-right p-2 font-medium text-gray-600",children:"수량"}),e.jsx("th",{className:"text-right p-2 font-medium text-gray-600",children:"단가"}),e.jsx("th",{className:"text-right p-2 font-medium text-gray-600",children:"금액"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:(x.purchase_request_items||[]).map((s,l)=>{const d=s.quantity>0?(Number(s.amount_value)||0)/s.quantity:0;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsxs("td",{className:"p-2",children:[e.jsx("div",{className:"font-medium text-gray-900",children:s.item_name||"품목명 없음"}),s.remark&&e.jsxs("div",{className:"text-xs text-amber-600 mt-1",children:["비고: ",s.remark]})]}),e.jsx("td",{className:"p-2 text-gray-600",children:s.specification||"-"}),e.jsx("td",{className:"p-2 text-right font-medium",children:s.quantity||0}),e.jsxs("td",{className:"p-2 text-right",children:["₩",d.toLocaleString()]}),e.jsxs("td",{className:"p-2 text-right font-medium",children:["₩",(Number(s.amount_value)||0).toLocaleString()]})]},l)})})]})})]})]}),e.jsx("div",{className:"sticky bottom-0 bg-white border-t border-gray-100 px-6 py-6",children:e.jsxs("div",{className:"flex items-center justify-between gap-6",children:[e.jsxs(C,{onClick:()=>ce(x),disabled:P.has(x.id),className:"bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white px-8 py-4 rounded-2xl shadow-lg transition-all duration-200 modal-subtitle",children:[P.has(x.id)?e.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-3"}):e.jsx(G,{className:"w-5 h-5 mr-3"}),"Excel 다운로드"]}),e.jsxs("div",{className:"flex items-center gap-4 ml-auto",children:[e.jsxs(C,{variant:"outline",onClick:()=>{Y("/purchase/list?tab=purchase"),S(!1),g(null)},className:"border-gray-300 text-gray-700 hover:bg-gray-50 hover:text-gray-900 hover:border-gray-400 px-8 py-4 rounded-2xl modal-subtitle transition-all duration-200",children:["발주 목록에서 보기",e.jsx(se,{className:"w-5 h-5 ml-3"})]}),e.jsx(C,{onClick:()=>{S(!1),g(null)},className:"bg-gray-900 hover:bg-gray-800 text-white px-10 py-4 rounded-2xl modal-subtitle transition-all duration-200 shadow-lg",children:"완료"})]})]})})]})})]})}export{Ze as default};
//# sourceMappingURL=DashboardMain-3H0qQvc0.js.map
