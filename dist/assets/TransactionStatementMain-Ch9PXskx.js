import{e,r as t,c as r,j as s,X as a,B as n,a3 as i,a4 as c,w as l}from"./index-BvgUOoDT.js";import{S as o,C as d,c as m,T as u}from"./card-Wm6gpivN.js";import{D as x,a as p,b as h,c as _,d as b,P as g,I as f}from"./dialog-DdzUS4Ws.js";import{t as y}from"./index-CFnxfa1n.js";import{S as j,a as N,b as v,c as w,d as S}from"./select-CV3XYGsq.js";import{I as C,t as k,n as q,C as M,P as O}from"./PurchaseDetailModal-CCHz74r9.js";import{U as $,Z as z,a as E}from"./zoom-out-CUgnMWZ6.js";import{L as I}from"./loader-circle-s52mQtgW.js";import{D as R}from"./download-BryjDUOb.js";import{C as W}from"./chevron-down-CoVvPEu-.js";import{C as F}from"./check-7yeTsVP_.js";import{C as D}from"./chevron-right-BrDLAKzG.js";import{C as L}from"./clock-BZ3j9l5b.js";import"./index-yabZEjOu.js";import"./helpers-CmqE03mo.js";import"./react-select.esm-B52KLWOb.js";import"./popover-Bde3Div9.js";import"./textarea-joNJfKvn.js";import"./calendar-Bl9nu6EP.js";import"./credit-card-DT2RYO8x.js";import"./save-BaaXvmMI.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const P=e("circle-x",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]),U=e("external-link",[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]]),B=e("refresh-cw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]),T=e("rotate-cw",[["path",{d:"M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8",key:"1p45f6"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}]]),H=e("sliders-horizontal",[["line",{x1:"21",x2:"14",y1:"4",y2:"4",key:"obuewd"}],["line",{x1:"10",x2:"3",y1:"4",y2:"4",key:"1q6298"}],["line",{x1:"21",x2:"12",y1:"12",y2:"12",key:"1iu8h1"}],["line",{x1:"8",x2:"3",y1:"12",y2:"12",key:"ntss68"}],["line",{x1:"21",x2:"16",y1:"20",y2:"20",key:"14d8ph"}],["line",{x1:"12",x2:"3",y1:"20",y2:"20",key:"m0wm8r"}],["line",{x1:"14",x2:"14",y1:"2",y2:"6",key:"14e1ph"}],["line",{x1:"8",x2:"8",y1:"10",y2:"14",key:"1i6ji0"}],["line",{x1:"16",x2:"16",y1:"18",y2:"22",key:"1lctlv"}]]);function A({isOpen:e,onClose:i,onSuccess:c}){const[l,o]=t.useState(null),[d,m]=t.useState(null),[u,g]=t.useState(!1),[f,j]=t.useState(""),N=t.useRef(null),v=r();t.useEffect(()=>{e&&(async()=>{try{const{data:{user:e}}=await v.auth.getUser();if(e?.email){const{data:t}=await v.from("employees").select("name").eq("email",e.email).single();t?.name&&j(t.name)}}catch(e){}})()},[e]);const w=e=>{if(!e.type.startsWith("image/"))return void y.error("ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.");if(e.size>10485760)return void y.error("íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.");o(e);const t=new FileReader;t.onloadend=()=>{m(t.result)},t.readAsDataURL(e)},S=()=>{u||(o(null),m(null),N.current&&(N.current.value=""),i())};return s.jsx(x,{open:e,onOpenChange:S,children:s.jsxs(p,{className:"sm:max-w-[480px] business-radius-modal",children:[s.jsx(h,{className:"border-b border-gray-100 pb-3",children:s.jsxs(_,{className:"flex items-center gap-2 text-[13px] font-bold text-gray-900",children:[s.jsx($,{className:"w-4 h-4 text-hansl-600"}),"ê±°ëž˜ëª…ì„¸ì„œ ì—…ë¡œë“œ"]})}),s.jsxs("div",{className:"py-4",children:[s.jsxs("div",{className:`\n              border-2 border-dashed business-radius-card p-6 text-center cursor-pointer transition-colors\n              ${d?"border-hansl-300 bg-hansl-50":"border-gray-200 hover:border-hansl-300 hover:bg-gray-50"}\n            `,onDrop:e=>{e.preventDefault(),e.stopPropagation();const t=e.dataTransfer.files[0];t&&w(t)},onDragOver:e=>{e.preventDefault(),e.stopPropagation()},onClick:()=>{N.current?.click()},children:[s.jsx("input",{ref:N,type:"file",accept:"image/*",onChange:e=>{const t=e.target.files?.[0];t&&w(t)},className:"hidden"}),d?s.jsxs("div",{className:"relative",children:[s.jsx("img",{src:d,alt:"ë¯¸ë¦¬ë³´ê¸°",className:"max-h-52 mx-auto business-radius-card shadow-sm"}),s.jsx("button",{className:"absolute top-2 right-2 p-1.5 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors",onClick:e=>{e.stopPropagation(),o(null),m(null),N.current&&(N.current.value="")},children:s.jsx(a,{className:"w-3.5 h-3.5"})}),s.jsx("p",{className:"mt-3 text-[11px] text-gray-600 truncate px-4",children:l?.name})]}):s.jsxs(s.Fragment,{children:[s.jsx(C,{className:"w-10 h-10 text-gray-300 mx-auto mb-3"}),s.jsx("p",{className:"text-[11px] text-gray-600 mb-1",children:"ê±°ëž˜ëª…ì„¸ì„œ ì´ë¯¸ì§€ë¥¼ ë“œëž˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”"}),s.jsx("p",{className:"text-[10px] text-gray-400",children:"ì§€ì› í˜•ì‹: JPG, PNG, GIF, WEBP (ìµœëŒ€ 10MB)"})]})]}),s.jsx("div",{className:"mt-3 p-2.5 bg-blue-50 business-radius-card border border-blue-100",children:s.jsx("p",{className:"text-[10px] text-blue-700 leading-relaxed",children:"ðŸ’¡ ê±°ëž˜ëª…ì„¸ì„œë¥¼ ì´¬ì˜í•˜ê±°ë‚˜ ìŠ¤ìº”í•œ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”. ì—…ë¡œë“œ í›„ OCRë¡œ í’ˆëª©, ìˆ˜ëŸ‰, ê¸ˆì•¡, ë°œì£¼ë²ˆí˜¸ ë“±ì„ ìžë™ìœ¼ë¡œ ì¶”ì¶œí•©ë‹ˆë‹¤."})})]}),s.jsxs(b,{className:"border-t border-gray-100 pt-3 gap-2",children:[s.jsx(n,{variant:"outline",onClick:S,disabled:u,className:"button-base h-8 text-[11px]",children:"ì·¨ì†Œ"}),s.jsx(n,{onClick:async()=>{if(l)try{g(!0);const e=await k.uploadStatement(l,f||"ì•Œ ìˆ˜ ì—†ìŒ");e.success&&e.data?(y.success("ì—…ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."),c(e.data.statementId,e.data.imageUrl),S()):y.error(e.error||"ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}catch(e){y.error("ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}finally{g(!1)}else y.error("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.")},disabled:!l||u,className:"button-base h-8 text-[11px] bg-hansl-600 hover:bg-hansl-700 text-white",children:u?s.jsxs(s.Fragment,{children:[s.jsx(I,{className:"w-3.5 h-3.5 mr-1.5 animate-spin"}),"ì—…ë¡œë“œ ì¤‘..."]}):s.jsxs(s.Fragment,{children:[s.jsx($,{className:"w-3.5 h-3.5 mr-1.5"}),"ì—…ë¡œë“œ"]})})]})]})})}function K({isOpen:e,imageUrl:r,onClose:n}){const[i,c]=t.useState(1),[l,o]=t.useState(0),d=()=>{c(1),o(0),n()};return r?s.jsx(x,{open:e,onOpenChange:d,children:s.jsxs(p,{className:"max-w-[90vw] max-h-[90vh] p-0 bg-black/95 border-none",children:[s.jsxs("div",{className:"absolute top-0 left-0 right-0 z-50 flex items-center justify-between px-4 py-3 bg-gradient-to-b from-black/80 to-transparent",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("button",{onClick:()=>{c(e=>Math.max(e-.25,.5))},disabled:i<=.5,className:"p-2 rounded-lg bg-white/10 hover:bg-white/20 text-white disabled:opacity-40 transition-colors",children:s.jsx(z,{className:"w-4 h-4"})}),s.jsxs("span",{className:"text-[11px] text-white min-w-[50px] text-center font-medium",children:[Math.round(100*i),"%"]}),s.jsx("button",{onClick:()=>{c(e=>Math.min(e+.25,3))},disabled:i>=3,className:"p-2 rounded-lg bg-white/10 hover:bg-white/20 text-white disabled:opacity-40 transition-colors",children:s.jsx(E,{className:"w-4 h-4"})}),s.jsx("div",{className:"w-px h-5 bg-white/30 mx-1.5"}),s.jsx("button",{onClick:()=>{o(e=>(e+90)%360)},className:"p-2 rounded-lg bg-white/10 hover:bg-white/20 text-white transition-colors",children:s.jsx(T,{className:"w-4 h-4"})}),s.jsx("button",{onClick:async()=>{try{const e=await fetch(r),t=await e.blob(),s=window.URL.createObjectURL(t),a=document.createElement("a");a.href=s,a.download=`ê±°ëž˜ëª…ì„¸ì„œ_${(new Date).toISOString().split("T")[0]}.jpg`,document.body.appendChild(a),a.click(),document.body.removeChild(a),window.URL.revokeObjectURL(s),y.success("ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.")}catch(e){y.error("ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}},className:"p-2 rounded-lg bg-white/10 hover:bg-white/20 text-white transition-colors",children:s.jsx(R,{className:"w-4 h-4"})})]}),s.jsx("button",{onClick:d,className:"p-2 rounded-lg bg-white/10 hover:bg-white/20 text-white transition-colors",children:s.jsx(a,{className:"w-4 h-4"})})]}),s.jsx("div",{className:"flex items-center justify-center w-full h-[80vh] overflow-auto p-4 pt-16",children:s.jsx("img",{src:r,alt:"ê±°ëž˜ëª…ì„¸ì„œ",className:"max-w-full max-h-full object-contain transition-transform duration-200",style:{transform:`scale(${i}) rotate(${l}deg)`}})})]})}):null}function G(e,t){const r=e?.toLowerCase().replace(/\s+/g,"")||"",s=t?.toLowerCase().replace(/\s+/g,"")||"";if(!r||!s)return 0;if(r===s)return 100;const a=Math.min(r.length,s.length),n=Math.max(r.length,s.length),i=a/n;if(r.includes(s)||s.includes(r))return i>=.7?90:i>=.5?70:i>=.3?50:30;const c=(n-function(e,t){const r=e.toLowerCase().replace(/\s+/g,""),s=t.toLowerCase().replace(/\s+/g,"");if(r===s)return 0;if(0===r.length)return s.length;if(0===s.length)return r.length;const a=[];for(let n=0;n<=r.length;n++)a[n]=[n];for(let n=0;n<=s.length;n++)a[0][n]=n;for(let n=1;n<=r.length;n++)for(let e=1;e<=s.length;e++){const t=r[n-1]===s[e-1]?0:1;a[n][e]=Math.min(a[n-1][e]+1,a[n][e-1]+1,a[n-1][e-1]+t)}return a[r.length][s.length]}(r,s))/n*100,l=e?.split(/\s+/).filter(e=>e.length>=2)||[],o=t?.split(/\s+/).filter(e=>e.length>=2)||[];if(0===l.length||0===o.length)return c;const d=l.filter(e=>o.some(t=>{const r=e.toLowerCase(),s=t.toLowerCase();return r===s||r.length>=3&&s.includes(r)||s.length>=3&&r.includes(s)})).length/Math.max(l.length,o.length)*15;return Math.min(100,c+d)}function V(e,t,r){const s=G(e,t),a=r?G(e,r):0;return s>=30?s:a>=60&&s<30?Math.min(35,.4*a):Math.max(s,.3*a)}function J(e,t){return null!=e&&(null!=t&&e===t)}function X({isOpen:e,statement:a,onClose:c,onConfirm:l}){const[d,m]=t.useState(!0),[u,g]=t.useState(!1),[f,j]=t.useState(null),[N,v]=t.useState(!1),[w,S]=t.useState(""),[$,z]=t.useState(""),[E,R]=t.useState(new Map),[D,L]=t.useState(new Map),[B,T]=t.useState(new Set),[H,A]=t.useState({top:0,left:0}),[G,X]=t.useState(!1),[Y,Z]=t.useState(null),[Q,ee]=t.useState(new Map),[te,re]=t.useState(null),[se,ae]=t.useState(!1),[ne,ie]=t.useState(""),[ce,le]=t.useState([]),[oe,de]=t.useState(!1),[me,ue]=t.useState(!1),[xe,pe]=t.useState(null),[he,_e]=t.useState(new Map),be=t.useRef(!1),ge=t.useRef(null),[fe,ye]=t.useState(!1),[je,Ne]=t.useState(""),[ve,we]=t.useState([]),[Se,Ce]=t.useState(!1),[ke,qe]=t.useState(!1),[Me,Oe]=t.useState(!1),[$e,ze]=t.useState(new Map),Ee=t.useRef(new Set),[Ie,Re]=t.useState(null),We=r(),Fe=t.useMemo(()=>{if(!f?.items.length)return!0;const e=f.items.map(e=>e.extracted_po_number?q(e.extracted_po_number):null).filter(Boolean);return 0===e.length||e.every(t=>t===e[0])},[f]),De=t.useMemo(()=>{if(!f?.items.length)return null;const e=f.items.find(e=>e.extracted_po_number)?.extracted_po_number;return e?q(e):null},[f]);t.useEffect(()=>{if(!f)return;const e=f.vendor_name||f.extracted_data?.ocr_vendor_name||"";e&&!ne&&ie(e),e&&!be.current&&(be.current=!0,Ye(e,{silent:!0}))},[f,ne]);const Le=t.useCallback(async()=>{try{m(!0);const{data:{user:e}}=await We.auth.getUser();if(e?.email){const{data:t}=await We.from("employees").select("name").eq("email",e.email).single();t?.name&&S(t.name)}const t=await k.getStatementWithItems(a.id);if(t.success&&t.data){j(t.data);const e=new Map,r=new Map;t.data.items.forEach(t=>{let s="";if(t.extracted_po_number&&(s=q(t.extracted_po_number),e.set(t.id,s)),t.matched_purchase&&t.matched_item_id)r.set(t.id,{purchase_id:t.matched_purchase_id,item_id:t.matched_item_id,purchase_order_number:t.matched_purchase.purchase_order_number||"",sales_order_number:t.matched_purchase.sales_order_number,item_name:t.matched_item_name||"",quantity:t.matched_item_quantity,unit_price:t.matched_item_unit_price,amount:t.matched_item_amount,vendor_name:t.matched_purchase.vendor_name});else{let a=null,n=-1;const i=t.match_candidates?.filter(e=>e.purchase_order_number===s||e.sales_order_number===s)||[];for(const e of i){const r=V(t.extracted_item_name||"",e.item_name,e.specification);r>n&&(n=r,a={purchase_id:e.purchase_id,item_id:e.item_id,purchase_order_number:e.purchase_order_number||"",sales_order_number:e.sales_order_number,item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price:e.unit_price,amount:e.amount,vendor_name:e.vendor_name})}if(!a&&t.match_candidates&&t.match_candidates.length>0){for(const e of t.match_candidates){const r=V(t.extracted_item_name||"",e.item_name,e.specification);r>n&&r>=40&&(n=r,a={purchase_id:e.purchase_id,item_id:e.item_id,purchase_order_number:e.purchase_order_number||"",sales_order_number:e.sales_order_number,item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price:e.unit_price,amount:e.amount,vendor_name:e.vendor_name})}if(a){const r=a.purchase_order_number||a.sales_order_number||"";r&&e.set(t.id,r)}}r.set(t.id,a)}}),R(e),L(r);const s=t.data.items.find(e=>e.extracted_po_number)?.extracted_po_number;s&&z(q(s));const a=t.data.items.map(e=>e.extracted_po_number?q(e.extracted_po_number):null).filter(Boolean);if(0===a.length||a.every(e=>e===a[0])){const e=await k.findBestMatchingPurchaseOrderSet(t.data.items,s,t.data.vendor_name);if(e.success&&e.data&&(Re(e.data),e.data.bestMatch)){const s=e.data.bestMatch.purchase_order_number||e.data.bestMatch.sales_order_number||"";z(s);const a=new Map;e.data.bestMatch.itemMatches.forEach(e=>{for(const r of t.data.items){const t=r.match_candidates?.find(t=>t.item_id===e.systemItemId);if(t){a.set(e.ocrItemId,{purchase_id:t.purchase_id,item_id:t.item_id,purchase_order_number:t.purchase_order_number||"",sales_order_number:t.sales_order_number,item_name:t.item_name,specification:t.specification,quantity:t.quantity,unit_price:t.unit_price,amount:t.amount,vendor_name:t.vendor_name});break}}});const n=new Map(r);a.forEach((e,t)=>{e&&n.set(t,e)}),L(n);const i=e.data.bestMatch.confidence,c="high"===i?"ë†’ìŒ":"medium"===i?"ë³´í†µ":"ë‚®ìŒ";y.success(`ì„¸íŠ¸ ë§¤ì¹­ ì™„ë£Œ! ${e.data.bestMatch.matchedItemCount}/${t.data.items.length}ê°œ í’ˆëª© ë§¤ì¹­ (ì‹ ë¢°ë„: ${c})`)}}}else y.error(t.error||"ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}catch(e){y.error("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}finally{m(!1)}},[a.id,We]);t.useEffect(()=>{e&&a&&(Oe(!1),Le())},[e,a,Le]),t.useEffect(()=>{if(!f||!e)return;if(d)return;const t=new Map,r=new Map(E);let s=!1,a=!1;f.items.forEach(e=>{const n=D.get(e.id),i=Fe?$:E.get(e.id)||(e.extracted_po_number?q(e.extracted_po_number):"");if(n&&(n.purchase_order_number===i||n.sales_order_number===i))return void t.set(e.id,n);let c=null,l=-1;const o=i&&e.match_candidates?.filter(e=>e.purchase_order_number===i||e.sales_order_number===i)||[];for(const t of o){const r=V(e.extracted_item_name||"",t.item_name,t.specification);r>l&&(l=r,c={purchase_id:t.purchase_id,item_id:t.item_id,purchase_order_number:t.purchase_order_number||"",sales_order_number:t.sales_order_number,item_name:t.item_name,specification:t.specification,quantity:t.quantity,unit_price:t.unit_price,amount:t.amount,vendor_name:t.vendor_name})}if(!c&&e.match_candidates)for(const t of e.match_candidates){const r=V(e.extracted_item_name||"",t.item_name,t.specification);r>l&&r>=40&&(l=r,c={purchase_id:t.purchase_id,item_id:t.item_id,purchase_order_number:t.purchase_order_number||"",sales_order_number:t.sales_order_number,item_name:t.item_name,specification:t.specification,quantity:t.quantity,unit_price:t.unit_price,amount:t.amount,vendor_name:t.vendor_name})}if(t.set(e.id,c),c){const t=c.purchase_order_number||c.sales_order_number||"",s=E.get(e.id)||"";t&&t!==s&&(r.set(e.id,t),a=!0)}n!==c&&(s=!0)}),s&&L(t),a&&R(r)},[$,Fe,f,e,d]);const Pe=t.useMemo(()=>{if(!f)return[];const e=f.items.find(e=>e.extracted_po_number)?.extracted_po_number||"",t=(e?q(e).toUpperCase():"").startsWith("HS"),r=new Map;Ie?.candidates&&Ie.candidates.forEach(e=>{const s=t&&e.sales_order_number||e.purchase_order_number;s&&r.set(s,{poNumber:e.purchase_order_number||"",salesOrderNumber:e.sales_order_number,itemCount:e.matchedItemCount,items:[],vendorName:e.vendor_name,setMatchScore:e.matchScore,matchedItemCount:e.matchedItemCount,purchaseId:e.purchase_id})}),f.items.forEach(e=>{e.match_candidates?.forEach(e=>{const s=t?e.sales_order_number||"":e.purchase_order_number||"";if(s&&!r.has(s)&&r.set(s,{poNumber:e.purchase_order_number||"",salesOrderNumber:e.sales_order_number,itemCount:0,items:[],vendorName:e.vendor_name,purchaseId:e.purchase_id}),s&&r.has(s)){const t=r.get(s);t.items.push(e),t.setMatchScore||(t.itemCount=t.items.length)}})}),he.size>0&&he.forEach((e,s)=>{const a=q(s),n=a.startsWith("HS");t&&!n||!t&&n||r.has(a)||r.set(a,{poNumber:n?"":a,salesOrderNumber:n?a:void 0,itemCount:e.length,items:e.map(e=>({purchase_id:e.purchase_id,purchase_order_number:e.purchase_order_number||"",sales_order_number:e.sales_order_number,item_id:e.item_id,item_name:e.item_name,specification:e.specification,quantity:e.quantity??0,unit_price:e.unit_price,vendor_name:e.vendor_name,score:0,match_reasons:["po_items_map"]})),vendorName:e[0]?.vendor_name,purchaseId:e[0]?.purchase_id})}),r.forEach((e,t)=>{let r=0,s=0,a=0,n=0;const i=q(t).toUpperCase(),c=f.items.map(e=>{const t=Ke(e,"po_number");return t?q(t).toUpperCase():null}).filter(Boolean).some(e=>e===i),l=e.items;f.items.forEach(e=>{let t=0,i=null;const c=Ke(e,"item_name");for(const r of l){const e=r,s=V(c||"",e.item_name,e.specification);s>t&&(t=s,i=e)}if(t>=40&&null!==i){s++;const t=Ke(e,"quantity"),r="number"==typeof t?t:""!==t?Number(t):void 0,c=i.quantity;void 0!==r&&!Number.isNaN(r)&&J(r,c)?a++:n++}r+=t});const o=f.items.length>0?Math.round(r/f.items.length):0,d=s>0&&a===s?10:0,m=Math.min(100,o+d),u=c?100:0;void 0===e.setMatchScore?(e.setMatchScore=m+u,e.displayScore=m,e.matchedItemCount=s):c&&(e.setMatchScore=(e.setMatchScore??0)+u,void 0===e.displayScore&&(e.displayScore=e.setMatchScore-u)),e.quantityMatchedCount=a,e.quantityMismatchedCount=n,e.hasOrderNumberMatch=c});const s=Array.from(r.values());return s.sort((e,t)=>{const r=e.hasOrderNumberMatch?1:0,s=t.hasOrderNumberMatch?1:0;if(r!==s)return s-r;const a=e.setMatchScore??0,n=t.setMatchScore??0;return a!==n?n-a:t.itemCount-e.itemCount}),s},[f,Ie,he,Q]),Ue=t.useCallback(e=>{if(!e)return;const t=q(e),r=Pe.find(r=>r.poNumber===t||r.salesOrderNumber===t||r.poNumber===e||r.salesOrderNumber===e);if(r)return t.startsWith("F")?r.salesOrderNumber:t.startsWith("HS")?r.poNumber:r.salesOrderNumber||r.poNumber;const s=he.get(t)||he.get(e)||[];if(s.length>0){const e=s[0];return t.startsWith("F")?e.sales_order_number:t.startsWith("HS")?e.purchase_order_number||e.purchase_order_number:e.sales_order_number||e.purchase_order_number}},[Pe,he]),Be=e=>{if(!e)return;const t=q(e),r=$e.get(t);return void 0!==r?r||void 0:Ue(e)};t.useEffect(()=>{if(!Pe.length||!Fe)return;if(Me)return;const e=Pe.find(e=>!0===e.hasOrderNumberMatch);if(e){const t=e.poNumber||e.salesOrderNumber||"";if(t&&t!==$)return void z(t)}if(!Pe.some(e=>e.poNumber===$||e.salesOrderNumber===$)&&Pe[0]){const e=Pe[0],t=e.poNumber||e.salesOrderNumber||"";t&&z(t)}},[Pe,$,Fe,Me]);const Te=t.useCallback(e=>{if(!f||!e)return[];const t=he.get(e)||[];if(t.length>0){return t.filter((e,t,r)=>t===r.findIndex(t=>t.item_id===e.item_id))}const r=[];f.items.forEach(t=>{t.match_candidates?.forEach(t=>{t.purchase_order_number!==e&&t.sales_order_number!==e||r.push({purchase_id:t.purchase_id,item_id:t.item_id,purchase_order_number:t.purchase_order_number||"",sales_order_number:t.sales_order_number,item_name:t.item_name,specification:t.specification,quantity:t.quantity,unit_price:t.unit_price,amount:t.amount,vendor_name:t.vendor_name})})});return r.filter((e,t,r)=>t===r.findIndex(t=>t.item_id===e.item_id))},[f,he]),He=t.useCallback(e=>{if(!f)return[];const t=f.items.find(t=>t.id===e);if(!t)return[];const r=new Set,s=(t.extracted_po_number?q(t.extracted_po_number).toUpperCase():"").startsWith("HS");return t.match_candidates?.forEach(e=>{s?e.sales_order_number&&r.add(e.sales_order_number):e.purchase_order_number&&r.add(e.purchase_order_number)}),Array.from(r)},[f]),Ae=(e,t,r)=>{ee(s=>{const a=new Map(s),n=a.get(e)||{};return a.set(e,{...n,[t]:r}),a})};function Ke(e,t){const r=Q.get(e.id);if(r&&void 0!==r[t])return r[t];switch(t){case"item_name":return e.extracted_item_name||"";case"quantity":return e.extracted_quantity??"";case"unit_price":return e.extracted_unit_price??"";case"amount":return e.extracted_amount??"";case"po_number":return e.extracted_po_number?q(e.extracted_po_number):"";default:return""}}const Ge=(e,t)=>{const r=Q.get(e.id);if(!r||void 0===r[t])return!1;switch(t){case"item_name":return r.item_name!==e.extracted_item_name;case"quantity":return r.quantity!==e.extracted_quantity;case"unit_price":return r.unit_price!==e.extracted_unit_price;case"amount":return r.amount!==e.extracted_amount;case"po_number":{const t=e.extracted_po_number?q(e.extracted_po_number):"";return r.po_number!==t}default:return!1}},Ve=async(e,t,r)=>{if(z(e),r){const t=q(e);ze(e=>{const s=new Map(e);return s.set(t,r),s})}const s=Pe.find(t=>t.poNumber===e||t.salesOrderNumber===e);let a=[],n=t||"";if(s&&s.items.length>0&&(a=s.items.map(e=>({purchase_id:e.purchase_id,item_id:e.item_id,purchase_order_number:e.purchase_order_number||"",sales_order_number:e.sales_order_number,item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price:e.unit_price,amount:e.amount,vendor_name:e.vendor_name})),a=a.filter((e,t,r)=>t===r.findIndex(t=>t.item_id===e.item_id)),!n&&a[0]?.vendor_name&&(n=a[0].vendor_name)),0===a.length&&(a=Te(e),!n&&a[0]?.vendor_name&&(n=a[0].vendor_name)),0===a.length)try{const{data:t}=await We.from("purchase_requests").select("\n            id,\n            purchase_order_number,\n            sales_order_number,\n            vendor:vendors(vendor_name)\n          ").or(`purchase_order_number.eq.${e},sales_order_number.eq.${e}`).limit(1).single();if(t){!n&&t.vendor?.vendor_name&&(n=t.vendor.vendor_name);const r=q(e),s=e.startsWith("F")?t.sales_order_number:t.purchase_order_number;s&&ze(e=>{const t=new Map(e);return t.set(r,s),t});const{data:i}=await We.from("purchase_request_items").select("\n              id,\n              item_name,\n              specification,\n              quantity,\n              unit_price_value,\n              amount_value\n            ").eq("purchase_request_id",t.id);i&&i.length>0&&(a=i.map(e=>({purchase_id:t.id,item_id:e.id,purchase_order_number:t.purchase_order_number||"",sales_order_number:t.sales_order_number,item_name:e.item_name||"",specification:e.specification,quantity:e.quantity,unit_price:e.unit_price_value,amount:e.amount_value,vendor_name:n})))}}catch(i){}if(a.length>0&&_e(t=>{const r=new Map(t);r.set(e,a);const s=a[0]?.sales_order_number;return s&&s!==e&&r.set(s,a),r}),n&&ie(n),f){const e=new Map;f.items.forEach(t=>{let r=null,s=0;a.forEach(e=>{const a=V(t.extracted_item_name||"",e.item_name,e.specification);a>s&&a>=40&&(s=a,r=e)}),e.set(t.id,r)}),L(e)}},Je=t.useCallback(async e=>{const t=e.trim();if(!t)return;const r=q(t);if(r&&!$e.has(r)&&!Ee.current.has(r)){Ee.current.add(r);try{const{data:e,error:t}=await We.from("purchase_requests").select("purchase_order_number,sales_order_number").or(`purchase_order_number.eq.${r},sales_order_number.eq.${r}`).limit(1);if(t)throw t;const s=e?.[0],a=s?r.startsWith("F")?s.sales_order_number:r.startsWith("HS")?s.purchase_order_number:s.sales_order_number||s.purchase_order_number:null;ze(e=>{const t=new Map(e);return t.set(r,a??null),t})}catch(s){ze(e=>{const t=new Map(e);return t.set(r,null),t})}finally{Ee.current.delete(r)}}},[$e,We]),Xe=t.useCallback(async e=>{Je(e),f&&f.items.forEach(t=>{Ae(t.id,"po_number",e)});const t=q(e);if(!t)return;const r=Pe.find(e=>e.poNumber===t||e.salesOrderNumber===t);if(r){const e=r.poNumber||r.salesOrderNumber||"";e&&e!==$&&z(e)}else{z(t);try{const{data:e}=await We.from("purchase_requests").select("\n            id,\n            purchase_order_number,\n            sales_order_number,\n            vendor_name,\n            purchase_request_items (\n              id,\n              item_name,\n              specification,\n              quantity,\n              unit_price_value,\n              amount_value\n            )\n          ").or(`purchase_order_number.eq.${t},sales_order_number.eq.${t}`).limit(1);if(e&&e.length>0){const r=e[0],s=(r.purchase_request_items||[]).map(e=>({purchase_id:r.id,item_id:e.id,purchase_order_number:r.purchase_order_number||"",sales_order_number:r.sales_order_number,item_name:e.item_name,specification:e.specification,quantity:e.quantity??0,unit_price:e.unit_price_value,amount:e.amount_value,vendor_name:r.vendor_name}));_e(e=>{const a=new Map(e);return a.set(t,s),r.purchase_order_number&&a.set(r.purchase_order_number,s),r.sales_order_number&&a.set(r.sales_order_number,s),a})}}catch(s){}}},[f,Pe,$,Je,Ae,We]),Ye=async(e,t)=>{const r=!t?.silent;pe(e),ie(e),ue(!1),le([]),r&&y.success(`ê±°ëž˜ì²˜ê°€ "${e}"(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ë°œì£¼ í›„ë³´ë¥¼ ë‹¤ì‹œ ê²€ìƒ‰í•©ë‹ˆë‹¤.`);try{const{data:t,error:s}=await We.from("purchase_requests").select("\n          id,\n          purchase_order_number,\n          sales_order_number,\n          vendor:vendors!inner(vendor_name),\n          items:purchase_request_items(\n            id,\n            item_name,\n            specification,\n            quantity,\n            unit_price_value,\n            amount_value\n          )\n        ").eq("vendor.vendor_name",e).order("created_at",{ascending:!1}).limit(50);if(s)throw s;if(!t||0===t.length)return void(r&&y.error(`"${e}" ê±°ëž˜ì²˜ì˜ ë°œì£¼ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.`));const a=new Map;let n=0;t.forEach(t=>{const r=(t.items||[]).map(r=>({purchase_id:t.id,item_id:r.id,purchase_order_number:t.purchase_order_number||"",sales_order_number:t.sales_order_number,item_name:r.item_name||"",specification:r.specification,quantity:r.quantity,unit_price:r.unit_price_value,amount:r.amount_value,vendor_name:e}));0!==r.length&&(n+=r.length,t.purchase_order_number&&a.set(t.purchase_order_number,r),t.sales_order_number&&a.set(t.sales_order_number,r))}),_e(a);const i=new Map,c=t[0]?.purchase_order_number||t[0]?.sales_order_number||"";if(f){f.items.forEach((r,s)=>{const a=[];let n=0,c=0;t.forEach(t=>{(t.items||[]).forEach(s=>{const i=V(r.extracted_item_name||"",s.item_name,s.specification);c+=1,i>n&&(n=i),i>=40&&a.push({purchase_id:t.id,item_id:s.id,purchase_order_number:t.purchase_order_number||"",sales_order_number:t.sales_order_number,item_name:s.item_name||"",specification:s.specification,quantity:s.quantity,unit_price:s.unit_price_value,score:i,match_reasons:["ê±°ëž˜ì²˜ ë§¤ì¹­"],vendor_name:e})})}),a.sort((e,t)=>t.score-e.score),i.set(r.id,a.slice(0,5))}),z(c);const s=new Map,a=(t[0]?.items||[]).map(r=>({purchase_id:t[0].id,item_id:r.id,purchase_order_number:t[0].purchase_order_number||"",sales_order_number:t[0].sales_order_number,item_name:r.item_name||"",specification:r.specification,quantity:r.quantity,unit_price:r.unit_price_value,amount:r.amount_value,vendor_name:e}));f.items.forEach(e=>{let t=null,r=0;a.forEach(s=>{const a=V(e.extracted_item_name||"",s.item_name,s.specification);a>r&&a>=30&&(r=a,t=s)}),s.set(e.id,t)}),L(s),Re({bestMatch:{purchase_id:t[0].id,purchase_order_number:t[0].purchase_order_number||"",sales_order_number:t[0].sales_order_number,vendor_name:e,matchScore:100,matchedItemCount:s.size,totalItemCount:f.items.length,confidence:"high",itemMatches:[]},candidates:t.map(r=>({purchase_id:r.id,purchase_order_number:r.purchase_order_number||"",sales_order_number:r.sales_order_number,vendor_name:e,matchScore:r.id===t[0].id?100:50,matchedItemCount:(r.items||[]).length}))}),r&&y.success(`${t.length}ê°œ ë°œì£¼ í›„ë³´ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤. ìžë™ ë§¤ì¹­ ì™„ë£Œ.`)}}catch(s){y.error("ë°œì£¼ í›„ë³´ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},Ze=(e,t)=>{L(r=>{const s=new Map(r);return s.set(e,t),s}),T(t=>{const r=new Set(t);return r.delete(`item-${e}`),r})},Qe=e=>null==e?"-":e.toLocaleString("ko-KR"),et=(e,t)=>{if(t&&"global-po"===e){const e=t.currentTarget.getBoundingClientRect();A({top:e.bottom+4,left:e.left})}T(t=>{const r=new Set(t);return r.has(e)?r.delete(e):(r.clear(),r.add(e)),r})};return a?s.jsxs(s.Fragment,{children:[s.jsx(x,{open:e,onOpenChange:c,children:s.jsxs(p,{className:"max-w-[95vw] md:max-w-[1200px] max-h-[90vh] overflow-hidden flex flex-col business-radius-modal",showCloseButton:!1,onInteractOutside:e=>{B.size>0&&e.preventDefault()},children:[s.jsx(h,{className:"border-b border-gray-100 pb-3 px-4",children:s.jsxs(_,{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-2 modal-title",children:[s.jsx(M,{className:"w-4 h-4 text-hansl-600"}),"ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸ ë° í™•ì •"]}),s.jsxs(n,{variant:"outline",size:"sm",onClick:()=>v(!0),className:"button-base h-7 text-[10px]",children:[s.jsx(C,{className:"w-3.5 h-3.5 mr-1"}),"ì›ë³¸ ë³´ê¸°"]})]})}),d?s.jsxs("div",{className:"flex items-center justify-center py-12",children:[s.jsx(I,{className:"w-6 h-6 animate-spin text-hansl-600"}),s.jsx("span",{className:"ml-3 modal-subtitle",children:"ë¡œë”© ì¤‘..."})]}):f?s.jsxs("div",{className:"flex-1 overflow-hidden flex flex-col py-3 px-4",children:[s.jsxs("div",{className:"flex items-center gap-6 p-3 bg-gray-50 business-radius-card mb-4",children:[s.jsxs("div",{className:"relative",children:[s.jsx("p",{className:"modal-label",children:"ê±°ëž˜ì²˜"}),s.jsxs("div",{className:"relative",children:[s.jsx("input",{type:"text",value:ne,onChange:e=>{ie(e.target.value),(async e=>{if(!e.trim())return le([]),void ue(!1);de(!0),ue(!0);try{const{data:t,error:r}=await We.from("vendors").select("id, vendor_name").ilike("vendor_name",`%${e}%`).limit(10);if(r)throw r;le((t||[]).map(e=>({id:e.id,name:e.vendor_name})))}catch(t){le([])}finally{de(!1)}})(e.target.value)},onFocus:()=>{ce.length>0&&ue(!0)},onBlur:()=>{setTimeout(()=>ue(!1),200)},placeholder:"ê±°ëž˜ì²˜ ê²€ìƒ‰...",className:"w-[120px] h-5 px-1.5 bg-white border business-radius focus:outline-none focus:ring-1 focus:ring-hansl-400 "+(xe?"border-green-400 text-green-700":"border-gray-300 text-gray-900"),style:{fontSize:"11px",fontWeight:700}}),oe&&s.jsx(I,{className:"absolute right-2 top-1/2 -translate-y-1/2 w-3 h-3 animate-spin text-gray-400"}),me&&ce.length>0&&s.jsx("div",{className:"absolute top-full left-0 mt-1 w-[200px] bg-white border border-gray-200 rounded-lg shadow-lg z-50 max-h-[180px] overflow-y-auto",children:ce.map(e=>s.jsx("button",{onMouseDown:e=>e.preventDefault(),onClick:()=>{ie(e.name),ue(!1),Ye(e.name)},className:"w-full px-2 py-1.5 text-left hover:bg-gray-50 border-b border-gray-100 last:border-b-0",children:s.jsx("div",{className:"text-[10px] font-medium text-gray-900",children:e.name})},e.id))})]})]}),s.jsxs("div",{children:[s.jsx("p",{className:"modal-label",children:"ê±°ëž˜ì¼"}),s.jsx("p",{className:"modal-value",children:f.statement_date?new Date(f.statement_date).toLocaleDateString("ko-KR"):"-"})]}),s.jsxs("div",{children:[s.jsx("p",{className:"modal-label",children:"í•©ê³„ê¸ˆì•¡"}),s.jsxs("p",{className:"modal-value-large",children:[Qe(f.grand_total),"ì›"]})]}),s.jsxs("div",{children:[s.jsx("p",{className:"modal-label",children:"í’ˆëª© ìˆ˜"}),s.jsxs("p",{className:"modal-value",children:[f.items.length,"ê±´"]})]})]}),s.jsx("div",{className:"flex-1 overflow-auto border border-gray-200 business-radius-card",children:s.jsxs("table",{className:"modal-value table-auto min-w-full",children:[s.jsxs("thead",{className:"bg-gray-100 sticky top-0 z-10",children:[s.jsxs("tr",{className:"border-b border-gray-200",children:[s.jsx("th",{colSpan:Fe?4:5,className:"border-r-2 border-gray-300 p-2 text-left w-[45%]",children:s.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[s.jsx("span",{className:"modal-section-title text-gray-700",children:"ì‹œìŠ¤í…œ ë°œì£¼í’ˆëª©"}),Fe&&Pe.length>0&&s.jsxs("div",{className:"relative flex items-center gap-1",children:[s.jsxs("button",{onClick:e=>et("global-po",e),className:"inline-flex items-center gap-1 px-1.5 h-5 text-[10px] font-medium bg-white border border-gray-300 rounded-md hover:bg-gray-50 text-gray-700",children:[(()=>{if(!$)return"ë°œì£¼ë²ˆí˜¸ ì„ íƒ";const e=Pe.find(e=>e.poNumber===$||e.salesOrderNumber===$);if(e?.poNumber&&e?.salesOrderNumber)return s.jsxs(s.Fragment,{children:[e.poNumber," ",s.jsxs("span",{className:"text-gray-400",children:["(",e.salesOrderNumber,")"]})]});const t=Ue($);return t?s.jsxs(s.Fragment,{children:[$," ",s.jsxs("span",{className:"text-gray-400",children:["(",t,")"]})]}):$})(),s.jsx(W,{className:"w-3 h-3"})]}),De&&$&&De!==$&&s.jsx("span",{className:"text-[9px] text-orange-500",title:"OCR ì¶”ì¶œ ë°œì£¼ë²ˆí˜¸ì™€ ë‹¤ë¥¸ ë°œì£¼ê°€ ë§¤ì¹­ë¨",children:"âš ï¸"}),s.jsx("div",{className:"relative flex items-center",children:fe?s.jsxs(s.Fragment,{children:[s.jsx("input",{type:"text",value:je,onChange:e=>{Ne(e.target.value),(async e=>{if(!e.trim())return we([]),void qe(!1);Ce(!0),qe(!0);try{const t=q(e.trim()),{data:r,error:s}=await We.from("purchase_requests").select("\n          id,\n          purchase_order_number,\n          sales_order_number,\n          vendor:vendors(vendor_name)\n        ").or(`purchase_order_number.ilike.%${t}%,sales_order_number.ilike.%${t}%`).order("created_at",{ascending:!1}).limit(10);if(s)throw s;we((r||[]).map(e=>({id:e.id,poNumber:e.purchase_order_number||"",soNumber:e.sales_order_number,vendorName:e.vendor?.vendor_name})))}catch(t){we([])}finally{Ce(!1)}})(e.target.value)},onBlur:()=>{setTimeout(()=>{ye(!1),qe(!1)},200)},placeholder:"F... ë˜ëŠ” HS...",className:"w-[90px] h-5 px-1.5 bg-white border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-hansl-400",style:{fontSize:"10px",fontWeight:500},autoFocus:!0,onClick:e=>e.stopPropagation()}),Se&&s.jsx(I,{className:"absolute right-1 w-3 h-3 animate-spin text-gray-400"}),ke&&ve.length>0&&s.jsx("div",{className:"absolute top-full left-0 mt-1 w-[200px] bg-white border border-gray-200 rounded-lg shadow-lg z-50 max-h-[180px] overflow-y-auto",children:ve.map(e=>s.jsxs("button",{onMouseDown:e=>e.preventDefault(),onClick:t=>{t.stopPropagation();const r=je.trim().toUpperCase();let s;s=r.startsWith("HS")&&e.soNumber?e.soNumber:r.startsWith("F")&&e.poNumber?e.poNumber:e.poNumber||e.soNumber||"",Ne(""),ye(!1),qe(!1),Oe(!0),Ve(s,e.vendorName,e.soNumber),y.success(`${s} ë°œì£¼ê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤`)},className:"w-full px-2 py-1.5 text-left hover:bg-gray-50 border-b border-gray-100 last:border-b-0",children:[s.jsxs("div",{className:"text-[10px] font-medium text-gray-900",children:[e.poNumber,e.soNumber&&s.jsxs("span",{className:"text-gray-400 ml-1",children:["(",e.soNumber,")"]})]}),e.vendorName&&s.jsx("div",{className:"text-[9px] text-gray-500",children:e.vendorName})]},e.id))})]}):s.jsx("button",{onClick:e=>{e.stopPropagation(),ye(!0)},className:"inline-flex items-center gap-0.5 px-1 h-5 text-[9px] font-medium text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded",title:"ë°œì£¼/ìˆ˜ì£¼ë²ˆí˜¸ ì§ì ‘ ê²€ìƒ‰",children:s.jsx(o,{className:"w-3 h-3"})})}),$&&(()=>{const e=Pe.find(e=>e.poNumber===$||e.salesOrderNumber===$),t=e?.purchaseId||e?.items[0]?.purchase_id;return t?s.jsx("button",{onClick:e=>{e.stopPropagation(),Z(t),X(!0)},className:"inline-flex items-center gap-0.5 px-1 h-5 text-[9px] font-medium text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded",title:"ë°œì£¼ ìƒì„¸ ë³´ê¸°",children:s.jsx(U,{className:"w-3 h-3"})}):null})()]})]})}),s.jsx("th",{className:"border-r-2 border-gray-300 p-2 text-center bg-blue-50/30 w-[10%]"}),s.jsx("th",{colSpan:Fe?4:5,className:"p-2 text-left w-[45%]",children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:"modal-section-title text-gray-700",children:"OCR ì¶”ì¶œ í’ˆëª©"}),Fe&&De&&s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("input",{type:"text",value:(()=>{const e=f?.items[0];return e?Ke(e,"po_number"):De})(),onChange:e=>Xe(e.target.value),className:"px-1.5 h-5 bg-white border border-gray-300 text-gray-700 text-[10px] font-medium business-radius focus:outline-none focus:ring-1 focus:ring-gray-400",style:{fontSize:"11px",fontWeight:500},title:"OCR ì¶”ì¶œ ë°œì£¼ë²ˆí˜¸ (ìˆ˜ì • ê°€ëŠ¥)"}),(()=>{const e=f?.items[0],t=e?Ke(e,"po_number"):De,r=Be(t);return r?s.jsx("span",{className:"text-gray-400 text-[10px] font-normal",style:{fontSize:"11px"},children:r}):null})()]}),Fe&&!De&&s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("input",{type:"text",placeholder:"ë°œì£¼/ìˆ˜ì£¼ë²ˆí˜¸ ìž…ë ¥",onChange:e=>Xe(e.target.value),className:"px-1.5 h-5 bg-white border border-gray-300 text-gray-700 text-[10px] font-medium business-radius focus:outline-none focus:ring-1 focus:ring-gray-400",style:{fontSize:"11px",fontWeight:500},title:"ë°œì£¼ë²ˆí˜¸ ì§ì ‘ ìž…ë ¥"}),(()=>{const e=f?.items[0],t=e?Ke(e,"po_number"):"",r=Be(t);return r?s.jsx("span",{className:"text-gray-400 text-[10px] font-normal",style:{fontSize:"11px"},children:r}):null})()]})]})})]}),s.jsxs("tr",{className:"modal-label",children:[!Fe&&s.jsx("th",{className:"p-1 text-left whitespace-nowrap modal-label",children:"ë°œì£¼/ìˆ˜ì£¼ë²ˆí˜¸"}),s.jsx("th",{className:"p-1 text-left modal-label",children:"í’ˆëª©ëª…"}),s.jsx("th",{className:"p-1 text-right modal-label",children:"ìˆ˜ëŸ‰"}),s.jsx("th",{className:"p-1 text-right modal-label",children:"ë‹¨ê°€"}),s.jsx("th",{className:"border-r-2 border-gray-300 p-1 text-right modal-label",children:"í•©ê³„"}),s.jsx("th",{className:"border-r-2 border-gray-300 p-1 text-center bg-blue-50/30",children:s.jsx("span",{className:"text-gray-400 text-sm",children:"â‡„"})}),s.jsx("th",{className:"p-1 text-left whitespace-nowrap modal-label",children:"í’ˆëª©ëª…"}),s.jsx("th",{className:"p-1 text-right whitespace-nowrap w-16 modal-label",children:"ìˆ˜ëŸ‰"}),s.jsx("th",{className:"p-1 text-right whitespace-nowrap w-20 modal-label",children:"ë‹¨ê°€"}),s.jsx("th",{className:"p-1 text-right whitespace-nowrap w-24 modal-label",children:"í•©ê³„"}),!Fe&&s.jsx("th",{className:"p-1 text-left whitespace-nowrap modal-label",children:"ë°œì£¼/ìˆ˜ì£¼ë²ˆí˜¸"})]})]}),s.jsxs("tbody",{children:[f.items.map((e,t)=>{const r=D.get(e.id);(e=>{let t=D.get(e.id)||null;if(!t){const r=Fe?$:E.get(e.id)||(e.extracted_po_number?q(e.extracted_po_number):"");if(r){const s=Te(r);s.length;let a=0;s.forEach(r=>{const s=V(e.extracted_item_name||"",r.item_name,r.specification);s>a&&(a=s,t=r)})}}if(!t)return"unmatched";const r=V(e.extracted_item_name||"",t.item_name||"",t.specification)})(e);const a=e.extracted_po_number?q(e.extracted_po_number):void 0,n=E.get(e.id)||a,i=He(e.id),c=Fe?$:n||"",l=Te(c),o=Fe&&0===t&&!r&&l.length>0;if(0===t){const t=`${e.id}|${Fe?"same":"multi"}|${c}|${l.length}`;ge.current!==t&&(ge.current=t,l[0])}const d=$?q($):"",m=$?Ue($):void 0,u=m?q(m):"",x=f.items.length,p=f.items.map(e=>Ke(e,"po_number")).filter(Boolean).map(e=>q(e)),h=!!d&&p.some(e=>e===d||u&&e===u),_=0===t;return s.jsxs("tr",{className:"hover:bg-gray-50",children:[!Fe&&s.jsx("td",{className:"p-1 whitespace-nowrap",children:s.jsxs("div",{className:"relative",children:[s.jsxs("button",{onClick:()=>et(`po-${e.id}`),className:"inline-flex items-center gap-1 px-1.5 h-5 text-[10px] font-medium bg-white border border-gray-300 business-radius hover:bg-gray-50 text-gray-700 whitespace-nowrap",style:{fontSize:"11px"},children:[s.jsx("span",{children:n||"ì„ íƒ"}),s.jsx(W,{className:"w-3 h-3 flex-shrink-0"})]}),B.has(`po-${e.id}`)&&i.length>0&&s.jsx("div",{className:"absolute left-0 top-full mt-1 z-20 bg-white border border-gray-200 rounded-md shadow-lg min-w-[150px] max-h-[150px] overflow-auto",children:i.map((t,r)=>s.jsxs("div",{onClick:()=>((e,t)=>{R(r=>{const s=new Map(r);return s.set(e,t),s});const r=f?.items.find(t=>t.id===e);if(r){const s=r.match_candidates?.filter(e=>e.purchase_order_number===t||e.sales_order_number===t)||[];let a=null,n=-1;s.length>0&&s.forEach(e=>{const t=V(r.extracted_item_name||"",e.item_name,e.specification);t>n&&(n=t,a={purchase_id:e.purchase_id,item_id:e.item_id,purchase_order_number:e.purchase_order_number||"",sales_order_number:e.sales_order_number,item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price:e.unit_price,amount:e.amount,vendor_name:e.vendor_name})}),a||Te(t).forEach(e=>{const t=V(r.extracted_item_name||"",e.item_name,e.specification);t>n&&(n=t,a=e)}),L(t=>{const r=new Map(t);return r.set(e,a),r})}T(t=>{const r=new Set(t);return r.delete(`po-${e}`),r})})(e.id,t),className:"px-2 py-1.5 hover:bg-gray-100 cursor-pointer text-[11px] font-medium "+(t===n?"bg-gray-100 text-gray-900 font-semibold":"text-gray-700"),style:{fontSize:"11px"},children:[t,(()=>{const e=Ue(t);return e?s.jsxs("span",{className:"text-gray-400 ml-1",children:["(",e,")"]}):null})()]},r))})]})}),s.jsx("td",{className:"p-1",children:r?s.jsxs("div",{className:"flex items-center gap-1 whitespace-nowrap",children:[s.jsx("span",{className:"text-[11px] font-medium text-gray-900",style:{fontSize:"11px"},children:r.item_name}),s.jsx("button",{onClick:()=>Ze(e.id,null),className:"text-gray-400 hover:text-red-500 flex-shrink-0",title:"ë§¤ì¹­ í•´ì œ",children:s.jsx(P,{className:"w-3 h-3"})})]}):o?s.jsx("div",{className:"space-y-1",children:l.map((e,t)=>s.jsx("div",{className:"text-[11px] font-medium text-gray-900",style:{fontSize:"11px"},children:e.item_name},t))}):l.length>0?s.jsxs("div",{className:"relative",children:[s.jsxs("button",{onClick:()=>et(`item-${e.id}`),className:"flex items-center gap-1 text-blue-600 hover:text-blue-700 text-[11px]",style:{fontSize:"11px"},children:[s.jsx("span",{children:"â–¼ í›„ë³´ ì„ íƒ"}),s.jsxs("span",{className:"text-gray-400",children:["(",l.length,")"]})]}),B.has(`item-${e.id}`)&&s.jsx("div",{className:"absolute left-0 top-full mt-1 z-20 bg-white border border-gray-200 rounded-md shadow-lg min-w-[280px] max-h-[200px] overflow-auto",children:l.map((t,r)=>{const a=V(e.extracted_item_name||"",t.item_name,t.specification);return s.jsxs("div",{onClick:()=>Ze(e.id,t),className:"px-2 py-1.5 hover:bg-gray-100 cursor-pointer",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("p",{className:"text-[11px] font-medium text-gray-900",style:{fontSize:"11px"},children:t.item_name}),s.jsxs("span",{className:"text-[10px] px-1.5 py-0.5 rounded "+(a>=80?"bg-green-100 text-green-700":a>=50?"bg-yellow-100 text-yellow-700":"bg-gray-100 text-gray-600"),children:[Math.round(a),"%"]})]}),s.jsxs("p",{className:"text-[10px] text-gray-500",children:[t.quantity??"-","ê°œ Ã— ",Qe(t.unit_price)," = ",Qe(t.amount)]})]},r)})})]}):s.jsx("span",{className:"text-[11px] text-gray-400",style:{fontSize:"11px"},children:"í›„ë³´ ì—†ìŒ"})}),s.jsx("td",{className:"p-1 text-right",children:o?s.jsx("div",{className:"space-y-1",children:l.map((e,t)=>s.jsx("div",{className:"text-[11px] text-gray-700",style:{fontSize:"11px"},children:e.quantity??"-"},t))}):s.jsx("span",{className:"text-[11px] text-gray-700",style:{fontSize:"11px"},children:r?.quantity??"-"})}),s.jsx("td",{className:"p-1 text-right",children:o?s.jsx("div",{className:"space-y-1",children:l.map((e,t)=>s.jsx("div",{className:"text-[11px] text-gray-700",style:{fontSize:"11px"},children:Qe(e.unit_price)},t))}):s.jsx("span",{className:"text-[11px] text-gray-700",style:{fontSize:"11px"},children:r?Qe(r.unit_price):"-"})}),s.jsx("td",{className:"border-r-2 border-gray-300 p-1 text-right",children:o?s.jsx("div",{className:"space-y-1",children:l.map((e,t)=>s.jsx("div",{className:"text-[11px] font-bold text-gray-900",style:{fontSize:"11px",fontWeight:700},children:Qe(e.amount)},t))}):s.jsx("span",{className:"text-[11px] font-bold text-gray-900",style:{fontSize:"11px",fontWeight:700},children:r?Qe(r.amount):"-"})}),_&&s.jsx("td",{className:"border-r-2 border-gray-300 px-2 py-1 text-center bg-blue-50/30 cursor-pointer hover:bg-blue-100/50 transition-colors",rowSpan:x,style:{verticalAlign:"middle"},onClick:()=>ae(!0),title:"í´ë¦­í•˜ì—¬ ìƒì„¸ ë‚´ì—­ ë³´ê¸°",children:s.jsxs("div",{className:"flex flex-col items-center justify-center",children:[s.jsx("span",{className:"text-[11px] font-bold "+(h?"text-green-600":"text-gray-500"),children:h?"ë°œì£¼/ìˆ˜ì£¼ ë²ˆí˜¸ ì¼ì¹˜":"ë°œì£¼/ìˆ˜ì£¼ ë²ˆí˜¸ ë¶ˆì¼ì¹˜"}),s.jsx("span",{className:"text-[8px] text-blue-500 underline mt-0.5",children:"ìƒì„¸ë³´ê¸°"})]})}),s.jsx("td",{className:"p-1 whitespace-nowrap",children:s.jsx("input",{type:"text",value:Ke(e,"item_name"),onChange:t=>Ae(e.id,"item_name",t.target.value),className:"min-w-[180px] w-auto px-1 h-5 !text-[10px] !font-medium text-gray-900 border business-radius focus:outline-none focus:ring-1 focus:ring-blue-400 "+(Ge(e,"item_name")?"border-orange-400 bg-orange-50":"border-gray-200 bg-white"),style:{fontSize:"11px",fontWeight:500,width:`${Math.max(180,8*Ke(e,"item_name").length)}px`},title:Ge(e,"item_name")?`ì›ë³¸: ${e.extracted_item_name}`:void 0})}),s.jsx("td",{className:"p-1 text-right w-16",children:s.jsx("input",{type:"number",value:Ke(e,"quantity"),onChange:t=>Ae(e.id,"quantity",t.target.value?Number(t.target.value):0),className:"w-14 px-1 h-5 !text-[10px] !font-medium text-gray-900 text-right border business-radius focus:outline-none focus:ring-1 focus:ring-blue-400 "+(Ge(e,"quantity")?"border-orange-400 bg-orange-50":"border-gray-200 bg-white"),style:{fontSize:"11px",fontWeight:500},title:Ge(e,"quantity")?`ì›ë³¸: ${e.extracted_quantity}`:void 0})}),s.jsx("td",{className:"p-1 text-right w-20",children:s.jsx("input",{type:"number",value:Ke(e,"unit_price"),onChange:t=>Ae(e.id,"unit_price",t.target.value?Number(t.target.value):0),className:"w-16 px-1 h-5 !text-[10px] !font-medium text-gray-900 text-right border business-radius focus:outline-none focus:ring-1 focus:ring-blue-400 "+(Ge(e,"unit_price")?"border-orange-400 bg-orange-50":"border-gray-200 bg-white"),style:{fontSize:"11px",fontWeight:500},title:Ge(e,"unit_price")?`ì›ë³¸: ${e.extracted_unit_price}`:void 0})}),s.jsx("td",{className:"p-1 text-right w-24",children:s.jsx("input",{type:"number",value:Ke(e,"amount"),onChange:t=>Ae(e.id,"amount",t.target.value?Number(t.target.value):0),className:"w-20 px-1 h-5 !text-[10px] !font-bold text-gray-900 text-right border business-radius focus:outline-none focus:ring-1 focus:ring-blue-400 "+(Ge(e,"amount")?"border-orange-400 bg-orange-50":"border-gray-200 bg-white"),style:{fontSize:"11px",fontWeight:700},title:Ge(e,"amount")?`ì›ë³¸: ${e.extracted_amount}`:void 0})}),!Fe&&s.jsx("td",{className:"p-1 whitespace-nowrap",children:s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("input",{type:"text",value:Ke(e,"po_number"),onChange:t=>{const r=t.target.value;Je(r),Ae(e.id,"po_number",r)},className:"px-1.5 h-5 text-[10px] font-medium bg-white border business-radius focus:outline-none focus:ring-1 focus:ring-gray-400 text-gray-700 "+(Ge(e,"po_number")?"border-orange-400 bg-orange-50":"border-gray-300"),style:{fontSize:"11px",fontWeight:500},title:Ge(e,"po_number")?`ì›ë³¸: ${e.extracted_po_number}`:void 0}),(()=>{const t=Ke(e,"po_number"),r=Be(t);return r?s.jsx("span",{className:"text-gray-400 text-[10px] font-normal",style:{fontSize:"11px"},children:r}):null})()]})})]},e.id)}),s.jsxs("tr",{className:"bg-gray-50 font-medium border-t border-gray-100",children:[s.jsx("td",{colSpan:Fe?3:4,className:"p-1 text-right text-gray-600",children:"ì‹œìŠ¤í…œ í•©ê³„"}),s.jsx("td",{className:"border-r-2 border-gray-300 p-1 text-right text-gray-900",children:Qe(Array.from(D.values()).filter(Boolean).reduce((e,t)=>e+(t?.amount||0),0))}),s.jsx("td",{className:"border-r-2 border-gray-300 p-1 bg-blue-50/50"}),s.jsxs("td",{colSpan:Fe?3:4,className:"p-1 text-right text-gray-600",children:["OCR í•©ê³„",Q.size>0&&s.jsx("span",{className:"ml-1 text-[9px] text-orange-600",children:"(ìˆ˜ì •ë¨)"})]}),s.jsx("td",{className:"p-1 text-right text-gray-900",children:Qe(f.items.reduce((e,t)=>{const r=Q.get(t.id);return e+(void 0!==r?.amount?r.amount:t.extracted_amount||0)},0))}),!Fe&&s.jsx("td",{className:"p-1"})]})]})]})})]}):s.jsx("div",{className:"text-center py-12",children:s.jsx("p",{className:"modal-subtitle",children:"ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."})}),s.jsxs(b,{className:"border-t border-gray-100 pt-3 px-4 gap-2",children:[s.jsxs(n,{variant:"outline",onClick:async()=>{if(confirm("ì´ ê±°ëž˜ëª…ì„¸ì„œë¥¼ ê±°ë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"))try{g(!0);const e=await k.rejectStatement(a.id);e.success?(y.success("ê±°ëž˜ëª…ì„¸ì„œê°€ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤."),c()):y.error(e.error||"ê±°ë¶€ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}catch(e){y.error("ê±°ë¶€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}finally{g(!1)}},disabled:u,className:"button-base h-8 text-[11px] text-red-500 border-red-200 hover:bg-red-50",children:[s.jsx(P,{className:"w-3.5 h-3.5 mr-1"}),"ê±°ë¶€"]}),s.jsx(n,{variant:"outline",onClick:c,disabled:u,className:"button-base h-8 text-[11px]",children:"ë‹«ê¸°"}),s.jsx(n,{onClick:async()=>{if(f)try{g(!0),await(async()=>{if(!f)return;const e=[];if(f.items.forEach(t=>{const r=Q.get(t.id);if(r&&(void 0!==r.item_name&&r.item_name!==t.extracted_item_name&&e.push({statement_id:f.id,statement_item_id:t.id,original_text:t.extracted_item_name||"",corrected_text:r.item_name,field_type:"item_name"}),void 0!==r.quantity&&r.quantity!==t.extracted_quantity&&e.push({statement_id:f.id,statement_item_id:t.id,original_text:String(t.extracted_quantity??""),corrected_text:String(r.quantity),field_type:"quantity"}),void 0!==r.unit_price&&r.unit_price!==t.extracted_unit_price&&e.push({statement_id:f.id,statement_item_id:t.id,original_text:String(t.extracted_unit_price??""),corrected_text:String(r.unit_price),field_type:"unit_price"}),void 0!==r.amount&&r.amount!==t.extracted_amount&&e.push({statement_id:f.id,statement_item_id:t.id,original_text:String(t.extracted_amount??""),corrected_text:String(r.amount),field_type:"amount"}),void 0!==r.po_number)){const s=t.extracted_po_number?q(t.extracted_po_number):"";r.po_number!==s&&e.push({statement_id:f.id,statement_item_id:t.id,original_text:s,corrected_text:r.po_number,field_type:"po_number"})}}),e.length>0){for(const t of e)await k.saveCorrection(t);y.success(`${e.length}ê±´ì˜ OCR ìˆ˜ì •ì‚¬í•­ì´ í•™ìŠµ ë°ì´í„°ë¡œ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.`)}})();const e=f.items.map(e=>{const t=D.get(e.id),r=Q.get(e.id),s=void 0!==r?.quantity?r.quantity:e.extracted_quantity,a=void 0!==r?.unit_price?r.unit_price:e.extracted_unit_price,n=void 0!==r?.amount?r.amount:e.extracted_amount;return{itemId:e.id,matched_purchase_id:t?.purchase_id,matched_item_id:t?.item_id,confirmed_quantity:s,confirmed_unit_price:a,confirmed_amount:n}}),t=await k.confirmStatement({statementId:a.id,items:e},w);t.success?(y.success("ê±°ëž˜ëª…ì„¸ì„œê°€ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤."),l()):y.error(t.error||"í™•ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}catch(e){y.error("í™•ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}finally{g(!1)}},disabled:u||!f,className:"button-base h-8 text-[11px] bg-hansl-600 hover:bg-hansl-700 text-white",children:u?s.jsxs(s.Fragment,{children:[s.jsx(I,{className:"w-3.5 h-3.5 mr-1 animate-spin"}),"ì²˜ë¦¬ ì¤‘..."]}):s.jsxs(s.Fragment,{children:[s.jsx(M,{className:"w-3.5 h-3.5 mr-1"}),"í™•ì •"]})})]})]})}),te&&s.jsx(x,{open:te.isOpen,onOpenChange:()=>re(null),children:s.jsxs(p,{className:"max-w-md",children:[s.jsx(h,{children:s.jsx(_,{className:"text-[14px] font-semibold text-gray-800",children:"ë§¤ì¹­ ìƒì„¸ ì •ë³´"})}),s.jsxs("div",{className:"space-y-4 py-2",children:[s.jsxs("div",{className:"flex items-center justify-center",children:[(e=>{const t=void 0;switch(e){case"high":return s.jsxs("span",{className:"badge-stats bg-green-500 text-white ",onClick:t,title:"í´ë¦­í•˜ì—¬ ìƒì„¸ ë³´ê¸°",children:[s.jsx(F,{className:"w-3 h-3"}),"ë†’ìŒ"]});case"med":return s.jsx("span",{className:"badge-stats bg-yellow-500 text-white ",onClick:t,title:"í´ë¦­í•˜ì—¬ ìƒì„¸ ë³´ê¸°",children:"ë³´í†µ"});case"low":return s.jsx("span",{className:"badge-stats bg-orange-500 text-white ",onClick:t,title:"í´ë¦­í•˜ì—¬ ìƒì„¸ ë³´ê¸°",children:"ë‚®ìŒ"});case"unmatched":return s.jsx("span",{className:"badge-stats bg-gray-500 text-white ",onClick:t,title:"í´ë¦­í•˜ì—¬ ìƒì„¸ ë³´ê¸°",children:"ë¯¸ë§¤ì¹­"})}})(te.status),s.jsxs("span",{className:"ml-2 text-[12px] text-gray-600",children:["ìœ ì‚¬ë„: ",te.similarity.toFixed(1),"%"]})]}),s.jsxs("div",{className:"bg-gray-50 rounded-lg p-3 space-y-2",children:[s.jsxs("div",{className:"flex items-start gap-2",children:[s.jsx("span",{className:"text-[11px] font-medium text-gray-500 w-20 shrink-0",children:"OCR í’ˆëª©:"}),s.jsx("span",{className:"text-[11px] text-gray-800 break-all",children:te.ocrItemName})]}),s.jsxs("div",{className:"flex items-start gap-2",children:[s.jsx("span",{className:"text-[11px] font-medium text-gray-500 w-20 shrink-0",children:"ì‹œìŠ¤í…œ í’ˆëª©:"}),s.jsx("span",{className:"text-[11px] text-gray-800 break-all",children:te.systemItemName})]}),te.systemSpec&&"-"!==te.systemSpec&&s.jsxs("div",{className:"flex items-start gap-2",children:[s.jsx("span",{className:"text-[11px] font-medium text-gray-500 w-20 shrink-0",children:"ì‹œìŠ¤í…œ ê·œê²©:"}),s.jsx("span",{className:"text-[11px] text-gray-800 break-all",children:te.systemSpec})]})]}),s.jsxs("div",{className:"space-y-1",children:[s.jsx("span",{className:"text-[11px] font-medium text-gray-600",children:"ë§¤ì¹­ íŒì • ì´ìœ :"}),s.jsx("ul",{className:"space-y-1",children:te.reasons.map((e,t)=>s.jsx("li",{className:"text-[11px] text-gray-700 pl-2",children:e},t))})]})]}),s.jsx(b,{children:s.jsx(n,{variant:"outline",size:"sm",onClick:()=>re(null),className:"text-[11px]",children:"ë‹«ê¸°"})})]})}),s.jsx(x,{open:se,onOpenChange:ae,children:s.jsxs(p,{className:"max-w-lg",children:[s.jsx(h,{children:s.jsx(_,{className:"text-[14px] font-semibold text-gray-800",children:"ë§¤ì¹­ ìƒì„¸ ë‚´ì—­"})}),s.jsx("div",{className:"space-y-4 py-2",children:(()=>{const e=Pe.find(e=>e.poNumber===$||e.salesOrderNumber===$),t=Math.min(100,e?.displayScore??e?.setMatchScore??0),r=e?.matchedItemCount??0,a=f?.items.length??0,n=$?q($):"",i=$?Ue($):void 0,c=i?q(i):"",l=(f?.items??[]).map(e=>Ke(e,"po_number")).filter(Boolean).map(e=>q(e)),o=!!n&&l.some(e=>e===n||c&&e===c),d=(f?.items??[]).filter(e=>{const t=D.get(e.id);if(!t)return!1;return V(Ke(e,"item_name")||"",t.item_name,t.specification)>=40}).length,m=(f?.items??[]).filter(e=>{const t=D.get(e.id);if(!t)return!1;const r=Ke(e,"quantity");return J("number"==typeof r?r:""!==r?Number(r):void 0,t.quantity)}).length,u=a>0&&d===a,x=a>0&&m===a;return s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center justify-center gap-3 p-4 bg-gray-50 rounded-lg",children:[s.jsxs("span",{className:"text-3xl font-bold "+(t>=80?"text-green-600":t>=50?"text-yellow-600":"text-gray-500"),children:[t,"%"]}),s.jsxs("div",{className:"text-left",children:[s.jsxs("p",{className:"text-[12px] font-medium text-gray-700",children:["ë°œì£¼ë²ˆí˜¸: ",$||"ë¯¸ì„ íƒ"]}),s.jsxs("p",{className:"text-[11px] text-gray-500",children:[r,"/",a,"ê°œ í’ˆëª© ë§¤ì¹­ë¨"]})]})]}),s.jsxs("div",{className:"grid grid-cols-1 gap-2 rounded-lg border border-gray-200 p-3",children:[s.jsxs("div",{className:"flex items-center justify-between text-[11px]",children:[s.jsx("span",{className:"text-gray-600",children:"ë°œì£¼/ìˆ˜ì£¼ë²ˆí˜¸ ë§¤ì¹­"}),s.jsx("span",{className:"font-medium "+(o?"text-green-600":"text-red-600"),children:o?"âœ… ì¼ì¹˜":"âŒ ë¶ˆì¼ì¹˜"})]}),s.jsxs("div",{className:"flex items-center justify-between text-[11px]",children:[s.jsx("span",{className:"text-gray-600",children:"í’ˆëª©ëª… ë§¤ì¹­"}),s.jsx("span",{className:"font-medium "+(u?"text-green-600":"text-red-600"),children:u?`âœ… ëª¨ë‘ ì¼ì¹˜ (${d}/${a})`:`âŒ ë¶ˆì¼ì¹˜ (${d}/${a})`})]}),s.jsxs("div",{className:"flex items-center justify-between text-[11px]",children:[s.jsx("span",{className:"text-gray-600",children:"ìˆ˜ëŸ‰ ë§¤ì¹­"}),s.jsx("span",{className:"font-medium "+(x?"text-green-600":"text-red-600"),children:x?`âœ… ëª¨ë‘ ì¼ì¹˜ (${m}/${a})`:`âŒ ë¶ˆì¼ì¹˜ (${m}/${a})`})]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx("p",{className:"text-[11px] font-semibold text-gray-600",children:"í’ˆëª©ë³„ ë§¤ì¹­ ìƒì„¸:"}),s.jsx("div",{className:"max-h-[250px] overflow-y-auto space-y-2",children:f?.items.map(e=>{const t=D.get(e.id),r=t?V(Ke(e,"item_name")||"",t.item_name,t.specification):0,a=r>=40,n=Ke(e,"quantity"),i="number"==typeof n?n:""!==n?Number(n):void 0,c=t?.quantity,l=J(i,c),o=(m=c,null==(d=i)||null==m?"mismatch":d===m?"exact":d<=m?"partial":"mismatch");var d,m;return s.jsxs("div",{className:"p-2 rounded-lg border "+(a&&l?"bg-green-50 border-green-200":a?"bg-yellow-50 border-yellow-200":"bg-gray-50 border-gray-200"),children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsx("p",{className:"text-[11px] font-medium text-gray-800 truncate",children:e.extracted_item_name||"-"}),s.jsxs("p",{className:"text-[10px] text-gray-500",children:["â†’ ",t?.item_name||"ë¯¸ë§¤ì¹­"]})]}),s.jsx("span",{className:"text-[10px] px-2 py-0.5 rounded font-medium ml-2 "+(r>=85?"bg-green-100 text-green-700":r>=60?"bg-yellow-100 text-yellow-700":r>=40?"bg-orange-100 text-orange-700":"bg-red-100 text-red-600"),children:a?`${Math.round(r)}%`:"ë¯¸ë§¤ì¹­"})]}),a&&s.jsxs("div",{className:"flex items-center gap-2 mt-1.5 pt-1.5 border-t border-gray-100",children:[s.jsx("span",{className:"text-[10px] text-gray-500",children:"ìˆ˜ëŸ‰:"}),s.jsxs("span",{className:"text-[10px] font-medium text-gray-700",children:["OCR ",i??"-","ê°œ"]}),s.jsx("span",{className:"text-[10px] text-gray-400",children:"vs"}),s.jsxs("span",{className:"text-[10px] font-medium text-gray-700",children:["ì‹œìŠ¤í…œ ",c??"-","ê°œ"]}),s.jsx("span",{className:"text-[9px] px-1.5 py-0.5 rounded "+(l?"bg-green-100 text-green-700":"partial"===o?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"),children:l?"âœ… ì¼ì¹˜":"partial"===o?"âš ï¸ ë¶€ë¶„ìž…ê³ ":"âŒ ë¶ˆì¼ì¹˜"})]})]},e.id)})})]})]})})()}),s.jsx(b,{children:s.jsx(n,{variant:"outline",size:"sm",onClick:()=>ae(!1),className:"text-[11px]",children:"ë‹«ê¸°"})})]})}),s.jsx(K,{isOpen:N,imageUrl:a.image_url,onClose:()=>v(!1)}),B.has("global-po")&&i.createPortal(s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"fixed inset-0 z-[100]",style:{pointerEvents:"auto"},onClick:()=>et("global-po")}),s.jsxs("div",{className:"fixed z-[101] bg-white border border-gray-200 rounded-lg shadow-xl min-w-[280px] max-h-[350px] overflow-y-auto",style:{top:H.top,left:H.left,pointerEvents:"auto"},onClick:e=>e.stopPropagation(),children:[s.jsx("div",{className:"sticky top-0 bg-gray-50 px-3 py-2 border-b border-gray-100 rounded-t-lg",children:s.jsx("span",{className:"text-[10px] font-semibold text-gray-600",children:"ë°œì£¼ë²ˆí˜¸ ì„ íƒ"})}),Pe.map((e,t)=>{const r=e.poNumber||e.salesOrderNumber||"",a=$===r,n=Ie?.bestMatch?.purchase_order_number===e.poNumber||Ie?.bestMatch?.sales_order_number===e.salesOrderNumber;return s.jsxs("div",{onClick:e=>{e.stopPropagation(),Ve(r),et("global-po")},className:`p-2.5 cursor-pointer border-b border-gray-50 last:border-0 transition-colors ${a?"bg-blue-50":"hover:bg-gray-50"} ${n?"ring-1 ring-inset ring-green-400":""}`,children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("p",{className:"text-[12px] font-medium text-gray-900",children:[e.poNumber||e.salesOrderNumber,e.poNumber&&e.salesOrderNumber&&s.jsxs("span",{className:"text-gray-500 font-normal",children:[" (",e.salesOrderNumber,")"]})]}),(void 0!==e.displayScore||void 0!==e.setMatchScore)&&s.jsxs("span",{className:"text-[10px] px-1.5 py-0.5 rounded font-medium "+((e.displayScore??e.setMatchScore??0)>=80?"bg-green-100 text-green-700":(e.displayScore??e.setMatchScore??0)>=50?"bg-yellow-100 text-yellow-700":"bg-gray-100 text-gray-600"),children:[Math.min(100,e.displayScore??e.setMatchScore??0),"%"]})]}),s.jsxs("p",{className:"text-[10px] text-gray-500 mt-0.5",children:[void 0!==e.matchedItemCount?`${e.matchedItemCount}/${f?.items.length||0}ê°œ ë§¤ì¹­`:`${e.itemCount}ê°œ í’ˆëª©`," Â· ",e.vendorName||"ê±°ëž˜ì²˜ ë¯¸ìƒ"]}),void 0!==e.quantityMatchedCount&&void 0!==e.matchedItemCount&&e.matchedItemCount>0&&s.jsx("p",{className:"text-[9px] mt-0.5 "+(0===e.quantityMismatchedCount?"text-green-600":"text-orange-600"),children:0===e.quantityMismatchedCount?"âœ… ìˆ˜ëŸ‰ ëª¨ë‘ ì¼ì¹˜":`âš ï¸ ìˆ˜ëŸ‰ ${e.quantityMismatchedCount}ê°œ ë¶ˆì¼ì¹˜`}),n&&s.jsx("p",{className:"text-[9px] text-green-600 font-medium mt-0.5",children:"âœ… ì„¸íŠ¸ ë§¤ì¹­ ì¶”ì²œ"})]},t)})]})]}),document.body),Y&&s.jsx(O,{purchaseId:Y,isOpen:G,onClose:()=>{X(!1),Z(null)},activeTab:"all"})]}):null}function Y(){const[e,i]=t.useState([]),[x,p]=t.useState(!0),[h,_]=t.useState(""),[b,q]=t.useState("all"),[$,z]=t.useState(""),[E,R]=t.useState(0),[W,F]=t.useState(!1),[U,T]=t.useState(!1),[G,V]=t.useState(null),[J,Y]=t.useState(!1),[Z,Q]=t.useState(!1),[ee,te]=t.useState(""),[re,se]=t.useState(new Set),[ae,ne]=t.useState(!1),[ie,ce]=t.useState(null),[le,oe]=t.useState({isOpen:!1,statement:null,position:{top:0,left:0}}),de=t.useCallback(async()=>{try{p(!0);const e=await k.getStatements({status:"all"!==b?b:void 0,dateFrom:$||void 0,search:h||void 0,limit:50});e.success?(i(e.data||[]),R(e.count||0)):y.error(e.error||"ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}catch(e){y.error("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}finally{p(!1)}},[b,$,h]);t.useEffect(()=>{de()},[de]);const me=t.useRef(r());t.useEffect(()=>{const e=me.current,t=e.channel("transaction-statements-changes").on("postgres_changes",{event:"*",schema:"public",table:"transaction_statements"},e=>{if("UPDATE"===e.eventType){const t=e.new?.status,r=e.old?.status;t!==r&&de()}else"INSERT"!==e.eventType&&"DELETE"!==e.eventType||de()}).subscribe();return()=>{e.removeChannel(t)}},[de]);const ue=e=>{const t="inline-flex items-center gap-1 business-radius-badge px-2 py-0.5 text-[10px] font-medium leading-tight";switch(e){case"pending":return s.jsxs("span",{className:`${t} bg-gray-100 text-gray-600 border border-gray-200`,children:[s.jsx(L,{className:"w-3 h-3"}),"ëŒ€ê¸°ì¤‘"]});case"processing":return s.jsxs("span",{className:`${t} bg-blue-50 text-blue-600 border border-blue-200`,children:[s.jsx(I,{className:"w-3 h-3 animate-spin"}),"ì²˜ë¦¬ì¤‘"]});case"extracted":return s.jsxs("span",{className:`${t} bg-yellow-50 text-yellow-600 border border-yellow-200`,children:[s.jsx(l,{className:"w-3 h-3"}),"í™•ì¸í•„ìš”"]});case"confirmed":return s.jsxs("span",{className:`${t} bg-green-50 text-green-600 border border-green-200`,children:[s.jsx(M,{className:"w-3 h-3"}),"í™•ì •ë¨"]});case"rejected":return s.jsxs("span",{className:`${t} bg-red-50 text-red-600 border border-red-200`,children:[s.jsx(P,{className:"w-3 h-3"}),"ê±°ë¶€ë¨"]});default:return s.jsx("span",{className:`${t} bg-gray-100 text-gray-600`,children:e})}},xe=(e,t)=>{if(V(e),"extracted"===e.status)Y(!0);else if("confirmed"===e.status&&e.matched_purchases&&e.matched_purchases.length>0)if(1===e.matched_purchases.length)ce(e.matched_purchases[0].purchase_id),ne(!0);else{const r=t?.currentTarget?.getBoundingClientRect();oe({isOpen:!0,statement:e,position:{top:r?r.bottom+window.scrollY:0,left:r?r.left+window.scrollX:0}})}else"confirmed"!==e.status&&"pending"!==e.status||(te(e.image_url),Q(!0))},pe=()=>{oe({isOpen:!1,statement:null,position:{top:0,left:0}})},he=(e,t)=>{e.stopPropagation(),te(t),Q(!0)},_e=()=>{Y(!1),V(null),de()},be=e=>e?new Date(e).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"}):"-",ge=e=>null==e?"-":e.toLocaleString("ko-KR")+"ì›";return s.jsxs("div",{className:"w-full",children:[s.jsx("div",{className:"mb-4",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"page-title",children:"ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸"}),s.jsx("p",{className:"page-subtitle",style:{marginTop:"-2px",marginBottom:"-4px"},children:"Transaction Statement Verification"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs(n,{onClick:()=>T(!0),className:"!h-auto button-base bg-hansl-600 hover:bg-hansl-700 text-white",children:[s.jsx(g,{className:"w-3.5 h-3.5"}),s.jsx("span",{className:"hidden sm:inline",children:"ì—…ë¡œë“œ"})]}),s.jsx(n,{variant:"outline",onClick:de,disabled:x,className:"!h-auto button-base",children:s.jsx(B,{className:"w-3.5 h-3.5 "+(x?"animate-spin":"")})})]})]})}),s.jsxs("div",{className:"mb-3",children:[s.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[s.jsxs("div",{className:"relative min-w-[140px] max-w-[200px]",children:[s.jsx(o,{className:"absolute left-1.5 top-1/2 transform -translate-y-1/2 w-2.5 h-2.5 text-gray-400"}),s.jsx(f,{placeholder:"ê±°ëž˜ì²˜ëª…, íŒŒì¼ëª… ê²€ìƒ‰...",value:h,onChange:e=>_(e.target.value),className:"!h-auto !py-px !pr-1.5 !pl-5 !text-[11px] !min-h-[20px] business-radius-input border border-gray-300 bg-white text-gray-700"})]}),s.jsxs(j,{value:b,onValueChange:q,children:[s.jsx(N,{className:"!h-auto !py-[1px] !px-2 !text-[12px] !min-h-[22px] w-[100px] business-radius-input border border-gray-300 bg-white text-gray-700 [&>svg]:h-3 [&>svg]:w-3",children:s.jsx(v,{placeholder:"ìƒíƒœ"})}),s.jsxs(w,{className:"min-w-[100px]",children:[s.jsx(S,{value:"all",className:"text-[12px] py-1.5",children:"ì „ì²´ ìƒíƒœ"}),s.jsx(S,{value:"pending",className:"text-[12px] py-1.5",children:"ëŒ€ê¸°ì¤‘"}),s.jsx(S,{value:"extracted",className:"text-[12px] py-1.5",children:"í™•ì¸í•„ìš”"}),s.jsx(S,{value:"confirmed",className:"text-[12px] py-1.5",children:"í™•ì •ë¨"}),s.jsx(S,{value:"rejected",className:"text-[12px] py-1.5",children:"ê±°ë¶€ë¨"})]})]}),s.jsxs(n,{variant:"outline",onClick:()=>F(!W),className:"!h-auto button-base border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 "+(W?"bg-hansl-50 border-hansl-300 text-hansl-700":""),children:[s.jsx(H,{className:"w-3.5 h-3.5 mr-1"}),s.jsx("span",{className:"button-text",children:"í•„í„°"})]}),s.jsxs("span",{className:"badge-stats bg-gray-100 text-gray-600",children:["ì´ ",E,"ê±´"]})]}),W&&s.jsx("div",{className:"mt-2 p-3 bg-gray-50 business-radius-card border border-gray-200",children:s.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("label",{className:"text-[12px] font-medium text-gray-500",children:"ì—…ë¡œë“œ ë‚ ì§œ"}),s.jsx(f,{type:"date",value:$,onChange:e=>z(e.target.value),className:"!h-auto !py-[2px] !px-2.5 !text-[12px] !min-h-[24px] w-[140px] business-radius-input border border-gray-300 bg-white text-gray-700"})]}),s.jsxs(n,{variant:"outline",onClick:()=>{_(""),q("all"),z("")},className:"!h-auto button-base border border-gray-300 bg-white text-blue-600 hover:bg-blue-50 hover:border-blue-300",children:["â†» ",s.jsx("span",{className:"button-text text-blue-600",children:"ì´ˆê¸°í™”"})]})]})})]}),s.jsx(d,{className:"overflow-hidden border border-gray-200 business-radius-card",children:s.jsx(m,{className:"p-0",children:x?s.jsxs("div",{className:"flex items-center justify-center py-12",children:[s.jsx("div",{className:"w-6 h-6 border-2 border-hansl-500 border-t-transparent rounded-full animate-spin"}),s.jsx("span",{className:"ml-3 text-[11px] text-gray-500",children:"ë¡œë”© ì¤‘..."})]}):0===e.length?s.jsxs("div",{className:"text-center py-12",children:[s.jsx(c,{className:"w-10 h-10 text-gray-300 mx-auto mb-3"}),s.jsx("h3",{className:"text-[12px] font-medium text-gray-700 mb-1",children:"ê±°ëž˜ëª…ì„¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤"}),s.jsx("p",{className:"text-[11px] text-gray-500",children:"ì—…ë¡œë“œëœ ê±°ëž˜ëª…ì„¸ì„œê°€ ì—†ê±°ë‚˜ ê²€ìƒ‰ ì¡°ê±´ì— ë§žëŠ” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤."})]}):s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"hidden md:block overflow-x-auto",children:s.jsxs("table",{className:"w-full min-w-fit",children:[s.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:s.jsxs("tr",{children:[s.jsx("th",{className:"px-3 py-2.5 text-center text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:"ìƒíƒœ"}),s.jsx("th",{className:"px-3 py-2.5 text-center text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:"ì—…ë¡œë“œì¼"}),s.jsx("th",{className:"px-3 py-2.5 text-center text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:"ëª…ì„¸ì„œì¼"}),s.jsx("th",{className:"px-3 py-2.5 text-left text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:"ê±°ëž˜ì²˜ëª…"}),s.jsx("th",{className:"px-3 py-2.5 text-left text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:"íŒŒì¼ëª…"}),s.jsx("th",{className:"px-3 py-2.5 text-right text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:"í•©ê³„ê¸ˆì•¡"}),s.jsx("th",{className:"px-3 py-2.5 text-center text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:"ë“±ë¡ìž"}),s.jsx("th",{className:"px-3 py-2.5 text-center text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:"í™•ì •ìž"}),s.jsx("th",{className:"px-3 py-2.5 text-center text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:"ì•¡ì…˜"})]})}),s.jsx("tbody",{className:"bg-white divide-y divide-gray-100",children:e.map(e=>s.jsxs("tr",{className:"hover:bg-gray-50 transition-colors cursor-pointer",onClick:t=>xe(e,t),children:[s.jsx("td",{className:"px-3 py-2.5 text-center",children:re.has(e.id)?ue("processing"):ue(e.status)}),s.jsx("td",{className:"px-3 py-2.5 text-[11px] text-center text-gray-600",children:be(e.uploaded_at)}),s.jsx("td",{className:"px-3 py-2.5 text-[11px] text-center text-gray-600",children:e.statement_date?be(e.statement_date):"-"}),s.jsx("td",{className:"px-3 py-2.5 text-[11px] font-medium text-gray-900",children:e.vendor_name||"-"}),s.jsx("td",{className:"px-3 py-2.5 text-[11px] text-gray-700 max-w-[180px] truncate",children:e.file_name||"-"}),s.jsx("td",{className:"px-3 py-2.5 text-[11px] font-medium text-right text-gray-900",children:ge(e.grand_total)}),s.jsx("td",{className:"px-3 py-2.5 text-[11px] text-center text-gray-600",children:e.uploaded_by_name||"-"}),s.jsx("td",{className:"px-3 py-2.5 text-[11px] text-center text-gray-600",children:e.confirmed_by_name||"-"}),s.jsx("td",{className:"px-3 py-2.5 text-center",children:s.jsxs("div",{className:"flex items-center justify-center gap-1",children:[s.jsx("button",{onClick:t=>he(t,e.image_url),className:"p-1.5 rounded-md hover:bg-gray-100 text-gray-500 hover:text-gray-700 transition-colors",title:"ì´ë¯¸ì§€ ë³´ê¸°",children:s.jsx(C,{className:"w-3.5 h-3.5"})}),s.jsx("button",{onClick:t=>(async(e,t)=>{if(e.stopPropagation(),confirm(`"${t.file_name||"ì´ ê±°ëž˜ëª…ì„¸ì„œ"}"ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`))try{const e=await k.deleteStatement(t.id);e.success?(y.success("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."),de()):y.error(e.error||"ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}catch(r){y.error("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}})(t,e),className:"p-1.5 rounded-md hover:bg-red-50 text-red-400 hover:text-red-600 transition-colors",title:"ì‚­ì œ",children:s.jsx(u,{className:"w-3.5 h-3.5"})})]})})]},e.id))})]})}),s.jsx("div",{className:"md:hidden divide-y divide-gray-100",children:e.map(e=>s.jsxs("div",{className:"p-3 hover:bg-gray-50 transition-colors cursor-pointer",onClick:t=>xe(e,t),children:[s.jsxs("div",{className:"flex items-start justify-between mb-2",children:[re.has(e.id)?ue("processing"):ue(e.status),s.jsx("span",{className:"text-[10px] text-gray-400",children:be(e.uploaded_at)})]}),s.jsxs("div",{className:"mb-2",children:[s.jsx("p",{className:"text-[11px] font-medium text-gray-900",children:e.vendor_name||"ê±°ëž˜ì²˜ ë¯¸í™•ì¸"}),s.jsx("p",{className:"text-[10px] text-gray-500 truncate",children:e.file_name})]}),e.grand_total&&s.jsx("p",{className:"text-[12px] font-bold text-gray-900",children:ge(e.grand_total)}),s.jsx("div",{className:"flex items-center justify-end gap-2 mt-2 pt-2 border-t border-gray-100",children:s.jsxs("button",{onClick:t=>he(t,e.image_url),className:"button-base px-2 py-1 text-[10px] border border-gray-200 text-gray-600 hover:bg-gray-50",children:[s.jsx(C,{className:"w-3 h-3 mr-1"}),"ë³´ê¸°"]})})]},e.id))})]})})}),s.jsx(A,{isOpen:U,onClose:()=>T(!1),onSuccess:async(e,t)=>{T(!1),await de(),se(t=>new Set(t).add(e));try{y.loading("OCR ì¶”ì¶œ ì¤‘... (ì•½ 10~30ì´ˆ ì†Œìš”)",{id:`extraction-${e}`});const r=await k.extractStatementData(e,t);r.success?(y.success("OCR ì¶”ì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.",{id:`extraction-${e}`}),de(),r.data&&(V(r.data),Y(!0))):(y.error(r.error||"OCR ì¶”ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",{id:`extraction-${e}`}),de())}catch(r){y.error("OCR ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",{id:`extraction-${e}`}),de()}finally{se(t=>{const r=new Set(t);return r.delete(e),r})}}}),G&&s.jsx(X,{isOpen:J,statement:G,onClose:_e,onConfirm:_e}),s.jsx(K,{isOpen:Z,imageUrl:ee,onClose:()=>{Q(!1),te("")}}),le.isOpen&&le.statement&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"fixed inset-0 z-40",onClick:pe}),s.jsxs("div",{className:"fixed z-50 bg-white border border-gray-200 rounded-lg shadow-lg min-w-[280px] max-w-[360px]",style:{top:le.position.top+4,left:le.position.left},children:[s.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-b border-gray-100 bg-gray-50 rounded-t-lg",children:[s.jsxs("span",{className:"text-[11px] font-semibold text-gray-700",children:["ì—°ê²°ëœ ë°œì£¼ (",le.statement.matched_purchases?.length||0,"ê±´)"]}),s.jsx("button",{onClick:pe,className:"p-0.5 hover:bg-gray-200 rounded",children:s.jsx(a,{className:"w-3.5 h-3.5 text-gray-500"})})]}),s.jsx("div",{className:"max-h-[300px] overflow-auto",children:le.statement.matched_purchases?.map((e,t)=>s.jsxs("div",{onClick:()=>{return t=e.purchase_id,oe({isOpen:!1,statement:null,position:{top:0,left:0}}),ce(t),void ne(!0);var t},className:"flex items-center justify-between px-3 py-2.5 hover:bg-blue-50 cursor-pointer border-b border-gray-50 last:border-0 transition-colors",children:[s.jsxs("div",{className:"flex-1",children:[s.jsx("p",{className:"text-[12px] font-medium text-gray-900",children:e.purchase_order_number||e.sales_order_number||`ë°œì£¼ #${e.purchase_id}`}),e.sales_order_number&&e.purchase_order_number&&s.jsxs("p",{className:"text-[10px] text-gray-500",children:["ìˆ˜ì£¼: ",e.sales_order_number]})]}),s.jsxs("div",{className:"flex items-center gap-1 text-blue-600",children:[s.jsx("span",{className:"text-[10px]",children:"ìƒì„¸ë³´ê¸°"}),s.jsx(D,{className:"w-3.5 h-3.5"})]})]},e.purchase_id))})]})]}),ie&&s.jsx(O,{purchaseId:ie,isOpen:ae,onClose:()=>{ne(!1),ce(null)},activeTab:"all"})]})}export{Y as default};
//# sourceMappingURL=TransactionStatementMain-Ch9PXskx.js.map
