import{e,r as t,c as a,j as r,X as s,B as n,b as i,l as c,O as o,Q as l,P as d,x as m}from"./index-DsAL4iro.js";import{C as u,c as x,T as p}from"./card-C_LMoGjm.js";import{D as h,a as _,b as g,c as b,d as f,P as y,I as j}from"./dialog-B22Nto94.js";import{t as N}from"./index-Dz8943Z0.js";import{S as v,a as w,b as C,c as S,d as q,e as k}from"./select-8avWESM0.js";import{D as M,a as O,b as I,e as $}from"./dropdown-menu-SziJVaKh.js";import{C as E,a as P,b as D,f as R,c as z,d as F,e as B}from"./command-C36rWf8P.js";import{P as U,a as T,b as W}from"./popover-CdBmGBMH.js";import{I as L,e as A,t as H,n as X,C as J,P as G}from"./PurchaseDetailModal-C-yD7klJ.js";import{U as Q,Z as K,a as V}from"./zoom-out-S--gI9zw.js";import{L as Y}from"./loader-circle-FAMWboDr.js";import{f as Z}from"./react-select.esm-xf0YyH9B.js";import{D as ee}from"./download-ayaITdR2.js";import{S as te}from"./search-8TWKvsJc.js";import{C as ae}from"./check-B6iIntpq.js";import{C as re}from"./chevron-right-3Zn4N5p9.js";import{C as se}from"./clock-DNupN12_.js";import"./index-dVjxNOkf.js";import"./helpers-CmqE03mo.js";import"./textarea-CLkwskUf.js";import"./calendar-TX1shQE9.js";import"./credit-card-jVf85E50.js";import"./chevron-left-DiNSaEMF.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=e("circle-x",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]),ie=e("external-link",[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]]),ce=e("file-spreadsheet",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M8 13h2",key:"yr2amv"}],["path",{d:"M14 13h2",key:"un5t4a"}],["path",{d:"M8 17h2",key:"2yhykz"}],["path",{d:"M14 17h2",key:"10kma7"}]]),oe=e("refresh-cw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]),le=e("rotate-cw",[["path",{d:"M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8",key:"1p45f6"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}]]),de=e("sliders-horizontal",[["line",{x1:"21",x2:"14",y1:"4",y2:"4",key:"obuewd"}],["line",{x1:"10",x2:"3",y1:"4",y2:"4",key:"1q6298"}],["line",{x1:"21",x2:"12",y1:"12",y2:"12",key:"1iu8h1"}],["line",{x1:"8",x2:"3",y1:"12",y2:"12",key:"ntss68"}],["line",{x1:"21",x2:"16",y1:"20",y2:"20",key:"14d8ph"}],["line",{x1:"12",x2:"3",y1:"20",y2:"20",key:"m0wm8r"}],["line",{x1:"14",x2:"14",y1:"2",y2:"6",key:"14e1ph"}],["line",{x1:"8",x2:"8",y1:"10",y2:"14",key:"1i6ji0"}],["line",{x1:"16",x2:"16",y1:"18",y2:"22",key:"1lctlv"}]]);function me({isOpen:e,onClose:i,onSuccess:c}){const[o,l]=t.useState(null),[d,m]=t.useState(null),[u,x]=t.useState(!1),[p,y]=t.useState(""),[j,k]=t.useState(null),[M,O]=t.useState(""),I=t.useRef(null),$=a();t.useEffect(()=>{e&&(async()=>{try{const{data:{user:e}}=await $.auth.getUser();if(e?.email){const{data:t}=await $.from("employees").select("name").eq("email",e.email).single();t?.name&&y(t.name)}}catch(e){}})()},[e]);const E=e=>{e.type.startsWith("image/")?e.size>10485760?N.error("íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤."):(l(e),createImageBitmap(e).then(e=>{const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const a=t.getContext("2d");a&&(a.drawImage(e,0,0),m(t.toDataURL("image/jpeg",.8)))}).catch(()=>{const t=new FileReader;t.onloadend=()=>m(t.result),t.readAsDataURL(e)})):N.error("ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.")},P=()=>{u||(l(null),m(null),k(null),O(""),I.current&&(I.current.value=""),i())};return r.jsx(h,{open:e,onOpenChange:P,children:r.jsxs(_,{className:"sm:max-w-[480px] business-radius-modal",children:[r.jsx(g,{className:"border-b border-gray-100 pb-3",children:r.jsxs(b,{className:"flex items-center gap-2 text-[13px] font-bold text-gray-900",children:[r.jsx(Q,{className:"w-4 h-4 text-hansl-600"}),"ê±°ëž˜ëª…ì„¸ì„œ ì—…ë¡œë“œ"]})}),r.jsxs("div",{className:"py-4 px-1",children:[r.jsxs("div",{className:`\n              border-2 border-dashed business-radius-card p-6 text-center cursor-pointer transition-colors\n              ${d?"border-hansl-300 bg-hansl-50":"border-gray-200 hover:border-hansl-300 hover:bg-gray-50"}\n            `,onDrop:e=>{e.preventDefault(),e.stopPropagation();const t=e.dataTransfer.files[0];t&&E(t)},onDragOver:e=>{e.preventDefault(),e.stopPropagation()},onClick:()=>{I.current?.click()},children:[r.jsx("input",{ref:I,type:"file",accept:"image/*",onChange:e=>{const t=e.target.files?.[0];t&&E(t)},className:"hidden"}),d?r.jsxs("div",{className:"relative",children:[r.jsx("img",{src:d,alt:"ë¯¸ë¦¬ë³´ê¸°",className:"max-h-52 mx-auto business-radius-card shadow-sm"}),r.jsx("button",{className:"absolute top-2 right-2 p-1.5 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors",onClick:e=>{e.stopPropagation(),l(null),m(null),I.current&&(I.current.value="")},children:r.jsx(s,{className:"w-3.5 h-3.5"})}),r.jsx("p",{className:"mt-3 text-[11px] text-gray-600 truncate px-4",children:o?.name})]}):r.jsxs(r.Fragment,{children:[r.jsx(L,{className:"w-10 h-10 text-gray-300 mx-auto mb-3"}),r.jsx("p",{className:"text-[11px] text-gray-600 mb-1",children:"ê±°ëž˜ëª…ì„¸ì„œ ì´ë¯¸ì§€ë¥¼ ë“œëž˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”"}),r.jsx("p",{className:"text-[10px] text-gray-400",children:"ì§€ì› í˜•ì‹: JPG, PNG, GIF, WEBP (ìµœëŒ€ 10MB)"})]})]}),r.jsxs("div",{className:"mt-4 space-y-3 rounded-lg border border-gray-200 bg-gray-50/50 p-3",children:[r.jsxs("div",{className:"flex items-start justify-between gap-4",children:[r.jsx("div",{className:"modal-label text-gray-600",children:"ë°œì£¼/ìˆ˜ì£¼ êµ¬ë¶„"}),r.jsxs("div",{className:"flex flex-col items-end gap-1",children:[r.jsxs(v,{value:M,onValueChange:e=>O(e),disabled:u,children:[r.jsx(w,{className:"button-base border border-gray-300 bg-white text-gray-700 hover:bg-gray-50",children:r.jsx(C,{placeholder:"ë‹¨ì¼/ë‹¤ì¤‘ ì„ íƒ"})}),r.jsxs(S,{className:"border border-gray-200 business-radius-card shadow-md",children:[r.jsx(q,{value:"single",className:"text-[11px]",children:"ë‹¨ì¼ ë°œì£¼"}),r.jsx(q,{value:"multi",className:"text-[11px]",children:"ë‹¤ì¤‘ ë°œì£¼"})]})]}),!M&&r.jsx("span",{className:"text-[10px] text-red-500 font-medium",children:"ë‹¨ì¼/ë‹¤ì¤‘ì„ ì„ íƒí•´ì£¼ì„¸ìš”."})]})]}),r.jsxs("div",{className:"flex items-start justify-between gap-4",children:[r.jsx("div",{className:"modal-label text-gray-600",children:"ì‹¤ìž…ê³ ì¼"}),r.jsxs("div",{className:"flex flex-col items-end gap-1",children:[r.jsx(A,{onConfirm:e=>k(e),placeholder:"ìž…ê³ ì¼ì„ ì„ íƒí•˜ì„¸ìš”",align:"end",side:"bottom",hideQuantityInput:!0,disabled:u,children:r.jsx("button",{className:"button-base border border-gray-300 bg-white text-gray-700 hover:bg-gray-50",children:j?Z(j,"yyyy-MM-dd"):"ì‹¤ìž…ê³ ì¼ ì„ íƒ"})}),!j&&r.jsx("span",{className:"text-[10px] text-red-500 font-medium",children:"ì‹¤ìž…ê³ ì¼ì„ ìž…ë ¥í•´ì£¼ì„¸ìš”."})]})]})]}),r.jsx("div",{className:"mt-4 p-3 bg-blue-50 business-radius-card border border-blue-100",children:r.jsx("p",{className:"text-[10px] text-blue-700 leading-relaxed",children:"ðŸ’¡ ê±°ëž˜ëª…ì„¸ì„œë¥¼ ì´¬ì˜í•˜ê±°ë‚˜ ìŠ¤ìº”í•œ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”. ì—…ë¡œë“œ í›„ OCRë¡œ í’ˆëª©, ìˆ˜ëŸ‰, ê¸ˆì•¡, ë°œì£¼ë²ˆí˜¸ ë“±ì„ ìžë™ìœ¼ë¡œ ì¶”ì¶œí•©ë‹ˆë‹¤."})})]}),r.jsxs(f,{className:"border-t border-gray-100 pt-3 gap-2",children:[r.jsx(n,{variant:"outline",onClick:P,disabled:u,className:"button-base h-8 text-[11px]",children:"ì·¨ì†Œ"}),r.jsx(n,{onClick:async()=>{if(o)if(j)if(M)try{x(!0);const e=await H.uploadStatement(o,p||"ì•Œ ìˆ˜ ì—†ìŒ",j,M);e.success&&e.data?(N.success("ì—…ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."),c(e.data.statementId,e.data.imageUrl),P()):N.error(e.error||"ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}catch(e){N.error("ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}finally{x(!1)}else N.error("ë‹¨ì¼/ë‹¤ì¤‘ ì—¬ë¶€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");else N.error("ì‹¤ìž…ê³ ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");else N.error("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.")},disabled:!o||!j||!M||u,className:"button-base h-8 text-[11px] bg-hansl-600 hover:bg-hansl-700 text-white",children:u?r.jsxs(r.Fragment,{children:[r.jsx(Y,{className:"w-3.5 h-3.5 mr-1.5 animate-spin"}),"ì—…ë¡œë“œ ì¤‘..."]}):r.jsxs(r.Fragment,{children:[r.jsx(Q,{className:"w-3.5 h-3.5 mr-1.5"}),"ì—…ë¡œë“œ"]})})]})]})})}function ue({isOpen:e,onClose:i,onSuccess:c}){const[o,l]=t.useState(null),[d,m]=t.useState(null),[u,x]=t.useState(!1),[p,y]=t.useState(""),[j,k]=t.useState(null),[M,O]=t.useState(""),I=t.useRef(null),$=a();t.useEffect(()=>{e&&(async()=>{try{const{data:{user:e}}=await $.auth.getUser();if(e?.email){const{data:t}=await $.from("employees").select("name").eq("email",e.email).single();t?.name&&y(t.name)}}catch(e){}})()},[e]);const E=e=>{e.type.startsWith("image/")?e.size>10485760?N.error("íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤."):(l(e),createImageBitmap(e).then(e=>{const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const a=t.getContext("2d");a&&(a.drawImage(e,0,0),m(t.toDataURL("image/jpeg",.8)))}).catch(()=>{const t=new FileReader;t.onloadend=()=>m(t.result),t.readAsDataURL(e)})):N.error("ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.")},P=()=>{u||(l(null),m(null),k(null),O(""),I.current&&(I.current.value=""),i())};return r.jsx(h,{open:e,onOpenChange:P,children:r.jsxs(_,{className:"sm:max-w-[480px] business-radius-modal",children:[r.jsx(g,{className:"border-b border-gray-100 pb-3",children:r.jsxs(b,{className:"flex items-center gap-2 text-[13px] font-bold text-gray-900",children:[r.jsx(Q,{className:"w-4 h-4 text-orange-600"}),"ìž…ê³ ìˆ˜ëŸ‰ ì—…ë¡œë“œ"]})}),r.jsxs("div",{className:"py-4 px-1",children:[r.jsxs("div",{className:`\n              border-2 border-dashed business-radius-card p-6 text-center cursor-pointer transition-colors\n              ${d?"border-orange-300 bg-orange-50":"border-gray-200 hover:border-orange-300 hover:bg-gray-50"}\n            `,onDrop:e=>{e.preventDefault(),e.stopPropagation();const t=e.dataTransfer.files[0];t&&E(t)},onDragOver:e=>{e.preventDefault(),e.stopPropagation()},onClick:()=>{I.current?.click()},children:[r.jsx("input",{ref:I,type:"file",accept:"image/*",onChange:e=>{const t=e.target.files?.[0];t&&E(t)},className:"hidden"}),d?r.jsxs("div",{className:"relative",children:[r.jsx("img",{src:d,alt:"ë¯¸ë¦¬ë³´ê¸°",className:"max-h-52 mx-auto business-radius-card shadow-sm"}),r.jsx("button",{className:"absolute top-2 right-2 p-1.5 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors",onClick:e=>{e.stopPropagation(),l(null),m(null),I.current&&(I.current.value="")},children:r.jsx(s,{className:"w-3.5 h-3.5"})}),r.jsx("p",{className:"mt-3 text-[11px] text-gray-600 truncate px-4",children:o?.name})]}):r.jsxs(r.Fragment,{children:[r.jsx(L,{className:"w-10 h-10 text-gray-300 mx-auto mb-3"}),r.jsx("p",{className:"text-[11px] text-gray-600 mb-1",children:"ê±°ëž˜ëª…ì„¸ì„œ ì´ë¯¸ì§€ë¥¼ ë“œëž˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”"}),r.jsx("p",{className:"text-[10px] text-gray-400",children:"ì§€ì› í˜•ì‹: JPG, PNG, GIF, WEBP (ìµœëŒ€ 10MB)"})]})]}),r.jsxs("div",{className:"mt-4 space-y-3 rounded-lg border border-gray-200 bg-gray-50/50 p-3",children:[r.jsxs("div",{className:"flex items-start justify-between gap-4",children:[r.jsx("div",{className:"modal-label text-gray-600",children:"ë°œì£¼/ìˆ˜ì£¼ êµ¬ë¶„"}),r.jsxs("div",{className:"flex flex-col items-end gap-1",children:[r.jsxs(v,{value:M,onValueChange:e=>O(e),disabled:u,children:[r.jsx(w,{className:"button-base border border-gray-300 bg-white text-gray-700 hover:bg-gray-50",children:r.jsx(C,{placeholder:"ë‹¨ì¼/ë‹¤ì¤‘ ì„ íƒ"})}),r.jsxs(S,{className:"border border-gray-200 business-radius-card shadow-md",children:[r.jsx(q,{value:"single",className:"text-[11px]",children:"ë‹¨ì¼ ë°œì£¼"}),r.jsx(q,{value:"multi",className:"text-[11px]",children:"ë‹¤ì¤‘ ë°œì£¼"})]})]}),!M&&r.jsx("span",{className:"text-[10px] text-red-500 font-medium",children:"ë‹¨ì¼/ë‹¤ì¤‘ì„ ì„ íƒí•´ì£¼ì„¸ìš”."})]})]}),r.jsxs("div",{className:"flex items-start justify-between gap-4",children:[r.jsx("div",{className:"modal-label text-gray-600",children:"ì‹¤ìž…ê³ ì¼"}),r.jsxs("div",{className:"flex flex-col items-end gap-1",children:[r.jsx(A,{onConfirm:e=>k(e),placeholder:"ìž…ê³ ì¼ì„ ì„ íƒí•˜ì„¸ìš”",align:"end",side:"bottom",hideQuantityInput:!0,disabled:u,children:r.jsx("button",{className:"button-base border border-gray-300 bg-white text-gray-700 hover:bg-gray-50",children:j?Z(j,"yyyy-MM-dd"):"ì‹¤ìž…ê³ ì¼ ì„ íƒ"})}),!j&&r.jsx("span",{className:"text-[10px] text-red-500 font-medium",children:"ì‹¤ìž…ê³ ì¼ì„ ìž…ë ¥í•´ì£¼ì„¸ìš”."})]})]})]}),r.jsx("div",{className:"mt-4 p-3 bg-orange-50 business-radius-card border border-orange-100",children:r.jsx("p",{className:"text-[10px] text-orange-700 leading-relaxed",children:"ðŸ“¦ ì›”ë§ê²°ì œ ì—…ì²´ìš© ìž…ê³ ìˆ˜ëŸ‰ í™•ì¸ ê¸°ëŠ¥ìž…ë‹ˆë‹¤. ê±°ëž˜ëª…ì„¸ì„œì—ì„œ ìˆ˜ëŸ‰ë§Œ ì¶”ì¶œí•˜ì—¬ ì‹¤ìž…ê³ ìˆ˜ëŸ‰ì„ ê¸°ë¡í•©ë‹ˆë‹¤. (ê¸ˆì•¡ ì •ë³´ëŠ” ì¶”ì¶œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤)"})})]}),r.jsxs(f,{className:"border-t border-gray-100 pt-3 gap-2",children:[r.jsx(n,{variant:"outline",onClick:P,disabled:u,className:"button-base h-8 text-[11px]",children:"ì·¨ì†Œ"}),r.jsx(n,{onClick:async()=>{if(o)if(j)if(M)try{x(!0);const e=await H.uploadReceiptQuantity(o,p||"ì•Œ ìˆ˜ ì—†ìŒ",j,M);e.success&&e.data?(N.success("ìž…ê³ ìˆ˜ëŸ‰ ì—…ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."),c(e.data.statementId,e.data.imageUrl),P()):N.error(e.error||"ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}catch(e){N.error("ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}finally{x(!1)}else N.error("ë‹¨ì¼/ë‹¤ì¤‘ ì—¬ë¶€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");else N.error("ì‹¤ìž…ê³ ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");else N.error("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.")},disabled:!o||!j||!M||u,className:"button-base h-8 text-[11px] bg-orange-600 hover:bg-orange-700 text-white",children:u?r.jsxs(r.Fragment,{children:[r.jsx(Y,{className:"w-3.5 h-3.5 mr-1.5 animate-spin"}),"ì—…ë¡œë“œ ì¤‘..."]}):r.jsxs(r.Fragment,{children:[r.jsx(Q,{className:"w-3.5 h-3.5 mr-1.5"}),"ì—…ë¡œë“œ"]})})]})]})})}const xe=[".xls",".xlsx",".pdf",".jpg",".jpeg",".png",".gif",".webp"];function pe(e){const t=e.name.split(".").pop()?.toLowerCase()||"";return["xls","xlsx"].includes(t)?"excel":"pdf"===t?"pdf":"image"}function he({isOpen:e,onClose:i,onSuccess:c}){const[o,l]=t.useState(null),[d,m]=t.useState(null),[u,x]=t.useState(!1),[p,y]=t.useState(""),j=t.useRef(null),v=a();t.useEffect(()=>{e&&(async()=>{try{const{data:{user:e}}=await v.auth.getUser();if(e?.email){const{data:t}=await v.from("employees").select("name").eq("email",e.email).single();t?.name&&y(t.name)}}catch(e){}})()},[e]);const w=e=>{const t="."+(e.name.split(".").pop()?.toLowerCase()||"");xe.includes(t)?e.size>20971520?N.error("íŒŒì¼ í¬ê¸°ëŠ” 20MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤."):(l(e),e.type.startsWith("image/")?createImageBitmap(e).then(e=>{const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const a=t.getContext("2d");a&&(a.drawImage(e,0,0),m(t.toDataURL("image/jpeg",.8)))}).catch(()=>{const t=new FileReader;t.onloadend=()=>m(t.result),t.readAsDataURL(e)}):m(null)):N.error("ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ìž…ë‹ˆë‹¤. (ì—‘ì…€, PDF, ì´ë¯¸ì§€)")},C=()=>{u||(l(null),m(null),j.current&&(j.current.value=""),i())},S=o?pe(o):null;return r.jsx(h,{open:e,onOpenChange:C,children:r.jsxs(_,{className:"sm:max-w-[480px] business-radius-modal",children:[r.jsx(g,{className:"border-b border-gray-100 pb-3",children:r.jsxs(b,{className:"flex items-center gap-2 text-[13px] font-bold text-gray-900",children:[r.jsx(ce,{className:"w-4 h-4 text-emerald-600"}),"ê±°ëž˜ëª…ì„¸ì„œ(ì›”ë§ê²°ì œ) ì—…ë¡œë“œ"]})}),r.jsxs("div",{className:"py-4 px-1",children:[r.jsxs("div",{className:`\n              border-2 border-dashed business-radius-card p-6 text-center cursor-pointer transition-colors\n              ${o?"border-emerald-300 bg-emerald-50":"border-gray-200 hover:border-emerald-300 hover:bg-gray-50"}\n            `,onDrop:e=>{e.preventDefault(),e.stopPropagation();const t=e.dataTransfer.files[0];t&&w(t)},onDragOver:e=>{e.preventDefault(),e.stopPropagation()},onClick:()=>{j.current?.click()},children:[r.jsx("input",{ref:j,type:"file",accept:".xls,.xlsx,.pdf,image/*",onChange:e=>{const t=e.target.files?.[0];t&&w(t)},className:"hidden"}),o?r.jsxs("div",{className:"relative",children:[d?r.jsx("img",{src:d,alt:"ë¯¸ë¦¬ë³´ê¸°",className:"max-h-52 mx-auto business-radius-card shadow-sm"}):r.jsxs("div",{className:"flex flex-col items-center gap-2",children:[r.jsx(ce,{className:"w-12 h-12 text-emerald-500"}),r.jsx("span",{className:"text-[11px] font-medium text-emerald-700",children:"excel"===S?"ì—‘ì…€ íŒŒì¼":"pdf"===S?"PDF íŒŒì¼":"ì´ë¯¸ì§€ íŒŒì¼"})]}),r.jsx("button",{className:"absolute top-2 right-2 p-1.5 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors",onClick:e=>{e.stopPropagation(),l(null),m(null),j.current&&(j.current.value="")},children:r.jsx(s,{className:"w-3.5 h-3.5"})}),r.jsx("p",{className:"mt-3 text-[11px] text-gray-600 truncate px-4",children:o.name})]}):r.jsxs(r.Fragment,{children:[r.jsx(ce,{className:"w-10 h-10 text-gray-300 mx-auto mb-3"}),r.jsx("p",{className:"text-[11px] text-gray-600 mb-1",children:"ì›”ë§ê²°ì œ ê±°ëž˜ëª…ì„¸ì„œë¥¼ ë“œëž˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”"}),r.jsx("p",{className:"text-[10px] text-gray-400",children:"ì§€ì› í˜•ì‹: XLS, XLSX, PDF, JPG, PNG (ìµœëŒ€ 20MB)"})]})]}),r.jsx("div",{className:"mt-4 p-3 bg-emerald-50 business-radius-card border border-emerald-100",children:r.jsx("p",{className:"text-[10px] text-emerald-700 leading-relaxed",children:"ì›”ë§ê²°ì œ ì—…ì²´ì˜ ê±°ëž˜ëª…ì„¸ì„œë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”. ì—‘ì…€/PDFëŠ” íŒŒì‹±ìœ¼ë¡œ ì •í™•í•˜ê²Œ, ì´ë¯¸ì§€ëŠ” OCRë¡œ ìžë™ ì¶”ì¶œí•©ë‹ˆë‹¤. í’ˆëª©ëª…ìœ¼ë¡œ ì‹œìŠ¤í…œ ë°œì£¼ë¥¼ ë§¤ì¹­í•˜ì—¬ ë‹¨ê°€/í•©ê³„ë¥¼ ìžë™ ê¸°ìž…í•©ë‹ˆë‹¤."})})]}),r.jsxs(f,{className:"border-t border-gray-100 pt-3 gap-2",children:[r.jsx(n,{variant:"outline",onClick:C,disabled:u,className:"button-base h-8 text-[11px]",children:"ì·¨ì†Œ"}),r.jsx(n,{onClick:async()=>{if(o)try{x(!0);const e=pe(o),t=await H.uploadMonthlyStatement(o,p||"ì•Œ ìˆ˜ ì—†ìŒ",void 0,void 0,e);t.success&&t.data?(N.success("ì›”ë§ê²°ì œ ê±°ëž˜ëª…ì„¸ì„œ ì—…ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."),c(t.data.statementId,t.data.fileUrl),C()):N.error(t.error||"ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}catch(e){N.error("ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}finally{x(!1)}else N.error("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.")},disabled:!o||u,className:"button-base h-8 text-[11px] bg-emerald-600 hover:bg-emerald-700 text-white",children:u?r.jsxs(r.Fragment,{children:[r.jsx(Y,{className:"w-3.5 h-3.5 mr-1.5 animate-spin"}),"ì—…ë¡œë“œ ì¤‘..."]}):r.jsxs(r.Fragment,{children:[r.jsx(Q,{className:"w-3.5 h-3.5 mr-1.5"}),"ì—…ë¡œë“œ"]})})]})]})})}function _e({isOpen:e,imageUrl:a,onClose:n}){const[i,c]=t.useState(1),[o,l]=t.useState(0),d=()=>{c(1),l(0),n()};return a?r.jsx(h,{open:e,onOpenChange:d,children:r.jsxs(_,{className:"max-w-[90vw] max-h-[90vh] p-0 bg-black/95 border-none",children:[r.jsxs("div",{className:"absolute top-0 left-0 right-0 z-50 flex items-center justify-between px-4 py-3 bg-gradient-to-b from-black/80 to-transparent",children:[r.jsxs("div",{className:"flex items-center gap-1.5",children:[r.jsx("button",{onClick:()=>{c(e=>Math.max(e-.25,.5))},disabled:i<=.5,className:"p-2 rounded-lg bg-white/10 hover:bg-white/20 text-white disabled:opacity-40 transition-colors",children:r.jsx(K,{className:"w-4 h-4"})}),r.jsxs("span",{className:"text-[11px] text-white min-w-[50px] text-center font-medium",children:[Math.round(100*i),"%"]}),r.jsx("button",{onClick:()=>{c(e=>Math.min(e+.25,3))},disabled:i>=3,className:"p-2 rounded-lg bg-white/10 hover:bg-white/20 text-white disabled:opacity-40 transition-colors",children:r.jsx(V,{className:"w-4 h-4"})}),r.jsx("div",{className:"w-px h-5 bg-white/30 mx-1.5"}),r.jsx("button",{onClick:()=>{l(e=>(e+90)%360)},className:"p-2 rounded-lg bg-white/10 hover:bg-white/20 text-white transition-colors",children:r.jsx(le,{className:"w-4 h-4"})}),r.jsx("button",{onClick:async()=>{try{const e=await fetch(a),t=await e.blob(),r=window.URL.createObjectURL(t),s=document.createElement("a");s.href=r,s.download=`ê±°ëž˜ëª…ì„¸ì„œ_${(new Date).toISOString().split("T")[0]}.jpg`,document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(r),N.success("ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.")}catch(e){N.error("ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}},className:"p-2 rounded-lg bg-white/10 hover:bg-white/20 text-white transition-colors",children:r.jsx(ee,{className:"w-4 h-4"})})]}),r.jsx("button",{onClick:d,className:"p-2 rounded-lg bg-white/10 hover:bg-white/20 text-white transition-colors",children:r.jsx(s,{className:"w-4 h-4"})})]}),r.jsx("div",{className:"flex items-center justify-center w-full h-[80vh] overflow-auto p-4 pt-16",children:r.jsx("img",{src:a,alt:"ê±°ëž˜ëª…ì„¸ì„œ",className:"max-w-full max-h-full object-contain transition-transform duration-200",style:{transform:`scale(${i}) rotate(${o}deg)`}})})]})}):null}function ge(e,t){const a=e?.toLowerCase().replace(/\s+/g,"")||"",r=t?.toLowerCase().replace(/\s+/g,"")||"";if(!a||!r)return 0;if(a===r)return 100;const s=Math.min(a.length,r.length),n=Math.max(a.length,r.length),i=s/n;if(a.includes(r)||r.includes(a))return i>=.7?90:i>=.5?70:i>=.3?50:30;const c=(n-function(e,t){const a=e.toLowerCase().replace(/\s+/g,""),r=t.toLowerCase().replace(/\s+/g,"");if(a===r)return 0;if(0===a.length)return r.length;if(0===r.length)return a.length;const s=[];for(let n=0;n<=a.length;n++)s[n]=[n];for(let n=0;n<=r.length;n++)s[0][n]=n;for(let n=1;n<=a.length;n++)for(let e=1;e<=r.length;e++){const t=a[n-1]===r[e-1]?0:1;s[n][e]=Math.min(s[n-1][e]+1,s[n][e-1]+1,s[n-1][e-1]+t)}return s[a.length][r.length]}(a,r))/n*100,o=e?.split(/\s+/).filter(e=>e.length>=2)||[],l=t?.split(/\s+/).filter(e=>e.length>=2)||[];if(0===o.length||0===l.length)return c;const d=o.filter(e=>l.some(t=>{const a=e.toLowerCase(),r=t.toLowerCase();return a===r||a.length>=3&&r.includes(a)||r.length>=3&&a.includes(r)})).length/Math.max(o.length,l.length)*15;return Math.min(100,c+d)}function be(e,t,a){const r=ge(e,t),s=a?ge(e,a):0;return r>=30?r:s>=60&&r<30?Math.min(35,.4*s):Math.max(r,.3*s)}function fe(e,t){return null!=e&&(null!=t&&e===t)}function ye({isOpen:e,statement:s,onClose:l,onConfirm:d,onReextractStart:m,onReextractFinish:u}){const[x,p]=t.useState(!0),[y,j]=t.useState(!1),[v,w]=t.useState(null),[C,S]=t.useState(null),[q,M]=t.useState(!1),[O,I]=t.useState(""),$="statement-confirm-dialog",{currentUserRoles:E,currentUserId:P,currentUserName:D}=i(),R=a(),[z,F]=t.useState(""),[B,U]=t.useState(new Map),[T,W]=t.useState(new Map),[A,Q]=t.useState(new Set),[K,V]=t.useState({top:0,left:0}),[Z,ee]=t.useState(!1),[re,se]=t.useState(null),[ce,le]=t.useState(new Map),de=t.useRef(null),[me,ue]=t.useState(null),[xe,pe]=t.useState(new Map),he="receipt"===(C?.statement_mode??s.statement_mode);C?.statement_mode??s.statement_mode,t.useEffect(()=>{C&&C.items.slice(0,5).map(e=>{const t=T.get(e.id);return{itemId:e.id,matched:Boolean(t),sysUnitPrice:t?.unit_price??null,sysAmount:t?.amount??null,sysKeys:t?Object.keys(t):[]}})},[C,T,he,s.id]),t.useEffect(()=>{C&&Array.from(T.values()).find(Boolean)},[C,T,s.id]),t.useEffect(()=>{if(!C)return;const e=Array.from(T.values()).filter(Boolean).map(e=>e.purchase_id).filter(e=>"number"==typeof e),t=Array.from(new Set(e));if(0===t.length)return;(async()=>{const{data:e,error:a}=await R.from("purchase_requests").select("id, currency").in("id",t);if(a||!e)return;const r=new Map;e.forEach(e=>{e?.id&&r.set(e.id,e.currency||"KRW")}),pe(r)})()},[C,T,R,s.id]);const[ge,ye]=t.useState(!1),[je,Ne]=t.useState(""),[ve,we]=t.useState([]),[Ce,Se]=t.useState(!1),[qe,ke]=t.useState(!1),[Me,Oe]=t.useState(null),[Ie,$e]=t.useState(new Map),Ee=t.useRef(!1),Pe=t.useRef(null),[De,Re]=t.useState(!1),[ze,Fe]=t.useState(""),[Be,Ue]=t.useState([]),[Te,We]=t.useState(!1),[Le,Ae]=t.useState(!1),[He,Xe]=t.useState(!1),Je=t.useRef(!1),[Ge,Qe]=t.useState({}),[Ke,Ve]=t.useState({}),[Ye,Ze]=t.useState({}),et=t.useRef(null),[tt,at]=t.useState(""),[rt,st]=t.useState(new Map),nt=t.useRef(new Set);t.useEffect(()=>()=>{de.current&&clearTimeout(de.current)},[]),t.useEffect(()=>{if(!e)return;const t=e=>{const t=document.querySelector(`[data-debug="${$}"]`);document.documentElement,document.documentElement,t&&(t.getBoundingClientRect(),window.getComputedStyle(t))},a=requestAnimationFrame(()=>t()),r=()=>t();return window.addEventListener("resize",r),()=>{cancelAnimationFrame(a),window.removeEventListener("resize",r)}},[e,$]);const[it,ct]=t.useState(null),ot=t.useMemo(()=>{if(!C?.items.length)return!0;if("single"===C?.po_scope)return!0;const e=C.items.map(e=>e.extracted_po_number?X(e.extracted_po_number):null).filter(Boolean);return 0===e.length||e.every(t=>t===e[0])},[C]),lt=t.useMemo(()=>{if(!C?.items.length)return null;const e=C.items.find(e=>e.extracted_po_number)?.extracted_po_number;return e?X(e):null},[C]);t.useEffect(()=>{if(!C)return;const e=C.vendor_name||"";e&&!je&&Ne(e),e&&!Ee.current&&(Ee.current=!0,St(e,{silent:!0}))},[C,je]);const dt=e=>{if(!e)return"";const t=e.trim();if(!t)return"";if(/^\d{4}-\d{2}-\d{2}$/.test(t))return t;const a=new Date(t);return Number.isNaN(a.getTime())?t.slice(0,10):a.toISOString().slice(0,10)};t.useEffect(()=>{C&&at(dt(C.statement_date))},[C]);const mt=t.useCallback(async()=>{try{p(!0);const{data:{user:e}}=await R.auth.getUser();if(e?.email){const{data:t}=await R.from("employees").select("name").eq("email",e.email).single();t?.name&&I(t.name)}const t=await H.getStatementWithItems(s.id);if(t.success&&t.data){fetch("http://127.0.0.1:7244/ingest/d1bfd845-9c34-4c24-9ef7-fd981ce7dd8e",{method:"POST",headers:{"Content-Type":"application/json","X-Debug-Session-Id":"9f46d9"},body:JSON.stringify({sessionId:"9f46d9",runId:"ocr-regression-debug",hypothesisId:"H3",location:"StatementConfirmModal.tsx:loadData:ocrItemsSnapshot",message:"modal received ocr items snapshot",data:{statementId:s.id,itemCount:t.data.items.length,sample:t.data.items.slice(0,5).map(e=>({id:e?.id??null,line:e?.line_number??null,itemName:e?.extracted_item_name??null,specification:e?.extracted_specification??null,quantity:e?.extracted_quantity??null,unitPrice:e?.extracted_unit_price??null,amount:e?.extracted_amount??null,po:e?.extracted_po_number??null,matchedPurchaseId:e?.matched_purchase_id??null,matchedItemId:e?.matched_item_id??null}))},timestamp:Date.now()})}).catch(()=>{}),S(t.data);const e=new Map,a=new Map;t.data.items.forEach(t=>{let r="";if(t.extracted_po_number){r=X(t.extracted_po_number);const a=t.match_candidates?.some(e=>e.purchase_order_number===r||e.sales_order_number===r);a&&e.set(t.id,r)}if(t.matched_purchase&&t.matched_item_id){const r=t.matched_purchase.purchase_order_number||t.matched_purchase.sales_order_number||"";r&&e.set(t.id,r),a.set(t.id,{purchase_id:t.matched_purchase_id,item_id:t.matched_item_id,purchase_order_number:t.matched_purchase.purchase_order_number||"",sales_order_number:t.matched_purchase.sales_order_number,item_name:t.matched_item?.item_name||t.matched_item_name||"",specification:t.matched_item?.specification,quantity:t.matched_item?.quantity??t.matched_item_quantity,unit_price:t.matched_item?.unit_price_value??t.matched_item_unit_price,amount:t.matched_item?.amount_value??t.matched_item_amount,received_quantity:t.matched_item?.received_quantity,vendor_name:t.matched_purchase.vendor_name})}else{let s=null,n=-1;const i=t.match_candidates?.filter(e=>e.purchase_order_number===r||e.sales_order_number===r)||[];for(const e of i){const a=be(t.extracted_item_name||"",e.item_name,e.specification);a>n&&(n=a,s={purchase_id:e.purchase_id,item_id:e.item_id,purchase_order_number:e.purchase_order_number||"",sales_order_number:e.sales_order_number,item_name:e.item_name,specification:e.specification,quantity:e.quantity,received_quantity:e.received_quantity,unit_price:e.unit_price,amount:e.amount,vendor_name:e.vendor_name})}if(!s&&t.match_candidates&&t.match_candidates.length>0){for(const e of t.match_candidates){const a=be(t.extracted_item_name||"",e.item_name,e.specification);a>n&&a>=40&&(n=a,s={purchase_id:e.purchase_id,item_id:e.item_id,purchase_order_number:e.purchase_order_number||"",sales_order_number:e.sales_order_number,item_name:e.item_name,specification:e.specification,quantity:e.quantity,received_quantity:e.received_quantity,unit_price:e.unit_price,amount:e.amount,vendor_name:e.vendor_name})}if(s){const a=s.purchase_order_number||s.sales_order_number||"";a&&e.set(t.id,a)}}if(!e.has(t.id)&&t.match_candidates&&t.match_candidates.length>0){const r=t.match_candidates.reduce((e,t)=>e?(t.score??-1)>(e.score??-1)?t:e:t,t.match_candidates[0]),n=r.purchase_order_number||r.sales_order_number||"";if(n&&e.set(t.id,n),!s&&n){const e=t.match_candidates.filter(e=>e.purchase_order_number===n||e.sales_order_number===n);let r=null,s=-1;for(const a of e){const e=be(t.extracted_item_name||"",a.item_name,a.specification);e>s&&(s=e,r={purchase_id:a.purchase_id,item_id:a.item_id,purchase_order_number:a.purchase_order_number||"",sales_order_number:a.sales_order_number,item_name:a.item_name,specification:a.specification,quantity:a.quantity,received_quantity:a.received_quantity,unit_price:a.unit_price,amount:a.amount,vendor_name:a.vendor_name})}r&&a.set(t.id,r)}}a.has(t.id)||a.set(t.id,s)}}),t.data.items.forEach(t=>{const r=e.get(t.id);if(r&&!a.get(t.id)){const e=t.match_candidates?.filter(e=>e.purchase_order_number===r||e.sales_order_number===r)||[];if(e.length>0){let r=null,s=-1;for(const a of e){const e=be(t.extracted_item_name||"",a.item_name,a.specification);e>s&&(s=e,r={purchase_id:a.purchase_id,item_id:a.item_id,purchase_order_number:a.purchase_order_number||"",sales_order_number:a.sales_order_number,item_name:a.item_name,specification:a.specification,quantity:a.quantity,received_quantity:a.received_quantity,unit_price:a.unit_price,amount:a.amount,vendor_name:a.vendor_name})}r&&a.set(t.id,r)}}});const r=Array.from(a.values()).filter(Boolean);fetch("http://127.0.0.1:7244/ingest/d1bfd845-9c34-4c24-9ef7-fd981ce7dd8e",{method:"POST",headers:{"Content-Type":"application/json","X-Debug-Session-Id":"9f46d9"},body:JSON.stringify({sessionId:"9f46d9",runId:"system-total-debug",hypothesisId:"H1",location:"StatementConfirmModal.tsx:loadData:initialMatches",message:"initial matches amount snapshot",data:{statementId:s.id,matchCount:a.size,missingAmountCount:r.filter(e=>null==e.amount).length,zeroUnitPriceCount:r.filter(e=>0===(e.unit_price??null)).length,sample:r.slice(0,4).map(e=>({itemId:e.item_id,quantity:e.quantity??null,unitPrice:e.unit_price??null,amount:e.amount??null,po:e.purchase_order_number||e.sales_order_number||null}))},timestamp:Date.now()})}).catch(()=>{}),U(e),W(a);const n=t.data.items.find(e=>e.extracted_po_number)?.extracted_po_number;n&&F(X(n));const i=t.data.items.map(e=>e.extracted_po_number?X(e.extracted_po_number):null).filter(Boolean),c="single"===t.data.po_scope;if(c||0===i.length||i.every(e=>e===i[0])){const e=await H.findBestMatchingPurchaseOrderSet(t.data.items,n,t.data.vendor_name);if(e.success&&e.data){if(ct(e.data),e.data.bestMatch){const r=e.data.bestMatch.purchase_order_number||e.data.bestMatch.sales_order_number||"";F(r);const n=new Map;e.data.bestMatch.itemMatches.forEach(e=>{for(const a of t.data.items){const t=a.match_candidates?.find(t=>t.item_id===e.systemItemId);if(t){n.set(e.ocrItemId,{purchase_id:t.purchase_id,item_id:t.item_id,purchase_order_number:t.purchase_order_number||"",sales_order_number:t.sales_order_number,item_name:t.item_name,specification:t.specification,quantity:t.quantity,received_quantity:t.received_quantity,unit_price:t.unit_price,amount:t.amount,vendor_name:t.vendor_name});break}}});const i=new Map(a);n.forEach((e,t)=>{e&&i.set(t,e)});const c=Array.from(i.values()).filter(Boolean);fetch("http://127.0.0.1:7244/ingest/d1bfd845-9c34-4c24-9ef7-fd981ce7dd8e",{method:"POST",headers:{"Content-Type":"application/json","X-Debug-Session-Id":"9f46d9"},body:JSON.stringify({sessionId:"9f46d9",runId:"system-total-debug",hypothesisId:"H2",location:"StatementConfirmModal.tsx:loadData:setMatchMerge",message:"set-match merged matches snapshot",data:{statementId:s.id,selectedPO:r,mergedCount:i.size,missingAmountCount:c.filter(e=>null==e.amount).length,zeroUnitPriceCount:c.filter(e=>0===(e.unit_price??null)).length,sample:c.slice(0,4).map(e=>({itemId:e.item_id,quantity:e.quantity??null,unitPrice:e.unit_price??null,amount:e.amount??null,po:e.purchase_order_number||e.sales_order_number||null}))},timestamp:Date.now()})}).catch(()=>{}),W(i);const o=e.data.bestMatch.confidence,l="high"===o?"ë†’ìŒ":"medium"===o?"ë³´í†µ":"ë‚®ìŒ";N.success(`ì„¸íŠ¸ ë§¤ì¹­ ì™„ë£Œ! ${e.data.bestMatch.matchedItemCount}/${t.data.items.length}ê°œ í’ˆëª© ë§¤ì¹­ (ì‹ ë¢°ë„: ${l})`)}if(c&&!e.data.bestMatch&&!n){const e=t.data.items[0]?.match_candidates?.[0],a=e?.purchase_order_number||e?.sales_order_number||"";a&&F(a)}}}}else N.error(t.error||"ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}catch(e){N.error("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}finally{p(!1)}},[s.id,R]);t.useEffect(()=>{e&&s&&(Xe(!1),mt())},[e,s,mt]),t.useEffect(()=>{if(!C||!e)return;if(x)return;const t=new Map,a=new Map(B);let r=!1,n=!1;C.items.forEach(e=>{const s=T.get(e.id),i=ot?z:B.get(e.id)||(e.extracted_po_number?X(e.extracted_po_number):"");if(s&&(s.purchase_order_number===i||s.sales_order_number===i||s.purchase_id))return void t.set(e.id,s);let c=null,o=-1;const l=i&&e.match_candidates?.filter(e=>e.purchase_order_number===i||e.sales_order_number===i)||[];for(const t of l){const a=be(e.extracted_item_name||"",t.item_name,t.specification);a>o&&(o=a,c={purchase_id:t.purchase_id,item_id:t.item_id,purchase_order_number:t.purchase_order_number||"",sales_order_number:t.sales_order_number,item_name:t.item_name,specification:t.specification,quantity:t.quantity,received_quantity:t.received_quantity,unit_price:t.unit_price,amount:t.amount,vendor_name:t.vendor_name})}if(!c&&e.match_candidates)for(const t of e.match_candidates){const a=be(e.extracted_item_name||"",t.item_name,t.specification);a>o&&a>=40&&(o=a,c={purchase_id:t.purchase_id,item_id:t.item_id,purchase_order_number:t.purchase_order_number||"",sales_order_number:t.sales_order_number,item_name:t.item_name,specification:t.specification,quantity:t.quantity,received_quantity:t.received_quantity,unit_price:t.unit_price,amount:t.amount,vendor_name:t.vendor_name})}if(t.set(e.id,c),c){const t=c.purchase_order_number||c.sales_order_number||"",r=B.get(e.id)||"";t&&t!==r&&(a.set(e.id,t),n=!0)}s!==c&&(r=!0)});const i=Array.from(t.values()).filter(Boolean);fetch("http://127.0.0.1:7244/ingest/d1bfd845-9c34-4c24-9ef7-fd981ce7dd8e",{method:"POST",headers:{"Content-Type":"application/json","X-Debug-Session-Id":"9f46d9"},body:JSON.stringify({sessionId:"9f46d9",runId:"system-total-debug",hypothesisId:"H2",location:"StatementConfirmModal.tsx:selectedPOEffect:beforeSet",message:"selected-po effect computed matches",data:{statementId:s.id,selectedPONumber:z,isSamePONumber:ot,totalComputed:t.size,hasMatchChanges:r,hasPOChanges:n,missingAmountCount:i.filter(e=>null==e.amount).length,zeroUnitPriceCount:i.filter(e=>0===(e.unit_price??null)).length,sample:i.slice(0,4).map(e=>({itemId:e.item_id,quantity:e.quantity??null,unitPrice:e.unit_price??null,amount:e.amount??null,po:e.purchase_order_number||e.sales_order_number||null}))},timestamp:Date.now()})}).catch(()=>{}),r&&W(t),n&&U(a)},[z,ot,C,e,x]);const ut=t.useMemo(()=>{if(!C)return[];const e=C.items.find(e=>e.extracted_po_number)?.extracted_po_number||"",t=(e?X(e).toUpperCase():"").startsWith("HS"),a=new Map;it?.candidates&&it.candidates.forEach(e=>{const r=t&&e.sales_order_number||e.purchase_order_number;r&&a.set(r,{poNumber:e.purchase_order_number||"",salesOrderNumber:e.sales_order_number,itemCount:e.matchedItemCount,items:[],vendorName:e.vendor_name,setMatchScore:e.matchScore,matchedItemCount:e.matchedItemCount,purchaseId:e.purchase_id})}),C.items.forEach(e=>{e.match_candidates?.forEach(e=>{const r=t?e.sales_order_number||"":e.purchase_order_number||"";if(r&&!a.has(r)&&a.set(r,{poNumber:e.purchase_order_number||"",salesOrderNumber:e.sales_order_number,itemCount:0,items:[],vendorName:e.vendor_name,purchaseId:e.purchase_id}),r&&a.has(r)){const t=a.get(r);t.items.push(e),t.setMatchScore||(t.itemCount=t.items.length)}})}),Ie.size>0&&Ie.forEach((e,r)=>{const s=X(r),n=s.startsWith("HS");t&&!n||!t&&n||a.has(s)||a.set(s,{poNumber:n?"":s,salesOrderNumber:n?s:void 0,itemCount:e.length,items:e.map(e=>({purchase_id:e.purchase_id,purchase_order_number:e.purchase_order_number||"",sales_order_number:e.sales_order_number,item_id:e.item_id,item_name:e.item_name,specification:e.specification,quantity:e.quantity??0,unit_price:e.unit_price,vendor_name:e.vendor_name,score:0,match_reasons:["po_items_map"]})),vendorName:e[0]?.vendor_name,purchaseId:e[0]?.purchase_id})}),a.forEach((e,t)=>{let a=0,r=0,s=0,n=0;const i=X(t).toUpperCase(),c=C.items.map(e=>{const t=yt(e,"po_number");return t?X(t).toUpperCase():null}).filter(Boolean).some(e=>e===i),o=e.items;C.items.forEach(e=>{let t=0,i=null;const c=yt(e,"item_name");for(const a of o){const e=a,r=be(c||"",e.item_name,e.specification);r>t&&(t=r,i=e)}if(t>=40&&null!==i){r++;const t=yt(e,"quantity"),a="number"==typeof t?t:""!==t?Number(t):void 0,c=i.quantity;void 0!==a&&!Number.isNaN(a)&&fe(a,c)?s++:n++}a+=t});const l=C.items.length>0?Math.round(a/C.items.length):0,d=r>0&&s===r?10:0,m=Math.min(100,l+d),u=c?100:0;void 0===e.setMatchScore?(e.setMatchScore=m+u,e.displayScore=m,e.matchedItemCount=r):c&&(e.setMatchScore=(e.setMatchScore??0)+u,void 0===e.displayScore&&(e.displayScore=e.setMatchScore-u)),e.quantityMatchedCount=s,e.quantityMismatchedCount=n,e.hasOrderNumberMatch=c});const r=Array.from(a.values());return r.sort((e,t)=>{const a=e.hasOrderNumberMatch?1:0,r=t.hasOrderNumberMatch?1:0;if(a!==r)return r-a;const s=e.setMatchScore??0,n=t.setMatchScore??0;return s!==n?n-s:t.itemCount-e.itemCount}),r},[C,it,Ie,ce]),xt=t.useCallback(e=>{if(!e)return;const t=X(e),a=ut.find(a=>a.poNumber===t||a.salesOrderNumber===t||a.poNumber===e||a.salesOrderNumber===e);if(a)return t.startsWith("F")?a.salesOrderNumber:t.startsWith("HS")?a.poNumber:a.salesOrderNumber||a.poNumber;const r=Ie.get(t)||Ie.get(e)||[];if(r.length>0){const e=r[0];return t.startsWith("F")?e.sales_order_number:t.startsWith("HS")?e.purchase_order_number||e.purchase_order_number:e.sales_order_number||e.purchase_order_number}},[ut,Ie]),pt=e=>{if(!e)return;const t=X(e),a=rt.get(t);return void 0!==a?a||void 0:xt(e)};t.useEffect(()=>{if(!ut.length||!ot)return;if(He)return;const e=ut.find(e=>!0===e.hasOrderNumberMatch);if(e){const t=e.poNumber||e.salesOrderNumber||"";if(t&&t!==z)return void F(t)}if(!ut.some(e=>e.poNumber===z||e.salesOrderNumber===z)&&ut[0]){const e=ut[0],t=e.poNumber||e.salesOrderNumber||"";t&&F(t)}},[ut,z,ot,He]);const ht=t.useCallback(e=>{if(!C||!e)return[];const t=Ie.get(e)||[];if(t.length>0){return t.filter((e,t,a)=>t===a.findIndex(t=>t.item_id===e.item_id))}const a=[];C.items.forEach(t=>{t.match_candidates?.forEach(t=>{t.purchase_order_number!==e&&t.sales_order_number!==e||a.push({purchase_id:t.purchase_id,item_id:t.item_id,purchase_order_number:t.purchase_order_number||"",sales_order_number:t.sales_order_number,item_name:t.item_name,specification:t.specification,quantity:t.quantity,received_quantity:t.received_quantity,unit_price:t.unit_price,amount:t.amount,vendor_name:t.vendor_name})})});return a.filter((e,t,a)=>t===a.findIndex(t=>t.item_id===e.item_id))},[C,Ie]),_t=t.useCallback(e=>{if(!C)return[];const t=C.items.find(t=>t.id===e);if(!t)return[];const a=new Set,r=(t.extracted_po_number?X(t.extracted_po_number).toUpperCase():"").startsWith("HS");t.match_candidates?.forEach(e=>{r?e.sales_order_number&&a.add(e.sales_order_number):e.purchase_order_number&&a.add(e.purchase_order_number)});return Array.from(a)},[C]),gt=t.useCallback(async(e,t,a)=>{const r={item_name:"extracted_item_name",quantity:"extracted_quantity",unit_price:"extracted_unit_price",amount:"extracted_amount",po_number:"extracted_po_number"}[t];if(!r)return;const s="item_name"===t||"po_number"===t?a:Number(a),{error:n}=await R.from("transaction_statement_items").update({[r]:s}).eq("id",e);n&&c.warn("OCR ìˆ˜ì •ê°’ ìžë™ ì €ìž¥ ì‹¤íŒ¨:",n)},[R]),bt=(e,t,a)=>{le(r=>{const s=new Map(r),n=s.get(e)||{};return s.set(e,{...n,[t]:a}),s}),de.current&&clearTimeout(de.current),de.current=setTimeout(()=>{gt(e,t,a)},500)},ft=async()=>{if(!C||0===ce.size)return;const e=Array.from(ce.entries()).map(([e,t])=>{const a={};return void 0!==t.item_name&&(a.extracted_item_name=t.item_name),void 0!==t.quantity&&(a.extracted_quantity=Number(t.quantity)),void 0!==t.unit_price&&(a.extracted_unit_price=Number(t.unit_price)),void 0!==t.amount&&(a.extracted_amount=Number(t.amount)),void 0!==t.po_number&&(a.extracted_po_number=t.po_number),Object.keys(a).length>0?{itemId:e,updateData:a}:null}).filter(e=>Boolean(e));if(0===e.length)return;(await Promise.all(e.map(({itemId:e,updateData:t})=>R.from("transaction_statement_items").update(t).eq("id",e)))).some(({error:e})=>e)?N.error("ìˆ˜ì •ê°’ ì €ìž¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."):S(t=>{if(!t)return t;const a=t.items.map(t=>{const a=e.find(e=>e.itemId===t.id);return a?{...t,...a.updateData}:t});return{...t,items:a}})};function yt(e,t){const a=ce.get(e.id);if(a&&void 0!==a[t])return a[t];switch(t){case"item_name":return e.extracted_item_name||"";case"quantity":return e.extracted_quantity??"";case"unit_price":return e.extracted_unit_price??"";case"amount":return e.extracted_amount??"";case"po_number":return B.get(e.id)||(e.extracted_po_number?X(e.extracted_po_number):"");default:return""}}const jt=(e,t)=>{const a=ce.get(e.id);if(!a||void 0===a[t])return!1;switch(t){case"item_name":return a.item_name!==e.extracted_item_name;case"quantity":return a.quantity!==e.extracted_quantity;case"unit_price":return a.unit_price!==e.extracted_unit_price;case"amount":return a.amount!==e.extracted_amount;case"po_number":{const t=e.extracted_po_number?X(e.extracted_po_number):"";return a.po_number!==t}default:return!1}},Nt=async()=>{if(!C)return;const e=[];if(C.items.forEach(t=>{const a=ce.get(t.id);if(a&&(void 0!==a.item_name&&a.item_name!==t.extracted_item_name&&e.push({statement_id:C.id,statement_item_id:t.id,original_text:t.extracted_item_name||"",corrected_text:a.item_name,field_type:"item_name"}),void 0!==a.quantity&&a.quantity!==t.extracted_quantity&&e.push({statement_id:C.id,statement_item_id:t.id,original_text:String(t.extracted_quantity??""),corrected_text:String(a.quantity),field_type:"quantity"}),void 0!==a.unit_price&&a.unit_price!==t.extracted_unit_price&&e.push({statement_id:C.id,statement_item_id:t.id,original_text:String(t.extracted_unit_price??""),corrected_text:String(a.unit_price),field_type:"unit_price"}),void 0!==a.amount&&a.amount!==t.extracted_amount&&e.push({statement_id:C.id,statement_item_id:t.id,original_text:String(t.extracted_amount??""),corrected_text:String(a.amount),field_type:"amount"}),void 0!==a.po_number)){const r=t.extracted_po_number?X(t.extracted_po_number):"";a.po_number!==r&&e.push({statement_id:C.id,statement_item_id:t.id,original_text:r,corrected_text:a.po_number,field_type:"po_number"})}}),e.length>0){for(const t of e)await H.saveCorrection(t);N.success(`${e.length}ê±´ì˜ OCR ìˆ˜ì •ì‚¬í•­ì´ í•™ìŠµ ë°ì´í„°ë¡œ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.`)}},vt=async(e,t,a)=>{if(F(e),a){const t=X(e);st(e=>{const r=new Map(e);return r.set(t,a),r})}const r=ut.find(t=>t.poNumber===e||t.salesOrderNumber===e);let s=[],n=t||"";if(r&&r.items.length>0&&(s=r.items.map(e=>({purchase_id:e.purchase_id,item_id:e.item_id,purchase_order_number:e.purchase_order_number||"",sales_order_number:e.sales_order_number,item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price:e.unit_price,amount:e.amount,vendor_name:e.vendor_name})),s=s.filter((e,t,a)=>t===a.findIndex(t=>t.item_id===e.item_id)),!n&&s[0]?.vendor_name&&(n=s[0].vendor_name)),0===s.length&&(s=ht(e),!n&&s[0]?.vendor_name&&(n=s[0].vendor_name)),0===s.length)try{const{data:t}=await R.from("purchase_requests").select("\n            id,\n            purchase_order_number,\n            sales_order_number,\n            vendor:vendors(vendor_name)\n          ").or(`purchase_order_number.eq.${e},sales_order_number.eq.${e}`).limit(1).single();if(t){!n&&t.vendor?.vendor_name&&(n=t.vendor.vendor_name);const a=X(e),r=e.startsWith("F")?t.sales_order_number:t.purchase_order_number;r&&st(e=>{const t=new Map(e);return t.set(a,r),t});const{data:i}=await R.from("purchase_request_items").select("\n              id,\n              item_name,\n              specification,\n              quantity,\n              received_quantity,\n              unit_price_value,\n              amount_value\n            ").eq("purchase_request_id",t.id);i&&i.length>0&&(s=i.map(e=>({purchase_id:t.id,item_id:e.id,purchase_order_number:t.purchase_order_number||"",sales_order_number:t.sales_order_number,item_name:e.item_name||"",specification:e.specification,quantity:e.quantity,received_quantity:e.received_quantity,unit_price:e.unit_price_value,amount:e.amount_value,vendor_name:n})))}}catch(i){}if(s.length>0&&$e(t=>{const a=new Map(t);a.set(e,s);const r=s[0]?.sales_order_number;return r&&r!==e&&a.set(r,s),a}),n&&Ne(n),C){const t=new Map;C.items.forEach(e=>{let a=null,r=0;s.forEach(t=>{const s=be(e.extracted_item_name||"",t.item_name,t.specification);s>r&&s>=40&&(r=s,a=t)}),t.set(e.id,a)}),W(t);const a=new Map(ce),r=new Map(B);C.items.forEach(t=>{const s=a.get(t.id)||{};a.set(t.id,{...s,po_number:e}),r.set(t.id,e)}),le(a),U(r),C.items.forEach(a=>{const r=t.get(a.id);R.from("transaction_statement_items").update({extracted_po_number:e,matched_purchase_id:r?.purchase_id??null,matched_item_id:r?.item_id??null}).eq("id",a.id).then(({error:e})=>{e&&c.warn("ì „ì²´ ë°œì£¼ë²ˆí˜¸ ì„ íƒ ìžë™ ì €ìž¥ ì‹¤íŒ¨:",e)})})}},wt=t.useCallback(async e=>{const t=e.trim();if(!t)return;const a=X(t);if(a&&!rt.has(a)&&!nt.current.has(a)){nt.current.add(a);try{const{data:e,error:t}=await R.from("purchase_requests").select("purchase_order_number,sales_order_number").or(`purchase_order_number.eq.${a},sales_order_number.eq.${a}`).limit(1);if(t)throw t;const r=e?.[0],s=r?a.startsWith("F")?r.sales_order_number:a.startsWith("HS")?r.purchase_order_number:r.sales_order_number||r.purchase_order_number:null;st(e=>{const t=new Map(e);return t.set(a,s??null),t})}catch(r){st(e=>{const t=new Map(e);return t.set(a,null),t})}finally{nt.current.delete(a)}}},[rt,R]),Ct=t.useCallback(async e=>{wt(e),C&&C.items.forEach(t=>{bt(t.id,"po_number",e)});const t=X(e);if(!t)return;const a=ut.find(e=>e.poNumber===t||e.salesOrderNumber===t);if(a){const e=a.poNumber||a.salesOrderNumber||"";e&&e!==z&&F(e),a.vendorName&&(Ne(a.vendorName),Oe(a.vendorName))}else{F(t);try{const{data:e}=await R.from("purchase_requests").select("\n            id,\n            purchase_order_number,\n            sales_order_number,\n            vendor:vendors(vendor_name),\n            purchase_request_items (\n              id,\n              item_name,\n              specification,\n              quantity,\n              received_quantity,\n              unit_price_value,\n              amount_value\n            )\n          ").or(`purchase_order_number.eq.${t},sales_order_number.eq.${t}`).limit(1);if(e&&e.length>0){const a=e[0],r=a.purchase_request_items||[],s=a.vendor?.vendor_name||"",n=r.map(e=>({purchase_id:a.id,item_id:e.id,purchase_order_number:a.purchase_order_number||"",sales_order_number:a.sales_order_number,item_name:e.item_name,specification:e.specification,quantity:e.quantity??0,received_quantity:e.received_quantity,unit_price:e.unit_price_value,amount:e.amount_value,vendor_name:s}));$e(e=>{const r=new Map(e);return r.set(t,n),a.purchase_order_number&&r.set(a.purchase_order_number,n),a.sales_order_number&&r.set(a.sales_order_number,n),r}),s&&(Ne(s),Oe(s))}}catch(r){}}},[C,ut,z,wt,bt,R]),St=async(e,t)=>{const a=!t?.silent;Oe(e),Ne(e),ke(!1),we([]),R.from("transaction_statements").update({vendor_name:e}).eq("id",s.id).then(()=>{}),a&&N.success(`ê±°ëž˜ì²˜ê°€ "${e}"(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ë°œì£¼ í›„ë³´ë¥¼ ë‹¤ì‹œ ê²€ìƒ‰í•©ë‹ˆë‹¤.`);try{const{data:t,error:r}=await R.from("purchase_requests").select("\n          id,\n          purchase_order_number,\n          sales_order_number,\n          vendor:vendors!inner(vendor_name),\n          items:purchase_request_items(\n            id,\n            item_name,\n            specification,\n            quantity,\n            received_quantity,\n            unit_price_value,\n            amount_value\n          )\n        ").eq("vendor.vendor_name",e).order("created_at",{ascending:!1}).limit(50);if(r)throw r;if(!t||0===t.length)return void(a&&N.error(`"${e}" ê±°ëž˜ì²˜ì˜ ë°œì£¼ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.`));const s=new Map;let n=0;t.forEach(t=>{const a=(t.items||[]).map(a=>({purchase_id:t.id,item_id:a.id,purchase_order_number:t.purchase_order_number||"",sales_order_number:t.sales_order_number,item_name:a.item_name||"",specification:a.specification,quantity:a.quantity,received_quantity:a.received_quantity,unit_price:a.unit_price_value,amount:a.amount_value,vendor_name:e}));0!==a.length&&(n+=a.length,t.purchase_order_number&&s.set(t.purchase_order_number,a),t.sales_order_number&&s.set(t.sales_order_number,a))}),$e(s);const i=new Map,c=t[0]?.purchase_order_number||t[0]?.sales_order_number||"";if(C){C.items.forEach((a,r)=>{const s=[];let n=0,c=0;t.forEach(t=>{(t.items||[]).forEach(r=>{const i=be(a.extracted_item_name||"",r.item_name,r.specification);c+=1,i>n&&(n=i),i>=40&&s.push({purchase_id:t.id,item_id:r.id,purchase_order_number:t.purchase_order_number||"",sales_order_number:t.sales_order_number,item_name:r.item_name||"",specification:r.specification,quantity:r.quantity,unit_price:r.unit_price_value,score:i,match_reasons:["ê±°ëž˜ì²˜ ë§¤ì¹­"],vendor_name:e})})}),s.sort((e,t)=>t.score-e.score),i.set(a.id,s.slice(0,5))}),F(c);const r=new Map,s=(t[0]?.items||[]).map(a=>({purchase_id:t[0].id,item_id:a.id,purchase_order_number:t[0].purchase_order_number||"",sales_order_number:t[0].sales_order_number,item_name:a.item_name||"",specification:a.specification,quantity:a.quantity,unit_price:a.unit_price_value,amount:a.amount_value,vendor_name:e}));C.items.forEach(e=>{const t=T.get(e.id);if(t&&t.purchase_id)return void r.set(e.id,t);let a=null,n=0;s.forEach(t=>{const r=be(e.extracted_item_name||"",t.item_name,t.specification);r>n&&r>=30&&(n=r,a=t)}),r.set(e.id,a)}),W(r),ct({bestMatch:{purchase_id:t[0].id,purchase_order_number:t[0].purchase_order_number||"",sales_order_number:t[0].sales_order_number,vendor_name:e,matchScore:100,matchedItemCount:r.size,totalItemCount:C.items.length,confidence:"high",itemMatches:[]},candidates:t.map(a=>({purchase_id:a.id,purchase_order_number:a.purchase_order_number||"",sales_order_number:a.sales_order_number,vendor_name:e,matchScore:a.id===t[0].id?100:50,matchedItemCount:(a.items||[]).length}))}),a&&N.success(`${t.length}ê°œ ë°œì£¼ í›„ë³´ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤. ìžë™ ë§¤ì¹­ ì™„ë£Œ.`)}}catch(r){N.error("ë°œì£¼ í›„ë³´ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},qt=(e,t)=>{U(a=>{const r=new Map(a);return r.set(e,t),r});const a=C?.items.find(t=>t.id===e);if(a){const r=a.match_candidates?.filter(e=>e.purchase_order_number===t||e.sales_order_number===t)||[];let n=null,i=-1;if(r.length>0&&r.forEach(e=>{const t=be(a.extracted_item_name||"",e.item_name,e.specification);t>i&&(i=t,n={purchase_id:e.purchase_id,item_id:e.item_id,purchase_order_number:e.purchase_order_number||"",sales_order_number:e.sales_order_number,item_name:e.item_name,specification:e.specification,quantity:e.quantity,received_quantity:e.received_quantity,unit_price:e.unit_price,amount:e.amount,vendor_name:e.vendor_name})}),!n){ht(t).forEach(e=>{const t=be(a.extracted_item_name||"",e.item_name,e.specification);t>i&&(i=t,n=e)})}const c=n;fetch("http://127.0.0.1:7244/ingest/d1bfd845-9c34-4c24-9ef7-fd981ce7dd8e",{method:"POST",headers:{"Content-Type":"application/json","X-Debug-Session-Id":"9f46d9"},body:JSON.stringify({sessionId:"9f46d9",runId:"system-total-debug",hypothesisId:"H4",location:"StatementConfirmModal.tsx:handleSelectItemPO:selectedMatch",message:"item po selection matched system item",data:{statementId:s.id,ocrItemId:e,poNumber:t,bestScore:i,matchFound:Boolean(c),matchedItemId:c?.item_id??null,unitPrice:c?.unit_price??null,quantity:c?.quantity??null,amount:c?.amount??null,candidateCount:r.length},timestamp:Date.now()})}).catch(()=>{}),W(t=>{const a=new Map(t);return a.set(e,n),a}),It(e,n),gt(e,"po_number",t)}Q(t=>{const a=new Set(t);return a.delete(`po-${e}`),a})},kt=t.useCallback(e=>{const t=ut.find(t=>t.poNumber===e||t.salesOrderNumber===e);return t?.purchaseId||t?.items?.[0]?.purchase_id},[ut]),Mt=t.useCallback(e=>{se(e),ee(!0)},[]),Ot=t.useCallback(async(e,t)=>{if(Qe(a=>({...a,[e]:t})),!t||t.trim().length<2)Ve(t=>({...t,[e]:[]}));else{Ze(t=>({...t,[e]:!0}));try{const{data:a,error:r}=await R.from("purchase_requests").select("\n          id,\n          purchase_order_number,\n          sales_order_number,\n          vendor:vendors(vendor_name)\n        ").or(`purchase_order_number.ilike.%${t}%,sales_order_number.ilike.%${t}%`).order("created_at",{ascending:!1}).limit(20);if(r)throw r;const s=(a||[]).map(e=>({id:e.id,poNumber:e.purchase_order_number||"",soNumber:e.sales_order_number||void 0,vendorName:e.vendor?.vendor_name}));Ve(t=>({...t,[e]:s}))}catch(a){Ve(t=>({...t,[e]:[]}))}finally{Ze(t=>({...t,[e]:!1}))}}},[R]),It=t.useCallback(async(e,t)=>{const{error:a}=await R.from("transaction_statement_items").update({matched_purchase_id:t?.purchase_id??null,matched_item_id:t?.item_id??null}).eq("id",e);a&&c.warn("ë§¤ì¹­ ë³€ê²½ ìžë™ ì €ìž¥ ì‹¤íŒ¨:",a)},[R]),$t=(e,t)=>{et.current=e,W(a=>{const r=new Map(a);return r.set(e,t),r}),It(e,t),Q(t=>{const a=new Set(t);return a.delete(`item-${e}`),a})};t.useEffect(()=>{if(!et.current)return;const e=et.current;T.get(e)},[T]),t.useEffect(()=>{if(!C||0===T.size)return;let e=!1;const t=new Map(T);C.items.forEach(a=>{const r=T.get(a.id);if(!r||null!=r.received_quantity)return;const s=ot?z:B.get(a.id)||(a.extracted_po_number?X(a.extracted_po_number):""),n=s?ht(s):[];if(0===n.length)return;const i=n.find(e=>e.item_id===r.item_id);i&&null!=i.received_quantity&&(t.set(a.id,{...r,received_quantity:i.received_quantity}),e=!0)}),e&&W(t)},[C,T,ot,z,B,ht]);const Et=O||D||"ì•Œìˆ˜ì—†ìŒ",Pt=C?.uploaded_by??s.uploaded_by,Dt=E.includes("app_admin"),Rt=E.includes("lead buyer"),zt=Boolean(P&&Pt&&P===Pt),Ft=Boolean(C?.manager_confirmed_at),Bt=Boolean(C?.quantity_match_confirmed_at),Ut="confirmed"===C?.status,Tt=y||!C||!(Rt||Dt)||Ft||Ut||he,Wt=y||!C||!(zt||Dt)||Bt||Ut,Lt=Ft||Ut?"í™•ì • ì™„ë£Œ":"í™•ì •",At=Bt||Ut?he?"ì™„ë£Œ":"ìˆ˜ëŸ‰ì¼ì¹˜ ì™„ë£Œ":"ìˆ˜ëŸ‰ì¼ì¹˜",Ht=e=>null==e?"-":e.toLocaleString("ko-KR"),Xt=()=>{const e=Array.from(xe.values()).filter(Boolean);if(0===e.length)return"â‚©";const t=Array.from(new Set(e));return 1===t.length?(a=t[0])?"USD"===a?"$":"KRW"===a||"ì›"===a||"â‚©"===a?"â‚©":a:"â‚©":"â‚©";var a},Jt=e=>e?void 0!==e.amount&&null!==e.amount?e.amount:void 0!==e.unit_price&&null!==e.unit_price&&void 0!==e.quantity&&null!==e.quantity?e.unit_price*e.quantity:null:null;t.useEffect(()=>{if(!C)return;const e=Array.from(T.values()).filter(Boolean),t=e.reduce((e,t)=>e+(Jt(t)||0),0),a=e.reduce((e,t)=>e+(t.quantity??0)*(t.unit_price??0),0);fetch("http://127.0.0.1:7244/ingest/d1bfd845-9c34-4c24-9ef7-fd981ce7dd8e",{method:"POST",headers:{"Content-Type":"application/json","X-Debug-Session-Id":"9f46d9"},body:JSON.stringify({sessionId:"9f46d9",runId:"system-total-debug",hypothesisId:"H3",location:"StatementConfirmModal.tsx:itemMatchesEffect:totals",message:"system total calculation snapshot",data:{statementId:s.id,matchedCount:e.length,totalFromUI:t,totalFromUnitPriceQty:a,amountFieldCount:e.filter(e=>null!=e.amount).length,derivedOnlyCount:e.filter(e=>null==e.amount&&null!=e.unit_price&&null!=e.quantity).length,nullAmountAndCannotDeriveCount:e.filter(e=>null==e.amount&&(null==e.unit_price||null==e.quantity)).length,sample:e.slice(0,4).map(e=>({itemId:e.item_id,quantity:e.quantity??null,unitPrice:e.unit_price??null,amount:e.amount??null,resolvedAmount:Jt(e)}))},timestamp:Date.now()})}).catch(()=>{})},[C,T,he,s.id]);const Gt=e=>{if(!e)return"";const t=e.item_name?.trim()||"",a=e.specification?.trim()||"";return a&&a.length>t.length?a:t||(a||`í’ˆëª© #${e.item_id}`)},Qt=(e,t)=>{if(t){const a=t.currentTarget.getBoundingClientRect(),r=(e=>"global-po"===e?320:280)(e),s=8,n=Math.max(s,window.innerWidth-r-s),i=Math.min(Math.max(a.left,s),n);V({top:a.bottom+4,left:i})}Q(t=>{const a=new Set(t);return a.has(e)?a.delete(e):(a.clear(),a.add(e)),a})},Kt=t.useCallback(e=>{const t=e.currentTarget,a=t.scrollTop,r=Math.max(0,t.scrollHeight-t.clientHeight),s=Math.min(r,Math.max(0,a+e.deltaY));e.preventDefault(),e.stopPropagation(),s!==a&&(t.scrollTop=s)},[]);return s?r.jsxs(r.Fragment,{children:[r.jsx(h,{open:e,onOpenChange:l,children:r.jsxs(_,{maxWidth:"max-w-[85vw] sm:max-w-[85vw]",className:"max-h-[90vh] overflow-hidden flex flex-col business-radius-modal","data-debug":$,showCloseButton:!1,onInteractOutside:e=>{A.size>0&&e.preventDefault()},children:[r.jsx(g,{className:"border-b border-gray-100 pb-3 px-4",children:r.jsxs(b,{className:"flex items-center justify-between",children:[r.jsxs("div",{className:"flex items-center gap-2 modal-title",children:[r.jsx(J,{className:"w-4 h-4 text-hansl-600"}),"ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸ ë° í™•ì •"]}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsxs(n,{variant:"outline",size:"sm",onClick:async()=>{if(x)return;const e=C?.image_url||s.image_url;if(e){le(new Map),U(new Map),W(new Map),F(""),ct(null),Xe(!1),st(new Map),Qe({}),Ve({}),Ze({}),Fe(""),Re(!1),Ae(!1),Ne(""),we([]),ke(!1),Oe(null),ue(null),ye(!1),Q(new Set),Ee.current=!1,Pe.current=null,m?.(s.id),l(),N.loading("OCR ìž¬ì¶”ì¶œ ì¤‘... (ì•½ 10~30ì´ˆ ì†Œìš”)",{id:`reextract-${s.id}`});try{const t=await H.extractStatementData(s.id,e,!0);t.success?t.queued?N.info("ìž¬ì¶”ì¶œì´ ëŒ€ê¸°ì—´ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.",{id:`reextract-${s.id}`}):N.success("OCR ìž¬ì¶”ì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",{id:`reextract-${s.id}`}):N.error(t.error||"OCR ìž¬ì¶”ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",{id:`reextract-${s.id}`})}catch(t){N.error("OCR ìž¬ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",{id:`reextract-${s.id}`})}finally{u?.(s.id)}}else N.error("ì´ë¯¸ì§€ URLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")},disabled:x,className:"button-base h-7 text-[10px]",children:[r.jsx(oe,{className:"w-3.5 h-3.5 mr-1"}),"ìž¬ì¶”ì¶œ"]}),r.jsxs(n,{variant:"outline",size:"sm",onClick:()=>{const e=C?.image_url||s.image_url;if(!e)return;const t=Math.max(0,window.screenX+(window.outerWidth-1e3)/2),a=Math.max(0,window.screenY+(window.outerHeight-800)/2);window.open(e,"transaction-statement-image",`width=1000,height=800,left=${t},top=${a}`)},className:"button-base h-7 text-[10px]",children:[r.jsx(L,{className:"w-3.5 h-3.5 mr-1"}),"ì›ë³¸ ë³´ê¸°"]})]})]})}),x?r.jsxs("div",{className:"flex items-center justify-center py-12",children:[r.jsx(Y,{className:"w-6 h-6 animate-spin text-hansl-600"}),r.jsx("span",{className:"ml-3 modal-subtitle",children:"ë¡œë”© ì¤‘..."})]}):C?r.jsxs("div",{className:"flex-1 overflow-hidden flex flex-col py-3 px-4",children:[r.jsxs("div",{className:"flex items-center gap-6 p-3 bg-gray-50 business-radius-card mb-4",children:[r.jsxs("div",{className:"relative",children:[r.jsx("p",{className:"modal-label",children:"ê±°ëž˜ì²˜"}),r.jsxs("div",{className:"relative",children:[r.jsx("input",{type:"text",value:je,onChange:e=>{Ne(e.target.value),(async e=>{if(!e.trim())return we([]),void ke(!1);Se(!0),ke(!0);try{const{data:t,error:a}=await R.from("vendors").select("id, vendor_name").ilike("vendor_name",`%${e}%`).limit(10);if(a)throw a;we((t||[]).map(e=>({id:e.id,name:e.vendor_name})))}catch(t){we([])}finally{Se(!1)}})(e.target.value)},onFocus:()=>{ve.length>0&&ke(!0)},onBlur:()=>{setTimeout(()=>{ke(!1),je.trim()&&R.from("transaction_statements").update({vendor_name:je.trim()}).eq("id",s.id).then(()=>{})},200)},placeholder:"ê±°ëž˜ì²˜ ê²€ìƒ‰...",className:"w-[120px] h-5 px-1.5 bg-white border business-radius focus:outline-none focus:ring-1 focus:ring-hansl-400 "+(Me?"border-green-400 text-green-700":"border-gray-300 text-gray-900"),style:{fontSize:"11px",fontWeight:700}}),Ce&&r.jsx(Y,{className:"absolute right-2 top-1/2 -translate-y-1/2 w-3 h-3 animate-spin text-gray-400"}),qe&&ve.length>0&&r.jsx("div",{className:"absolute top-full left-0 mt-1 w-[200px] bg-white border border-gray-200 rounded-lg shadow-lg z-50 max-h-[180px] overflow-y-auto",children:ve.map(e=>r.jsx("button",{onMouseDown:e=>e.preventDefault(),onClick:()=>{Ne(e.name),ke(!1),St(e.name)},className:"w-full px-2 py-1.5 text-left hover:bg-gray-50 border-b border-gray-100 last:border-b-0",children:r.jsx("div",{className:"text-[10px] font-medium text-gray-900",children:e.name})},e.id))})]})]}),r.jsxs("div",{children:[r.jsx("p",{className:"modal-label",children:"ê±°ëž˜ì¼"}),r.jsx("input",{type:"date",value:tt,onChange:e=>{const t=e.target.value;at(t);const a=dt(t);a&&R.from("transaction_statements").update({statement_date:a}).eq("id",s.id).then(()=>{})},className:"w-[120px] h-5 px-1.5 bg-white border border-gray-300 business-radius-input focus:outline-none focus:ring-1 focus:ring-hansl-400 text-gray-900",style:{fontSize:"11px",fontWeight:600}})]}),r.jsxs("div",{children:[r.jsx("p",{className:"modal-label",children:"í•©ê³„ê¸ˆì•¡"}),r.jsxs("p",{className:"modal-value-large",children:[Ht(C.grand_total??C.total_amount),"ì›"]})]}),r.jsxs("div",{children:[r.jsx("p",{className:"modal-label",children:"í’ˆëª© ìˆ˜"}),r.jsxs("p",{className:"modal-value",children:[C.items.length,"ê±´"]})]})]}),r.jsx("div",{className:"flex-1 overflow-auto border border-gray-200 business-radius-card",children:r.jsxs("table",{className:"modal-value table-auto min-w-full border-collapse",children:[r.jsxs("thead",{className:"bg-gray-100 sticky top-0 z-10",children:[r.jsxs("tr",{className:"border-b border-gray-200",children:[r.jsx("th",{colSpan:he?ot?3:4:ot?4:5,className:"border-r-2 border-gray-300 p-2 text-left w-[45%]",children:r.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[r.jsx("span",{className:"modal-section-title text-gray-700",children:"ì‹œìŠ¤í…œ ë°œì£¼í’ˆëª©"}),ot&&ut.length>0&&r.jsxs("div",{className:"relative flex items-center gap-1",children:[r.jsxs("button",{onClick:e=>Qt("global-po",e),className:"inline-flex items-center gap-1 px-1.5 h-5 text-[10px] font-medium bg-white border border-gray-300 rounded-md hover:bg-gray-50 text-gray-700",children:[(()=>{if(!z)return"ë°œì£¼ë²ˆí˜¸ ì„ íƒ";const e=ut.find(e=>e.poNumber===z||e.salesOrderNumber===z);if(e?.poNumber&&e?.salesOrderNumber)return r.jsxs(r.Fragment,{children:[e.poNumber," ",r.jsxs("span",{className:"text-gray-400",children:["(",e.salesOrderNumber,")"]})]});const t=xt(z);return t?r.jsxs(r.Fragment,{children:[z," ",r.jsxs("span",{className:"text-gray-400",children:["(",t,")"]})]}):z})(),r.jsx(k,{className:"w-3 h-3"})]}),lt&&z&&lt!==z&&r.jsx("span",{className:"text-[9px] text-orange-500",title:"OCR ì¶”ì¶œ ë°œì£¼ë²ˆí˜¸ì™€ ë‹¤ë¥¸ ë°œì£¼ê°€ ë§¤ì¹­ë¨",children:"âš ï¸"}),r.jsx("div",{className:"relative flex items-center",children:De?r.jsxs(r.Fragment,{children:[r.jsx("input",{type:"text",value:ze,onChange:e=>{Fe(e.target.value),(async e=>{if(!e.trim())return Ue([]),void Ae(!1);We(!0),Ae(!0);try{const t=X(e.trim()),{data:a,error:r}=await R.from("purchase_requests").select("\n          id,\n          purchase_order_number,\n          sales_order_number,\n          vendor:vendors(vendor_name)\n        ").or(`purchase_order_number.ilike.%${t}%,sales_order_number.ilike.%${t}%`).order("created_at",{ascending:!1}).limit(10);if(r)throw r;Ue((a||[]).map(e=>({id:e.id,poNumber:e.purchase_order_number||"",soNumber:e.sales_order_number,vendorName:e.vendor?.vendor_name})))}catch(t){Ue([])}finally{We(!1)}})(e.target.value)},onBlur:()=>{Je.current?Je.current=!1:setTimeout(()=>{Re(!1),Ae(!1)},200)},placeholder:"F... ë˜ëŠ” HS...",className:"w-[150px] h-5 px-1.5 bg-white border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-hansl-400",style:{fontSize:"10px",fontWeight:500},autoFocus:!0,onClick:e=>e.stopPropagation()}),Te&&r.jsx(Y,{className:"absolute right-1 w-3 h-3 animate-spin text-gray-400"}),Le&&Be.length>0&&r.jsx("div",{className:"absolute top-full left-0 mt-1 w-[280px] bg-white border border-gray-200 rounded-lg shadow-lg z-50 max-h-[180px] overflow-y-auto",children:Be.map(e=>r.jsxs("div",{className:"w-full px-2 py-1.5 hover:bg-gray-50 border-b border-gray-100 last:border-b-0",children:[r.jsx("button",{onMouseDown:e=>e.preventDefault(),onClick:t=>{t.stopPropagation(),Je.current=!1;const a=ze.trim().toUpperCase();let r;r=a.startsWith("HS")&&e.soNumber?e.soNumber:a.startsWith("F")&&e.poNumber?e.poNumber:e.poNumber||e.soNumber||"",Fe(""),Re(!1),Ae(!1),Xe(!0),vt(r,e.vendorName,e.soNumber),N.success(`${r} ë°œì£¼ê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤`)},className:"w-full text-left",children:r.jsxs("div",{className:"flex items-center justify-between gap-2",children:[r.jsxs("div",{className:"text-[10px] font-medium text-gray-900",children:[e.poNumber,e.soNumber&&r.jsxs("span",{className:"text-gray-400 ml-1",children:["(",e.soNumber,")"]})]}),r.jsx("button",{type:"button",onMouseDown:e=>{Je.current=!0,e.preventDefault()},onClick:t=>{t.stopPropagation(),Mt(e.id)},className:"text-[9px] font-medium text-blue-600 hover:text-blue-800",children:"ìƒì„¸"})]})}),e.vendorName&&r.jsx("div",{className:"text-[9px] text-gray-500",children:e.vendorName})]},e.id))})]}):r.jsx("button",{onClick:e=>{e.stopPropagation(),Re(!0)},className:"inline-flex items-center gap-0.5 px-1 h-5 text-[9px] font-medium text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded",title:"ë°œì£¼/ìˆ˜ì£¼ë²ˆí˜¸ ì§ì ‘ ê²€ìƒ‰",children:r.jsx(te,{className:"w-3 h-3"})})}),z&&(()=>{const e=ut.find(e=>e.poNumber===z||e.salesOrderNumber===z),t=e?.purchaseId||e?.items[0]?.purchase_id;return t?r.jsx("button",{onClick:e=>{e.stopPropagation(),Mt(t)},className:"inline-flex items-center gap-0.5 px-1 h-5 text-[9px] font-medium text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded",title:"ë°œì£¼ ìƒì„¸ ë³´ê¸°",children:r.jsx(ie,{className:"w-3 h-3"})}):null})()]})]})}),r.jsx("th",{className:"border-r-2 border-gray-300 p-2 text-center bg-blue-50/30 w-[10%]"}),r.jsx("th",{colSpan:he?ot?3:4:ot?4:5,className:"p-2 text-left w-[45%]",children:r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("span",{className:"modal-section-title text-gray-700",children:"OCR ì¶”ì¶œ í’ˆëª©"}),ot&&lt&&r.jsxs("div",{className:"flex items-center gap-1",children:[r.jsx("input",{type:"text",value:(()=>{const e=C?.items[0];return e?yt(e,"po_number"):lt})(),onChange:e=>Ct(e.target.value),className:"px-1.5 h-5 bg-white border border-gray-300 text-gray-700 text-[10px] font-medium business-radius focus:outline-none focus:ring-1 focus:ring-gray-400",style:{fontSize:"11px",fontWeight:500},title:"OCR ì¶”ì¶œ ë°œì£¼ë²ˆí˜¸ (ìˆ˜ì • ê°€ëŠ¥)"}),(()=>{const e=C?.items[0],t=e?yt(e,"po_number"):lt,a=pt(t);return a?r.jsx("span",{className:"text-gray-400 text-[10px] font-normal",style:{fontSize:"11px"},children:a}):null})()]}),ot&&!lt&&r.jsxs("div",{className:"flex items-center gap-1",children:[r.jsx("input",{type:"text",placeholder:"ë°œì£¼/ìˆ˜ì£¼ë²ˆí˜¸ ìž…ë ¥",onChange:e=>Ct(e.target.value),className:"px-1.5 h-5 bg-white border border-gray-300 text-gray-700 text-[10px] font-medium business-radius focus:outline-none focus:ring-1 focus:ring-gray-400",style:{fontSize:"11px",fontWeight:500},title:"ë°œì£¼ë²ˆí˜¸ ì§ì ‘ ìž…ë ¥"}),(()=>{const e=C?.items[0],t=e?yt(e,"po_number"):"",a=pt(t);return a?r.jsx("span",{className:"text-gray-400 text-[10px] font-normal",style:{fontSize:"11px"},children:a}):null})()]})]})})]}),r.jsxs("tr",{className:"modal-label",children:[!ot&&r.jsx("th",{className:"p-1 text-left whitespace-nowrap modal-label",children:"ë°œì£¼/ìˆ˜ì£¼ë²ˆí˜¸"}),r.jsx("th",{className:"p-1 text-left modal-label",children:"í’ˆëª©ëª…"}),r.jsx("th",{className:"p-1 text-right modal-label",children:"ìˆ˜ëŸ‰"}),!he&&r.jsxs(r.Fragment,{children:[r.jsx("th",{className:"p-1 text-right modal-label",children:"ë‹¨ê°€"}),r.jsx("th",{className:"border-r-2 border-gray-300 p-1 text-right modal-label",children:"í•©ê³„"})]}),he&&r.jsx("th",{className:"border-r-2 border-gray-300 p-1"}),r.jsx("th",{className:"border-r-2 border-gray-300 p-1 text-center bg-blue-50/30",children:r.jsx("span",{className:"text-gray-400 text-sm",children:"â‡„"})}),r.jsx("th",{className:"p-1 text-left whitespace-nowrap modal-label",children:"í’ˆëª©ëª…"}),r.jsx("th",{className:"p-1 text-right whitespace-nowrap w-16 modal-label",children:"ìˆ˜ëŸ‰"}),!he&&r.jsxs(r.Fragment,{children:[r.jsx("th",{className:"p-1 text-right whitespace-nowrap w-20 modal-label",children:"ë‹¨ê°€"}),r.jsx("th",{className:"p-1 text-right whitespace-nowrap w-24 modal-label",children:"í•©ê³„"})]}),he&&r.jsx("th",{className:"p-1"}),!ot&&r.jsx("th",{className:"p-1 text-left whitespace-nowrap modal-label",children:"ë°œì£¼/ìˆ˜ì£¼ë²ˆí˜¸"})]})]}),r.jsxs("tbody",{children:[C.items.map((e,t)=>{const a=T.get(e.id);(e=>{let t=T.get(e.id)||null;if(!t){const a=ot?z:B.get(e.id)||(e.extracted_po_number?X(e.extracted_po_number):"");if(a){const r=ht(a);r.length;let s=0;r.forEach(a=>{const r=be(e.extracted_item_name||"",a.item_name,a.specification);r>s&&(s=r,t=a)})}}if(!t)return"unmatched";const a=be(e.extracted_item_name||"",t.item_name||"",t.specification)})(e);const s=e.extracted_po_number?X(e.extracted_po_number):void 0,n=_t(e.id),i=n.map(e=>X(e)),c=new Set(i),l=B.get(e.id),d=l?X(l):"",m=s&&c.has(s)?s:"",u=d&&c.has(d)?d:m||d||"",x=a?.purchase_order_number||a?.sales_order_number||"",p=Array.from(new Set(n)),h=x&&!p.includes(x)?[x,...p]:x?[x,...p.filter(e=>e!==x)]:p,_=C.items[t+1],g=_?(e=>{const t=e.extracted_po_number?X(e.extracted_po_number):void 0,a=_t(e.id),r=new Set(a.map(e=>X(e))),s=B.get(e.id),n=s?X(s):"",i=t&&r.has(t)?t:"";return n&&r.has(n)?n:i||(n||"")})(_):"",b=t<C.items.length-1&&u!==g?"hover:bg-gray-50 border-b-2 border-gray-500":"hover:bg-gray-50",f=Ge[e.id]||"",y=Ke[e.id]||[],j=Ye[e.id]||!1,N=ot?z:u||"",v=ht(N),w=0===v.length&&N?(e.match_candidates||[]).filter(e=>e.purchase_order_number===N||e.sales_order_number===N).map(e=>({purchase_id:e.purchase_id,item_id:e.item_id,purchase_order_number:e.purchase_order_number||"",sales_order_number:e.sales_order_number,item_name:e.item_name||"í’ˆëª©ëª… ì—†ìŒ",specification:e.specification,quantity:e.quantity,received_quantity:e.received_quantity,unit_price:e.unit_price,amount:e.amount,vendor_name:e.vendor_name})):[];let S=v.length>0?v:w;0===S.length&&a&&(S=[a]);const q=S.map(t=>({candidate:t,score:be(e.extracted_item_name||"",t.item_name,t.specification)})).sort((e,t)=>t.score-e.score);if(0===t){const t=`${e.id}|${ot?"same":"multi"}|${N}|${v.length}`;Pe.current!==t&&(Pe.current=t,v[0])}const M=z?X(z):"",O=z?xt(z):void 0,I=O?X(O):"",$=C.items.length,E=C.items.map(e=>yt(e,"po_number")).filter(Boolean).map(e=>X(e)),P=!!M&&E.some(e=>e===M||I&&e===I),D=0===t;return r.jsxs("tr",{className:b,children:[!ot&&r.jsx("td",{className:"p-1 whitespace-nowrap",children:r.jsxs("div",{className:"relative",children:[r.jsxs("button",{onClick:t=>Qt(`po-${e.id}`,t),className:"inline-flex items-center gap-1 px-1.5 h-5 text-[10px] font-medium bg-white border border-gray-300 business-radius hover:bg-gray-50 text-gray-700 whitespace-nowrap",style:{fontSize:"11px"},children:[r.jsx("span",{children:u||"ì„ íƒ"}),r.jsx(k,{className:"w-3 h-3 flex-shrink-0"})]}),A.has(`po-${e.id}`)&&o.createPortal(r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"fixed inset-0 z-[110]",onClick:()=>Qt(`po-${e.id}`)}),r.jsxs("div",{className:"fixed z-[111] bg-white border border-gray-200 rounded-lg shadow-xl w-[280px] max-h-[360px] overflow-y-auto",style:{top:K.top,left:K.left},onClick:e=>e.stopPropagation(),children:[r.jsx("div",{className:"p-2 border-b border-gray-100",children:r.jsxs("div",{className:"relative",children:[r.jsx("input",{type:"text",value:f,onChange:t=>Ot(e.id,t.target.value),placeholder:"ë°œì£¼/ìˆ˜ì£¼ë²ˆí˜¸ ê²€ìƒ‰...",className:"w-full h-6 px-2 pr-6 text-[10px] bg-white border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-hansl-400"}),j&&r.jsx(Y,{className:"absolute right-2 top-1/2 -translate-y-1/2 w-3 h-3 animate-spin text-gray-400"})]})}),f&&y.length>0&&r.jsx("div",{className:"border-b border-gray-100",children:y.map(t=>{const a=f.trim().toUpperCase();let s;return s=a.startsWith("HS")&&t.soNumber?t.soNumber:a.startsWith("F")&&t.poNumber?t.poNumber:t.poNumber||t.soNumber||"",r.jsxs("div",{className:"px-2 py-1.5 hover:bg-gray-50 cursor-pointer text-[11px]",onClick:()=>qt(e.id,s),children:[r.jsxs("div",{className:"flex items-center justify-between gap-2",children:[r.jsxs("div",{className:"font-medium text-gray-900",children:[t.poNumber,t.soNumber&&r.jsxs("span",{className:"text-gray-400 ml-1",children:["(",t.soNumber,")"]})]}),r.jsx("button",{type:"button",onMouseDown:e=>e.preventDefault(),onClick:e=>{e.stopPropagation(),Mt(t.id)},className:"text-[9px] font-medium text-blue-600 hover:text-blue-800",children:"ìƒì„¸"})]}),t.vendorName&&r.jsx("div",{className:"text-[9px] text-gray-500",children:t.vendorName})]},t.id)})}),h.length>0&&r.jsx("div",{children:h.map((t,a)=>{const s=xt(t),n=kt(t),i=t===u,c=t===x;return r.jsx("div",{onClick:()=>qt(e.id,t),className:"px-2 py-1.5 hover:bg-gray-100 cursor-pointer text-[11px] font-medium "+(i?"bg-blue-50 text-blue-900 font-semibold":c?"bg-green-50 text-green-900":"text-gray-700"),style:{fontSize:"11px"},children:r.jsxs("div",{className:"flex items-center justify-between gap-2",children:[r.jsxs("div",{children:[t,s&&r.jsxs("span",{className:"text-gray-400 ml-1",children:["(",s,")"]}),c&&r.jsx("span",{className:"text-green-600 ml-1 text-[9px] font-bold",children:"ì¶”ì²œ"})]}),n&&r.jsx("button",{type:"button",onMouseDown:e=>e.preventDefault(),onClick:e=>{e.stopPropagation(),Mt(n)},className:"text-[9px] font-medium text-blue-600 hover:text-blue-800",children:"ìƒì„¸"})]})},`${t}-${a}`)})})]})]}),document.body)]})}),r.jsx("td",{className:"p-1",children:S.length>0?r.jsxs("div",{className:"relative",children:[r.jsxs("div",{className:"flex items-center gap-1",children:[r.jsxs("button",{onClick:t=>{Qt(`item-${e.id}`,t)},className:"inline-flex items-center gap-1 px-1.5 h-5 text-[10px] font-normal bg-white border border-gray-300 business-radius hover:bg-gray-50 text-gray-700 whitespace-nowrap",style:{fontSize:"11px"},children:[r.jsx("span",{children:Gt(a)||"ì„ íƒ"}),r.jsx(k,{className:"w-3 h-3 flex-shrink-0"})]}),a&&r.jsx("button",{onClick:()=>$t(e.id,null),className:"text-gray-400 hover:text-red-500 flex-shrink-0",title:"ë§¤ì¹­ í•´ì œ",children:r.jsx(ne,{className:"w-3 h-3"})})]}),A.has(`item-${e.id}`)&&o.createPortal(r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"fixed inset-0 z-[110]",onClick:()=>Qt(`item-${e.id}`)}),r.jsx("div",{className:"fixed z-[111] bg-white border border-gray-200 rounded-lg shadow-xl w-[280px] max-h-[360px] overflow-y-auto",style:{top:K.top,left:K.left},onClick:e=>e.stopPropagation(),children:q.map(({candidate:t,score:a},s)=>r.jsxs("div",{onClick:()=>{$t(e.id,t)},className:"px-2 py-1.5 hover:bg-gray-100 cursor-pointer",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("p",{className:"text-[11px] font-normal text-gray-900",style:{fontSize:"11px"},children:Gt(t)}),r.jsxs("span",{className:"text-[10px] px-1.5 py-0.5 rounded "+(a>=80?"bg-green-100 text-green-700":a>=50?"bg-yellow-100 text-yellow-700":"bg-gray-100 text-gray-600"),children:[Math.round(a),"%"]})]}),r.jsxs("p",{className:"text-[10px] text-gray-500",children:["ìš”ì²­/ì‹¤ì œ: ",t.quantity??"-"," / ",t.received_quantity??"-"]})]},s))})]}),document.body)]}):r.jsx("span",{className:"text-[11px] text-gray-400",style:{fontSize:"11px"},children:"í›„ë³´ ì—†ìŒ"})}),r.jsx("td",{className:"p-1 text-right",children:r.jsxs("span",{className:"text-[11px] text-gray-700",style:{fontSize:"11px"},children:[a?.quantity??"-"," / ",a?.received_quantity??"-"]})}),!he&&r.jsxs(r.Fragment,{children:[r.jsx("td",{className:"p-1 text-right",children:r.jsx("span",{className:"text-[11px] text-gray-700",style:{fontSize:"11px"},children:a?Ht(a.unit_price):"-"})}),r.jsx("td",{className:"border-r-2 border-gray-300 p-1 text-right",children:r.jsx("span",{className:"text-[11px] font-bold text-gray-900",style:{fontSize:"11px",fontWeight:700},children:a?Ht(Jt(a)??void 0):"-"})})]}),he&&r.jsx("td",{className:"border-r-2 border-gray-300 p-1"}),D&&r.jsx("td",{className:"border-r-2 border-gray-300 px-2 py-1 text-center bg-blue-50/30 cursor-pointer hover:bg-blue-100/50 transition-colors",rowSpan:$,style:{verticalAlign:"middle"},onClick:()=>ye(!0),title:"í´ë¦­í•˜ì—¬ ìƒì„¸ ë‚´ì—­ ë³´ê¸°",children:r.jsxs("div",{className:"flex flex-col items-center justify-center",children:[r.jsx("span",{className:"text-[11px] font-bold "+(P?"text-green-600":"text-gray-500"),children:P?"ë°œì£¼/ìˆ˜ì£¼ ë²ˆí˜¸ ì¼ì¹˜":"ë°œì£¼/ìˆ˜ì£¼ ë²ˆí˜¸ ë¶ˆì¼ì¹˜"}),r.jsx("span",{className:"text-[8px] text-blue-500 underline mt-0.5",children:"ìƒì„¸ë³´ê¸°"})]})}),r.jsx("td",{className:"p-1 whitespace-nowrap",children:r.jsx("input",{type:"text",value:yt(e,"item_name"),onChange:t=>bt(e.id,"item_name",t.target.value),className:"min-w-[180px] w-auto px-1 h-5 !text-[10px] !font-medium text-gray-900 border business-radius focus:outline-none focus:ring-1 focus:ring-blue-400 "+(jt(e,"item_name")?"border-orange-400 bg-orange-50":"border-gray-200 bg-white"),style:{fontSize:"11px",fontWeight:500,width:`${Math.max(180,8*yt(e,"item_name").length)}px`},title:jt(e,"item_name")?`ì›ë³¸: ${e.extracted_item_name}`:void 0})}),r.jsx("td",{className:"p-1 text-right w-16",children:r.jsx("input",{type:"number",value:yt(e,"quantity"),onChange:t=>bt(e.id,"quantity",t.target.value?Number(t.target.value):0),className:"w-14 px-1 h-5 !text-[10px] !font-medium text-gray-900 text-right border business-radius focus:outline-none focus:ring-1 focus:ring-blue-400 "+(jt(e,"quantity")?"border-orange-400 bg-orange-50":"border-gray-200 bg-white"),style:{fontSize:"11px",fontWeight:500},title:jt(e,"quantity")?`ì›ë³¸: ${e.extracted_quantity}`:void 0})}),!he&&r.jsxs(r.Fragment,{children:[r.jsx("td",{className:"p-1 text-right w-20",children:r.jsx("input",{type:"number",value:yt(e,"unit_price"),onChange:t=>bt(e.id,"unit_price",t.target.value?Number(t.target.value):0),className:"w-16 px-1 h-5 !text-[10px] !font-medium text-gray-900 text-right border business-radius focus:outline-none focus:ring-1 focus:ring-blue-400 "+(jt(e,"unit_price")?"border-orange-400 bg-orange-50":"border-gray-200 bg-white"),style:{fontSize:"11px",fontWeight:500},title:jt(e,"unit_price")?`ì›ë³¸: ${e.extracted_unit_price}`:void 0})}),r.jsx("td",{className:"p-1 text-right w-24",children:r.jsx("input",{type:"number",value:yt(e,"amount"),onChange:t=>bt(e.id,"amount",t.target.value?Number(t.target.value):0),className:"w-20 px-1 h-5 !text-[10px] !font-bold text-gray-900 text-right border business-radius focus:outline-none focus:ring-1 focus:ring-blue-400 "+(jt(e,"amount")?"border-orange-400 bg-orange-50":"border-gray-200 bg-white"),style:{fontSize:"11px",fontWeight:700},title:jt(e,"amount")?`ì›ë³¸: ${e.extracted_amount}`:void 0})})]}),he&&r.jsx("td",{className:"p-1"}),!ot&&r.jsx("td",{className:"p-1 whitespace-nowrap",children:r.jsxs("div",{className:"flex items-center gap-1",children:[r.jsx("input",{type:"text",value:yt(e,"po_number"),onChange:t=>{const a=t.target.value;wt(a),bt(e.id,"po_number",a)},className:"px-1.5 h-5 text-[10px] font-medium bg-white border business-radius focus:outline-none focus:ring-1 focus:ring-gray-400 text-gray-700 "+(jt(e,"po_number")?"border-orange-400 bg-orange-50":"border-gray-300"),style:{fontSize:"11px",fontWeight:500},title:jt(e,"po_number")?`ì›ë³¸: ${e.extracted_po_number}`:void 0}),(()=>{const t=yt(e,"po_number"),a=pt(t);return a?r.jsx("span",{className:"text-gray-400 text-[10px] font-normal",style:{fontSize:"11px"},children:a}):null})()]})})]},e.id)}),!he&&r.jsxs("tr",{className:"bg-gray-50 font-medium border-t border-gray-100",children:[r.jsx("td",{colSpan:ot?3:4,className:"p-1 text-right text-gray-600",children:"ì‹œìŠ¤í…œ í•©ê³„"}),r.jsx("td",{className:"border-r-2 border-gray-300 p-1 text-right text-gray-900",children:`${Xt()}${Ht(Array.from(T.values()).filter(Boolean).reduce((e,t)=>e+(Jt(t)||0),0))}`}),r.jsx("td",{className:"border-r-2 border-gray-300 p-1 bg-blue-50/50"}),r.jsxs("td",{colSpan:ot?3:4,className:"p-1 text-right text-gray-600",children:["OCR í•©ê³„",ce.size>0&&r.jsx("span",{className:"ml-1 text-[9px] text-orange-600",children:"(ìˆ˜ì •ë¨)"})]}),r.jsx("td",{className:"p-1 text-right text-gray-900",children:`${Xt()}${Ht(C.items.reduce((e,t)=>{const a=ce.get(t.id);return e+(void 0!==a?.amount?a.amount:t.extracted_amount||0)},0))}`}),!ot&&r.jsx("td",{className:"p-1"})]})]})]})})]}):r.jsx("div",{className:"text-center py-12",children:r.jsx("p",{className:"modal-subtitle",children:"ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."})}),r.jsxs(f,{className:"border-t border-gray-100 pt-3 px-4 gap-2",children:[r.jsxs(n,{variant:"outline",onClick:async()=>{if(confirm("ì´ ê±°ëž˜ëª…ì„¸ì„œë¥¼ ê±°ë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"))try{j(!0),w("reject");const e=await H.rejectStatement(s.id);e.success?(N.success("ê±°ëž˜ëª…ì„¸ì„œê°€ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤."),l()):N.error(e.error||"ê±°ë¶€ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}catch(e){N.error("ê±°ë¶€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}finally{j(!1),w(null)}},disabled:y,className:"button-base h-8 text-[11px] text-red-500 border-red-200 hover:bg-red-50",children:[r.jsx(ne,{className:"w-3.5 h-3.5 mr-1"}),"ê±°ë¶€"]}),r.jsx(n,{variant:"outline",onClick:l,disabled:y,className:"button-base h-8 text-[11px]",children:"ë‹«ê¸°"}),r.jsx(n,{onClick:async()=>{if(C)try{j(!0),w("quantity-match"),await Nt(),await ft();const e=C.items.map(e=>{const t=T.get(e.id),a=ce.get(e.id),r=void 0!==a?.quantity?a.quantity:e.extracted_quantity;return{itemId:e.id,matched_purchase_id:t?.purchase_id,matched_item_id:t?.item_id,confirmed_quantity:r}}),t=await H.confirmQuantityMatch({statementId:s.id,items:e,actual_received_date:C.extracted_data?.actual_received_date},Et);t.success?(t.updatedStatement&&S(e=>e?{...e,...t.updatedStatement}:e),t.finalized?N.success("ê±°ëž˜ëª…ì„¸ì„œê°€ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤."):N.success("ìˆ˜ëŸ‰ì¼ì¹˜ í™•ì¸ ì™„ë£Œ (í™•ì • ëŒ€ê¸°)"),d()):N.error(t.error||"ìˆ˜ëŸ‰ì¼ì¹˜ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}catch(e){N.error("ìˆ˜ëŸ‰ì¼ì¹˜ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}finally{j(!1),w(null)}},disabled:Wt,className:"button-base h-8 text-[11px] "+(Wt?"border border-gray-300 bg-white text-gray-400":"bg-hansl-600 hover:bg-hansl-700 text-white"),children:"quantity-match"===v?r.jsxs(r.Fragment,{children:[r.jsx(Y,{className:"w-3.5 h-3.5 mr-1 animate-spin"}),"ì²˜ë¦¬ ì¤‘..."]}):r.jsxs(r.Fragment,{children:[r.jsx(J,{className:"w-3.5 h-3.5 mr-1"}),At]})}),!he&&r.jsx(n,{onClick:async()=>{if(C)try{j(!0),w("confirm"),await Nt(),await ft();const e=dt(C.statement_date),t=dt(tt);if(t!==e){const{error:e}=await R.from("transaction_statements").update({statement_date:t||null}).eq("id",s.id);if(e)throw new Error(e.message)}const a=C.items.map(e=>{const t=T.get(e.id),a=ce.get(e.id),r=void 0!==a?.quantity?a.quantity:e.extracted_quantity,s=void 0!==a?.unit_price?a.unit_price:e.extracted_unit_price,n=void 0!==a?.amount?a.amount:e.extracted_amount;return{itemId:e.id,matched_purchase_id:t?.purchase_id,matched_item_id:t?.item_id,confirmed_quantity:r,confirmed_unit_price:s,confirmed_amount:n}}),r=await H.confirmStatement({statementId:s.id,items:a,actual_received_date:C.extracted_data?.actual_received_date,accounting_received_date:dt(tt)},Et);r.success?(r.updatedStatement&&S(e=>e?{...e,...r.updatedStatement}:e),r.finalized?N.success("ê±°ëž˜ëª…ì„¸ì„œê°€ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤."):N.success("í™•ì • ì²˜ë¦¬ ì™„ë£Œ (ìˆ˜ëŸ‰ì¼ì¹˜ ëŒ€ê¸°)"),d()):N.error(r.error||"í™•ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}catch(e){N.error("í™•ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}finally{j(!1),w(null)}},disabled:Tt,className:"button-base h-8 text-[11px] "+(Tt?"border border-gray-300 bg-white text-gray-400":"bg-hansl-600 hover:bg-hansl-700 text-white"),children:"confirm"===v?r.jsxs(r.Fragment,{children:[r.jsx(Y,{className:"w-3.5 h-3.5 mr-1 animate-spin"}),"ì²˜ë¦¬ ì¤‘..."]}):r.jsxs(r.Fragment,{children:[r.jsx(J,{className:"w-3.5 h-3.5 mr-1"}),Lt]})})]})]})}),me&&r.jsx(h,{open:me.isOpen,onOpenChange:()=>ue(null),children:r.jsxs(_,{className:"max-w-md",children:[r.jsx(g,{children:r.jsx(b,{className:"text-[14px] font-semibold text-gray-800",children:"ë§¤ì¹­ ìƒì„¸ ì •ë³´"})}),r.jsxs("div",{className:"space-y-4 py-2",children:[r.jsxs("div",{className:"flex items-center justify-center",children:[(e=>{const t=void 0;switch(e){case"high":return r.jsxs("span",{className:"badge-stats bg-green-500 text-white ",onClick:t,title:"í´ë¦­í•˜ì—¬ ìƒì„¸ ë³´ê¸°",children:[r.jsx(ae,{className:"w-3 h-3"}),"ë†’ìŒ"]});case"med":return r.jsx("span",{className:"badge-stats bg-yellow-500 text-white ",onClick:t,title:"í´ë¦­í•˜ì—¬ ìƒì„¸ ë³´ê¸°",children:"ë³´í†µ"});case"low":return r.jsx("span",{className:"badge-stats bg-orange-500 text-white ",onClick:t,title:"í´ë¦­í•˜ì—¬ ìƒì„¸ ë³´ê¸°",children:"ë‚®ìŒ"});case"unmatched":return r.jsx("span",{className:"badge-stats bg-gray-500 text-white ",onClick:t,title:"í´ë¦­í•˜ì—¬ ìƒì„¸ ë³´ê¸°",children:"ë¯¸ë§¤ì¹­"})}})(me.status),r.jsxs("span",{className:"ml-2 text-[12px] text-gray-600",children:["ìœ ì‚¬ë„: ",me.similarity.toFixed(1),"%"]})]}),r.jsxs("div",{className:"bg-gray-50 rounded-lg p-3 space-y-2",children:[r.jsxs("div",{className:"flex items-start gap-2",children:[r.jsx("span",{className:"text-[11px] font-medium text-gray-500 w-20 shrink-0",children:"OCR í’ˆëª©:"}),r.jsx("span",{className:"text-[11px] text-gray-800 break-all",children:me.ocrItemName})]}),r.jsxs("div",{className:"flex items-start gap-2",children:[r.jsx("span",{className:"text-[11px] font-medium text-gray-500 w-20 shrink-0",children:"ì‹œìŠ¤í…œ í’ˆëª©:"}),r.jsx("span",{className:"text-[11px] text-gray-800 break-all",children:me.systemItemName})]}),me.systemSpec&&"-"!==me.systemSpec&&r.jsxs("div",{className:"flex items-start gap-2",children:[r.jsx("span",{className:"text-[11px] font-medium text-gray-500 w-20 shrink-0",children:"ì‹œìŠ¤í…œ ê·œê²©:"}),r.jsx("span",{className:"text-[11px] text-gray-800 break-all",children:me.systemSpec})]})]}),r.jsxs("div",{className:"space-y-1",children:[r.jsx("span",{className:"text-[11px] font-medium text-gray-600",children:"ë§¤ì¹­ íŒì • ì´ìœ :"}),r.jsx("ul",{className:"space-y-1",children:me.reasons.map((e,t)=>r.jsx("li",{className:"text-[11px] text-gray-700 pl-2",children:e},t))})]})]}),r.jsx(f,{children:r.jsx(n,{variant:"outline",size:"sm",onClick:()=>ue(null),className:"text-[11px]",children:"ë‹«ê¸°"})})]})}),r.jsx(h,{open:ge,onOpenChange:ye,children:r.jsxs(_,{className:"max-w-lg",children:[r.jsx(g,{children:r.jsx(b,{className:"text-[14px] font-semibold text-gray-800",children:"ë§¤ì¹­ ìƒì„¸ ë‚´ì—­"})}),r.jsx("div",{className:"space-y-4 py-2",children:(()=>{const e=ut.find(e=>e.poNumber===z||e.salesOrderNumber===z),t=Math.min(100,e?.displayScore??e?.setMatchScore??0),a=e?.matchedItemCount??0,s=C?.items.length??0,n=z?X(z):"",i=z?xt(z):void 0,c=i?X(i):"",o=(C?.items??[]).map(e=>yt(e,"po_number")).filter(Boolean).map(e=>X(e)),l=!!n&&o.some(e=>e===n||c&&e===c),d=(C?.items??[]).filter(e=>{const t=T.get(e.id);if(!t)return!1;return be(yt(e,"item_name")||"",t.item_name,t.specification)>=40}).length,m=(C?.items??[]).filter(e=>{const t=T.get(e.id);if(!t)return!1;const a=yt(e,"quantity");return fe("number"==typeof a?a:""!==a?Number(a):void 0,t.quantity)}).length,u=s>0&&d===s,x=s>0&&m===s;return r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"flex items-center justify-center gap-3 p-4 bg-gray-50 rounded-lg",children:[r.jsxs("span",{className:"text-3xl font-bold "+(t>=80?"text-green-600":t>=50?"text-yellow-600":"text-gray-500"),children:[t,"%"]}),r.jsxs("div",{className:"text-left",children:[r.jsxs("p",{className:"text-[12px] font-medium text-gray-700",children:["ë°œì£¼ë²ˆí˜¸: ",z||"ë¯¸ì„ íƒ"]}),r.jsxs("p",{className:"text-[11px] text-gray-500",children:[a,"/",s,"ê°œ í’ˆëª© ë§¤ì¹­ë¨"]})]})]}),r.jsxs("div",{className:"grid grid-cols-1 gap-2 rounded-lg border border-gray-200 p-3",children:[r.jsxs("div",{className:"flex items-center justify-between text-[11px]",children:[r.jsx("span",{className:"text-gray-600",children:"ë°œì£¼/ìˆ˜ì£¼ë²ˆí˜¸ ë§¤ì¹­"}),r.jsx("span",{className:"font-medium "+(l?"text-green-600":"text-red-600"),children:l?"âœ… ì¼ì¹˜":"âŒ ë¶ˆì¼ì¹˜"})]}),r.jsxs("div",{className:"flex items-center justify-between text-[11px]",children:[r.jsx("span",{className:"text-gray-600",children:"í’ˆëª©ëª… ë§¤ì¹­"}),r.jsx("span",{className:"font-medium "+(u?"text-green-600":"text-red-600"),children:u?`âœ… ëª¨ë‘ ì¼ì¹˜ (${d}/${s})`:`âŒ ë¶ˆì¼ì¹˜ (${d}/${s})`})]}),r.jsxs("div",{className:"flex items-center justify-between text-[11px]",children:[r.jsx("span",{className:"text-gray-600",children:"ìˆ˜ëŸ‰ ë§¤ì¹­"}),r.jsx("span",{className:"font-medium "+(x?"text-green-600":"text-red-600"),children:x?`âœ… ëª¨ë‘ ì¼ì¹˜ (${m}/${s})`:`âŒ ë¶ˆì¼ì¹˜ (${m}/${s})`})]})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("p",{className:"text-[11px] font-semibold text-gray-600",children:"í’ˆëª©ë³„ ë§¤ì¹­ ìƒì„¸:"}),r.jsx("div",{className:"max-h-[250px] overflow-y-auto space-y-2",children:C?.items.map(e=>{const t=T.get(e.id),a=t?be(yt(e,"item_name")||"",t.item_name,t.specification):0,s=a>=40,n=yt(e,"quantity"),i="number"==typeof n?n:""!==n?Number(n):void 0,c=t?.quantity,o=fe(i,c),l=(m=c,null==(d=i)||null==m?"mismatch":d===m?"exact":d<=m?"partial":"mismatch");var d,m;return r.jsxs("div",{className:"p-2 rounded-lg border "+(s&&o?"bg-green-50 border-green-200":s?"bg-yellow-50 border-yellow-200":"bg-gray-50 border-gray-200"),children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{className:"flex-1 min-w-0",children:[r.jsx("p",{className:"text-[11px] font-medium text-gray-800 truncate",children:e.extracted_item_name||"-"}),r.jsxs("p",{className:"text-[10px] text-gray-500",children:["â†’ ",t?.item_name||"ë¯¸ë§¤ì¹­"]})]}),r.jsx("span",{className:"text-[10px] px-2 py-0.5 rounded font-medium ml-2 "+(a>=85?"bg-green-100 text-green-700":a>=60?"bg-yellow-100 text-yellow-700":a>=40?"bg-orange-100 text-orange-700":"bg-red-100 text-red-600"),children:s?`${Math.round(a)}%`:"ë¯¸ë§¤ì¹­"})]}),s&&r.jsxs("div",{className:"flex items-center gap-2 mt-1.5 pt-1.5 border-t border-gray-100",children:[r.jsx("span",{className:"text-[10px] text-gray-500",children:"ìˆ˜ëŸ‰:"}),r.jsxs("span",{className:"text-[10px] font-medium text-gray-700",children:["OCR ",i??"-","ê°œ"]}),r.jsx("span",{className:"text-[10px] text-gray-400",children:"vs"}),r.jsxs("span",{className:"text-[10px] font-medium text-gray-700",children:["ì‹œìŠ¤í…œ ",c??"-","ê°œ"]}),r.jsx("span",{className:"text-[9px] px-1.5 py-0.5 rounded "+(o?"bg-green-100 text-green-700":"partial"===l?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"),children:o?"âœ… ì¼ì¹˜":"partial"===l?"âš ï¸ ë¶€ë¶„ìž…ê³ ":"âŒ ë¶ˆì¼ì¹˜"})]})]},e.id)})})]})]})})()}),r.jsx(f,{children:r.jsx(n,{variant:"outline",size:"sm",onClick:()=>ye(!1),className:"text-[11px]",children:"ë‹«ê¸°"})})]})}),r.jsx(_e,{isOpen:q,imageUrl:s.image_url,onClose:()=>M(!1)}),A.has("global-po")&&o.createPortal(r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"fixed inset-0 z-[100]",style:{pointerEvents:"auto"},onClick:()=>Qt("global-po")}),r.jsxs("div",{className:"fixed z-[101] bg-white border border-gray-200 rounded-lg shadow-xl min-w-[280px] max-h-[350px] overflow-y-auto",style:{top:K.top,left:K.left,pointerEvents:"auto"},onClick:e=>e.stopPropagation(),onWheel:Kt,children:[r.jsx("div",{className:"sticky top-0 bg-gray-50 px-3 py-2 border-b border-gray-100 rounded-t-lg",children:r.jsx("span",{className:"text-[10px] font-semibold text-gray-600",children:"ë°œì£¼ë²ˆí˜¸ ì„ íƒ"})}),ut.map((e,t)=>{const a=e.poNumber||e.salesOrderNumber||"",s=z===a,n=it?.bestMatch?.purchase_order_number===e.poNumber||it?.bestMatch?.sales_order_number===e.salesOrderNumber;return r.jsxs("div",{onClick:e=>{e.stopPropagation(),vt(a),Qt("global-po")},className:`p-2.5 cursor-pointer border-b border-gray-50 last:border-0 transition-colors ${s?"bg-blue-50":"hover:bg-gray-50"} ${n?"ring-1 ring-inset ring-green-400":""}`,children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("p",{className:"text-[12px] font-medium text-gray-900",children:[e.poNumber||e.salesOrderNumber,e.poNumber&&e.salesOrderNumber&&r.jsxs("span",{className:"text-gray-500 font-normal",children:[" (",e.salesOrderNumber,")"]})]}),(void 0!==e.displayScore||void 0!==e.setMatchScore)&&r.jsxs("span",{className:"text-[10px] px-1.5 py-0.5 rounded font-medium "+((e.displayScore??e.setMatchScore??0)>=80?"bg-green-100 text-green-700":(e.displayScore??e.setMatchScore??0)>=50?"bg-yellow-100 text-yellow-700":"bg-gray-100 text-gray-600"),children:[Math.min(100,e.displayScore??e.setMatchScore??0),"%"]})]}),r.jsxs("p",{className:"text-[10px] text-gray-500 mt-0.5",children:[void 0!==e.matchedItemCount?`${e.matchedItemCount}/${C?.items.length||0}ê°œ ë§¤ì¹­`:`${e.itemCount}ê°œ í’ˆëª©`," Â· ",e.vendorName||"ê±°ëž˜ì²˜ ë¯¸ìƒ"]}),void 0!==e.quantityMatchedCount&&void 0!==e.matchedItemCount&&e.matchedItemCount>0&&r.jsx("p",{className:"text-[9px] mt-0.5 "+(0===e.quantityMismatchedCount?"text-green-600":"text-orange-600"),children:0===e.quantityMismatchedCount?"âœ… ìˆ˜ëŸ‰ ëª¨ë‘ ì¼ì¹˜":`âš ï¸ ìˆ˜ëŸ‰ ${e.quantityMismatchedCount}ê°œ ë¶ˆì¼ì¹˜`}),n&&r.jsx("p",{className:"text-[9px] text-green-600 font-medium mt-0.5",children:"âœ… ì„¸íŠ¸ ë§¤ì¹­ ì¶”ì²œ"})]},t)})]})]}),document.body),re&&r.jsx(G,{purchaseId:re,isOpen:Z,onClose:()=>{ee(!1),se(null)},activeTab:"done",forceShowStatementColumns:!0})]}):null}function je(){const{currentUserRoles:e}=i(),c=a(),o=e.includes("app_admin"),[h,_]=t.useState([]),[g,b]=t.useState(!0),[f,A]=t.useState(""),[X,Q]=t.useState("all"),[K,V]=t.useState(""),[Z,ee]=t.useState(0),[ie,ce]=t.useState(!1),[le,xe]=t.useState("default"),[pe,ge]=t.useState([]),[be,fe]=t.useState(null),[je,Ne]=t.useState(!1),[ve,we]=t.useState(!1),[Ce,Se]=t.useState(!1),[qe,ke]=t.useState(null),[Me,Oe]=t.useState(!1),[Ie,$e]=t.useState(!1),[Ee,Pe]=t.useState(""),[De,Re]=t.useState(new Set),[ze,Fe]=t.useState(!1),[Be,Ue]=t.useState(null),[Te,We]=t.useState({isOpen:!1,statement:null,position:{top:0,left:0}}),{filteredStatements:Le,defaultCount:Ae,receiptCount:He}=t.useMemo(()=>{const e=h.filter(e=>"default"===(e.statement_mode??"default")||"monthly"===e.statement_mode),t=h.filter(e=>"receipt"===e.statement_mode);return{filteredStatements:"default"===le?e:t,defaultCount:e.length,receiptCount:t.length}},[h,le]);t.useEffect(()=>{if(!o)return;(async()=>{const{data:e,error:t}=await c.from("employees").select("id, name").order("name");!t&&e&&ge(e.map(e=>({id:e.id,name:e.name})))})()},[o,c]);const Xe=t.useCallback(async()=>{try{b(!0);const e=await H.getStatements({status:"all"!==X?X:void 0,dateFrom:K||void 0,search:f||void 0,limit:50});if(e.success){_(e.data||[]),ee(e.count||0);(e.data||[]).filter(e=>"processing"===e.status).map(e=>e.id)}else N.error(e.error||"ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}catch(e){N.error("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}finally{b(!1)}},[X,K,f]);t.useEffect(()=>{Xe()},[Xe]),t.useEffect(()=>{H.kickQueue()},[]);const Je=t.useRef(a()),Ge=t.useRef(null),Qe=t.useRef(0),Ke=t.useRef(!0),Ve=t.useRef(!1),Ye=t.useRef(!1);t.useRef(Math.random().toString(36).slice(2,8)),t.useEffect(()=>{const e=Je.current,t=()=>{Ke.current&&(Ve.current||Ye.current||(Ve.current=!0,Ge.current&&(e.removeChannel(Ge.current),Ge.current=null),Ge.current=e.channel("transaction-statements-changes").on("postgres_changes",{event:"*",schema:"public",table:"transaction_statements"},e=>{if("UPDATE"===e.eventType){const t=e.new?.status,a=e.old?.status;t!==a&&(Xe(),"processing"===a&&["extracted","failed","confirmed","rejected"].includes(t)&&H.kickQueue())}else"INSERT"!==e.eventType&&"DELETE"!==e.eventType||Xe()}).subscribe((e,a)=>{"SUBSCRIBED"===e&&(Qe.current=0,Ve.current=!1,Ye.current=!0,Xe()),"CHANNEL_ERROR"!==e&&"CLOSED"!==e&&"TIMED_OUT"!==e||(Ve.current=!1,Ye.current=!1,Ke.current&&Qe.current<3&&(Qe.current+=1,t()))})))};return Ke.current=!0,(async()=>{try{const{data:t}=await e.auth.getSession(),a=t?.session?.access_token;a&&e.realtime.setAuth(a),e.realtime.connect()}catch(t){}})().finally(()=>{t()}),()=>{Ke.current=!1,Ge.current&&(e.removeChannel(Ge.current),Ge.current=null)}},[Xe]);const Ze=(e,t,a,s)=>{const n="inline-flex items-center gap-1 business-radius-badge px-2 py-0.5 text-[10px] font-medium leading-tight";switch(e){case"pending":return r.jsxs("span",{className:`${n} bg-gray-100 text-gray-600 border border-gray-200`,children:[r.jsx(se,{className:"w-3 h-3"}),"ëŒ€ê¸°ì¤‘"]});case"queued":return r.jsxs("span",{className:`${n} bg-slate-100 text-slate-600 border border-slate-200`,children:[r.jsx(se,{className:"w-3 h-3"}),"ëŒ€ê¸°ì—´"]});case"processing":return r.jsxs("span",{className:`${n} bg-blue-50 text-blue-600 border border-blue-200`,children:[r.jsx(Y,{className:"w-3 h-3 animate-spin"}),"ì²˜ë¦¬ì¤‘"]});case"extracted":return r.jsxs("span",{className:`${n} bg-yellow-50 text-yellow-600 border border-yellow-200`,children:[r.jsx(m,{className:"w-3 h-3"}),"í™•ì¸í•„ìš”"]});case"confirmed":return r.jsxs("span",{className:`${n} bg-green-50 text-green-600 border border-green-200`,children:[r.jsx(J,{className:"w-3 h-3"}),"receipt"===a?"ì™„ë£Œ":"í™•ì •ë¨"]});case"rejected":return r.jsxs("span",{className:`${n} bg-red-50 text-red-600 border border-red-200`,children:[r.jsx(ne,{className:"w-3 h-3"}),"ê±°ë¶€ë¨"]});case"failed":return r.jsxs("span",{className:`${n} bg-red-50 text-red-700 border border-red-200`,title:t||"ì²˜ë¦¬ ì‹¤íŒ¨",children:[r.jsx(ne,{className:"w-3 h-3"}),"ì‹¤íŒ¨"]});default:return r.jsx("span",{className:`${n} bg-gray-100 text-gray-600`,children:e})}},et=(e,t)=>{const a=t?.target;if(!Boolean(a?.closest?.('[data-uploader-control="true"]')))if(ke(e),"extracted"===e.status)Oe(!0);else if("confirmed"===e.status&&e.matched_purchases&&e.matched_purchases.length>0)if(1===e.matched_purchases.length)Ue(e.matched_purchases[0].purchase_id),Fe(!0);else{const a=t?.currentTarget?.getBoundingClientRect();We({isOpen:!0,statement:e,position:{top:a?a.bottom+window.scrollY:0,left:a?a.left+window.scrollX:0}})}else"confirmed"!==e.status&&"pending"!==e.status&&"queued"!==e.status&&"failed"!==e.status||(Pe(e.image_url),$e(!0))},tt=()=>{We({isOpen:!1,statement:null,position:{top:0,left:0}})},at=(e,t)=>{e.stopPropagation(),Pe(t),$e(!0)},rt=async(e,t)=>{e.stopPropagation();if(["pending","queued","failed"].includes(t.status)&&!De.has(t.id)){Re(e=>new Set(e).add(t.id));try{N.loading("OCR ì¶”ì¶œ ì¤‘... (ì•½ 10~30ì´ˆ ì†Œìš”)",{id:`extraction-${t.id}`});const e=await H.extractStatementData(t.id,t.image_url);if(e.success){if(e.queued)return N.info("ì²˜ë¦¬ ëŒ€ê¸°ì—´ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.",{id:`extraction-${t.id}`}),void Xe();N.success("OCR ì¶”ì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!",{id:`extraction-${t.id}`}),Xe(),e.data&&(ke(e.data),Oe(!0))}else N.error(e.error||"OCR ì¶”ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",{id:`extraction-${t.id}`})}catch(a){N.error("OCR ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",{id:`extraction-${t.id}`})}finally{Re(e=>{const a=new Set(e);return a.delete(t.id),a})}}else N.info("ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì´ê±°ë‚˜ ì™„ë£Œëœ ê±´ìž…ë‹ˆë‹¤.")},st=async(e,t)=>{Ne(!1),await Xe(),Re(t=>new Set(t).add(e));try{N.loading("OCR ì¶”ì¶œ ì¤‘... (ì•½ 10~30ì´ˆ ì†Œìš”)",{id:`extraction-${e}`});const a=await H.extractStatementData(e,t);a.success?a.queued?(N.info("ì²˜ë¦¬ ëŒ€ê¸°ì—´ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.",{id:`extraction-${e}`}),Xe()):(N.success("OCR ì¶”ì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.",{id:`extraction-${e}`}),Xe(),a.data&&(ke(a.data),Oe(!0))):(N.error(a.error||"OCR ì¶”ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",{id:`extraction-${e}`}),Xe())}catch(a){N.error("OCR ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",{id:`extraction-${e}`}),Xe()}finally{Re(t=>{const a=new Set(t);return a.delete(e),a})}},nt=()=>{Oe(!1),ke(null),Xe()},it=e=>e?new Date(e).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"}):"-",ct=e=>null==e?"-":e.toLocaleString("ko-KR")+"ì›";return r.jsxs("div",{className:"w-full",children:[r.jsx("div",{className:"mb-4",children:r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{children:[r.jsx("h1",{className:"page-title",children:"ê±°ëž˜ëª…ì„¸ì„œ í™•ì¸"}),r.jsx("p",{className:"page-subtitle",style:{marginTop:"-2px",marginBottom:"-4px"},children:"Transaction Statement Verification"})]}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsxs(M,{children:[r.jsx(O,{asChild:!0,children:r.jsxs(n,{className:"!h-auto button-base bg-hansl-600 hover:bg-hansl-700 text-white",children:[r.jsx(y,{className:"w-3.5 h-3.5"}),r.jsx("span",{className:"hidden sm:inline ml-1",children:"ì—…ë¡œë“œ"}),r.jsx(k,{className:"w-3 h-3 ml-1"})]})}),r.jsxs(I,{align:"end",className:"w-48",children:[r.jsxs($,{onClick:()=>Ne(!0),className:"text-[12px] py-2 cursor-pointer",children:[r.jsx(l,{className:"w-4 h-4 mr-2 text-hansl-600"}),"ê±°ëž˜ëª…ì„¸ì„œ ì—…ë¡œë“œ"]}),r.jsxs($,{onClick:()=>we(!0),className:"text-[12px] py-2 cursor-pointer",children:[r.jsx(d,{className:"w-4 h-4 mr-2 text-orange-600"}),"ìž…ê³ ìˆ˜ëŸ‰ ì—…ë¡œë“œ"]}),r.jsxs($,{onClick:()=>Se(!0),className:"text-[12px] py-2 cursor-pointer",children:[r.jsx(l,{className:"w-4 h-4 mr-2 text-emerald-600"}),"ê±°ëž˜ëª…ì„¸ì„œ(ì›”ë§ê²°ì œ)"]})]})]}),r.jsx(n,{variant:"outline",onClick:Xe,disabled:g,className:"!h-auto button-base",children:r.jsx(oe,{className:"w-3.5 h-3.5 "+(g?"animate-spin":"")})})]})]})}),r.jsxs("div",{className:"mb-3",children:[r.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[r.jsxs("div",{className:"relative min-w-[140px] max-w-[200px]",children:[r.jsx(te,{className:"absolute left-1.5 top-1/2 transform -translate-y-1/2 w-2.5 h-2.5 text-gray-400"}),r.jsx(j,{placeholder:"ê±°ëž˜ì²˜ëª…, íŒŒì¼ëª… ê²€ìƒ‰...",value:f,onChange:e=>A(e.target.value),className:"!h-auto !py-px !pr-1.5 !pl-5 !text-[11px] !min-h-[20px] business-radius-input border border-gray-300 bg-white text-gray-700"})]}),r.jsxs(v,{value:X,onValueChange:Q,children:[r.jsx(w,{className:"!h-auto !py-[1px] !px-2 !text-[12px] !min-h-[22px] w-[100px] business-radius-input border border-gray-300 bg-white text-gray-700 [&>svg]:h-3 [&>svg]:w-3",children:r.jsx(C,{placeholder:"ìƒíƒœ"})}),r.jsxs(S,{className:"min-w-[100px]",children:[r.jsx(q,{value:"all",className:"text-[12px] py-1.5",children:"ì „ì²´ ìƒíƒœ"}),r.jsx(q,{value:"pending",className:"text-[12px] py-1.5",children:"ëŒ€ê¸°ì¤‘"}),r.jsx(q,{value:"queued",className:"text-[12px] py-1.5",children:"ëŒ€ê¸°ì—´"}),r.jsx(q,{value:"extracted",className:"text-[12px] py-1.5",children:"í™•ì¸í•„ìš”"}),r.jsx(q,{value:"confirmed",className:"text-[12px] py-1.5",children:"í™•ì •ë¨"}),r.jsx(q,{value:"rejected",className:"text-[12px] py-1.5",children:"ê±°ë¶€ë¨"}),r.jsx(q,{value:"failed",className:"text-[12px] py-1.5",children:"ì‹¤íŒ¨"})]})]}),r.jsxs(n,{variant:"outline",onClick:()=>ce(!ie),className:"!h-auto button-base border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 "+(ie?"bg-hansl-50 border-hansl-300 text-hansl-700":""),children:[r.jsx(de,{className:"w-3.5 h-3.5 mr-1"}),r.jsx("span",{className:"button-text",children:"í•„í„°"})]}),r.jsxs("span",{className:"badge-stats bg-gray-100 text-gray-600",children:["ì´ ",Z,"ê±´"]})]}),ie&&r.jsx("div",{className:"mt-2 p-3 bg-gray-50 business-radius-card border border-gray-200",children:r.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("label",{className:"text-[12px] font-medium text-gray-500",children:"ì—…ë¡œë“œ ë‚ ì§œ"}),r.jsx(j,{type:"date",value:K,onChange:e=>V(e.target.value),className:"!h-auto !py-[2px] !px-2.5 !text-[12px] !min-h-[24px] w-[140px] business-radius-input border border-gray-300 bg-white text-gray-700"})]}),r.jsxs(n,{variant:"outline",onClick:()=>{A(""),Q("all"),V("")},className:"!h-auto button-base border border-gray-300 bg-white text-blue-600 hover:bg-blue-50 hover:border-blue-300",children:["â†» ",r.jsx("span",{className:"button-text text-blue-600",children:"ì´ˆê¸°í™”"})]})]})})]}),r.jsx(u,{className:"overflow-hidden border border-gray-200 business-radius-card",children:r.jsxs(x,{className:"p-0",children:[r.jsxs("div",{className:"flex border-b border-gray-200",children:[r.jsxs("button",{onClick:()=>xe("default"),className:"flex items-center gap-2 px-4 py-2.5 text-[11px] font-medium transition-colors "+("default"===le?"text-hansl-600 border-b-2 border-hansl-600 bg-hansl-50/50":"text-gray-500 hover:text-gray-700 hover:bg-gray-50"),children:[r.jsx(l,{className:"w-3.5 h-3.5"}),"ê±°ëž˜ëª…ì„¸ì„œ",r.jsx("span",{className:"px-1.5 py-0.5 text-[10px] rounded-full "+("default"===le?"bg-hansl-100 text-hansl-700":"bg-gray-100 text-gray-600"),children:Ae})]}),r.jsxs("button",{onClick:()=>xe("receipt"),className:"flex items-center gap-2 px-4 py-2.5 text-[11px] font-medium transition-colors "+("receipt"===le?"text-orange-600 border-b-2 border-orange-600 bg-orange-50/50":"text-gray-500 hover:text-gray-700 hover:bg-gray-50"),children:[r.jsx(d,{className:"w-3.5 h-3.5"}),"ìž…ê³ ìˆ˜ëŸ‰",r.jsx("span",{className:"px-1.5 py-0.5 text-[10px] rounded-full "+("receipt"===le?"bg-orange-100 text-orange-700":"bg-gray-100 text-gray-600"),children:He})]})]}),g?r.jsxs("div",{className:"flex items-center justify-center py-12",children:[r.jsx("div",{className:"w-6 h-6 border-2 border-hansl-500 border-t-transparent rounded-full animate-spin"}),r.jsx("span",{className:"ml-3 text-[11px] text-gray-500",children:"ë¡œë”© ì¤‘..."})]}):0===Le.length?r.jsxs("div",{className:"text-center py-12",children:[r.jsx(l,{className:"w-10 h-10 text-gray-300 mx-auto mb-3"}),r.jsx("h3",{className:"text-[12px] font-medium text-gray-700 mb-1",children:"default"===le?"ê±°ëž˜ëª…ì„¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤":"ìž…ê³ ìˆ˜ëŸ‰ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤"}),r.jsx("p",{className:"text-[11px] text-gray-500",children:"default"===le?"ì—…ë¡œë“œëœ ê±°ëž˜ëª…ì„¸ì„œê°€ ì—†ê±°ë‚˜ ê²€ìƒ‰ ì¡°ê±´ì— ë§žëŠ” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.":"ì—…ë¡œë“œëœ ìž…ê³ ìˆ˜ëŸ‰ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ê²€ìƒ‰ ì¡°ê±´ì— ë§žëŠ” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤."})]}):r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"hidden md:block overflow-x-auto",children:r.jsxs("table",{className:"w-full min-w-fit",children:[r.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:r.jsxs("tr",{children:[r.jsx("th",{className:"px-3 py-2.5 text-center text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:"ì¢…ë¥˜"}),r.jsx("th",{className:"px-3 py-2.5 text-center text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:"ìƒíƒœ"}),r.jsx("th",{className:"px-3 py-2.5 text-center text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:"ìˆ˜ëŸ‰/ê¸ˆì•¡"}),r.jsx("th",{className:"px-3 py-2.5 text-center text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:"ì—…ë¡œë“œì¼"}),r.jsx("th",{className:"px-3 py-2.5 text-center text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:"ëª…ì„¸ì„œì¼"}),r.jsx("th",{className:"px-3 py-2.5 text-left text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:"ê±°ëž˜ì²˜ëª…"}),r.jsx("th",{className:"px-3 py-2.5 text-right text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:"í•©ê³„ê¸ˆì•¡"}),r.jsx("th",{className:"px-3 py-2.5 text-center text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:"ë“±ë¡ìž"}),r.jsx("th",{className:"px-3 py-2.5 text-center text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:"ìˆ˜ëŸ‰í™•ì¸"}),r.jsx("th",{className:"px-3 py-2.5 text-center text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:"ê¸ˆì•¡í™•ì •"}),r.jsx("th",{className:"px-3 py-2.5 text-center text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:"ì•¡ì…˜"})]})}),r.jsx("tbody",{className:"bg-white divide-y divide-gray-100",children:Le.map(e=>r.jsxs("tr",{className:"hover:bg-gray-50 transition-colors cursor-pointer [&>td]:align-middle",onClick:t=>et(e,t),children:[r.jsx("td",{className:"px-3 py-2.5",children:r.jsx("div",{className:"flex items-center justify-center h-full",children:r.jsx("span",{className:"inline-flex items-center gap-1 business-radius-badge px-2 py-0.5 text-[10px] font-medium leading-tight "+("monthly"===e.statement_mode?"bg-emerald-100 text-emerald-700":"receipt"===e.statement_mode?"bg-orange-100 text-orange-700":"bg-blue-100 text-blue-700"),children:"monthly"===e.statement_mode?"ì›”ë§ê²°ì œ":"receipt"===e.statement_mode?"ìž…ê³ ìˆ˜ëŸ‰":"ì¼ë°˜"})})}),r.jsx("td",{className:"px-3 py-2.5 text-center",children:De.has(e.id)?Ze("processing"):Ze(e.status,e.extraction_error,e.statement_mode)}),r.jsx("td",{className:"px-3 py-2.5 text-center",children:"extracted"===e.status||"confirmed"===e.status?r.jsxs("div",{className:"flex items-center justify-center gap-1 text-[11px] font-medium",children:[r.jsxs("span",{className:e.quantity_match_confirmed_at?"text-green-600":"text-gray-400",children:["ìˆ˜ëŸ‰",e.quantity_match_confirmed_at?"âœ“":""]}),r.jsx("span",{className:"text-gray-300",children:"|"}),r.jsxs("span",{className:e.manager_confirmed_at?"text-green-600":"text-gray-400",children:["ê¸ˆì•¡",e.manager_confirmed_at?"âœ“":""]})]}):r.jsx("span",{className:"text-[11px] text-gray-300",children:"-"})}),r.jsx("td",{className:"px-3 py-2.5 text-[11px] text-center text-gray-600",children:it(e.uploaded_at)}),r.jsx("td",{className:"px-3 py-2.5 text-[11px] text-center text-gray-600",children:e.statement_date?it(e.statement_date):"-"}),r.jsx("td",{className:"px-3 py-2.5 text-[11px] font-medium text-gray-900",children:e.vendor_name||"-"}),r.jsx("td",{className:"px-3 py-2.5 text-[11px] font-medium text-right text-gray-900",children:ct(e.grand_total??e.total_amount)}),r.jsx("td",{className:"px-3 py-2.5 text-[11px] text-center text-gray-600",children:o?r.jsx("div",{className:"flex justify-center","data-uploader-control":"true",children:r.jsxs(U,{open:be===e.id,onOpenChange:t=>fe(t?e.id:null),children:[r.jsx(T,{asChild:!0,children:r.jsxs(n,{variant:"outline",role:"combobox",className:"h-6 w-20 justify-between text-[10px] px-2 border-gray-200",onClick:e=>e.stopPropagation(),children:[r.jsx("span",{className:"truncate",children:e.uploaded_by_name||"-"}),r.jsx(E,{className:"ml-1 h-3 w-3 shrink-0 opacity-50"})]})}),r.jsx(W,{className:"w-[180px] p-0",align:"center","data-uploader-control":"true",onClick:e=>e.stopPropagation(),children:r.jsxs(P,{children:[r.jsx(D,{placeholder:"ì´ë¦„ ê²€ìƒ‰...",className:"h-8 text-xs",onKeyDown:e=>e.stopPropagation()}),r.jsxs(R,{children:[r.jsx(z,{children:"ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ"}),r.jsx(F,{className:"max-h-[200px] overflow-auto",children:pe.map(t=>r.jsxs(B,{value:t.name,onMouseDown:e=>e.stopPropagation(),onClick:e=>e.stopPropagation(),onSelect:()=>{(async(e,t)=>{if(!o)return;const a=pe.find(e=>e.id===t);if(!a)return;const{error:r}=await c.from("transaction_statements").update({uploaded_by:t,uploaded_by_name:a.name}).eq("id",e);if(r){if(r.message?.includes("transaction_statements_uploaded_by_fkey")){const{error:t}=await c.from("transaction_statements").update({uploaded_by:null,uploaded_by_name:a.name}).eq("id",e);return t?void N.error("ë“±ë¡ìž ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."):(_(t=>t.map(t=>t.id===e?{...t,uploaded_by:void 0,uploaded_by_name:a.name}:t)),void fe(null))}N.error("ë“±ë¡ìž ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}else _(r=>r.map(r=>r.id===e?{...r,uploaded_by:t,uploaded_by_name:a.name}:r)),fe(null),N.success("ë“±ë¡ìžê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.")})(e.id,t.id)},className:"text-[11px]",children:[r.jsx(ae,{className:"mr-2 h-3 w-3 "+(e.uploaded_by===t.id?"opacity-100":"opacity-0")}),t.name]},t.id))})]})]})})]})}):e.uploaded_by_name||"-"}),r.jsx("td",{className:"px-3 py-2.5 text-[11px] text-center text-gray-600",children:e.quantity_match_confirmed_by_name||"-"}),r.jsx("td",{className:"px-3 py-2.5 text-[11px] text-center text-gray-600",children:e.manager_confirmed_by_name||"-"}),r.jsx("td",{className:"px-3 py-2.5 text-center",children:r.jsxs("div",{className:"flex items-center justify-center gap-1",children:["failed"===e.status&&r.jsx(n,{type:"button",onClick:t=>rt(t,e),className:"button-base border border-gray-300 bg-white text-gray-700 hover:bg-gray-50",children:"failed"===e.status?"ìž¬ì‹œë„":"ì¶”ì¶œ ì‹œìž‘"}),r.jsx("button",{onClick:t=>at(t,e.image_url),className:"p-1.5 rounded-md hover:bg-gray-100 text-gray-500 hover:text-gray-700 transition-colors",title:"ì´ë¯¸ì§€ ë³´ê¸°",children:r.jsx(L,{className:"w-3.5 h-3.5"})}),r.jsx("button",{onClick:t=>(async(e,t)=>{if(e.stopPropagation(),confirm(`"${t.file_name||"ì´ ê±°ëž˜ëª…ì„¸ì„œ"}"ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`))try{const e=await H.deleteStatement(t.id);e.success?(N.success("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."),Xe()):N.error(e.error||"ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}catch(a){N.error("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}})(t,e),className:"p-1.5 rounded-md hover:bg-red-50 text-red-400 hover:text-red-600 transition-colors",title:"ì‚­ì œ",children:r.jsx(p,{className:"w-3.5 h-3.5"})})]})})]},e.id))})]})}),r.jsx("div",{className:"md:hidden divide-y divide-gray-100",children:Le.map(e=>r.jsxs("div",{className:"p-3 hover:bg-gray-50 transition-colors cursor-pointer",onClick:t=>et(e,t),children:[r.jsxs("div",{className:"flex items-start justify-between mb-2",children:[r.jsxs("div",{className:"flex items-center gap-1.5",children:[r.jsx("span",{className:"inline-flex items-center gap-1 business-radius-badge px-2 py-0.5 text-[10px] font-medium leading-tight "+("monthly"===e.statement_mode?"bg-emerald-100 text-emerald-700":"receipt"===e.statement_mode?"bg-orange-100 text-orange-700":"bg-blue-100 text-blue-700"),children:"monthly"===e.statement_mode?"ì›”ë§ê²°ì œ":"receipt"===e.statement_mode?"ìž…ê³ ìˆ˜ëŸ‰":"ì¼ë°˜"}),De.has(e.id)?Ze("processing"):Ze(e.status,e.extraction_error,e.statement_mode)]}),r.jsx("span",{className:"text-[10px] text-gray-400",children:it(e.uploaded_at)})]}),r.jsx("div",{className:"mb-2",children:r.jsx("p",{className:"text-[11px] font-medium text-gray-900",children:e.vendor_name||"ê±°ëž˜ì²˜ ë¯¸í™•ì¸"})}),(e.grand_total||e.total_amount)&&r.jsx("p",{className:"text-[12px] font-bold text-gray-900",children:ct(e.grand_total??e.total_amount)}),r.jsxs("div",{className:"flex items-center justify-end gap-2 mt-2 pt-2 border-t border-gray-100",children:["failed"===e.status&&r.jsx(n,{type:"button",onClick:t=>rt(t,e),className:"button-base border border-gray-300 bg-white text-gray-700 hover:bg-gray-50",children:"failed"===e.status?"ìž¬ì‹œë„":"ì¶”ì¶œ ì‹œìž‘"}),r.jsxs("button",{onClick:t=>at(t,e.image_url),className:"button-base px-2 py-1 text-[10px] border border-gray-200 text-gray-600 hover:bg-gray-50",children:[r.jsx(L,{className:"w-3 h-3 mr-1"}),"ë³´ê¸°"]})]})]},e.id))})]})]})}),r.jsx(me,{isOpen:je,onClose:()=>Ne(!1),onSuccess:st}),r.jsx(ue,{isOpen:ve,onClose:()=>we(!1),onSuccess:st}),r.jsx(he,{isOpen:Ce,onClose:()=>Se(!1),onSuccess:async e=>{Se(!1),N.success("ì›”ë§ê²°ì œ ê±°ëž˜ëª…ì„¸ì„œ ì—…ë¡œë“œ ì™„ë£Œ. íŒŒì‹± ì²˜ë¦¬ ì¤‘..."),await Xe()}}),qe&&r.jsx(ye,{isOpen:Me,statement:qe,onClose:nt,onConfirm:nt,onReextractStart:e=>{Re(t=>{const a=new Set(t);return a.add(e),a})},onReextractFinish:e=>{Re(t=>{const a=new Set(t);return a.delete(e),a}),Xe()}}),r.jsx(_e,{isOpen:Ie,imageUrl:Ee,onClose:()=>{$e(!1),Pe("")}}),Te.isOpen&&Te.statement&&r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"fixed inset-0 z-40",onClick:tt}),r.jsxs("div",{className:"fixed z-50 bg-white border border-gray-200 rounded-lg shadow-lg min-w-[280px] max-w-[360px]",style:{top:Te.position.top+4,left:Te.position.left},children:[r.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-b border-gray-100 bg-gray-50 rounded-t-lg",children:[r.jsxs("span",{className:"text-[11px] font-semibold text-gray-700",children:["ì—°ê²°ëœ ë°œì£¼ (",Te.statement.matched_purchases?.length||0,"ê±´)"]}),r.jsx("button",{onClick:tt,className:"p-0.5 hover:bg-gray-200 rounded",children:r.jsx(s,{className:"w-3.5 h-3.5 text-gray-500"})})]}),r.jsx("div",{className:"max-h-[300px] overflow-auto",children:Te.statement.matched_purchases?.map((e,t)=>r.jsxs("div",{onClick:()=>{return t=e.purchase_id,We({isOpen:!1,statement:null,position:{top:0,left:0}}),Ue(t),void Fe(!0);var t},className:"flex items-center justify-between px-3 py-2.5 hover:bg-blue-50 cursor-pointer border-b border-gray-50 last:border-0 transition-colors",children:[r.jsxs("div",{className:"flex-1",children:[r.jsx("p",{className:"text-[12px] font-medium text-gray-900",children:e.purchase_order_number||e.sales_order_number||`ë°œì£¼ #${e.purchase_id}`}),e.sales_order_number&&e.purchase_order_number&&r.jsxs("p",{className:"text-[10px] text-gray-500",children:["ìˆ˜ì£¼: ",e.sales_order_number]})]}),r.jsxs("div",{className:"flex items-center gap-1 text-blue-600",children:[r.jsx("span",{className:"text-[10px]",children:"ìƒì„¸ë³´ê¸°"}),r.jsx(re,{className:"w-3.5 h-3.5"})]})]},e.purchase_id))})]})]}),Be&&r.jsx(G,{purchaseId:Be,isOpen:ze,onClose:()=>{Fe(!1),Ue(null)},activeTab:"done",forceShowStatementColumns:!0})]})}export{je as default};
//# sourceMappingURL=TransactionStatementMain-jJZ2kXvK.js.map
