import{c as e,a,l as s,u as t,r,j as n,X as l,B as i,S as d}from"./index-BX9izSap.js";import{t as c,B as o}from"./index-DbVKKtYS.js";import{C as m,a as u,b as p,c as h}from"./card-B_SoCqT_.js";import{D as g,a as x,I as _}from"./input-Dn1nJP7q.js";import{E as y}from"./exceljs.min-CXryy025.js";import{T as b,P as v}from"./PurchaseDetailModal-OCKJR0zE.js";import{P as j}from"./package-BAjOX6ye.js";import{C as f}from"./circle-check-big-EzXGun5U.js";import{E as N}from"./eye-SGyMDe6z.js";import{D as w}from"./download-DuiB1iNL.js";import{S as q}from"./search-CyVq7FBA.js";import"./helpers-C_CnFjYT.js";import"./format-DGRy94_S.js";import"./chevron-left-BB7PJ5LC.js";import"./chevron-down-DpNXlAaL.js";import"./popover-CHq-SEyw.js";import"./calendar-B8nGjZjd.js";import"./credit-card-D9lqxxq0.js";import"./trash-2-B0ZmnBt-.js";import"./plus-Ct9dD82T.js";import"./save-Dl1mkQkg.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const S=e("arrow-right",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]),k=e("circle-check",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]),D=e("clock",[["path",{d:"M12 6v6l4 2",key:"mmk7yg"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]),C=e("thumbs-up",[["path",{d:"M7 10v12",key:"1qc93n"}],["path",{d:"M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z",key:"emmmcr"}]]),P=e("triangle-alert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);const R=new class{constructor(){this.supabase=a()}parseRoles(e){let a=[];if(e)if(Array.isArray(e))a=e.map(e=>String(e).trim());else{a=String(e).split(",").map(e=>e.trim()).filter(e=>e.length>0)}return a}async getDashboardData(e){const[a,s,t,r,n,l,i]=await Promise.all([this.getDashboardStats(e),this.getUrgentRequests(e),this.getMyRecentRequests(e),this.getPendingApprovals(e),this.getQuickActions(e),this.getTodaySummary(e),this.getMyPurchaseStatus(e)]);return{employee:e,stats:a,urgentRequests:s,myRecentRequests:t,pendingApprovals:r,quickActions:n,todaySummary:l,myPurchaseStatus:i}}async getDashboardStats(e){const a=(new Date).toISOString().split("T")[0],s=this.parseRoles(e.purchase_role),[t,r,n,l,i,d]=await Promise.all([this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("requester_name",e.name),this.getPendingCount(e,s),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("is_received",!0).gte("received_at",new Date((new Date).getFullYear(),(new Date).getMonth(),1).toISOString()),this.getUrgentCount(e,s),this.getTodayActionsCount(e,a)]);return{total:t.count||0,myRequests:r.count||0,pending:n,completed:l.count||0,urgent:i,todayActions:d}}async getUrgentRequests(e){const a=new Date(Date.now()-2592e5).toISOString(),s=this.parseRoles(e.purchase_role);if(0===s.length)return[];let t=this.supabase.from("purchase_requests").select("*,vendors(vendor_name),purchase_request_items(id)").lt("created_at",a);if(s.includes("app_admin"))t=t.or("middle_manager_status.eq.pending,final_manager_status.eq.pending,purchase_status.eq.pending");else if(s.includes("middle_manager"))t=t.eq("middle_manager_status","pending");else if(s.includes("final_approver")||s.includes("ceo"))t=t.eq("middle_manager_status","approved").eq("final_manager_status","pending");else{if(!s.includes("lead buyer"))return[];t=t.eq("final_manager_status","approved").eq("purchase_status","pending")}const{data:r}=await t.order("created_at",{ascending:!0}).limit(5);return(r||[]).map(e=>({...e,vendor_name:e.vendors?.vendor_name,total_items:e.purchase_request_items?.length||0,daysOverdue:Math.floor((Date.now()-new Date(e.created_at).getTime())/864e5),priority:this.calculatePriority(e),urgentReason:this.getUrgentReason(e,s)}))}async getMyRecentRequests(e){const{data:a}=await this.supabase.from("purchase_requests").select("*,vendors(vendor_name),purchase_request_items(id)").eq("requester_name",e.name).or("and(middle_manager_status.eq.approved,final_manager_status.eq.pending),and(final_manager_status.eq.approved,purchase_status.eq.pending)").order("created_at",{ascending:!1}).limit(5);return(a||[]).map(e=>({...e,vendor_name:e.vendors?.vendor_name,total_items:e.purchase_request_items?.length||0,progress_percentage:this.calculateProgress(e),current_step:this.getCurrentStep(e),next_action:this.getNextAction(e),estimated_completion:this.estimateCompletion(e)}))}async getPendingApprovals(e){const a=this.parseRoles(e.purchase_role);let t=null;const r=await this.supabase.from("purchase_requests").select("*").order("request_date",{ascending:!1}).limit(100);if(r.error){r.error;const e=await this.supabase.from("purchase_requests").select("*").order("request_date",{ascending:!1}).limit(100);if(e.error)return[];t=e.data||[]}else t=r.data||[];s.debug("📊 전체 조회된 발주요청 개수",{count:t.length}),s.debug("📊 최근 5개 발주요청",{items:t.slice(0,5).map(e=>({id:e.id,purchase_order_number:e.purchase_order_number,request_date:e.request_date,created_at:e.created_at,middle_manager_status:e.middle_manager_status,final_manager_status:e.final_manager_status}))});let n=t||[];const l=e=>"pending"===e||"대기"===e||""===e||null==e;if(s.debug("🔍 승인대기 필터링 전 데이터",{employeeName:e.name,employeeRoles:this.parseRoles(e.purchase_role),totalRequests:t?.length||0,sampleData:t?.slice(0,3).map(e=>({id:e.id,purchase_order_number:e.purchase_order_number,middle_manager_status:e.middle_manager_status,final_manager_status:e.final_manager_status,vendor_name:e.vendor_name}))||[]}),n=n.filter(e=>{const a=l(e.middle_manager_status),t=l(e.final_manager_status),r="rejected"===e.middle_manager_status,n="rejected"===e.final_manager_status;if(r||n)return!1;const i=a||t;return s.debug("✅ 승인대기 항목 필터링",{id:e.id,purchase_order_number:e.purchase_order_number,middle_manager_status:e.middle_manager_status,final_manager_status:e.final_manager_status,middlePending:a,finalPending:t,shouldInclude:i}),i}),s.debug("🔍 승인대기 필터링 후 데이터",{filteredCount:n.length,filteredItems:n.map(e=>({id:e.id,purchase_order_number:e.purchase_order_number,middle_manager_status:e.middle_manager_status,final_manager_status:e.final_manager_status}))}),0===a.length)return[];let i=n;a.includes("app_admin")?s.debug("🔑 app_admin 권한으로 모든 승인대기 항목 표시",{totalItems:i.length}):a.includes("middle_manager")?(i=n.filter(e=>l(e.middle_manager_status)),s.debug("🔑 middle_manager 권한으로 중간승인 대기 항목만 표시",{beforeFilter:n.length,afterFilter:i.length})):a.includes("final_approver")||a.includes("ceo")?(i=n.filter(e=>{const a="approved"===e.middle_manager_status,s=l(e.final_manager_status);return a&&s}),s.debug("🔑 final_approver/ceo 권한으로 최종승인 대기 항목만 표시",{beforeFilter:n.length,afterFilter:i.length})):a.includes("raw_material_manager")||a.includes("consumable_manager")?(i=n.filter(e=>{const a="approved"===e.middle_manager_status,s=l(e.final_manager_status);return a&&s}),s.debug("🔑 material_manager 권한으로 최종승인 대기 항목만 표시",{beforeFilter:n.length,afterFilter:i.length})):a.includes("lead buyer")?(i=n.filter(e=>{const a="approved"===e.final_manager_status,s=l(e.purchase_status);return a&&s}),s.debug("🔑 lead buyer 권한으로 구매 대기 항목만 표시",{beforeFilter:n.length,afterFilter:i.length})):(i=[],s.debug("🔑 승인 권한 없는 역할",{roles:a,result:"empty"})),n=i,s.debug("📋 품목 정보 조회 시작",{filteredDataCount:n.length,filteredDataIds:n.map(e=>({id:e.id,purchase_order_number:e.purchase_order_number}))});const d=await Promise.all(n.map(async e=>{const{data:a}=await this.supabase.from("purchase_request_items").select("*").eq("purchase_request_id",e.id);let s=e.vendor_name;if(!s&&e.vendor_id){const{data:a}=await this.supabase.from("vendors").select("vendor_name").eq("id",e.vendor_id).single();s=a?.vendor_name}const t=a||[],r=t.reduce((e,a)=>e+(Number(a?.amount_value)||(Number(a?.quantity)||0)*(Number(a?.unit_price_value)||0)),0);return{...e,vendor_name:s,purchase_request_items:t,total_amount:r}}));return s.debug("📋 품목 정보 조회 완료",{enhancedDataCount:d.length,enhancedDataSummary:d.map(e=>({id:e.id,purchase_order_number:e.purchase_order_number,itemsCount:e.purchase_request_items?.length||0,total_amount:e.total_amount}))}),d}async getQuickActions(e){const a=this.parseRoles(e.purchase_role),s=[];if(a.includes("app_admin")||a.includes("middle_manager")||a.includes("final_approver")||a.includes("ceo")){const t=await this.getPendingCount(e,a);t>0&&s.push({id:"approve",type:"approve",label:"승인 대기",description:`${t}건의 승인 대기 중`,count:t,color:"red"})}if(a.includes("lead buyer")||a.includes("lead buyer")){const{count:e}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("final_manager_status","approved").eq("purchase_status","pending");e&&e>0&&s.push({id:"purchase",type:"purchase",label:"구매 처리",description:`${e}건의 구매 대기 중`,count:e,color:"yellow"})}return s}async getTodaySummary(e){const a=(new Date).toISOString().split("T")[0],s=new Date(Date.now()+864e5).toISOString().split("T")[0],[t,r,n]=await Promise.all([this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).gte("updated_at",a).lt("updated_at",s).or("middle_manager_status.eq.approved,final_manager_status.eq.approved"),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("requester_name",e.name).gte("created_at",a).lt("created_at",s),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("is_received",!0).gte("received_at",a).lt("received_at",s)]);return{approved:t.count||0,requested:r.count||0,received:n.count||0}}async getMyPurchaseStatus(e){const a=e.name||e.email,t=new Date(Date.now()-6048e5).toISOString(),r=await this.supabase.from("purchase_requests").select("*,vendors(vendor_name),purchase_request_items(item_name,quantity,specification,amount_value)").eq("requester_name",a).order("created_at",{ascending:!1}).limit(100);if(r.error)return s.error("getMyPurchaseStatus 에러",r.error),{waitingPurchase:[],waitingDelivery:[],recentCompleted:[]};const n=r.data||[];return{waitingPurchase:n.filter(e=>{const a=(e.payment_category||"").trim().replace(/\s+/g,""),s=["구매요청","발주요청"].includes(a),t=!e.is_payment_completed,r=(e.progress_type||"").includes("선진행");if(s&&t&&r)return!0;const n=(e.progress_type||"").includes("일반")||!e.progress_type||""===e.progress_type,l="approved"===e.final_manager_status;return s&&t&&n&&l}).slice(0,10),waitingDelivery:n.filter(e=>{const a=!e.is_received,s=(e.progress_type||"").includes("선진행");if(a&&s)return!0;const t="approved"===e.final_manager_status;return a&&t}).slice(0,10),recentCompleted:n.filter(e=>{if(!0!==e.is_received)return!1;if(!e.received_at)return!1;return new Date(e.received_at)>=new Date(t)}).slice(0,10)}}async quickApprove(e,a){try{const s=this.parseRoles(a.purchase_role),{data:t}=await this.supabase.from("purchase_requests").select("middle_manager_status, final_manager_status").eq("id",e).single();if(!t)return{success:!1,error:"요청을 찾을 수 없습니다."};let r={};const n=e=>"pending"===e||"대기"===e||""===e||null==e;if(s.includes("app_admin")?n(t.middle_manager_status)?r={middle_manager_status:"approved"}:"approved"===t.middle_manager_status&&n(t.final_manager_status)&&(r={final_manager_status:"approved"}):s.includes("middle_manager")?n(t.middle_manager_status)&&(r={middle_manager_status:"approved"}):s.includes("final_approver")||s.includes("ceo")?"approved"===t.middle_manager_status&&n(t.final_manager_status)&&(r={final_manager_status:"approved"}):(s.includes("raw_material_manager")||s.includes("consumable_manager"))&&"approved"===t.middle_manager_status&&n(t.final_manager_status)&&(r={final_manager_status:"approved"}),0===Object.keys(r).length)return{success:!1,error:"승인할 수 있는 상태가 아닙니다."};const{data:l,error:i}=await this.supabase.from("purchase_requests").update(r).eq("id",e).select().single();if(i)throw i;return{success:!0}}catch(s){return{success:!1,error:s.message}}}async getPendingCount(e,a){if(a.includes("app_admin")){const[e,a,s]=await Promise.all([this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).or("middle_manager_status.in.(pending,대기),middle_manager_status.is.null"),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("middle_manager_status","approved").or("final_manager_status.in.(pending,대기),final_manager_status.is.null"),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("final_manager_status","approved").or("purchase_status.in.(pending,대기),purchase_status.is.null")]);return(e.count||0)+(a.count||0)+(s.count||0)}if(a.includes("middle_manager")){const{count:e,error:a}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).or("middle_manager_status.in.(pending,대기),middle_manager_status.is.null");return a?0:e||0}if(a.includes("final_approver")||a.includes("ceo")){const{count:e,error:a}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("middle_manager_status","approved").or("final_manager_status.in.(pending,대기),final_manager_status.is.null");return a?0:e||0}if(a.includes("lead buyer")){const{count:e,error:a}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("final_manager_status","approved").or("purchase_status.in.(pending,대기),purchase_status.is.null");return a?0:e||0}return 0}async getUrgentCount(e,a){if(0===a.length)return 0;const s=new Date(Date.now()-2592e5).toISOString();let t=this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).lt("created_at",s);if(a.includes("app_admin"))t=t.or("middle_manager_status.eq.pending,final_manager_status.eq.pending,purchase_status.eq.pending");else if(a.includes("middle_manager"))t=t.eq("middle_manager_status","pending");else if(a.includes("final_approver")||a.includes("ceo"))t=t.eq("middle_manager_status","approved").eq("final_manager_status","pending");else{if(!a.includes("lead buyer"))return 0;t=t.eq("final_manager_status","approved").eq("purchase_status","pending")}const{count:r}=await t;return r||0}async getTodayActionsCount(e,a){const s=new Date(Date.now()+864e5).toISOString().split("T")[0],{count:t}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).gte("updated_at",a).lt("updated_at",s).or(`middle_manager_id.eq.${e.id},final_manager_id.eq.${e.id}`);return t||0}async getTotalDeliveryWaitingCount(){const{count:e}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("is_received",!1).or("is_payment_completed.eq.true,progress_type.ilike.%선진행%");return e||0}calculatePriority(e){const a=Math.floor((Date.now()-new Date(e.created_at).getTime())/864e5);return a>=7?"high":a>=5?"medium":"low"}getUrgentReason(e,a){return a.includes("middle_manager")&&"pending"===e.middle_manager_status||(a.includes("final_approver")||a.includes("ceo"))&&"pending"===e.final_manager_status?"overdue_approval":e.is_received?"payment_pending":"delivery_delay"}calculateProgress(e){let a=0;return"approved"===e.middle_manager_status&&(a+=25),"approved"===e.final_manager_status&&(a+=25),e.is_payment_completed&&(a+=25),e.is_received&&(a+=25),a}getCurrentStep(e){return e.is_received?"completed":e.is_payment_completed?"delivery":"approved"===e.final_manager_status?"purchase":"approval"}getNextAction(e){return"pending"===e.middle_manager_status?"중간 승인 대기 중":"pending"===e.final_manager_status?"최종 승인 대기 중":e.is_payment_completed?e.is_received?"완료":"입고 대기 중":"구매 처리 대기 중"}estimateCompletion(e){const a=new Date(e.created_at),s=new Date;Math.floor((s.getTime()-a.getTime())/864e5);let t=7;"긴급"===e.progress_type&&(t=3);return new Date(a.getTime()+24*t*60*60*1e3).toLocaleDateString("ko-KR")}async getUndownloadedOrders(e){const a=this.parseRoles(e.purchase_role);if(!a.includes("lead buyer")&&!a.includes("lead buyer"))return[];const{data:t,error:r}=await this.supabase.from("purchase_requests").select("*,purchase_request_items(id,item_name,specification,quantity,unit_price_value,amount_value)").order("created_at",{ascending:!1}).limit(100);if(r)return s.error("Failed to fetch undownloaded orders",r),[];const n=(t||[]).filter(e=>{const a="선진행"===e.progress_type||"approved"===e.middle_manager_status&&"approved"===e.final_manager_status,s=!e.is_po_download||!1===e.is_po_download||null===e.is_po_download;return a&&s});return n.sort((e,a)=>new Date(e.created_at).getTime()-new Date(a.created_at).getTime()),n.slice(0,10)}};function O({isOpen:e,onClose:o,item:m,type:u,onRefresh:p}){const h=t(),_=a(),[y,v]=r.useState([]),[N,w]=r.useState(!1),[q,C]=r.useState(m);if(r.useEffect(()=>{C(m)},[m]),r.useEffect(()=>{(async()=>{const{data:{user:e}}=await _.auth.getUser();if(e?.email){const{data:a}=await _.from("employees").select("purchase_role").eq("email",e.email).single();if(a?.purchase_role){const e=Array.isArray(a.purchase_role)?a.purchase_role:a.purchase_role.split(",").map(e=>e.trim());v(e)}}})()},[u]),!q)return null;const P=q.purchase_request_items||[],R=P.reduce((e,a)=>e+(Number(a.amount_value)||0),0);P.reduce((e,a)=>e+(Number(a.quantity)||0),0),s.debug("PurchaseStatusModal 디버깅",{type:u,currentUserRoles:y,item:q.purchase_order_number,showPurchaseButton:"purchase"===u,showDeliveryButton:"delivery"===u,hasAdminPermission:y.includes("app_admin"),hasLeadBuyerPermission:y.includes("lead buyer"),itemData:{is_payment_completed:q.is_payment_completed,is_received:q.is_received}});const O=(()=>{switch(u){case"pending":return{icon:n.jsx(D,{className:"w-6 h-6 text-orange-600"}),title:"승인 대기",status:"승인 처리 대기중",color:"bg-orange-50 text-orange-700 border-orange-200"};case"purchase":return{icon:n.jsx(d,{className:"w-6 h-6 text-yellow-600"}),title:"구매 대기",status:"구매 처리 대기중",color:"bg-yellow-50 text-yellow-700 border-yellow-200"};case"delivery":return{icon:n.jsx(b,{className:"w-6 h-6 text-blue-600"}),title:"입고 대기",status:"입고 처리 대기중",color:"bg-blue-50 text-blue-700 border-blue-200"};case"completed":return{icon:n.jsx(f,{className:"w-6 h-6 text-green-600"}),title:"처리 완료",status:"모든 처리 완료",color:"bg-green-50 text-green-700 border-green-200"};default:return{icon:n.jsx(j,{className:"w-6 h-6 text-gray-600"}),title:"상태 확인",status:"상태 확인 필요",color:"bg-gray-50 text-gray-700 border-gray-200"}}})();return n.jsx(g,{open:e,onOpenChange:o,children:n.jsxs(x,{className:"overflow-hidden bg-white rounded-3xl shadow-2xl border-0",style:{maxWidth:"1280px",width:"90vw",maxHeight:"50vh"},showCloseButton:!1,children:[n.jsxs("div",{className:"relative px-6 pt-6 pb-4",children:[n.jsx("button",{onClick:o,className:"absolute right-6 top-6 w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-all duration-200",children:n.jsx(l,{className:"w-4 h-4 text-gray-500"})}),n.jsx("div",{className:"pr-16",children:n.jsxs("div",{className:"flex items-start gap-4 mb-2",children:[n.jsx("div",{className:"w-10 h-10 rounded-2xl bg-blue-50 flex items-center justify-center flex-shrink-0",children:O.icon}),n.jsxs("div",{className:"min-w-0 flex-1",children:[n.jsx("h1",{className:"modal-title mb-1",children:q.purchase_order_number||"PO번호 없음"}),n.jsx("p",{className:"modal-subtitle",children:q.vendor_name||"업체명 없음"})]}),n.jsx("div",{className:`px-3 py-1.5 business-radius-badge badge-text ${O.color}`,children:O.title})]})})]}),n.jsxs("div",{className:"overflow-y-auto max-h-[calc(50vh-160px)] px-6 pb-4 space-y-3",children:[n.jsx("div",{className:"bg-gray-50 rounded-xl p-3 border border-gray-100",children:n.jsxs("div",{className:"grid grid-cols-3 gap-x-4 gap-y-2 text-xs",children:[n.jsxs("div",{children:[n.jsx("span",{className:"modal-label",children:"요청자:"})," ",n.jsx("span",{className:"modal-value",children:q.requester_name})]}),n.jsxs("div",{children:[n.jsx("span",{className:"modal-label",children:"요청일:"})," ",n.jsx("span",{className:"modal-value",children:new Date(q.request_date||q.created_at).toLocaleDateString("ko-KR")})]}),n.jsxs("div",{children:[n.jsx("span",{className:"modal-label",children:"납기요청일:"})," ",n.jsx("span",{className:"modal-value",children:q.delivery_request_date?new Date(q.delivery_request_date).toLocaleDateString("ko-KR"):"미지정"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"modal-label",children:"업체명:"})," ",n.jsx("span",{className:"modal-value",children:q.vendor_name||"-"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"modal-label",children:"결제유형:"})," ",n.jsx("span",{className:"modal-value",children:q.payment_category||"일반"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"modal-label",children:"진행구분:"})," ",n.jsx("span",{className:"modal-value",children:q.progress_type||"일반"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"modal-label",children:"프로젝트업체:"})," ",n.jsx("span",{className:"modal-value",children:q.project_vendor||"-"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"modal-label",children:"판매주문번호:"})," ",n.jsx("span",{className:"modal-value",children:q.sales_order_number||"-"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"modal-label",children:"배송지:"})," ",n.jsx("span",{className:"modal-value",children:q.shipping_address||"본사"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"modal-label",children:"통화:"})," ",n.jsx("span",{className:"modal-value",children:q.currency||"KRW"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"modal-label",children:"템플릿:"})," ",n.jsx("span",{className:"modal-value",children:q.po_template_type||"일반"})]}),q.revised_delivery_request_date&&n.jsxs("div",{children:[n.jsx("span",{className:"modal-label text-orange-500",children:"변경입고일:"})," ",n.jsx("span",{className:"modal-value text-orange-900",children:new Date(q.revised_delivery_request_date).toLocaleDateString("ko-KR")})]})]})}),n.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 overflow-hidden",children:[n.jsx("div",{className:"bg-gray-50 px-3 py-2 border-b border-gray-100",children:n.jsxs("h3",{className:"modal-section-title text-gray-700",children:["주문 품목 (",P.length,"개, 총 ₩",R.toLocaleString(),")"]})}),n.jsx("div",{className:"overflow-x-auto",children:n.jsxs("table",{className:"w-full text-xs table-fixed",children:[n.jsxs("colgroup",{children:[n.jsx("col",{className:"w-[25%]"}),n.jsx("col",{className:"w-[20%]"}),n.jsx("col",{className:"w-[10%]"}),n.jsx("col",{className:"w-[15%]"}),n.jsx("col",{className:"w-[15%]"}),("delivery"===u||"purchase"===u)&&n.jsx("col",{className:"w-[15%]"})]}),n.jsx("thead",{className:"bg-gray-50 border-b border-gray-100",children:n.jsxs("tr",{children:[n.jsx("th",{className:"text-left p-2 modal-label text-gray-600",children:"품목명"}),n.jsx("th",{className:"text-left p-2 modal-label text-gray-600",children:"규격"}),n.jsx("th",{className:"text-right p-2 modal-label text-gray-600",children:"수량"}),n.jsx("th",{className:"text-right p-2 modal-label text-gray-600",children:"단가"}),n.jsx("th",{className:"text-right p-2 modal-label text-gray-600",children:"금액"}),"delivery"===u&&n.jsx("th",{className:"text-center p-2 modal-label text-gray-600",children:"입고상태"}),"purchase"===u&&n.jsx("th",{className:"text-center p-2 modal-label text-gray-600",children:"구매상태"})]})}),n.jsx("tbody",{className:"divide-y divide-gray-100",children:P.map((e,a)=>{const s=e.quantity>0?(Number(e.amount_value)||0)/e.quantity:0;return n.jsxs("tr",{className:"hover:bg-gray-50",children:[n.jsxs("td",{className:"p-2",children:[n.jsx("div",{className:"modal-value text-gray-900",children:e.item_name||"품목명 없음"}),e.remark&&n.jsxs("div",{className:"text-xs text-amber-600 mt-1",children:["비고: ",e.remark]})]}),n.jsx("td",{className:"p-2 text-gray-600",children:e.specification||"-"}),n.jsx("td",{className:"p-2 text-right modal-value",children:e.quantity||0}),n.jsxs("td",{className:"p-2 text-right",children:["₩",s.toLocaleString()]}),n.jsxs("td",{className:"p-2 text-right modal-value",children:["₩",(Number(e.amount_value)||0).toLocaleString()]}),"delivery"===u&&n.jsx("td",{className:"p-2 text-center",children:e.is_received?n.jsxs("span",{className:"inline-flex items-center gap-1 bg-green-50 text-green-700 px-2 py-1 business-radius-badge text-xs border border-green-200",children:[n.jsx(k,{className:"w-3 h-3"}),"완료"]}):(y.includes("app_admin")||y.includes("requester"))&&n.jsx(i,{size:"sm",onClick:async()=>{if(confirm("이 품목을 입고완료 처리하시겠습니까?"))try{const{error:a}=await _.from("purchase_request_items").update({is_received:!0,received_at:(new Date).toISOString()}).eq("id",e.id);if(a)throw a;C(a=>({...a,purchase_request_items:a.purchase_request_items?.map(a=>a.id===e.id?{...a,is_received:!0,received_at:(new Date).toISOString()}:a)||[]})),c.success("입고완료 처리되었습니다."),p&&p()}catch(a){c.error("처리 중 오류가 발생했습니다.")}},className:"bg-blue-600 hover:bg-blue-700 text-white h-6 px-2 text-xs",children:"입고완료"})}),"purchase"===u&&n.jsx("td",{className:"p-2 text-center",children:e.is_payment_completed?n.jsxs("span",{className:"inline-flex items-center gap-1 bg-green-50 text-green-700 px-2 py-1 business-radius-badge text-xs border border-green-200",children:[n.jsx(k,{className:"w-3 h-3"}),"완료"]}):(y.includes("app_admin")||y.includes("lead buyer"))&&n.jsx(i,{size:"sm",onClick:async()=>{if(confirm("이 품목을 구매완료 처리하시겠습니까?"))try{const{error:a}=await _.from("purchase_request_items").update({is_payment_completed:!0,payment_completed_at:(new Date).toISOString()}).eq("id",e.id);if(a)throw a;C(a=>({...a,purchase_request_items:a.purchase_request_items?.map(a=>a.id===e.id?{...a,is_payment_completed:!0,payment_completed_at:(new Date).toISOString()}:a)})),c.success("품목 구매완료 처리되었습니다."),p?.()}catch(a){c.error("처리 중 오류가 발생했습니다.")}},className:"bg-yellow-600 hover:bg-yellow-700 text-white px-2 py-1 badge-text",children:"구매완료"})})]},a)})})]})})]}),"delivery"===u&&P.length>1&&n.jsx("div",{className:"bg-blue-50 rounded-xl p-3 border border-blue-100",children:(()=>{const e=P.filter(e=>e.is_received).length,a=P.length,s=e/a*100;return n.jsxs("div",{className:"flex items-center gap-4",children:[n.jsx("div",{className:"modal-value text-blue-700",children:"입고 진행률"}),n.jsx("div",{className:"flex-1 bg-blue-200 rounded-full h-2",children:n.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-500",style:{width:`${s}%`}})}),n.jsxs("div",{className:"modal-value text-blue-700",children:[e,"/",a," (",s.toFixed(0),"%)"]})]})})()})]}),n.jsx("div",{className:"sticky bottom-0 bg-white border-t border-gray-100 px-6 py-6",children:n.jsxs("div",{className:"flex items-center justify-between gap-6",children:["purchase"===u&&(y.includes("app_admin")||y.includes("lead buyer"))&&n.jsxs(i,{onClick:async()=>{w(!0);try{const{error:e}=await _.from("purchase_requests").update({is_payment_completed:!0,payment_completed_at:(new Date).toISOString()}).eq("id",q.id);if(e)throw e;C(e=>({...e,is_payment_completed:!0,payment_completed_at:(new Date).toISOString()})),c.success("구매완료 처리되었습니다."),p?.()}catch(e){c.error("처리 중 오류가 발생했습니다.")}finally{w(!1)}},disabled:N,className:"bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-8 py-4 rounded-2xl shadow-lg transition-all duration-200 modal-subtitle",children:[N?n.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-3"}):n.jsx(k,{className:"w-5 h-5 mr-3"}),"구매 완료 처리"]}),n.jsxs("div",{className:"flex items-center gap-4 ml-auto",children:[n.jsxs(i,{variant:"outline",onClick:()=>{h(`/purchase?highlight=${q.id}`),o()},className:"border-gray-300 text-gray-700 hover:bg-gray-50 hover:text-gray-900 hover:border-gray-400 px-8 py-4 rounded-2xl modal-subtitle transition-all duration-200",children:["발주 목록에서 보기",n.jsx(S,{className:"w-5 h-5 ml-3"})]}),n.jsx(i,{onClick:o,className:"bg-gray-900 hover:bg-gray-800 text-white px-10 py-4 rounded-2xl modal-subtitle transition-all duration-200 shadow-lg",children:"완료"})]})]})})]})})}function A(){const[e,s]=r.useState(null),[k,A]=r.useState(!0),[I,L]=r.useState(null),[T,M]=r.useState(null),[U,$]=r.useState(!1),[F,z]=r.useState([]),[E,B]=r.useState([]),[K,W]=r.useState(new Set),[H,Q]=r.useState(null),[Y,G]=r.useState(!1),[Z,J]=r.useState(null),[V,X]=r.useState(null),[ee,ae]=r.useState(!1),[se,te]=r.useState({undownloaded:"",pending:"",purchase:"",delivery:""}),re=t(),ne=a(),le=r.useCallback(async(e=!0)=>{try{e&&A(!0);const r=a(),{data:{user:n},error:l}=await r.auth.getUser();if(l)return void c.error("인증 정보를 불러올 수 없습니다.");if(!n)return void c.error("로그인이 필요합니다.");const{data:i,error:d}=await r.from("employees").select("*").eq("email",n.email).single();if(d||!i){const e={id:n.id,name:n.email?.split("@")[0]||"Guest User",email:n.email||"",purchase_role:null};try{const a=await R.getDashboardData(e);s(a)}catch(t){}return void A(!1)}try{const e=await R.getDashboardData(i);await R.getTotalDeliveryWaitingCount();s(e)}catch(t){c.error("대시보드 데이터를 불러오는데 실패했습니다.")}if(i.purchase_role){const e=Array.isArray(i.purchase_role)?i.purchase_role.map(e=>String(e).trim()):String(i.purchase_role).split(",").map(e=>e.trim()).filter(e=>e.length>0);if(z(e),e.includes("lead buyer")||e.includes("lead buyer")){const e=await R.getUndownloadedOrders(i);B(e)}}}catch(r){}finally{e&&A(!1)}},[]);r.useEffect(()=>{le()},[le]);const ie=async a=>{if(!e?.employee)return void c.error("사용자 정보를 찾을 수 없습니다.");if(!confirm("정말로 승인하시겠습니까?"))return;L(a);const t=e;s(e=>e?{...e,pendingApprovals:e.pendingApprovals.filter(e=>e.id!==a),stats:{...e.stats,pending:Math.max(0,e.stats.pending-1)}}:e);try{const r=await R.quickApprove(a,e.employee);r.success?(c.success("승인이 완료되었습니다."),setTimeout(()=>{le(!1)},1e3)):(s(t),c.error(r.error||"승인 처리 중 오류가 발생했습니다."))}catch(r){s(t),c.error("승인 처리 중 오류가 발생했습니다.")}finally{L(null)}},de=(e,a)=>{J(e),X(a),ae(!0)},ce=(e,a)=>a.trim()?e.filter(e=>[e.purchase_order_number||"",e.vendor_name||"",(e.purchase_request_items||[]).map(e=>e.item_name||"").join(" ")].join(" ").toLowerCase().includes(a.toLowerCase())):e,oe=async e=>{try{W(a=>new Set(a).add(e.id));const a=new y.Workbook,s=a.addWorksheet("발주서");s.columns=[{header:"발주번호",key:"purchase_order_number",width:20},{header:"업체명",key:"vendor_name",width:30},{header:"품목명",key:"item_name",width:40},{header:"규격",key:"specification",width:30},{header:"수량",key:"quantity",width:15},{header:"단가",key:"unit_price",width:20},{header:"금액",key:"amount",width:20},{header:"요청일",key:"request_date",width:15},{header:"진행상태",key:"progress_type",width:15}];(e.purchase_request_items||[]).forEach(a=>{s.addRow({purchase_order_number:e.purchase_order_number,vendor_name:e.vendor_name||e.vendors?.vendor_name||"",item_name:a.item_name||"",specification:a.specification||"",quantity:a.quantity||0,unit_price:a.unit_price_value||0,amount:a.amount_value||0,request_date:e.request_date||"",progress_type:e.progress_type||""})}),s.getRow(1).font={bold:!0},s.getRow(1).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFE0E0E0"}};const t=await a.xlsx.writeBuffer(),r=new Blob([t],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),n=window.URL.createObjectURL(r),l=document.createElement("a");l.href=n,l.download=`발주서_${e.purchase_order_number}_${(new Date).toISOString().slice(0,10)}.xlsx`,l.click(),window.URL.revokeObjectURL(n),(F.includes("lead buyer")||F.includes("lead buyer"))&&(await ne.from("purchase_requests").update({is_po_download:!0}).eq("id",e.id),B(a=>a.filter(a=>a.id!==e.id))),c.success("발주서가 다운로드되었습니다.")}catch(a){c.error("다운로드 중 오류가 발생했습니다.")}finally{W(a=>{const s=new Set(a);return s.delete(e.id),s})}},me=e=>{switch(e){case"high":return"bg-red-100 text-red-800 border-red-200";case"medium":return"bg-yellow-100 text-yellow-800 border-yellow-200";case"low":return"bg-green-100 text-green-800 border-green-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}};if(k)return n.jsx("div",{className:"flex items-center justify-center h-screen bg-gray-50",children:n.jsxs("div",{className:"text-center",children:[n.jsx("div",{className:"w-12 h-12 border-3 border-hansl-500 border-t-transparent rounded-full animate-spin mx-auto"}),n.jsx("p",{className:"mt-4 card-subtitle",children:"대시보드를 불러오고 있습니다..."})]})});if(!e?.employee)return n.jsx("div",{className:"flex items-center justify-center h-screen bg-gray-50",children:n.jsxs("div",{className:"text-center bg-white p-8 rounded-lg border border-gray-200",children:[n.jsx("h3",{className:"modal-subtitle mb-2",children:"사용자 정보를 찾을 수 없습니다"}),n.jsx("p",{className:"card-subtitle",children:"로그인을 다시 시도해주세요."})]})});const ue=(Array.isArray(e.employee.purchase_role)?e.employee.purchase_role.map(e=>String(e).trim()):e.employee.purchase_role?String(e.employee.purchase_role).split(",").map(e=>e.trim()).filter(e=>e.length>0):[]).some(e=>["middle_manager","final_approver","app_admin","raw_material_manager","consumable_manager"].includes(e));return n.jsxs("div",{className:"min-h-screen bg-gray-50",children:[n.jsxs("div",{className:"w-full px-4 lg:px-6",children:[n.jsx("div",{className:"mb-3",children:n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{children:[n.jsx("h1",{className:"page-title",children:"대시보드"}),n.jsx("p",{className:"page-subtitle",style:{marginTop:"-2px",marginBottom:"-4px"},children:"Dashboard"})]}),n.jsx("div",{className:"flex items-center gap-2",children:n.jsx(o,{variant:"outline",className:"badge-text",children:(new Date).toLocaleDateString("ko-KR",{month:"long",day:"numeric",weekday:"short"})})})]})}),e.urgentRequests.length>0&&n.jsxs(m,{className:"mb-3 border-red-200 bg-red-50",children:[n.jsx(u,{className:"pb-2 pt-3",children:n.jsxs(p,{className:"flex items-center gap-2 text-red-800 card-title",children:[n.jsx(P,{className:"w-4 h-4"}),"긴급 처리 필요 (",e.urgentRequests.length,"건)"]})}),n.jsx(h,{className:"p-3",children:n.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2",children:e.urgentRequests.slice(0,5).map(e=>n.jsx("div",{className:"bg-white rounded-lg p-2 border border-red-200 min-w-[280px] flex-shrink-0",children:n.jsxs("div",{className:"flex items-center justify-between gap-2",children:[n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsxs("div",{className:"flex flex-wrap items-center gap-1 mb-1",children:[n.jsx(o,{className:`${me(e.priority)} badge-text h-4 px-1`,children:"high"===e.priority?"높음":"medium"===e.priority?"보통":"낮음"}),n.jsx("span",{className:"card-subtitle truncate max-w-[120px]",children:e.vendor_name||"업체명 없음"}),n.jsxs("span",{className:"card-date",children:[e.daysOverdue,"일 지연"]})]}),n.jsxs("div",{className:"card-description",children:[n.jsxs("span",{children:["발주: ",e.purchase_order_number||e.id.slice(0,8)]}),n.jsxs("span",{className:"ml-1",children:["• ",e.total_items,"개"]})]})]}),n.jsxs("div",{className:"flex gap-1 shrink-0",children:[n.jsxs(i,{size:"sm",variant:"outline",onClick:()=>re(`/purchase?highlight=${e.id}`),className:"h-6 px-2 badge-text",children:[n.jsx(N,{className:"w-3 h-3 mr-0.5"}),"보기"]}),n.jsxs(i,{size:"sm",onClick:()=>ie(e.id),disabled:I===e.id,className:"bg-red-600 hover:bg-red-700 h-6 px-2 badge-text",children:[n.jsx(C,{className:"w-3 h-3 mr-0.5"}),I===e.id?"처리중":"승인"]})]})]})},e.id))})})]}),n.jsx("div",{className:"mb-2",children:n.jsxs("h2",{className:"section-title mb-2 flex items-center gap-1.5",children:[n.jsx(j,{className:"w-3.5 h-3.5 text-gray-600"}),"전체 현황"]})}),n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3",children:[(F.includes("lead buyer")||F.includes("lead buyer"))&&E.length>0&&n.jsxs(m,{className:"w-full col-span-1 row-span-2 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[n.jsx(u,{className:"py-3 px-4 bg-gray-50 border-b",children:n.jsxs(p,{className:"section-title flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(w,{className:"w-4 h-4 text-orange-600"}),n.jsx("span",{children:"미다운로드 발주서"})]}),n.jsx(o,{className:"bg-orange-100 text-orange-700 border-orange-200 px-2 py-0.5",children:E.length})]})}),n.jsx(h,{className:"p-4",children:n.jsxs("div",{className:"space-y-3",children:[n.jsxs("div",{className:"relative",children:[n.jsx(q,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),n.jsx(_,{placeholder:"발주번호, 업체명, 품목으로 검색...",value:se.undownloaded,onChange:e=>te(a=>({...a,undownloaded:e.target.value})),className:"pl-10 h-8 text-xs"})]}),n.jsx("div",{className:"space-y-2 h-[36rem] overflow-y-auto",children:ce(E,se.undownloaded).slice(0,10).map(e=>{const a=e.purchase_request_items||[],s=a[0]||{};a.reduce((e,a)=>e+(Number(a.amount_value)||0),0),a.reduce((e,a)=>e+(Number(a.quantity)||0),0);const t=Math.floor((Date.now()-new Date(e.created_at).getTime())/864e5),r="선진행"===e.progress_type;return n.jsx("div",{className:"border rounded-lg p-2 transition-all cursor-pointer hover:shadow-sm "+(r?"bg-red-50 hover:bg-red-100 border-red-200":"bg-white hover:bg-gray-50 border-gray-200"),onClick:()=>{Q(e),G(!0)},children:n.jsxs("div",{className:"flex items-center justify-between gap-2",children:[n.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[n.jsx("span",{className:"card-title",children:e.purchase_order_number||`PO-${e.id.slice(0,8)}`}),n.jsx("span",{className:"card-subtitle truncate",children:e.vendor_name||"업체명 없음"}),n.jsxs("span",{className:"card-description truncate",children:[s.item_name||"품목",a.length>1&&n.jsxs("span",{className:"text-gray-400",children:[" 외 ",a.length-1,"건"]})]}),t>3&&n.jsxs(o,{variant:"outline",className:"badge-text px-1.5 py-0 flex-shrink-0",children:[t,"일"]})]}),n.jsx("div",{children:n.jsx(i,{size:"sm",variant:"outline",className:"h-7 px-2 badge-text border-orange-200 hover:bg-orange-50",onClick:a=>{a.stopPropagation(),oe(e)},disabled:K.has(e.id),children:K.has(e.id)?n.jsx("div",{className:"w-3 h-3 border border-orange-600 border-t-transparent rounded-full animate-spin"}):n.jsxs(n.Fragment,{children:[n.jsx(w,{className:"w-3 h-3 mr-1"}),"다운로드"]})})})]})},e.id)})})]})})]}),ue&&n.jsxs(m,{className:"w-full col-span-1 row-span-2",children:[n.jsx(u,{className:"pb-2 pt-3",children:n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs(p,{className:"section-title flex items-center gap-1.5",children:[n.jsx(D,{className:"w-3.5 h-3.5 text-orange-500"}),"승인 대기",e.pendingApprovals.length>0&&n.jsx(o,{variant:"destructive",className:"badge-text h-4 px-1",children:e.pendingApprovals.length})]}),e.pendingApprovals.length>0&&n.jsx(i,{size:"sm",variant:"ghost",onClick:()=>re("/purchase"),className:"h-6 px-2",children:n.jsx(S,{className:"w-3 h-3"})})]})}),n.jsx(h,{className:"p-3",children:0===e.pendingApprovals.length?n.jsxs("div",{className:"text-center py-4 text-gray-400",children:[n.jsx(f,{className:"w-6 h-6 mx-auto mb-1"}),n.jsx("p",{className:"card-description",children:"대기 항목 없음"})]}):n.jsxs("div",{className:"space-y-3",children:[n.jsxs("div",{className:"relative",children:[n.jsx(q,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),n.jsx(_,{placeholder:"발주번호, 업체명, 품목으로 검색...",value:se.pending,onChange:e=>te(a=>({...a,pending:e.target.value})),className:"pl-10 h-8 text-xs"})]}),n.jsx("div",{style:{maxHeight:"36rem",overflowY:"auto",display:"flex",flexDirection:"column",gap:"0.375rem"},children:ce(e.pendingApprovals,se.pending).slice(0,10).map((e,a)=>{const s=e.purchase_request_items||[],t=s[0]||{};e.total_amount||s.reduce((e,a)=>e+(Number(a.amount_value)||0),0);const r="선진행"===e.progress_type;return n.jsx("div",{className:"border rounded-lg p-2 hover:shadow-sm transition-all cursor-pointer mb-1.5 "+(r?"bg-red-50 border-red-200":"hover:bg-orange-50/30"),style:{display:"block"},onClick:a=>{a.target.closest("button")||(M(Number(e.id)),$(!0))},children:n.jsxs("div",{className:"flex items-center justify-between gap-2",children:[n.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[n.jsx("span",{className:"card-title",children:e.purchase_order_number}),n.jsx("span",{className:"card-subtitle truncate",children:e.vendor_name||"업체"}),n.jsxs("span",{className:"card-description truncate",children:[t.item_name||"품목"," ",s.length>1&&`외 ${s.length-1}건`]})]}),n.jsx(i,{size:"sm",onClick:a=>{a.stopPropagation(),ie(e.id)},disabled:I===e.id,className:"h-7 px-2 text-white badge-text shrink-0 "+("approved"===e.middle_manager_status?"bg-blue-600 hover:bg-blue-700":"bg-green-600 hover:bg-green-700"),children:I===e.id?n.jsx("div",{className:"w-3 h-3 border border-white border-t-transparent rounded-full animate-spin"}):n.jsxs(n.Fragment,{children:["approved"===e.middle_manager_status?"최종":"1차"," 승인"]})})]})},`approval-${e.id}`)})})]})})]}),F.includes("lead buyer")&&n.jsxs(m,{className:"w-full col-span-1 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[n.jsx(u,{className:"py-3 px-4 bg-gray-50 border-b",children:n.jsxs(p,{className:"section-title flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(d,{className:"w-4 h-4 text-yellow-600"}),n.jsx("span",{children:"구매 대기"})]}),e.myPurchaseStatus&&e.myPurchaseStatus.waitingPurchase&&e.myPurchaseStatus.waitingPurchase.length>0&&n.jsx(o,{className:"bg-yellow-100 text-yellow-700 border-yellow-200 px-2 py-0.5",children:e.myPurchaseStatus.waitingPurchase.length})]})}),n.jsx(h,{className:"p-4",children:e.myPurchaseStatus&&e.myPurchaseStatus.waitingPurchase&&0!==e.myPurchaseStatus.waitingPurchase.length?n.jsxs("div",{className:"space-y-3",children:[n.jsxs("div",{className:"relative",children:[n.jsx(q,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),n.jsx(_,{placeholder:"발주번호, 업체명, 품목으로 검색...",value:se.purchase,onChange:e=>te(a=>({...a,purchase:e.target.value})),className:"pl-10 h-8 text-xs"})]}),n.jsx("div",{className:"space-y-2 h-[36rem] overflow-y-auto",children:ce(e.myPurchaseStatus.waitingPurchase,se.purchase).slice(0,10).map(e=>{const a=e.purchase_request_items||[],s=a[0];a.reduce((e,a)=>e+(Number(a.amount_value)||0),0);const t=(e.progress_type||"").includes("선진행");return n.jsx("div",{className:"border rounded-lg p-3 transition-all hover:shadow-sm "+(t?"bg-red-50 hover:bg-red-100 border-red-200":"bg-white hover:bg-gray-50 border-gray-200"),children:n.jsxs("div",{className:"flex items-center justify-between gap-2",children:[n.jsxs("div",{className:"flex items-center gap-2 flex-1 cursor-pointer",onClick:()=>de(e,"purchase"),children:[n.jsx("span",{className:"card-title",children:e.purchase_order_number||`PO-${e.id.slice(0,8)}`}),n.jsx("span",{className:"card-subtitle truncate",children:e.vendor_name||"업체명 없음"}),n.jsxs("span",{className:"card-description truncate",children:[s?.item_name||"품목",a.length>1&&n.jsxs("span",{className:"text-gray-400",children:[" 외 ",a.length-1,"건"]})]})]}),(F.includes("lead buyer")||F.includes("app_admin"))&&!e.is_payment_completed&&n.jsx(i,{size:"sm",onClick:async a=>{if(a.stopPropagation(),confirm("이 발주를 구매완료 처리하시겠습니까?"))try{const{error:a}=await ne.from("purchase_requests").update({is_payment_completed:!0,payment_completed_at:(new Date).toISOString()}).eq("id",e.id);if(a)throw a;c.success("구매완료 처리되었습니다."),le(!1)}catch(s){c.error("처리 중 오류가 발생했습니다.")}},className:"bg-yellow-600 hover:bg-yellow-700 text-white h-7 px-2 badge-text shrink-0",children:"구매완료"}),e.is_payment_completed&&n.jsx("div",{className:"bg-green-100 text-green-700 px-2 py-1 business-radius-badge badge-text shrink-0",children:"완료됨"})]})},e.id)})})]}):n.jsxs("div",{className:"text-center py-12 text-gray-400",children:[n.jsx(d,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),n.jsx("p",{className:"card-subtitle",children:"구매 대기 항목이 없습니다"})]})})]}),n.jsxs(m,{className:"w-full col-span-1 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[n.jsx(u,{className:"py-3 px-4 bg-gray-50 border-b",children:n.jsxs(p,{className:"section-title flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(b,{className:"w-4 h-4 text-blue-600"}),n.jsx("span",{children:"입고 대기"})]}),e.myPurchaseStatus.waitingDelivery.length>0&&n.jsx(o,{className:"bg-blue-100 text-blue-700 border-blue-200 px-2 py-0.5",children:e.myPurchaseStatus.waitingDelivery.length})]})}),n.jsx(h,{className:"p-4",children:0===e.myPurchaseStatus.waitingDelivery.length?n.jsxs("div",{className:"text-center py-12 text-gray-400",children:[n.jsx(b,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),n.jsx("p",{className:"card-subtitle",children:"입고 대기 항목이 없습니다"})]}):n.jsxs("div",{className:"space-y-3",children:[n.jsxs("div",{className:"relative",children:[n.jsx(q,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),n.jsx(_,{placeholder:"발주번호, 업체명, 품목으로 검색...",value:se.delivery,onChange:e=>te(a=>({...a,delivery:e.target.value})),className:"pl-10 h-8 text-xs"})]}),n.jsx("div",{className:"space-y-2 h-[36rem] overflow-y-auto",children:ce(e.myPurchaseStatus.waitingDelivery,se.delivery).slice(0,10).map(e=>{const a=e.purchase_request_items||[],s=a[0],t=a.length;a.filter(e=>e.is_received).length,a.reduce((e,a)=>e+(Number(a.amount_value)||0),0);const r=(e.progress_type||"").includes("선진행");return n.jsx("div",{className:"border rounded-lg p-3 transition-all cursor-pointer hover:shadow-sm "+(r?"bg-red-50 hover:bg-red-100 border-red-200":"bg-white hover:bg-gray-50 border-gray-200"),onClick:()=>de(e,"delivery"),children:n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("span",{className:"card-title",children:e.purchase_order_number||`PO-${e.id.slice(0,8)}`}),n.jsx("span",{className:"card-subtitle truncate",children:e.vendor_name||"업체명 없음"}),n.jsxs("span",{className:"card-description truncate",children:[s?.item_name||"품목",t>1&&n.jsxs("span",{className:"text-gray-400",children:[" 외 ",t-1,"건"]})]})]})},e.id)})})]})})]})]})]}),n.jsx(v,{purchaseId:T,isOpen:U,onClose:()=>{$(!1),M(null)},currentUserRoles:F,onRefresh:()=>{le(),$(!1),M(null)}}),n.jsx(O,{isOpen:ee,onClose:()=>{ae(!1),J(null),X(null)},item:Z,type:V,onRefresh:()=>le(!1)}),Y&&H&&n.jsx(g,{open:Y,onOpenChange:()=>{G(!1),Q(null)},children:n.jsxs(x,{className:"overflow-hidden bg-white rounded-3xl shadow-2xl border-0",style:{maxWidth:"1280px",width:"90vw",maxHeight:"50vh"},showCloseButton:!1,children:[n.jsxs("div",{className:"relative px-6 pt-6 pb-4",children:[n.jsx("button",{onClick:()=>{G(!1),Q(null)},className:"absolute right-6 top-6 w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-all duration-200",children:n.jsx(l,{className:"w-4 h-4 text-gray-500"})}),n.jsx("div",{className:"pr-16",children:n.jsxs("div",{className:"flex items-start gap-4 mb-2",children:[n.jsx("div",{className:"w-10 h-10 rounded-2xl bg-orange-50 flex items-center justify-center flex-shrink-0",children:n.jsx(w,{className:"w-6 h-6 text-orange-600"})}),n.jsxs("div",{className:"min-w-0 flex-1",children:[n.jsx("h1",{className:"modal-title mb-1",children:H.purchase_order_number||"PO번호 없음"}),n.jsx("p",{className:"modal-subtitle",children:H.vendor_name||"업체명 없음"})]}),n.jsx("div",{className:"px-3 py-1.5 business-radius-badge badge-text bg-orange-50 text-orange-700 border-orange-200",children:"미다운로드"})]})})]}),n.jsxs("div",{className:"overflow-y-auto max-h-[calc(50vh-160px)] px-6 pb-4 space-y-3",children:[n.jsx("div",{className:"bg-gray-50 rounded-xl p-3 border border-gray-100",children:n.jsxs("div",{className:"grid grid-cols-3 gap-x-4 gap-y-2 text-xs",children:[n.jsxs("div",{children:[n.jsx("span",{className:"text-gray-500",children:"요청자:"})," ",n.jsx("span",{className:"font-medium",children:H.requester_name})]}),n.jsxs("div",{children:[n.jsx("span",{className:"text-gray-500",children:"요청일:"})," ",n.jsx("span",{className:"font-medium",children:new Date(H.request_date||H.created_at).toLocaleDateString("ko-KR")})]}),n.jsxs("div",{children:[n.jsx("span",{className:"text-gray-500",children:"납기요청일:"})," ",n.jsx("span",{className:"font-medium",children:H.delivery_request_date?new Date(H.delivery_request_date).toLocaleDateString("ko-KR"):"미지정"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"text-gray-500",children:"업체명:"})," ",n.jsx("span",{className:"font-medium",children:H.vendor_name||"-"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"text-gray-500",children:"결제유형:"})," ",n.jsx("span",{className:"font-medium",children:H.payment_category||"일반"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"text-gray-500",children:"진행구분:"})," ",n.jsx("span",{className:"font-medium",children:H.progress_type||"일반"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"text-gray-500",children:"프로젝트업체:"})," ",n.jsx("span",{className:"font-medium",children:H.project_vendor||"-"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"text-gray-500",children:"판매주문번호:"})," ",n.jsx("span",{className:"font-medium",children:H.sales_order_number||"-"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"text-gray-500",children:"배송지:"})," ",n.jsx("span",{className:"font-medium",children:H.shipping_address||"본사"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"text-gray-500",children:"통화:"})," ",n.jsx("span",{className:"font-medium",children:H.currency||"KRW"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"text-gray-500",children:"템플릿:"})," ",n.jsx("span",{className:"font-medium",children:H.po_template_type||"일반"})]}),H.revised_delivery_request_date&&n.jsxs("div",{children:[n.jsx("span",{className:"text-orange-500",children:"변경입고일:"})," ",n.jsx("span",{className:"font-medium text-orange-900",children:new Date(H.revised_delivery_request_date).toLocaleDateString("ko-KR")})]})]})}),n.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 overflow-hidden",children:[n.jsx("div",{className:"bg-gray-50 px-3 py-2 border-b border-gray-100",children:n.jsxs("h3",{className:"text-sm font-medium text-gray-700",children:["주문 품목 (",(H.purchase_request_items||[]).length,"개, 총 ₩",(H.purchase_request_items||[]).reduce((e,a)=>e+(Number(a.amount_value)||0),0).toLocaleString(),")"]})}),n.jsx("div",{className:"overflow-x-auto",children:n.jsxs("table",{className:"w-full text-xs table-fixed",children:[n.jsxs("colgroup",{children:[n.jsx("col",{className:"w-[30%]"}),n.jsx("col",{className:"w-[25%]"}),n.jsx("col",{className:"w-[10%]"}),n.jsx("col",{className:"w-[15%]"}),n.jsx("col",{className:"w-[20%]"})]}),n.jsx("thead",{className:"bg-gray-50 border-b border-gray-100",children:n.jsxs("tr",{children:[n.jsx("th",{className:"text-left p-2 font-medium text-gray-600",children:"품목명"}),n.jsx("th",{className:"text-left p-2 font-medium text-gray-600",children:"규격"}),n.jsx("th",{className:"text-right p-2 font-medium text-gray-600",children:"수량"}),n.jsx("th",{className:"text-right p-2 font-medium text-gray-600",children:"단가"}),n.jsx("th",{className:"text-right p-2 font-medium text-gray-600",children:"금액"})]})}),n.jsx("tbody",{className:"divide-y divide-gray-100",children:(H.purchase_request_items||[]).map((e,a)=>{const s=e.quantity>0?(Number(e.amount_value)||0)/e.quantity:0;return n.jsxs("tr",{className:"hover:bg-gray-50",children:[n.jsxs("td",{className:"p-2",children:[n.jsx("div",{className:"font-medium text-gray-900",children:e.item_name||"품목명 없음"}),e.remark&&n.jsxs("div",{className:"text-xs text-amber-600 mt-1",children:["비고: ",e.remark]})]}),n.jsx("td",{className:"p-2 text-gray-600",children:e.specification||"-"}),n.jsx("td",{className:"p-2 text-right font-medium",children:e.quantity||0}),n.jsxs("td",{className:"p-2 text-right",children:["₩",s.toLocaleString()]}),n.jsxs("td",{className:"p-2 text-right font-medium",children:["₩",(Number(e.amount_value)||0).toLocaleString()]})]},a)})})]})})]})]}),n.jsx("div",{className:"sticky bottom-0 bg-white border-t border-gray-100 px-6 py-6",children:n.jsxs("div",{className:"flex items-center justify-between gap-6",children:[n.jsxs(i,{onClick:()=>oe(H),disabled:K.has(H.id),className:"bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white px-8 py-4 rounded-2xl shadow-lg transition-all duration-200 modal-subtitle",children:[K.has(H.id)?n.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-3"}):n.jsx(w,{className:"w-5 h-5 mr-3"}),"Excel 다운로드"]}),n.jsxs("div",{className:"flex items-center gap-4 ml-auto",children:[n.jsxs(i,{variant:"outline",onClick:()=>{re("/purchase/list?tab=purchase"),G(!1),Q(null)},className:"border-gray-300 text-gray-700 hover:bg-gray-50 hover:text-gray-900 hover:border-gray-400 px-8 py-4 rounded-2xl modal-subtitle transition-all duration-200",children:["발주 목록에서 보기",n.jsx(S,{className:"w-5 h-5 ml-3"})]}),n.jsx(i,{onClick:()=>{G(!1),Q(null)},className:"bg-gray-900 hover:bg-gray-800 text-white px-10 py-4 rounded-2xl modal-subtitle transition-all duration-200 shadow-lg",children:"완료"})]})]})})]})})]})}export{A as default};
//# sourceMappingURL=DashboardMain-TdWddcWg.js.map
