{"version":3,"file":"DashboardMain-h_ayNYF4.js","sources":["../../src/services/dashboardService.ts","../../src/components/dashboard/DashboardMain.tsx"],"sourcesContent":["import { createClient } from '@/lib/supabase/client'\nimport { logger } from '@/lib/logger'\nimport { purchaseMemoryCache, CACHE_DURATION, updatePurchaseInMemory } from '@/stores/purchaseMemoryStore'\nimport type { \n  DashboardData, \n  DashboardStats, \n  UrgentRequest, \n  MyRequestStatus, \n  QuickAction,\n  Employee,\n  PurchaseRequestWithDetails,\n  Purchase\n} from '@/types/purchase'\n\n// ëŒ€ì‹œë³´ë“œ ë°ì´í„° ìºì‹œ\nconst dashboardCache = {\n  data: null as DashboardData | null,\n  lastFetch: 0,\n  CACHE_DURATION: 30 * 1000, // 30ì´ˆ ìºì‹œ\n  employeeId: null as string | null\n}\n\nexport class DashboardService {\n  private supabase = createClient()\n\n  private hasValidPurchaseMemory(employee?: Employee | null): boolean {\n    if (!purchaseMemoryCache.allPurchases || purchaseMemoryCache.allPurchases.length === 0) return false\n    if (!employee?.id) return false\n    \n    const now = Date.now()\n    const lastFetch = purchaseMemoryCache.lastFetch || 0\n    const isFresh = (now - lastFetch) < CACHE_DURATION\n    const isSameUser = purchaseMemoryCache.currentUser?.id === String(employee.id)\n    \n    return isFresh && isSameUser\n  }\n\n  // ëŒ€ì‹œë³´ë“œ ìºì‹œ ë¬´íš¨í™” (ìŠ¹ì¸/ì‚­ì œ ë“± ë³€ê²½ ì‹œ ê°•ì œ ìƒˆë¡œê³ ì¹¨ ìœ ë„)\n  private invalidateDashboardCache() {\n    dashboardCache.data = null\n    dashboardCache.lastFetch = 0\n    dashboardCache.employeeId = null\n  }\n\n  // ì™¸ë¶€ì—ì„œ ëŒ€ì‹œë³´ë“œ ìºì‹œë¥¼ ë¬´íš¨í™”í•  ìˆ˜ ìˆë„ë¡ ê³µê°œ ë©”ì„œë“œ ì œê³µ\n  public invalidateCache() {\n    this.invalidateDashboardCache()\n  }\n\n  // ğŸš€ ìºì‹œ ìœ íš¨ì„± í™•ì¸ (ë¡œë”© ìŠ¤í‚µ íŒë‹¨ìš©)\n  // ëŒ€ì‹œë³´ë“œ ìºì‹œ OR ë©”ëª¨ë¦¬ ìºì‹œê°€ ìœ íš¨í•˜ë©´ true ë°˜í™˜\n  public hasValidCache(employeeId: string): boolean {\n    const now = Date.now()\n    \n    // ëŒ€ì‹œë³´ë“œ ì „ìš© ìºì‹œ í™•ì¸ (30ì´ˆ)\n    const dashboardCacheValid = \n      dashboardCache.data !== null && \n      dashboardCache.employeeId === employeeId &&\n      (now - dashboardCache.lastFetch) < dashboardCache.CACHE_DURATION\n    \n    // ë©”ëª¨ë¦¬ ìºì‹œ í™•ì¸ (30ë¶„) - ë©”ëª¨ë¦¬ê°€ ìˆìœ¼ë©´ ëŒ€ì‹œë³´ë“œë„ ë¹ ë¥´ê²Œ ê³„ì‚° ê°€ëŠ¥\n    const memoryCacheValid = this.hasValidPurchaseMemory({ id: employeeId } as Employee)\n    \n    return dashboardCacheValid || memoryCacheValid\n  }\n\n  private getPurchaseMemory(): Purchase[] {\n    return (purchaseMemoryCache.allPurchases || []) as Purchase[]\n  }\n\n  // ì—­í•  íŒŒì‹± ìœ í‹¸: ë°°ì—´/CSV ë¬¸ìì—´/ë‹¨ì¼ ë¬¸ìì—´ì„ ëª¨ë‘ ë°°ì—´ë¡œ ì •ê·œí™”\n  private parseRoles(purchaseRole: string | string[] | null | undefined): string[] {\n    let roles: string[] = []\n    \n    if (purchaseRole) {\n      if (Array.isArray(purchaseRole)) {\n        // ë°°ì—´ì¸ ê²½ìš°\n        roles = purchaseRole.map((r: any) => String(r).trim())\n      } else {\n        // ë¬¸ìì—´ì¸ ê²½ìš° (ì¼ë°˜ì )\n        const roleString = String(purchaseRole)\n        // ì‰¼í‘œë¡œ ë¶„í• í•˜ê³  ê³µë°± ì œê±°\n        roles = roleString\n          .split(',')\n          .map((r: string) => r.trim())\n          .filter((r: string) => r.length > 0)\n      }\n    }\n    \n    return roles\n  }\n\n  // ë©”ì¸ ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ\n  async getDashboardData(employee: Employee, forceRefresh = false): Promise<DashboardData> {\n    const now = Date.now()\n    const cacheValid = !forceRefresh && \n                       dashboardCache.data && \n                       dashboardCache.employeeId === employee.id &&\n                       (now - dashboardCache.lastFetch) < dashboardCache.CACHE_DURATION\n\n    // ìºì‹œê°€ ìœ íš¨í•˜ë©´ ì¦‰ì‹œ ë°˜í™˜\n    if (cacheValid && dashboardCache.data) {\n      return dashboardCache.data\n    }\n\n    // âœ… ë°œì£¼ìš”ì²­ ê´€ë¦¬ì™€ ë™ì¼í•œ ë°©ì‹: ë©”ëª¨ë¦¬ ìºì‹œ(ìµœê·¼ 2000ê±´ + í’ˆëª©) ê¸°ë°˜ìœ¼ë¡œ ëŒ€ì‹œë³´ë“œ êµ¬ì„±\n    // - DataInitializerì—ì„œ ì´ë¯¸ loadAllPurchaseDataë¥¼ ìˆ˜í–‰í•˜ë¯€ë¡œ ëŒ€ì‹œë³´ë“œ ì§„ì… ì‹œ ì¶”ê°€ DB ì¿¼ë¦¬ë¥¼ ì¤„ì¼ ìˆ˜ ìˆìŒ\n    // - ë©”ëª¨ë¦¬ê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ Supabase ì¿¼ë¦¬ ë°©ì‹ìœ¼ë¡œ í´ë°±\n    // - forceRefreshê°€ trueë©´ ë©”ëª¨ë¦¬ ìºì‹œë„ ë¬´ì‹œí•˜ê³  DBì—ì„œ ì§ì ‘ ì¡°íšŒ\n    const useMemory = !forceRefresh && this.hasValidPurchaseMemory(employee)\n\n    const results = await Promise.allSettled([\n      useMemory ? this.getDashboardStatsFromMemory(employee) : this.getDashboardStats(employee),\n      useMemory ? this.getMyRecentRequestsFromMemory(employee) : this.getMyRecentRequests(employee),\n      useMemory ? this.getPendingApprovalsFromMemory(employee) : this.getPendingApprovals(employee),\n      useMemory ? this.getQuickActionsFromMemory(employee) : this.getQuickActions(employee),\n      useMemory ? this.getTodaySummaryFromMemory(employee) : this.getTodaySummary(employee),\n      useMemory ? this.getMyPurchaseStatusFromMemory(employee) : this.getMyPurchaseStatus(employee)\n    ])\n    \n    const statsResult = results[0]\n    const myRecentRequestsResult = results[1]\n    const pendingApprovalsResult = results[2]\n    const quickActionsResult = results[3]\n    const todaySummaryResult = results[4]\n    const myPurchaseStatusResult = results[5]\n    \n    const stats: DashboardStats = statsResult.status === 'fulfilled' \n      ? statsResult.value \n      : { total: 0, myRequests: 0, pending: 0, completed: 0, urgent: 0, todayActions: 0 }\n    \n    const myRecentRequests: MyRequestStatus[] = myRecentRequestsResult.status === 'fulfilled'\n      ? myRecentRequestsResult.value\n      : []\n    \n    const pendingApprovals: PurchaseRequestWithDetails[] = pendingApprovalsResult.status === 'fulfilled'\n      ? pendingApprovalsResult.value\n      : []\n    \n    const quickActions: QuickAction[] = quickActionsResult.status === 'fulfilled'\n      ? quickActionsResult.value\n      : []\n    \n    const todaySummary = todaySummaryResult.status === 'fulfilled'\n      ? todaySummaryResult.value\n      : { approved: 0, requested: 0, received: 0 }\n    \n    const myPurchaseStatus = myPurchaseStatusResult.status === 'fulfilled'\n      ? myPurchaseStatusResult.value\n      : { waitingPurchase: [], waitingDelivery: [], recentCompleted: [] }\n    \n    // ì‹¤íŒ¨í•œ í•­ëª© ë¡œê¹…\n    if (statsResult.status === 'rejected') {\n      logger.error('[DashboardService] getDashboardStats ì‹¤íŒ¨:', statsResult.reason)\n    }\n    if (myRecentRequestsResult.status === 'rejected') {\n      logger.error('[DashboardService] getMyRecentRequests ì‹¤íŒ¨:', myRecentRequestsResult.reason)\n    }\n    if (pendingApprovalsResult.status === 'rejected') {\n      logger.error('[DashboardService] getPendingApprovals ì‹¤íŒ¨:', pendingApprovalsResult.reason)\n    }\n    if (quickActionsResult.status === 'rejected') {\n      logger.error('[DashboardService] getQuickActions ì‹¤íŒ¨:', quickActionsResult.reason)\n    }\n    if (todaySummaryResult.status === 'rejected') {\n      logger.error('[DashboardService] getTodaySummary ì‹¤íŒ¨:', todaySummaryResult.reason)\n    }\n    if (myPurchaseStatusResult.status === 'rejected') {\n      logger.error('[DashboardService] getMyPurchaseStatus ì‹¤íŒ¨:', myPurchaseStatusResult.reason)\n    }\n\n    const dashboardData: DashboardData = {\n      employee,\n      stats,\n      urgentRequests: [],\n      myRecentRequests,\n      pendingApprovals,\n      quickActions,\n      todaySummary,\n      myPurchaseStatus\n    }\n\n    // ìºì‹œ ì—…ë°ì´íŠ¸\n    dashboardCache.data = dashboardData\n    dashboardCache.lastFetch = now\n    dashboardCache.employeeId = employee.id\n\n    return dashboardData\n  }\n\n  // ===== Memory-based implementations (ë°œì£¼ìš”ì²­ ê´€ë¦¬ì™€ ë™ì¼: ë©”ëª¨ë¦¬ ìºì‹œ ê¸°ë°˜) =====\n\n  private isPendingStatus(status: any): boolean {\n    return status === 'pending' || status === 'ëŒ€ê¸°' || status === '' || status === null || status === undefined\n  }\n\n  private toTime(value?: string | null): number {\n    if (!value) return 0\n    const t = new Date(value).getTime()\n    return Number.isFinite(t) ? t : 0\n  }\n\n  async getDashboardStatsFromMemory(employee: Employee): Promise<DashboardStats> {\n    const purchases = this.getPurchaseMemory()\n    const today = new Date().toISOString().split('T')[0]\n    const roles = this.parseRoles(employee.purchase_role)\n\n    const requesterName = employee.name || employee.email\n    const monthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString()\n    const threeDaysAgo = new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString()\n\n    const total = purchases.length\n    const myRequests = purchases.filter(p => (p.requester_name || '') === employee.name).length\n    const pending = await this.getPendingCountFromMemory(employee, roles)\n    const completed = purchases.filter(p => p.is_received === true && this.toTime(p.received_at) >= this.toTime(monthStart)).length\n    const urgent = this.getUrgentCountFromMemory(employee, roles, threeDaysAgo)\n    const todayActions = this.getTodayActionsCountFromMemory(employee, today)\n\n    return { total, myRequests, pending, completed, urgent, todayActions }\n  }\n\n  async getMyRecentRequestsFromMemory(employee: Employee): Promise<MyRequestStatus[]> {\n    const purchases = this.getPurchaseMemory()\n    const requesterName = employee.name || employee.email\n\n    const filtered = purchases\n      .filter((item: any) => (item.requester_name || '') === requesterName)\n      .filter((item: any) => {\n        // ìŠ¹ì¸ ì§„í–‰ì¤‘ì¸ í•­ëª©ë§Œ (ìŠ¹ì¸ ëŒ€ê¸°ëŠ” ì œì™¸)\n        const middleApproved = item.middle_manager_status === 'approved'\n        const finalPending = this.isPendingStatus(item.final_manager_status)\n        const finalApproved = item.final_manager_status === 'approved'\n        const notPaid = !item.is_payment_completed\n        return (middleApproved && finalPending) || (finalApproved && notPaid)\n      })\n      .sort((a: any, b: any) => this.toTime(b.created_at) - this.toTime(a.created_at))\n      .slice(0, 5)\n\n    return filtered.map((item: any) => ({\n      ...item,\n      vendor_name: item.vendor_name,\n      total_items: (item.purchase_request_items || []).length,\n      progress_percentage: this.calculateProgress(item),\n      current_step: this.getCurrentStep(item),\n      next_action: this.getNextAction(item),\n      estimated_completion: this.estimateCompletion(item)\n    })) as MyRequestStatus[]\n  }\n\n  async getPendingApprovalsFromMemory(employee: Employee): Promise<PurchaseRequestWithDetails[]> {\n    const roles = this.parseRoles(employee.purchase_role)\n    if (roles.length === 0) return []\n\n    const purchases = this.getPurchaseMemory()\n\n    // ìµœì‹  ìˆœ ì •ë ¬ í›„ ì²˜ë¦¬ (ê¸°ì¡´ ì¿¼ë¦¬: request_date desc, limit 100)\n    const sorted = [...purchases].sort((a: any, b: any) => this.toTime(b.request_date) - this.toTime(a.request_date))\n\n    // ìŠ¹ì¸ ëŒ€ê¸°ì¸ í•­ëª©ë§Œ í•„í„°ë§\n    const filteredPending = sorted.filter((item: any) => {\n      const middlePending = this.isPendingStatus(item.middle_manager_status)\n      const finalPending = this.isPendingStatus(item.final_manager_status)\n\n      // ë°˜ë ¤ëœ ê²½ìš°ëŠ” ì œì™¸\n      const middleRejected = item.middle_manager_status === 'rejected'\n      const finalRejected = item.final_manager_status === 'rejected'\n      if (middleRejected || finalRejected) return false\n\n      return middlePending || finalPending\n    })\n\n    // ì—­í• ë³„ ê¶Œí•œì— ë”°ë¥¸ ì¶”ê°€ í•„í„°ë§\n    let roleFiltered = filteredPending\n\n    if (roles.includes('app_admin')) {\n      // all\n    } else if (roles.includes('middle_manager')) {\n      roleFiltered = filteredPending.filter((item: any) => this.isPendingStatus(item.middle_manager_status))\n    } else if (roles.includes('final_approver') || roles.includes('ceo')) {\n      roleFiltered = filteredPending.filter((item: any) => item.middle_manager_status === 'approved' && this.isPendingStatus(item.final_manager_status))\n    } else if (roles.includes('raw_material_manager') || roles.includes('consumable_manager')) {\n      roleFiltered = filteredPending.filter((item: any) => item.middle_manager_status === 'approved' && this.isPendingStatus(item.final_manager_status))\n    } else if (roles.includes('lead buyer')) {\n      roleFiltered = filteredPending.filter((item: any) => item.final_manager_status === 'approved' && !item.is_payment_completed)\n    } else {\n      roleFiltered = []\n    }\n\n    // ë°ì´í„° ê°€ê³µ: total_amount ë³´ê°•\n    const enhanced = roleFiltered.slice(0, 100).map((item: any) => {\n      const items = item.purchase_request_items || item.items || []\n      const total_amount = Number(item.total_amount) || items.reduce((sum: number, i: any) => {\n        const amount = Number(i?.amount_value) || (Number(i?.quantity) || 0) * (Number(i?.unit_price_value) || 0)\n        return sum + amount\n      }, 0)\n\n      return {\n        ...item,\n        purchase_request_items: items,\n        items,\n        total_amount,\n        vendor_name: item.vendor_name || item.project_vendor || item.vendor?.vendor_name\n      }\n    })\n\n    return enhanced as PurchaseRequestWithDetails[]\n  }\n\n  async getQuickActionsFromMemory(employee: Employee): Promise<QuickAction[]> {\n    const roles = this.parseRoles(employee.purchase_role)\n    const actions: QuickAction[] = []\n\n    if (roles.includes('app_admin') || roles.includes('middle_manager') || roles.includes('final_approver') || roles.includes('ceo')) {\n      const pendingCount = await this.getPendingCountFromMemory(employee, roles)\n      if (pendingCount > 0) {\n        actions.push({\n          id: 'approve',\n          type: 'approve',\n          label: 'ìŠ¹ì¸ ëŒ€ê¸°',\n          description: `${pendingCount}ê±´ì˜ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘`,\n          count: pendingCount,\n          color: 'red'\n        })\n      }\n    }\n\n    if (roles.includes('lead buyer') || roles.includes('lead buyer')) {\n      const purchases = this.getPurchaseMemory()\n      const purchaseCount = purchases.filter((p: any) => p.final_manager_status === 'approved' && p.is_payment_completed === false).length\n      if (purchaseCount > 0) {\n        actions.push({\n          id: 'purchase',\n          type: 'purchase',\n          label: 'êµ¬ë§¤ ì²˜ë¦¬',\n          description: `${purchaseCount}ê±´ì˜ êµ¬ë§¤ ëŒ€ê¸° ì¤‘`,\n          count: purchaseCount,\n          color: 'yellow'\n        })\n      }\n    }\n\n    return actions\n  }\n\n  async getTodaySummaryFromMemory(employee: Employee) {\n    const purchases = this.getPurchaseMemory()\n    const today = new Date().toISOString().split('T')[0]\n    const tomorrow = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().split('T')[0]\n\n    const inRange = (ts?: string | null) => {\n      const t = this.toTime(ts)\n      return t >= this.toTime(today) && t < this.toTime(tomorrow)\n    }\n\n    const approved = purchases.filter((p: any) => inRange(p.updated_at) && (p.middle_manager_status === 'approved' || p.final_manager_status === 'approved')).length\n    const requested = purchases.filter((p: any) => (p.requester_name || '') === employee.name && inRange(p.created_at)).length\n    const received = purchases.filter((p: any) => p.is_received === true && inRange(p.received_at)).length\n\n    return { approved, requested, received }\n  }\n\n  async getMyPurchaseStatusFromMemory(employee: Employee): Promise<{ waitingPurchase: PurchaseRequestWithDetails[], waitingDelivery: PurchaseRequestWithDetails[], recentCompleted: PurchaseRequestWithDetails[] }> {\n    const roles = this.parseRoles(employee.purchase_role)\n    const isLeadBuyer = roles.includes('lead buyer') || roles.includes('app_admin')\n\n    const requesterName = employee.name || employee.email\n    const purchases = this.getPurchaseMemory()\n    const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString()\n\n    // lead buyer/app_admin: ì „ì²´, ê·¸ ì™¸: ë³¸ì¸ ê²ƒë§Œ\n    const allMyRequests = isLeadBuyer\n      ? purchases\n      : purchases.filter((p: any) => (p.requester_name || '') === requesterName)\n\n    const waitingPurchase = allMyRequests.filter((item: any) => {\n      const category = (item.payment_category || '').trim()\n      const isPurchaseRequest = category === 'êµ¬ë§¤ ìš”ì²­'\n      const notPaid = !item.is_payment_completed\n      if (!isPurchaseRequest || !notPaid) return false\n\n      const isSeonJin = (item.progress_type || '').includes('ì„ ì§„í–‰')\n      if (isSeonJin) return true\n\n      const isIlban = (item.progress_type || '').includes('ì¼ë°˜') || !item.progress_type || item.progress_type === ''\n      const finalApproved = item.final_manager_status === 'approved'\n      return isIlban && finalApproved\n    })\n\n    const waitingDelivery = purchases.filter((item: any) => {\n      const notReceived = !item.is_received\n      const isSeonJin = (item.progress_type || '').includes('ì„ ì§„í–‰')\n\n      // ì…ê³  ëŒ€ê¸°ëŠ” í•­ìƒ ë³¸ì¸ ê²ƒë§Œ (ê¸°ì¡´ ë¡œì§)\n      if ((item.requester_name || '') !== requesterName) return false\n\n      if (notReceived && isSeonJin) return true\n\n      const finalApproved = item.final_manager_status === 'approved'\n      return notReceived && finalApproved\n    })\n\n    const recentCompleted = purchases.filter((item: any) => {\n      if (item.is_received !== true) return false\n      if (!item.received_at) return false\n      if ((item.requester_name || '') !== requesterName) return false\n      return this.toTime(item.received_at) >= this.toTime(sevenDaysAgo)\n    })\n\n    // ëŒ€ì‹œë³´ë“œ UIìš©: ìµœì‹ ìˆœ ì •ë ¬ (created_at desc)\n    const sortDesc = (a: any, b: any) => this.toTime(b.created_at) - this.toTime(a.created_at)\n\n    return {\n      waitingPurchase: [...waitingPurchase].sort(sortDesc) as any,\n      waitingDelivery: [...waitingDelivery].sort(sortDesc) as any,\n      recentCompleted: [...recentCompleted].sort(sortDesc) as any\n    }\n  }\n\n  private async getPendingCountFromMemory(employee: Employee, roles: string[]): Promise<number> {\n    const purchases = this.getPurchaseMemory()\n\n    if (roles.includes('app_admin')) {\n      const mid = purchases.filter((p: any) => this.isPendingStatus(p.middle_manager_status)).length\n      const fin = purchases.filter((p: any) => p.middle_manager_status === 'approved' && this.isPendingStatus(p.final_manager_status)).length\n      const pur = purchases.filter((p: any) => p.final_manager_status === 'approved' && p.is_payment_completed === false).length\n      return mid + fin + pur\n    }\n\n    if (roles.includes('middle_manager')) {\n      return purchases.filter((p: any) => this.isPendingStatus(p.middle_manager_status)).length\n    }\n\n    if (roles.includes('final_approver') || roles.includes('ceo')) {\n      return purchases.filter((p: any) => p.middle_manager_status === 'approved' && this.isPendingStatus(p.final_manager_status)).length\n    }\n\n    if (roles.includes('lead buyer')) {\n      return purchases.filter((p: any) => p.final_manager_status === 'approved' && p.is_payment_completed === false).length\n    }\n\n    return 0\n  }\n\n  private getUrgentCountFromMemory(employee: Employee, roles: string[], threeDaysAgoIso: string): number {\n    const purchases = this.getPurchaseMemory()\n    const threeDaysAgo = this.toTime(threeDaysAgoIso)\n\n    const base = purchases.filter((p: any) => this.toTime(p.created_at) > 0 && this.toTime(p.created_at) < threeDaysAgo)\n\n    if (roles.includes('app_admin')) {\n      return base.filter((p: any) =>\n        p.middle_manager_status === 'pending' ||\n        p.final_manager_status === 'pending' ||\n        p.is_payment_completed === false\n      ).length\n    }\n    if (roles.includes('middle_manager')) {\n      return base.filter((p: any) => p.middle_manager_status === 'pending').length\n    }\n    if (roles.includes('final_approver') || roles.includes('ceo')) {\n      return base.filter((p: any) => p.middle_manager_status === 'approved' && p.final_manager_status === 'pending').length\n    }\n    if (roles.includes('lead buyer')) {\n      return base.filter((p: any) => p.final_manager_status === 'approved' && p.is_payment_completed === false).length\n    }\n    return 0\n  }\n\n  private getTodayActionsCountFromMemory(employee: Employee, todayIsoDate: string): number {\n    const purchases = this.getPurchaseMemory()\n    const tomorrowIsoDate = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().split('T')[0]\n\n    const inRange = (ts?: string | null) => {\n      const t = this.toTime(ts)\n      return t >= this.toTime(todayIsoDate) && t < this.toTime(tomorrowIsoDate)\n    }\n\n    return purchases.filter((p: any) => inRange(p.updated_at) && (p.requester_name || '') === employee.name).length\n  }\n\n  // í†µê³„ ì •ë³´ (ìš°ì„ ìˆœìœ„ ì¬ì •ë ¬)\n  async getDashboardStats(employee: Employee): Promise<DashboardStats> {\n    const today = new Date().toISOString().split('T')[0]\n    const roles = this.parseRoles(employee.purchase_role)\n\n\n    // ë³‘ë ¬ ì¿¼ë¦¬ë¡œ ì„±ëŠ¥ ìµœì í™”\n    const [\n      totalResult,\n      myRequestsResult,\n      pendingResult,\n      completedResult,\n      urgentResult,\n      todayActionsResult\n    ] = await Promise.all([\n      // ì „ì²´ ìš”ì²­ ìˆ˜\n      this.supabase\n        .from('purchase_requests')\n        .select('id', { count: 'exact', head: true }),\n\n      // ë‚´ ìš”ì²­ ìˆ˜\n      this.supabase\n        .from('purchase_requests')\n        .select('id', { count: 'exact', head: true })\n        .eq('requester_name', employee.name),\n\n      // ë‚´ê°€ ì²˜ë¦¬í•´ì•¼ í•  ìŠ¹ì¸ ëŒ€ê¸°\n      this.getPendingCount(employee, roles),\n\n      // ì´ë²ˆ ë‹¬ ì™„ë£Œëœ ìš”ì²­ ìˆ˜  \n      this.supabase\n        .from('purchase_requests')\n        .select('id', { count: 'exact', head: true })\n        .eq('is_received', true)\n        .gte('received_at', new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString()),\n\n      // ê¸´ê¸‰ ìš”ì²­ ìˆ˜ (3ì¼ ì´ìƒ ëŒ€ê¸°)\n      this.getUrgentCount(employee, roles),\n\n      // ì˜¤ëŠ˜ ì²˜ë¦¬í•œ ì•¡ì…˜ ìˆ˜\n      this.getTodayActionsCount(employee, today)\n    ])\n\n    const stats = {\n      total: totalResult.count || 0,\n      myRequests: myRequestsResult.count || 0,\n      pending: pendingResult,\n      completed: completedResult.count || 0,\n      urgent: urgentResult,\n      todayActions: todayActionsResult\n    }\n\n    return stats\n  }\n\n  // ë‚´ ìµœê·¼ ìš”ì²­ ìƒíƒœ (ìŠ¹ì¸ ì§„í–‰ì¤‘ì¸ í•­ëª©ë§Œ - ìŠ¹ì¸ ëŒ€ê¸°ëŠ” ì œì™¸) - ì´ë¯¸ JOIN ìµœì í™”ë¨\n  async getMyRecentRequests(employee: Employee): Promise<MyRequestStatus[]> {\n    const { data } = await this.supabase\n      .from('purchase_requests')\n      .select('*,vendors(vendor_name),purchase_request_items(id)')\n      .eq('requester_name', employee.name)\n      // ìŠ¹ì¸ì´ ì§„í–‰ì¤‘ì¸ í•­ëª©ë§Œ (1ì°¨ ìŠ¹ì¸ë¨ + ìµœì¢… ëŒ€ê¸°ì¤‘ OR ëª¨ë“  ìŠ¹ì¸ ì™„ë£Œ + êµ¬ë§¤ ëŒ€ê¸°ì¤‘)\n      .or('and(middle_manager_status.eq.approved,final_manager_status.eq.pending),and(final_manager_status.eq.approved,is_payment_completed.eq.false)')\n      .order('created_at', { ascending: false })\n      .limit(5)\n\n    return (data || []).map((item: any) => ({\n      ...item,\n      vendor_name: item.vendors?.vendor_name,\n      total_items: item.purchase_request_items?.length || 0,\n      progress_percentage: this.calculateProgress(item),\n      current_step: this.getCurrentStep(item),\n      next_action: this.getNextAction(item),\n      estimated_completion: this.estimateCompletion(item)\n    })) as MyRequestStatus[]\n  }\n\n  // ìŠ¹ì¸ ëŒ€ê¸° í•­ëª© (ì „ì²´ ì¡°íšŒ) - JOIN ì¿¼ë¦¬ë¡œ N+1 ë¬¸ì œ í•´ê²°\n  async getPendingApprovals(employee: Employee): Promise<PurchaseRequestWithDetails[]> {\n    const roles = this.parseRoles(employee.purchase_role)\n\n    // ì—­í• ì´ ìˆëŠ” ì‚¬ìš©ìë§Œ ìŠ¹ì¸ ëŒ€ê¸° í•­ëª©ì„ ë³¼ ìˆ˜ ìˆìŒ\n    if (roles.length === 0) {\n      return []\n    }\n\n    logger.debug('ğŸš€ ìŠ¹ì¸ ëŒ€ê¸° í•­ëª© ì¡°íšŒ ì‹œì‘', {\n      employeeName: employee.name,\n      employeeRoles: roles\n    })\n\n    // âœ… N+1 ë¬¸ì œ í•´ê²°: JOINì„ ì‚¬ìš©í•˜ì—¬ í•œ ë²ˆì˜ ì¿¼ë¦¬ë¡œ ëª¨ë“  ê´€ë ¨ ë°ì´í„° ì¡°íšŒ\n    const { data: allRequests, error: requestsError } = await this.supabase\n      .from('purchase_requests')\n      .select(`\n        *,\n        vendors(vendor_name),\n        purchase_request_items(\n          id,\n          item_name,\n          specification,\n          quantity,\n          unit_price_value,\n          amount_value\n        )\n      `)\n      .order('request_date', { ascending: false })\n      .limit(100) // ì„±ëŠ¥ ìµœì í™”: 100ê°œë¡œ ì œí•œ\n\n    if (requestsError) {\n      logger.error('âŒ ìŠ¹ì¸ ëŒ€ê¸° í•­ëª© ì¡°íšŒ ì‹¤íŒ¨', requestsError)\n      return []\n    }\n\n    // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œì—ì„œ ìŠ¹ì¸ ëŒ€ê¸° ìƒíƒœ í•„í„°ë§\n    let filteredData = allRequests || []\n\n    // pending, ëŒ€ê¸°, ë¹ˆë¬¸ìì—´, null ëª¨ë‘ ëŒ€ê¸°ë¡œ ì²˜ë¦¬\n    const isPending = (status: any) => (\n      status === 'pending' || status === 'ëŒ€ê¸°' || status === '' || status === null || status === undefined\n    )\n\n    logger.debug('ğŸ” ìŠ¹ì¸ ëŒ€ê¸° í•„í„°ë§ ì „ ë°ì´í„°', {\n      totalRequests: allRequests?.length || 0\n    })\n    \n    // ìŠ¹ì¸ ëŒ€ê¸°ì¸ í•­ëª©ë§Œ í•„í„°ë§\n    filteredData = filteredData.filter((item: any) => {\n      const middlePending = isPending(item.middle_manager_status)\n      const finalPending = isPending(item.final_manager_status)\n      \n      // ë°˜ë ¤ëœ ê²½ìš°ëŠ” ì œì™¸\n      const middleRejected = item.middle_manager_status === 'rejected'\n      const finalRejected = item.final_manager_status === 'rejected'\n      \n      if (middleRejected || finalRejected) return false\n      \n      // ì¤‘ê°„ìŠ¹ì¸ ëŒ€ê¸° ë˜ëŠ” ìµœì¢…ìŠ¹ì¸ ëŒ€ê¸°\n      return middlePending || finalPending\n    })\n\n    // ì—­í• ë³„ ê¶Œí•œì— ë”°ë¥¸ ì¶”ê°€ í•„í„°ë§\n    let roleFilteredData = filteredData\n    \n    if (roles.includes('app_admin')) {\n      // app_adminì€ ëª¨ë“  ìŠ¹ì¸ ëŒ€ê¸° í•­ëª© ë³¼ ìˆ˜ ìˆìŒ (í•„í„°ë§ ì—†ìŒ)\n      logger.debug('ğŸ”‘ app_admin ê¶Œí•œìœ¼ë¡œ ëª¨ë“  ìŠ¹ì¸ëŒ€ê¸° í•­ëª© í‘œì‹œ', {\n        totalItems: roleFilteredData.length\n      })\n    } else if (roles.includes('middle_manager')) {\n      // ì¤‘ê°„ìŠ¹ì¸ì: ì¤‘ê°„ìŠ¹ì¸ ëŒ€ê¸° í•­ëª©ë§Œ\n      roleFilteredData = filteredData.filter((item: any) => isPending(item.middle_manager_status))\n      logger.debug('ğŸ”‘ middle_manager ê¶Œí•œìœ¼ë¡œ ì¤‘ê°„ìŠ¹ì¸ ëŒ€ê¸° í•­ëª©ë§Œ í‘œì‹œ', {\n        beforeFilter: filteredData.length,\n        afterFilter: roleFilteredData.length\n      })\n    } else if (roles.includes('final_approver') || roles.includes('ceo')) {\n      // ìµœì¢…ìŠ¹ì¸ì: ì¤‘ê°„ìŠ¹ì¸ ì™„ë£Œ + ìµœì¢…ìŠ¹ì¸ ëŒ€ê¸° í•­ëª©ë§Œ\n      roleFilteredData = filteredData.filter((item: any) => {\n        const middleApproved = item.middle_manager_status === 'approved'\n        const finalPending = isPending(item.final_manager_status)\n        return middleApproved && finalPending\n      })\n      logger.debug('ğŸ”‘ final_approver/ceo ê¶Œí•œìœ¼ë¡œ ìµœì¢…ìŠ¹ì¸ ëŒ€ê¸° í•­ëª©ë§Œ í‘œì‹œ', {\n        beforeFilter: filteredData.length,\n        afterFilter: roleFilteredData.length\n      })\n    } else if (roles.includes('raw_material_manager') || roles.includes('consumable_manager')) {\n      // ì›ìì¬/ì†Œëª¨í’ˆ ë§¤ë‹ˆì €: ìµœì¢…ìŠ¹ì¸ìì™€ ë™ì¼í•œ ê¶Œí•œ\n      roleFilteredData = filteredData.filter((item: any) => {\n        const middleApproved = item.middle_manager_status === 'approved'\n        const finalPending = isPending(item.final_manager_status)\n        return middleApproved && finalPending\n      })\n      logger.debug('ğŸ”‘ material_manager ê¶Œí•œìœ¼ë¡œ ìµœì¢…ìŠ¹ì¸ ëŒ€ê¸° í•­ëª©ë§Œ í‘œì‹œ', {\n        beforeFilter: filteredData.length,\n        afterFilter: roleFilteredData.length\n      })\n    } else if (roles.includes('lead buyer')) {\n      // êµ¬ë§¤ë‹´ë‹¹ì: ìµœì¢…ìŠ¹ì¸ ì™„ë£Œ + êµ¬ë§¤ ëŒ€ê¸° í•­ëª©ë§Œ\n      roleFilteredData = filteredData.filter((item: any) => {\n        const finalApproved = item.final_manager_status === 'approved'\n        const purchasePending = !item.is_payment_completed\n        return finalApproved && purchasePending\n      })\n      logger.debug('ğŸ”‘ lead buyer ê¶Œí•œìœ¼ë¡œ êµ¬ë§¤ ëŒ€ê¸° í•­ëª©ë§Œ í‘œì‹œ', {\n        beforeFilter: filteredData.length,\n        afterFilter: roleFilteredData.length\n      })\n    } else {\n      // ê¸°íƒ€ ì—­í• ì€ ìŠ¹ì¸ ê¶Œí•œ ì—†ìŒ\n      roleFilteredData = []\n      logger.debug('ğŸ”‘ ìŠ¹ì¸ ê¶Œí•œ ì—†ëŠ” ì—­í• ', { roles, result: 'empty' })\n    }\n\n    // âœ… ë°ì´í„° ê°€ê³µ: JOINìœ¼ë¡œ ê°€ì ¸ì˜¨ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì²˜ë¦¬\n    const enhancedData = roleFilteredData.map((item: any) => {\n      // vendor_name ì²˜ë¦¬ (JOIN ê²°ê³¼ ì‚¬ìš©)\n      const vendor_name = item.vendors?.vendor_name || item.vendor_name || 'ì—…ì²´ ì •ë³´ ì—†ìŒ'\n      \n      // purchase_request_items ì²˜ë¦¬ (ì´ë¯¸ JOINìœ¼ë¡œ ê°€ì ¸ì˜´)\n      const purchase_request_items = item.purchase_request_items || []\n      \n      // total_amount ê³„ì‚°\n      const total_amount = purchase_request_items.reduce((sum: number, i: any) => {\n        const amount = Number(i?.amount_value) || (Number(i?.quantity) || 0) * (Number(i?.unit_price_value) || 0)\n        return sum + amount\n      }, 0)\n\n      return {\n        ...item,\n        vendor_name,\n        purchase_request_items,\n        total_amount\n      }\n    })\n    \n    logger.debug('âœ… ìŠ¹ì¸ ëŒ€ê¸° í•­ëª© ì¡°íšŒ ì™„ë£Œ (ìµœì í™”ë¨)', {\n      finalCount: enhancedData.length,\n      performanceNote: 'N+1 ë¬¸ì œ í•´ê²° - ë‹¨ì¼ JOIN ì¿¼ë¦¬ ì‚¬ìš©'\n    })\n\n    return enhancedData\n  }\n\n  // ë¹ ë¥¸ ì•¡ì…˜ ë²„íŠ¼ ë°ì´í„°\n  async getQuickActions(employee: Employee): Promise<QuickAction[]> {\n    const roles = this.parseRoles(employee.purchase_role)\n\n    const actions: QuickAction[] = []\n\n    // ìŠ¹ì¸ ê¶Œí•œì´ ìˆëŠ” ê²½ìš°\n    if (roles.includes('app_admin') || roles.includes('middle_manager') || roles.includes('final_approver') || roles.includes('ceo')) {\n      const pendingCount = await this.getPendingCount(employee, roles)\n      if (pendingCount > 0) {\n        actions.push({\n          id: 'approve',\n          type: 'approve',\n          label: 'ìŠ¹ì¸ ëŒ€ê¸°',\n          description: `${pendingCount}ê±´ì˜ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘`,\n          count: pendingCount,\n          color: 'red'\n        })\n      }\n    }\n\n    // êµ¬ë§¤ ê¶Œí•œì´ ìˆëŠ” ê²½ìš°\n    if (roles.includes('lead buyer') || roles.includes('lead buyer')) {\n      const { count: purchaseCount } = await this.supabase\n        .from('purchase_requests')\n        .select('id', { count: 'exact', head: true })\n        .eq('final_manager_status', 'approved')\n        .eq('is_payment_completed', false)\n\n      if (purchaseCount && purchaseCount > 0) {\n        actions.push({\n          id: 'purchase',\n          type: 'purchase',\n          label: 'êµ¬ë§¤ ì²˜ë¦¬',\n          description: `${purchaseCount}ê±´ì˜ êµ¬ë§¤ ëŒ€ê¸° ì¤‘`,\n          count: purchaseCount,\n          color: 'yellow'\n        })\n      }\n    }\n\n    return actions\n  }\n\n  // ì˜¤ëŠ˜ ìš”ì•½ ì •ë³´\n  async getTodaySummary(employee: Employee) {\n    const today = new Date().toISOString().split('T')[0]\n    const tomorrow = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().split('T')[0]\n\n    const [approvedResult, requestedResult, receivedResult] = await Promise.all([\n      // ì˜¤ëŠ˜ ë‚´ê°€ ìŠ¹ì¸í•œ ê±´ìˆ˜\n      this.supabase\n        .from('purchase_requests')\n        .select('id', { count: 'exact', head: true })\n        .gte('updated_at', today)\n        .lt('updated_at', tomorrow)\n        .or('middle_manager_status.eq.approved,final_manager_status.eq.approved'),\n\n      // ì˜¤ëŠ˜ ë‚´ê°€ ìš”ì²­í•œ ê±´ìˆ˜\n      this.supabase\n        .from('purchase_requests')\n        .select('id', { count: 'exact', head: true })\n        .eq('requester_name', employee.name)\n        .gte('created_at', today)\n        .lt('created_at', tomorrow),\n\n      // ì˜¤ëŠ˜ ì…ê³  ì²˜ë¦¬í•œ ê±´ìˆ˜\n      this.supabase\n        .from('purchase_requests')\n        .select('id', { count: 'exact', head: true })\n        .eq('is_received', true)\n        .gte('received_at', today)\n        .lt('received_at', tomorrow)\n    ])\n\n    return {\n      approved: approvedResult.count || 0,\n      requested: requestedResult.count || 0,\n      received: receivedResult.count || 0\n    }\n  }\n\n  // ë‚´ êµ¬ë§¤/ì…ê³  ìƒíƒœ í™•ì¸ - JOIN ì¿¼ë¦¬ë¡œ ìµœì í™”ë¨\n  async getMyPurchaseStatus(employee: Employee): Promise<{ waitingPurchase: PurchaseRequestWithDetails[], waitingDelivery: PurchaseRequestWithDetails[], recentCompleted: PurchaseRequestWithDetails[] }> {\n    \n    const roles = this.parseRoles(employee.purchase_role)\n    const isLeadBuyer = roles.includes('lead buyer') || roles.includes('app_admin')\n    \n    // nameì´ ì—†ìœ¼ë©´ email ì‚¬ìš©\n    const requesterName = employee.name || employee.email\n    \n    const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString()\n\n    // âœ… JOINì„ ì‚¬ìš©í•˜ì—¬ í•œ ë²ˆì˜ ì¿¼ë¦¬ë¡œ ëª¨ë“  ê´€ë ¨ ë°ì´í„° ì¡°íšŒ\n    // lead buyer ë˜ëŠ” app_adminì€ ëª¨ë“  í•­ëª© ì¡°íšŒ, ê·¸ ì™¸ëŠ” ë³¸ì¸ ê²ƒë§Œ\n    // PurchaseItemsModalê³¼ ë™ì¼í•œ ë°ì´í„° êµ¬ì¡°ë¥¼ ìœ„í•´ purchase_request_items ì „ì²´ í•„ë“œ ì¡°íšŒ\n    let query = this.supabase\n      .from('purchase_requests')\n      .select('*,vendors(vendor_name),purchase_request_items(*)')\n      .order('created_at', { ascending: false })\n      .limit(500)  // ì¶©ë¶„í•œ ê°œìˆ˜ë¡œ ì¦ê°€\n    \n    if (!isLeadBuyer) {\n      query = query.eq('requester_name', requesterName)\n    }\n    \n    const myRequests = await query\n\n    if (myRequests.error) {\n      logger.error('getMyPurchaseStatus ì—ëŸ¬', myRequests.error)\n      return {\n        waitingPurchase: [],\n        waitingDelivery: [],\n        recentCompleted: []\n      }\n    }\n\n    const allMyRequests = myRequests.data || []\n    \n\n    // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ í•„í„°ë§ (PurchaseListMain êµ¬ë§¤/ì…ê³  íƒ­ê³¼ ë™ì¼í•œ ë¡œì§)\n    \n    const waitingPurchase = allMyRequests.filter((item: any) => {\n      // êµ¬ë§¤ ëŒ€ê¸°: êµ¬ë§¤ ìš”ì²­ + ê²°ì œ ë¯¸ì™„ë£Œ + (ì„ ì§„í–‰ì´ê±°ë‚˜ ìµœì¢…ìŠ¹ì¸ì™„ë£Œ)\n      const category = (item.payment_category || '').trim()\n      const isPurchaseRequest = category === 'êµ¬ë§¤ ìš”ì²­'\n      const notPaid = !item.is_payment_completed\n      \n      // êµ¬ë§¤ ìš”ì²­ì´ ì•„ë‹ˆê±°ë‚˜ ì´ë¯¸ ê²°ì œ ì™„ë£Œëœ ê²ƒì€ ì œì™¸\n      if (!isPurchaseRequest || !notPaid) return false\n      \n      const isSeonJin = (item.progress_type || '').includes('ì„ ì§„í–‰')\n      \n      // ì„ ì§„í–‰ì€ ìŠ¹ì¸ ìƒíƒœì™€ ë¬´ê´€í•˜ê²Œ êµ¬ë§¤ ëŒ€ê¸°\n      if (isSeonJin) {\n        return true\n      }\n      \n      // ì¼ë°˜ì€ ìµœì¢… ìŠ¹ì¸ ì™„ë£Œë˜ì–´ì•¼ êµ¬ë§¤ ëŒ€ê¸°\n      const isIlban = (item.progress_type || '').includes('ì¼ë°˜') || !item.progress_type || item.progress_type === ''\n      const finalApproved = item.final_manager_status === 'approved'\n      \n      return isIlban && finalApproved\n    })\n\n\n    const waitingDelivery = allMyRequests.filter((item: any) => {\n      // ì…ê³  íƒ­ ë¡œì§: ì…ê³  ë¯¸ì™„ë£Œ + ì„ ì§„í–‰(ìŠ¹ì¸ë¬´ê´€) OR ìµœì¢…ìŠ¹ì¸\n      const notReceived = !item.is_received\n      const isSeonJin = (item.progress_type || '').includes('ì„ ì§„í–‰')\n      \n      // ì…ê³  ëŒ€ê¸°ëŠ” í•­ìƒ ë³¸ì¸ ê²ƒë§Œ (lead buyerë„ ë³¸ì¸ ê²ƒë§Œ)\n      if (item.requester_name !== requesterName) {\n        return false\n      }\n      \n      // ì„ ì§„í–‰ì€ ìŠ¹ì¸ ìƒíƒœì™€ ë¬´ê´€í•˜ê²Œ ì…ê³  ëŒ€ê¸°\n      if (notReceived && isSeonJin) {\n        return true\n      }\n      \n      // ì¼ë°˜ì€ ìµœì¢… ìŠ¹ì¸ ì™„ë£Œë˜ì–´ì•¼ ì…ê³  ëŒ€ê¸°\n      const finalApproved = item.final_manager_status === 'approved'\n      \n      return notReceived && finalApproved\n    })\n\n\n    const recentCompleted = allMyRequests.filter((item: any) => {\n      // ì…ê³  ì™„ë£Œ && 7ì¼ ì´ë‚´ && ë³¸ì¸ ê²ƒë§Œ\n      if (item.is_received !== true) return false\n      if (!item.received_at) return false\n      if (item.requester_name !== requesterName) return false\n      \n      const receivedDate = new Date(item.received_at)\n      const sevenDaysAgoDate = new Date(sevenDaysAgo)\n      return receivedDate >= sevenDaysAgoDate\n    })\n\n\n    return {\n      waitingPurchase: waitingPurchase,\n      waitingDelivery: waitingDelivery,\n      recentCompleted: recentCompleted\n    }\n  }\n\n  // ì›í´ë¦­ ìŠ¹ì¸ API\n  async quickApprove(\n    requestId: string,\n    employee: Employee\n  ): Promise<{ success: boolean; stage?: 'middle' | 'final'; error?: string }> {\n    try {\n      const roles = this.parseRoles(employee.purchase_role)\n\n      // ë¨¼ì € í˜„ì¬ ìš”ì²­ì˜ ìƒíƒœë¥¼ í™•ì¸\n      const { data: request } = await this.supabase\n        .from('purchase_requests')\n        .select('middle_manager_status, final_manager_status')\n        .eq('id', requestId)\n        .single()\n\n      if (!request) {\n        return { success: false, error: 'ìš”ì²­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }\n      }\n\n      let updateData: any = {}\n      let stage: 'middle' | 'final' | null = null\n\n      // pending, ëŒ€ê¸°, null, ë¹ˆ ë¬¸ìì—´ ëª¨ë‘ ëŒ€ê¸° ìƒíƒœë¡œ ê°„ì£¼\n      const isPending = (status: any) =>\n        status === 'pending' || status === 'ëŒ€ê¸°' || status === '' || status === null || status === undefined\n\n      if (roles.includes('app_admin')) {\n        if (isPending(request.middle_manager_status)) {\n          updateData = {\n            middle_manager_status: 'approved'\n          }\n          stage = 'middle'\n        } else if (request.middle_manager_status === 'approved' && isPending(request.final_manager_status)) {\n          updateData = {\n            final_manager_status: 'approved'\n          }\n          stage = 'final'\n        }\n      } else if (roles.includes('middle_manager')) {\n        if (isPending(request.middle_manager_status)) {\n          updateData = {\n            middle_manager_status: 'approved'\n          }\n          stage = 'middle'\n        }\n      } else if (roles.includes('final_approver') || roles.includes('ceo')) {\n        if (request.middle_manager_status === 'approved' && isPending(request.final_manager_status)) {\n          updateData = {\n            final_manager_status: 'approved'\n          }\n          stage = 'final'\n        }\n      } else if (roles.includes('raw_material_manager') || roles.includes('consumable_manager')) {\n        // raw_material_managerì™€ consumable_managerë„ ìµœì¢… ìŠ¹ì¸ ê¶Œí•œì´ ìˆìŒ\n        if (request.middle_manager_status === 'approved' && isPending(request.final_manager_status)) {\n          updateData = {\n            final_manager_status: 'approved'\n          }\n          stage = 'final'\n        }\n      }\n\n      // updateDataê°€ ë¹„ì–´ìˆìœ¼ë©´ ìŠ¹ì¸í•  ë‹¨ê³„ê°€ ì—†ìŒ\n      if (!stage || Object.keys(updateData).length === 0) {\n        return { success: false, error: 'ìŠ¹ì¸í•  ìˆ˜ ìˆëŠ” ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤.' }\n      }\n\n      const { error } = await this.supabase\n        .from('purchase_requests')\n        .update(updateData)\n        .eq('id', requestId)\n\n      if (error) {\n        // Error details are handled by the caller\n        throw error\n      }\n\n      // ë©”ëª¨ë¦¬ ìºì‹œ ì—…ë°ì´íŠ¸ (ìˆì„ ë•Œë§Œ)\n      updatePurchaseInMemory(requestId, (purchase) => ({\n        ...purchase,\n        ...updateData\n      }))\n\n      // ëŒ€ì‹œë³´ë“œ ìºì‹œ ë¬´íš¨í™” â†’ ë‹¤ìŒ ë¡œë“œ ì‹œ ê°•ì œ ìƒˆë¡œê³ ì¹¨\n      this.invalidateDashboardCache()\n\n      return { success: true, stage }\n    } catch (error) {\n      return { success: false, error: (error as Error).message }\n    }\n  }\n\n  // Helper methods\n  private async getPendingCount(employee: Employee, roles: string[]): Promise<number> {\n    // ê³µí†µ: 'ëŒ€ê¸°', null, ë¹ˆ ë¬¸ìì—´ë„ ëŒ€ê¸° ìƒíƒœë¡œ ê°„ì£¼\n    const pendingClause = (col: string) => (\n      `${col}.in.(pending,ëŒ€ê¸°),${col}.is.null`\n    )\n\n    // ì—­í• ë³„ ì¹´ìš´íŠ¸ ì¿¼ë¦¬ êµ¬ì„±\n    if (roles.includes('app_admin')) {\n      // 1) ì¤‘ê°„ ìŠ¹ì¸ ëŒ€ê¸° + 2) ìµœì¢… ìŠ¹ì¸ ëŒ€ê¸°(ì¤‘ê°„ ìŠ¹ì¸ ì™„ë£Œ) + 3) êµ¬ë§¤ ëŒ€ê¸°(ìµœì¢… ìŠ¹ì¸ ì™„ë£Œ)\n      const [mid, fin, pur] = await Promise.all([\n        this.supabase\n          .from('purchase_requests')\n          .select('id', { count: 'exact', head: true })\n          .or(`middle_manager_status.in.(pending,ëŒ€ê¸°),middle_manager_status.is.null`),\n        this.supabase\n          .from('purchase_requests')\n          .select('id', { count: 'exact', head: true })\n          .eq('middle_manager_status', 'approved')\n          .or(`final_manager_status.in.(pending,ëŒ€ê¸°),final_manager_status.is.null`),\n        this.supabase\n          .from('purchase_requests')\n          .select('id', { count: 'exact', head: true })\n          .eq('final_manager_status', 'approved')\n          .eq('is_payment_completed', false)\n      ])\n\n      const total = (mid.count || 0) + (fin.count || 0) + (pur.count || 0)\n      return total\n    }\n\n    if (roles.includes('middle_manager')) {\n      const { count, error } = await this.supabase\n        .from('purchase_requests')\n        .select('id', { count: 'exact', head: true })\n        .or(`middle_manager_status.in.(pending,ëŒ€ê¸°),middle_manager_status.is.null`)\n\n      if (error) {\n        // Count error for middle_manager - will use 0\n        return 0\n      }\n      return count || 0\n    }\n\n    if (roles.includes('final_approver') || roles.includes('ceo')) {\n      const { count, error } = await this.supabase\n        .from('purchase_requests')\n        .select('id', { count: 'exact', head: true })\n        .eq('middle_manager_status', 'approved')\n        .or(`final_manager_status.in.(pending,ëŒ€ê¸°),final_manager_status.is.null`)\n\n      if (error) {\n        // Count error for final_approver/ceo - will use 0\n        return 0\n      }\n      return count || 0\n    }\n\n    if (roles.includes('lead buyer')) {\n      const { count, error } = await this.supabase\n        .from('purchase_requests')\n        .select('id', { count: 'exact', head: true })\n        .eq('final_manager_status', 'approved')\n        .eq('is_payment_completed', false)\n\n      if (error) {\n        // Count error for lead buyer - will use 0\n        return 0\n      }\n      return count || 0\n    }\n\n    return 0\n  }\n\n  private async getUrgentCount(employee: Employee, roles: string[]): Promise<number> {\n    // ì—­í• ì´ ì—†ìœ¼ë©´ ê¸´ê¸‰ ìš”ì²­ ì¹´ìš´íŠ¸ë„ 0\n    if (roles.length === 0) {\n      return 0\n    }\n\n    const threeDaysAgo = new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString()\n    \n    let query = this.supabase\n      .from('purchase_requests')\n      .select('id', { count: 'exact', head: true })\n      .lt('created_at', threeDaysAgo)\n\n    if (roles.includes('app_admin')) {\n      query = query.or('middle_manager_status.eq.pending,final_manager_status.eq.pending,is_payment_completed.eq.false')\n    } else if (roles.includes('middle_manager')) {\n      query = query.eq('middle_manager_status', 'pending')\n    } else if (roles.includes('final_approver') || roles.includes('ceo')) {\n      query = query\n        .eq('middle_manager_status', 'approved')\n        .eq('final_manager_status', 'pending')\n    } else if (roles.includes('lead buyer')) {\n      query = query\n        .eq('final_manager_status', 'approved')\n        .eq('is_payment_completed', false)\n    } else {\n      return 0\n    }\n\n    const { count } = await query\n    return count || 0\n  }\n\n  private async getTodayActionsCount(employee: Employee, today: string): Promise<number> {\n    // middle_manager_idì™€ final_manager_id ì»¬ëŸ¼ì´ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ\n    // ì˜¤ëŠ˜ ì—…ë°ì´íŠ¸ëœ ìš”ì²­ ì¤‘ í•´ë‹¹ ì§ì›ì´ ìš”ì²­í•œ ìš”ì²­ë§Œ ì¹´ìš´íŠ¸\n    const tomorrow = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().split('T')[0]\n    \n    const { count } = await this.supabase\n      .from('purchase_requests')\n      .select('id', { count: 'exact', head: true })\n      .gte('updated_at', today)\n      .lt('updated_at', tomorrow)\n      .eq('requester_name', employee.name)\n\n    return count || 0\n  }\n\n  // ì „ì²´ ì…ê³ ëŒ€ê¸° ê±´ìˆ˜ ì¡°íšŒ (ê¶Œí•œì— ê´€ê³„ì—†ì´ ì „ì²´ ì¡°íšŒ)\n  async getTotalDeliveryWaitingCount(): Promise<number> {\n    const { count } = await this.supabase\n      .from('purchase_requests')\n      .select('id', { count: 'exact', head: true })\n      .eq('is_received', false)\n      .or('is_payment_completed.eq.true,progress_type.ilike.%ì„ ì§„í–‰%')\n\n    return count || 0\n  }\n\n  private calculateProgress(request: any): number {\n    let progress = 0\n    \n    if (request.middle_manager_status === 'approved') progress += 25\n    if (request.final_manager_status === 'approved') progress += 25\n    if (request.is_payment_completed) progress += 25\n    if (request.is_received) progress += 25\n    \n    return progress\n  }\n\n  private getCurrentStep(request: any): 'approval' | 'purchase' | 'delivery' | 'payment' | 'completed' {\n    if (request.is_received) return 'completed'\n    if (request.is_payment_completed) return 'delivery'\n    if (request.final_manager_status === 'approved') return 'purchase'\n    return 'approval'\n  }\n\n  private getNextAction(request: any): string {\n    if (request.middle_manager_status === 'pending') return 'ì¤‘ê°„ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘'\n    if (request.final_manager_status === 'pending') return 'ìµœì¢… ìŠ¹ì¸ ëŒ€ê¸° ì¤‘'\n    if (!request.is_payment_completed) return 'êµ¬ë§¤ ì²˜ë¦¬ ëŒ€ê¸° ì¤‘'\n    if (!request.is_received) return 'ì…ê³  ëŒ€ê¸° ì¤‘'\n    return 'ì™„ë£Œ'\n  }\n\n  private estimateCompletion(request: any): string {\n    const created = new Date(request.created_at)\n    const today = new Date()\n    const daysPassed = Math.floor((today.getTime() - created.getTime()) / (1000 * 60 * 60 * 24))\n    \n    // í‰ê·  ì²˜ë¦¬ ì‹œê°„ì„ ê¸°ë°˜ìœ¼ë¡œ ì˜ˆìƒ ì™„ë£Œì¼ ê³„ì‚°\n    let estimatedDays = 7 // ê¸°ë³¸ 7ì¼\n    if (request.progress_type === 'ê¸´ê¸‰') estimatedDays = 3\n    \n    const estimatedCompletion = new Date(created.getTime() + estimatedDays * 24 * 60 * 60 * 1000)\n    return estimatedCompletion.toLocaleDateString('ko-KR')\n  }\n\n  // lead buyer ë˜ëŠ” app_adminì„ ìœ„í•œ ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œ ëª©ë¡ ì¡°íšŒ - ì´ë¯¸ JOIN ìµœì í™”ë¨\n  async getUndownloadedOrders(employee: Employee): Promise<PurchaseRequestWithDetails[]> {\n    const roles = this.parseRoles(employee.purchase_role)\n    \n    // lead buyer ë˜ëŠ” app_admin ê¶Œí•œ ì²´í¬\n    if (!roles.includes('lead buyer') && !roles.includes('app_admin')) {\n      logger.info('[DashboardService] ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œ ì¡°íšŒ ê¶Œí•œ ì—†ìŒ:', { roles })\n      return []\n    }\n\n    // âœ… ë©”ëª¨ë¦¬ ìºì‹œê°€ ìˆìœ¼ë©´ DB ì¡°íšŒ ì—†ì´ ì¦‰ì‹œ ê³„ì‚° (ëŒ€ì‹œë³´ë“œ ì²´ê° ì†ë„ ê°œì„ )\n    if (this.hasValidPurchaseMemory(employee)) {\n      const purchases = this.getPurchaseMemory()\n        .filter((item: any) => item.is_po_download !== true) // NULL/false í¬í•¨\n        .sort((a: any, b: any) => this.toTime(b.created_at) - this.toTime(a.created_at))\n        .slice(0, 500)\n\n      const filteredData = purchases.filter((item: any) => {\n        if (item.is_po_download === true) return false\n        if (item.progress_type === 'ì„ ì§„í–‰') return true\n        return item.final_manager_status === 'approved'\n      })\n\n      return filteredData as any\n    }\n\n    try {\n      // ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œë§Œ ë¨¼ì € ê°€ì ¸ì˜¤ê¸° (NULLì´ê±°ë‚˜ falseì¸ ê²ƒë“¤)\n      const { data, error } = await this.supabase\n        .from('purchase_requests')\n        .select(`\n          *,\n          purchase_request_items(\n            id,\n            item_name,\n            specification,\n            quantity,\n            unit_price_value,\n            amount_value\n          )\n        `)\n        .or('is_po_download.is.null,is_po_download.eq.false')\n        .order('created_at', { ascending: false })  // ìµœì‹  ìˆœìœ¼ë¡œ ì •ë ¬\n        .limit(500)  // ë” ë§ì€ ë°ì´í„° ì¡°íšŒ\n\n      if (error) {\n        logger.error('[DashboardService] ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œ ì¡°íšŒ ì¿¼ë¦¬ ì—ëŸ¬:', error)\n        throw error\n      }\n\n      // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œì—ì„œ ì¡°ê±´ì— ë§ëŠ” ê²ƒë§Œ í•„í„°ë§\n      const filteredData = (data || []).filter((item: any) => {\n        if (item.is_po_download === true) return false\n        if (item.progress_type === 'ì„ ì§„í–‰') return true\n        return item.final_manager_status === 'approved'\n      })\n\n      return filteredData\n    } catch (error) {\n      logger.error('[DashboardService] getUndownloadedOrders ì—ëŸ¬:', error)\n      throw error // ì—ëŸ¬ë¥¼ ìƒìœ„ë¡œ ì „íŒŒ\n    }\n  }\n}\n\nexport const dashboardService = new DashboardService()","\nimport { useState, useEffect, useCallback, useRef, useMemo } from 'react'\nimport { useAuth } from '@/contexts/AuthContext'\nimport { dashboardService } from '@/services/dashboardService'\nimport { createClient } from '@/lib/supabase/client'\nimport { updatePurchaseInMemory, addCacheListener, markPurchaseAsPaymentCompleted } from '@/stores/purchaseMemoryStore'\nimport { Button } from '@/components/ui/button'\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Input } from '@/components/ui/input'\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from '@/components/ui/alert-dialog'\nimport { Clock, CheckCircle, ArrowRight, X, Package, Truck, ShoppingCart, Download, Search, MessageCircle, Trash2 } from 'lucide-react'\nimport { downloadPurchaseOrderExcel } from '@/utils/excelDownload'\n\n// ëª¨ë“  ì¹´ë“œì—ì„œ ì‚¬ìš©í•˜ëŠ” ëª¨ë‹¬ (activeTabì— ë”°ë¼ ë‹¤ë¥¸ ë‚´ìš© í‘œì‹œ)\nimport PurchaseDetailModal from '@/components/purchase/PurchaseDetailModal'\nimport DeliveryDateWarningModal, { useDeliveryWarningCount } from '@/components/purchase/DeliveryDateWarningModal'\n\nimport { toast } from 'sonner'\nimport type { DashboardData, Purchase } from '@/types/purchase'\nimport { useNavigate } from 'react-router-dom'\nimport { logger } from '@/lib/logger'\nimport { supportService, type SupportInquiry } from '@/services/supportService'\nimport { format } from 'date-fns'\n\nexport default function DashboardMain() {\n  const navigate = useNavigate()\n  const { employee, currentUserRoles: userRoles, currentUserName } = useAuth()\n  \n  // ğŸš€ ë©”ëª¨ë¦¬ ìºì‹œ ê¸°ë°˜ ì¦‰ì‹œ ë Œë”ë§: ìºì‹œê°€ ìœ íš¨í•˜ë©´ ë¡œë”© ì—†ì´ ë°”ë¡œ í‘œì‹œ\n  const hasValidCache = Boolean(\n    employee?.id && \n    dashboardService.hasValidCache(employee.id)\n  )\n  \n  const [data, setData] = useState<DashboardData | null>(null)\n  const [loading, setLoading] = useState(!hasValidCache) // ìºì‹œê°€ ìˆìœ¼ë©´ ë¡œë”© ìŠ¤í‚µ\n  const [actionLoading, setActionLoading] = useState<string | null>(null)\n  const [currentUserRoles, setCurrentUserRoles] = useState<string[]>([])\n  const [undownloadedOrders, setUndownloadedOrders] = useState<any[]>([])\n  const [downloadingIds, setDownloadingIds] = useState<Set<string>>(new Set())\n  // ìµœì¢… ìŠ¹ì¸ í›„ ì ì‹œ ì¬ë“±ì¥í•˜ëŠ” ê¹œë¹¡ì„ ë°©ì§€ìš©(ì„œë²„ ì‘ë‹µ ì§€ì—° ëŒ€ë¹„)\n  const [dismissedApprovalIds, setDismissedApprovalIds] = useState<Set<string>>(new Set())\n  \n  // ë¬¸ì˜í•˜ê¸° ê´€ë ¨ (app_adminìš©)\n  const [inquiries, setInquiries] = useState<SupportInquiry[]>([])\n  const [loadingInquiries, setLoadingInquiries] = useState(false)\n  const [expandedInquiryId, setExpandedInquiryId] = useState<number | null>(null)\n  \n  const supabase = createClient()\n  \n  // PurchaseDetailModal ìƒíƒœ (ëª¨ë“  ì¹´ë“œì—ì„œ ì‚¬ìš©)\n  const [selectedPurchaseId, setSelectedPurchaseId] = useState<number | null>(null)\n  const [isModalOpen, setIsModalOpen] = useState(false)\n  const [modalActiveTab, setModalActiveTab] = useState<string>('pending') // ëª¨ë‹¬ì˜ activeTab ê°’\n  \n  // ì‚­ì œ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ ìƒíƒœ\n  const [deleteConfirmOpen, setDeleteConfirmOpen] = useState(false)\n  const [purchaseToDelete, setPurchaseToDelete] = useState<any>(null)\n  \n  // ì…ê³ ì¼ì •ì§€ì—°ì•Œë¦¼ ëª¨ë‹¬ ìƒíƒœ\n  const [isWarningModalOpen, setIsWarningModalOpen] = useState(false)\n  const hasShownWarningRef = useRef(false)\n  \n  // ê²€ìƒ‰ ìƒíƒœ\n  const [searchTerms, setSearchTerms] = useState({\n    undownloaded: '',\n    pending: '',\n    purchase: '',\n    delivery: ''\n  })\n\n  const loadDashboardData = useCallback(async (showLoading = true, forceRefresh = false) => {\n    if (!employee) {\n      logger.error('[DashboardMain] No employee data available')\n      if (showLoading) {\n        setLoading(false)\n      }\n      return\n    }\n\n    try {\n      if (showLoading && !forceRefresh && !data) {\n        setLoading(true)\n      }\n      \n      const dashboardData = await dashboardService.getDashboardData(employee, forceRefresh)\n\n      // ìµœì¢… ìŠ¹ì¸ìœ¼ë¡œ ë¡œì»¬ì—ì„œ ì œê±°ëœ í•­ëª©ì´ ì„œë²„ ì§€ì—°ìœ¼ë¡œ ì¬ë“±ì¥í•˜ì§€ ì•Šë„ë¡ í•„í„°\n      const filteredPending = dashboardData.pendingApprovals.filter(\n        (item) => !dismissedApprovalIds.has(String(item.id))\n      )\n      const removedCount = dashboardData.pendingApprovals.length - filteredPending.length\n      const adjustedStats = dashboardData.stats\n        ? { ...dashboardData.stats, pending: Math.max(0, dashboardData.stats.pending - removedCount) }\n        : dashboardData.stats\n\n      // ì„œë²„ ì‘ë‹µì— í•´ë‹¹ í•­ëª©ì´ ì‚¬ë¼ì¡Œë‹¤ë©´ setì—ì„œ ì œê±°í•´ ë©”ëª¨ë¦¬ ëˆ„ì  ë°©ì§€\n      if (removedCount > 0) {\n        setDismissedApprovalIds((prev) => {\n          const next = new Set(prev)\n          filteredPending.forEach((item) => next.delete(String(item.id)))\n          return next\n        })\n      }\n\n      setData({\n        ...dashboardData,\n        pendingApprovals: filteredPending,\n        stats: adjustedStats\n      })\n      setCurrentUserRoles(userRoles)\n      \n      // lead buyer ë˜ëŠ” app_adminì¸ ê²½ìš° ë¯¸ë‹¤ìš´ë¡œë“œ í•­ëª© ì¡°íšŒ\n      if (userRoles.includes('lead buyer') || userRoles.includes('app_admin')) {\n        try {\n          const undownloaded = await dashboardService.getUndownloadedOrders(employee)\n          logger.info('[DashboardMain] ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œ ì¡°íšŒ ê²°ê³¼:', { \n            count: undownloaded.length,\n            userRoles,\n            employeeName: employee.name,\n            sampleItems: undownloaded.slice(0, 3).map(item => ({\n              purchase_order_number: item.purchase_order_number,\n              requester_name: item.requester_name,\n              vendor_name: item.vendor_name\n            }))\n          })\n          setUndownloadedOrders(undownloaded)\n        } catch (undownloadedError) {\n          logger.error('[DashboardMain] ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œ ì¡°íšŒ ì‹¤íŒ¨:', undownloadedError)\n          toast.error('ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')\n        }\n      }\n    } catch (error) {\n      logger.error('[DashboardMain] Failed to load dashboard data:', error)\n      toast.error('ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')\n      // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ë¡œë”© ìƒíƒœ í•´ì œ\n      setLoading(false)\n      // ë¹ˆ ë°ì´í„°ë¼ë„ ì„¤ì •í•´ì„œ UIê°€ ë Œë”ë§ë˜ë„ë¡\n      setData(null)\n    } finally {\n      if (showLoading) {\n        setLoading(false)\n      }\n    }\n  }, [employee, userRoles, dismissedApprovalIds])\n\n  useEffect(() => {\n    loadDashboardData()\n  }, [loadDashboardData])\n\n  // ğŸš€ Realtime ì´ë²¤íŠ¸ êµ¬ë… - DB ë³€ê²½ ì‹œ ìë™ ìƒˆë¡œê³ ì¹¨\n  const isFirstMount = useRef(true)\n  useEffect(() => {\n    const handleCacheUpdate = () => {\n      // ì²« ë§ˆìš´íŠ¸ ì‹œì—ëŠ” ë¬´ì‹œ (ì´ˆê¸° ë¡œë“œì™€ ì¤‘ë³µ ë°©ì§€)\n      if (isFirstMount.current) {\n        isFirstMount.current = false\n        return\n      }\n      // Realtime ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ë°±ê·¸ë¼ìš´ë“œ ìƒˆë¡œê³ ì¹¨\n      loadDashboardData(false, true)\n    }\n\n    const unsubscribe = addCacheListener(handleCacheUpdate)\n    return () => unsubscribe()\n  }, [loadDashboardData])\n\n  // ë¬¸ì˜ ëª©ë¡ ì´ˆê¸° ë¡œë“œ (app_adminë§Œ)\n  useEffect(() => {\n    if (!currentUserRoles.includes('app_admin')) return\n\n    const loadInquiries = async () => {\n      try {\n        setLoadingInquiries(true)\n        const inquiryResult = await supportService.getAllInquiries()\n        if (inquiryResult.success) {\n          // ë¯¸ì²˜ë¦¬ ë¬¸ì˜ë§Œ í•„í„°ë§ (open, in_progress)\n          const pendingInquiries = inquiryResult.data.filter(\n            inq => inq.status === 'open' || inq.status === 'in_progress'\n          )\n          setInquiries(pendingInquiries)\n        }\n      } catch (inquiryError) {\n        logger.error('[DashboardMain] ë¬¸ì˜ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', inquiryError)\n      } finally {\n        setLoadingInquiries(false)\n      }\n    }\n\n    loadInquiries()\n  }, [currentUserRoles])\n\n  // ë¬¸ì˜ ëª©ë¡ ì‹¤ì‹œê°„ êµ¬ë… (app_adminë§Œ)\n  useEffect(() => {\n    if (!currentUserRoles.includes('app_admin')) return\n\n    const subscription = supportService.subscribeToInquiries((payload) => {\n      const eventType = payload?.eventType as 'INSERT' | 'UPDATE' | 'DELETE' | undefined\n      const newRow = payload?.new as SupportInquiry | undefined\n      const oldRow = payload?.old as SupportInquiry | undefined\n\n      // DELETE ì´ë²¤íŠ¸: ëª©ë¡ì—ì„œ ì œê±°\n      if (eventType === 'DELETE') {\n        const deletedId = oldRow?.id\n        if (!deletedId) return\n        setInquiries(prev => {\n          const next = prev.filter(i => i.id !== deletedId)\n          return next\n        })\n        if (expandedInquiryId === deletedId) {\n          setExpandedInquiryId(null)\n        }\n        return\n      }\n\n      // INSERT/UPDATE ì´ë²¤íŠ¸: ë¯¸ì²˜ë¦¬ ë¬¸ì˜ë§Œ ìœ ì§€í•˜ë©° ì—…ë°ì´íŠ¸\n      const row = newRow\n      if (!row?.id) return\n\n      setInquiries(prev => {\n        // ë¯¸ì²˜ë¦¬ ë¬¸ì˜ê°€ ì•„ë‹ˆë©´ ì œê±°\n        const isPending = row.status === 'open' || row.status === 'in_progress'\n        const idx = prev.findIndex(i => i.id === row.id)\n\n        if (!isPending) {\n          // ì²˜ë¦¬ ì™„ë£Œëœ ë¬¸ì˜ëŠ” ëª©ë¡ì—ì„œ ì œê±°\n          if (idx === -1) return prev\n          return prev.filter(i => i.id !== row.id)\n        }\n\n        // ë¯¸ì²˜ë¦¬ ë¬¸ì˜ëŠ” upsert\n        const next = [...prev]\n        if (idx >= 0) {\n          next[idx] = row\n        } else {\n          next.unshift(row)\n        }\n\n        // ìµœì‹ ìˆœ ì •ë ¬ (created_at ë‚´ë¦¼ì°¨ìˆœ)\n        next.sort((a, b) => {\n          const at = a.created_at ? new Date(a.created_at).getTime() : 0\n          const bt = b.created_at ? new Date(b.created_at).getTime() : 0\n          return bt - at\n        })\n        return next\n      })\n    })\n\n    return () => {\n      subscription.unsubscribe()\n    }\n  }, [currentUserRoles, expandedInquiryId])\n\n  // ë°œì£¼ ìƒì„¸ ëª¨ë‹¬ ì—´ê¸° (ë¬¸ì˜ì—ì„œ ë°œì£¼ë²ˆí˜¸ í´ë¦­ ì‹œ)\n  const openPurchaseDetailFromInquiry = async (inquiry: SupportInquiry) => {\n    try {\n      // 1) ê°€ì¥ ì •í™•í•œ ê°’: purchase_request_id (ì‹ ê·œ ë¬¸ì˜ë¶€í„° ì €ì¥ë¨)\n      if (inquiry.purchase_request_id) {\n        setSelectedPurchaseId(inquiry.purchase_request_id)\n        setModalActiveTab('done')  // ë¬¸ì˜ì—ì„œ ì—´ë¦° ë°œì£¼ëŠ” 'done' íƒ­ìœ¼ë¡œ ì„¤ì • (í’ˆëª© ì‚­ì œ ë“± ì „ì²´ ê¸°ëŠ¥ ì‚¬ìš© ê°€ëŠ¥)\n        setIsModalOpen(true)\n        return\n      }\n\n      // 2) ê³¼ê±° ë°ì´í„° í˜¸í™˜: purchase_order_numberë¡œ purchase_requestsì—ì„œ id ì¡°íšŒ\n      const orderNumber = inquiry.purchase_order_number?.trim()\n      if (!orderNumber) {\n        toast.error('ë°œì£¼ë‚´ì—­ì´ ì‚­ì œ ë˜ì—ˆê±°ë‚˜ ì—†ìŠµë‹ˆë‹¤.')\n        return\n      }\n\n      const { data, error } = await supabase\n        .from('purchase_requests')\n        .select('id')\n        .eq('purchase_order_number', orderNumber)\n        .limit(1)\n        .maybeSingle()\n\n      if (error) throw error\n      if (!data?.id) {\n        toast.error('ë°œì£¼ë‚´ì—­ì´ ì‚­ì œ ë˜ì—ˆê±°ë‚˜ ì—†ìŠµë‹ˆë‹¤.')\n        return\n      }\n\n      setSelectedPurchaseId(data.id)\n      setModalActiveTab('done')  // ë¬¸ì˜ì—ì„œ ì—´ë¦° ë°œì£¼ëŠ” 'done' íƒ­ìœ¼ë¡œ ì„¤ì • (í’ˆëª© ì‚­ì œ ë“± ì „ì²´ ê¸°ëŠ¥ ì‚¬ìš© ê°€ëŠ¥)\n      setIsModalOpen(true)\n    } catch (error) {\n      logger.error('[DashboardMain] ë°œì£¼ ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨:', error)\n      toast.error('ë°œì£¼ ìƒì„¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')\n    }\n  }\n\n  // ë¬¸ì˜ ì‚­ì œ (app_admin)\n  const handleDeleteInquiry = async (inquiryId: number) => {\n    if (!confirm('ì •ë§ë¡œ ì´ ë¬¸ì˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\nì‚­ì œëœ ë¬¸ì˜ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return\n\n    const result = await supportService.deleteInquiry(inquiryId)\n    \n    if (result.success) {\n      toast.success('ë¬¸ì˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.')\n      // ëª©ë¡ì—ì„œ ì œê±°\n      setInquiries(prev => prev.filter(inq => inq.id !== inquiryId))\n      setExpandedInquiryId(null)\n    } else {\n      toast.error(result.error || 'ë¬¸ì˜ ì‚­ì œ ì‹¤íŒ¨')\n    }\n  }\n\n  // ë°œì£¼ ì‚­ì œ í™•ì¸ ì²˜ë¦¬ (PurchaseDetailModalì—ì„œ ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ)\n  const handleConfirmDeletePurchase = async () => {\n    if (!purchaseToDelete?.id) {\n      toast.error('ì‚­ì œí•  ë°œì£¼ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.')\n      return\n    }\n\n    try {\n      const purchaseIdForDelete =\n        typeof purchaseToDelete.id === 'string' ? parseInt(purchaseToDelete.id, 10) : purchaseToDelete.id\n\n      if (!purchaseIdForDelete || Number.isNaN(purchaseIdForDelete)) {\n        toast.error('ë°œì£¼ IDê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.')\n        return\n      }\n\n      // 1) ë¬¸ì˜ ê¸°ë¡ ë³´ì¡´: support_inquiresì—ì„œ purchase_request_idë§Œ nullë¡œ ë³€ê²½\n      const { error: inquiryUpdateError } = await supabase\n        .from('support_inquires')\n        .update({ purchase_request_id: null })\n        .eq('purchase_request_id', purchaseIdForDelete)\n\n      if (inquiryUpdateError) {\n        throw inquiryUpdateError\n      }\n\n      // 2) í’ˆëª© ì‚­ì œ\n      const { error: itemsError } = await supabase\n        .from('purchase_request_items')\n        .delete()\n        .eq('purchase_request_id', purchaseIdForDelete)\n\n      if (itemsError) throw itemsError\n\n      // 3) ë°œì£¼ ì‚­ì œ\n      const { error: requestError } = await supabase\n        .from('purchase_requests')\n        .delete()\n        .eq('id', purchaseIdForDelete)\n\n      if (requestError) throw requestError\n\n      toast.success('ë°œì£¼ìš”ì²­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.')\n      setDeleteConfirmOpen(false)\n      setPurchaseToDelete(null)\n      setIsModalOpen(false)\n      setSelectedPurchaseId(null)\n\n      // ë¡œì»¬ ìƒíƒœì—ì„œ ì¦‰ì‹œ ì œê±°í•˜ì—¬ ì…ê³  ëŒ€ê¸° ì¹´ë“œì— ë°”ë¡œ ë°˜ì˜\n      setData((prev) => {\n        if (!prev) return prev\n        const targetId = String(purchaseIdForDelete)\n        const removeById = (list: any[] = []) => list.filter((item: any) => String(item.id) !== targetId)\n        \n        const nextMyStatus = prev.myPurchaseStatus\n          ? {\n              ...prev.myPurchaseStatus,\n              waitingDelivery: removeById(prev.myPurchaseStatus.waitingDelivery),\n              waitingPurchase: removeById(prev.myPurchaseStatus.waitingPurchase),\n              recentCompleted: removeById(prev.myPurchaseStatus.recentCompleted)\n            }\n          : prev.myPurchaseStatus\n\n        return {\n          ...prev,\n          pendingApprovals: removeById(prev.pendingApprovals),\n          myRecentRequests: removeById(prev.myRecentRequests),\n          myPurchaseStatus: nextMyStatus\n        }\n      })\n\n      // ë¯¸ë‹¤ìš´ë¡œë“œ ëª©ë¡ ë“± ë‹¤ë¥¸ ì¹´ë“œì—ì„œë„ ì¦‰ì‹œ ì œê±°\n      setUndownloadedOrders((prev) => prev.filter(item => String(item.id) !== String(purchaseIdForDelete)))\n\n      // ìºì‹œ ë¬´íš¨í™” í›„ ê°•ì œ ìƒˆë¡œê³ ì¹¨\n      dashboardService.invalidateCache()\n      loadDashboardData(false, true)\n    } catch (error) {\n      logger.error('[DashboardMain] ë°œì£¼ ì‚­ì œ ì‹¤íŒ¨:', error)\n      toast.error('ë°œì£¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')\n    }\n  }\n\n  const handleQuickApprove = async (requestId: string | number) => {\n    const normalizedId = String(requestId)\n\n    if (!data?.employee) {\n      toast.error('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')\n      return\n    }\n\n    const applyOptimisticUpdate = (stage: 'middle' | 'final') => {\n      setData((prev) => {\n        if (!prev) return prev\n\n        if (stage === 'middle') {\n          return {\n            ...prev,\n            pendingApprovals: prev.pendingApprovals.map((item) =>\n              String(item.id) === normalizedId ? { ...item, middle_manager_status: 'approved' as const } : item\n            )\n          }\n        }\n\n        // ìµœì¢… ìŠ¹ì¸ â†’ ëª©ë¡ì—ì„œ ì œê±° + pending ì¹´ìš´íŠ¸ ê°ì†Œ\n        setDismissedApprovalIds((prev) => {\n          const next = new Set(prev)\n          next.add(normalizedId)\n          return next\n        })\n        const nextPending = Math.max(0, (prev.stats?.pending || 0) - 1)\n        return {\n          ...prev,\n          pendingApprovals: prev.pendingApprovals.filter((item) => String(item.id) !== normalizedId),\n          stats: prev.stats ? { ...prev.stats, pending: nextPending } : prev.stats\n        }\n      })\n    }\n\n    // ìŠ¹ì¸ í™•ì¸ ë©”ì‹œì§€\n    if (!confirm('ì •ë§ë¡œ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {\n      return\n    }\n\n    setActionLoading(normalizedId)\n    \n    // ì›ë³¸ ë°ì´í„° ë°±ì—… (ë¡¤ë°±ìš©)\n    const originalData = data\n\n    try {\n      const result = await dashboardService.quickApprove(normalizedId, data.employee)\n\n      if (result.success && result.stage) {\n        // 1) ëŒ€ì‹œë³´ë“œ ë¡œì»¬ ìƒíƒœ ì¦‰ì‹œ ë°˜ì˜\n        applyOptimisticUpdate(result.stage)\n\n        // 2) ë©”ëª¨ë¦¬ ìºì‹œë„ ë™ê¸°í™” â†’ ë‹¤ë¥¸ í™”ë©´/ë¦¬ìŠ¤ë„ˆ ì‹¤ì‹œê°„ ë°˜ì˜\n        updatePurchaseInMemory(normalizedId, (purchase) => {\n          if (result.stage === 'middle') {\n            return { ...purchase, middle_manager_status: 'approved' as any }\n          }\n          return { ...purchase, final_manager_status: 'approved' as any }\n        })\n\n        toast.success('ìŠ¹ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.')\n\n        // 3) ë°±ê·¸ë¼ìš´ë“œ ìƒˆë¡œê³ ì¹¨ (ìºì‹œ ë¬´íš¨í™”ì™€ í•¨ê»˜ ì •í•©ì„± ë³´ê°•)\n        setTimeout(() => loadDashboardData(false, true), 500)\n      } else {\n        // ì‹¤íŒ¨ ì‹œ ì›ë˜ ë°ì´í„°ë¡œ ë¡¤ë°±\n        setData(originalData)\n        toast.error(result.error || 'ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')\n      }\n    } catch (error) {\n      // ì—ëŸ¬ ì‹œ ì›ë˜ ë°ì´í„°ë¡œ ë¡¤ë°±\n      setData(originalData)\n      toast.error('ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')\n    } finally {\n      setActionLoading(null)\n    }\n  }\n\n  // ëª¨ë‹¬ ì—´ê¸° í—¬í¼ í•¨ìˆ˜ (PurchaseDetailModal ì‚¬ìš©, activeTab ì „ë‹¬)\n  const openPurchaseModal = (item: any, activeTab: string = 'pending') => {\n    setSelectedPurchaseId(Number(item.id))\n    setModalActiveTab(activeTab)\n    setIsModalOpen(true)\n  }\n\n  // ê²€ìƒ‰ í•„í„°ë§ í•¨ìˆ˜\n  const filterItems = useCallback((items: any[], searchTerm: string) => {\n    if (!searchTerm.trim()) return items\n    \n    return items.filter(item => {\n      const orderNumber = item.purchase_order_number || ''\n      const vendorName = item.vendor_name || ''\n      const itemsText = (item.purchase_request_items || [])\n        .map((pItem: any) => pItem.item_name || '')\n        .join(' ')\n      \n      return [orderNumber, vendorName, itemsText]\n        .join(' ')\n        .toLowerCase()\n        .includes(searchTerm.toLowerCase())\n    })\n  }, [])\n\n  // í•„í„°ë§ëœ ê²°ê³¼ ë©”ëª¨ì´ì œì´ì…˜ (ì…ë ¥í•  ë•Œë§ˆë‹¤ ì¬ê³„ì‚° ë°©ì§€)\n  const filteredUndownloaded = useMemo(() => filterItems(undownloadedOrders, searchTerms.undownloaded), [undownloadedOrders, searchTerms.undownloaded, filterItems])\n  const filteredPending = useMemo(() => filterItems(data?.pendingApprovals || [], searchTerms.pending), [data?.pendingApprovals, searchTerms.pending, filterItems])\n  const filteredPurchase = useMemo(() => filterItems(data?.myPurchaseStatus?.waitingPurchase || [], searchTerms.purchase), [data?.myPurchaseStatus?.waitingPurchase, searchTerms.purchase, filterItems])\n  const filteredDelivery = useMemo(() => filterItems(data?.myPurchaseStatus?.waitingDelivery || [], searchTerms.delivery), [data?.myPurchaseStatus?.waitingDelivery, searchTerms.delivery, filterItems])\n  \n  // ì…ê³ ì¼ì •ì§€ì—°ì•Œë¦¼: waitingDelivery ë°ì´í„°ë¥¼ Purchase íƒ€ì…ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ê²½ê³  í•­ëª© ê³„ì‚°\n  const deliveryPurchases = useMemo(() => {\n    if (!data?.myPurchaseStatus?.waitingDelivery) return []\n    return data.myPurchaseStatus.waitingDelivery.map(item => ({\n      ...item,\n      id: typeof item.id === 'string' ? parseInt(item.id) || 0 : item.id,\n      purchase_request_items: item.purchase_request_items || []\n    })) as unknown as Purchase[]\n  }, [data?.myPurchaseStatus?.waitingDelivery])\n  \n  const deliveryWarningCount = useDeliveryWarningCount(deliveryPurchases, currentUserName)\n  \n  // ë¡œë”© ì™„ë£Œ í›„ ê²½ê³  ëª¨ë‹¬ ìë™ í‘œì‹œ (ë§ˆìš´íŠ¸ë‹¹ 1íšŒ)\n  useEffect(() => {\n    if (hasShownWarningRef.current) return\n    \n    if (!loading && deliveryWarningCount > 0 && deliveryPurchases.length > 0) {\n      const timer = setTimeout(() => {\n        if (!hasShownWarningRef.current) {\n          hasShownWarningRef.current = true\n          setIsWarningModalOpen(true)\n        }\n      }, 500)\n      return () => clearTimeout(timer)\n    }\n  }, [loading, deliveryWarningCount, deliveryPurchases.length])\n\n  const handleDownloadExcel = async (purchase: any) => {\n    try {\n      setDownloadingIds(prev => new Set(prev).add(purchase.id))\n      \n      // UI ë¸”ë¡œí‚¹ ë°©ì§€ë¥¼ ìœ„í•´ ë‹¤ìŒ í‹±ìœ¼ë¡œ ì§€ì—°\n      await new Promise(resolve => setTimeout(resolve, 0))\n      \n      // ê´€ë¦¬íƒ­ê³¼ ë™ì¼í•œ Excel ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ í˜¸ì¶œ\n      await downloadPurchaseOrderExcel(\n        {\n          id: purchase.id,\n          purchase_order_number: purchase.purchase_order_number,\n          vendor_name: purchase.vendor_name,\n          vendor_id: purchase.vendor_id,\n          contact_id: purchase.contact_id\n        },\n        currentUserRoles,\n        () => {\n          // ì„±ê³µ ì½œë°±: UIì—ì„œ ë‹¤ìš´ë¡œë“œ ì™„ë£Œëœ í•­ëª© ì œê±°\n          setUndownloadedOrders(prev => prev.filter(item => item.id !== purchase.id))\n        }\n      )\n    } catch (error) {\n      logger.error('Excel ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', error)\n    } finally {\n      setDownloadingIds(prev => {\n        const newSet = new Set(prev)\n        newSet.delete(purchase.id)\n        return newSet\n      })\n    }\n  }\n\n  const getStepColor = (step: string) => {\n    switch (step) {\n      case 'approval': return 'bg-yellow-100 text-yellow-800'\n      case 'purchase': return 'bg-blue-100 text-blue-800'\n      case 'delivery': return 'bg-purple-100 text-purple-800'\n      case 'completed': return 'bg-green-100 text-green-800'\n      default: return 'bg-gray-100 text-gray-800'\n    }\n  }\n\n  if (loading) {\n    return (\n      <div className=\"flex items-center justify-center\" style={{ minHeight: '400px', backgroundColor: '#f9fafb' }}>\n        <div className=\"text-center\">\n          <div className=\"w-12 h-12 border-3 border-hansl-500 border-t-transparent rounded-full animate-spin mx-auto\" />\n          <p className=\"mt-4 card-subtitle\">ëŒ€ì‹œë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</p>\n          <p className=\"text-xs text-gray-400 mt-2\">Employee: {employee?.name || 'ì—†ìŒ'}</p>\n        </div>\n      </div>\n    )\n  }\n\n  if (!data?.employee) {\n    logger.warn('[DashboardMain] ë°ì´í„° ì—†ìŒ', { \n      hasData: !!data, \n      hasEmployee: !!employee,\n      employeeName: employee?.name,\n      loading \n    })\n    return (\n      <div className=\"flex items-center justify-center\" style={{ minHeight: '400px', backgroundColor: '#f9fafb' }}>\n        <div className=\"text-center bg-white p-8 rounded-lg border border-gray-200 shadow-sm\">\n          <h3 className=\"modal-subtitle mb-2\">ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>\n          <p className=\"card-subtitle mb-4\">ë¡œê·¸ì¸ì„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>\n          <div className=\"text-xs text-gray-400 space-y-1\">\n            <p>Employee: {employee?.name || 'ì—†ìŒ'}</p>\n            <p>Loading: {loading ? 'true' : 'false'}</p>\n            <p>Has Data: {data ? 'true' : 'false'}</p>\n          </div>\n        </div>\n      </div>\n    )\n  }\n\n  // ê¶Œí•œ íŒŒì‹± ë° í‘œì‹œ ì—¬ë¶€ ê²°ì •\n  const roles = Array.isArray(data.employee.purchase_role)\n    ? (data.employee.purchase_role as any[]).map((r: any) => String(r).trim())\n    : (data.employee.purchase_role\n        ? String(data.employee.purchase_role)\n            .split(',')\n            .map((r: string) => r.trim())\n            .filter((r: string) => r.length > 0)\n        : [])\n\n  const canSeeApprovalBox = roles.some((r: string) => ['middle_manager', 'final_approver', 'app_admin', 'raw_material_manager', 'consumable_manager'].includes(r))\n\n  // ê²°ì œ/ìš”ì²­ ìœ í˜•ë³„ ìƒ‰ìƒ ë§¤í•‘ (payment_category ê¸°ì¤€)\n  const getTypeColorClass = (paymentCategory: string | null | undefined) => {\n    const normalized = (paymentCategory || '').toLowerCase().replace(/\\s+/g, '')\n    const isOnsitePayment = normalized.includes('í˜„ì¥ê²°ì œ')\n    const isOrder = normalized.includes('ë°œì£¼')\n    const isPurchaseRequest = normalized.includes('êµ¬ë§¤')\n\n    if (isOnsitePayment) return 'bg-gray-500'\n    if (isOrder) return 'bg-green-500'\n    if (isPurchaseRequest) return 'bg-blue-500'\n    return 'bg-gray-300'\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gray-50\">\n      <div className=\"w-full px-4 lg:px-6\">\n        {/* í—¤ë” */}\n        <div className=\"mb-3\">\n          <div>\n            <h1 className=\"page-title\">ëŒ€ì‹œë³´ë“œ</h1>\n            <p className=\"page-subtitle\" style={{marginTop:'-2px',marginBottom:'-4px'}}>Dashboard</p>\n          </div>\n        </div>\n\n        {/* í†µí•© ëŒ€ì‹œë³´ë“œ ê·¸ë¦¬ë“œ */}\n        <div className=\"mb-2\">\n          <h2 className=\"section-title mb-2 flex items-center gap-1.5\">\n            <Package className=\"w-3.5 h-3.5 text-gray-600\" />\n            ì „ì²´ í˜„í™©\n            <span className=\"badge-stats border border-gray-300 bg-white text-gray-600 ml-2\">\n              {new Date().toLocaleDateString('ko-KR', { \n                month: 'long', \n                day: 'numeric',\n                weekday: 'short'\n              })}\n            </span>\n          </h2>\n        </div>\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3\">\n          {/* 1. ìŠ¹ì¸ ëŒ€ê¸° (ìŠ¹ì¸ ê¶Œí•œìë§Œ í‘œì‹œ) */}\n          {canSeeApprovalBox && (\n            <Card className=\"w-full col-span-1\">\n              <CardHeader className=\"h-12 px-4 bg-gray-50 border-b flex items-center\">\n                <CardTitle className=\"section-title flex items-center justify-between w-full\">\n                  <div className=\"flex items-center gap-2\">\n                    <Clock className=\"w-3.5 h-3.5 text-orange-500\" />\n                    <span>ìŠ¹ì¸ ëŒ€ê¸°</span>\n                  </div>\n                  {data.pendingApprovals.length > 0 && (\n                    <span className=\"badge-stats bg-gray-200 text-gray-700\">\n                      {data.pendingApprovals.length}\n                    </span>\n                  )}\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"p-4\">\n                {data.pendingApprovals.length === 0 ? (\n                  <div className=\"text-center py-4 text-gray-400\">\n                    <CheckCircle className=\"w-6 h-6 mx-auto mb-1\" />\n                    <p className=\"card-description\">ëŒ€ê¸° í•­ëª© ì—†ìŒ</p>\n                  </div>\n                  ) : (\n                  <div className=\"space-y-3\">\n                    {/* ê²€ìƒ‰ ì…ë ¥ */}\n                    <div className=\"relative\">\n                      <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400\" />\n                      <Input\n                        placeholder=\"ë°œì£¼ë²ˆí˜¸, ì—…ì²´ëª…, í’ˆëª©ìœ¼ë¡œ ê²€ìƒ‰...\"\n                        value={searchTerms.pending}\n                        onChange={(e) => setSearchTerms(prev => ({ ...prev, pending: e.target.value }))}\n                        className=\"pl-10 h-8 text-xs\"\n                      />\n                    </div>\n                    \n                    {/* í•­ëª© ë¦¬ìŠ¤íŠ¸ */}\n                    <div className=\"space-y-2 h-[36rem] overflow-y-auto\">\n                      {filteredPending.slice(0, 10).map((approval, index) => {\n                        const items = approval.purchase_request_items || []\n                        const firstItem = items[0] || {}\n                        const totalAmount = approval.total_amount || items.reduce((sum: number, i: any) => sum + (Number(i.amount_value) || 0), 0)\n                        const isAdvance = approval.progress_type === 'ì„ ì§„í–‰'\n                        const typeColorClass = getTypeColorClass(approval.payment_category)\n                        \n                        return (\n                          <div \n                            key={`approval-${approval.id}`} \n                            className={`relative border rounded-lg p-2 hover:shadow-sm transition-all cursor-pointer mb-2 pl-3 ${\n                              isAdvance ? 'bg-red-50 border-red-200' : 'hover:bg-orange-50/30'\n                            }`}\n                            onClick={(e) => {\n                              // ë²„íŠ¼ í´ë¦­ì€ ë¬´ì‹œ\n                              if ((e.target as HTMLElement).closest('button')) return\n                              openPurchaseModal(approval, 'pending') // ìŠ¹ì¸ëŒ€ê¸° íƒ­\n                            }}\n                          >\n                            {/* ì¢Œì¸¡ ì„¸ë¡œ íƒ€ì… ë°” */}\n                            <div className={`absolute inset-y-1 left-1 w-1 rounded-full ${typeColorClass}`} />\n                            <div className=\"flex items-center justify-between gap-2\">\n                              <div className=\"flex items-center gap-2 flex-1 min-w-0\">\n                                <span className=\"card-title\">\n                                  {approval.purchase_order_number}\n                                </span>\n                                <span className=\"card-subtitle truncate\">{approval.vendor_name || 'ì—…ì²´'}</span>\n                                <span className=\"card-description truncate\">\n                                  {firstItem.item_name || 'í’ˆëª©'} {items.length > 1 && `ì™¸ ${items.length - 1}ê±´`}\n                                </span>\n                              </div>\n                              <Button\n                                onClick={async (e) => {\n                                  e.stopPropagation()\n                                  await handleQuickApprove(approval.id)\n                                }}\n                                disabled={actionLoading === approval.id}\n                                className={`button-base text-white ${\n                                  approval.middle_manager_status === 'approved' \n                                    ? 'bg-blue-600 hover:bg-blue-700' \n                                    : 'bg-green-600 hover:bg-green-700'\n                                }`}\n                              >\n                                {actionLoading === approval.id ? (\n                                  <div className=\"w-3 h-3 border border-white border-t-transparent rounded-full animate-spin\" />\n                                ) : (\n                                  <>\n                                    {approval.middle_manager_status === 'approved' ? 'ìµœì¢…' : '1ì°¨'} ìŠ¹ì¸\n                                  </>\n                                )}\n                              </Button>\n                            </div>\n                          </div>\n                        )\n                      })}\n                    </div>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          )}\n\n          {/* 2. ë¬¸ì˜í•˜ê¸° ë‚´ì—­ - App Adminë§Œ í‘œì‹œ */}\n          {currentUserRoles.includes('app_admin') && (\n            <Card className=\"w-full col-span-1 border-gray-200 shadow-sm hover:shadow-md transition-shadow\">\n              <CardHeader className=\"h-12 px-4 bg-gray-50 border-b flex items-center\">\n                <CardTitle className=\"section-title flex items-center w-full\">\n                  <div className=\"flex items-center gap-2\">\n                    <MessageCircle className=\"w-4 h-4 text-purple-600\" />\n                    <span>ë¯¸ì²˜ë¦¬ ë¬¸ì˜</span>\n                    {inquiries.length > 0 && (\n                      <span className=\"badge-stats bg-red-100 text-red-700\">\n                        {inquiries.length}\n                      </span>\n                    )}\n                  </div>\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"p-4\">\n                {loadingInquiries ? (\n                  <div className=\"flex items-center justify-center py-8\">\n                    <div className=\"w-6 h-6 border-2 border-gray-300 border-t-transparent rounded-full animate-spin\" />\n                  </div>\n                ) : inquiries.length === 0 ? (\n                  <div className=\"text-center py-12 text-gray-400\">\n                    <CheckCircle className=\"w-10 h-10 mx-auto mb-3 text-gray-300\" />\n                    <p className=\"card-subtitle\">ë¯¸ì²˜ë¦¬ ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤</p>\n                  </div>\n                ) : (\n                  <div className=\"space-y-2 max-h-[20rem] overflow-y-auto\">\n                    {inquiries.slice(0, 10).map((inquiry) => {\n                      const isExpanded = expandedInquiryId === inquiry.id\n                      \n                      return (\n                        <div \n                          key={inquiry.id} \n                          className=\"border rounded-lg overflow-hidden hover:shadow-sm transition-all\"\n                        >\n                          {/* ë¬¸ì˜ ìš”ì•½ */}\n                          <div \n                            className=\"p-2 hover:bg-purple-50/30 cursor-pointer\"\n                            onClick={() => setExpandedInquiryId(isExpanded ? null : inquiry.id!)}\n                          >\n                            <div className=\"flex items-center gap-2\">\n                              <span className={`badge-stats ${\n                                inquiry.status === 'open' \n                                  ? 'bg-yellow-100 text-yellow-800' \n                                  : 'bg-blue-100 text-blue-800'\n                              }`}>\n                                {inquiry.status === 'open' ? 'ëŒ€ê¸°' : 'ì²˜ë¦¬ì¤‘'}\n                              </span>\n                              <span className=\"card-title truncate flex-1\">\n                                {inquiry.subject}\n                              </span>\n                              <span className=\"card-description whitespace-nowrap\">\n                                {inquiry.user_name}\n                              </span>\n                              <span className=\"card-date whitespace-nowrap\">\n                                {inquiry.created_at && format(new Date(inquiry.created_at), 'MM/dd HH:mm')}\n                              </span>\n                            </div>\n                          </div>\n                          \n                          {/* ìƒì„¸ ë‚´ìš© */}\n                          {isExpanded && (\n                            <div className=\"px-3 py-2 bg-gray-50 border-t text-xs space-y-2\">\n                              {/* ë°œì£¼ë²ˆí˜¸ */}\n                              {inquiry.purchase_order_number && (\n                                <div>\n                                  <span className=\"modal-label text-gray-500\">ë°œì£¼ë²ˆí˜¸:</span>\n                                  <button\n                                    className=\"text-blue-600 underline ml-2 hover:text-blue-800\"\n                                    onClick={(e) => {\n                                      e.stopPropagation()\n                                      openPurchaseDetailFromInquiry(inquiry)\n                                    }}\n                                    title=\"ë°œì£¼ ìƒì„¸ ì—´ê¸°\"\n                                  >\n                                    {inquiry.purchase_order_number}\n                                  </button>\n                                </div>\n                              )}\n                              <div>\n                                <span className=\"modal-label text-gray-500\">ë‚´ìš©:</span>\n                                <p className=\"text-gray-600 mt-1 whitespace-pre-wrap\">{inquiry.message}</p>\n                              </div>\n                              {/* ì²¨ë¶€ ì´ë¯¸ì§€ */}\n                              {inquiry.attachments && inquiry.attachments.length > 0 && (\n                                <div>\n                                  <span className=\"modal-label text-gray-500\">ì²¨ë¶€ ì´ë¯¸ì§€:</span>\n                                  <div className=\"flex flex-wrap gap-2 mt-1\">\n                                    {inquiry.attachments.map((attachment, index) => (\n                                      <a\n                                        key={index}\n                                        href={attachment.url}\n                                        target=\"_blank\"\n                                        rel=\"noopener noreferrer\"\n                                      >\n                                        <img\n                                          src={attachment.url}\n                                          alt={attachment.name}\n                                          className=\"w-16 h-16 object-cover rounded border border-gray-200 hover:border-blue-400\"\n                                        />\n                                      </a>\n                                    ))}\n                                  </div>\n                                </div>\n                              )}\n                              <div className=\"flex justify-end gap-2 pt-2\">\n                                <button\n                                  className=\"button-action-danger\"\n                                  onClick={(e) => {\n                                    e.stopPropagation()\n                                    handleDeleteInquiry(inquiry.id!)\n                                  }}\n                                >\n                                  <Trash2 className=\"w-3 h-3 mr-1\" />\n                                  ì‚­ì œ\n                                </button>\n                                <button\n                                  className=\"button-action-primary\"\n                                  onClick={async () => {\n                                    // âœ… ì…ë ¥ ì—†ì´ ì™„ë£Œ ì²˜ë¦¬ + ì‚¬ìš©ìì—ê²Œ \"ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤\" ì•Œë¦¼ + ë¡œê·¸ ê¸°ë¡\n                                    const result = await supportService.resolveInquiry(inquiry.id!)\n                                    if (result.success) {\n                                      toast.success('ë¬¸ì˜ê°€ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.')\n                                      // ëª©ë¡ì—ì„œ ì œê±°\n                                      setInquiries(prev => prev.filter(inq => inq.id !== inquiry.id))\n                                      setExpandedInquiryId(null)\n                                    } else {\n                                      toast.error(result.error || 'ì™„ë£Œ ì²˜ë¦¬ ì‹¤íŒ¨')\n                                    }\n                                  }}\n                                >\n                                  ì™„ë£Œ ì²˜ë¦¬\n                                </button>\n                              </div>\n                            </div>\n                          )}\n                        </div>\n                      )\n                    })}\n                    {inquiries.length > 10 && (\n                      <div className=\"text-center pt-2\">\n                        <button\n                          className=\"button-action-secondary\"\n                          onClick={() => navigate('/support')}\n                        >\n                          ì „ì²´ ë³´ê¸° ({inquiries.length}ê±´)\n                        </button>\n                      </div>\n                    )}\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          )}\n\n          {/* 3. ì…ê³  ëŒ€ê¸°ì¤‘ */}\n          <Card className=\"w-full col-span-1 border-gray-200 shadow-sm hover:shadow-md transition-shadow\">\n              <CardHeader className=\"h-12 px-4 bg-gray-50 border-b flex items-center\">\n                <CardTitle className=\"section-title flex items-center justify-between w-full\">\n                  <div className=\"flex items-center gap-2\">\n                    <Truck className=\"w-4 h-4 text-blue-600\" />\n                    <span>ì…ê³  ëŒ€ê¸°</span>\n                  </div>\n                  {data.myPurchaseStatus.waitingDelivery.length > 0 && (\n                    <span className=\"badge-stats bg-gray-200 text-gray-700\">\n                      {data.myPurchaseStatus.waitingDelivery.length}\n                    </span>\n                  )}\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"p-4\">\n                {data.myPurchaseStatus.waitingDelivery.length === 0 ? (\n                  <div className=\"text-center py-12 text-gray-400\">\n                    <Truck className=\"w-10 h-10 mx-auto mb-3 text-gray-300\" />\n                    <p className=\"card-subtitle\">ì…ê³  ëŒ€ê¸° í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</p>\n                  </div>\n                ) : (\n                  <div className=\"space-y-3\">\n                    {/* ê²€ìƒ‰ ì…ë ¥ */}\n                    <div className=\"relative\">\n                      <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400\" />\n                      <Input\n                        placeholder=\"ë°œì£¼ë²ˆí˜¸, ì—…ì²´ëª…, í’ˆëª©ìœ¼ë¡œ ê²€ìƒ‰...\"\n                        value={searchTerms.delivery}\n                        onChange={(e) => setSearchTerms(prev => ({ ...prev, delivery: e.target.value }))}\n                        className=\"pl-10 h-8 text-xs\"\n                      />\n                    </div>\n                    \n                    {/* í•­ëª© ë¦¬ìŠ¤íŠ¸ */}\n                    <div className=\"space-y-2 h-[36rem] overflow-y-auto\">\n                      {filteredDelivery.slice(0, 10).map((item) => {\n                        const items = item.purchase_request_items || []\n                        const firstItem = items[0]\n                        const totalItems = items.length\n                        const receivedItems = items.filter((i: any) => i.is_received).length\n                        const progress = totalItems > 0 ? Math.round((receivedItems / totalItems) * 100) : 0\n                        const totalAmount = items.reduce((sum: number, i: any) => sum + (Number(i.amount_value) || 0), 0)\n                        const isSeonJin = (item.progress_type || '').includes('ì„ ì§„í–‰')\n                        \n                        return (\n                          <div \n                            key={item.id} \n                            className={`border rounded-lg p-2 transition-all cursor-pointer hover:shadow-sm mb-2 ${\n                              isSeonJin ? 'bg-red-50 hover:bg-red-100 border-red-200' : 'bg-white hover:bg-gray-50 border-gray-200'\n                            }`}\n                            onClick={(e) => {\n                              // ë²„íŠ¼ í´ë¦­ì€ ë¬´ì‹œ\n                              if ((e.target as HTMLElement).closest('button')) return\n                              openPurchaseModal(item, 'receipt') // ì…ê³ í˜„í™© íƒ­\n                            }}\n                          >\n                            <div className=\"flex items-center gap-2\">\n                              <span className=\"card-title\">\n                                {item.purchase_order_number || `PO-${item.id.slice(0, 8)}`}\n                              </span>\n                              <span className=\"card-subtitle truncate\">\n                                {item.vendor_name || 'ì—…ì²´ëª… ì—†ìŒ'}\n                              </span>\n                              <span className=\"card-description truncate\">\n                                {firstItem?.item_name || 'í’ˆëª©'} \n                                {totalItems > 1 && (\n                                  <span className=\"text-gray-400\"> ì™¸ {totalItems - 1}ê±´</span>\n                                )}\n                              </span>\n                            </div>\n                          </div>\n                        )\n                      })}\n                    </div>\n                  </div>\n                )}\n              </CardContent>\n          </Card>\n\n          {/* 4. Lead Buyer / App Admin - ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œ */}\n          {(currentUserRoles.includes('lead buyer') || currentUserRoles.includes('app_admin')) && (\n            <Card className=\"w-full col-span-1 row-span-2 border-gray-200 shadow-sm hover:shadow-md transition-shadow\">\n              <CardHeader className=\"h-12 px-4 bg-gray-50 border-b flex items-center\">\n                <CardTitle className=\"section-title flex items-center justify-between w-full\">\n                  <div className=\"flex items-center gap-2\">\n                    <Download className=\"w-4 h-4 text-orange-600\" />\n                    <span>ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œ</span>\n                  </div>\n                  <span className=\"badge-stats bg-gray-200 text-gray-700\">\n                    {undownloadedOrders.length}\n                  </span>\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"p-4\">\n                <div className=\"space-y-3\">\n                  {/* ê²€ìƒ‰ ì…ë ¥ */}\n                  <div className=\"relative\">\n                    <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400\" />\n                    <Input\n                      placeholder=\"ë°œì£¼ë²ˆí˜¸, ì—…ì²´ëª…, í’ˆëª©ìœ¼ë¡œ ê²€ìƒ‰...\"\n                      value={searchTerms.undownloaded}\n                      onChange={(e) => setSearchTerms(prev => ({ ...prev, undownloaded: e.target.value }))}\n                      className=\"pl-10 h-8 text-xs\"\n                    />\n                  </div>\n                  \n                  {/* í•­ëª© ë¦¬ìŠ¤íŠ¸ */}\n                  <div className=\"space-y-2 h-[36rem] overflow-y-auto\">\n                    {filteredUndownloaded.length === 0 ? (\n                      <div className=\"text-center py-12 text-gray-400\">\n                        <Download className=\"w-10 h-10 mx-auto mb-3 text-gray-300\" />\n                        <p className=\"card-subtitle\">ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œê°€ ì—†ìŠµë‹ˆë‹¤</p>\n                      </div>\n                    ) : (\n                      filteredUndownloaded.map((item, index) => {\n                        const items = item.purchase_request_items || []\n                        const firstItem = items[0] || {}\n                        const isAdvance = item.progress_type === 'ì„ ì§„í–‰'\n                      \n                      return (\n                        <div \n                          key={`undownloaded-${item.id}`} \n                          className={`border rounded-lg p-2 hover:shadow-sm transition-all cursor-pointer mb-2 ${\n                            isAdvance ? 'bg-red-50 border-red-200' : 'hover:bg-orange-50/30'\n                          }`}\n                          onClick={(e) => {\n                            // ë²„íŠ¼ í´ë¦­ì€ ë¬´ì‹œ\n                            if ((e.target as HTMLElement).closest('button')) return\n                            openPurchaseModal(item, 'pending') // ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œëŠ” ìŠ¹ì¸ëŒ€ê¸° íƒ­ê³¼ ë™ì¼\n                          }}\n                        >\n                          <div className=\"flex items-center justify-between gap-2\">\n                            <div className=\"flex items-center gap-2 flex-1 min-w-0\">\n                              <span className=\"card-title\">\n                                {item.purchase_order_number || `PO-${item.id.slice(0, 8)}`}\n                              </span>\n                              <span className=\"card-subtitle truncate\">\n                                {item.vendor_name || 'ì—…ì²´ëª… ì—†ìŒ'}\n                              </span>\n                              <span className=\"card-description truncate\">\n                                {firstItem.item_name || 'í’ˆëª©'} \n                                {items.length > 1 && (\n                                  <span className=\"text-gray-400\"> ì™¸ {items.length - 1}ê±´</span>\n                                )}\n                              </span>\n                            </div>\n                            <Button\n                              className=\"button-base bg-gray-500 hover:bg-gray-600 text-white\"\n                              onClick={async (e) => {\n                                e.stopPropagation()\n                                await handleDownloadExcel(item)\n                              }}\n                              disabled={downloadingIds.has(item.id)}\n                            >\n                              {downloadingIds.has(item.id) ? (\n                                <div className=\"w-3 h-3 border border-white border-t-transparent rounded-full animate-spin\" />\n                              ) : (\n                                \"ë‹¤ìš´ë¡œë“œ\"\n                              )}\n                            </Button>\n                          </div>\n                        </div>\n                      )\n                      })\n                    )}\n                    {filteredUndownloaded.length >= 100 && (\n                      <div className=\"text-center text-xs text-gray-500 mt-3 pb-2\">\n                        í‘œì‹œëœ í•­ëª©: {filteredUndownloaded.length}ê°œ\n                        <br />\n                        ë” ë§ì€ í•­ëª©ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê²€ìƒ‰ìœ¼ë¡œ í•„í„°ë§í•˜ì„¸ìš”.\n                      </div>\n                    )}\n                    {filteredUndownloaded.length > 0 && (\n                      <div className=\"text-center text-xs text-gray-400 mt-2 pb-2\">\n                        ì´ {filteredUndownloaded.length}ê°œ ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œ\n                      </div>\n                    )}\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          )}\n\n        </div>\n\n        {/* ì˜¤ëŠ˜ì˜ ìš”ì•½ - ìƒë‹¨ í†µê³„ì— í†µí•© */}\n      </div>\n      \n      {/* PurchaseDetailModal - ëª¨ë“  ì¹´ë“œì—ì„œ ì‚¬ìš© (activeTabì— ë”°ë¼ ë‹¤ë¥¸ ë‚´ìš© í‘œì‹œ) */}\n      <PurchaseDetailModal\n        purchaseId={selectedPurchaseId}\n        isOpen={isModalOpen}\n        onClose={() => {\n          setIsModalOpen(false)\n          setSelectedPurchaseId(null)\n          setModalActiveTab('pending')\n        }}\n        currentUserRoles={currentUserRoles}\n        activeTab={modalActiveTab}\n        onRefresh={() => {\n          loadDashboardData(false)\n          setIsModalOpen(false)\n          setSelectedPurchaseId(null)\n          setModalActiveTab('pending')\n        }}\n        onOptimisticUpdate={(purchaseId: number, updater: (prev: Purchase) => Purchase) => {\n          updatePurchaseInMemory(purchaseId, updater)\n          loadDashboardData(false)\n        }}\n        onDelete={(purchase) => {\n          setPurchaseToDelete(purchase)\n          setDeleteConfirmOpen(true)\n        }}\n      />\n\n      {/* ì‚­ì œ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ (PurchaseDetailModal ì—°ë™) */}\n      <AlertDialog\n        open={deleteConfirmOpen}\n        onOpenChange={(open) => {\n          setDeleteConfirmOpen(open)\n          if (!open) setPurchaseToDelete(null)\n        }}\n      >\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>ë°œì£¼ìš”ì²­ ë‚´ì—­ ì‚­ì œ</AlertDialogTitle>\n            <AlertDialogDescription>\n              ë°œì£¼ìš”ì²­ë²ˆí˜¸ <strong>{purchaseToDelete?.purchase_order_number || 'ì•Œ ìˆ˜ ì—†ìŒ'}</strong>ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n              <br />\n              ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel>ì·¨ì†Œ</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={handleConfirmDeletePurchase}\n              className=\"bg-red-600 hover:bg-red-700\"\n            >\n              ì‚­ì œ\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n      \n      {/* ì…ê³  ì¼ì • ì§€ì—° ê²½ê³  ëª¨ë‹¬ */}\n      <DeliveryDateWarningModal\n        isOpen={isWarningModalOpen}\n        onClose={() => {\n          setIsWarningModalOpen(false)\n          // ëª¨ë‹¬ ë‹«ê³  ë°ì´í„° ìƒˆë¡œê³ ì¹¨\n          loadDashboardData(false, true)\n        }}\n        purchases={deliveryPurchases}\n        currentUserName={currentUserName}\n        onRefresh={() => loadDashboardData(false, true)}\n      />\n    </div>\n  )\n}"],"names":["dashboardCache","data","lastFetch","CACHE_DURATION","employeeId","dashboardService","constructor","this","supabase","createClient","hasValidPurchaseMemory","employee","purchaseMemoryCache","allPurchases","length","id","isFresh","Date","now","isSameUser","currentUser","String","invalidateDashboardCache","invalidateCache","hasValidCache","dashboardCacheValid","memoryCacheValid","getPurchaseMemory","parseRoles","purchaseRole","roles","Array","isArray","map","r","trim","split","filter","getDashboardData","forceRefresh","useMemory","results","Promise","allSettled","getDashboardStatsFromMemory","getDashboardStats","getMyRecentRequestsFromMemory","getMyRecentRequests","getPendingApprovalsFromMemory","getPendingApprovals","getQuickActionsFromMemory","getQuickActions","getTodaySummaryFromMemory","getTodaySummary","getMyPurchaseStatusFromMemory","getMyPurchaseStatus","statsResult","myRecentRequestsResult","pendingApprovalsResult","quickActionsResult","todaySummaryResult","myPurchaseStatusResult","stats","status","value","total","myRequests","pending","completed","urgent","todayActions","myRecentRequests","pendingApprovals","quickActions","todaySummary","approved","requested","received","myPurchaseStatus","waitingPurchase","waitingDelivery","recentCompleted","logger","error","reason","dashboardData","urgentRequests","isPendingStatus","toTime","t","getTime","Number","isFinite","purchases","today","toISOString","purchase_role","name","email","monthStart","getFullYear","getMonth","threeDaysAgo","p","requester_name","getPendingCountFromMemory","is_received","received_at","getUrgentCountFromMemory","getTodayActionsCountFromMemory","requesterName","item","middleApproved","middle_manager_status","finalPending","final_manager_status","finalApproved","notPaid","is_payment_completed","sort","a","b","created_at","slice","vendor_name","total_items","purchase_request_items","progress_percentage","calculateProgress","current_step","getCurrentStep","next_action","getNextAction","estimated_completion","estimateCompletion","filteredPending","request_date","middlePending","middleRejected","finalRejected","roleFiltered","includes","items","total_amount","reduce","sum","i","amount_value","quantity","unit_price_value","project_vendor","vendor","actions","pendingCount","push","type","label","description","count","color","purchaseCount","tomorrow","inRange","ts","updated_at","isLeadBuyer","sevenDaysAgo","isPurchaseRequest","payment_category","progress_type","isIlban","notReceived","isSeonJin","sortDesc","threeDaysAgoIso","base","todayIsoDate","tomorrowIsoDate","totalResult","myRequestsResult","pendingResult","completedResult","urgentResult","todayActionsResult","all","from","select","head","eq","getPendingCount","gte","getUrgentCount","getTodayActionsCount","or","order","ascending","limit","vendors","debug","employeeName","employeeRoles","allRequests","requestsError","filteredData","isPending","totalRequests","roleFilteredData","totalItems","beforeFilter","afterFilter","purchasePending","result","enhancedData","finalCount","performanceNote","approvedResult","requestedResult","receivedResult","lt","query","allMyRequests","quickApprove","requestId","request","single","success","updateData","stage","Object","keys","update","updatePurchaseInMemory","purchase","message","mid","fin","pur","getTotalDeliveryWaitingCount","progress","created","Math","floor","estimatedDays","toLocaleDateString","getUndownloadedOrders","info","is_po_download","DashboardMain","navigate","useNavigate","currentUserRoles","userRoles","currentUserName","useAuth","Boolean","setData","useState","loading","setLoading","actionLoading","setActionLoading","setCurrentUserRoles","undownloadedOrders","setUndownloadedOrders","downloadingIds","setDownloadingIds","Set","dismissedApprovalIds","setDismissedApprovalIds","inquiries","setInquiries","loadingInquiries","setLoadingInquiries","expandedInquiryId","setExpandedInquiryId","selectedPurchaseId","setSelectedPurchaseId","isModalOpen","setIsModalOpen","modalActiveTab","setModalActiveTab","deleteConfirmOpen","setDeleteConfirmOpen","purchaseToDelete","setPurchaseToDelete","isWarningModalOpen","setIsWarningModalOpen","hasShownWarningRef","useRef","searchTerms","setSearchTerms","undownloaded","delivery","loadDashboardData","useCallback","async","showLoading","has","removedCount","adjustedStats","max","prev","next","forEach","delete","sampleItems","purchase_order_number","undownloadedError","toast","useEffect","isFirstMount","unsubscribe","addCacheListener","current","inquiryResult","supportService","getAllInquiries","pendingInquiries","inq","inquiryError","loadInquiries","subscription","subscribeToInquiries","payload","eventType","newRow","new","oldRow","old","deletedId","row","idx","findIndex","unshift","at","handleQuickApprove","normalizedId","confirm","originalData","add","nextPending","setTimeout","openPurchaseModal","activeTab","filterItems","searchTerm","pItem","item_name","join","toLowerCase","filteredUndownloaded","useMemo","filteredDelivery","deliveryPurchases","parseInt","deliveryWarningCount","useDeliveryWarningCount","timer","clearTimeout","jsx","className","style","minHeight","backgroundColor","children","jsxs","warn","hasData","hasEmployee","canSeeApprovalBox","some","marginTop","marginBottom","Package","month","day","weekday","Card","CardHeader","CardTitle","Clock","CardContent","CheckCircle","Search","Input","placeholder","onChange","e","target","approval","index","firstItem","isAdvance","typeColorClass","paymentCategory","normalized","replace","isOnsitePayment","isOrder","getTypeColorClass","onClick","closest","Button","stopPropagation","disabled","Fragment","MessageCircle","inquiry","isExpanded","subject","user_name","format","purchase_request_id","orderNumber","maybeSingle","openPurchaseDetailFromInquiry","title","attachments","attachment","href","url","rel","src","alt","inquiryId","deleteInquiry","handleDeleteInquiry","Trash2","resolveInquiry","Truck","Download","resolve","downloadPurchaseOrderExcel","vendor_id","contact_id","newSet","handleDownloadExcel","PurchaseDetailModal","purchaseId","isOpen","onClose","onRefresh","onOptimisticUpdate","updater","onDelete","AlertDialog","open","onOpenChange","AlertDialogContent","AlertDialogHeader","AlertDialogTitle","AlertDialogDescription","AlertDialogFooter","AlertDialogCancel","AlertDialogAction","purchaseIdForDelete","isNaN","inquiryUpdateError","itemsError","requestError","targetId","removeById","list","nextMyStatus","DeliveryDateWarningModal"],"mappings":"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"}