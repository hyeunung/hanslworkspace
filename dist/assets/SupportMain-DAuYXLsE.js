import{e,r as t,j as s,z as a,B as r,X as i,s as n,c as l,M as c,w as d,g as o}from"./index-BnUWfPZP.js";import{C as u,a as m,b as p,c as h,T as x}from"./card-C-3C6eA3.js";import{I as g,P as b,D as y,a as f,b as j,c as v}from"./dialog-CZ0kcMYz.js";import{T as _}from"./textarea-6iGa2zsc.js";import{S as N,a as w,b as S,c as q,d as I,C}from"./select-Ck9yvnvY.js";import{t as $}from"./index-9IIpIF1U.js";import{A as k,a as M,b as T,c as D,d as O,e as P,f as L,g as R}from"./alert-dialog-CPQU1rSu.js";import{C as H,k as E,S as F,f as A,D as V}from"./react-select.esm-DbrbSTF8.js";import{P as W,a as J,b as z}from"./popover-CToDCtYW.js";import{C as K}from"./calendar-DxQ4BKdl.js";import{d as Q,P as B}from"./PurchaseDetailModal-BJpCmNp4.js";import{L as U}from"./loader-circle-AczPEY5c.js";import{C as Y}from"./chevron-down-CECmaK-L.js";import{E as G}from"./eye-Ctl3kkN-.js";import{S as X}from"./save-CBKG6yE9.js";import"./index-BePm0O1Z.js";import"./check-DGx8L62M.js";import"./chevron-right-SfJ2SgoC.js";import"./helpers-CmqE03mo.js";import"./credit-card-fh7IxcEj.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Z=e("image-plus",[["path",{d:"M16 5h6",key:"1vod17"}],["path",{d:"M19 2v6",key:"4bpg5p"}],["path",{d:"M21 11.5V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7.5",key:"1ue2ih"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}]]),ee=e("send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]);function te({className:e,date:n,onDateChange:l,placeholder:c="기간을 선택하세요",disabled:d=!1,triggerClassName:o,...u}){const[m,p]=t.useState(!1),h=e=>{if(!e?.from)return c;const t=e=>e.toLocaleDateString("ko-KR",{year:"numeric",month:"long",day:"numeric"});if(e.from&&e.to){if(e.from.getFullYear()===e.to.getFullYear()&&e.from.getMonth()===e.to.getMonth()){return`${e.from.getFullYear()}년 ${e.from.toLocaleDateString("ko-KR",{month:"long"})} ${e.from.getDate()}일 - ${e.to.getDate()}일`}return`${t(e.from)} - ${t(e.to)}`}return t(e.from)};return s.jsx("div",{className:a("grid gap-2",e),...u,children:s.jsxs(W,{open:m,onOpenChange:p,children:[s.jsx(J,{asChild:!0,children:s.jsxs(r,{id:"date",className:a("button-base w-full justify-start text-left font-normal border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 transition-colors",!n&&"text-gray-500",n&&"text-gray-900",o),disabled:d,children:[s.jsx(K,{className:"mr-2 h-4 w-4 text-gray-400"}),s.jsx("span",{className:"truncate",children:h(n)}),n&&s.jsx(i,{className:"ml-auto h-4 w-4 text-gray-400 hover:text-gray-600 transition-colors",onClick:e=>{e.stopPropagation(),l?.(void 0),p(!1)}})]})}),s.jsx(z,{className:"w-auto p-0 shadow-lg border border-gray-200 business-radius-card",align:"start",children:s.jsxs("div",{className:"bg-white business-radius-card overflow-hidden",children:[s.jsxs("div",{className:"bg-gray-50 border-b border-gray-100 px-4 py-3",children:[s.jsx("h4",{className:"text-[11px] font-semibold text-gray-900",children:"기간 선택"}),s.jsx("p",{className:"text-[10px] text-gray-500 mt-1",children:"시작일과 종료일을 선택하세요"})]}),s.jsx("div",{className:"p-4",children:s.jsx(H,{initialFocus:!0,mode:"range",defaultMonth:n?.from,selected:n,onSelect:e=>{l?.(e),e?.from&&e?.to&&p(!1)},numberOfMonths:2,disabled:d,locale:E,className:"business-radius-card",classNames:{months:"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",month:"space-y-4",caption:"flex justify-center pt-1 relative items-center text-[11px] font-medium",caption_label:"text-[11px] font-medium text-gray-900",nav:"space-x-1 flex items-center",nav_button:"inline-flex items-center justify-center rounded-md text-[11px] font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none border border-input bg-background hover:bg-accent hover:text-accent-foreground h-6 w-6",nav_button_previous:"absolute left-1",nav_button_next:"absolute right-1",table:"w-full border-collapse space-y-1",head_row:"flex",head_cell:"text-gray-500 rounded-md w-7 font-normal text-[10px]",row:"flex w-full mt-2",cell:"h-7 w-7 text-center text-[11px] p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20",day:"inline-flex items-center justify-center rounded-md text-[11px] font-normal ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 aria-selected:opacity-100 h-7 w-7 hover:bg-gray-100 hover:text-gray-900 text-gray-900",day_range_start:"day-range-start bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",day_range_end:"day-range-end bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",day_selected:"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",day_today:"bg-accent text-accent-foreground font-semibold",outside:"!text-gray-400 !opacity-40 hover:!text-gray-500 hover:bg-gray-50 aria-selected:bg-accent/50 aria-selected:text-muted-foreground aria-selected:opacity-30",day_disabled:"!text-gray-400 !opacity-40",day_range_middle:"aria-selected:bg-accent aria-selected:text-accent-foreground",day_hidden:"invisible"}})}),n&&s.jsx("div",{className:"bg-gray-50 border-t border-gray-100 px-4 py-3",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("span",{className:"badge-text text-gray-600",children:["선택된 기간: ",h(n)]}),s.jsx(r,{onClick:()=>{l?.(void 0),p(!1)},className:"button-action-secondary",children:"지우기"})]})})]})})]})})}function se(){const[e,a]=t.useState(""),[H,E]=t.useState(""),[W,J]=t.useState(!1),[z,se]=t.useState([]),[ae,re]=t.useState(!1),ie=t.useRef(null),ne=t.useRef(null),[le,ce]=t.useState(!1),[de,oe]=t.useState(),[ue,me]=t.useState([]),[pe,he]=t.useState(null),[xe,ge]=t.useState(!1),[be,ye]=t.useState(),[fe,je]=t.useState([]),[ve,_e]=t.useState([]),Ne=["modify","delete","delivery_date_change","quantity_change","price_change"],we="delete"===e?"삭제할 발주요청 선택":"발주요청 선택",Se="delete"===e?"삭제 사유":"내용",qe=()=>`row-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,[Ie,Ce]=t.useState([]),[$e,ke]=t.useState(null),[Me,Te]=t.useState(""),[De,Oe]=t.useState(""),[Pe,Le]=t.useState([]),[Re,He]=t.useState(!0),[Ee,Fe]=t.useState(null),[Ae,Ve]=t.useState(!1),[We,Je]=t.useState(null),[ze,Ke]=t.useState(!1),[Qe,Be]=t.useState(null),[Ue,Ye]=t.useState(null),[Ge,Xe]=t.useState(!1),[Ze,et]=t.useState(null),[tt,st]=t.useState(!1),[at,rt]=t.useState(null),[it,nt]=t.useState(!1),[lt,ct]=t.useState("발주내역이 삭제 되었거나 없습니다."),[dt,ot]=t.useState([]),[ut,mt]=t.useState(!1),[pt,ht]=t.useState(!1),[xt,gt]=t.useState(""),[bt,yt]=t.useState(!1),ft=t.useRef(null),jt=t.useRef(null),vt=t.useRef(null),_t=t.useRef(!1),Nt=t.useRef(new Map);t.useEffect(()=>{wt()},[]),t.useEffect(()=>{if(null===$e)return;const e=n.subscribeToInquiries(e=>{const t=e?.eventType,s=e?.new,a=e?.old;if("DELETE"===t){const e=a?.id;if(!e)return;return Ce(t=>t.filter(t=>t.id!==e)),void(Ee===e&&Fe(null))}const r=s;r?.id&&Ce(e=>{const t=!!(s=r)&&(!!$e||!!De&&s.user_id===De);var s;const a=e.findIndex(e=>e.id===r.id);if(!t){if(-1===a)return e;return e.filter(e=>e.id!==r.id)}const i=[...e];return a>=0?i[a]=r:i.unshift(r),i.sort((e,t)=>{const s=e.created_at?new Date(e.created_at).getTime():0;return(t.created_at?new Date(t.created_at).getTime():0)-s}),i})});return()=>{e.unsubscribe()}},[$e,De]);const wt=async()=>{const e=l(),{data:{user:t}}=await e.auth.getUser();if(!t)return;Te(t.email||""),Oe(t.id);const{data:s}=await e.from("employees").select("purchase_role").eq("email",t.email).single();if(s){const e=Array.isArray(s.purchase_role)?s.purchase_role:s.purchase_role?.split(",").map(e=>e.trim())||[];Le(e);const t=e.includes("app_admin");ke(t),St(t)}},St=async e=>{He(!0);const t=e?await n.getAllInquiries():await n.getMyInquiries();t.success?Ce(t.data):$.error(t.error||"문의 목록 로드 실패"),He(!1)},qt=async()=>{if(null===$e)return;He(!0);const e=$e?await n.getAllInquiries():await n.getMyInquiries();e.success?Ce(e.data):$.error(e.error||"문의 목록 로드 실패"),He(!1)};t.useEffect(()=>{Ne.includes(e)?ce(!0):(ce(!1),he(null)),ye(void 0),je([]),_e([])},[e]),t.useEffect(()=>{ye(void 0),je([]),_e([])},[pe?.id]),t.useEffect(()=>{"quantity_change"===e&&0===fe.length&&je([{id:qe(),itemId:"",newQuantity:""}]),"price_change"===e&&0===ve.length&&_e([{id:qe(),itemId:"",changeType:"unit_price",newValue:""}])},[e,fe.length,ve.length]),t.useEffect(()=>{le&&de?.from&&de?.to&&It()},[le,de?.from,de?.to]);const It=async()=>{ge(!0);const e=de?.from?de.from.toISOString().split("T")[0]:void 0,t=de?.to?de.to.toISOString().split("T")[0]:void 0,s=await n.getMyPurchaseRequests(e,t);s.success?me(s.data):$.error(s.error||"발주요청 조회 실패"),ge(!1)};t.useEffect(()=>{if(!de){const e=new Date,t=new Date;t.setMonth(t.getMonth()-2),oe({from:t,to:e})}},[de]);const Ct=[...ue].sort((e,t)=>{const s=e.request_date||e.created_at,a=t.request_date||t.created_at,r=s?new Date(s).getTime():0;return(a?new Date(a).getTime():0)-r}).map(e=>{const t=e.purchase_order_number||"(승인대기)",s=e.vendor_name||"",a=e.purchase_request_items?.[0]?.item_name||"품목 없음",r=`${t} · ${s} · ${a}${e.purchase_request_items?.length>1?` 외 ${e.purchase_request_items.length-1}건`:""}`.trim(),i=`${t} ${s} ${e.requester_name||""} ${a}`.toLowerCase();return{value:String(e.id),label:r,data:e,searchText:i}}),$t=[{value:"delivery_date_change",label:"입고일 변경 요청"},{value:"quantity_change",label:"수량 변경 요청"},{value:"price_change",label:"단가/합계 금액 변경 요청"},{value:"bug",label:"오류 신고"},{value:"modify",label:"수정 요청"},{value:"delete",label:"삭제 요청"},{value:"other",label:"기타 문의"}],kt=Array.isArray(pe?.purchase_request_items)?[...pe.purchase_request_items].sort((e,t)=>(e.line_number??Number.MAX_SAFE_INTEGER)-(t.line_number??Number.MAX_SAFE_INTEGER)):[],Mt=kt.map(e=>({value:String(e.id),label:`${e.line_number?`${e.line_number}.`:""} ${e.item_name} (${e.specification||"-"})`.trim()})),Tt=e=>{if("undefined"==typeof document)return 7*e.length;ne.current||(ne.current=document.createElement("canvas"));const t=ne.current.getContext("2d");return t?(t.font=(()=>{if("undefined"==typeof document)return'11px Pretendard, -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans KR", sans-serif';const e=window.getComputedStyle(document.body),t=e.fontFamily||'Pretendard, -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans KR", sans-serif';return`${e.fontWeight||"400"} 11px ${t}`})(),Math.ceil(t.measureText(e).width)):7*e.length},Dt=(e,t=4,s=12)=>Math.max(e.length+t,s),Ot=e=>e.reduce((e,t)=>{const s=t.label??"";return Math.max(e,Tt(s))},0),Pt=(e,t)=>{const s=Ot(e),a=Math.max(s,Tt(t));return Math.ceil(a+24+30)},Lt=(e,t)=>{const s=Ot(e),a=Math.max(s,Tt(t));return Math.ceil(a+24+30+14)},Rt="문의 유형을 선택해주세요",Ht=Dt(Rt,3,14),Et=Dt($t.reduce((e,t)=>{const s=t.label||"";return s.length>e.length?s:e},Rt),3,Ht),Ft="발주번호 선택/검색",At=Pt(Ct,Ft),Vt=Lt(Ct,Ft),Wt="품목 선택/검색",Jt=Pt(Mt,Wt),zt=Lt(Mt,Wt),Kt=[{value:"unit_price",label:"단가"},{value:"amount",label:"합계액"}],Qt=e=>{if(!e)return"";const t=Number(e);return Number.isFinite(t)?t.toLocaleString("ko-KR"):e},Bt=Math.max(19,22),Ut=(e,t)=>({control:e=>({...e,minHeight:"28px",height:"28px",fontSize:"11px",borderRadius:"8px",borderColor:"#e5e7eb",boxShadow:"none"}),container:t=>({...t,width:e?`${e}px`:t.width,maxWidth:"100%"}),valueContainer:e=>({...e,padding:"0 8px"}),input:e=>({...e,margin:0,padding:0,fontSize:"11px"}),indicatorsContainer:e=>({...e,height:"28px"}),option:e=>({...e,fontSize:"11px",whiteSpace:"nowrap",overflow:"visible",textOverflow:"clip"}),placeholder:e=>({...e,fontSize:"11px",color:"#9ca3af"}),singleValue:e=>({...e,fontSize:"11px",overflow:"visible",textOverflow:"clip",maxWidth:"none"}),menu:e=>({...e,width:t?`${t}px`:e.width,minWidth:t?`${t}px`:e.minWidth,maxWidth:t?`${t}px`:"90vw"}),menuList:e=>({...e,width:t?`${t}px`:e.width,minWidth:t?`${t}px`:e.minWidth,maxWidth:t?`${t}px`:e.maxWidth})}),Yt=(e,t)=>{je(s=>s.map(s=>s.id===e?{...s,...t}:s))},Gt=(e,t)=>{_e(s=>s.map(s=>s.id===e?{...s,...t}:s))},Xt=async(e,t,s)=>{if("resolved"===t){const t=await n.resolveInquiry(e);t.success?($.success("문의가 완료 처리되었습니다."),qt()):$.error(t.error||"완료 처리 실패")}else{const s=await n.updateInquiryStatus(e,t);s.success?($.success("상태가 업데이트되었습니다."),qt()):$.error(s.error||"상태 업데이트 실패")}},Zt=Ie.find(e=>e.id===Ee)||null;t.useEffect(()=>{if(!Zt?.id)return;const e=Zt.id;let t=!1;_t.current=!0;const s=Nt.current.get(e);s&&s.length>0?(ot(s),mt(!1),ht(!0)):(ot([]),mt(!0),ht(!1));const a=async()=>{(Nt.current.get(e)?.length??0)>0?ht(!0):mt(!0);const s=await n.getInquiryMessages(e);if(!t)if(s.success){const t=ft.current,a=t?.scrollTop??0,r=vt.current!==e;vt.current=e;const i=!!r||(!t||t.scrollHeight-t.scrollTop-t.clientHeight<80);jt.current={atBottom:i,prevTop:a},ot(s.data),Nt.current.set(e,s.data),mt(!1),ht(!1)}else $.error(s.error||"대화 내용을 불러오지 못했습니다."),mt(!1),ht(!1)};a(),(async()=>{if($e)return;if(!Me)return;const t=l();await t.from("notifications").update({is_read:!0,read_at:(new Date).toISOString()}).eq("user_email",Me).eq("is_read",!1).in("type",["inquiry_message","inquiry_resolved"]).eq("data->>inquiryId",String(e))})();const r=n.subscribeToInquiryMessages(e,()=>{a()});return()=>{t=!0,r.unsubscribe()}},[Zt?.id,$e,Me]),t.useLayoutEffect(()=>{if(!Zt?.id)return;const e=ft.current;if(e)if(_t.current)e.scrollTop=e.scrollHeight,(dt.length>0||!ut)&&(_t.current=!1);else{const t=jt.current;if(!t)return;t.atBottom?e.scrollTop=e.scrollHeight:e.scrollTop=t.prevTop}},[Zt?.id,dt,ut]);const es=()=>{Be(null),Ye(null)},ts=e=>{switch(e){case"open":return s.jsx("span",{className:"badge-stats bg-yellow-100 text-yellow-800",children:"대기"});case"in_progress":return s.jsx("span",{className:"badge-stats bg-blue-100 text-blue-800",children:"처리중"});case"resolved":return s.jsx("span",{className:"badge-stats bg-green-100 text-green-800",children:"완료"});case"closed":return s.jsx("span",{className:"badge-stats bg-gray-100 text-gray-800",children:"종료"});default:return s.jsx("span",{className:"badge-stats border border-gray-300 bg-white text-gray-600",children:"-"})}},ss=e=>{switch(e){case"bug":return"오류 신고";case"modify":return"수정 요청";case"delivery_date_change":return"입고일 변경 요청";case"quantity_change":return"수량 변경 요청";case"price_change":return"단가/합계 금액 변경 요청";case"delete":return"삭제 요청";case"annual_leave":return"연차 문의";case"attendance":return"근태 문의";case"other":return"기타 문의";default:return e}},as=e=>{const t=e.inquiry_payload;if(!t||"object"!=typeof t)return null;if("delivery_date_change"===e.inquiry_type)return s.jsxs("div",{children:[s.jsx("span",{className:"modal-value text-gray-700",children:"입고일 변경 요청:"}),s.jsxs("div",{className:"mt-1 text-gray-600",children:[s.jsxs("div",{children:["현재 입고요청일: ",t.current_date||"-"]}),s.jsxs("div",{children:["변경 입고일: ",t.requested_date||"-"]})]})]});if("quantity_change"===e.inquiry_type){const e=Array.isArray(t.items)?t.items:[];return 0===e.length?null:s.jsxs("div",{children:[s.jsx("span",{className:"modal-value text-gray-700",children:"수량 변경 요청:"}),s.jsx("div",{className:"mt-1 text-gray-600 space-y-1",children:e.map((e,t)=>s.jsxs("div",{children:[e.line_number??"-","번 ",e.item_name," (",e.specification||"-",") ",e.current_quantity??"-"," → ",e.new_quantity]},`${e.item_id}-${t}`))})]})}if("price_change"===e.inquiry_type){const e=Array.isArray(t.items)?t.items:[];return 0===e.length?null:s.jsxs("div",{children:[s.jsx("span",{className:"modal-value text-gray-700",children:"단가/합계 금액 변경 요청:"}),s.jsx("div",{className:"mt-1 text-gray-600 space-y-1",children:e.map((e,t)=>s.jsxs("div",{children:[e.line_number??"-","번 ",e.item_name," (",e.specification||"-",")"," ","amount"===e.change_type?`합계 ${e.current_amount??"-"} → ${e.new_amount??"-"}`:`단가 ${e.current_unit_price??"-"} → ${e.new_unit_price??"-"} 합계 ${e.current_amount??"-"} → ${e.new_amount??"-"}`]},`${e.item_id}-${t}`))})]})}return"delete"===e.inquiry_type&&t.reason?s.jsxs("div",{children:[s.jsx("span",{className:"modal-value text-gray-700",children:"삭제 사유:"}),s.jsx("p",{className:"text-gray-600 mt-1 whitespace-pre-wrap",children:t.reason})]}):null};return null===$e?s.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"}),s.jsx("p",{className:"text-gray-600",children:"권한 확인 중..."})]})}):s.jsxs("div",{className:"min-h-screen bg-gray-50",children:[s.jsxs("div",{className:"w-full max-w-none mx-0 px-3 sm:px-4 lg:px-5 pb-6",children:[s.jsxs("div",{className:"mb-4",children:[s.jsx("h1",{className:"page-title text-gray-900",children:"문의하기"}),s.jsx("p",{className:"page-subtitle text-gray-600 mt-1",children:$e?"모든 문의를 관리하고 답변할 수 있습니다":"시스템 사용 중 궁금하신 점이나 개선사항을 알려주세요"})]}),s.jsxs("div",{className:""+($e?"w-full":"grid grid-cols-1 xl:grid-cols-2 gap-4"),children:[!$e&&s.jsxs(u,{className:"business-radius-card border border-gray-200 shadow-sm",children:[s.jsx(m,{className:"pb-3 pt-4 px-4",children:s.jsxs(p,{className:"section-title flex items-center gap-2 text-gray-900",children:[s.jsx(c,{className:"w-4 h-4 text-gray-600"}),"문의 내용"]})}),s.jsx(h,{className:"px-4 pb-4",children:s.jsxs("form",{onSubmit:async t=>{if(t.preventDefault(),fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SupportMain.tsx:handleSubmit:start",message:"submit_start",data:{inquiryType:e,messageLength:H.length,loading:W,uploadingImage:ae,selectedPurchaseId:pe?.id??null,showPurchaseSelect:le},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"H1"})}).catch(()=>{}),!e||!H)return fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SupportMain.tsx:handleSubmit:validation",message:"missing_required",data:{inquiryType:e,hasMessage:!!H},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"H2"})}).catch(()=>{}),void $.error("모든 필드를 입력해주세요.");const s=Ne.includes(e);if(s&&!pe)return fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SupportMain.tsx:handleSubmit:validation",message:"missing_purchase",data:{inquiryType:e,requiresPurchase:s},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"H2"})}).catch(()=>{}),void $.error("발주요청을 선택해주세요.");J(!0);const r=ss(e)||e;let i=H,l="",c=null;const d=[];if("delivery_date_change"===e){if(!be)return fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SupportMain.tsx:handleSubmit:validation",message:"missing_requested_delivery_date",data:{inquiryType:e},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"H2"})}).catch(()=>{}),$.error("변경 입고일을 입력해주세요."),void J(!1);const t=pe?.delivery_request_date?A(new Date(pe.delivery_request_date),"yyyy-MM-dd"):"-",s=A(be,"yyyy-MM-dd");c={requested_date:s,current_date:pe?.delivery_request_date||null},d.push(`현재 입고요청일: ${t}`),d.push(`변경 입고일: ${s}`)}if("quantity_change"===e){const t=fe.filter(e=>e.itemId||e.newQuantity.trim());if(0===t.length)return fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SupportMain.tsx:handleSubmit:validation",message:"missing_quantity_rows",data:{inquiryType:e,rows:fe.length},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"H2"})}).catch(()=>{}),$.error("수량 변경할 품목을 추가해주세요."),void J(!1);const s=[];for(const e of t){if(!e.itemId||!e.newQuantity.trim())return fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SupportMain.tsx:handleSubmit:validation",message:"invalid_quantity_row",data:{itemId:e.itemId,hasQuantity:!!e.newQuantity.trim()},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"H2"})}).catch(()=>{}),$.error("수량 변경 항목을 모두 입력해주세요."),void J(!1);const t=Number(e.newQuantity);if(!Number.isFinite(t))return fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SupportMain.tsx:handleSubmit:validation",message:"invalid_quantity_value",data:{value:e.newQuantity},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"H2"})}).catch(()=>{}),$.error("변경 수량이 올바르지 않습니다."),void J(!1);const a=kt.find(t=>String(t.id)===e.itemId);if(!a)return fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SupportMain.tsx:handleSubmit:validation",message:"missing_target_item",data:{itemId:e.itemId},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"H2"})}).catch(()=>{}),$.error("선택한 품목을 찾을 수 없습니다."),void J(!1);s.push({item_id:String(a.id),line_number:a.line_number??null,item_name:a.item_name,specification:a.specification??null,current_quantity:a.quantity??null,new_quantity:t}),d.push(`${a.line_number??"-"}번 ${a.item_name} (${a.specification||"-"}) ${a.quantity??0} → ${t}`)}c={items:s}}if("price_change"===e){const t=ve.filter(e=>e.itemId||e.newValue.trim());if(0===t.length)return fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SupportMain.tsx:handleSubmit:validation",message:"missing_price_rows",data:{inquiryType:e,rows:ve.length},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"H2"})}).catch(()=>{}),$.error("단가/합계 금액 변경할 품목을 추가해주세요."),void J(!1);const s=[];for(const e of t){if(!e.itemId||!e.newValue.trim())return fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SupportMain.tsx:handleSubmit:validation",message:"invalid_price_row",data:{itemId:e.itemId,hasValue:!!e.newValue.trim(),changeType:e.changeType},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"H2"})}).catch(()=>{}),$.error("단가/합계 금액 변경 항목을 모두 입력해주세요."),void J(!1);const t=Number(e.newValue);if(!Number.isFinite(t))return fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SupportMain.tsx:handleSubmit:validation",message:"invalid_price_value",data:{value:e.newValue,changeType:e.changeType},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"H2"})}).catch(()=>{}),$.error("변경 값이 올바르지 않습니다."),void J(!1);const a=kt.find(t=>String(t.id)===e.itemId);if(!a)return fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SupportMain.tsx:handleSubmit:validation",message:"missing_target_item_price",data:{itemId:e.itemId},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"H2"})}).catch(()=>{}),$.error("선택한 품목을 찾을 수 없습니다."),void J(!1);const r=Number(a.unit_price_value??a.unit_price??0),i=Number(a.amount_value??r*(a.quantity??0)),n=Number(a.quantity??0);if("amount"===e.changeType){const e=t,l=n>0?e/n:0;s.push({item_id:String(a.id),line_number:a.line_number??null,item_name:a.item_name,specification:a.specification??null,change_type:"amount",current_unit_price:r,new_unit_price:l,current_amount:i,new_amount:e}),d.push(`${a.line_number??"-"}번 ${a.item_name} (${a.specification||"-"}) 합계 ${i.toLocaleString("ko-KR")} → ${e.toLocaleString("ko-KR")}`)}else{const e=t,l=n*e;s.push({item_id:String(a.id),line_number:a.line_number??null,item_name:a.item_name,specification:a.specification??null,change_type:"unit_price",current_unit_price:r,new_unit_price:e,current_amount:i,new_amount:l}),d.push(`${a.line_number??"-"}번 ${a.item_name} (${a.specification||"-"}) 단가 ${r.toLocaleString("ko-KR")} → ${e.toLocaleString("ko-KR")} 합계 ${i.toLocaleString("ko-KR")} → ${l.toLocaleString("ko-KR")}`)}}c={items:s}}if("delete"===e&&(c={reason:H.trim()}),pe){const e=(pe.purchase_request_items||[]).map((e,t)=>`- ${e.line_number??t+1}. ${e.item_name} (${e.specification||"-"}) ${e.quantity}개`).join("\n");l=`발주번호: ${pe.purchase_order_number||"(승인대기)"}\n업체: ${pe.vendor_name}\n요청자: ${pe.requester_name}\n요청일: ${pe.request_date||pe.created_at||"-"}\n품목:\n${e}`}const o=[H.trim()];d.length>0&&o.push(`[요청 상세]\n${d.join("\n")}`),l&&o.push(`[관련 발주 정보]\n${l}`),i=o.join("\n\n");const u=await n.createInquiry({inquiry_type:e,subject:r,message:i,purchase_request_id:pe?.id,purchase_info:l,purchase_order_number:pe?.purchase_order_number,attachments:z,inquiry_payload:c});if(fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SupportMain.tsx:handleSubmit:createInquiry",message:"submit_result",data:{success:u.success,error:u.error||null,inquiryId:u.inquiryId||null},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"H3"})}).catch(()=>{}),u.success){$.success("문의가 접수되었습니다.");const e=u.inquiryId;a(""),E(""),he(null),me([]),oe(void 0),se([]),qt(),e&&Fe(e)}else $.error(u.error||"문의 접수에 실패했습니다.");J(!1)},className:"space-y-4",children:[s.jsxs("div",{children:[s.jsxs("label",{className:"block modal-label text-gray-700 mb-1",children:["문의 유형 ",s.jsx("span",{className:"text-red-500",children:"*"})]}),s.jsxs(N,{value:e,onValueChange:a,children:[s.jsx(w,{size:"sm",className:"button-base business-radius-input border border-gray-300 bg-white text-gray-700 w-auto !h-7 !px-2.5 !text-[11px]",style:{width:`${Ht}em`,maxWidth:"100%"},children:s.jsx(S,{placeholder:Rt})}),s.jsx(q,{className:"text-[11px] business-radius-card",style:{minWidth:`${Et}em`},children:$t.map(e=>s.jsx(I,{className:"text-[11px] py-1.5",value:e.value,children:e.label},e.value))})]})]}),le&&s.jsxs("div",{className:"space-y-3 p-4 bg-gray-50 business-radius-card border border-gray-200",children:[s.jsx("div",{className:"modal-section-title text-gray-900",children:we}),s.jsxs("div",{children:[s.jsx("label",{className:"modal-label text-gray-600 mb-2 block",children:"기간 선택"}),s.jsx(te,{date:de,onDateChange:oe,placeholder:"발주요청 기간을 선택하세요",className:"inline-grid w-fit",style:{width:`${Bt}em`,maxWidth:"100%"},triggerClassName:"button-base w-fit justify-start border border-gray-300 bg-white text-gray-700 business-radius-input"})]}),s.jsxs("div",{className:"space-y-3",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"modal-label text-gray-600",children:["발주요청 선택 (총 ",ue.length,"건)"]}),xe&&s.jsx("span",{className:"badge-text text-gray-400",children:"조회 중…"})]}),s.jsx(F,{value:Ct.find(e=>e.value===String(pe?.id))||null,onChange:e=>he(e?.data||null),options:Ct,placeholder:"발주번호 선택/검색",isSearchable:!0,isLoading:xe,noOptionsMessage:()=>"일치하는 발주가 없습니다",filterOption:(e,t)=>{const s=t.toLowerCase(),a=e.label.toLowerCase(),r=e.data?.searchText||"";return a.includes(s)||r.includes(s)},styles:Ut(At,Vt)}),!xe&&0===ue.length&&s.jsx("div",{className:"card-description text-gray-500",children:"선택한 기간 내 발주요청이 없습니다."}),pe&&s.jsxs("div",{className:"px-3 py-2 bg-white border border-gray-200 business-radius-card",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:"card-title",children:pe.purchase_order_number||"(승인대기)"}),s.jsx("span",{className:"card-subtitle",children:pe.vendor_name}),s.jsx("span",{className:"card-date",children:(pe.request_date||pe.created_at)&&A(new Date(pe.request_date||pe.created_at),"MM/dd")})]}),kt.length>0&&s.jsxs("div",{className:"mt-2 space-y-1",children:[s.jsx("div",{className:"modal-label text-gray-600",children:"품목 상세"}),kt.map((e,t)=>s.jsxs("div",{className:"flex items-center gap-2 pl-2",children:[s.jsxs("span",{className:"card-description text-gray-400",children:[e.line_number??t+1,"."]}),s.jsx("span",{className:"card-description",children:e.item_name}),e.specification&&s.jsxs("span",{className:"card-description text-gray-500",children:["(",e.specification,")"]}),s.jsxs("span",{className:"card-description text-gray-500",children:["- ",e.quantity,"개"]})]},e.id||t))]})]})]})]}),"delivery_date_change"===e&&s.jsxs("div",{className:"space-y-3 p-4 bg-gray-50 business-radius-card border border-gray-200",children:[s.jsx("div",{className:"modal-section-title text-gray-900",children:"입고일 변경 요청"}),s.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"modal-label text-gray-600 mb-1 block",children:"현재 입고요청일"}),s.jsx("div",{className:"modal-value text-gray-700",children:pe?.delivery_request_date?A(new Date(pe.delivery_request_date),"yyyy-MM-dd"):"-"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"modal-label text-gray-600 mb-1 block",children:"변경 입고일"}),s.jsx(V,{onDateSelect:e=>ye(e),placeholder:"변경 입고일 선택",align:"start",side:"bottom",children:s.jsxs(r,{type:"button",className:"button-base w-full justify-start border border-gray-300 bg-white text-gray-700 business-radius-input",disabled:!pe,children:[s.jsx(K,{className:"mr-2 h-4 w-4"}),be?A(be,"yyyy-MM-dd"):"날짜 선택"]})})]})]})]}),"quantity_change"===e&&s.jsxs("div",{className:"space-y-3 p-4 bg-gray-50 business-radius-card border border-gray-200",children:[s.jsx("div",{className:"modal-section-title text-gray-900",children:"수량 변경 요청"}),s.jsx("div",{className:"space-y-2",children:fe.map(e=>{const t=kt.find(t=>String(t.id)===e.itemId);return s.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2",children:[s.jsx("div",{className:"flex-1",children:s.jsx(F,{value:Mt.find(t=>t.value===e.itemId)||null,onChange:t=>Yt(e.id,{itemId:t?.value||""}),options:Mt,placeholder:"품목 선택/검색",isSearchable:!0,isDisabled:!pe,noOptionsMessage:()=>"일치하는 품목이 없습니다",filterOption:(e,t)=>e.label.toLowerCase().includes(t.toLowerCase()),styles:Ut(Jt,zt)})}),s.jsx("div",{className:"badge-text text-gray-600 sm:w-24 text-right",children:"변경 수량 :"}),s.jsx(g,{type:"number",value:e.newQuantity,onChange:t=>Yt(e.id,{newQuantity:t.target.value}),placeholder:`입고 수량 : ${t?.quantity??"-"}`,className:"sm:w-28 business-radius-input h-7 !text-[11px] !leading-tight",min:0,disabled:!pe}),s.jsxs("button",{type:"button",onClick:()=>{return t=e.id,void je(e=>e.filter(e=>e.id!==t));var t},className:"button-action-danger",children:[s.jsx(x,{className:"w-3.5 h-3.5 mr-1"}),"삭제"]})]},e.id)})}),s.jsxs("button",{type:"button",onClick:()=>{je(e=>[...e,{id:qe(),itemId:"",newQuantity:""}])},className:"button-action-secondary",disabled:!pe,children:[s.jsx(b,{className:"w-3.5 h-3.5 mr-1"}),"품목 추가"]})]}),"price_change"===e&&s.jsxs("div",{className:"space-y-3 p-4 bg-gray-50 business-radius-card border border-gray-200",children:[s.jsx("div",{className:"modal-section-title text-gray-900",children:"단가/합계 금액 변경 요청"}),s.jsx("div",{className:"space-y-2",children:ve.map(e=>{const t=kt.find(t=>String(t.id)===e.itemId),a=Number(t?.unit_price_value??t?.unit_price??0),r=Number(t?.amount_value??a*(t?.quantity??0)),i=t?a.toLocaleString("ko-KR"):"-",n=t?r.toLocaleString("ko-KR"):"-",l="amount"===e.changeType?`현재 합계액: ${n}`:`현재 단가: ${i}`;return s.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center gap-2",children:[s.jsx("div",{className:"flex-1",children:s.jsx(F,{value:Mt.find(t=>t.value===e.itemId)||null,onChange:t=>Gt(e.id,{itemId:t?.value||""}),options:Mt,placeholder:"품목 선택/검색",isSearchable:!0,isDisabled:!pe,noOptionsMessage:()=>"일치하는 품목이 없습니다",filterOption:(e,t)=>e.label.toLowerCase().includes(t.toLowerCase()),styles:Ut(Jt,zt)})}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:"badge-text text-gray-600",children:"변경 요청"}),s.jsxs(N,{value:e.changeType,onValueChange:t=>Gt(e.id,{changeType:t,newValue:""}),disabled:!pe,children:[s.jsx(w,{size:"sm",className:"button-base business-radius-input border border-gray-300 bg-white text-gray-700 w-auto !h-7 !px-2.5 !text-[11px]",children:s.jsx(S,{})}),s.jsx(q,{className:"text-[11px] business-radius-card",children:Kt.map(e=>s.jsx(I,{className:"text-[11px] py-1.5",value:e.value,children:e.label},e.value))})]})]}),s.jsx(g,{type:"text",inputMode:"numeric",value:Qt(e.newValue),onChange:t=>{return Gt(e.id,{newValue:(s=t.target.value,s.replace(/[^\d]/g,""))});var s},placeholder:l,className:"lg:w-40 business-radius-input h-7 !text-[11px] !leading-tight",min:0,disabled:!pe}),s.jsxs("button",{type:"button",onClick:()=>{return t=e.id,void _e(e=>e.filter(e=>e.id!==t));var t},className:"button-action-danger",children:[s.jsx(x,{className:"w-3.5 h-3.5 mr-1"}),"삭제"]})]},e.id)})}),s.jsxs("button",{type:"button",onClick:()=>{_e(e=>[...e,{id:qe(),itemId:"",changeType:"unit_price",newValue:""}])},className:"button-action-secondary",disabled:!pe,children:[s.jsx(b,{className:"w-3.5 h-3.5 mr-1"}),"품목 추가"]})]}),s.jsxs("div",{children:[s.jsxs("label",{className:"block modal-label text-gray-700 mb-1",children:[Se," ",s.jsx("span",{className:"text-red-500",children:"*"})]}),s.jsx(_,{value:H,onChange:e=>E(e.target.value),placeholder:"delete"===e?"삭제 사유를 입력해주세요":"문의 내용을 자세히 입력해주세요",rows:6,maxLength:1e3,className:"business-radius-input text-[11px]"}),s.jsxs("p",{className:"badge-text text-gray-500 mt-1",children:[H.length,"/1000"]})]}),s.jsxs("div",{children:[s.jsxs("label",{className:"block modal-label text-gray-700 mb-2",children:["사진 첨부 ",s.jsx("span",{className:"badge-text text-gray-400",children:"(선택, 최대 5개)"})]}),z.length>0&&s.jsx("div",{className:"flex flex-wrap gap-2 mb-3",children:z.map((e,t)=>s.jsxs("div",{className:"relative group",children:[s.jsx("img",{src:e.url,alt:e.name,className:"w-20 h-20 object-cover business-radius-card border border-gray-200"}),s.jsx("button",{type:"button",onClick:()=>(async e=>{const t=z[e];await n.deleteAttachment(t.path),se(t=>t.filter((t,s)=>s!==e)),$.success("첨부파일이 삭제되었습니다.")})(t),className:"button-base absolute -top-2 -right-2 bg-red-500 text-white business-radius-badge opacity-0 group-hover:opacity-100 transition-opacity",title:"삭제",children:s.jsx(i,{className:"w-3 h-3"})}),s.jsx("p",{className:"text-[10px] text-gray-500 mt-1 truncate w-20 text-center",children:e.name})]},t))}),z.length<5&&s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("input",{ref:ie,type:"file",accept:"image/*",onChange:async e=>{const t=e.target.files;if(!t||0===t.length)return;if(z.length>=5)return void $.error("첨부파일은 최대 5개까지 가능합니다.");const s=t[0];if(s.size>5242880)return void $.error("파일 크기는 5MB 이하만 가능합니다.");if(!s.type.startsWith("image/"))return void $.error("이미지 파일만 첨부 가능합니다.");re(!0);const a=await n.uploadAttachment(s);a.success&&a.data?(se(e=>[...e,a.data]),$.success("이미지가 첨부되었습니다.")):$.error(a.error||"이미지 업로드 실패"),re(!1),ie.current&&(ie.current.value="")},className:"hidden"}),s.jsx("button",{type:"button",onClick:()=>ie.current?.click(),disabled:ae,className:"button-action-secondary disabled:opacity-50 disabled:cursor-not-allowed",children:ae?s.jsxs(s.Fragment,{children:[s.jsx(U,{className:"w-3.5 h-3.5 animate-spin"}),"업로드 중..."]}):s.jsxs(s.Fragment,{children:[s.jsx(Z,{className:"w-3.5 h-3.5"}),"사진 추가"]})}),s.jsxs("span",{className:"badge-text text-gray-400",children:[z.length,"/5"]})]})]}),s.jsx("div",{className:"flex justify-end",children:s.jsx("button",{type:"submit",className:"button-action-primary",disabled:W||ae,onClick:()=>{fetch("http://127.0.0.1:7242/ingest/b22edbac-a44c-4882-a88d-47f6cafc7628",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SupportMain.tsx:submitButton:onClick",message:"submit_click",data:{disabled:W||ae},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"H1"})}).catch(()=>{})},children:W?s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}),"전송 중..."]}):s.jsxs(s.Fragment,{children:[s.jsx(ee,{className:"w-4 h-4 mr-2"}),"문의 보내기"]})})})]})})]}),s.jsxs(u,{className:"business-radius-card border border-gray-200 shadow-sm",children:[s.jsx(m,{className:"pb-3 pt-4 px-4",children:s.jsxs(p,{className:"section-title flex items-center justify-between text-gray-900",children:[s.jsxs("span",{className:"flex items-center gap-2",children:[s.jsx(d,{className:"w-4 h-4 text-orange-500"}),$e?"전체 문의 목록":"내 문의 내역"]}),s.jsxs("span",{className:"badge-stats border border-gray-300 bg-white text-gray-600",children:[Ie.length,"건"]})]})}),s.jsx(h,{className:"px-4 pb-4",children:Re?s.jsx("div",{className:"flex items-center justify-center py-8",children:s.jsx("div",{className:"w-6 h-6 border-2 border-gray-300 border-t-transparent rounded-full animate-spin"})}):0===Ie.length?s.jsxs("div",{className:"text-center py-8 text-gray-500",children:[s.jsx(c,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),s.jsx("p",{className:"card-description text-gray-500",children:"문의 내역이 없습니다"})]}):s.jsx("div",{className:"space-y-2 max-h-[600px] overflow-y-auto",children:Ie.map(e=>s.jsxs("div",{className:"border border-gray-200 business-radius-card overflow-hidden bg-white",children:[s.jsx("div",{className:"px-4 py-1.5 hover:bg-gray-50 transition-colors cursor-pointer",onClick:()=>{Fe(Ee===e.id?null:e.id)},children:s.jsxs("div",{className:"flex items-center justify-between gap-2",children:[s.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0 flex-nowrap",children:[s.jsx("span",{className:"badge-stats border border-gray-300 bg-white text-gray-600 whitespace-nowrap flex-shrink-0",children:ss(e.inquiry_type)}),s.jsx("span",{className:"flex-shrink-0",children:ts(e.status)}),e.purchase_order_number?s.jsx("button",{type:"button",className:"card-title truncate flex-1 min-w-0 text-blue-600 hover:underline text-left",onClick:t=>{t.stopPropagation(),(async e=>{try{if(e.purchase_request_id)return et(e.purchase_request_id),void Xe(!0);const t=e.purchase_order_number?.trim();if(!t)return ct("발주내역이 삭제 되었거나 없습니다."),void nt(!0);const s=l(),{data:a,error:r}=await s.from("purchase_requests").select("id").eq("purchase_order_number",t).limit(1).maybeSingle();if(r)throw r;if(!a?.id)return ct("발주내역이 삭제 되었거나 없습니다."),void nt(!0);et(a.id),Xe(!0)}catch(t){ct("발주내역이 삭제 되었거나 없습니다."),nt(!0)}})(e)},title:"발주 상세 열기",children:e.purchase_order_number}):s.jsx("span",{className:"card-title truncate flex-1 min-w-0",children:e.subject}),$e&&s.jsx("span",{className:"badge-text text-gray-500 whitespace-nowrap flex-shrink-0",children:e.user_name||e.user_email}),s.jsx("span",{className:"badge-text text-gray-400 ml-auto whitespace-nowrap flex-shrink-0",children:e.created_at&&A(new Date(e.created_at),"MM/dd HH:mm")})]}),s.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0",children:[$e&&"open"===e.status&&s.jsx("button",{type:"button",onClick:t=>{t.stopPropagation(),Xt(e.id,"in_progress")},className:"button-waiting-active",children:"처리중"}),$e&&("open"===e.status||"in_progress"===e.status)&&s.jsx("button",{type:"button",onClick:t=>{t.stopPropagation(),Xt(e.id,"resolved")},className:"button-action-success",children:"완료"}),($e||"open"===e.status&&!e.resolution_note&&e.user_email===Me)&&s.jsx("button",{type:"button",onClick:t=>{t.stopPropagation(),(async e=>{if(!confirm("정말로 이 문의를 삭제하시겠습니까?\n삭제된 문의는 복구할 수 없습니다."))return;const t=await n.deleteInquiry(e);t.success?($.success("문의가 삭제되었습니다."),qt()):$.error(t.error||"문의 삭제 실패")})(e.id)},className:"button-base border border-red-200 bg-white text-red-600 hover:bg-red-50",title:"문의 삭제",children:s.jsx(x,{className:"w-3.5 h-3.5"})}),s.jsx("button",{type:"button",className:"button-action-secondary",children:Ee===e.id?s.jsx(C,{className:"w-4 h-4"}):s.jsx(Y,{className:"w-4 h-4"})})]})]})}),Ee===e.id&&s.jsx("div",{className:"px-3 py-3 bg-gray-50 border-t",children:s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{children:[s.jsx("span",{className:"modal-value text-gray-700",children:"내용:"}),s.jsx("p",{className:"card-description text-gray-600 mt-1 whitespace-pre-wrap",children:e.message})]}),as(e),e.handled_by&&s.jsxs("div",{children:[s.jsx("span",{className:"modal-value text-gray-700",children:"처리자:"}),s.jsxs("span",{className:"text-green-600 ml-2",children:[e.handled_by,e.processed_at&&` (${A(new Date(e.processed_at),"yyyy-MM-dd HH:mm")})`]})]}),e.attachments&&e.attachments.length>0&&s.jsxs("div",{children:[s.jsx("span",{className:"modal-value text-gray-700",children:"첨부 이미지:"}),s.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:e.attachments.map((e,t)=>s.jsx("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",className:"block",onClick:e=>e.stopPropagation(),children:s.jsx("img",{src:e.url,alt:e.name,className:"w-24 h-24 object-cover business-radius-card border border-gray-200 hover:border-blue-400 transition-colors cursor-pointer"})},t))})]}),s.jsxs("div",{className:"mt-3 border-t pt-3",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("div",{className:"modal-value text-gray-800",children:"대화"}),$e&&"resolved"!==e.status&&"closed"!==e.status&&s.jsx("button",{type:"button",onClick:e=>{e.stopPropagation(),(async()=>{if(!Zt?.id)return;const e=await n.resolveInquiry(Zt.id);e.success?($.success("문의가 완료 처리되었습니다."),gt(""),Fe(null),qt()):$.error(e.error||"완료 처리 실패")})()},className:"button-action-success",children:"완료"})]}),s.jsxs("div",{className:"mt-2 border border-gray-200 business-radius-card bg-white relative",children:[pt&&s.jsx("div",{className:"absolute top-2 right-2 badge-text text-gray-400 bg-white/80 backdrop-blur px-2 py-1 business-radius-badge border pointer-events-none","aria-hidden":"true",children:"업데이트 중…"}),s.jsx("div",{ref:ft,className:"max-h-[260px] overflow-y-auto p-3 space-y-2",children:ut&&0===dt.length?s.jsx("div",{className:"flex items-center justify-center py-8",children:s.jsx("div",{className:"w-6 h-6 border-2 border-gray-300 border-t-transparent rounded-full animate-spin"})}):0===dt.length?s.jsx("div",{className:"text-center text-gray-500 py-8 card-description",children:"대화 내용이 없습니다."}):dt.map(e=>{const t="system"===e.sender_role,a=!t&&e.sender_email===Me;return s.jsx("div",{className:t?"text-center":"flex "+(a?"justify-end":"justify-start"),children:s.jsxs("div",{className:t?"inline-block badge-text text-gray-500 px-3 py-1 business-radius-badge bg-gray-50 border":"max-w-[80%] business-radius-card px-3 py-2 "+(a?"bg-blue-600 text-white":"bg-gray-50 border text-gray-800"),children:[!t&&s.jsxs("div",{className:"badge-text mb-1 "+(a?"text-white/80":"text-gray-500"),children:["admin"===e.sender_role?"관리자":"문의자",e.created_at&&` · ${A(new Date(e.created_at),"MM/dd HH:mm")}`]}),s.jsx("div",{className:"whitespace-pre-wrap card-description",children:e.message}),e.attachments&&e.attachments.length>0&&s.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:e.attachments.map((e,t)=>s.jsx("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",className:"block",onClick:e=>e.stopPropagation(),children:s.jsx("img",{src:e.url,alt:e.name,className:"w-20 h-20 object-cover business-radius-card border"})},t))})]})},e.id)})}),s.jsx("div",{className:"border-t p-2",children:"resolved"===e.status||"closed"===e.status?s.jsx("div",{className:"card-description text-gray-500 text-center py-1",children:"완료된 문의입니다. 추가 대화가 필요하면 새 문의를 등록해주세요."}):s.jsxs("div",{className:"flex items-end gap-2",children:[s.jsx(_,{value:xt,onChange:e=>gt(e.target.value),placeholder:"메시지를 입력하세요",rows:2,maxLength:1e3,disabled:bt,onClick:e=>e.stopPropagation(),className:"business-radius-input text-[11px]"}),s.jsx("button",{type:"button",onClick:e=>{e.stopPropagation(),(async()=>{if(!Zt?.id)return;if(!xt.trim())return void $.error("메시지를 입력해주세요.");if("resolved"===Zt.status||"closed"===Zt.status)return void $.error("완료된 문의에는 메시지를 보낼 수 없습니다.");yt(!0);const e=await n.sendInquiryMessage({inquiryId:Zt.id,message:xt.trim(),senderRole:$e?"admin":"user"});e.success?gt(""):$.error(e.error||"메시지 전송 실패"),yt(!1)})()},disabled:bt||!xt.trim(),className:"button-action-primary disabled:opacity-50 disabled:cursor-not-allowed",children:bt?"전송중":"전송"})]})})]})]})]})})]},e.id))})})]})]})]}),s.jsx(y,{open:Ae,onOpenChange:Ve,children:s.jsxs(f,{className:"max-w-6xl max-h-[90vh] overflow-y-auto business-radius-modal",children:[s.jsx(j,{children:s.jsxs(v,{className:"flex items-center justify-between modal-title text-gray-900",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{children:"발주요청 상세"}),We?.purchase_order_number&&s.jsx("span",{className:"badge-stats border border-gray-300 bg-white text-gray-600 font-normal",children:We.purchase_order_number})]}),$e&&We&&s.jsxs(r,{onClick:async()=>{if(!We?.id)return;if(!confirm("이 발주요청 전체를 삭제하시겠습니까?\n모든 품목이 함께 삭제됩니다."))return;const e=await n.deletePurchaseRequest(We.id);if(e.success){o(We.id);$.success("발주요청이 삭제되었습니다."),Ve(!1),Je(null),qt()}else $.error(e.error||"발주요청 삭제 실패")},className:"button-action-danger",children:[s.jsx(x,{className:"w-4 h-4 mr-1"}),"전체 삭제"]})]})}),ze?s.jsx("div",{className:"flex items-center justify-center py-8",children:s.jsx("div",{className:"w-6 h-6 border-2 border-gray-300 border-t-transparent rounded-full animate-spin"})}):We&&s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 p-4 bg-gray-50 border border-gray-200 business-radius-card",children:[s.jsxs("div",{children:[s.jsx("span",{className:"modal-label text-gray-500",children:"발주번호"}),s.jsx("p",{className:"modal-value mt-1",children:We.purchase_order_number||"N/A"})]}),s.jsxs("div",{children:[s.jsx("span",{className:"modal-label text-gray-500",children:"업체명"}),s.jsx("p",{className:"modal-value mt-1",children:We.vendor_name})]}),s.jsxs("div",{children:[s.jsx("span",{className:"modal-label text-gray-500",children:"요청자"}),s.jsx("p",{className:"modal-value mt-1",children:We.requester_name})]}),s.jsxs("div",{children:[s.jsx("span",{className:"modal-label text-gray-500",children:"요청일"}),s.jsx("p",{className:"modal-value mt-1",children:We.request_date&&A(new Date(We.request_date),"yyyy-MM-dd")})]})]}),s.jsxs("div",{children:[s.jsx("h3",{className:"modal-section-title mb-3",children:"품목 상세"}),s.jsx("div",{className:"border border-gray-200 business-radius-card overflow-x-auto",children:s.jsxs("table",{className:"w-full",children:[s.jsx("thead",{className:"bg-gray-50 border-b",children:s.jsxs("tr",{children:[s.jsx("th",{className:"text-left badge-text modal-value text-gray-700 px-3 py-3 w-12",children:"번호"}),s.jsx("th",{className:"text-left badge-text modal-value text-gray-700 px-3 py-3 min-w-[180px]",children:"품명"}),s.jsx("th",{className:"text-left badge-text modal-value text-gray-700 px-3 py-3 min-w-[150px]",children:"규격"}),s.jsx("th",{className:"text-center badge-text modal-value text-gray-700 px-3 py-3 w-20",children:"수량"}),s.jsx("th",{className:"text-right badge-text modal-value text-gray-700 px-3 py-3 w-28",children:"단가"}),s.jsx("th",{className:"text-right badge-text modal-value text-gray-700 px-3 py-3 w-32",children:"금액"}),s.jsx("th",{className:"text-left badge-text modal-value text-gray-700 px-3 py-3 min-w-[150px]",children:"비고"}),s.jsx("th",{className:"text-center badge-text modal-value text-gray-700 px-3 py-3 w-16",children:"링크"}),$e&&s.jsx("th",{className:"text-center badge-text modal-value text-gray-700 px-3 py-3 w-24",children:"작업"})]})}),s.jsx("tbody",{className:"divide-y divide-gray-200",children:We.purchase_request_items?.map((e,t)=>s.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[s.jsx("td",{className:"px-3 py-3 text-center modal-value text-gray-600",children:e.line_number||t+1}),s.jsx("td",{className:"px-3 py-3",children:Qe===e.id?s.jsx(g,{value:Ue?.item_name||"",onChange:e=>Ye({...Ue,item_name:e.target.value}),className:"business-radius-input h-7 text-[11px] w-full",autoFocus:!0}):s.jsx("span",{className:"modal-value text-gray-900",children:e.item_name})}),s.jsx("td",{className:"px-3 py-3",children:Qe===e.id?s.jsx(g,{value:Ue?.specification||"",onChange:e=>Ye({...Ue,specification:e.target.value}),className:"business-radius-input h-7 text-[11px] w-full"}):s.jsx("span",{className:"text-gray-600",children:e.specification||"-"})}),s.jsx("td",{className:"text-center px-3 py-3",children:Qe===e.id?s.jsx(g,{type:"number",value:Ue?.quantity||"",onChange:e=>Ye({...Ue,quantity:parseInt(e.target.value)}),className:"business-radius-input h-7 text-[11px] text-center w-full"}):s.jsx("span",{className:"modal-value",children:e.quantity})}),s.jsx("td",{className:"text-right px-3 py-3",children:Qe===e.id?s.jsx(g,{type:"number",value:Ue?.unit_price_value||"",onChange:e=>Ye({...Ue,unit_price_value:parseInt(e.target.value)}),className:"business-radius-input h-7 text-[11px] text-right w-full"}):s.jsx("span",{className:"modal-value",children:e.unit_price_value?`${parseFloat(e.unit_price_value).toLocaleString()}`:"-"})}),s.jsx("td",{className:"text-right px-3 py-3",children:Qe===e.id?s.jsx("span",{className:"font-semibold text-blue-600",children:((Ue?.quantity||0)*(Ue?.unit_price_value||0)).toLocaleString()}):s.jsx("span",{className:"font-semibold text-blue-600",children:e.amount_value?`${parseFloat(e.amount_value).toLocaleString()}`:"-"})}),s.jsx("td",{className:"px-3 py-3",children:Qe===e.id?s.jsx(_,{value:Ue?.remark||"",onChange:e=>Ye({...Ue,remark:e.target.value}),className:"business-radius-input h-7 text-[11px] w-full resize-none",rows:1}):s.jsx("span",{className:"text-gray-600 badge-text",children:e.remark||"-"})}),s.jsx("td",{className:"text-center px-3 py-3",children:e.link?s.jsx("a",{href:e.link,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center justify-center w-8 h-8 business-radius-badge hover:bg-blue-50 text-blue-600",children:s.jsx(G,{className:"w-4 h-4"})}):s.jsx("span",{className:"text-gray-400",children:"-"})}),$e&&s.jsx("td",{className:"text-center px-3 py-3",children:Qe===e.id?s.jsxs("div",{className:"flex justify-center gap-1",children:[s.jsxs(r,{onClick:()=>(async e=>{if(!Ue)return;const t=(Ue.quantity||0)*(Ue.unit_price_value||0),s=await n.updatePurchaseRequestItem(e,{item_name:Ue.item_name,specification:Ue.specification,quantity:Ue.quantity,unit_price_value:Ue.unit_price_value,amount_value:t,remark:Ue.remark});s.success?($.success("품목이 수정되었습니다."),es()):$.error(s.error||"품목 수정 실패")})(e.id),className:"button-action-success",children:[s.jsx(X,{className:"w-4 h-4 mr-1"}),"저장"]}),s.jsx(r,{onClick:es,className:"button-action-secondary",children:"취소"})]}):s.jsxs("div",{className:"flex justify-center gap-1",children:[s.jsx(r,{onClick:()=>(e=>{Be(e.id),Ye({item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,remark:e.remark})})(e),className:"button-action-secondary",children:s.jsx(Q,{className:"w-4 h-4 text-blue-600"})}),s.jsx(r,{onClick:()=>(async e=>{if(!confirm("이 품목을 삭제하시겠습니까?"))return;const t=await n.deletePurchaseRequestItem(e);t.success?$.success("품목이 삭제되었습니다."):$.error(t.error||"품목 삭제 실패")})(e.id),className:"button-action-danger",children:s.jsx(x,{className:"w-4 h-4 text-red-600"})})]})})]},e.id))}),s.jsx("tfoot",{className:"bg-gray-50 border-t-2",children:s.jsxs("tr",{children:[s.jsx("td",{colSpan:5,className:"modal-value text-right px-3 py-3",children:"합계"}),s.jsx("td",{className:"modal-value text-right px-3 py-3 text-blue-600",children:We.purchase_request_items?.reduce((e,t)=>e+(parseFloat(t.amount_value)||0),0).toLocaleString()}),s.jsx("td",{colSpan:$e?3:2,className:"px-3 py-3"})]})})]})})]}),We.notes&&s.jsxs("div",{children:[s.jsx("h3",{className:"modal-section-title mb-2",children:"비고"}),s.jsx("p",{className:"card-description text-gray-600 p-3 bg-gray-50 border border-gray-200 business-radius-card",children:We.notes})]})]})]})}),s.jsx(B,{purchaseId:Ze,isOpen:Ge,onClose:()=>{Xe(!1),et(null)},currentUserRoles:Pe,activeTab:"done",onDelete:e=>{rt(e),st(!0)}}),s.jsx(k,{open:tt,onOpenChange:e=>{st(e),e||rt(null)},children:s.jsxs(M,{className:"business-radius-modal",children:[s.jsxs(T,{children:[s.jsx(D,{className:"modal-title",children:"발주요청 내역 삭제"}),s.jsxs(O,{children:["발주요청번호 ",s.jsx("strong",{children:at?.purchase_order_number||"알 수 없음"}),"를 삭제하시겠습니까?",s.jsx("br",{}),"이 작업은 되돌릴 수 없습니다."]})]}),s.jsxs(P,{children:[s.jsx(L,{className:"button-action-secondary",children:"취소"}),s.jsx(R,{onClick:async()=>{if(!at?.id)return void $.error("삭제할 발주 정보가 없습니다.");const e=l();try{const t="string"==typeof at.id?parseInt(at.id,10):at.id;if(!t||Number.isNaN(t))return void $.error("발주 ID가 올바르지 않습니다.");const{error:s}=await e.from("support_inquires").update({purchase_request_id:null}).eq("purchase_request_id",t);if(s)throw s;const{error:a}=await e.from("purchase_request_items").delete().eq("purchase_request_id",t);if(a)throw a;const{error:r}=await e.from("purchase_requests").delete().eq("id",t);if(r)throw r;o(t),$.success("발주요청이 삭제되었습니다. (문의 기록은 보존됩니다)"),st(!1),rt(null),Xe(!1),et(null),qt()}catch(t){$.error(t instanceof Error?t.message:"삭제 중 오류가 발생했습니다.")}finally{st(!1),rt(null)}},className:"button-action-danger",children:"삭제"})]})]})}),s.jsx(y,{open:it,onOpenChange:nt,children:s.jsx(f,{showCloseButton:!1,maxWidth:"sm:max-w-md",className:"p-0 overflow-hidden business-radius-modal",children:s.jsxs("div",{className:"px-8 py-10 text-center",children:[s.jsx("div",{className:"modal-title text-gray-900",children:"안내"}),s.jsx("div",{className:"mt-4 modal-value text-gray-700 whitespace-pre-wrap",children:lt}),s.jsx("div",{className:"mt-6 badge-text text-gray-400",children:"화면을 클릭하거나 ESC로 닫을 수 있습니다."})]})})})]})}export{se as default};
//# sourceMappingURL=SupportMain-DAuYXLsE.js.map
