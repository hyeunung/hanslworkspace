import{c as G,r as h,a as O,j as e,F as ne,t as ie,B as o,U as le,X as ce}from"./index-C0FAzD3m.js";import{t as u,B as j}from"./index-BxJnWAhi.js";import{I as f,D as de,a as me,b as oe,c as ue}from"./input-DaTkxl0w.js";import{C as I,P as xe}from"./pen-BGLtDehW.js";import{T as V}from"./card-uOpkqlwt.js";import{P as he}from"./plus-CqeW5uEq.js";import{S as pe}from"./save-DYJzTmaz.js";/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],X=G("circle-x",ge);/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=[["path",{d:"M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z",key:"1a0edw"}],["path",{d:"M12 22V12",key:"d0xqtd"}],["polyline",{points:"3.29 7 12 12 20.71 7",key:"ousv84"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}]],H=G("package",_e);function qe({purchaseId:p,isOpen:v,onClose:J,embedded:Q=!1,currentUserRoles:w=[],activeTab:S,onRefresh:q,onDelete:z}){const[W,A]=h.useState(!1),[a,Y]=h.useState(null),[i,k]=h.useState(!1),[x,P]=h.useState(null),[c,y]=h.useState([]),[C,D]=h.useState([]),[F,Z]=h.useState([]),d=O();h.useEffect(()=>{v&&(async()=>{try{const{data:{user:r}}=await d.auth.getUser();if(r){let{data:s}=await d.from("employees").select("*").eq("id",r.id).maybeSingle();if(!s&&r.email){const{data:n}=await d.from("employees").select("*").eq("email",r.email).maybeSingle();s=n}if(s?.purchase_role){let n=[];Array.isArray(s.purchase_role)?n=s.purchase_role.map(m=>String(m).trim()):n=String(s.purchase_role).split(",").map(b=>b.trim()).filter(b=>b.length>0),Z(n)}}}catch{}})()},[v]);const l=Array.isArray(w)&&w.length>0?w:F,M=l.includes("final_approver")||l.includes("app_admin")||l.includes("ceo"),ee=M,g=l.includes("final_approver")||l.includes("app_admin")||l.includes("ceo"),B=l.includes("middle_manager")||l.includes("app_admin")||l.includes("ceo"),R=l.includes("final_approver")||l.includes("app_admin")||l.includes("ceo");console.log("=== PurchaseDetailModal Debug ==="),console.log("Current User Roles (prop):",w),console.log("User Roles (direct load):",F),console.log("Effective Roles:",l),console.log("Can Approve Middle:",B),console.log("Can Approve Final:",R),console.log("Is Editing:",i),console.log("Middle Manager Status:",a?.middle_manager_status),console.log("Final Manager Status:",a?.final_manager_status),console.log("================================"),h.useEffect(()=>{p&&v&&N(p.toString())},[p,v]);const N=async t=>{try{A(!0);const r=O(),{data:s,error:n}=await r.from("purchase_requests").select(`
          *,
          vendors(id, vendor_name),
          purchase_request_items(*)
        `).eq("id",t).single();if(n)throw n;if(s){const m={...s,items:s.purchase_request_items||[],vendor:s.vendors||{id:0,vendor_name:"알 수 없음"},vendor_contacts:[]};Y(m),P(m),y(m.items||[])}}catch{u.error("발주 상세 정보를 불러오는데 실패했습니다.")}finally{A(!1)}},se=()=>a?a.is_received?e.jsx(j,{className:"bg-green-100 text-green-800",children:"입고완료"}):a.middle_manager_status==="approved"&&a.final_manager_status==="approved"?e.jsx(j,{className:"bg-hansl-100 text-hansl-800",children:"구매진행"}):a.middle_manager_status==="rejected"||a.final_manager_status==="rejected"?e.jsx(j,{className:"bg-red-100 text-red-800",children:"반려"}):e.jsx(j,{className:"bg-yellow-100 text-yellow-800",children:"승인대기"}):null,U=t=>t?new Date(t).toLocaleDateString("ko-KR"):"-",E=t=>new Intl.NumberFormat("ko-KR").format(t),te=async()=>{if(!(!a||!x))try{const t=c.reduce((s,n)=>s+(n.amount_value||0),0),{error:r}=await d.from("purchase_requests").update({purchase_order_number:x.purchase_order_number,requester_name:x.requester_name,vendor_name:x.vendor?.vendor_name||x.vendor_name,delivery_request_date:x.delivery_request_date,request_date:x.request_date,payment_category:x.payment_category,project_vendor:x.project_vendor,total_amount:t,updated_at:new Date().toISOString()}).eq("id",a.id);if(r)throw r;if(C.length>0){const{error:s}=await d.from("purchase_request_items").delete().in("id",C);if(s)throw s}for(const s of c)if(s.id){const{error:n}=await d.from("purchase_request_items").update({item_name:s.item_name,specification:s.specification,quantity:s.quantity,unit_price_value:s.unit_price_value,amount_value:s.amount_value,remark:s.remark,updated_at:new Date().toISOString()}).eq("id",s.id);if(n)throw n}else{const{error:n}=await d.from("purchase_request_items").insert({purchase_request_id:a.id,item_name:s.item_name,specification:s.specification,quantity:s.quantity,unit_price_value:s.unit_price_value,amount_value:s.amount_value,remark:s.remark,line_number:s.line_number||c.indexOf(s)+1,created_at:new Date().toISOString()});if(n)throw n}u.success("발주 내역이 수정되었습니다."),k(!1),D([]),q?.(),await N(p?.toString()||"")}catch{u.error("저장 중 오류가 발생했습니다.")}},_=(t,r,s)=>{const n=[...c];if(r==="amount_value")n[t]={...n[t],amount_value:s};else if(r==="quantity"||r==="unit_price_value"){const m=r==="quantity"?s:n[t].quantity,b=r==="unit_price_value"?s:n[t].unit_price_value;n[t]={...n[t],[r]:s,amount_value:m*b}}else n[t]={...n[t],[r]:s};y(n)},ae=()=>{const t={item_name:"",specification:"",quantity:1,unit_price_value:0,amount_value:0,remark:"",line_number:c.length+1};y([...c,t])},re=t=>{const r=c[t];r.id&&D([...C,r.id]);const s=c.filter((n,m)=>m!==t);y(s)},L=async(t,r)=>{if(!g){u.error("입고 처리 권한이 없습니다.");return}try{const{error:s}=await d.from("purchase_request_items").update({is_received:r,delivery_status:r?"received":"pending",received_quantity:r&&a?.items?.find(n=>String(n.id)===String(t))?.quantity||0,received_at:r?new Date().toISOString():null}).eq("id",t);if(s)throw s;u.success(r?"입고 처리되었습니다.":"입고가 취소되었습니다."),p&&await N(p.toString()),q?.()}catch{u.error("입고 처리 중 오류가 발생했습니다.")}},T=async t=>{if(a)try{const r=t==="middle"?{middle_manager_status:"approved"}:{final_manager_status:"approved"},{error:s}=await d.from("purchase_requests").update(r).eq("id",a.id);if(s)throw s;u.success(`${t==="middle"?"중간":"최종"} 승인이 완료되었습니다.`),q?.(),await N(p?.toString()||"")}catch{u.error("승인 처리 중 오류가 발생했습니다.")}},$=async t=>{if(!(!a||!window.prompt("반려 사유를 입력해주세요:")))try{const s=t==="middle"?{middle_manager_status:"rejected"}:{final_manager_status:"rejected"},{error:n}=await d.from("purchase_requests").update(s).eq("id",a.id);if(n)throw n;u.success(`${t==="middle"?"중간":"최종"} 반려가 완료되었습니다.`),q?.(),await N(p?.toString()||"")}catch{u.error("반려 처리 중 오류가 발생했습니다.")}},K=e.jsx(e.Fragment,{children:W?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-hansl-600"})}):a?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsxs("h3",{className:"font-semibold mb-3 flex items-center",children:[e.jsx(ne,{className:"w-4 h-4 mr-2"}),"기본 정보"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"요청자"}),e.jsx("p",{className:"font-medium",children:a.requester_name})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"요청일"}),e.jsx("p",{className:"font-medium",children:U(a.request_date)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"입고요청일"}),e.jsx("p",{className:"font-medium",children:U(a.delivery_request_date)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"결제유형"}),e.jsx("p",{className:"font-medium",children:a.payment_category||"-"})]})]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsxs("h3",{className:"font-semibold mb-3 flex items-center",children:[e.jsx(ie,{className:"w-4 h-4 mr-2"}),"업체 정보"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"업체명"}),e.jsx("p",{className:"font-medium",children:a.vendor?.vendor_name||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"프로젝트 업체"}),e.jsx("p",{className:"font-medium",children:a.project_vendor||"-"})]})]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsxs("h3",{className:"font-semibold mb-3 flex items-center",children:[e.jsx(H,{className:"w-4 h-4 mr-2"}),"품목 리스트"]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{className:"bg-white",children:e.jsxs("tr",{children:[g&&S==="receipt"&&e.jsx("th",{className:"px-3 py-2 text-center text-xs font-medium text-gray-500",children:"입고"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500",children:"품명"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500",children:"규격"}),e.jsx("th",{className:"px-3 py-2 text-center text-xs font-medium text-gray-500",children:"수량"}),e.jsx("th",{className:"px-3 py-2 text-right text-xs font-medium text-gray-500",children:"단가"}),e.jsx("th",{className:"px-3 py-2 text-right text-xs font-medium text-gray-500",children:"금액"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500",children:"비고"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:(i?c:a.items)?.map((t,r)=>e.jsxs("tr",{children:[g&&S==="receipt"&&e.jsx("td",{className:"px-3 py-2 text-center",children:e.jsx("div",{className:"flex items-center justify-center",children:t.is_received||t.delivery_status==="received"?e.jsxs("button",{onClick:()=>L(t.id,!1),className:"flex items-center gap-1 px-2 py-1 text-xs bg-green-100 text-green-800 rounded-md hover:bg-green-200 transition-colors",disabled:!g,children:[e.jsx(I,{className:"w-3 h-3"}),"입고완료"]}):e.jsxs("button",{onClick:()=>L(t.id,!0),className:"flex items-center gap-1 px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded-md hover:bg-gray-200 transition-colors",disabled:!g,children:[e.jsx(H,{className:"w-3 h-3"}),"미입고"]})})}),e.jsx("td",{className:"px-3 py-2",children:i?e.jsx(f,{value:t.item_name,onChange:s=>_(r,"item_name",s.target.value),className:"text-sm"}):e.jsx("span",{className:"text-sm",children:t.item_name})}),e.jsx("td",{className:"px-3 py-2",children:i?e.jsx(f,{value:t.specification,onChange:s=>_(r,"specification",s.target.value),className:"text-sm"}):e.jsx("span",{className:"text-sm",children:t.specification})}),e.jsx("td",{className:"px-3 py-2 text-center",children:i?e.jsx(f,{type:"number",value:t.quantity,onChange:s=>_(r,"quantity",Number(s.target.value)),className:"text-sm text-center w-20 mx-auto"}):e.jsx("span",{className:"text-sm",children:t.quantity})}),e.jsx("td",{className:"px-3 py-2 text-right",children:i?e.jsx(f,{type:"number",value:t.unit_price_value,onChange:s=>_(r,"unit_price_value",Number(s.target.value)),className:"text-sm text-right"}):e.jsxs("span",{className:"text-sm",children:[E(t.unit_price_value)," ",a.currency]})}),e.jsx("td",{className:"px-3 py-2 text-right",children:i?e.jsx(f,{type:"number",value:t.amount_value,onChange:s=>_(r,"amount_value",Number(s.target.value)),className:"text-sm text-right"}):e.jsxs("span",{className:"text-sm",children:[E(t.amount_value)," ",a.currency]})}),e.jsx("td",{className:"px-3 py-2",children:i?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(f,{value:t.remark||"",onChange:s=>_(r,"remark",s.target.value),className:"text-sm"}),e.jsx(o,{size:"sm",variant:"ghost",onClick:()=>re(r),className:"text-red-600 hover:bg-red-50",children:e.jsx(V,{className:"w-4 h-4"})})]}):e.jsx("span",{className:"text-sm",children:t.remark||"-"})})]},r))}),e.jsx("tfoot",{className:"bg-gray-100",children:e.jsxs("tr",{children:[e.jsx("td",{colSpan:g&&S==="receipt"?5:4,className:"px-3 py-2 text-sm font-semibold text-right",children:"총액"}),e.jsxs("td",{className:"px-3 py-2 text-sm font-semibold text-right",children:[E((i?c:a.items)?.reduce((t,r)=>t+(r.amount_value||0),0)||0)," ",a.currency]}),e.jsx("td",{})]})})]})}),i&&e.jsxs(o,{size:"sm",variant:"outline",onClick:ae,className:"w-full mt-2",children:[e.jsx(he,{className:"w-4 h-4 mr-1"}),"항목 추가"]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsxs("h3",{className:"font-semibold mb-3 flex items-center",children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),"승인 정보"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"중간승인"}),e.jsx(j,{variant:a.middle_manager_status==="approved"?"default":"secondary",className:a.middle_manager_status==="approved"?"bg-green-100 text-green-800":a.middle_manager_status==="rejected"?"bg-red-100 text-red-800":"",children:a.middle_manager_status==="approved"?"승인":a.middle_manager_status==="rejected"?"반려":"대기"})]}),!i&&B&&a.middle_manager_status==="pending"&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(o,{size:"sm",onClick:()=>T("middle"),className:"bg-green-600 hover:bg-green-700 text-white",children:[e.jsx(I,{className:"w-4 h-4 mr-1"}),"승인"]}),e.jsxs(o,{size:"sm",variant:"outline",onClick:()=>$("middle"),className:"text-red-600 hover:bg-red-50",children:[e.jsx(X,{className:"w-4 h-4 mr-1"}),"반려"]})]})]})}),e.jsx("div",{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"최종승인"}),e.jsx(j,{variant:a.final_manager_status==="approved"?"default":"secondary",className:a.final_manager_status==="approved"?"bg-green-100 text-green-800":a.final_manager_status==="rejected"?"bg-red-100 text-red-800":"",children:a.final_manager_status==="approved"?"승인":a.final_manager_status==="rejected"?"반려":"대기"})]}),!i&&R&&a.middle_manager_status==="approved"&&a.final_manager_status==="pending"&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(o,{size:"sm",onClick:()=>T("final"),className:"bg-green-600 hover:bg-green-700 text-white",children:[e.jsx(I,{className:"w-4 h-4 mr-1"}),"승인"]}),e.jsxs(o,{size:"sm",variant:"outline",onClick:()=>$("final"),className:"text-red-600 hover:bg-red-50",children:[e.jsx(X,{className:"w-4 h-4 mr-1"}),"반려"]})]})]})})]})]})]}):e.jsx("div",{className:"text-center py-12 text-gray-500",children:"발주 정보를 불러올 수 없습니다."})});return Q?K:e.jsx(de,{open:v,onOpenChange:J,children:e.jsxs(me,{className:"w-full max-w-[95vw] sm:max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(oe,{children:e.jsxs(ue,{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xl font-bold",children:i?"발주 내역 수정":"발주 상세 정보"}),a&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm text-gray-500",children:["#",a.purchase_order_number]}),!i&&se(),!i&&M&&e.jsxs(e.Fragment,{children:[e.jsxs(o,{size:"sm",variant:"outline",onClick:()=>k(!0),className:"text-blue-600 hover:bg-blue-50",children:[e.jsx(xe,{className:"w-4 h-4 mr-1"}),"수정"]}),ee&&z&&e.jsxs(o,{size:"sm",variant:"outline",onClick:()=>z(a),className:"text-red-600 hover:bg-red-50",children:[e.jsx(V,{className:"w-4 h-4 mr-1"}),"삭제"]})]}),i&&e.jsxs(e.Fragment,{children:[e.jsxs(o,{size:"sm",variant:"outline",onClick:()=>{k(!1),P(a),y(a.items||[]),D([])},children:[e.jsx(ce,{className:"w-4 h-4 mr-1"}),"취소"]}),e.jsxs(o,{size:"sm",onClick:te,className:"bg-hansl-600 hover:bg-hansl-700 text-white",children:[e.jsx(pe,{className:"w-4 h-4 mr-1"}),"저장"]})]})]})]})}),K]})})}export{H as P,qe as a};
//# sourceMappingURL=PurchaseDetailModal-DVHyq9uz.js.map
