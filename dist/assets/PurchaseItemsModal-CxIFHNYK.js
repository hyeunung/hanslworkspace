import{c as e,E as a,j as t,a as s,r as i,B as n,X as r}from"./index-BjQfKsz5.js";import{D as l,a as c,b as m,c as o,I as d}from"./input-DZeHNnGi.js";import{T as u,a as h,b as x,c as p,d as j,e as g}from"./table-BaJ4-g5Y.js";import{B as _,t as v}from"./index-DMhMemmS.js";import{E as f}from"./eye-CCmD2ep-.js";import{D as b}from"./download-DA5cmyzh.js";import{u as N,D as y}from"./useConfirmDateAction-BijC1hXy.js";import{P as w,f as C}from"./format-C9v-JHhC.js";import{P as k}from"./plus-CNKBYCVi.js";import{S as q}from"./save-E7vGK4sj.js";import{T}from"./trash-2-Q_rjc0gc.js";import"./chevron-down-C9v4nD0z.js";import"./popover-fqFFHJHr.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const U=e("file-x",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"m14.5 12.5-5 5",key:"b62r18"}],["path",{d:"m9.5 12.5 5 5",key:"1rk7el"}]]),D=({itemId:e,receiptUrl:i,itemName:n,paymentCategory:r,onUpdate:l})=>{const[c,m]=a.useState(!1);if("현장 결제"!==r&&"현장결제"!==r)return null;return i?t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{onClick:()=>{if(!i)return;const e=document.createElement("div");e.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: rgba(0, 0, 0, 0.9);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      z-index: 9999;\n      cursor: pointer;\n    ";const a=document.createElement("img");a.src=i,a.style.cssText="\n      max-width: 90%;\n      max-height: 90%;\n      object-fit: contain;\n      border-radius: 8px;\n    ",e.appendChild(a),e.onclick=()=>document.body.removeChild(e),document.body.appendChild(e)},className:"inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-semibold text-white bg-blue-500 hover:bg-blue-600 rounded-md transition-colors",title:"영수증 미리보기",children:[t.jsx(f,{className:"w-4 h-4"}),t.jsx("span",{children:"보기"})]}),t.jsxs("button",{onClick:async()=>{if(i){m(!0);try{const a=new URL(i).pathname.split("/"),t=a.indexOf("receipt-images");if(-1===t)throw new Error("잘못된 영수증 URL입니다");const r=a.slice(t+1).join("/"),l=s(),{data:c,error:m}=await l.storage.from("receipt-images").download(r);if(m)throw m;const o=new Blob([c],{type:"image/jpeg"}),d=window.URL.createObjectURL(o),u=document.createElement("a");u.href=d,u.download=`영수증_${n}_${e}_${Date.now()}.jpg`,document.body.appendChild(u),u.click(),document.body.removeChild(u),window.URL.revokeObjectURL(d),"undefined"!=typeof window&&"function"==typeof window.alert&&alert("✅ 영수증이 다운로드되었습니다.")}catch(a){alert(`❌ 다운로드 실패: ${a instanceof Error?a.message:a}`)}finally{m(!1)}}},disabled:c,className:"inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-semibold text-white bg-green-500 hover:bg-green-600 disabled:bg-gray-400 disabled:cursor-not-allowed rounded-md transition-colors",title:"영수증 다운로드",children:[t.jsx(b,{className:"w-4 h-4"}),t.jsx("span",{children:c?"다운로드 중...":"다운로드"})]})]}):t.jsxs("div",{className:"flex items-center gap-2 text-gray-400",children:[t.jsx(U,{className:"w-4 h-4"}),t.jsx("span",{className:"text-sm",children:"영수증 없음"})]})};function M({isOpen:e,onClose:a,purchase:f,isAdmin:b,onUpdate:U,activeTab:M="done"}){const[z,S]=i.useState(f.items||[]),[L,E]=i.useState(!1),[B,R]=i.useState(""),F=s();i.useEffect(()=>{e&&(async()=>{try{const{data:{user:e}}=await F.auth.getUser();if(e?.email){const{data:a}=await F.from("employees").select("name").eq("email",e.email).single();R(a?.name?a.name:e.email)}if(f.id){const{data:e}=await F.from("purchase_request_items").select("*").eq("purchase_request_id",f.id).order("line_number");e&&S(e)}}catch(e){R("사용자")}})()},[e,F,f.id]);const O=b||f?.requester_name===B,A=N({config:{field:"statement_received",confirmMessage:{confirm:"거래명세서 확인을 처리하시겠습니까?",cancel:"거래명세서 확인을 취소하시겠습니까?"},successMessage:{confirm:"거래명세서 확인이 완료되었습니다.",cancel:"거래명세서 확인이 취소되었습니다."},completedText:"✓ 완료",waitingText:"대기"},currentUserName:B,canPerformAction:O,onUpdate:()=>{U&&U();(async()=>{if(f.id){const{data:e}=await F.from("purchase_request_items").select("*").eq("purchase_request_id",f.id).order("line_number");e&&S(e)}})()}}),P=N({config:{field:"actual_received",confirmMessage:{confirm:"실제 입고 처리를 진행하시겠습니까?",cancel:"실제 입고 처리를 취소하시겠습니까?"},successMessage:{confirm:"실제 입고 처리가 완료되었습니다.",cancel:"실제 입고 처리가 취소되었습니다."},completedText:"입고완료",waitingText:"입고대기"},currentUserName:B,canPerformAction:O,onUpdate:()=>{U&&U();(async()=>{if(f.id){const{data:e}=await F.from("purchase_request_items").select("*").eq("purchase_request_id",f.id).order("line_number");e&&S(e)}})()}}),$=(e,a,t)=>{const s=[...z];s[e]={...s[e],[a]:"quantity"===a||"unit_price_value"===a||"amount_value"===a?Number(t):t},"quantity"!==a&&"unit_price_value"!==a||(s[e].amount_value=s[e].quantity*(s[e].unit_price_value||0)),S(s)},H=z,I=H.reduce((e,a)=>e+(a.amount_value||0),0);return t.jsx(l,{open:e,onOpenChange:a,children:t.jsxs(c,{className:"w-full max-w-[95vw] sm:max-w-6xl max-h-[80vh] overflow-hidden flex flex-col bg-white",children:[t.jsx(m,{className:"flex-shrink-0",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs(o,{className:"modal-title",children:["발주 상세 항목 - ",f.purchase_order_number]}),t.jsxs("div",{className:"flex items-center gap-2",children:[b&&!L&&t.jsxs(n,{variant:"outline",size:"sm",onClick:()=>{E(!0),S([...f.items||[]])},children:[t.jsx(w,{className:"h-4 w-4 mr-1"}),"편집"]}),L&&t.jsxs(t.Fragment,{children:[t.jsxs(n,{variant:"outline",size:"sm",onClick:()=>{const e={line_number:z.length+1,item_name:"",specification:"",quantity:0,unit_price_value:0,amount_value:0,remark:"",is_received:!1};S([...z,e])},children:[t.jsx(k,{className:"h-4 w-4 mr-1"}),"품목 추가"]}),t.jsxs(n,{variant:"default",size:"sm",onClick:async()=>{try{await F.from("purchase_request_items").delete().eq("purchase_request_id",f.id);const e=z.map(e=>({purchase_request_id:f.id,purchase_order_number:f.purchase_order_number,line_number:e.line_number,item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark,link:e.link,is_received:e.is_received||!1,delivery_status:e.delivery_status||"pending"})),{error:t}=await F.from("purchase_request_items").insert(e);if(t)throw t;const s=z.reduce((e,a)=>e+(a.amount_value||0),0);await F.from("purchase_requests").update({total_amount:s}).eq("id",f.id),v.success("품목이 수정되었습니다."),E(!1),U(),a()}catch(e){v.error("저장 중 오류가 발생했습니다.")}},children:[t.jsx(q,{className:"h-4 w-4 mr-1"}),"저장"]}),t.jsx(n,{variant:"ghost",size:"sm",onClick:()=>{E(!1),S(f.items||[])},children:"취소"})]}),t.jsx(n,{variant:"ghost",size:"icon",onClick:a,className:"h-6 w-6",children:t.jsx(r,{className:"h-4 w-4"})})]})]})}),t.jsxs("div",{className:"flex-shrink-0 grid grid-cols-2 md:grid-cols-4 gap-3 py-3 border-b",children:[t.jsxs("div",{children:[t.jsx("p",{className:"modal-label",children:"업체명"}),t.jsx("p",{className:"modal-value",children:f.vendor_name})]}),t.jsxs("div",{children:[t.jsx("p",{className:"modal-label",children:"요청자"}),t.jsx("p",{className:"modal-value",children:f.requester_name})]}),t.jsxs("div",{children:[t.jsx("p",{className:"modal-label",children:"프로젝트"}),t.jsx("p",{className:"modal-value truncate",title:f.project_vendor,children:f.project_vendor})]}),t.jsxs("div",{children:[t.jsx("p",{className:"modal-label",children:"납기일"}),t.jsx("p",{className:"modal-value",children:f.delivery_request_date&&C(new Date(f.delivery_request_date),"yyyy-MM-dd")})]})]}),t.jsx("div",{className:"flex-1 overflow-auto",children:t.jsxs(u,{children:[t.jsx(h,{className:"sticky top-0 bg-white z-10",children:t.jsxs(x,{children:[t.jsx(p,{className:"w-12",children:"No."}),t.jsx(p,{children:"품목"}),t.jsx(p,{children:"규격"}),t.jsx(p,{className:"text-right",children:"수량"}),t.jsx(p,{className:"text-right",children:"단가"}),t.jsx(p,{className:"text-right",children:"금액"}),t.jsx(p,{children:"purchase"===M?"구매상태":"입고상태"}),t.jsx(p,{children:"영수증"}),"done"===M&&t.jsxs(t.Fragment,{children:[t.jsx(p,{className:"text-center",children:"거래명세서 확인"}),t.jsx(p,{className:"text-center",children:"회계상 입고일"}),t.jsx(p,{className:"text-center",children:"처리자"})]}),"receipt"===M&&t.jsxs(t.Fragment,{children:[t.jsx(p,{className:"text-center",children:"실제 입고일"}),t.jsx(p,{className:"text-center",children:"처리자"})]}),t.jsx(p,{children:"비고"}),L&&t.jsx(p,{className:"w-20",children:"삭제"})]})}),t.jsx(j,{children:H.map((e,a)=>t.jsxs(x,{children:[t.jsx(g,{className:"modal-value",children:e.line_number||a+1}),t.jsx(g,{children:L?t.jsx(d,{value:e.item_name,onChange:e=>$(a,"item_name",e.target.value),className:"h-7 modal-label"}):t.jsx("div",{className:"sm:max-w-[200px]",children:t.jsx("p",{className:"modal-value truncate",title:e.item_name,children:e.item_name})})}),t.jsx(g,{children:L?t.jsx(d,{value:e.specification,onChange:e=>$(a,"specification",e.target.value),className:"h-7 modal-label"}):t.jsx("div",{className:"sm:max-w-[150px] truncate",title:e.specification,children:e.specification})}),t.jsx(g,{className:"text-right",children:L?t.jsx(d,{type:"number",value:e.quantity,onChange:e=>$(a,"quantity",e.target.value),className:"h-7 text-xs text-right"}):t.jsx("span",{className:"modal-value",children:e.quantity.toLocaleString()})}),t.jsx(g,{className:"text-right",children:L?t.jsx(d,{type:"number",value:e.unit_price_value,onChange:e=>$(a,"unit_price_value",e.target.value),className:"h-7 text-xs text-right"}):t.jsxs("span",{className:"modal-subtitle",children:[(e.unit_price_value||0).toLocaleString()," ",f.currency]})}),t.jsx(g,{className:"text-right",children:L?t.jsx(d,{type:"number",value:e.amount_value,onChange:e=>$(a,"amount_value",e.target.value),className:"h-7 modal-label text-right"}):t.jsxs("span",{className:"modal-value",children:[(e.amount_value||0).toLocaleString()," ",f.currency]})}),t.jsx(g,{children:"receipt"===M?O?P.isCompleted(e)?t.jsx("button",{onClick:()=>{P.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-base bg-green-500 hover:bg-green-600 text-white transition-colors",title:"클릭하여 실제 입고 처리 취소",children:P.config.completedText}):t.jsx(y,{onDateSelect:a=>{P.handleConfirm(e.id,a,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"실제 입고 날짜 선택",children:t.jsx(n,{variant:"outline",size:"sm",className:"button-base border border-gray-300 text-gray-600 bg-white hover:bg-gray-50",children:P.config.waitingText})}):t.jsx("span",{className:"button-base "+(P.isCompleted(e)?"bg-green-500 text-white":"border border-gray-300 text-gray-400 bg-white"),children:P.isCompleted(e)?P.config.completedText:P.config.waitingText}):e.is_received?t.jsx(_,{variant:null,className:"badge-success",children:"입고완료"}):t.jsx(_,{variant:null,className:"badge-secondary",children:"대기"})}),t.jsx(g,{className:"text-center",children:t.jsx(D,{itemId:Number(e.id),receiptUrl:e.receipt_image_url,itemName:e.item_name,paymentCategory:f.payment_category,onUpdate:U})}),"done"===M&&t.jsxs(t.Fragment,{children:[t.jsx(g,{className:"text-center",children:O?A.isCompleted(e)?t.jsx("button",{onClick:()=>{A.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-base bg-green-500 hover:bg-green-600 text-white transition-colors",title:"클릭하여 거래명세서 확인 취소",children:A.config.completedText}):t.jsx(y,{onDateSelect:a=>{A.handleConfirm(e.id,a,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"날짜 선택",children:t.jsx(n,{variant:"outline",size:"sm",className:"button-base border border-gray-300 text-gray-600 bg-white hover:bg-gray-50",children:A.config.waitingText})}):t.jsx("span",{className:"button-base "+(A.isCompleted(e)?"bg-green-500 text-white":"border border-gray-300 text-gray-400 bg-white"),children:A.isCompleted(e)?A.config.completedText:A.config.waitingText})}),t.jsx(g,{className:"text-center",children:A.getCompletedDate(e)?t.jsx("span",{className:"modal-subtitle",children:C(new Date(A.getCompletedDate(e)),"yyyy-MM-dd")}):t.jsx("span",{className:"modal-subtitle",children:"-"})}),t.jsx(g,{className:"text-center",children:A.getCompletedByName(e)?t.jsx("span",{className:"modal-subtitle",children:A.getCompletedByName(e)}):t.jsx("span",{className:"modal-subtitle",children:"-"})})]}),"receipt"===M&&t.jsxs(t.Fragment,{children:[t.jsx(g,{className:"text-center",children:P.getCompletedDate(e)?t.jsx("span",{className:"modal-subtitle text-green-600",children:C(new Date(P.getCompletedDate(e)),"yyyy-MM-dd HH:mm")}):t.jsx("span",{className:"modal-subtitle",children:"-"})}),t.jsx(g,{className:"text-center",children:P.getCompletedByName(e)?t.jsx("span",{className:"modal-subtitle",children:P.getCompletedByName(e)}):t.jsx("span",{className:"modal-subtitle",children:"-"})})]}),t.jsx(g,{children:L?t.jsx(d,{value:e.remark||"",onChange:e=>$(a,"remark",e.target.value),className:"h-7 modal-label",placeholder:"비고"}):t.jsx("div",{className:"sm:max-w-[150px]",children:t.jsx("span",{className:"modal-subtitle truncate block",title:e.remark,children:e.remark||"-"})})}),L&&t.jsx(g,{children:t.jsx(n,{variant:"ghost",size:"icon",onClick:()=>(e=>{const a=z.filter((a,t)=>t!==e);a.forEach((e,a)=>{e.line_number=a+1}),S(a)})(a),className:"h-7 w-7 text-red-500 hover:text-red-700",children:t.jsx(T,{className:"h-4 w-4"})})})]},e.id||a))})]})}),t.jsxs("div",{className:"flex-shrink-0 border-t pt-4 flex justify-between items-center",children:[t.jsxs("div",{className:"modal-subtitle",children:["총 ",H.length,"개 품목"]}),t.jsxs("div",{className:"modal-value-large",children:["총 금액: ",I.toLocaleString()," ",f.currency]})]})]})})}export{M as default};
//# sourceMappingURL=PurchaseItemsModal-CxIFHNYK.js.map
