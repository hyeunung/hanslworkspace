import{r as e,a,j as s,B as l,X as i}from"./index-BX9izSap.js";import{D as t,a as r,b as n,c,I as m}from"./input-Dn1nJP7q.js";import{T as d,a as u,b as o,c as h,d as x,e as j}from"./table-Bz0_NlA2.js";import{B as v,t as p}from"./index-DbVKKtYS.js";import{P as _,f as N}from"./format-DGRy94_S.js";import{P as g}from"./plus-Ct9dD82T.js";import{S as f}from"./save-Dl1mkQkg.js";import{T as b}from"./trash-2-B0ZmnBt-.js";function y({isOpen:y,onClose:w,purchase:k,isAdmin:q,onUpdate:C}){const[z,S]=e.useState(k.items||[]),[L,A]=e.useState(!1),B=a(),D=(e,a,s)=>{const l=[...z];l[e]={...l[e],[a]:"quantity"===a||"unit_price_value"===a||"amount_value"===a?Number(s):s},"quantity"!==a&&"unit_price_value"!==a||(l[e].amount_value=l[e].quantity*(l[e].unit_price_value||0)),S(l)},M=L?z:k.items||[],O=M.reduce((e,a)=>e+(a.amount_value||0),0);return s.jsx(t,{open:y,onOpenChange:w,children:s.jsxs(r,{className:"w-full max-w-[95vw] sm:max-w-6xl max-h-[80vh] overflow-hidden flex flex-col bg-white",children:[s.jsx(n,{className:"flex-shrink-0",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs(c,{className:"modal-title",children:["발주 상세 항목 - ",k.purchase_order_number]}),s.jsxs("div",{className:"flex items-center gap-2",children:[q&&!L&&s.jsxs(l,{variant:"outline",size:"sm",onClick:()=>{A(!0),S([...k.items||[]])},children:[s.jsx(_,{className:"h-4 w-4 mr-1"}),"편집"]}),L&&s.jsxs(s.Fragment,{children:[s.jsxs(l,{variant:"outline",size:"sm",onClick:()=>{const e={line_number:z.length+1,item_name:"",specification:"",quantity:0,unit_price_value:0,amount_value:0,remark:"",is_received:!1};S([...z,e])},children:[s.jsx(g,{className:"h-4 w-4 mr-1"}),"품목 추가"]}),s.jsxs(l,{variant:"default",size:"sm",onClick:async()=>{try{await B.from("purchase_request_items").delete().eq("purchase_request_id",k.id);const e=z.map(e=>({purchase_request_id:k.id,purchase_order_number:k.purchase_order_number,line_number:e.line_number,item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark,link:e.link,is_received:e.is_received||!1,delivery_status:e.delivery_status||"pending"})),{error:a}=await B.from("purchase_request_items").insert(e);if(a)throw a;const s=z.reduce((e,a)=>e+(a.amount_value||0),0);await B.from("purchase_requests").update({total_amount:s}).eq("id",k.id),p.success("품목이 수정되었습니다."),A(!1),C(),w()}catch(e){p.error("저장 중 오류가 발생했습니다.")}},children:[s.jsx(f,{className:"h-4 w-4 mr-1"}),"저장"]}),s.jsx(l,{variant:"ghost",size:"sm",onClick:()=>{A(!1),S(k.items||[])},children:"취소"})]}),s.jsx(l,{variant:"ghost",size:"icon",onClick:w,className:"h-6 w-6",children:s.jsx(i,{className:"h-4 w-4"})})]})]})}),s.jsxs("div",{className:"flex-shrink-0 grid grid-cols-2 md:grid-cols-4 gap-3 py-3 border-b",children:[s.jsxs("div",{children:[s.jsx("p",{className:"modal-label",children:"업체명"}),s.jsx("p",{className:"modal-value",children:k.vendor_name})]}),s.jsxs("div",{children:[s.jsx("p",{className:"modal-label",children:"요청자"}),s.jsx("p",{className:"modal-value",children:k.requester_name})]}),s.jsxs("div",{children:[s.jsx("p",{className:"modal-label",children:"프로젝트"}),s.jsx("p",{className:"modal-value truncate",title:k.project_vendor,children:k.project_vendor})]}),s.jsxs("div",{children:[s.jsx("p",{className:"modal-label",children:"납기일"}),s.jsx("p",{className:"modal-value",children:k.delivery_request_date&&N(new Date(k.delivery_request_date),"yyyy-MM-dd")})]})]}),s.jsx("div",{className:"flex-1 overflow-auto",children:s.jsxs(d,{children:[s.jsx(u,{className:"sticky top-0 bg-white z-10",children:s.jsxs(o,{children:[s.jsx(h,{className:"w-12",children:"No."}),s.jsx(h,{children:"품목"}),s.jsx(h,{children:"규격"}),s.jsx(h,{className:"text-right",children:"수량"}),s.jsx(h,{className:"text-right",children:"단가"}),s.jsx(h,{className:"text-right",children:"금액"}),s.jsx(h,{children:"입고상태"}),s.jsx(h,{children:"영수증"}),s.jsx(h,{children:"비고"}),L&&s.jsx(h,{className:"w-20",children:"삭제"})]})}),s.jsx(x,{children:M.map((e,a)=>s.jsxs(o,{children:[s.jsx(j,{className:"modal-value",children:e.line_number||a+1}),s.jsx(j,{children:L?s.jsx(m,{value:e.item_name,onChange:e=>D(a,"item_name",e.target.value),className:"h-7 modal-label"}):s.jsx("div",{className:"sm:max-w-[200px]",children:s.jsx("p",{className:"modal-value truncate",title:e.item_name,children:e.item_name})})}),s.jsx(j,{children:L?s.jsx(m,{value:e.specification,onChange:e=>D(a,"specification",e.target.value),className:"h-7 modal-label"}):s.jsx("div",{className:"sm:max-w-[150px] truncate",title:e.specification,children:e.specification})}),s.jsx(j,{className:"text-right",children:L?s.jsx(m,{type:"number",value:e.quantity,onChange:e=>D(a,"quantity",e.target.value),className:"h-7 text-xs text-right"}):s.jsx("span",{className:"modal-value",children:e.quantity.toLocaleString()})}),s.jsx(j,{className:"text-right",children:L?s.jsx(m,{type:"number",value:e.unit_price_value,onChange:e=>D(a,"unit_price_value",e.target.value),className:"h-7 text-xs text-right"}):s.jsxs("span",{className:"modal-subtitle",children:[(e.unit_price_value||0).toLocaleString()," ",k.currency]})}),s.jsx(j,{className:"text-right",children:L?s.jsx(m,{type:"number",value:e.amount_value,onChange:e=>D(a,"amount_value",e.target.value),className:"h-7 modal-label text-right"}):s.jsxs("span",{className:"modal-value",children:[(e.amount_value||0).toLocaleString()," ",k.currency]})}),s.jsx(j,{children:e.is_received?s.jsx(v,{className:"bg-green-100 text-green-800 badge-text",children:"입고완료"}):s.jsx(v,{variant:"outline",className:"badge-text",children:"대기"})}),s.jsx(j,{children:L?s.jsx(m,{value:e.remark||"",onChange:e=>D(a,"remark",e.target.value),className:"h-7 modal-label",placeholder:"비고"}):s.jsx("div",{className:"sm:max-w-[150px]",children:s.jsx("span",{className:"modal-subtitle truncate block",title:e.remark,children:e.remark||"-"})})}),L&&s.jsx(j,{children:s.jsx(l,{variant:"ghost",size:"icon",onClick:()=>(e=>{const a=z.filter((a,s)=>s!==e);a.forEach((e,a)=>{e.line_number=a+1}),S(a)})(a),className:"h-7 w-7 text-red-500 hover:text-red-700",children:s.jsx(b,{className:"h-4 w-4"})})})]},e.id||a))})]})}),s.jsxs("div",{className:"flex-shrink-0 border-t pt-4 flex justify-between items-center",children:[s.jsxs("div",{className:"modal-subtitle",children:["총 ",M.length,"개 품목"]}),s.jsxs("div",{className:"modal-value-large",children:["총 금액: ",O.toLocaleString()," ",k.currency]})]})]})})}export{y as default};
//# sourceMappingURL=PurchaseItemsModal-BVgQuRc6.js.map
