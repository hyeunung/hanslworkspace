import{c as e,l as s,r as a,j as t,B as r,X as l,z as n,U as i,b as c,_ as o}from"./index-B10MXRio.js";import{P as d,I as m,D as h,a as x,b as u,c as p,d as j}from"./dialog-Cmrbb0S0.js";import{S as g,a as y,b as f,c as w,d as b}from"./select-B45xlmY8.js";import{C as v}from"./calendar-py_FtKCX.js";import{D as N}from"./download-BIumrsPt.js";import{S as _,T as k}from"./card-QP279vC5.js";import{b as S}from"./helpers-CmqE03mo.js";import{T as C,a as D,b as E,c as $,d as F,e as R}from"./table-Dx8N4oqv.js";import{D as I,a as O,b as L,e as z}from"./dropdown-menu-zAvT3l3P.js";import{t as K}from"./index-DZIVtcIE.js";import{u as q,S as M,E as A,a as U,T as V,b as T,M as P,c as Y,d as B,e as W,F as J,f as Z,g as H,h as G,i as Q,j as X}from"./form-CIOdbZeU.js";import{E as ee}from"./eye-DcyRlawH.js";import{u as se}from"./index.esm-DMceMDjC.js";import{C as ae,a as te,b as re,c as le,d as ne,e as ie}from"./command-DzuMThl_.js";import{P as ce,a as oe,b as de}from"./popover-xpcMj7oI.js";import{C as me}from"./check-DhkQyFTZ.js";import{E as he}from"./exceljs.min-DfVRx8GD.js";import"./chevron-right-1OPWKzlh.js";const xe=new class{constructor(){this.supabase=e()}async getEmployees(e){try{let s=this.supabase.from("employees").select("*").order("name");e?.search&&(s=s.or(`\n          name.ilike.%${e.search}%,\n          email.ilike.%${e.search}%,\n          phone.ilike.%${e.search}%,\n          position.ilike.%${e.search}%,\n          department.ilike.%${e.search}%\n        `)),e?.department&&(s=s.eq("department",e.department)),e?.position&&(s=s.eq("position",e.position)),e?.purchase_role&&(s=s.eq("purchase_role",e.purchase_role)),void 0!==e?.is_active&&(s=s.eq("is_active",e.is_active));const{data:a,error:t}=await s;if(t)throw t;return{success:!0,data:a||[]}}catch(a){return s.error("직원 목록 조회 실패",a),{success:!1,error:a instanceof Error?a.message:"알 수 없는 오류가 발생했습니다."}}}async getEmployee(e){try{const{data:s,error:a}=await this.supabase.from("employees").select("*").eq("id",e).single();if(a)throw a;return{success:!0,data:s}}catch(a){return s.error("직원 조회 실패",a),{success:!1,error:a instanceof Error?a.message:"알 수 없는 오류가 발생했습니다."}}}async createEmployee(e){try{if(e.email){const{data:s}=await this.supabase.from("employees").select("id").eq("email",e.email).single();if(s)return{success:!1,error:"이미 등록된 이메일입니다."}}const s=crypto.randomUUID(),{data:a,error:t}=await this.supabase.from("employees").insert({id:s,...e,purchase_role:e.purchase_role?.join(",")||null,is_active:!0}).select().single();if(t)throw t;return{success:!0,data:a}}catch(a){return s.error("직원 생성 실패",a),{success:!1,error:a instanceof Error?a.message:"알 수 없는 오류가 발생했습니다."}}}async updateEmployee(e,a){try{if(a.email){const{data:s}=await this.supabase.from("employees").select("id").eq("email",a.email).neq("id",e).single();if(s)return{success:!1,error:"이미 등록된 이메일입니다."}}const s={...a,purchase_role:a.purchase_role?a.purchase_role.join(","):void 0};void 0===s.purchase_role&&delete s.purchase_role;const{data:t,error:r}=await this.supabase.from("employees").update(s).eq("id",e).select().single();if(r)throw r;return{success:!0,data:t}}catch(t){return s.error("직원 수정 실패",t),{success:!1,error:t instanceof Error?t.message:"알 수 없는 오류가 발생했습니다."}}}async deleteEmployee(e){try{const{data:s}=await this.supabase.from("purchase_requests").select("id").eq("requester_id",e).limit(1);if(s&&s.length>0){const{error:s}=await this.supabase.from("employees").update({is_active:!1}).eq("id",e);if(s)throw s;return{success:!0}}{const{error:s}=await this.supabase.from("employees").delete().eq("id",e);if(s)throw s;return{success:!0}}}catch(a){return s.error("직원 삭제 실패",a),{success:!1,error:a instanceof Error?a.message:"알 수 없는 오류가 발생했습니다."}}}async toggleEmployeeStatus(e){try{const{data:s,error:a}=await this.supabase.from("employees").select("is_active").eq("id",e).single();if(a)throw a;const{data:t,error:r}=await this.supabase.from("employees").update({is_active:!s.is_active}).eq("id",e).select().single();if(r)throw r;return{success:!0,data:t}}catch(a){return s.error("직원 상태 변경 실패",a),{success:!1,error:a instanceof Error?a.message:"알 수 없는 오류가 발생했습니다."}}}async updateEmployeeRole(e,a){try{const{data:s,error:t}=await this.supabase.from("employees").update({purchase_role:a}).eq("id",e).select().single();if(t)throw t;return{success:!0,data:s}}catch(t){return s.error("직원 권한 변경 실패",t),{success:!1,error:t instanceof Error?t.message:"알 수 없는 오류가 발생했습니다."}}}async getDepartments(){try{const{data:e,error:s}=await this.supabase.from("employees").select("department");if(s)throw s;return{success:!0,data:[...new Set((e||[]).map(e=>e.department).filter(e=>null!=e&&""!==e))].sort()}}catch(e){return s.error("부서 목록 조회 실패",e),{success:!1,error:e instanceof Error?e.message:"알 수 없는 오류가 발생했습니다."}}}async getPositions(){try{const{data:e,error:s}=await this.supabase.from("employees").select("position");if(s)throw s;return{success:!0,data:[...new Set((e||[]).map(e=>e.position).filter(e=>null!=e&&""!==e))].sort()}}catch(e){return s.error("직급 목록 조회 실패",e),{success:!1,error:e instanceof Error?e.message:"알 수 없는 오류가 발생했습니다."}}}async getEmployeesForExport(){try{const{data:e,error:s}=await this.supabase.from("employees").select("*").order("name");if(s)throw s;return{success:!0,data:(e||[]).map(e=>({"이름":e.name,"이메일":e.email||"","전화번호":e.phone||"","주소":e.adress||"","부서":e.department||"","직급":e.position||"","권한":this.getRoleDisplayName(e.purchase_role),"상태":e.is_active?"활성":"비활성","등록일":e.created_at?new Date(e.created_at).toLocaleDateString("ko-KR"):""}))}}catch(e){return s.error("직원 Excel 내보내기 실패",e),{success:!1,error:e instanceof Error?e.message:"알 수 없는 오류가 발생했습니다."}}}getRoleDisplayName(e){return{app_admin:"앱 관리자",ceo:"CEO",final_approver:"최종 승인자",middle_manager:"중간 관리자","lead buyer":"수석 구매자",buyer:"구매자"}[e||""]||e||"권한 없음"}async checkPermission(e,s){try{const{data:a}=await this.supabase.from("employees").select("purchase_role, is_active").eq("id",e).single();if(!a||!a.is_active)return{success:!0,hasPermission:!1};return{success:!0,hasPermission:s.includes(a.purchase_role)}}catch(a){return{success:!1,error:a instanceof Error?a.message:"알 수 없는 오류가 발생했습니다."}}}},ue=[{value:"app_admin",label:"앱 관리자"},{value:"ceo",label:"CEO"},{value:"final_approver",label:"최종 승인자"},{value:"middle_manager",label:"중간 관리자"},{value:"lead buyer",label:"수석 구매자"},{value:"buyer",label:"구매자"}];function pe({filters:e,onFiltersChange:s,onExport:n,onCreateNew:i,onAttendanceDownload:c,onAnnualLeaveUsageDownload:o,canManageEmployees:h=!1}){const[x,u]=a.useState(e.search||""),[p,j]=a.useState([]),[k,S]=a.useState([]);a.useEffect(()=>{(async()=>{const[e,s]=await Promise.all([xe.getDepartments(),xe.getPositions()]);e.success&&j(e.data||[]),s.success&&S(s.data||[])})()},[]);const C=e.search||e.department||e.position||e.purchase_role||void 0!==e.is_active;return t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4",children:[t.jsxs("div",{children:[t.jsx("h2",{className:"page-title",children:"직원 관리"}),t.jsx("p",{className:"page-subtitle",style:{marginTop:"-2px",marginBottom:"-4px"},children:"Employee Management"})]}),h&&t.jsxs("div",{className:"flex gap-2",children:[t.jsxs(r,{variant:"outline",onClick:o,className:"flex items-center gap-1 sm:gap-2 text-xs sm:text-sm",children:[t.jsx(v,{className:"w-3 h-3 sm:w-4 sm:h-4"}),t.jsx("span",{className:"hidden sm:inline",children:"연차사용현황"}),t.jsx("span",{className:"sm:hidden",children:"연차"})]}),t.jsxs(r,{variant:"outline",onClick:c,className:"flex items-center gap-1 sm:gap-2 text-xs sm:text-sm",children:[t.jsx(v,{className:"w-3 h-3 sm:w-4 sm:h-4"}),t.jsx("span",{className:"hidden sm:inline",children:"출근현황표"}),t.jsx("span",{className:"sm:hidden",children:"출근"})]}),t.jsxs(r,{variant:"outline",onClick:n,className:"flex items-center gap-1 sm:gap-2 text-xs sm:text-sm",children:[t.jsx(N,{className:"w-3 h-3 sm:w-4 sm:h-4"}),t.jsx("span",{className:"hidden sm:inline",children:"Excel 내보내기"}),t.jsx("span",{className:"sm:hidden",children:"Excel"})]}),t.jsxs(r,{onClick:i,className:"flex items-center gap-1 sm:gap-2 text-xs sm:text-sm",children:[t.jsx(d,{className:"w-3 h-3 sm:w-4 sm:h-4"}),"직원 등록"]})]})]}),t.jsx("div",{className:"bg-white p-3 sm:p-4 rounded-lg border space-y-4",children:t.jsxs("form",{onSubmit:a=>{a.preventDefault(),s({...e,search:x.trim()||void 0})},className:"flex flex-col sm:flex-row gap-3 sm:gap-4 sm:items-end sm:flex-wrap",children:[t.jsxs("div",{className:"flex-1 sm:min-w-[250px]",children:[t.jsx("label",{className:"block text-xs sm:text-sm font-medium text-gray-700 mb-1",children:"검색"}),t.jsxs("div",{className:"relative",children:[t.jsx(_,{className:"absolute left-2 sm:left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-3 h-3 sm:w-4 sm:h-4"}),t.jsx(m,{type:"text",placeholder:"이름, 이메일, 전화번호로 검색",value:x,onChange:e=>u(e.target.value),className:"pl-8 sm:pl-10 text-sm h-9"})]})]}),t.jsxs("div",{className:"w-full sm:w-auto sm:min-w-[120px]",children:[t.jsx("label",{className:"block text-xs sm:text-sm font-medium text-gray-700 mb-1",children:"부서"}),t.jsxs(g,{value:e.department||"all",onValueChange:a=>{s({...e,department:"all"===a?void 0:a})},children:[t.jsx(y,{className:"h-9",children:t.jsx(f,{})}),t.jsxs(w,{children:[t.jsx(b,{value:"all",children:"전체 부서"}),p.map(e=>t.jsx(b,{value:e,children:e},e))]})]})]}),t.jsxs("div",{className:"w-full sm:w-auto sm:min-w-[120px]",children:[t.jsx("label",{className:"block text-xs sm:text-sm font-medium text-gray-700 mb-1",children:"직급"}),t.jsxs(g,{value:e.position||"all",onValueChange:a=>{s({...e,position:"all"===a?void 0:a})},children:[t.jsx(y,{className:"h-9",children:t.jsx(f,{})}),t.jsxs(w,{children:[t.jsx(b,{value:"all",children:"전체 직급"}),k.map(e=>t.jsx(b,{value:e,children:e},e))]})]})]}),t.jsxs("div",{className:"w-full sm:w-auto sm:min-w-[140px]",children:[t.jsx("label",{className:"block text-xs sm:text-sm font-medium text-gray-700 mb-1",children:"권한"}),t.jsxs(g,{value:e.purchase_role||"all",onValueChange:a=>{s({...e,purchase_role:"all"===a?void 0:"none"===a?"":a})},children:[t.jsx(y,{className:"h-9",children:t.jsx(f,{})}),t.jsxs(w,{children:[t.jsx(b,{value:"all",children:"전체 권한"}),t.jsx(b,{value:"none",children:"권한 없음"}),ue.map(e=>t.jsx(b,{value:e.value,children:e.label},e.value))]})]})]}),t.jsxs("div",{className:"w-full sm:w-auto sm:min-w-[100px]",children:[t.jsx("label",{className:"block text-xs sm:text-sm font-medium text-gray-700 mb-1",children:"상태"}),t.jsxs(g,{value:void 0===e.is_active?"all":e.is_active?"active":"inactive",onValueChange:a=>{s({...e,is_active:"all"===a?void 0:"active"===a})},children:[t.jsx(y,{className:"h-9",children:t.jsx(f,{})}),t.jsxs(w,{children:[t.jsx(b,{value:"all",children:"전체"}),t.jsx(b,{value:"active",children:"활성"}),t.jsx(b,{value:"inactive",children:"비활성"})]})]})]}),t.jsxs("div",{className:"flex gap-2 w-full sm:w-auto",children:[t.jsx(r,{type:"submit",className:"flex-1 sm:flex-none h-9 text-sm",children:"검색"}),C&&t.jsxs(r,{type:"button",variant:"outline",onClick:()=>{u(""),s({})},className:"flex items-center gap-1 h-9 text-sm",children:[t.jsx(l,{className:"w-3 h-3 sm:w-4 sm:h-4"}),t.jsx("span",{className:"hidden sm:inline",children:"초기화"}),t.jsx("span",{className:"sm:hidden",children:"초기"})]})]})]})})]})}function je({employees:e,onEdit:s,onView:l,onRefresh:n,currentUserRoles:i=[]}){const[c,o]=a.useState(null),{sortedData:d,sortConfig:m,handleSort:h}=q(e,"name","asc"),x=i.includes("app_admin")||i.includes("hr"),u=async e=>{if(x){o(e.id);try{const s=await xe.toggleEmployeeStatus(e.id);s.success?(K.success(`직원이 ${e.is_active?"비활성화":"활성화"}되었습니다.`),n()):K.error(s.error||"상태 변경에 실패했습니다.")}catch(s){K.error("상태 변경 중 오류가 발생했습니다.")}finally{o(null)}}else K.error("상태 변경 권한이 없습니다.")},p=async e=>{if(x){if(confirm(`정말로 '${e.name}' 직원을 삭제하시겠습니까?`)){o(e.id);try{const s=await xe.deleteEmployee(e.id);s.success?(K.success("직원이 삭제되었습니다."),n()):K.error(s.error||"삭제에 실패했습니다.")}catch(s){K.error("삭제 중 오류가 발생했습니다.")}finally{o(null)}}}else K.error("삭제 권한이 없습니다.")},j=e=>({app_admin:"앱 관리자",ceo:"CEO",final_approver:"최종 승인자",middle_manager:"중간 관리자","lead buyer":"수석 구매자",buyer:"구매자"}[e||""]||"권한 없음"),g=e=>({app_admin:"bg-purple-100 text-purple-800",ceo:"bg-red-100 text-red-800",final_approver:"bg-hansl-100 text-hansl-800",middle_manager:"bg-green-100 text-green-800","lead buyer":"bg-yellow-100 text-yellow-800",buyer:"bg-gray-100 text-gray-800"}[e||""]||"bg-gray-100 text-gray-600");return t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"hidden lg:block border rounded-lg overflow-hidden",children:t.jsx("div",{className:"overflow-x-auto",children:t.jsxs(C,{children:[t.jsx(D,{children:t.jsxs(E,{children:[t.jsx($,{className:"w-16 min-w-[50px]",children:t.jsx(M,{sortKey:"employeeID",currentSortKey:m.key,sortDirection:m.direction,onSort:()=>h("employeeID"),children:"사번"})}),t.jsx($,{className:"w-14 min-w-[45px]",children:t.jsx(M,{sortKey:"name",currentSortKey:m.key,sortDirection:m.direction,onSort:()=>h("name"),children:"이름"})}),t.jsx($,{className:"w-12 min-w-[40px]",children:t.jsx(M,{sortKey:"position",currentSortKey:m.key,sortDirection:m.direction,onSort:()=>h("position"),children:"직급"})}),t.jsx($,{className:"w-16 min-w-[50px]",children:t.jsx(M,{sortKey:"department",currentSortKey:m.key,sortDirection:m.direction,onSort:()=>h("department"),children:"부서"})}),t.jsx($,{className:"w-20 min-w-[70px]",children:t.jsx(M,{sortKey:"phone",currentSortKey:m.key,sortDirection:m.direction,onSort:()=>h("phone"),children:"연락처"})}),t.jsx($,{className:"w-32 min-w-[100px]",children:t.jsx(M,{sortKey:"email",currentSortKey:m.key,sortDirection:m.direction,onSort:()=>h("email"),children:"이메일"})}),x&&t.jsxs(t.Fragment,{children:[t.jsx($,{className:"w-11 min-w-[40px] text-center",children:"생성"}),t.jsx($,{className:"w-11 min-w-[40px] text-center",children:"사용"}),t.jsx($,{className:"w-11 min-w-[40px] text-center",children:"남은"}),t.jsx($,{className:"hidden lg:table-cell w-18 min-w-[60px]",children:t.jsx(M,{sortKey:"join_date",currentSortKey:m.key,sortDirection:m.direction,onSort:()=>h("join_date"),children:"입사일"})}),t.jsx($,{className:"hidden lg:table-cell w-20 min-w-[70px]",children:t.jsx(M,{sortKey:"birthday",currentSortKey:m.key,sortDirection:m.direction,onSort:()=>h("birthday"),children:"생년월일"})}),t.jsx($,{className:"hidden xl:table-cell w-14 min-w-[45px]",children:"은행"}),t.jsx($,{className:"hidden xl:table-cell w-24 min-w-[80px]",children:"계좌번호"}),t.jsx($,{className:"hidden 2xl:table-cell min-w-[120px]",children:"주소"}),t.jsx($,{children:t.jsx(M,{sortKey:"purchase_role",currentSortKey:m.key,sortDirection:m.direction,onSort:()=>h("purchase_role"),children:"권한"})}),t.jsx($,{children:t.jsx(M,{sortKey:"is_active",currentSortKey:m.key,sortDirection:m.direction,onSort:()=>h("is_active"),children:"상태"})}),t.jsx($,{className:"w-16 min-w-[50px]",children:"작업"})]})]})}),t.jsx(F,{children:0===e.length?t.jsx(E,{children:t.jsx(R,{colSpan:x?14:6,className:"text-center py-8 text-gray-500",children:"등록된 직원이 없습니다."})}):d.map(e=>t.jsxs(E,{children:[t.jsx(R,{className:"text-[11px] px-2 py-1.5",children:e.employeeID||e.employee_number||e.id.slice(0,8)}),t.jsx(R,{className:"text-[11px] px-2 py-1.5",children:e.name}),t.jsx(R,{className:"text-[11px] px-2 py-1.5",children:e.position||"-"}),t.jsx(R,{className:"text-[11px] px-2 py-1.5",children:e.department||"-"}),t.jsx(R,{className:"text-[11px] px-2 py-1.5",children:e.phone||"-"}),t.jsx(R,{className:"text-[11px] px-2 py-1.5",children:e.email||"-"}),x&&t.jsxs(t.Fragment,{children:[t.jsx(R,{className:"text-center text-[11px] px-1 py-1.5",children:e.annual_leave_granted_current_year||0}),t.jsx(R,{className:"text-center text-[11px] px-1 py-1.5",children:e.used_annual_leave||0}),t.jsx(R,{className:"text-center text-[11px] px-1 py-1.5",children:void 0!==e.remaining_annual_leave?e.remaining_annual_leave:"-"}),t.jsx(R,{className:"hidden lg:table-cell text-[11px] px-2 py-1.5",children:S(e.join_date)}),t.jsx(R,{className:"hidden lg:table-cell text-[11px] px-2 py-1.5",children:S(e.birthday)}),t.jsx(R,{className:"hidden xl:table-cell text-[11px] px-2 py-1.5",children:e.bank||"-"}),t.jsx(R,{className:"hidden xl:table-cell text-[11px] px-2 py-1.5",children:e.bank_account||"-"}),t.jsx(R,{className:"hidden 2xl:table-cell text-[11px] px-2 py-1.5",children:e.adress||"-"}),t.jsx(R,{className:"px-2 py-1.5",children:t.jsx("span",{className:`badge-stats text-[10px] px-1.5 py-0.5 ${g(e.purchase_role)}`,children:j(e.purchase_role)})}),t.jsx(R,{className:"px-2 py-1.5",children:t.jsx("span",{className:"badge-stats text-[10px] px-1.5 py-0.5 "+(e.is_active?"bg-green-100 text-green-800":"bg-gray-100 text-gray-600"),children:e.is_active?"활성":"비활성"})}),t.jsx(R,{className:"px-1 py-1.5",children:t.jsxs(I,{children:[t.jsx(O,{asChild:!0,children:t.jsx(r,{variant:"ghost",className:"h-7 w-7 p-0",disabled:c===e.id,children:t.jsx(A,{className:"h-3 w-3"})})}),t.jsxs(L,{align:"end",children:[t.jsxs(z,{onClick:()=>l(e),children:[t.jsx(ee,{className:"mr-2 h-4 w-4"}),"상세 보기"]}),t.jsxs(z,{onClick:()=>s(e),children:[t.jsx(U,{className:"mr-2 h-4 w-4"}),"수정"]}),t.jsx(z,{onClick:()=>u(e),children:e.is_active?t.jsxs(t.Fragment,{children:[t.jsx(V,{className:"mr-2 h-4 w-4"}),"비활성화"]}):t.jsxs(t.Fragment,{children:[t.jsx(T,{className:"mr-2 h-4 w-4"}),"활성화"]})}),t.jsxs(z,{onClick:()=>p(e),className:"text-red-600",children:[t.jsx(k,{className:"mr-2 h-4 w-4"}),"삭제"]})]})]})})]})]},e.id))})]})})}),t.jsx("div",{className:"hidden md:block lg:hidden",children:t.jsx("div",{className:"overflow-x-auto border rounded-lg",children:t.jsxs("table",{className:"w-full "+(x?"min-w-[700px]":"min-w-[520px]"),children:[t.jsx("thead",{className:"bg-gray-50",children:t.jsxs("tr",{children:[t.jsx("th",{className:"text-left p-3 header-title text-gray-900 w-16",children:"사번"}),t.jsx("th",{className:"text-left p-3 header-title text-gray-900 w-20",children:"이름"}),t.jsx("th",{className:"text-left p-3 header-title text-gray-900 w-20",children:"직급"}),t.jsx("th",{className:"text-left p-3 header-title text-gray-900 w-24",children:"부서"}),t.jsx("th",{className:"text-left p-3 header-title text-gray-900",children:"연락처"}),t.jsx("th",{className:"text-left p-3 header-title text-gray-900",children:"이메일"}),x&&t.jsxs(t.Fragment,{children:[t.jsx("th",{className:"text-left p-3 header-title text-gray-900 w-24",children:"권한"}),t.jsx("th",{className:"text-center p-3 header-title text-gray-900 w-16",children:"상태"}),t.jsx("th",{className:"text-center p-3 header-title text-gray-900 w-16",children:"작업"})]})]})}),t.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:0===d.length?t.jsx("tr",{children:t.jsx("td",{colSpan:x?9:6,className:"text-center py-8 text-gray-500",children:"등록된 직원이 없습니다."})}):d.map(e=>t.jsxs("tr",{className:"hover:bg-gray-50",children:[t.jsx("td",{className:"p-3 modal-subtitle",children:e.employeeID||e.employee_number||e.id.slice(0,8)}),t.jsx("td",{className:"p-3 modal-value",children:e.name}),t.jsx("td",{className:"p-3 modal-subtitle",children:e.position||"-"}),t.jsx("td",{className:"p-3 modal-subtitle",children:e.department||"-"}),t.jsx("td",{className:"p-3 modal-subtitle",children:e.phone||"-"}),t.jsx("td",{className:"p-3 modal-subtitle",children:e.email||"-"}),x&&t.jsxs(t.Fragment,{children:[t.jsx("td",{className:"p-3",children:t.jsx("span",{className:`badge-stats text-xs ${g(e.purchase_role)}`,children:j(e.purchase_role)})}),t.jsx("td",{className:"p-3 text-center",children:t.jsx("span",{className:"badge-stats text-xs "+(e.is_active?"bg-green-100 text-green-800":"bg-gray-100 text-gray-600"),children:e.is_active?"활성":"비활성"})}),t.jsx("td",{className:"p-3 text-center",children:t.jsxs(I,{children:[t.jsx(O,{asChild:!0,children:t.jsx(r,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0",children:t.jsx(A,{className:"h-4 w-4"})})}),t.jsxs(L,{align:"end",children:[t.jsxs(z,{onClick:()=>l(e),children:[t.jsx(ee,{className:"mr-2 h-4 w-4"}),"상세 보기"]}),t.jsxs(z,{onClick:()=>s(e),children:[t.jsx(U,{className:"mr-2 h-4 w-4"}),"수정"]}),t.jsx(z,{onClick:()=>u(e),children:e.is_active?t.jsxs(t.Fragment,{children:[t.jsx(V,{className:"mr-2 h-4 w-4"}),"비활성화"]}):t.jsxs(t.Fragment,{children:[t.jsx(T,{className:"mr-2 h-4 w-4"}),"활성화"]})}),t.jsxs(z,{onClick:()=>p(e),className:"text-red-600",children:[t.jsx(k,{className:"mr-2 h-4 w-4"}),"삭제"]})]})]})})]})]},e.id))})]})})}),t.jsx("div",{className:"block md:hidden space-y-3",children:0===d.length?t.jsx("div",{className:"text-center py-8 text-gray-500",children:"등록된 직원이 없습니다."}):d.map(e=>t.jsxs(P,{children:[t.jsx(Y,{children:t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{children:e.name}),x&&t.jsx("span",{className:"badge-stats "+(e.is_active?"bg-green-100 text-green-800":"bg-gray-100 text-gray-600"),children:e.is_active?"활성":"비활성"})]})}),t.jsx(B,{label:"사번",value:e.employeeID||e.employee_number||e.id.slice(0,8)}),t.jsx(B,{label:"직급",value:e.position||"-"}),t.jsx(B,{label:"부서",value:e.department||"-"}),t.jsx(B,{label:"연락처",value:e.phone||"-"}),t.jsx(B,{label:"이메일",value:e.email||"-"}),x&&t.jsxs(t.Fragment,{children:[t.jsx(B,{label:"권한",value:t.jsx("span",{className:`badge-stats ${g(e.purchase_role)}`,children:j(e.purchase_role)})}),t.jsx(B,{label:"주소",value:e.adress||"-"}),t.jsx(B,{label:"은행",value:e.bank||"-"}),t.jsx(B,{label:"계좌번호",value:e.bank_account||"-"}),t.jsx(B,{label:"연차",value:void 0!==e.remaining_annual_leave?`${e.remaining_annual_leave}일`:"-"}),t.jsxs(W,{children:[t.jsx(r,{size:"sm",variant:"outline",onClick:()=>l(e),children:t.jsx(ee,{className:"w-4 h-4"})}),t.jsx(r,{size:"sm",variant:"outline",onClick:()=>s(e),children:t.jsx(U,{className:"w-4 h-4"})}),t.jsx(r,{size:"sm",variant:"outline",onClick:()=>u(e),disabled:c===e.id,children:e.is_active?t.jsx(V,{className:"w-4 h-4"}):t.jsx(T,{className:"w-4 h-4"})}),t.jsx(r,{size:"sm",variant:"outline",className:"text-red-600",onClick:()=>p(e),disabled:c===e.id,children:t.jsx(k,{className:"w-4 h-4"})})]})]})]},e.id))})]})}const ge=[{value:"app_admin",label:"앱 관리자"},{value:"ceo",label:"CEO"},{value:"final_approver",label:"최종 승인자"},{value:"middle_manager",label:"중간 관리자"},{value:"lead buyer",label:"수석 구매자"},{value:"buyer",label:"구매자"}];function ye({isOpen:e,onClose:s,employee:l,onSave:n,mode:i}){const[c,o]=a.useState(!1),[d,v]=a.useState([]),[N,_]=a.useState([]),k=se({defaultValues:{name:"",email:"",phone:"",position:"",department:"",purchase_role:[]}});a.useEffect(()=>{(async()=>{const[e,s]=await Promise.all([xe.getDepartments(),xe.getPositions()]);e.success&&v(e.data||[]),s.success&&_(s.data||[])})()},[]),a.useEffect(()=>{l&&e?k.reset({name:l.name||"",email:l.email||"",phone:l.phone||"",position:l.position||"",department:l.department||"",purchase_role:Array.isArray(l.purchase_role)?l.purchase_role:l.purchase_role?.split(",")||[]}):!l&&e&&k.reset({name:"",email:"",phone:"",position:"",department:"",purchase_role:[]})},[l,e,k]);const S="view"===i;return t.jsx(h,{open:e,onOpenChange:s,children:t.jsxs(x,{className:"w-full max-w-[95vw] sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[t.jsx(u,{children:t.jsx(p,{children:(()=>{switch(i){case"create":return"직원 등록";case"edit":return"직원 수정";case"view":return"직원 상세";default:return"직원"}})()})}),t.jsx(J,{...k,children:t.jsxs("form",{onSubmit:k.handleSubmit(async e=>{o(!0);try{let a;"create"===i?a=await xe.createEmployee(e):"edit"===i&&l&&(a=await xe.updateEmployee(l.id,e)),a?.success?(K.success("create"===i?"직원이 등록되었습니다.":"직원 정보가 수정되었습니다."),n(),s()):K.error(a?.error||"처리 중 오류가 발생했습니다.")}catch(a){K.error("처리 중 오류가 발생했습니다.")}finally{o(!1)}}),className:"space-y-4",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsx(Z,{control:k.control,name:"name",rules:{required:"이름을 입력해주세요."},render:({field:e})=>t.jsxs(H,{children:[t.jsx(G,{children:"이름 *"}),t.jsx(Q,{children:t.jsx(m,{...e,placeholder:"이름을 입력하세요",disabled:S})}),t.jsx(X,{})]})}),t.jsx(Z,{control:k.control,name:"email",rules:{pattern:{value:/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$/i,message:"올바른 이메일 형식을 입력해주세요."}},render:({field:e})=>t.jsxs(H,{children:[t.jsx(G,{children:"이메일"}),t.jsx(Q,{children:t.jsx(m,{...e,type:"email",placeholder:"user@example.com",disabled:S})}),t.jsx(X,{})]})}),t.jsx(Z,{control:k.control,name:"phone",render:({field:e})=>t.jsxs(H,{children:[t.jsx(G,{children:"전화번호"}),t.jsx(Q,{children:t.jsx(m,{...e,placeholder:"010-0000-0000",disabled:S})}),t.jsx(X,{})]})}),t.jsx(Z,{control:k.control,name:"department",render:({field:e})=>t.jsxs(H,{children:[t.jsx(G,{children:"부서"}),t.jsx(Q,{children:S?t.jsx(m,{...e,disabled:!0}):t.jsxs(g,{onValueChange:e.onChange,defaultValue:e.value,children:[t.jsx(y,{children:t.jsx(f,{placeholder:"부서를 선택하세요"})}),t.jsxs(w,{children:[d.map(e=>t.jsx(b,{value:e,children:e},e)),t.jsx(b,{value:"custom",children:"직접 입력"})]})]})}),t.jsx(X,{})]})}),t.jsx(Z,{control:k.control,name:"position",render:({field:e})=>t.jsxs(H,{children:[t.jsx(G,{children:"직급"}),t.jsx(Q,{children:S?t.jsx(m,{...e,disabled:!0}):t.jsxs(g,{onValueChange:e.onChange,defaultValue:e.value,children:[t.jsx(y,{children:t.jsx(f,{placeholder:"직급을 선택하세요"})}),t.jsxs(w,{children:[N.map(e=>t.jsx(b,{value:e,children:e},e)),t.jsx(b,{value:"custom",children:"직접 입력"})]})]})}),t.jsx(X,{})]})}),t.jsx(Z,{control:k.control,name:"purchase_role",render:({field:e})=>t.jsxs(H,{children:[t.jsx(G,{children:"권한"}),t.jsx(Q,{children:t.jsxs(g,{onValueChange:s=>e.onChange("none"===s?[]:[s]),defaultValue:e.value?.[0]||"none",disabled:S,children:[t.jsx(y,{children:t.jsx(f,{placeholder:"권한을 선택하세요"})}),t.jsxs(w,{children:[t.jsx(b,{value:"none",children:"권한 없음"}),ge.map(e=>t.jsx(b,{value:e.value,children:e.label},e.value))]})]})}),t.jsx(X,{})]})})]}),"view"===i&&l&&t.jsx("div",{className:"pt-4 border-t",children:t.jsxs("div",{className:"grid grid-cols-2 gap-4 modal-subtitle",children:[t.jsxs("div",{children:[t.jsx("span",{className:"text-gray-500",children:"상태:"}),t.jsx("span",{className:"ml-2 px-2 py-1 business-radius-badge badge-text "+(l.is_active?"bg-green-100 text-green-800":"bg-gray-100 text-gray-600"),children:l.is_active?"활성":"비활성"})]}),t.jsxs("div",{children:[t.jsx("span",{className:"text-gray-500",children:"등록일:"}),t.jsx("span",{className:"ml-2",children:l.created_at?new Date(l.created_at).toLocaleDateString("ko-KR"):"-"})]})]})}),t.jsxs(j,{className:"gap-2",children:[t.jsx(r,{type:"button",variant:"outline",onClick:s,children:"view"===i?"닫기":"취소"}),!S&&t.jsx(r,{type:"submit",disabled:c,children:c?"create"===i?"등록 중...":"수정 중...":"create"===i?"등록":"수정"})]})]})})]})})}function fe({options:e,value:s,onValueChange:l,placeholder:i="선택...",searchPlaceholder:c="검색...",emptyText:o="결과가 없습니다.",className:d}){const[m,h]=a.useState(!1);return t.jsxs(ce,{open:m,onOpenChange:h,children:[t.jsx(oe,{asChild:!0,children:t.jsxs(r,{variant:"outline",role:"combobox","aria-expanded":m,className:n("w-full justify-between h-9 text-sm font-normal",d),children:[s?e.find(e=>e.value===s)?.label:i,t.jsx(ae,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),t.jsx(de,{className:"w-full p-0",align:"start",children:t.jsxs(te,{children:[t.jsx(re,{placeholder:c,className:"h-9"}),t.jsx(le,{children:o}),t.jsx(ne,{className:"max-h-[300px] overflow-auto",children:e.map(e=>t.jsxs(ie,{value:e.label,onSelect:()=>{l(e.value===s?"":e.value),h(!1)},children:[t.jsx(me,{className:n("mr-2 h-4 w-4",s===e.value?"opacity-100":"opacity-0")}),e.label]},e.value))})]})})]})}async function we(e){const s=new he.Workbook,a=s.addWorksheet("출근현황표");a.pageSetup={paperSize:9,orientation:"portrait",margins:{left:.7,right:.7,top:.75,bottom:.75,header:.3,footer:.3}},a.columns=[{width:12},{width:8},{width:12},{width:8},{width:6},{width:8},{width:12},{width:12},{width:8},{width:8}];a.addRow(["1"]).height=25,a.mergeCells("A1:J1");const t=a.getCell("A1");t.value="1",t.font={name:"맑은 고딕",size:14,bold:!0},t.alignment={horizontal:"center",vertical:"middle"},a.addRow([]);a.addRow([`${e.employeeName} 내역 (21)`]).height=20,a.mergeCells("A3:J3");const r=a.getCell("A3");r.font={name:"맑은 고딕",size:12,bold:!0},r.alignment={horizontal:"left",vertical:"middle"};a.addRow([`조회기간: ${e.startDate} ~ ${e.endDate}`]).height=20,a.mergeCells("A4:J4");const l=a.getCell("A4");l.font={name:"맑은 고딕",size:10},l.alignment={horizontal:"left",vertical:"middle"};const n=a.addRow(["날짜","이름","사번","부서","직급","근무형태","출근시간","퇴근시간","출퇴근상태","근무상태"]);n.height=25,n.eachCell((e,s)=>{e.font={name:"맑은 고딕",size:10,bold:!0},e.alignment={horizontal:"center",vertical:"middle"},e.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}},e.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFE0E0E0"}}});e.records.forEach(e=>{let s=e.remarks||"-";const t=(e=>{const s=new Date(e.split("(")[0]),a=s.getDay();if(0===a||6===a)return!0;const t=s.getFullYear(),r=s.getMonth()+1,l=s.getDate(),n=[`${t}-01-01`,`${t}-03-01`,`${t}-05-05`,`${t}-06-06`,`${t}-08-15`,`${t}-10-03`,`${t}-10-09`,`${t}-12-25`],i=`${t}-${r.toString().padStart(2,"0")}-${l.toString().padStart(2,"0")}`;return n.includes(i)})(e.date);if(e.remarks&&e.remarks.includes("연차"))s="연차";else if(t){const a=new Date(e.date.split("(")[0]).getDay();s=0===a||6===a?"주말":"공휴일"}const r=a.addRow([e.date,e.employeeName,e.employeeId,e.department,e.position,e.workType,e.clockIn||"-",e.clockOut||"-",e.status,s]);r.height=20;const l=t,n=e.remarks&&e.remarks.includes("연차");r.eachCell((e,s)=>{e.font={name:"맑은 고딕",size:9},e.alignment={horizontal:1===s?"center":"left",vertical:"middle"},e.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}},7!==s&&8!==s||(e.alignment={horizontal:"center",vertical:"middle"}),n?e.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFE8F5E8"}}:l&&(e.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFFFE8E8"}})})});const i=await s.xlsx.writeBuffer();return new Blob([i],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"})}function be(e){const s=function(e){return["일","월","화","수","목","금","토"][new Date(e).getDay()]}(e);return`${e}(${s})`}function ve({employees:s,isOpen:l,onClose:n}){const[c,o]=a.useState(""),[d,j]=a.useState(""),[g,y]=a.useState(""),[f,w]=a.useState(!1),b=e(),_=()=>{o(""),j(""),y(""),w(!1),n()};return t.jsx(h,{open:l,onOpenChange:_,children:t.jsxs(x,{className:"sm:max-w-[520px] max-h-[85vh] overflow-y-auto",children:[t.jsxs(u,{className:"pb-6 space-y-3",children:[t.jsxs(p,{className:"flex items-center text-2xl font-bold text-gray-900",children:[t.jsx("div",{className:"w-12 h-12 rounded-xl bg-gradient-to-br from-hansl-400 to-hansl-600 flex items-center justify-center mr-4 shadow-sm",children:t.jsx(v,{className:"w-6 h-6 text-white"})}),"출근현황표 다운로드"]}),t.jsxs("p",{className:"text-gray-600 leading-relaxed pl-16",children:["직원과 조회 기간을 선택하여 출근현황을",t.jsx("br",{}),"엑셀 파일로 간편하게 다운로드하세요"]})]}),t.jsxs("div",{className:"space-y-8 py-2",children:[t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx("div",{className:"w-8 h-8 rounded-lg bg-blue-50 flex items-center justify-center",children:t.jsx(i,{className:"w-4 h-4 text-blue-600"})}),t.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"직원 선택"})]}),t.jsx("div",{className:"pl-11",children:t.jsx(fe,{value:c,onValueChange:o,options:s.filter(e=>e.name&&""!==e.name.trim()).sort((e,s)=>(e.name||"").localeCompare(s.name||"")).map(e=>({value:e.id,label:`${e.name} (${e.department||"부서없음"})`})),placeholder:"직원명 검색...",searchPlaceholder:"직원 이름 검색...",emptyText:"검색 결과가 없습니다",className:"h-10 text-sm border-gray-200 focus:border-hansl-400 focus:ring-1 focus:ring-hansl-100"})})]}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx("div",{className:"w-8 h-8 rounded-lg bg-green-50 flex items-center justify-center",children:t.jsx(v,{className:"w-4 h-4 text-green-600"})}),t.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"조회 기간"})]}),t.jsxs("div",{className:"pl-11 space-y-4",children:[t.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"시작일"}),t.jsx(m,{type:"date",value:d,onChange:e=>j(e.target.value),className:"h-9 text-sm border-gray-200 focus:border-hansl-400 focus:ring-1 focus:ring-hansl-100"})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"종료일"}),t.jsx(m,{type:"date",value:g,onChange:e=>y(e.target.value),className:"h-9 text-sm border-gray-200 focus:border-hansl-400 focus:ring-1 focus:ring-hansl-100"})]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("p",{className:"text-sm font-medium text-gray-700",children:"빠른 선택"}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(r,{type:"button",variant:"outline",size:"sm",onClick:()=>{const e=new Date,s=new Date(e.getFullYear(),e.getMonth(),1),a=new Date(e.getFullYear(),e.getMonth()+1,0);j(s.toISOString().split("T")[0]),y(a.toISOString().split("T")[0])},className:"h-8 px-4 text-sm border-gray-200 hover:bg-hansl-50 hover:border-hansl-300 hover:text-hansl-700 transition-colors",children:"이번 달"}),t.jsx(r,{type:"button",variant:"outline",size:"sm",onClick:()=>{const e=new Date,s=new Date(e.getFullYear(),e.getMonth()-1,1),a=new Date(e.getFullYear(),e.getMonth(),0);j(s.toISOString().split("T")[0]),y(a.toISOString().split("T")[0])},className:"h-8 px-4 text-sm border-gray-200 hover:bg-hansl-50 hover:border-hansl-300 hover:text-hansl-700 transition-colors",children:"지난 달"})]})]})]})]})]}),t.jsxs("div",{className:"flex gap-3 pt-6 mt-2 border-t border-gray-100",children:[t.jsx(r,{variant:"outline",onClick:_,className:"flex-1 h-10 text-sm font-medium border-gray-200 hover:bg-gray-50 transition-colors",disabled:f,children:"취소"}),t.jsxs(r,{onClick:async()=>{if(c)if(d&&g)if(new Date(d)>new Date(g))K.error("시작일이 종료일보다 늦을 수 없습니다.");else{w(!0);try{const e=s.find(e=>e.id===c);if(!e)throw new Error("선택된 직원 정보를 찾을 수 없습니다.");const{data:a,error:t}=await b.from("attendance_records").select("*").eq("employee_id",c).gte("date",d).lte("date",g).order("date",{ascending:!0});if(t)throw new Error("출근 기록을 조회하는데 실패했습니다.");const r=[],l=new Date(d),i=new Date(g);for(let s=new Date(l);s<=i;s.setDate(s.getDate()+1))r.push(s.toISOString().split("T")[0]);const o=new Map;a?.forEach(e=>{o.set(e.date,e)});const m=r.map(s=>{const a=o.get(s),t=be(s),r=t.split("(")[1]?.split(")")[0]||"",l=new Date(s),n=0===l.getDay()||6===l.getDay();return{date:t,dayOfWeek:r,employeeName:e.name||"",employeeId:e.employeeID||e.employee_number||"",department:e.department||"",position:e.position||"",workType:"사원",clockIn:a?.clock_in||(n?"-":""),clockOut:a?.clock_out||(n?"-":""),status:"정상 출근"===a?.status?"정상 출근":a?.status||"",remarks:a?.remarks||""}}),h={employeeName:e.name||"",employeeId:e.employeeID||"",department:e.department||"",startDate:d,endDate:g,records:m},x=await we(h),u=window.URL.createObjectURL(x),p=document.createElement("a");p.href=u,p.download=`출근현황표_${e.name}_${d}_${g}.xlsx`,document.body.appendChild(p),p.click(),document.body.removeChild(p),window.URL.revokeObjectURL(u),K.success("출근현황표가 다운로드되었습니다."),n()}catch(e){K.error(e instanceof Error?e.message:"다운로드 중 오류가 발생했습니다.")}finally{w(!1)}}else K.error("조회 기간을 설정해주세요.");else K.error("직원을 선택해주세요.")},disabled:f||!c||!d||!g,className:"flex-1 h-10 text-sm bg-gradient-to-r from-hansl-500 to-hansl-600 hover:from-hansl-600 hover:to-hansl-700 text-white font-medium shadow-sm transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed",children:[t.jsx(N,{className:"w-4 h-4 mr-2"}),f?"다운로드 중...":"엑셀 다운로드"]})]})]})})}const Ne=["일","월","화","수","목","금","토"];function _e(e){const s=new Date(e);return s.setHours(0,0,0,0),s}function ke(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function Se(e){const s=(e.status??"").toString().toLowerCase();if(!("approved"===s||s.includes("approved")||s.includes("승인")))return{ok:!1,reason:"not_approved",unit:1};const a=(e.type??"").toString(),t=(e.reason??"").toString(),r=a.toLowerCase(),l=t.toLowerCase();return r.includes("annual")||r.includes("연차")||r.includes("half")||r.includes("반차")||l.includes("half")||l.includes("반차")||l.includes("0.5")?{ok:!0,reason:"included",unit:Ce(e)}:{ok:!1,reason:"not_annual_or_half",unit:1}}function Ce(e){const s=Number(e.days??NaN);if(!Number.isNaN(s))return.5===s?.5:1;const a=(e.start_period??"").toString().toLowerCase(),t=(e.end_period??"").toString().toLowerCase();if((a&&"full"!==a||t&&"full"!==t)&&e.start_date===e.end_date)return.5;const r=(e.type??"").toString().toLowerCase(),l=(e.reason??"").toString().toLowerCase();return(r.includes("half")||r.includes("반차")||l.includes("half")||l.includes("반차")||l.includes("0.5"))&&e.start_date===e.end_date?.5:1}function De({isOpen:s,onClose:l}){const[n,i]=a.useState(String((new Date).getFullYear())),[c,o]=a.useState(!1),d=e();return t.jsx(h,{open:s,onOpenChange:()=>{i(String((new Date).getFullYear())),o(!1),l()},children:t.jsxs(x,{className:"sm:max-w-[520px] max-h-[85vh] overflow-y-auto",children:[t.jsxs(u,{className:"pb-6 space-y-3",children:[t.jsxs(p,{className:"flex items-center text-2xl font-bold text-gray-900",children:[t.jsx("div",{className:"w-12 h-12 rounded-xl bg-gradient-to-br from-hansl-400 to-hansl-600 flex items-center justify-center mr-4 shadow-sm",children:t.jsx(v,{className:"w-6 h-6 text-white"})}),"연차사용현황 다운로드"]}),t.jsxs("p",{className:"text-gray-600 leading-relaxed pl-16",children:["연도를 선택하면 직원별 사용일수와 월별 상세(일자/단위)를",t.jsx("br",{}),"엑셀로 다운로드합니다"]})]}),t.jsxs("div",{className:"space-y-6 py-2",children:[t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"연도"}),t.jsx(m,{type:"number",value:n,onChange:e=>i(e.target.value),min:2e3,max:2100,placeholder:"예: 2025",className:"h-9 text-sm border-gray-200 focus:border-hansl-400 focus:ring-1 focus:ring-hansl-100"})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(r,{type:"button",variant:"outline",size:"sm",onClick:()=>i(String((new Date).getFullYear())),className:"h-8 px-4 text-sm border-gray-200 hover:bg-hansl-50 hover:border-hansl-300 hover:text-hansl-700 transition-colors",children:"올해"}),t.jsx(r,{type:"button",variant:"outline",size:"sm",onClick:()=>i(String((new Date).getFullYear()-1)),className:"h-8 px-4 text-sm border-gray-200 hover:bg-hansl-50 hover:border-hansl-300 hover:text-hansl-700 transition-colors",children:"작년"})]})]}),t.jsx("div",{className:"pt-2",children:t.jsx(r,{onClick:async()=>{const e=Number(n);if(!n||Number.isNaN(e)||e<2e3||e>2100)return void K.error("연도를 올바르게 입력해주세요. (예: 2025)");const s=`${e}-01-01`,a=`${e}-12-31`;o(!0);try{const{data:t,error:r}=await d.from("leave").select("*").lte("start_date",a).gte("end_date",s).order("start_date",{ascending:!0});if(r)throw r;const n=t||[];if(0===n.length)return void K.error("선택한 기간에 연차(승인) 기록이 없습니다.");const i=n.map(e=>{const s=Se(e);return s.ok?{id:e.id,user_email:e.user_email,start_date:e.start_date,end_date:e.end_date,unit:s.unit,type:e.type??null,status:e.status??null,reason:e.reason??null}:null}).filter(Boolean),c=n.map(e=>{const s=Se(e);return s.ok?null:{id:e.id,user_email:e.user_email,start_date:e.start_date,end_date:e.end_date,excludeReason:s.reason,type:e.type??null,status:e.status??null,reason:e.reason??null}}).filter(Boolean),{summaries:o,details:m}=function(e){const{leaves:s,startDate:a,endDate:t}=e,r=_e(a),l=_e(t),n=[],i=new Map;s.forEach(e=>{const s=Se(e);if(!s.ok)return;const a=_e(e.start_date),t=_e(e.end_date),c=a>r?a:r,o=t<l?t:l;if(c>o)return;const d=new Date(c);for(;d<=o;d.setDate(d.getDate()+1)){const a=d.getDay(),t=ke(d);let r=1;if(e.start_date===e.end_date)r=s.unit;else{const s=(e.start_period??"").toString().toLowerCase(),a=(e.end_period??"").toString().toLowerCase();t===e.start_date&&s&&"full"!==s&&(r=.5),t===e.end_date&&a&&"full"!==a&&(r=.5)}n.push({user_email:e.user_email,date:t,dayOfWeek:Ne[a],unit:r,leave_id:e.id,leave_start_date:e.start_date,leave_end_date:e.end_date,reason:e.reason??null}),i.set(e.user_email,(i.get(e.user_email)??0)+r)}});const c=Array.from(i.entries()).map(([e,s])=>({user_email:e,used_days:s})).sort((e,s)=>s.used_days-e.used_days);return n.sort((e,s)=>e.user_email!==s.user_email?e.user_email.localeCompare(s.user_email):e.date.localeCompare(s.date)),{summaries:c,details:n}}({leaves:n,startDate:s,endDate:a});if(0===o.length||0===m.length)return void K.error("선택한 연도에 승인된 연차/반차(근무일 기준) 기록이 없습니다.");const h=await xe.getEmployees({is_active:void 0});if(!h.success||!h.data)throw new Error(h.error||"직원 목록을 불러오지 못했습니다.");const x=h.data,u=new Map;x.forEach(e=>{e.email&&u.set(e.email,e)});const p=new Set(o.map(e=>e.user_email)),j=[],g=new Map;x.forEach(e=>{e.email&&p.has(e.email)&&e.id&&(g.set(e.email,e.id),j.push(e.id))});const y=new Map;m.forEach(e=>{const[s,a,t]=e.date.split("-");if(!s||!a||!t)return;const r=Number(a),l=Number(t);if(Number.isNaN(r)||Number.isNaN(l))return;y.has(e.user_email)||y.set(e.user_email,new Map);const n=y.get(e.user_email);n.has(r)||n.set(r,[]),n.get(r).push({day:l,unit:e.unit})});const f=(e,s)=>{const a=y.get(e),t=a?.get(s)||[];return t.sort((e,s)=>e.day-s.day),t.map(e=>`${e.day}(${1===e.unit?"1":"0.5"})`).join(",")},w=o.map(s=>{const a=u.get(s.user_email),t={};for(let e=1;e<=12;e++)t[e]=f(s.user_email,e);const r=((e,s)=>{if(!e)return 0;const a=new Date(e);if(Number.isNaN(a.getTime()))return 0;const t=a.getFullYear(),r=a.getMonth()+1,l=s-t;if(0===l){const e=13-r;return Math.floor(15*e/12)}return 1===l||2===l?15:l>=3?Math.min(25,15+Math.floor((l-1)/2)):0})(a?.join_date,e);return{employeeId:a?.employeeID||a?.employee_number||"",name:a?.name||"",grantedDays:r,usedDays:s.used_days,months:t}}),b=await async function(e){const{summaries:s,debug:a}=e,t=new he.Workbook,r=t.addWorksheet("연차사용현황");if(r.columns=[{header:"사번",key:"employeeId",width:14},{header:"이름",key:"name",width:12},{header:"지급연차",key:"grantedDays",width:10},{header:"사용일수",key:"usedDays",width:10},{header:"1월",key:"m1",width:22},{header:"2월",key:"m2",width:22},{header:"3월",key:"m3",width:22},{header:"4월",key:"m4",width:22},{header:"5월",key:"m5",width:22},{header:"6월",key:"m6",width:22},{header:"7월",key:"m7",width:22},{header:"8월",key:"m8",width:22},{header:"9월",key:"m9",width:22},{header:"10월",key:"m10",width:24},{header:"11월",key:"m11",width:24},{header:"12월",key:"m12",width:24}],r.getRow(1).font={name:"맑은 고딕",bold:!0},r.getRow(1).alignment={vertical:"middle",horizontal:"center"},[...s].sort((e,s)=>{const a=(e.name??"").toString(),t=(s.name??"").toString(),r=a.localeCompare(t);return 0!==r?r:(e.employeeId??"").toString().localeCompare((s.employeeId??"").toString())}).forEach(e=>{r.addRow({employeeId:e.employeeId??"",name:e.name??"",grantedDays:e.grantedDays??"",usedDays:e.usedDays,m1:e.months[1]??"",m2:e.months[2]??"",m3:e.months[3]??"",m4:e.months[4]??"",m5:e.months[5]??"",m6:e.months[6]??"",m7:e.months[7]??"",m8:e.months[8]??"",m9:e.months[9]??"",m10:e.months[10]??"",m11:e.months[11]??"",m12:e.months[12]??""})}),a){const e=t.addWorksheet(`검증_포함_${a.year}`);e.columns=[{header:"leave_id",key:"id",width:10},{header:"user_email",key:"user_email",width:26},{header:"start_date",key:"start_date",width:12},{header:"end_date",key:"end_date",width:12},{header:"unit",key:"unit",width:6},{header:"type",key:"type",width:18},{header:"status",key:"status",width:12},{header:"reason",key:"reason",width:30}],e.getRow(1).font={name:"맑은 고딕",bold:!0},e.getRow(1).alignment={vertical:"middle",horizontal:"center"},a.includedLeaves.forEach(s=>e.addRow(s));const s=t.addWorksheet(`검증_제외_${a.year}`);s.columns=[{header:"leave_id",key:"id",width:10},{header:"user_email",key:"user_email",width:26},{header:"start_date",key:"start_date",width:12},{header:"end_date",key:"end_date",width:12},{header:"excludeReason",key:"excludeReason",width:16},{header:"type",key:"type",width:18},{header:"status",key:"status",width:12},{header:"reason",key:"reason",width:30}],s.getRow(1).font={name:"맑은 고딕",bold:!0},s.getRow(1).alignment={vertical:"middle",horizontal:"center"},a.excludedLeaves.forEach(e=>s.addRow(e))}const l=await t.xlsx.writeBuffer();return new Blob([l],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"})}({summaries:w,debug:{year:e,includedLeaves:i,excludedLeaves:c}}),v=window.URL.createObjectURL(b),N=document.createElement("a");N.href=v,N.download=`연차_사용현황_${e}.xlsx`,document.body.appendChild(N),N.click(),document.body.removeChild(N),window.URL.revokeObjectURL(v),K.success("연차사용현황 엑셀이 다운로드되었습니다."),l()}catch(t){const e=t?.message||("string"==typeof t?t:"")||"다운로드 중 오류가 발생했습니다.";K.error(e)}finally{o(!1)}},disabled:c,className:"w-full h-11 bg-hansl-600 hover:bg-hansl-700 text-white font-semibold shadow-sm",children:c?"다운로드 중...":t.jsxs(t.Fragment,{children:[t.jsx(N,{className:"w-4 h-4 mr-2"}),"엑셀 다운로드"]})})})]})]})})}function Ee(){const{currentUserRoles:e}=c(),s=e.includes("app_admin")||e.includes("hr"),[r,l]=a.useState([]),[n,i]=a.useState([]),[d,m]=a.useState(!0),[h,x]=a.useState({}),[u,p]=a.useState(!1),[j,g]=a.useState(null),[y,f]=a.useState("create"),[w,b]=a.useState(!1),[v,N]=a.useState(!1),_=async()=>{m(!0);try{const e=await xe.getEmployees(h);e.success&&e.data?(l(e.data),i(e.data)):K.error(e.error||"직원 목록을 불러오는데 실패했습니다.")}catch(e){K.error("직원 목록을 불러오는 중 오류가 발생했습니다.")}finally{m(!1)}};a.useEffect(()=>{_()},[]),a.useEffect(()=>{_()},[h]);return d&&0===r.length?t.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"}),t.jsx("p",{className:"mt-2 card-subtitle",children:"직원 목록을 불러오는 중..."})]})}):t.jsx(t.Fragment,{children:t.jsxs("div",{className:"space-y-6",children:[t.jsx(pe,{filters:h,onFiltersChange:x,onExport:async()=>{if(s)try{const e=await xe.getEmployeesForExport();if(e.success&&e.data){const s=await o(()=>import("./xlsx-ByDo_lG2.js"),[]),a=s.utils.json_to_sheet(e.data),t=s.utils.book_new();s.utils.book_append_sheet(t,a,"직원 목록");const r=`직원_목록_${(new Date).toISOString().slice(0,10)}.xlsx`;s.writeFile(t,r),K.success("Excel 파일이 다운로드되었습니다.")}else K.error(e.error||"Excel 내보내기에 실패했습니다.")}catch(e){K.error("Excel 내보내기 중 오류가 발생했습니다.")}else K.error("Excel 내보내기 권한이 없습니다.")},onCreateNew:()=>{s?(g(null),f("create"),p(!0)):K.error("직원 등록 권한이 없습니다.")},onAttendanceDownload:()=>{s?b(!0):K.error("출근현황표 다운로드 권한이 없습니다.")},onAnnualLeaveUsageDownload:()=>{s?N(!0):K.error("연차사용현황 다운로드 권한이 없습니다.")},canManageEmployees:s}),t.jsxs("div",{className:"bg-white rounded-lg border",children:[t.jsx("div",{className:"p-4 border-b",children:t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("h3",{className:"modal-title",children:"직원 목록"}),t.jsx("div",{className:"card-description",children:d?"로딩 중...":`총 ${n.length}명의 직원`})]})}),t.jsx(je,{employees:n,onEdit:e=>{s?(g(e),f("edit"),p(!0)):K.error("직원 수정 권한이 없습니다.")},onView:e=>{s?(g(e),f("view"),p(!0)):K.error("직원 상세 조회 권한이 없습니다.")},onRefresh:_,currentUserRoles:e})]}),t.jsx(ye,{isOpen:u,onClose:()=>{p(!1),g(null)},employee:j,onSave:()=>{_()},mode:y}),t.jsx(ve,{employees:r,isOpen:w,onClose:()=>b(!1)}),t.jsx(De,{isOpen:v,onClose:()=>N(!1)})]})})}export{Ee as default};
//# sourceMappingURL=EmployeeMain-DnUICHfm.js.map
