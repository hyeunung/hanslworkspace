import{c as e,a as s,l as a,r as t,j as r,w as i,B as n,X as c,V as l,g as d,f as o}from"./index-BBqlRFcp.js";import{C as u,a as m,b as h,c as x,S as p,T as g}from"./card-BnaOJBOj.js";import{I as y,D as b,a as f,b as j,c as _}from"./dialog-CUL_r7q0.js";import{T as v}from"./textarea-DxEeqYlW.js";import{S as N,a as w,b as q,c as S,d as k,C}from"./select-ClJeBd6X.js";import{t as I}from"./index-BwPoDD6m.js";import{A as $,a as M,b as D,c as P,d as E,e as z,f as R,g as T}from"./alert-dialog-DNMoSUJ2.js";import{d as F,k as O,f as L,C as A,e as U,g as H,P as K}from"./PurchaseDetailModal-DFSq3uwl.js";import{P as W,a as Y,b as B}from"./popover-Dtg6OeLr.js";import{C as V}from"./calendar-5LoKqPi-.js";import{C as G}from"./chevron-down-CJqBJprP.js";import{C as J}from"./chevron-right-C4qk5A-c.js";import{E as Q}from"./eye-MxCi1oSo.js";import{S as X}from"./save-uKwyxrbO.js";import"./check-DrHAfXhs.js";import"./helpers-CsHcdtkA.js";import"./react-select.esm-Dql5RJUW.js";import"./credit-card-D1QBxTV5.js";import"./loader-circle-yVa5C846.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Z=e("send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]);const ee=new class{constructor(){this.supabase=s()}async createInquiry(e){try{const{data:{user:s},error:t}=await this.supabase.auth.getUser();if(t||!s)return{success:!1,error:"로그인이 필요합니다."};const{data:r}=await this.supabase.from("employees").select("id, name, email").eq("email",s.email).maybeSingle(),{error:i}=await this.supabase.from("support_inquires").insert({user_id:s.id,user_email:r?.email||s.email,user_name:r?.name||"",requester_id:r?.id,inquiry_type:e.inquiry_type,subject:e.subject,message:e.message,purchase_request_id:e.purchase_request_id??null,purchase_info:e.purchase_info,purchase_order_number:e.purchase_order_number,status:"open"});return i?(a.error("문의 등록 에러",i,{code:i.code,details:i.details,hint:i.hint}),{success:!1,error:i.message}):{success:!0}}catch(s){return{success:!1,error:s instanceof Error?s.message:"문의 접수 실패"}}}async getMyInquiries(){try{const{data:{user:e},error:s}=await this.supabase.auth.getUser();if(s||!e)return{success:!1,data:[],error:"로그인이 필요합니다."};const{data:a,error:t}=await this.supabase.from("support_inquires").select("*").eq("user_id",e.id).order("created_at",{ascending:!1});if(t)throw t;return{success:!0,data:a||[]}}catch(e){return{success:!1,data:[],error:e instanceof Error?e.message:"문의 조회 실패"}}}async getAllInquiries(){try{const{data:e,error:s}=await this.supabase.from("support_inquires").select("*").order("created_at",{ascending:!1});if(s)throw s;return{success:!0,data:e||[]}}catch(e){return{success:!1,data:[],error:e instanceof Error?e.message:"문의 조회 실패"}}}async updateInquiryStatus(e,s,a){try{const{data:{user:t},error:r}=await this.supabase.auth.getUser();if(r||!t)return{success:!1,error:"로그인이 필요합니다."};const{data:i}=await this.supabase.from("employees").select("name").eq("email",t.email).single(),n={status:s,handled_by:i?.name||t.email,updated_at:(new Date).toISOString()};"resolved"!==s&&"closed"!==s||(n.processed_at=(new Date).toISOString()),a&&(n.resolution_note=a);const{error:c}=await this.supabase.from("support_inquires").update(n).eq("id",e);if(c)throw c;return{success:!0}}catch(t){return{success:!1,error:t instanceof Error?t.message:"상태 업데이트 실패"}}}async getMyPurchaseRequests(e,s){try{const{data:{user:a},error:t}=await this.supabase.auth.getUser();if(t||!a)return{success:!1,data:[],error:"로그인이 필요합니다."};const{data:r}=await this.supabase.from("employees").select("name").eq("email",a.email).single();if(!r)return{success:!1,data:[],error:"사용자 정보를 찾을 수 없습니다."};let i=this.supabase.from("purchase_requests").select("id,purchase_order_number,vendor_name,request_date,created_at,requester_name,middle_manager_status,final_manager_status,purchase_request_items(item_name,specification,quantity)").eq("requester_name",r.name).order("created_at",{ascending:!1});e&&(i=i.gte("created_at",`${e}T00:00:00`)),s&&(i=i.lte("created_at",`${s}T23:59:59.999`));const{data:n,error:c}=await i.limit(100);if(c)throw c;return{success:!0,data:n||[]}}catch(a){return{success:!1,data:[],error:a instanceof Error?a.message:"발주요청 조회 실패"}}}subscribeToInquiries(e){return this.supabase.channel("support_inquires_changes").on("postgres_changes",{event:"*",schema:"public",table:"support_inquires"},e).subscribe()}async updatePurchaseRequestItem(e,s){try{const a={};void 0!==s.item_name&&(a.item_name=s.item_name),void 0!==s.specification&&(a.specification=s.specification),void 0!==s.quantity&&(a.quantity=s.quantity),void 0!==s.remark&&(a.remark=s.remark),void 0!==s.unit_price_value&&(a.unit_price_value=s.unit_price_value,a.unit_price_currency="KRW"),void 0!==s.amount_value&&(a.amount_value=s.amount_value,a.amount_currency="KRW");const{error:t}=await this.supabase.from("purchase_request_items").update(a).eq("id",e);if(t)throw t;return{success:!0}}catch(a){return{success:!1,error:a instanceof Error?a.message:"품목 수정 실패"}}}async deletePurchaseRequestItem(e){try{const{error:s}=await this.supabase.from("purchase_request_items").delete().eq("id",e);if(s)throw s;return{success:!0}}catch(s){return{success:!1,error:s instanceof Error?s.message:"품목 삭제 실패"}}}async deletePurchaseRequest(e){try{const{data:s,error:a}=await this.supabase.from("purchase_request_items").delete().eq("purchase_request_id",e).select();if(a)throw a;const{data:t,error:r}=await this.supabase.from("purchase_requests").delete().eq("id",e).select();if(r)throw r;return{success:!0}}catch(s){return{success:!1,error:s instanceof Error?s.message:"발주요청 삭제 실패"}}}async getPurchaseRequestDetail(e){try{const{data:s,error:a}=await this.supabase.from("purchase_requests").select("*,purchase_request_items(id,line_number,item_name,specification,quantity,unit_price_value,amount_value,remark,link)").eq("id",e).single();if(a)throw a;return{success:!0,data:s}}catch(s){return{success:!1,error:s instanceof Error?s.message:"발주요청 조회 실패"}}}async deleteInquiry(e){try{const{data:{user:s},error:a}=await this.supabase.auth.getUser();if(a||!s)return{success:!1,error:"로그인이 필요합니다."};const{data:t}=await this.supabase.from("employees").select("purchase_role").eq("email",s.email).single(),r=t?.purchase_role?.includes("app_admin");if(!r){const{data:a,error:t}=await this.supabase.from("support_inquires").select("user_id, status, resolution_note").eq("id",e).single();if(t||!a)return{success:!1,error:"문의를 찾을 수 없습니다."};if(a.user_id!==s.id)return{success:!1,error:"본인의 문의만 삭제할 수 있습니다."};if(a.resolution_note)return{success:!1,error:"답변이 완료된 문의는 삭제할 수 없습니다."};if("open"!==a.status)return{success:!1,error:"처리가 진행된 문의는 삭제할 수 없습니다."}}const{error:i}=await this.supabase.from("support_inquires").delete().eq("id",e);if(i)throw i;return{success:!0}}catch(s){return{success:!1,error:s instanceof Error?s.message:"문의 삭제 실패"}}}};function se({className:e,date:s,onDateChange:a,placeholder:l="기간을 선택하세요",disabled:d=!1,...o}){const[u,m]=t.useState(!1),h=e=>{if(!e?.from)return l;const s=e=>e.toLocaleDateString("ko-KR",{year:"numeric",month:"long",day:"numeric"});if(e.from&&e.to){if(e.from.getFullYear()===e.to.getFullYear()&&e.from.getMonth()===e.to.getMonth()){return`${e.from.getFullYear()}년 ${e.from.toLocaleDateString("ko-KR",{month:"long"})} ${e.from.getDate()}일 - ${e.to.getDate()}일`}return`${s(e.from)} - ${s(e.to)}`}return s(e.from)};return r.jsx("div",{className:i("grid gap-2",e),...o,children:r.jsxs(W,{open:u,onOpenChange:m,children:[r.jsx(Y,{asChild:!0,children:r.jsxs(n,{id:"date",variant:"outline",className:i("w-full justify-start text-left font-normal h-9 text-sm border-gray-200 hover:border-gray-300 hover:bg-gray-50 transition-colors",!s&&"text-gray-500",s&&"text-gray-900"),disabled:d,children:[r.jsx(V,{className:"mr-2 h-4 w-4 text-gray-400"}),r.jsx("span",{className:"truncate",children:h(s)}),s&&r.jsx(c,{className:"ml-auto h-4 w-4 text-gray-400 hover:text-gray-600 transition-colors",onClick:e=>{e.stopPropagation(),a?.(void 0),m(!1)}})]})}),r.jsx(B,{className:"w-auto p-0 shadow-lg border border-gray-200",align:"start",children:r.jsxs("div",{className:"bg-white rounded-lg overflow-hidden",children:[r.jsxs("div",{className:"bg-gray-50 border-b border-gray-100 px-4 py-3",children:[r.jsx("h4",{className:"text-sm font-medium text-gray-900",children:"기간 선택"}),r.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"시작일과 종료일을 선택하세요"})]}),r.jsx("div",{className:"p-4",children:r.jsx(F,{initialFocus:!0,mode:"range",defaultMonth:s?.from,selected:s,onSelect:e=>{a?.(e),e?.from&&e?.to&&m(!1)},numberOfMonths:2,disabled:d,locale:O,className:"rounded-md",classNames:{months:"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",month:"space-y-4",caption:"flex justify-center pt-1 relative items-center text-sm font-medium",caption_label:"text-sm font-medium text-gray-900",nav:"space-x-1 flex items-center",nav_button:"inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none border border-input bg-background hover:bg-accent hover:text-accent-foreground h-7 w-7",nav_button_previous:"absolute left-1",nav_button_next:"absolute right-1",table:"w-full border-collapse space-y-1",head_row:"flex",head_cell:"text-gray-500 rounded-md w-9 font-normal text-[0.8rem]",row:"flex w-full mt-2",cell:"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20",day:"inline-flex items-center justify-center rounded-md text-sm font-normal ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 aria-selected:opacity-100 h-9 w-9 hover:bg-gray-100 hover:text-gray-900 text-gray-900",day_range_start:"day-range-start bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",day_range_end:"day-range-end bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",day_selected:"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",day_today:"bg-accent text-accent-foreground font-semibold",outside:"!text-gray-400 !opacity-40 hover:!text-gray-500 hover:bg-gray-50 aria-selected:bg-accent/50 aria-selected:text-muted-foreground aria-selected:opacity-30",day_disabled:"!text-gray-400 !opacity-40",day_range_middle:"aria-selected:bg-accent aria-selected:text-accent-foreground",day_hidden:"invisible"}})}),s&&r.jsx("div",{className:"bg-gray-50 border-t border-gray-100 px-4 py-3",children:r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("span",{className:"text-xs text-gray-600",children:["선택된 기간: ",h(s)]}),r.jsx(n,{variant:"ghost",size:"sm",onClick:()=>{a?.(void 0),m(!1)},className:"h-6 px-2 text-xs",children:"지우기"})]})})]})})]})})}function ae(){const[e,a]=t.useState(""),[i,c]=t.useState(""),[F,O]=t.useState(""),[W,Y]=t.useState(!1),[B,V]=t.useState(!1),[ae,te]=t.useState(),[re,ie]=t.useState([]),[ne,ce]=t.useState(null),[le,de]=t.useState(!1),[oe,ue]=t.useState(1),[me,he]=t.useState(null),[xe,pe]=t.useState([]),[ge,ye]=t.useState(null),[be,fe]=t.useState(""),[je,_e]=t.useState(""),[ve,Ne]=t.useState([]),[we,qe]=t.useState(!0),[Se,ke]=t.useState(null),[Ce,Ie]=t.useState(!1),[$e,Me]=t.useState(null),[De,Pe]=t.useState(!1),[Ee,ze]=t.useState(null),[Re,Te]=t.useState(null),[Fe,Oe]=t.useState(!1),[Le,Ae]=t.useState(null),[Ue,He]=t.useState(!1),[Ke,We]=t.useState(null),[Ye,Be]=t.useState(!1),[Ve,Ge]=t.useState("발주내역이 삭제 되었거나 없습니다.");t.useEffect(()=>{(async()=>{await Je()})();const e=ee.subscribeToInquiries(e=>{if(null===ge)return;const s=e?.eventType,a=e?.new,t=e?.old;if("DELETE"===s){const e=t?.id;if(!e)return;return pe(s=>s.filter(s=>s.id!==e)),void(Se===e&&ke(null))}const r=a;r?.id&&pe(e=>{const s=!!(a=r)&&(!!ge||!!je&&a.user_id===je);var a;const t=e.findIndex(e=>e.id===r.id);if(!s){if(-1===t)return e;return e.filter(e=>e.id!==r.id)}const i=[...e];return t>=0?i[t]=r:i.unshift(r),i.sort((e,s)=>{const a=e.created_at?new Date(e.created_at).getTime():0;return(s.created_at?new Date(s.created_at).getTime():0)-a}),i})});return()=>{e.unsubscribe()}},[ge,je,Se]);const Je=async()=>{const e=s(),{data:{user:a}}=await e.auth.getUser();if(!a)return;fe(a.email||""),_e(a.id);const{data:t}=await e.from("employees").select("purchase_role").eq("email",a.email).single();if(t){const e=Array.isArray(t.purchase_role)?t.purchase_role:t.purchase_role?.split(",").map(e=>e.trim())||[];Ne(e);const s=e.includes("app_admin");ye(s),Qe(s)}},Qe=async e=>{qe(!0);const s=e?await ee.getAllInquiries():await ee.getMyInquiries();s.success&&pe(s.data),qe(!1)},Xe=async()=>{if(null===ge)return;qe(!0);const e=ge?await ee.getAllInquiries():await ee.getMyInquiries();e.success&&pe(e.data),qe(!1)};t.useEffect(()=>{"modify"===e||"delete"===e?V(!0):(V(!1),ce(null))},[e]);const Ze=Math.ceil(re.length/5),es=5*(oe-1),ss=es+5,as=re.slice(es,ss),ts=async(e,s,a)=>{if("resolved"===s){const a=prompt("처리 완료 답변을 입력해주세요:");if(!a||""===a.trim())return void I.error("답변 내용을 입력해야 완료 처리할 수 있습니다.");const t=await ee.updateInquiryStatus(e,s,a.trim());t.success?(I.success("문의가 완료 처리되었습니다."),Xe()):I.error(t.error||"완료 처리 실패")}else{const a=await ee.updateInquiryStatus(e,s);a.success?(I.success("상태가 업데이트되었습니다."),Xe()):I.error(a.error||"상태 업데이트 실패")}},rs=async e=>{try{if(e.purchase_request_id)return Ae(e.purchase_request_id),void Oe(!0);const a=e.purchase_order_number?.trim();if(!a)return Ge("발주내역이 삭제 되었거나 없습니다."),void Be(!0);const t=s(),{data:r,error:i}=await t.from("purchase_requests").select("id").eq("purchase_order_number",a).limit(1).maybeSingle();if(i)throw i;if(!r?.id)return Ge("발주내역이 삭제 되었거나 없습니다."),void Be(!0);Ae(r.id),Oe(!0)}catch(a){Ge("발주내역이 삭제 되었거나 없습니다."),Be(!0)}},is=()=>{ze(null),Te(null)},ns=e=>{switch(e){case"open":return r.jsx("span",{className:"badge-stats bg-yellow-100 text-yellow-800",children:"대기"});case"in_progress":return r.jsx("span",{className:"badge-stats bg-blue-100 text-blue-800",children:"처리중"});case"resolved":return r.jsx("span",{className:"badge-stats bg-green-100 text-green-800",children:"완료"});case"closed":return r.jsx("span",{className:"badge-stats bg-gray-100 text-gray-800",children:"종료"});default:return r.jsx("span",{className:"badge-stats border border-gray-300 bg-white text-gray-600",children:"-"})}},cs=e=>{switch(e){case"bug":return"오류 신고";case"modify":return"수정 요청";case"delete":return"삭제 요청";case"other":return"기타 문의";default:return e}};return null===ge?r.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"}),r.jsx("p",{className:"text-gray-600",children:"권한 확인 중..."})]})}):r.jsxs("div",{className:"min-h-screen bg-gray-50",children:[r.jsxs("div",{className:"w-full",children:[r.jsxs("div",{className:"mb-4",children:[r.jsx("h1",{className:"page-title text-gray-900",children:"문의하기"}),r.jsx("p",{className:"page-subtitle text-gray-600 mt-1",children:ge?"모든 문의를 관리하고 답변할 수 있습니다":"시스템 사용 중 궁금하신 점이나 개선사항을 알려주세요"})]}),r.jsxs("div",{className:""+(ge?"max-w-4xl":"grid grid-cols-1 xl:grid-cols-2 gap-4"),children:[!ge&&r.jsxs(u,{children:[r.jsx(m,{children:r.jsxs(h,{className:"flex items-center gap-2",children:[r.jsx(l,{className:"w-5 h-5"}),"문의 내용"]})}),r.jsx(x,{children:r.jsxs("form",{onSubmit:async s=>{if(s.preventDefault(),!e||!i||!F)return void I.error("모든 필드를 입력해주세요.");if(("modify"===e||"delete"===e)&&!ne)return void I.error("수정/삭제할 발주요청을 선택해주세요.");Y(!0);let t=F,r="";if(ne){const e=(ne.purchase_request_items||[]).map(e=>`- ${e.item_name} (${e.specification}) ${e.quantity}개`).join("\n"),s=ne.purchase_order_number||"(승인대기)";r=`발주번호: ${ne.purchase_order_number}\n업체: ${ne.vendor_name}\n요청자: ${ne.requester_name}\n요청일: ${ne.request_date}\n품목:\n${e}`,r=`발주번호: ${s}\n업체: ${ne.vendor_name}\n요청자: ${ne.requester_name}\n요청일: ${ne.request_date||ne.created_at||"-"}\n품목:\n${e}`,t=`${F}\n\n[관련 발주 정보]\n${r}`}const n=await ee.createInquiry({inquiry_type:e,subject:i,message:t,purchase_request_id:ne?.id,purchase_info:r,purchase_order_number:ne?.purchase_order_number});n.success?(I.success("문의가 접수되었습니다."),a(""),c(""),O(""),ce(null),ie([]),te(void 0),Xe()):I.error(n.error||"문의 접수에 실패했습니다."),Y(!1)},className:"space-y-4",children:[r.jsxs("div",{children:[r.jsxs("label",{className:"block modal-label text-gray-700 mb-1",children:["문의 유형 ",r.jsx("span",{className:"text-red-500",children:"*"})]}),r.jsxs(N,{value:e,onValueChange:a,children:[r.jsx(w,{children:r.jsx(q,{placeholder:"문의 유형을 선택해주세요"})}),r.jsxs(S,{children:[r.jsx(k,{value:"bug",children:"오류 신고"}),r.jsx(k,{value:"modify",children:"수정 요청"}),r.jsx(k,{value:"delete",children:"삭제 요청"}),r.jsx(k,{value:"other",children:"기타 문의"})]})]})]}),B&&r.jsxs("div",{className:"space-y-3 p-4 bg-blue-50 rounded-lg border border-blue-200",children:[r.jsx("div",{className:"modal-label text-blue-900",children:"수정/삭제할 발주요청 선택"}),r.jsxs("div",{children:[r.jsx("label",{className:"modal-label text-gray-600 mb-2 block",children:"기간 선택"}),r.jsx(se,{date:ae,onDateChange:te,placeholder:"발주요청 기간을 선택하세요",className:"w-full"})]}),r.jsx(n,{type:"button",onClick:async()=>{de(!0),ue(1);const e=ae?.from?ae.from.toISOString().split("T")[0]:void 0,s=ae?.to?ae.to.toISOString().split("T")[0]:void 0,a=await ee.getMyPurchaseRequests(e,s);a.success?ie(a.data):I.error(a.error||"발주요청 조회 실패"),de(!1)},disabled:le,className:"w-full h-9",variant:"outline",children:le?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"w-4 h-4 border-2 border-gray-600 border-t-transparent rounded-full animate-spin mr-2"}),"검색 중..."]}):r.jsxs(r.Fragment,{children:[r.jsx(p,{className:"w-4 h-4 mr-2"}),"발주요청 검색"]})}),re.length>0&&r.jsxs("div",{className:"space-y-3",children:[r.jsxs("div",{className:"modal-label text-gray-600",children:["발주요청 선택 (총 ",re.length,"건)"]}),r.jsx("div",{className:"space-y-1",children:as.map(e=>r.jsxs("div",{className:"border rounded overflow-hidden",children:[r.jsx("div",{onClick:()=>ce(e),className:"px-3 py-2 cursor-pointer transition-all badge-text "+(ne?.id===e.id?"border-blue-500 bg-blue-50":"hover:bg-gray-50"),children:r.jsxs("div",{className:"flex items-center justify-between gap-2",children:[r.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[r.jsx("span",{className:"modal-value whitespace-nowrap",children:e.purchase_order_number||"(승인대기)"}),e.final_manager_status&&"approved"!==e.final_manager_status&&r.jsx("span",{className:"badge-stats whitespace-nowrap "+("rejected"===e.final_manager_status||"rejected"===e.middle_manager_status?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"),children:"rejected"===e.final_manager_status||"rejected"===e.middle_manager_status?"반려":"승인대기"}),r.jsx("span",{className:"text-gray-600 truncate",children:e.vendor_name}),r.jsxs("span",{className:"text-gray-500",children:[e.purchase_request_items?.[0]?.item_name||"품목 없음",e.purchase_request_items?.length>1&&r.jsx("span",{className:"modal-value text-blue-600",children:` 외 ${e.purchase_request_items.length-1}건`})]}),r.jsx("span",{className:"text-gray-400 whitespace-nowrap ml-auto",children:(e.request_date||e.created_at)&&L(new Date(e.request_date||e.created_at),"MM/dd")})]}),r.jsxs("div",{className:"flex items-center gap-1",children:[ne?.id===e.id&&r.jsx(A,{className:"w-4 h-4 text-blue-500 flex-shrink-0"}),e.purchase_request_items?.length>1&&r.jsx("button",{type:"button",onClick:s=>{s.stopPropagation(),he(me===e.id?null:e.id)},className:"p-1 hover:bg-gray-200 rounded",children:me===e.id?r.jsx(C,{className:"w-4 h-4"}):r.jsx(G,{className:"w-4 h-4"})})]})]})}),me===e.id&&e.purchase_request_items?.length>0&&r.jsx("div",{className:"px-3 py-2 bg-gray-50 border-t badge-text",children:r.jsxs("div",{className:"space-y-1",children:[r.jsx("div",{className:"modal-value text-gray-700 mb-1",children:"품목 상세"}),e.purchase_request_items.map((e,s)=>r.jsxs("div",{className:"flex items-center gap-2 text-gray-600 pl-2",children:[r.jsxs("span",{className:"text-gray-400",children:[s+1,"."]}),r.jsx("span",{children:e.item_name}),e.specification&&r.jsxs("span",{className:"text-gray-500",children:["(",e.specification,")"]}),r.jsxs("span",{className:"text-gray-500",children:["- ",e.quantity,"개"]})]},s))]})})]},e.id))}),Ze>1&&r.jsxs("div",{className:"flex justify-center items-center gap-1 pt-2",children:[r.jsx(n,{type:"button",variant:"outline",size:"sm",onClick:()=>ue(Math.max(1,oe-1)),disabled:1===oe,className:"h-8 w-8 p-0",children:r.jsx(U,{className:"w-4 h-4"})}),Array.from({length:Ze},(e,s)=>s+1).map(e=>r.jsx(n,{type:"button",variant:oe===e?"default":"outline",size:"sm",onClick:()=>ue(e),className:"h-8 w-8 p-0",children:e},e)),r.jsx(n,{type:"button",variant:"outline",size:"sm",onClick:()=>ue(Math.min(Ze,oe+1)),disabled:oe===Ze,className:"h-8 w-8 p-0",children:r.jsx(J,{className:"w-4 h-4"})})]})]})]}),r.jsxs("div",{children:[r.jsxs("label",{className:"block modal-label text-gray-700 mb-1",children:["제목 ",r.jsx("span",{className:"text-red-500",children:"*"})]}),r.jsx(y,{value:i,onChange:e=>c(e.target.value),placeholder:"문의 제목을 입력해주세요",maxLength:100})]}),r.jsxs("div",{children:[r.jsxs("label",{className:"block modal-label text-gray-700 mb-1",children:["내용 ",r.jsx("span",{className:"text-red-500",children:"*"})]}),r.jsx(v,{value:F,onChange:e=>O(e.target.value),placeholder:"문의 내용을 자세히 입력해주세요",rows:6,maxLength:1e3}),r.jsxs("p",{className:"badge-text text-gray-500 mt-1",children:[F.length,"/1000"]})]}),r.jsx(n,{type:"submit",className:"w-full",disabled:W,children:W?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}),"전송 중..."]}):r.jsxs(r.Fragment,{children:[r.jsx(Z,{className:"w-4 h-4 mr-2"}),"문의 보내기"]})})]})})]}),r.jsxs(u,{children:[r.jsx(m,{children:r.jsxs(h,{className:"flex items-center justify-between",children:[r.jsxs("span",{className:"flex items-center gap-2",children:[r.jsx(d,{className:"w-5 h-5 text-orange-500"}),ge?"전체 문의 목록":"내 문의 내역"]}),r.jsxs("span",{className:"badge-stats border border-gray-300 bg-white text-gray-600",children:[xe.length,"건"]})]})}),r.jsx(x,{children:we?r.jsx("div",{className:"flex items-center justify-center py-8",children:r.jsx("div",{className:"w-6 h-6 border-2 border-gray-300 border-t-transparent rounded-full animate-spin"})}):0===xe.length?r.jsxs("div",{className:"text-center py-8 text-gray-500",children:[r.jsx(l,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),r.jsx("p",{className:"text-sm",children:"문의 내역이 없습니다"})]}):r.jsx("div",{className:"space-y-1 max-h-[600px] overflow-y-auto",children:xe.map(e=>r.jsxs("div",{className:"border rounded overflow-hidden",children:[r.jsx("div",{className:"px-3 py-2 hover:bg-gray-50 transition-colors cursor-pointer",onClick:()=>{ke(Se===e.id?null:e.id)},children:r.jsxs("div",{className:"flex items-center justify-between gap-2",children:[r.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[r.jsx("span",{className:"badge-stats border border-gray-300 bg-white text-gray-600 badge-text whitespace-nowrap",children:cs(e.inquiry_type)}),ns(e.status),r.jsx("span",{className:"modal-label truncate",children:e.subject}),ge&&r.jsx("span",{className:"badge-text text-gray-500",children:e.user_name||e.user_email}),e.purchase_order_number&&r.jsxs("button",{type:"button",className:"badge-text text-blue-600 hover:underline",onClick:s=>{s.stopPropagation(),rs(e)},title:"발주 상세 열기",children:["[",e.purchase_order_number,"]"]}),r.jsx("span",{className:"badge-text text-gray-400 ml-auto whitespace-nowrap",children:e.created_at&&L(new Date(e.created_at),"MM/dd HH:mm")})]}),r.jsxs("div",{className:"flex items-center gap-1",children:[ge&&"open"===e.status&&r.jsx(n,{size:"sm",variant:"outline",onClick:s=>{s.stopPropagation(),ts(e.id,"in_progress")},className:"h-6 badge-text px-2",children:"처리중"}),ge&&("open"===e.status||"in_progress"===e.status)&&r.jsx(n,{size:"sm",onClick:s=>{s.stopPropagation(),ts(e.id,"resolved")},className:"h-6 badge-text px-2 bg-green-600 hover:bg-green-700",children:"완료"}),(ge||"open"===e.status&&!e.resolution_note&&e.user_email===be)&&r.jsx(n,{size:"sm",variant:"ghost",onClick:s=>{s.stopPropagation(),(async e=>{if(!confirm("정말로 이 문의를 삭제하시겠습니까?\n삭제된 문의는 복구할 수 없습니다."))return;const s=await ee.deleteInquiry(e);s.success?(I.success("문의가 삭제되었습니다."),Xe()):I.error(s.error||"문의 삭제 실패")})(e.id)},className:"h-6 w-6 p-0 hover:bg-red-50",title:"문의 삭제",children:r.jsx(g,{className:"w-3 h-3 text-red-600"})}),r.jsx("button",{type:"button",className:"p-1 hover:bg-gray-200 rounded",children:Se===e.id?r.jsx(C,{className:"w-4 h-4"}):r.jsx(G,{className:"w-4 h-4"})})]})]})}),Se===e.id&&r.jsx("div",{className:"px-3 py-3 bg-gray-50 border-t text-sm",children:r.jsxs("div",{className:"space-y-2",children:[r.jsxs("div",{children:[r.jsx("span",{className:"modal-value text-gray-700",children:"내용:"}),r.jsx("p",{className:"text-gray-600 mt-1 whitespace-pre-wrap",children:e.message})]}),e.purchase_order_number&&r.jsxs("div",{children:[r.jsx("span",{className:"modal-value text-gray-700",children:"관련 발주번호:"}),r.jsx("button",{type:"button",className:"text-blue-600 ml-2 hover:underline",onClick:s=>{s.stopPropagation(),rs(e)},title:"발주 상세 열기",children:e.purchase_order_number})]}),e.handled_by&&r.jsxs("div",{children:[r.jsx("span",{className:"modal-value text-gray-700",children:"처리자:"}),r.jsxs("span",{className:"text-green-600 ml-2",children:[e.handled_by,e.processed_at&&` (${L(new Date(e.processed_at),"yyyy-MM-dd HH:mm")})`]})]}),e.resolution_note&&r.jsxs("div",{children:[r.jsx("span",{className:"modal-value text-gray-700",children:"처리 내용:"}),r.jsx("p",{className:"text-gray-600 mt-1",children:e.resolution_note})]})]})})]},e.id))})})]})]})]}),r.jsx(b,{open:Ce,onOpenChange:Ie,children:r.jsxs(f,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[r.jsx(j,{children:r.jsxs(_,{className:"flex items-center justify-between text-lg",children:[r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("span",{children:"발주요청 상세"}),$e?.purchase_order_number&&r.jsx("span",{className:"badge-stats border border-gray-300 bg-white text-gray-600 font-normal",children:$e.purchase_order_number})]}),ge&&$e&&r.jsxs(n,{variant:"destructive",size:"sm",onClick:async()=>{if(!$e?.id)return;if(!confirm("이 발주요청 전체를 삭제하시겠습니까?\n모든 품목이 함께 삭제됩니다."))return;const e=await ee.deletePurchaseRequest($e.id);if(e.success){o($e.id);I.success("발주요청이 삭제되었습니다."),Ie(!1),Me(null),Xe()}else I.error(e.error||"발주요청 삭제 실패")},className:"h-8 px-3",children:[r.jsx(g,{className:"w-4 h-4 mr-1"}),"전체 삭제"]})]})}),De?r.jsx("div",{className:"flex items-center justify-center py-8",children:r.jsx("div",{className:"w-6 h-6 border-2 border-gray-300 border-t-transparent rounded-full animate-spin"})}):$e&&r.jsxs("div",{className:"space-y-6",children:[r.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 p-4 bg-gray-50 rounded-lg",children:[r.jsxs("div",{children:[r.jsx("span",{className:"badge-text text-gray-500 uppercase tracking-wider",children:"발주번호"}),r.jsx("p",{className:"font-semibold text-sm mt-1",children:$e.purchase_order_number||"N/A"})]}),r.jsxs("div",{children:[r.jsx("span",{className:"badge-text text-gray-500 uppercase tracking-wider",children:"업체명"}),r.jsx("p",{className:"font-semibold text-sm mt-1",children:$e.vendor_name})]}),r.jsxs("div",{children:[r.jsx("span",{className:"badge-text text-gray-500 uppercase tracking-wider",children:"요청자"}),r.jsx("p",{className:"font-semibold text-sm mt-1",children:$e.requester_name})]}),r.jsxs("div",{children:[r.jsx("span",{className:"badge-text text-gray-500 uppercase tracking-wider",children:"요청일"}),r.jsx("p",{className:"font-semibold text-sm mt-1",children:$e.request_date&&L(new Date($e.request_date),"yyyy-MM-dd")})]})]}),r.jsxs("div",{children:[r.jsx("h3",{className:"font-semibold text-base mb-3",children:"품목 상세"}),r.jsx("div",{className:"border rounded-lg overflow-x-auto",children:r.jsxs("table",{className:"w-full",children:[r.jsx("thead",{className:"bg-gray-50 border-b",children:r.jsxs("tr",{children:[r.jsx("th",{className:"text-left badge-text modal-value text-gray-700 px-3 py-3 w-12",children:"번호"}),r.jsx("th",{className:"text-left badge-text modal-value text-gray-700 px-3 py-3 min-w-[180px]",children:"품명"}),r.jsx("th",{className:"text-left badge-text modal-value text-gray-700 px-3 py-3 min-w-[150px]",children:"규격"}),r.jsx("th",{className:"text-center badge-text modal-value text-gray-700 px-3 py-3 w-20",children:"수량"}),r.jsx("th",{className:"text-right badge-text modal-value text-gray-700 px-3 py-3 w-28",children:"단가"}),r.jsx("th",{className:"text-right badge-text modal-value text-gray-700 px-3 py-3 w-32",children:"금액"}),r.jsx("th",{className:"text-left badge-text modal-value text-gray-700 px-3 py-3 min-w-[150px]",children:"비고"}),r.jsx("th",{className:"text-center badge-text modal-value text-gray-700 px-3 py-3 w-16",children:"링크"}),ge&&r.jsx("th",{className:"text-center badge-text modal-value text-gray-700 px-3 py-3 w-24",children:"작업"})]})}),r.jsx("tbody",{className:"divide-y divide-gray-200",children:$e.purchase_request_items?.map((e,s)=>r.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[r.jsx("td",{className:"text-sm px-3 py-3 text-center modal-value text-gray-600",children:e.line_number||s+1}),r.jsx("td",{className:"text-sm px-3 py-3",children:Ee===e.id?r.jsx(y,{value:Re?.item_name||"",onChange:e=>Te({...Re,item_name:e.target.value}),className:"h-9 text-sm w-full",autoFocus:!0}):r.jsx("span",{className:"modal-value text-gray-900",children:e.item_name})}),r.jsx("td",{className:"text-sm px-3 py-3",children:Ee===e.id?r.jsx(y,{value:Re?.specification||"",onChange:e=>Te({...Re,specification:e.target.value}),className:"h-9 text-sm w-full"}):r.jsx("span",{className:"text-gray-600",children:e.specification||"-"})}),r.jsx("td",{className:"text-sm text-center px-3 py-3",children:Ee===e.id?r.jsx(y,{type:"number",value:Re?.quantity||"",onChange:e=>Te({...Re,quantity:parseInt(e.target.value)}),className:"h-9 text-sm text-center w-full"}):r.jsx("span",{className:"modal-value",children:e.quantity})}),r.jsx("td",{className:"text-sm text-right px-3 py-3",children:Ee===e.id?r.jsx(y,{type:"number",value:Re?.unit_price_value||"",onChange:e=>Te({...Re,unit_price_value:parseInt(e.target.value)}),className:"h-9 text-sm text-right w-full"}):r.jsx("span",{className:"modal-value",children:e.unit_price_value?`${parseFloat(e.unit_price_value).toLocaleString()}`:"-"})}),r.jsx("td",{className:"text-sm text-right px-3 py-3",children:Ee===e.id?r.jsx("span",{className:"font-semibold text-blue-600",children:((Re?.quantity||0)*(Re?.unit_price_value||0)).toLocaleString()}):r.jsx("span",{className:"font-semibold text-blue-600",children:e.amount_value?`${parseFloat(e.amount_value).toLocaleString()}`:"-"})}),r.jsx("td",{className:"text-sm px-3 py-3",children:Ee===e.id?r.jsx(v,{value:Re?.remark||"",onChange:e=>Te({...Re,remark:e.target.value}),className:"h-9 text-sm w-full resize-none",rows:1}):r.jsx("span",{className:"text-gray-600 badge-text",children:e.remark||"-"})}),r.jsx("td",{className:"text-sm text-center px-3 py-3",children:e.link?r.jsx("a",{href:e.link,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center justify-center w-8 h-8 rounded hover:bg-blue-50 text-blue-600",children:r.jsx(Q,{className:"w-4 h-4"})}):r.jsx("span",{className:"text-gray-400",children:"-"})}),ge&&r.jsx("td",{className:"text-sm text-center px-3 py-3",children:Ee===e.id?r.jsxs("div",{className:"flex justify-center gap-1",children:[r.jsxs(n,{size:"sm",onClick:()=>(async e=>{if(!Re)return;const s=(Re.quantity||0)*(Re.unit_price_value||0),a=await ee.updatePurchaseRequestItem(e,{item_name:Re.item_name,specification:Re.specification,quantity:Re.quantity,unit_price_value:Re.unit_price_value,amount_value:s,remark:Re.remark});a.success?(I.success("품목이 수정되었습니다."),is()):I.error(a.error||"품목 수정 실패")})(e.id),className:"h-8 px-2 bg-green-600 hover:bg-green-700",children:[r.jsx(X,{className:"w-4 h-4 mr-1"}),"저장"]}),r.jsx(n,{size:"sm",variant:"outline",onClick:is,className:"h-8 px-2",children:"취소"})]}):r.jsxs("div",{className:"flex justify-center gap-1",children:[r.jsx(n,{size:"sm",variant:"ghost",onClick:()=>(e=>{ze(e.id),Te({item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,remark:e.remark})})(e),className:"h-8 w-8 p-0 hover:bg-blue-50",children:r.jsx(H,{className:"w-4 h-4 text-blue-600"})}),r.jsx(n,{size:"sm",variant:"ghost",onClick:()=>(async e=>{if(!confirm("이 품목을 삭제하시겠습니까?"))return;const s=await ee.deletePurchaseRequestItem(e);s.success?I.success("품목이 삭제되었습니다."):I.error(s.error||"품목 삭제 실패")})(e.id),className:"h-8 w-8 p-0 hover:bg-red-50",children:r.jsx(g,{className:"w-4 h-4 text-red-600"})})]})})]},e.id))}),r.jsx("tfoot",{className:"bg-gray-50 border-t-2",children:r.jsxs("tr",{children:[r.jsx("td",{colSpan:5,className:"text-sm font-semibold text-right px-3 py-3",children:"합계"}),r.jsx("td",{className:"text-sm font-bold text-right px-3 py-3 text-blue-600",children:$e.purchase_request_items?.reduce((e,s)=>e+(parseFloat(s.amount_value)||0),0).toLocaleString()}),r.jsx("td",{colSpan:ge?3:2,className:"px-3 py-3"})]})})]})})]}),$e.notes&&r.jsxs("div",{children:[r.jsx("h3",{className:"modal-value mb-2",children:"비고"}),r.jsx("p",{className:"page-subtitle text-gray-600 p-3 bg-gray-50 rounded-lg",children:$e.notes})]})]})]})}),r.jsx(K,{purchaseId:Le,isOpen:Fe,onClose:()=>{Oe(!1),Ae(null)},currentUserRoles:ve,activeTab:"done",onDelete:e=>{We(e),He(!0)}}),r.jsx($,{open:Ue,onOpenChange:e=>{He(e),e||We(null)},children:r.jsxs(M,{children:[r.jsxs(D,{children:[r.jsx(P,{children:"발주요청 내역 삭제"}),r.jsxs(E,{children:["발주요청번호 ",r.jsx("strong",{children:Ke?.purchase_order_number||"알 수 없음"}),"를 삭제하시겠습니까?",r.jsx("br",{}),"이 작업은 되돌릴 수 없습니다."]})]}),r.jsxs(z,{children:[r.jsx(R,{children:"취소"}),r.jsx(T,{onClick:async()=>{if(!Ke?.id)return void I.error("삭제할 발주 정보가 없습니다.");const e=s();try{const s="string"==typeof Ke.id?parseInt(Ke.id,10):Ke.id;if(!s||Number.isNaN(s))return void I.error("발주 ID가 올바르지 않습니다.");const{error:a}=await e.from("support_inquires").update({purchase_request_id:null}).eq("purchase_request_id",s);if(a)throw a;const{error:t}=await e.from("purchase_request_items").delete().eq("purchase_request_id",s);if(t)throw t;const{error:r}=await e.from("purchase_requests").delete().eq("id",s);if(r)throw r;o(s),I.success("발주요청이 삭제되었습니다. (문의 기록은 보존됩니다)"),He(!1),We(null),Oe(!1),Ae(null),Xe()}catch(a){I.error(a instanceof Error?a.message:"삭제 중 오류가 발생했습니다.")}finally{He(!1),We(null)}},className:"bg-red-600 hover:bg-red-700",children:"삭제"})]})]})}),r.jsx(b,{open:Ye,onOpenChange:Be,children:r.jsx(f,{showCloseButton:!1,maxWidth:"sm:max-w-md",className:"p-0 overflow-hidden",children:r.jsxs("div",{className:"px-8 py-10 text-center",children:[r.jsx("div",{className:"text-xl font-semibold text-gray-900",children:"안내"}),r.jsx("div",{className:"mt-4 text-base text-gray-700 whitespace-pre-wrap",children:Ve}),r.jsx("div",{className:"mt-6 text-sm text-gray-400",children:"화면을 클릭하거나 ESC로 닫을 수 있습니다."})]})})})]})}export{ae as default};
//# sourceMappingURL=SupportMain-D5FWoKVe.js.map
