import{c as e,a,l as s,r as t,u as r,b as n,j as i,B as l,S as d,d as c}from"./index-dj2fB8jQ.js";import{C as o,a as u,b as m,c as p,S as h}from"./card-DqKnFVRo.js";import{I as g}from"./dialog-CXF5pNfn.js";import{T as _,P as x,d as y}from"./PurchaseDetailModal-bnqQEnmm.js";import{t as b}from"./index-Cv_AwcOq.js";import{P as f}from"./react-select.esm-CMpEMIZm.js";import{D as v}from"./download-DYbbmAqe.js";import{C as w}from"./calendar-D2xkSi_-.js";import"./helpers-CsHcdtkA.js";import"./popover-BaXqhLsR.js";import"./calendar-DFHgBaiR.js";import"./chevron-down-h4T4Rdu_.js";import"./credit-card-CRCLW1nq.js";import"./plus-D0n321ES.js";import"./save-DIzQb8uO.js";import"./chevron-right-nXNuOPig.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const j=e("clock",[["path",{d:"M12 6v6l4 2",key:"mmk7yg"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]),N={data:null,lastFetch:0,CACHE_DURATION:3e4,employeeId:null};const q=new class{constructor(){this.supabase=a()}parseRoles(e){let a=[];if(e)if(Array.isArray(e))a=e.map(e=>String(e).trim());else{a=String(e).split(",").map(e=>e.trim()).filter(e=>e.length>0)}return a}async getDashboardData(e,a=!1){const t=Date.now();if(!a&&N.data&&N.employeeId===e.id&&t-N.lastFetch<N.CACHE_DURATION&&N.data)return N.data;const r=await Promise.allSettled([this.getDashboardStats(e),this.getMyRecentRequests(e),this.getPendingApprovals(e),this.getQuickActions(e),this.getTodaySummary(e),this.getMyPurchaseStatus(e)]),n=r[0],i=r[1],l=r[2],d=r[3],c=r[4],o=r[5],u="fulfilled"===n.status?n.value:{total:0,myRequests:0,pending:0,completed:0,urgent:0,todayActions:0},m="fulfilled"===i.status?i.value:[],p="fulfilled"===l.status?l.value:[],h="fulfilled"===d.status?d.value:[],g="fulfilled"===c.status?c.value:{approved:0,requested:0,received:0},_="fulfilled"===o.status?o.value:{waitingPurchase:[],waitingDelivery:[],recentCompleted:[]};"rejected"===n.status&&s.error("[DashboardService] getDashboardStats ì‹¤íŒ¨:",n.reason),"rejected"===i.status&&s.error("[DashboardService] getMyRecentRequests ì‹¤íŒ¨:",i.reason),"rejected"===l.status&&s.error("[DashboardService] getPendingApprovals ì‹¤íŒ¨:",l.reason),"rejected"===d.status&&s.error("[DashboardService] getQuickActions ì‹¤íŒ¨:",d.reason),"rejected"===c.status&&s.error("[DashboardService] getTodaySummary ì‹¤íŒ¨:",c.reason),"rejected"===o.status&&s.error("[DashboardService] getMyPurchaseStatus ì‹¤íŒ¨:",o.reason);const x={employee:e,stats:u,urgentRequests:[],myRecentRequests:m,pendingApprovals:p,quickActions:h,todaySummary:g,myPurchaseStatus:_};return N.data=x,N.lastFetch=t,N.employeeId=e.id,x}async getDashboardStats(e){const a=(new Date).toISOString().split("T")[0],s=this.parseRoles(e.purchase_role),[t,r,n,i,l,d]=await Promise.all([this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("requester_name",e.name),this.getPendingCount(e,s),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("is_received",!0).gte("received_at",new Date((new Date).getFullYear(),(new Date).getMonth(),1).toISOString()),this.getUrgentCount(e,s),this.getTodayActionsCount(e,a)]);return{total:t.count||0,myRequests:r.count||0,pending:n,completed:i.count||0,urgent:l,todayActions:d}}async getMyRecentRequests(e){const{data:a}=await this.supabase.from("purchase_requests").select("*,vendors(vendor_name),purchase_request_items(id)").eq("requester_name",e.name).or("and(middle_manager_status.eq.approved,final_manager_status.eq.pending),and(final_manager_status.eq.approved,is_payment_completed.eq.false)").order("created_at",{ascending:!1}).limit(5);return(a||[]).map(e=>({...e,vendor_name:e.vendors?.vendor_name,total_items:e.purchase_request_items?.length||0,progress_percentage:this.calculateProgress(e),current_step:this.getCurrentStep(e),next_action:this.getNextAction(e),estimated_completion:this.estimateCompletion(e)}))}async getPendingApprovals(e){const a=this.parseRoles(e.purchase_role);if(0===a.length)return[];s.debug("ðŸš€ ìŠ¹ì¸ ëŒ€ê¸° í•­ëª© ì¡°íšŒ ì‹œìž‘",{employeeName:e.name,employeeRoles:a});const{data:t,error:r}=await this.supabase.from("purchase_requests").select("\n        *,\n        vendors(vendor_name),\n        purchase_request_items(\n          id,\n          item_name,\n          specification,\n          quantity,\n          unit_price_value,\n          amount_value\n        )\n      ").order("request_date",{ascending:!1}).limit(100);if(r)return s.error("âŒ ìŠ¹ì¸ ëŒ€ê¸° í•­ëª© ì¡°íšŒ ì‹¤íŒ¨",r),[];let n=t||[];const i=e=>"pending"===e||"ëŒ€ê¸°"===e||""===e||null==e;s.debug("ðŸ” ìŠ¹ì¸ ëŒ€ê¸° í•„í„°ë§ ì „ ë°ì´í„°",{totalRequests:t?.length||0}),n=n.filter(e=>{const a=i(e.middle_manager_status),s=i(e.final_manager_status),t="rejected"===e.middle_manager_status,r="rejected"===e.final_manager_status;return!t&&!r&&(a||s)});let l=n;a.includes("app_admin")?s.debug("ðŸ”‘ app_admin ê¶Œí•œìœ¼ë¡œ ëª¨ë“  ìŠ¹ì¸ëŒ€ê¸° í•­ëª© í‘œì‹œ",{totalItems:l.length}):a.includes("middle_manager")?(l=n.filter(e=>i(e.middle_manager_status)),s.debug("ðŸ”‘ middle_manager ê¶Œí•œìœ¼ë¡œ ì¤‘ê°„ìŠ¹ì¸ ëŒ€ê¸° í•­ëª©ë§Œ í‘œì‹œ",{beforeFilter:n.length,afterFilter:l.length})):a.includes("final_approver")||a.includes("ceo")?(l=n.filter(e=>{const a="approved"===e.middle_manager_status,s=i(e.final_manager_status);return a&&s}),s.debug("ðŸ”‘ final_approver/ceo ê¶Œí•œìœ¼ë¡œ ìµœì¢…ìŠ¹ì¸ ëŒ€ê¸° í•­ëª©ë§Œ í‘œì‹œ",{beforeFilter:n.length,afterFilter:l.length})):a.includes("raw_material_manager")||a.includes("consumable_manager")?(l=n.filter(e=>{const a="approved"===e.middle_manager_status,s=i(e.final_manager_status);return a&&s}),s.debug("ðŸ”‘ material_manager ê¶Œí•œìœ¼ë¡œ ìµœì¢…ìŠ¹ì¸ ëŒ€ê¸° í•­ëª©ë§Œ í‘œì‹œ",{beforeFilter:n.length,afterFilter:l.length})):a.includes("lead buyer")?(l=n.filter(e=>{const a="approved"===e.final_manager_status,s=!e.is_payment_completed;return a&&s}),s.debug("ðŸ”‘ lead buyer ê¶Œí•œìœ¼ë¡œ êµ¬ë§¤ ëŒ€ê¸° í•­ëª©ë§Œ í‘œì‹œ",{beforeFilter:n.length,afterFilter:l.length})):(l=[],s.debug("ðŸ”‘ ìŠ¹ì¸ ê¶Œí•œ ì—†ëŠ” ì—­í• ",{roles:a,result:"empty"}));const d=l.map(e=>{const a=e.vendors?.vendor_name||e.vendor_name||"ì—…ì²´ ì •ë³´ ì—†ìŒ",s=e.purchase_request_items||[],t=s.reduce((e,a)=>e+(Number(a?.amount_value)||(Number(a?.quantity)||0)*(Number(a?.unit_price_value)||0)),0);return{...e,vendor_name:a,purchase_request_items:s,total_amount:t}});return s.debug("âœ… ìŠ¹ì¸ ëŒ€ê¸° í•­ëª© ì¡°íšŒ ì™„ë£Œ (ìµœì í™”ë¨)",{finalCount:d.length,performanceNote:"N+1 ë¬¸ì œ í•´ê²° - ë‹¨ì¼ JOIN ì¿¼ë¦¬ ì‚¬ìš©"}),d}async getQuickActions(e){const a=this.parseRoles(e.purchase_role),s=[];if(a.includes("app_admin")||a.includes("middle_manager")||a.includes("final_approver")||a.includes("ceo")){const t=await this.getPendingCount(e,a);t>0&&s.push({id:"approve",type:"approve",label:"ìŠ¹ì¸ ëŒ€ê¸°",description:`${t}ê±´ì˜ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘`,count:t,color:"red"})}if(a.includes("lead buyer")||a.includes("lead buyer")){const{count:e}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("final_manager_status","approved").eq("is_payment_completed",!1);e&&e>0&&s.push({id:"purchase",type:"purchase",label:"êµ¬ë§¤ ì²˜ë¦¬",description:`${e}ê±´ì˜ êµ¬ë§¤ ëŒ€ê¸° ì¤‘`,count:e,color:"yellow"})}return s}async getTodaySummary(e){const a=(new Date).toISOString().split("T")[0],s=new Date(Date.now()+864e5).toISOString().split("T")[0],[t,r,n]=await Promise.all([this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).gte("updated_at",a).lt("updated_at",s).or("middle_manager_status.eq.approved,final_manager_status.eq.approved"),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("requester_name",e.name).gte("created_at",a).lt("created_at",s),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("is_received",!0).gte("received_at",a).lt("received_at",s)]);return{approved:t.count||0,requested:r.count||0,received:n.count||0}}async getMyPurchaseStatus(e){const a=this.parseRoles(e.purchase_role),t=a.includes("lead buyer")||a.includes("app_admin"),r=e.name||e.email,n=new Date(Date.now()-6048e5).toISOString();let i=this.supabase.from("purchase_requests").select("*,vendors(vendor_name),purchase_request_items(*)").order("created_at",{ascending:!1}).limit(500);t||(i=i.eq("requester_name",r));const l=await i;if(l.error)return s.error("getMyPurchaseStatus ì—ëŸ¬",l.error),{waitingPurchase:[],waitingDelivery:[],recentCompleted:[]};const d=l.data||[];return{waitingPurchase:d.filter(e=>{const a="êµ¬ë§¤ ìš”ì²­"===(e.payment_category||"").trim(),s=!e.is_payment_completed;if(!a||!s)return!1;if((e.progress_type||"").includes("ì„ ì§„í–‰"))return!0;const t=(e.progress_type||"").includes("ì¼ë°˜")||!e.progress_type||""===e.progress_type,r="approved"===e.final_manager_status;return t&&r}),waitingDelivery:d.filter(e=>{const a=!e.is_received,s=(e.progress_type||"").includes("ì„ ì§„í–‰");if(e.requester_name!==r)return!1;if(a&&s)return!0;const t="approved"===e.final_manager_status;return a&&t}),recentCompleted:d.filter(e=>{if(!0!==e.is_received)return!1;if(!e.received_at)return!1;if(e.requester_name!==r)return!1;return new Date(e.received_at)>=new Date(n)})}}async quickApprove(e,a){try{const s=this.parseRoles(a.purchase_role),{data:t}=await this.supabase.from("purchase_requests").select("middle_manager_status, final_manager_status").eq("id",e).single();if(!t)return{success:!1,error:"ìš”ì²­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."};let r={};const n=e=>"pending"===e||"ëŒ€ê¸°"===e||""===e||null==e;if(s.includes("app_admin")?n(t.middle_manager_status)?r={middle_manager_status:"approved"}:"approved"===t.middle_manager_status&&n(t.final_manager_status)&&(r={final_manager_status:"approved"}):s.includes("middle_manager")?n(t.middle_manager_status)&&(r={middle_manager_status:"approved"}):s.includes("final_approver")||s.includes("ceo")?"approved"===t.middle_manager_status&&n(t.final_manager_status)&&(r={final_manager_status:"approved"}):(s.includes("raw_material_manager")||s.includes("consumable_manager"))&&"approved"===t.middle_manager_status&&n(t.final_manager_status)&&(r={final_manager_status:"approved"}),0===Object.keys(r).length)return{success:!1,error:"ìŠ¹ì¸í•  ìˆ˜ ìžˆëŠ” ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤."};const{data:i,error:l}=await this.supabase.from("purchase_requests").update(r).eq("id",e).select().single();if(l)throw l;return{success:!0}}catch(s){return{success:!1,error:s.message}}}async getPendingCount(e,a){if(a.includes("app_admin")){const[e,a,s]=await Promise.all([this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).or("middle_manager_status.in.(pending,ëŒ€ê¸°),middle_manager_status.is.null"),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("middle_manager_status","approved").or("final_manager_status.in.(pending,ëŒ€ê¸°),final_manager_status.is.null"),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("final_manager_status","approved").eq("is_payment_completed",!1)]);return(e.count||0)+(a.count||0)+(s.count||0)}if(a.includes("middle_manager")){const{count:e,error:a}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).or("middle_manager_status.in.(pending,ëŒ€ê¸°),middle_manager_status.is.null");return a?0:e||0}if(a.includes("final_approver")||a.includes("ceo")){const{count:e,error:a}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("middle_manager_status","approved").or("final_manager_status.in.(pending,ëŒ€ê¸°),final_manager_status.is.null");return a?0:e||0}if(a.includes("lead buyer")){const{count:e,error:a}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("final_manager_status","approved").eq("is_payment_completed",!1);return a?0:e||0}return 0}async getUrgentCount(e,a){if(0===a.length)return 0;const s=new Date(Date.now()-2592e5).toISOString();let t=this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).lt("created_at",s);if(a.includes("app_admin"))t=t.or("middle_manager_status.eq.pending,final_manager_status.eq.pending,is_payment_completed.eq.false");else if(a.includes("middle_manager"))t=t.eq("middle_manager_status","pending");else if(a.includes("final_approver")||a.includes("ceo"))t=t.eq("middle_manager_status","approved").eq("final_manager_status","pending");else{if(!a.includes("lead buyer"))return 0;t=t.eq("final_manager_status","approved").eq("is_payment_completed",!1)}const{count:r}=await t;return r||0}async getTodayActionsCount(e,a){const s=new Date(Date.now()+864e5).toISOString().split("T")[0],{count:t}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).gte("updated_at",a).lt("updated_at",s).eq("requester_name",e.name);return t||0}async getTotalDeliveryWaitingCount(){const{count:e}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("is_received",!1).or("is_payment_completed.eq.true,progress_type.ilike.%ì„ ì§„í–‰%");return e||0}calculateProgress(e){let a=0;return"approved"===e.middle_manager_status&&(a+=25),"approved"===e.final_manager_status&&(a+=25),e.is_payment_completed&&(a+=25),e.is_received&&(a+=25),a}getCurrentStep(e){return e.is_received?"completed":e.is_payment_completed?"delivery":"approved"===e.final_manager_status?"purchase":"approval"}getNextAction(e){return"pending"===e.middle_manager_status?"ì¤‘ê°„ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘":"pending"===e.final_manager_status?"ìµœì¢… ìŠ¹ì¸ ëŒ€ê¸° ì¤‘":e.is_payment_completed?e.is_received?"ì™„ë£Œ":"ìž…ê³  ëŒ€ê¸° ì¤‘":"êµ¬ë§¤ ì²˜ë¦¬ ëŒ€ê¸° ì¤‘"}estimateCompletion(e){const a=new Date(e.created_at),s=new Date;Math.floor((s.getTime()-a.getTime())/864e5);let t=7;"ê¸´ê¸‰"===e.progress_type&&(t=3);return new Date(a.getTime()+24*t*60*60*1e3).toLocaleDateString("ko-KR")}async getUndownloadedOrders(e){const a=this.parseRoles(e.purchase_role);if(!a.includes("lead buyer")&&!a.includes("app_admin"))return s.info("[DashboardService] ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œ ì¡°íšŒ ê¶Œí•œ ì—†ìŒ:",{roles:a}),[];try{const{data:t,error:r}=await this.supabase.from("purchase_requests").select("*,purchase_request_items(id,item_name,specification,quantity,unit_price_value,amount_value)").or("is_po_download.is.null,is_po_download.eq.false").order("created_at",{ascending:!1}).limit(500);if(r)throw s.error("[DashboardService] ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œ ì¡°íšŒ ì¿¼ë¦¬ ì—ëŸ¬:",r),r;const n=(t||[]).filter(e=>!0!==e.is_po_download);return s.info("[DashboardService] ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œ í•„í„°ë§ ê²°ê³¼:",{totalFetched:t?.length||0,afterFilter:n.length,roles:a,employeeName:e.name,sampleItems:n.slice(0,3).map(e=>({id:e.id,purchase_order_number:e.purchase_order_number,requester_name:e.requester_name,payment_category:e.payment_category,progress_type:e.progress_type,is_po_download:e.is_po_download,is_payment_completed:e.is_payment_completed}))}),n}catch(t){throw s.error("[DashboardService] getUndownloadedOrders ì—ëŸ¬:",t),t}}};function S(){const[e,N]=t.useState(null),[S,D]=t.useState(!0),[P,C]=t.useState(null),[A,R]=t.useState([]),[k,T]=t.useState([]),[O,I]=t.useState(new Set),M=a(),[F,U]=t.useState(null),[$,E]=t.useState(!1),[H,L]=t.useState("pending"),[Q,B]=t.useState({undownloaded:"",pending:"",purchase:"",delivery:""});r();const{employee:K,currentUserRoles:J}=n(),W=t.useCallback(async(a=!0,t=!1)=>{if(!K)return s.error("[DashboardMain] No employee data available"),void(a&&D(!1));try{!a||t||e||D(!0);const n=await q.getDashboardData(K,t);if(N(n),R(J),J.includes("lead buyer")||J.includes("app_admin"))try{const e=await q.getUndownloadedOrders(K);s.info("[DashboardMain] ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œ ì¡°íšŒ ê²°ê³¼:",{count:e.length,userRoles:J,employeeName:K.name,sampleItems:e.slice(0,3).map(e=>({purchase_order_number:e.purchase_order_number,requester_name:e.requester_name,vendor_name:e.vendor_name}))}),T(e)}catch(r){s.error("[DashboardMain] ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œ ì¡°íšŒ ì‹¤íŒ¨:",r),b.error("ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}}catch(n){s.error("[DashboardMain] Failed to load dashboard data:",n),b.error("ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."),D(!1),N(null)}finally{a&&D(!1)}},[K,J,e]);t.useEffect(()=>{W()},[W]);const Y=(e,a="pending")=>{U(Number(e.id)),L(a),E(!0)},z=(e,a)=>a.trim()?e.filter(e=>[e.purchase_order_number||"",e.vendor_name||"",(e.purchase_request_items||[]).map(e=>e.item_name||"").join(" ")].join(" ").toLowerCase().includes(a.toLowerCase())):e;if(S)return i.jsx("div",{className:"flex items-center justify-center",style:{minHeight:"400px",backgroundColor:"#f9fafb"},children:i.jsxs("div",{className:"text-center",children:[i.jsx("div",{className:"w-12 h-12 border-3 border-hansl-500 border-t-transparent rounded-full animate-spin mx-auto"}),i.jsx("p",{className:"mt-4 card-subtitle",children:"ëŒ€ì‹œë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìžˆìŠµë‹ˆë‹¤..."}),i.jsxs("p",{className:"text-xs text-gray-400 mt-2",children:["Employee: ",K?.name||"ì—†ìŒ"]})]})});if(!e?.employee)return s.warn("[DashboardMain] ë°ì´í„° ì—†ìŒ",{hasData:!!e,hasEmployee:!!K,employeeName:K?.name,loading:S}),i.jsx("div",{className:"flex items-center justify-center",style:{minHeight:"400px",backgroundColor:"#f9fafb"},children:i.jsxs("div",{className:"text-center bg-white p-8 rounded-lg border border-gray-200 shadow-sm",children:[i.jsx("h3",{className:"modal-subtitle mb-2",children:"ì‚¬ìš©ìž ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"}),i.jsx("p",{className:"card-subtitle mb-4",children:"ë¡œê·¸ì¸ì„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."}),i.jsxs("div",{className:"text-xs text-gray-400 space-y-1",children:[i.jsxs("p",{children:["Employee: ",K?.name||"ì—†ìŒ"]}),i.jsxs("p",{children:["Loading: ",S?"true":"false"]}),i.jsxs("p",{children:["Has Data: ",e?"true":"false"]})]})]})});const G=(Array.isArray(e.employee.purchase_role)?e.employee.purchase_role.map(e=>String(e).trim()):e.employee.purchase_role?String(e.employee.purchase_role).split(",").map(e=>e.trim()).filter(e=>e.length>0):[]).some(e=>["middle_manager","final_approver","app_admin","raw_material_manager","consumable_manager"].includes(e));return i.jsxs("div",{className:"min-h-screen bg-gray-50",children:[i.jsxs("div",{className:"w-full px-4 lg:px-6",children:[i.jsx("div",{className:"mb-3",children:i.jsxs("div",{children:[i.jsx("h1",{className:"page-title",children:"ëŒ€ì‹œë³´ë“œ"}),i.jsx("p",{className:"page-subtitle",style:{marginTop:"-2px",marginBottom:"-4px"},children:"Dashboard"})]})}),i.jsx("div",{className:"mb-2",children:i.jsxs("h2",{className:"section-title mb-2 flex items-center gap-1.5",children:[i.jsx(f,{className:"w-3.5 h-3.5 text-gray-600"}),"ì „ì²´ í˜„í™©",i.jsx("span",{className:"badge-stats border border-gray-300 bg-white text-gray-600 ml-2",children:(new Date).toLocaleDateString("ko-KR",{month:"long",day:"numeric",weekday:"short"})})]})}),i.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3",children:[(A.includes("lead buyer")||A.includes("app_admin"))&&i.jsxs(o,{className:"w-full col-span-1 row-span-2 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[i.jsx(u,{className:"h-12 px-4 bg-gray-50 border-b flex items-center",children:i.jsxs(m,{className:"section-title flex items-center justify-between w-full",children:[i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx(v,{className:"w-4 h-4 text-orange-600"}),i.jsx("span",{children:"ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œ"})]}),i.jsx("span",{className:"badge-stats bg-gray-200 text-gray-700",children:k.length})]})}),i.jsx(p,{className:"p-4",children:i.jsxs("div",{className:"space-y-3",children:[i.jsxs("div",{className:"relative",children:[i.jsx(h,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),i.jsx(g,{placeholder:"ë°œì£¼ë²ˆí˜¸, ì—…ì²´ëª…, í’ˆëª©ìœ¼ë¡œ ê²€ìƒ‰...",value:Q.undownloaded,onChange:e=>B(a=>({...a,undownloaded:e.target.value})),className:"pl-10 h-8 text-xs"})]}),i.jsxs("div",{className:"space-y-2 h-[36rem] overflow-y-auto",children:[0===z(k,Q.undownloaded).length?i.jsxs("div",{className:"text-center py-12 text-gray-400",children:[i.jsx(v,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),i.jsx("p",{className:"card-subtitle",children:"ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œê°€ ì—†ìŠµë‹ˆë‹¤"})]}):z(k,Q.undownloaded).map((e,a)=>{const t=e.purchase_request_items||[],r=t[0]||{},n="ì„ ì§„í–‰"===e.progress_type;return i.jsx("div",{className:"border rounded-lg p-2 hover:shadow-sm transition-all cursor-pointer mb-2 "+(n?"bg-red-50 border-red-200":"hover:bg-orange-50/30"),onClick:a=>{a.target.closest("button")||Y(e,"pending")},children:i.jsxs("div",{className:"flex items-center justify-between gap-2",children:[i.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[i.jsx("span",{className:"card-title",children:e.purchase_order_number||`PO-${e.id.slice(0,8)}`}),i.jsx("span",{className:"card-subtitle truncate",children:e.vendor_name||"ì—…ì²´ëª… ì—†ìŒ"}),i.jsxs("span",{className:"card-description truncate",children:[r.item_name||"í’ˆëª©",t.length>1&&i.jsxs("span",{className:"text-gray-400",children:[" ì™¸ ",t.length-1,"ê±´"]})]})]}),i.jsx(l,{className:"button-base bg-gray-500 hover:bg-gray-600 text-white",onClick:async a=>{a.stopPropagation(),await(async e=>{try{I(a=>new Set(a).add(e.id)),await new Promise(e=>setTimeout(e,0)),await y({id:e.id,purchase_order_number:e.purchase_order_number,vendor_name:e.vendor_name,vendor_id:e.vendor_id,contact_id:e.contact_id},A,()=>{T(a=>a.filter(a=>a.id!==e.id))})}catch(a){s.error("Excel ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ",a)}finally{I(a=>{const s=new Set(a);return s.delete(e.id),s})}})(e)},disabled:O.has(e.id),children:O.has(e.id)?i.jsx("div",{className:"w-3 h-3 border border-white border-t-transparent rounded-full animate-spin"}):"ë‹¤ìš´ë¡œë“œ"})]})},`undownloaded-${e.id}`)}),z(k,Q.undownloaded).length>=100&&i.jsxs("div",{className:"text-center text-xs text-gray-500 mt-3 pb-2",children:["í‘œì‹œëœ í•­ëª©: ",z(k,Q.undownloaded).length,"ê°œ",i.jsx("br",{}),"ë” ë§Žì€ í•­ëª©ì´ ìžˆì„ ìˆ˜ ìžˆìŠµë‹ˆë‹¤. ê²€ìƒ‰ìœ¼ë¡œ í•„í„°ë§í•˜ì„¸ìš”."]}),z(k,Q.undownloaded).length>0&&i.jsxs("div",{className:"text-center text-xs text-gray-400 mt-2 pb-2",children:["ì´ ",z(k,Q.undownloaded).length,"ê°œ ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œ"]})]})]})})]}),G&&i.jsxs(o,{className:"w-full col-span-1 row-span-2",children:[i.jsx(u,{className:"h-12 px-4 bg-gray-50 border-b flex items-center",children:i.jsxs(m,{className:"section-title flex items-center justify-between w-full",children:[i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx(j,{className:"w-3.5 h-3.5 text-orange-500"}),i.jsx("span",{children:"ìŠ¹ì¸ ëŒ€ê¸°"})]}),e.pendingApprovals.length>0&&i.jsx("span",{className:"badge-stats bg-gray-200 text-gray-700",children:e.pendingApprovals.length})]})}),i.jsx(p,{className:"p-4",children:0===e.pendingApprovals.length?i.jsxs("div",{className:"text-center py-4 text-gray-400",children:[i.jsx(w,{className:"w-6 h-6 mx-auto mb-1"}),i.jsx("p",{className:"card-description",children:"ëŒ€ê¸° í•­ëª© ì—†ìŒ"})]}):i.jsxs("div",{className:"space-y-3",children:[i.jsxs("div",{className:"relative",children:[i.jsx(h,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),i.jsx(g,{placeholder:"ë°œì£¼ë²ˆí˜¸, ì—…ì²´ëª…, í’ˆëª©ìœ¼ë¡œ ê²€ìƒ‰...",value:Q.pending,onChange:e=>B(a=>({...a,pending:e.target.value})),className:"pl-10 h-8 text-xs"})]}),i.jsx("div",{className:"space-y-2 h-[36rem] overflow-y-auto",children:z(e.pendingApprovals,Q.pending).slice(0,10).map((a,s)=>{const t=a.purchase_request_items||[],r=t[0]||{};a.total_amount||t.reduce((e,a)=>e+(Number(a.amount_value)||0),0);const n="ì„ ì§„í–‰"===a.progress_type;return i.jsx("div",{className:"border rounded-lg p-2 hover:shadow-sm transition-all cursor-pointer mb-2 "+(n?"bg-red-50 border-red-200":"hover:bg-orange-50/30"),onClick:e=>{e.target.closest("button")||Y(a,"pending")},children:i.jsxs("div",{className:"flex items-center justify-between gap-2",children:[i.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[i.jsx("span",{className:"card-title",children:a.purchase_order_number}),i.jsx("span",{className:"card-subtitle truncate",children:a.vendor_name||"ì—…ì²´"}),i.jsxs("span",{className:"card-description truncate",children:[r.item_name||"í’ˆëª©"," ",t.length>1&&`ì™¸ ${t.length-1}ê±´`]})]}),i.jsx(l,{onClick:async s=>{s.stopPropagation(),await(async a=>{if(!e?.employee)return void b.error("ì‚¬ìš©ìž ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");if(!confirm("ì •ë§ë¡œ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"))return;C(a),await new Promise(e=>setTimeout(e,0));const s=e;N(e=>e?{...e,pendingApprovals:e.pendingApprovals.filter(e=>e.id!==a),stats:{...e.stats,pending:Math.max(0,e.stats.pending-1)}}:e);try{const t=await q.quickApprove(a,e.employee);t.success?(b.success("ìŠ¹ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."),setTimeout(()=>{W(!1)},1e3)):(N(s),b.error(t.error||"ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."))}catch(t){N(s),b.error("ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}finally{C(null)}})(a.id)},disabled:P===a.id,className:"button-base text-white "+("approved"===a.middle_manager_status?"bg-blue-600 hover:bg-blue-700":"bg-green-600 hover:bg-green-700"),children:P===a.id?i.jsx("div",{className:"w-3 h-3 border border-white border-t-transparent rounded-full animate-spin"}):i.jsxs(i.Fragment,{children:["approved"===a.middle_manager_status?"ìµœì¢…":"1ì°¨"," ìŠ¹ì¸"]})})]})},`approval-${a.id}`)})})]})})]}),(A.includes("lead buyer")||A.includes("app_admin"))&&i.jsxs(o,{className:"w-full col-span-1 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[i.jsx(u,{className:"h-12 px-4 bg-gray-50 border-b flex items-center",children:i.jsxs(m,{className:"section-title flex items-center justify-between w-full",children:[i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx(d,{className:"w-4 h-4 text-yellow-600"}),i.jsx("span",{children:"êµ¬ë§¤ ëŒ€ê¸°"})]}),e.myPurchaseStatus&&e.myPurchaseStatus.waitingPurchase&&e.myPurchaseStatus.waitingPurchase.length>0&&i.jsx("span",{className:"badge-stats bg-gray-200 text-gray-700",children:e.myPurchaseStatus.waitingPurchase.length})]})}),i.jsx(p,{className:"p-4",children:e.myPurchaseStatus&&e.myPurchaseStatus.waitingPurchase&&0!==e.myPurchaseStatus.waitingPurchase.length?i.jsxs("div",{className:"space-y-3",children:[i.jsxs("div",{className:"relative",children:[i.jsx(h,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),i.jsx(g,{placeholder:"ë°œì£¼ë²ˆí˜¸, ì—…ì²´ëª…, í’ˆëª©ìœ¼ë¡œ ê²€ìƒ‰...",value:Q.purchase,onChange:e=>B(a=>({...a,purchase:e.target.value})),className:"pl-10 h-8 text-xs"})]}),i.jsx("div",{className:"space-y-2 h-[36rem] overflow-y-auto",children:z(e.myPurchaseStatus.waitingPurchase,Q.purchase).map(e=>{const a=e.purchase_request_items||[],s=a[0];a.reduce((e,a)=>e+(Number(a.amount_value)||0),0);const t=(e.progress_type||"").includes("ì„ ì§„í–‰");return i.jsx("div",{className:"border rounded-lg p-2 transition-all hover:shadow-sm mb-2 "+(t?"bg-red-50 hover:bg-red-100 border-red-200":"bg-white hover:bg-gray-50 border-gray-200"),children:i.jsxs("div",{className:"flex items-center justify-between gap-2",children:[i.jsxs("div",{className:"flex items-center gap-2 flex-1 cursor-pointer",onClick:a=>{a.target.closest("button")||Y(e,"purchase")},children:[i.jsx("span",{className:"card-title",children:e.purchase_order_number||`PO-${e.id.slice(0,8)}`}),i.jsx("span",{className:"card-subtitle truncate",children:e.vendor_name||"ì—…ì²´ëª… ì—†ìŒ"}),i.jsxs("span",{className:"card-description truncate",children:[s?.item_name||"í’ˆëª©",a.length>1&&i.jsxs("span",{className:"text-gray-400",children:[" ì™¸ ",a.length-1,"ê±´"]})]})]}),(A.includes("lead buyer")||A.includes("app_admin"))&&!e.is_payment_completed&&i.jsx(l,{onClick:async a=>{if(a.stopPropagation(),confirm("ì´ ë°œì£¼ë¥¼ êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){await new Promise(e=>setTimeout(e,0));try{const{error:a}=await M.from("purchase_requests").update({is_payment_completed:!0,payment_completed_at:(new Date).toISOString()}).eq("id",e.id);if(a)throw a;b.success("êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."),W(!1)}catch(s){b.error("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}}},className:"button-base bg-orange-500 hover:bg-orange-600 text-white",children:"êµ¬ë§¤ì™„ë£Œ"}),e.is_payment_completed&&i.jsx("div",{className:"bg-green-100 text-green-700 px-2 py-1 business-radius-badge badge-text shrink-0",children:"ì™„ë£Œë¨"})]})},e.id)})})]}):i.jsxs("div",{className:"text-center py-12 text-gray-400",children:[i.jsx(d,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),i.jsx("p",{className:"card-subtitle",children:"êµ¬ë§¤ ëŒ€ê¸° í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤"})]})})]}),i.jsxs(o,{className:"w-full col-span-1 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[i.jsx(u,{className:"h-12 px-4 bg-gray-50 border-b flex items-center",children:i.jsxs(m,{className:"section-title flex items-center justify-between w-full",children:[i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx(_,{className:"w-4 h-4 text-blue-600"}),i.jsx("span",{children:"ìž…ê³  ëŒ€ê¸°"})]}),e.myPurchaseStatus.waitingDelivery.length>0&&i.jsx("span",{className:"badge-stats bg-gray-200 text-gray-700",children:e.myPurchaseStatus.waitingDelivery.length})]})}),i.jsx(p,{className:"p-4",children:0===e.myPurchaseStatus.waitingDelivery.length?i.jsxs("div",{className:"text-center py-12 text-gray-400",children:[i.jsx(_,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),i.jsx("p",{className:"card-subtitle",children:"ìž…ê³  ëŒ€ê¸° í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤"})]}):i.jsxs("div",{className:"space-y-3",children:[i.jsxs("div",{className:"relative",children:[i.jsx(h,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),i.jsx(g,{placeholder:"ë°œì£¼ë²ˆí˜¸, ì—…ì²´ëª…, í’ˆëª©ìœ¼ë¡œ ê²€ìƒ‰...",value:Q.delivery,onChange:e=>B(a=>({...a,delivery:e.target.value})),className:"pl-10 h-8 text-xs"})]}),i.jsx("div",{className:"space-y-2 h-[36rem] overflow-y-auto",children:z(e.myPurchaseStatus.waitingDelivery,Q.delivery).slice(0,10).map(e=>{const a=e.purchase_request_items||[],s=a[0],t=a.length;a.filter(e=>e.is_received).length,a.reduce((e,a)=>e+(Number(a.amount_value)||0),0);const r=(e.progress_type||"").includes("ì„ ì§„í–‰");return i.jsx("div",{className:"border rounded-lg p-2 transition-all cursor-pointer hover:shadow-sm mb-2 "+(r?"bg-red-50 hover:bg-red-100 border-red-200":"bg-white hover:bg-gray-50 border-gray-200"),onClick:a=>{a.target.closest("button")||Y(e,"receipt")},children:i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("span",{className:"card-title",children:e.purchase_order_number||`PO-${e.id.slice(0,8)}`}),i.jsx("span",{className:"card-subtitle truncate",children:e.vendor_name||"ì—…ì²´ëª… ì—†ìŒ"}),i.jsxs("span",{className:"card-description truncate",children:[s?.item_name||"í’ˆëª©",t>1&&i.jsxs("span",{className:"text-gray-400",children:[" ì™¸ ",t-1,"ê±´"]})]})]})},e.id)})})]})})]})]})]}),i.jsx(x,{purchaseId:F,isOpen:$,onClose:()=>{E(!1),U(null),L("pending")},currentUserRoles:A,activeTab:H,onRefresh:()=>{W(!1),E(!1),U(null),L("pending")},onOptimisticUpdate:(e,a)=>{c(e,a),W(!1)}})]})}export{S as default};
//# sourceMappingURL=DashboardMain-DVvcR4La.js.map
