import{c as e,l as s}from"./index-B0aFbCDa.js";const r=new class{constructor(){this.supabase=e(),this.BUCKET_NAME="support-attachments"}async uploadAttachment(e){try{const{data:{user:r},error:t}=await this.supabase.auth.getUser();if(t||!r)return{success:!1,error:"로그인이 필요합니다."};const a=e.name.split(".").pop()?.toLowerCase()||"jpg",u=Date.now(),i=`support_${u}_${Math.random().toString(36).substring(2,8)}.${a}`,c=`inquiries/${r.id}/${i}`,{error:n}=await this.supabase.storage.from(this.BUCKET_NAME).upload(c,e,{contentType:e.type,upsert:!1});if(n)throw s.error("첨부파일 업로드 에러",n),n;const{data:{publicUrl:o}}=this.supabase.storage.from(this.BUCKET_NAME).getPublicUrl(c);return{success:!0,data:{url:o,name:e.name,size:e.size,path:c}}}catch(r){return{success:!1,error:r instanceof Error?r.message:"파일 업로드 실패"}}}async deleteAttachment(e){try{const{error:s}=await this.supabase.storage.from(this.BUCKET_NAME).remove([e]);if(s)throw s;return{success:!0}}catch(s){return{success:!1,error:s instanceof Error?s.message:"파일 삭제 실패"}}}sortInquiriesByStatus(e){return e.sort((e,s)=>{const r="resolved"===e.status||"closed"===e.status;if(r!==("resolved"===s.status||"closed"===s.status))return r?1:-1;const t=new Date(e.created_at||0).getTime();return new Date(s.created_at||0).getTime()-t})}async createInquiry(e){try{const{data:{user:r},error:t}=await this.supabase.auth.getUser();if(t||!r)return{success:!1,error:"로그인이 필요합니다."};const{data:a}=await this.supabase.from("employees").select("id, name, email").eq("email",r.email).maybeSingle(),{error:u}=await this.supabase.from("support_inquires").insert({user_id:r.id,user_email:a?.email||r.email,user_name:a?.name||"",requester_id:a?.id,inquiry_type:e.inquiry_type,subject:e.subject,message:e.message,purchase_request_id:e.purchase_request_id??null,purchase_info:e.purchase_info,purchase_order_number:e.purchase_order_number,status:"open",attachments:e.attachments||[]});return u?(s.error("문의 등록 에러",u,{code:u.code,details:u.details,hint:u.hint}),{success:!1,error:u.message}):{success:!0}}catch(r){return{success:!1,error:r instanceof Error?r.message:"문의 접수 실패"}}}async getMyInquiries(){try{const{data:{user:e},error:s}=await this.supabase.auth.getUser();if(s||!e)return{success:!1,data:[],error:"로그인이 필요합니다."};const{data:r,error:t}=await this.supabase.from("support_inquires").select("*").eq("user_id",e.id).order("created_at",{ascending:!1});if(t)throw t;return{success:!0,data:this.sortInquiriesByStatus(r||[])}}catch(e){return{success:!1,data:[],error:e instanceof Error?e.message:"문의 조회 실패"}}}async getAllInquiries(){try{const{data:e,error:s}=await this.supabase.from("support_inquires").select("*").order("created_at",{ascending:!1});if(s)throw s;return{success:!0,data:this.sortInquiriesByStatus(e||[])}}catch(e){return{success:!1,data:[],error:e instanceof Error?e.message:"문의 조회 실패"}}}async updateInquiryStatus(e,s,r){try{const{data:{user:t},error:a}=await this.supabase.auth.getUser();if(a||!t)return{success:!1,error:"로그인이 필요합니다."};const{data:u}=await this.supabase.from("employees").select("name").eq("email",t.email).single(),i={status:s,handled_by:u?.name||t.email,updated_at:(new Date).toISOString()};"resolved"!==s&&"closed"!==s||(i.processed_at=(new Date).toISOString()),r&&(i.resolution_note=r);const{error:c}=await this.supabase.from("support_inquires").update(i).eq("id",e);if(c)throw c;return{success:!0}}catch(t){return{success:!1,error:t instanceof Error?t.message:"상태 업데이트 실패"}}}async getMyPurchaseRequests(e,s){try{const{data:{user:r},error:t}=await this.supabase.auth.getUser();if(t||!r)return{success:!1,data:[],error:"로그인이 필요합니다."};const{data:a}=await this.supabase.from("employees").select("name").eq("email",r.email).single();if(!a)return{success:!1,data:[],error:"사용자 정보를 찾을 수 없습니다."};let u=this.supabase.from("purchase_requests").select("id,purchase_order_number,vendor_name,request_date,created_at,requester_name,middle_manager_status,final_manager_status,purchase_request_items(item_name,specification,quantity)").eq("requester_name",a.name).order("created_at",{ascending:!1});e&&(u=u.gte("created_at",`${e}T00:00:00`)),s&&(u=u.lte("created_at",`${s}T23:59:59.999`));const{data:i,error:c}=await u.limit(100);if(c)throw c;return{success:!0,data:i||[]}}catch(r){return{success:!1,data:[],error:r instanceof Error?r.message:"발주요청 조회 실패"}}}subscribeToInquiries(e){return this.supabase.channel("support_inquires_changes").on("postgres_changes",{event:"*",schema:"public",table:"support_inquires"},e).subscribe()}async updatePurchaseRequestItem(e,s){try{const r={};void 0!==s.item_name&&(r.item_name=s.item_name),void 0!==s.specification&&(r.specification=s.specification),void 0!==s.quantity&&(r.quantity=s.quantity),void 0!==s.remark&&(r.remark=s.remark),void 0!==s.unit_price_value&&(r.unit_price_value=s.unit_price_value,r.unit_price_currency="KRW"),void 0!==s.amount_value&&(r.amount_value=s.amount_value,r.amount_currency="KRW");const{error:t}=await this.supabase.from("purchase_request_items").update(r).eq("id",e);if(t)throw t;return{success:!0}}catch(r){return{success:!1,error:r instanceof Error?r.message:"품목 수정 실패"}}}async deletePurchaseRequestItem(e){try{const{error:s}=await this.supabase.from("purchase_request_items").delete().eq("id",e);if(s)throw s;return{success:!0}}catch(s){return{success:!1,error:s instanceof Error?s.message:"품목 삭제 실패"}}}async deletePurchaseRequest(e){try{const{data:s,error:r}=await this.supabase.from("purchase_request_items").delete().eq("purchase_request_id",e).select();if(r)throw r;const{data:t,error:a}=await this.supabase.from("purchase_requests").delete().eq("id",e).select();if(a)throw a;return{success:!0}}catch(s){return{success:!1,error:s instanceof Error?s.message:"발주요청 삭제 실패"}}}async getPurchaseRequestDetail(e){try{const{data:s,error:r}=await this.supabase.from("purchase_requests").select("*,purchase_request_items(id,line_number,item_name,specification,quantity,unit_price_value,amount_value,remark,link)").eq("id",e).single();if(r)throw r;return{success:!0,data:s}}catch(s){return{success:!1,error:s instanceof Error?s.message:"발주요청 조회 실패"}}}async deleteInquiry(e){try{const{data:{user:s},error:r}=await this.supabase.auth.getUser();if(r||!s)return{success:!1,error:"로그인이 필요합니다."};const{data:t}=await this.supabase.from("employees").select("purchase_role").eq("email",s.email).single(),a=t?.purchase_role?.includes("app_admin");if(!a){const{data:r,error:t}=await this.supabase.from("support_inquires").select("user_id, status, resolution_note").eq("id",e).single();if(t||!r)return{success:!1,error:"문의를 찾을 수 없습니다."};if(r.user_id!==s.id)return{success:!1,error:"본인의 문의만 삭제할 수 있습니다."};if(r.resolution_note)return{success:!1,error:"답변이 완료된 문의는 삭제할 수 없습니다."};if("open"!==r.status)return{success:!1,error:"처리가 진행된 문의는 삭제할 수 없습니다."}}const{error:u}=await this.supabase.from("support_inquires").delete().eq("id",e);if(u)throw u;return{success:!0}}catch(s){return{success:!1,error:s instanceof Error?s.message:"문의 삭제 실패"}}}};export{r as s};
//# sourceMappingURL=supportService-C51a4I52.js.map
