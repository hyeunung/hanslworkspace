import{e,r as t,R as n,a3 as r,j as a,B as i,c as s,l as c,a5 as o,a6 as l,a7 as d,a8 as u,a9 as m,d as h,u as p,t as _,X as g,a0 as f,y as v,a4 as x,P as b,aa as y,ab as w,g as N,ac as j,ad as S,ae as q}from"./index-BvgUOoDT.js";import{d as C,b as k}from"./helpers-CmqE03mo.js";import{C as D,k as I,D as M,f as R,S as $}from"./react-select.esm-B52KLWOb.js";import{I as E,P as T,D as O,a as P,b as A,c as W,L as F}from"./dialog-DdzUS4Ws.js";import{P as L,a as z,b as U}from"./popover-Bde3Div9.js";import{T as B}from"./textarea-joNJfKvn.js";import{t as K}from"./index-CFnxfa1n.js";import{C as V}from"./calendar-Bl9nu6EP.js";import{C as H}from"./check-7yeTsVP_.js";import{C as Y}from"./credit-card-DT2RYO8x.js";import{T as Q}from"./card-Wm6gpivN.js";import{L as X}from"./loader-circle-s52mQtgW.js";import{S as J}from"./save-BaaXvmMI.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=e("circle-check-big",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]),Z=e("dollar-sign",[["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}],["path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6",key:"1b0p4s"}]]),ee=e("grip-vertical",[["circle",{cx:"9",cy:"12",r:"1",key:"1vctgf"}],["circle",{cx:"9",cy:"5",r:"1",key:"hp0tcf"}],["circle",{cx:"9",cy:"19",r:"1",key:"fkjjf6"}],["circle",{cx:"15",cy:"12",r:"1",key:"1tmaij"}],["circle",{cx:"15",cy:"5",r:"1",key:"19l28e"}],["circle",{cx:"15",cy:"19",r:"1",key:"f4zoj3"}]]),te=e("image",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]]),ne=e("message-square-plus",[["path",{d:"M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z",key:"18887p"}],["path",{d:"M12 8v6",key:"1ib9pf"}],["path",{d:"M9 11h6",key:"1fldmi"}]]),re=e("pen",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]]),ae=e("truck",[["path",{d:"M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2",key:"wrbu53"}],["path",{d:"M15 18H9",key:"1lyqi6"}],["path",{d:"M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14",key:"lysw3i"}],["circle",{cx:"17",cy:"18",r:"2",key:"332jqn"}],["circle",{cx:"7",cy:"18",r:"2",key:"19iecd"}]]);const ie="undefined"!=typeof window&&void 0!==window.document&&void 0!==window.document.createElement;function se(e){const t=Object.prototype.toString.call(e);return"[object Window]"===t||"[object global]"===t}function ce(e){return"nodeType"in e}function oe(e){var t,n;return e?se(e)?e:ce(e)&&null!=(t=null==(n=e.ownerDocument)?void 0:n.defaultView)?t:window:window}function le(e){const{Document:t}=oe(e);return e instanceof t}function de(e){return!se(e)&&e instanceof oe(e).HTMLElement}function ue(e){return e instanceof oe(e).SVGElement}function me(e){return e?se(e)?e.document:ce(e)?le(e)?e:de(e)||ue(e)?e.ownerDocument:document:document:document}const he=ie?t.useLayoutEffect:t.useEffect;function pe(e){const n=t.useRef(e);return he(()=>{n.current=e}),t.useCallback(function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return null==n.current?void 0:n.current(...t)},[])}function _e(e,n){void 0===n&&(n=[e]);const r=t.useRef(e);return he(()=>{r.current!==e&&(r.current=e)},n),r}function ge(e,n){const r=t.useRef();return t.useMemo(()=>{const t=e(r.current);return r.current=t,t},[...n])}function fe(e){const n=pe(e),r=t.useRef(null),a=t.useCallback(e=>{e!==r.current&&(null==n||n(e,r.current)),r.current=e},[]);return[r,a]}function ve(e){const n=t.useRef();return t.useEffect(()=>{n.current=e},[e]),n.current}let xe={};function be(e,n){return t.useMemo(()=>{if(n)return n;const t=null==xe[e]?0:xe[e]+1;return xe[e]=t,e+"-"+t},[e,n])}function ye(e){return function(t){for(var n=arguments.length,r=new Array(n>1?n-1:0),a=1;a<n;a++)r[a-1]=arguments[a];return r.reduce((t,n)=>{const r=Object.entries(n);for(const[a,i]of r){const n=t[a];null!=n&&(t[a]=n+e*i)}return t},{...t})}}const we=ye(1),Ne=ye(-1);function je(e){if(!e)return!1;const{KeyboardEvent:t}=oe(e.target);return t&&e instanceof t}function Se(e){if(function(e){if(!e)return!1;const{TouchEvent:t}=oe(e.target);return t&&e instanceof t}(e)){if(e.touches&&e.touches.length){const{clientX:t,clientY:n}=e.touches[0];return{x:t,y:n}}if(e.changedTouches&&e.changedTouches.length){const{clientX:t,clientY:n}=e.changedTouches[0];return{x:t,y:n}}}return function(e){return"clientX"in e&&"clientY"in e}(e)?{x:e.clientX,y:e.clientY}:null}const qe=Object.freeze({Translate:{toString(e){if(!e)return;const{x:t,y:n}=e;return"translate3d("+(t?Math.round(t):0)+"px, "+(n?Math.round(n):0)+"px, 0)"}},Scale:{toString(e){if(!e)return;const{scaleX:t,scaleY:n}=e;return"scaleX("+t+") scaleY("+n+")"}},Transform:{toString(e){if(e)return[qe.Translate.toString(e),qe.Scale.toString(e)].join(" ")}},Transition:{toString(e){let{property:t,duration:n,easing:r}=e;return t+" "+n+"ms "+r}}}),Ce="a,frame,iframe,input:not([type=hidden]):not(:disabled),select:not(:disabled),textarea:not(:disabled),button:not(:disabled),*[tabindex]";function ke(e){return e.matches(Ce)?e:e.querySelector(Ce)}const De={display:"none"};function Ie(e){let{id:t,value:r}=e;return n.createElement("div",{id:t,style:De},r)}function Me(e){let{id:t,announcement:r,ariaLiveType:a="assertive"}=e;return n.createElement("div",{id:t,style:{position:"fixed",top:0,left:0,width:1,height:1,margin:-1,border:0,padding:0,overflow:"hidden",clip:"rect(0 0 0 0)",clipPath:"inset(100%)",whiteSpace:"nowrap"},role:"status","aria-live":a,"aria-atomic":!0},r)}const Re=t.createContext(null);const $e={draggable:"\n    To pick up a draggable item, press the space bar.\n    While dragging, use the arrow keys to move the item.\n    Press space again to drop the item in its new position, or press escape to cancel.\n  "},Ee={onDragStart(e){let{active:t}=e;return"Picked up draggable item "+t.id+"."},onDragOver(e){let{active:t,over:n}=e;return n?"Draggable item "+t.id+" was moved over droppable area "+n.id+".":"Draggable item "+t.id+" is no longer over a droppable area."},onDragEnd(e){let{active:t,over:n}=e;return n?"Draggable item "+t.id+" was dropped over droppable area "+n.id:"Draggable item "+t.id+" was dropped."},onDragCancel(e){let{active:t}=e;return"Dragging was cancelled. Draggable item "+t.id+" was dropped."}};function Te(e){let{announcements:a=Ee,container:i,hiddenTextDescribedById:s,screenReaderInstructions:c=$e}=e;const{announce:o,announcement:l}=function(){const[e,n]=t.useState("");return{announce:t.useCallback(e=>{null!=e&&n(e)},[]),announcement:e}}(),d=be("DndLiveRegion"),[u,m]=t.useState(!1);if(t.useEffect(()=>{m(!0)},[]),function(e){const n=t.useContext(Re);t.useEffect(()=>{if(!n)throw new Error("useDndMonitor must be used within a children of <DndContext>");return n(e)},[e,n])}(t.useMemo(()=>({onDragStart(e){let{active:t}=e;o(a.onDragStart({active:t}))},onDragMove(e){let{active:t,over:n}=e;a.onDragMove&&o(a.onDragMove({active:t,over:n}))},onDragOver(e){let{active:t,over:n}=e;o(a.onDragOver({active:t,over:n}))},onDragEnd(e){let{active:t,over:n}=e;o(a.onDragEnd({active:t,over:n}))},onDragCancel(e){let{active:t,over:n}=e;o(a.onDragCancel({active:t,over:n}))}}),[o,a])),!u)return null;const h=n.createElement(n.Fragment,null,n.createElement(Ie,{id:s,value:c.draggable}),n.createElement(Me,{id:d,announcement:l}));return i?r.createPortal(h,i):h}var Oe,Pe;function Ae(){}(Pe=Oe||(Oe={})).DragStart="dragStart",Pe.DragMove="dragMove",Pe.DragEnd="dragEnd",Pe.DragCancel="dragCancel",Pe.DragOver="dragOver",Pe.RegisterDroppable="registerDroppable",Pe.SetDroppableDisabled="setDroppableDisabled",Pe.UnregisterDroppable="unregisterDroppable";const We=Object.freeze({x:0,y:0});function Fe(e,t){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}function Le(e,t){let{data:{value:n}}=e,{data:{value:r}}=t;return n-r}function ze(e,t){let{data:{value:n}}=e,{data:{value:r}}=t;return r-n}function Ue(e,t,n){return void 0===t&&(t=e.left),void 0===n&&(n=e.top),{x:t+.5*e.width,y:n+.5*e.height}}const Be=e=>{let{collisionRect:t,droppableRects:n,droppableContainers:r}=e;const a=Ue(t,t.left,t.top),i=[];for(const s of r){const{id:e}=s,t=n.get(e);if(t){const n=Fe(Ue(t),a);i.push({id:e,data:{droppableContainer:s,value:n}})}}return i.sort(Le)};function Ke(e,t){const n=Math.max(t.top,e.top),r=Math.max(t.left,e.left),a=Math.min(t.left+t.width,e.left+e.width),i=Math.min(t.top+t.height,e.top+e.height),s=a-r,c=i-n;if(r<a&&n<i){const n=t.width*t.height,r=e.width*e.height,a=s*c;return Number((a/(n+r-a)).toFixed(4))}return 0}const Ve=e=>{let{collisionRect:t,droppableRects:n,droppableContainers:r}=e;const a=[];for(const i of r){const{id:e}=i,r=n.get(e);if(r){const n=Ke(r,t);n>0&&a.push({id:e,data:{droppableContainer:i,value:n}})}}return a.sort(ze)};function He(e,t){return e&&t?{x:e.left-t.left,y:e.top-t.top}:We}function Ye(e){return function(t){for(var n=arguments.length,r=new Array(n>1?n-1:0),a=1;a<n;a++)r[a-1]=arguments[a];return r.reduce((t,n)=>({...t,top:t.top+e*n.y,bottom:t.bottom+e*n.y,left:t.left+e*n.x,right:t.right+e*n.x}),{...t})}}const Qe=Ye(1);const Xe={ignoreTransform:!1};function Je(e,t){void 0===t&&(t=Xe);let n=e.getBoundingClientRect();if(t.ignoreTransform){const{transform:t,transformOrigin:r}=oe(e).getComputedStyle(e);t&&(n=function(e,t,n){const r=function(e){if(e.startsWith("matrix3d(")){const t=e.slice(9,-1).split(/, /);return{x:+t[12],y:+t[13],scaleX:+t[0],scaleY:+t[5]}}if(e.startsWith("matrix(")){const t=e.slice(7,-1).split(/, /);return{x:+t[4],y:+t[5],scaleX:+t[0],scaleY:+t[3]}}return null}(t);if(!r)return e;const{scaleX:a,scaleY:i,x:s,y:c}=r,o=e.left-s-(1-a)*parseFloat(n),l=e.top-c-(1-i)*parseFloat(n.slice(n.indexOf(" ")+1)),d=a?e.width/a:e.width,u=i?e.height/i:e.height;return{width:d,height:u,top:l,right:o+d,bottom:l+u,left:o}}(n,t,r))}const{top:r,left:a,width:i,height:s,bottom:c,right:o}=n;return{top:r,left:a,width:i,height:s,bottom:c,right:o}}function Ge(e){return Je(e,{ignoreTransform:!0})}function Ze(e,t){const n=[];return e?function r(a){if(null!=t&&n.length>=t)return n;if(!a)return n;if(le(a)&&null!=a.scrollingElement&&!n.includes(a.scrollingElement))return n.push(a.scrollingElement),n;if(!de(a)||ue(a))return n;if(n.includes(a))return n;const i=oe(e).getComputedStyle(a);return a!==e&&function(e,t){void 0===t&&(t=oe(e).getComputedStyle(e));const n=/(auto|scroll|overlay)/;return["overflow","overflowX","overflowY"].some(e=>{const r=t[e];return"string"==typeof r&&n.test(r)})}(a,i)&&n.push(a),function(e,t){return void 0===t&&(t=oe(e).getComputedStyle(e)),"fixed"===t.position}(a,i)?n:r(a.parentNode)}(e):n}function et(e){const[t]=Ze(e,1);return null!=t?t:null}function tt(e){return ie&&e?se(e)?e:ce(e)?le(e)||e===me(e).scrollingElement?window:de(e)?e:null:null:null}function nt(e){return se(e)?e.scrollX:e.scrollLeft}function rt(e){return se(e)?e.scrollY:e.scrollTop}function at(e){return{x:nt(e),y:rt(e)}}var it,st;function ct(e){return!(!ie||!e)&&e===document.scrollingElement}function ot(e){const t={x:0,y:0},n=ct(e)?{height:window.innerHeight,width:window.innerWidth}:{height:e.clientHeight,width:e.clientWidth},r={x:e.scrollWidth-n.width,y:e.scrollHeight-n.height};return{isTop:e.scrollTop<=t.y,isLeft:e.scrollLeft<=t.x,isBottom:e.scrollTop>=r.y,isRight:e.scrollLeft>=r.x,maxScroll:r,minScroll:t}}(st=it||(it={}))[st.Forward=1]="Forward",st[st.Backward=-1]="Backward";const lt={x:.2,y:.2};function dt(e,t,n,r,a){let{top:i,left:s,right:c,bottom:o}=n;void 0===r&&(r=10),void 0===a&&(a=lt);const{isTop:l,isBottom:d,isLeft:u,isRight:m}=ot(e),h={x:0,y:0},p={x:0,y:0},_=t.height*a.y,g=t.width*a.x;return!l&&i<=t.top+_?(h.y=it.Backward,p.y=r*Math.abs((t.top+_-i)/_)):!d&&o>=t.bottom-_&&(h.y=it.Forward,p.y=r*Math.abs((t.bottom-_-o)/_)),!m&&c>=t.right-g?(h.x=it.Forward,p.x=r*Math.abs((t.right-g-c)/g)):!u&&s<=t.left+g&&(h.x=it.Backward,p.x=r*Math.abs((t.left+g-s)/g)),{direction:h,speed:p}}function ut(e){if(e===document.scrollingElement){const{innerWidth:e,innerHeight:t}=window;return{top:0,left:0,right:e,bottom:t,width:e,height:t}}const{top:t,left:n,right:r,bottom:a}=e.getBoundingClientRect();return{top:t,left:n,right:r,bottom:a,width:e.clientWidth,height:e.clientHeight}}function mt(e){return e.reduce((e,t)=>we(e,at(t)),We)}const ht=[["x",["left","right"],function(e){return e.reduce((e,t)=>e+nt(t),0)}],["y",["top","bottom"],function(e){return e.reduce((e,t)=>e+rt(t),0)}]];class pt{constructor(e,t){this.rect=void 0,this.width=void 0,this.height=void 0,this.top=void 0,this.bottom=void 0,this.right=void 0,this.left=void 0;const n=Ze(t),r=mt(n);this.rect={...e},this.width=e.width,this.height=e.height;for(const[a,i,s]of ht)for(const e of i)Object.defineProperty(this,e,{get:()=>{const t=s(n),i=r[a]-t;return this.rect[e]+i},enumerable:!0});Object.defineProperty(this,"rect",{enumerable:!1})}}class _t{constructor(e){this.target=void 0,this.listeners=[],this.removeAll=()=>{this.listeners.forEach(e=>{var t;return null==(t=this.target)?void 0:t.removeEventListener(...e)})},this.target=e}add(e,t,n){var r;null==(r=this.target)||r.addEventListener(e,t,n),this.listeners.push([e,t,n])}}function gt(e,t){const n=Math.abs(e.x),r=Math.abs(e.y);return"number"==typeof t?Math.sqrt(n**2+r**2)>t:"x"in t&&"y"in t?n>t.x&&r>t.y:"x"in t?n>t.x:"y"in t&&r>t.y}var ft,vt,xt,bt;function yt(e){e.preventDefault()}function wt(e){e.stopPropagation()}(vt=ft||(ft={})).Click="click",vt.DragStart="dragstart",vt.Keydown="keydown",vt.ContextMenu="contextmenu",vt.Resize="resize",vt.SelectionChange="selectionchange",vt.VisibilityChange="visibilitychange",(bt=xt||(xt={})).Space="Space",bt.Down="ArrowDown",bt.Right="ArrowRight",bt.Left="ArrowLeft",bt.Up="ArrowUp",bt.Esc="Escape",bt.Enter="Enter",bt.Tab="Tab";const Nt={start:[xt.Space,xt.Enter],cancel:[xt.Esc],end:[xt.Space,xt.Enter,xt.Tab]},jt=(e,t)=>{let{currentCoordinates:n}=t;switch(e.code){case xt.Right:return{...n,x:n.x+25};case xt.Left:return{...n,x:n.x-25};case xt.Down:return{...n,y:n.y+25};case xt.Up:return{...n,y:n.y-25}}};class St{constructor(e){this.props=void 0,this.autoScrollEnabled=!1,this.referenceCoordinates=void 0,this.listeners=void 0,this.windowListeners=void 0,this.props=e;const{event:{target:t}}=e;this.props=e,this.listeners=new _t(me(t)),this.windowListeners=new _t(oe(t)),this.handleKeyDown=this.handleKeyDown.bind(this),this.handleCancel=this.handleCancel.bind(this),this.attach()}attach(){this.handleStart(),this.windowListeners.add(ft.Resize,this.handleCancel),this.windowListeners.add(ft.VisibilityChange,this.handleCancel),setTimeout(()=>this.listeners.add(ft.Keydown,this.handleKeyDown))}handleStart(){const{activeNode:e,onStart:t}=this.props,n=e.node.current;n&&function(e,t){if(void 0===t&&(t=Je),!e)return;const{top:n,left:r,bottom:a,right:i}=t(e);et(e)&&(a<=0||i<=0||n>=window.innerHeight||r>=window.innerWidth)&&e.scrollIntoView({block:"center",inline:"center"})}(n),t(We)}handleKeyDown(e){if(je(e)){const{active:t,context:n,options:r}=this.props,{keyboardCodes:a=Nt,coordinateGetter:i=jt,scrollBehavior:s="smooth"}=r,{code:c}=e;if(a.end.includes(c))return void this.handleEnd(e);if(a.cancel.includes(c))return void this.handleCancel(e);const{collisionRect:o}=n.current,l=o?{x:o.left,y:o.top}:We;this.referenceCoordinates||(this.referenceCoordinates=l);const d=i(e,{active:t,context:n.current,currentCoordinates:l});if(d){const t=Ne(d,l),r={x:0,y:0},{scrollableAncestors:a}=n.current;for(const n of a){const a=e.code,{isTop:i,isRight:c,isLeft:o,isBottom:l,maxScroll:u,minScroll:m}=ot(n),h=ut(n),p={x:Math.min(a===xt.Right?h.right-h.width/2:h.right,Math.max(a===xt.Right?h.left:h.left+h.width/2,d.x)),y:Math.min(a===xt.Down?h.bottom-h.height/2:h.bottom,Math.max(a===xt.Down?h.top:h.top+h.height/2,d.y))},_=a===xt.Right&&!c||a===xt.Left&&!o,g=a===xt.Down&&!l||a===xt.Up&&!i;if(_&&p.x!==d.x){const e=n.scrollLeft+t.x,i=a===xt.Right&&e<=u.x||a===xt.Left&&e>=m.x;if(i&&!t.y)return void n.scrollTo({left:e,behavior:s});r.x=i?n.scrollLeft-e:a===xt.Right?n.scrollLeft-u.x:n.scrollLeft-m.x,r.x&&n.scrollBy({left:-r.x,behavior:s});break}if(g&&p.y!==d.y){const e=n.scrollTop+t.y,i=a===xt.Down&&e<=u.y||a===xt.Up&&e>=m.y;if(i&&!t.x)return void n.scrollTo({top:e,behavior:s});r.y=i?n.scrollTop-e:a===xt.Down?n.scrollTop-u.y:n.scrollTop-m.y,r.y&&n.scrollBy({top:-r.y,behavior:s});break}}this.handleMove(e,we(Ne(d,this.referenceCoordinates),r))}}}handleMove(e,t){const{onMove:n}=this.props;e.preventDefault(),n(t)}handleEnd(e){const{onEnd:t}=this.props;e.preventDefault(),this.detach(),t()}handleCancel(e){const{onCancel:t}=this.props;e.preventDefault(),this.detach(),t()}detach(){this.listeners.removeAll(),this.windowListeners.removeAll()}}function qt(e){return Boolean(e&&"distance"in e)}function Ct(e){return Boolean(e&&"delay"in e)}St.activators=[{eventName:"onKeyDown",handler:(e,t,n)=>{let{keyboardCodes:r=Nt,onActivation:a}=t,{active:i}=n;const{code:s}=e.nativeEvent;if(r.start.includes(s)){const t=i.activatorNode.current;return(!t||e.target===t)&&(e.preventDefault(),null==a||a({event:e.nativeEvent}),!0)}return!1}}];class kt{constructor(e,t,n){var r;void 0===n&&(n=function(e){const{EventTarget:t}=oe(e);return e instanceof t?e:me(e)}(e.event.target)),this.props=void 0,this.events=void 0,this.autoScrollEnabled=!0,this.document=void 0,this.activated=!1,this.initialCoordinates=void 0,this.timeoutId=null,this.listeners=void 0,this.documentListeners=void 0,this.windowListeners=void 0,this.props=e,this.events=t;const{event:a}=e,{target:i}=a;this.props=e,this.events=t,this.document=me(i),this.documentListeners=new _t(this.document),this.listeners=new _t(n),this.windowListeners=new _t(oe(i)),this.initialCoordinates=null!=(r=Se(a))?r:We,this.handleStart=this.handleStart.bind(this),this.handleMove=this.handleMove.bind(this),this.handleEnd=this.handleEnd.bind(this),this.handleCancel=this.handleCancel.bind(this),this.handleKeydown=this.handleKeydown.bind(this),this.removeTextSelection=this.removeTextSelection.bind(this),this.attach()}attach(){const{events:e,props:{options:{activationConstraint:t,bypassActivationConstraint:n}}}=this;if(this.listeners.add(e.move.name,this.handleMove,{passive:!1}),this.listeners.add(e.end.name,this.handleEnd),e.cancel&&this.listeners.add(e.cancel.name,this.handleCancel),this.windowListeners.add(ft.Resize,this.handleCancel),this.windowListeners.add(ft.DragStart,yt),this.windowListeners.add(ft.VisibilityChange,this.handleCancel),this.windowListeners.add(ft.ContextMenu,yt),this.documentListeners.add(ft.Keydown,this.handleKeydown),t){if(null!=n&&n({event:this.props.event,activeNode:this.props.activeNode,options:this.props.options}))return this.handleStart();if(Ct(t))return this.timeoutId=setTimeout(this.handleStart,t.delay),void this.handlePending(t);if(qt(t))return void this.handlePending(t)}this.handleStart()}detach(){this.listeners.removeAll(),this.windowListeners.removeAll(),setTimeout(this.documentListeners.removeAll,50),null!==this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}handlePending(e,t){const{active:n,onPending:r}=this.props;r(n,e,this.initialCoordinates,t)}handleStart(){const{initialCoordinates:e}=this,{onStart:t}=this.props;e&&(this.activated=!0,this.documentListeners.add(ft.Click,wt,{capture:!0}),this.removeTextSelection(),this.documentListeners.add(ft.SelectionChange,this.removeTextSelection),t(e))}handleMove(e){var t;const{activated:n,initialCoordinates:r,props:a}=this,{onMove:i,options:{activationConstraint:s}}=a;if(!r)return;const c=null!=(t=Se(e))?t:We,o=Ne(r,c);if(!n&&s){if(qt(s)){if(null!=s.tolerance&&gt(o,s.tolerance))return this.handleCancel();if(gt(o,s.distance))return this.handleStart()}return Ct(s)&&gt(o,s.tolerance)?this.handleCancel():void this.handlePending(s,o)}e.cancelable&&e.preventDefault(),i(c)}handleEnd(){const{onAbort:e,onEnd:t}=this.props;this.detach(),this.activated||e(this.props.active),t()}handleCancel(){const{onAbort:e,onCancel:t}=this.props;this.detach(),this.activated||e(this.props.active),t()}handleKeydown(e){e.code===xt.Esc&&this.handleCancel()}removeTextSelection(){var e;null==(e=this.document.getSelection())||e.removeAllRanges()}}const Dt={cancel:{name:"pointercancel"},move:{name:"pointermove"},end:{name:"pointerup"}};class It extends kt{constructor(e){const{event:t}=e,n=me(t.target);super(e,Dt,n)}}It.activators=[{eventName:"onPointerDown",handler:(e,t)=>{let{nativeEvent:n}=e,{onActivation:r}=t;return!(!n.isPrimary||0!==n.button)&&(null==r||r({event:n}),!0)}}];const Mt={move:{name:"mousemove"},end:{name:"mouseup"}};var Rt,$t;($t=Rt||(Rt={}))[$t.RightClick=2]="RightClick";(class extends kt{constructor(e){super(e,Mt,me(e.event.target))}}).activators=[{eventName:"onMouseDown",handler:(e,t)=>{let{nativeEvent:n}=e,{onActivation:r}=t;return n.button!==Rt.RightClick&&(null==r||r({event:n}),!0)}}];const Et={cancel:{name:"touchcancel"},move:{name:"touchmove"},end:{name:"touchend"}};var Tt,Ot,Pt,At;function Wt(e){let{acceleration:n,activator:r=Tt.Pointer,canScroll:a,draggingRect:i,enabled:s,interval:c=5,order:o=Pt.TreeOrder,pointerCoordinates:l,scrollableAncestors:d,scrollableAncestorRects:u,delta:m,threshold:h}=e;const p=function(e){let{delta:t,disabled:n}=e;const r=ve(t);return ge(e=>{if(n||!r||!e)return Ft;const a={x:Math.sign(t.x-r.x),y:Math.sign(t.y-r.y)};return{x:{[it.Backward]:e.x[it.Backward]||-1===a.x,[it.Forward]:e.x[it.Forward]||1===a.x},y:{[it.Backward]:e.y[it.Backward]||-1===a.y,[it.Forward]:e.y[it.Forward]||1===a.y}}},[n,t,r])}({delta:m,disabled:!s}),[_,g]=function(){const e=t.useRef(null);return[t.useCallback((t,n)=>{e.current=setInterval(t,n)},[]),t.useCallback(()=>{null!==e.current&&(clearInterval(e.current),e.current=null)},[])]}(),f=t.useRef({x:0,y:0}),v=t.useRef({x:0,y:0}),x=t.useMemo(()=>{switch(r){case Tt.Pointer:return l?{top:l.y,bottom:l.y,left:l.x,right:l.x}:null;case Tt.DraggableRect:return i}},[r,i,l]),b=t.useRef(null),y=t.useCallback(()=>{const e=b.current;if(!e)return;const t=f.current.x*v.current.x,n=f.current.y*v.current.y;e.scrollBy(t,n)},[]),w=t.useMemo(()=>o===Pt.TreeOrder?[...d].reverse():d,[o,d]);t.useEffect(()=>{if(s&&d.length&&x){for(const e of w){if(!1===(null==a?void 0:a(e)))continue;const t=d.indexOf(e),r=u[t];if(!r)continue;const{direction:i,speed:s}=dt(e,r,x,n,h);for(const e of["x","y"])p[e][i[e]]||(s[e]=0,i[e]=0);if(s.x>0||s.y>0)return g(),b.current=e,_(y,c),f.current=s,void(v.current=i)}f.current={x:0,y:0},v.current={x:0,y:0},g()}else g()},[n,y,a,g,s,c,JSON.stringify(x),JSON.stringify(p),_,d,w,u,JSON.stringify(h)])}(class extends kt{constructor(e){super(e,Et)}static setup(){return window.addEventListener(Et.move.name,e,{capture:!1,passive:!1}),function(){window.removeEventListener(Et.move.name,e)};function e(){}}}).activators=[{eventName:"onTouchStart",handler:(e,t)=>{let{nativeEvent:n}=e,{onActivation:r}=t;const{touches:a}=n;return!(a.length>1)&&(null==r||r({event:n}),!0)}}],(Ot=Tt||(Tt={}))[Ot.Pointer=0]="Pointer",Ot[Ot.DraggableRect=1]="DraggableRect",(At=Pt||(Pt={}))[At.TreeOrder=0]="TreeOrder",At[At.ReversedTreeOrder=1]="ReversedTreeOrder";const Ft={x:{[it.Backward]:!1,[it.Forward]:!1},y:{[it.Backward]:!1,[it.Forward]:!1}};var Lt,zt,Ut;(zt=Lt||(Lt={}))[zt.Always=0]="Always",zt[zt.BeforeDragging=1]="BeforeDragging",zt[zt.WhileDragging=2]="WhileDragging",(Ut||(Ut={})).Optimized="optimized";const Bt=new Map;function Kt(e,t){return ge(n=>e?n||("function"==typeof t?t(e):e):null,[t,e])}function Vt(e){let{callback:n,disabled:r}=e;const a=pe(n),i=t.useMemo(()=>{if(r||"undefined"==typeof window||void 0===window.ResizeObserver)return;const{ResizeObserver:e}=window;return new e(a)},[r]);return t.useEffect(()=>()=>null==i?void 0:i.disconnect(),[i]),i}function Ht(e){return new pt(Je(e),e)}function Yt(e,n,r){void 0===n&&(n=Ht);const[a,i]=t.useState(null);function s(){i(t=>{if(!e)return null;var a;if(!1===e.isConnected)return null!=(a=null!=t?t:r)?a:null;const i=n(e);return JSON.stringify(t)===JSON.stringify(i)?t:i})}const c=function(e){let{callback:n,disabled:r}=e;const a=pe(n),i=t.useMemo(()=>{if(r||"undefined"==typeof window||void 0===window.MutationObserver)return;const{MutationObserver:e}=window;return new e(a)},[a,r]);return t.useEffect(()=>()=>null==i?void 0:i.disconnect(),[i]),i}({callback(t){if(e)for(const n of t){const{type:t,target:r}=n;if("childList"===t&&r instanceof HTMLElement&&r.contains(e)){s();break}}}}),o=Vt({callback:s});return he(()=>{s(),e?(null==o||o.observe(e),null==c||c.observe(document.body,{childList:!0,subtree:!0})):(null==o||o.disconnect(),null==c||c.disconnect())},[e]),a}const Qt=[];function Xt(e,n){void 0===n&&(n=[]);const r=t.useRef(null);return t.useEffect(()=>{r.current=null},n),t.useEffect(()=>{const t=e!==We;t&&!r.current&&(r.current=e),!t&&r.current&&(r.current=null)},[e]),r.current?Ne(e,r.current):We}function Jt(e){return t.useMemo(()=>e?function(e){const t=e.innerWidth,n=e.innerHeight;return{top:0,left:0,right:t,bottom:n,width:t,height:n}}(e):null,[e])}const Gt=[];function Zt(e){let{measure:n}=e;const[r,a]=t.useState(null),i=Vt({callback:t.useCallback(e=>{for(const{target:t}of e)if(de(t)){a(e=>{const r=n(t);return e?{...e,width:r.width,height:r.height}:r});break}},[n])}),s=t.useCallback(e=>{const t=function(e){if(!e)return null;if(e.children.length>1)return e;const t=e.children[0];return de(t)?t:e}(e);null==i||i.disconnect(),t&&(null==i||i.observe(t)),a(t?n(t):null)},[n,i]),[c,o]=fe(s);return t.useMemo(()=>({nodeRef:c,rect:r,setRef:o}),[r,c,o])}const en=[{sensor:It,options:{}},{sensor:St,options:{}}],tn={current:{}},nn={draggable:{measure:Ge},droppable:{measure:Ge,strategy:Lt.WhileDragging,frequency:Ut.Optimized},dragOverlay:{measure:Je}};class rn extends Map{get(e){var t;return null!=e&&null!=(t=super.get(e))?t:void 0}toArray(){return Array.from(this.values())}getEnabled(){return this.toArray().filter(e=>{let{disabled:t}=e;return!t})}getNodeFor(e){var t,n;return null!=(t=null==(n=this.get(e))?void 0:n.node.current)?t:void 0}}const an={activatorEvent:null,active:null,activeNode:null,activeNodeRect:null,collisions:null,containerNodeRect:null,draggableNodes:new Map,droppableRects:new Map,droppableContainers:new rn,over:null,dragOverlay:{nodeRef:{current:null},rect:null,setRef:Ae},scrollableAncestors:[],scrollableAncestorRects:[],measuringConfiguration:nn,measureDroppableContainers:Ae,windowRect:null,measuringScheduled:!1},sn={activatorEvent:null,activators:[],active:null,activeNodeRect:null,ariaDescribedById:{draggable:""},dispatch:Ae,draggableNodes:new Map,over:null,measureDroppableContainers:Ae},cn=t.createContext(sn),on=t.createContext(an);function ln(){return{draggable:{active:null,initialCoordinates:{x:0,y:0},nodes:new Map,translate:{x:0,y:0}},droppable:{containers:new rn}}}function dn(e,t){switch(t.type){case Oe.DragStart:return{...e,draggable:{...e.draggable,initialCoordinates:t.initialCoordinates,active:t.active}};case Oe.DragMove:return null==e.draggable.active?e:{...e,draggable:{...e.draggable,translate:{x:t.coordinates.x-e.draggable.initialCoordinates.x,y:t.coordinates.y-e.draggable.initialCoordinates.y}}};case Oe.DragEnd:case Oe.DragCancel:return{...e,draggable:{...e.draggable,active:null,initialCoordinates:{x:0,y:0},translate:{x:0,y:0}}};case Oe.RegisterDroppable:{const{element:n}=t,{id:r}=n,a=new rn(e.droppable.containers);return a.set(r,n),{...e,droppable:{...e.droppable,containers:a}}}case Oe.SetDroppableDisabled:{const{id:n,key:r,disabled:a}=t,i=e.droppable.containers.get(n);if(!i||r!==i.key)return e;const s=new rn(e.droppable.containers);return s.set(n,{...i,disabled:a}),{...e,droppable:{...e.droppable,containers:s}}}case Oe.UnregisterDroppable:{const{id:n,key:r}=t,a=e.droppable.containers.get(n);if(!a||r!==a.key)return e;const i=new rn(e.droppable.containers);return i.delete(n),{...e,droppable:{...e.droppable,containers:i}}}default:return e}}function un(e){let{disabled:n}=e;const{active:r,activatorEvent:a,draggableNodes:i}=t.useContext(cn),s=ve(a),c=ve(null==r?void 0:r.id);return t.useEffect(()=>{if(!n&&!a&&s&&null!=c){if(!je(s))return;if(document.activeElement===s.target)return;const e=i.get(c);if(!e)return;const{activatorNode:t,node:n}=e;if(!t.current&&!n.current)return;requestAnimationFrame(()=>{for(const e of[t.current,n.current]){if(!e)continue;const t=ke(e);if(t){t.focus();break}}})}},[a,n,i,c,s]),null}const mn=t.createContext({...We,scaleX:1,scaleY:1});var hn,pn;(pn=hn||(hn={}))[pn.Uninitialized=0]="Uninitialized",pn[pn.Initializing=1]="Initializing",pn[pn.Initialized=2]="Initialized";const _n=t.memo(function(e){var a,i,s,c;let{id:o,accessibility:l,autoScroll:d=!0,children:u,sensors:m=en,collisionDetection:h=Ve,measuring:p,modifiers:_,...g}=e;const f=t.useReducer(dn,void 0,ln),[v,x]=f,[b,y]=function(){const[e]=t.useState(()=>new Set),n=t.useCallback(t=>(e.add(t),()=>e.delete(t)),[e]);return[t.useCallback(t=>{let{type:n,event:r}=t;e.forEach(e=>{var t;return null==(t=e[n])?void 0:t.call(e,r)})},[e]),n]}(),[w,N]=t.useState(hn.Uninitialized),j=w===hn.Initialized,{draggable:{active:S,nodes:q,translate:C},droppable:{containers:k}}=v,D=null!=S?q.get(S):null,I=t.useRef({initial:null,translated:null}),M=t.useMemo(()=>{var e;return null!=S?{id:S,data:null!=(e=null==D?void 0:D.data)?e:tn,rect:I}:null},[S,D]),R=t.useRef(null),[$,E]=t.useState(null),[T,O]=t.useState(null),P=_e(g,Object.values(g)),A=be("DndDescribedBy",o),W=t.useMemo(()=>k.getEnabled(),[k]),F=(L=p,t.useMemo(()=>({draggable:{...nn.draggable,...null==L?void 0:L.draggable},droppable:{...nn.droppable,...null==L?void 0:L.droppable},dragOverlay:{...nn.dragOverlay,...null==L?void 0:L.dragOverlay}}),[null==L?void 0:L.draggable,null==L?void 0:L.droppable,null==L?void 0:L.dragOverlay]));var L;const{droppableRects:z,measureDroppableContainers:U,measuringScheduled:B}=function(e,n){let{dragging:r,dependencies:a,config:i}=n;const[s,c]=t.useState(null),{frequency:o,measure:l,strategy:d}=i,u=t.useRef(e),m=function(){switch(d){case Lt.Always:return!1;case Lt.BeforeDragging:return r;default:return!r}}(),h=_e(m),p=t.useCallback(function(e){void 0===e&&(e=[]),h.current||c(t=>null===t?e:t.concat(e.filter(e=>!t.includes(e))))},[h]),_=t.useRef(null),g=ge(t=>{if(m&&!r)return Bt;if(!t||t===Bt||u.current!==e||null!=s){const t=new Map;for(let n of e){if(!n)continue;if(s&&s.length>0&&!s.includes(n.id)&&n.rect.current){t.set(n.id,n.rect.current);continue}const e=n.node.current,r=e?new pt(l(e),e):null;n.rect.current=r,r&&t.set(n.id,r)}return t}return t},[e,s,r,m,l]);return t.useEffect(()=>{u.current=e},[e]),t.useEffect(()=>{m||p()},[r,m]),t.useEffect(()=>{s&&s.length>0&&c(null)},[JSON.stringify(s)]),t.useEffect(()=>{m||"number"!=typeof o||null!==_.current||(_.current=setTimeout(()=>{p(),_.current=null},o))},[o,m,p,...a]),{droppableRects:g,measureDroppableContainers:p,measuringScheduled:null!=s}}(W,{dragging:j,dependencies:[C.x,C.y],config:F.droppable}),K=function(e,t){const n=null!=t?e.get(t):void 0,r=n?n.node.current:null;return ge(e=>{var n;return null==t?null:null!=(n=null!=r?r:e)?n:null},[r,t])}(q,S),V=t.useMemo(()=>T?Se(T):null,[T]),H=function(){const e=!1===(null==$?void 0:$.autoScrollEnabled),t="object"==typeof d?!1===d.enabled:!1===d,n=j&&!e&&!t;if("object"==typeof d)return{...d,enabled:n};return{enabled:n}}(),Y=function(e,t){return Kt(e,t)}(K,F.draggable.measure);!function(e){let{activeNode:n,measure:r,initialRect:a,config:i=!0}=e;const s=t.useRef(!1),{x:c,y:o}="boolean"==typeof i?{x:i,y:i}:i;he(()=>{if(!c&&!o||!n)return void(s.current=!1);if(s.current||!a)return;const e=null==n?void 0:n.node.current;if(!e||!1===e.isConnected)return;const t=He(r(e),a);if(c||(t.x=0),o||(t.y=0),s.current=!0,Math.abs(t.x)>0||Math.abs(t.y)>0){const n=et(e);n&&n.scrollBy({top:t.y,left:t.x})}},[n,c,o,a,r])}({activeNode:null!=S?q.get(S):null,config:H.layoutShiftCompensation,initialRect:Y,measure:F.draggable.measure});const Q=Yt(K,F.draggable.measure,Y),X=Yt(K?K.parentElement:null),J=t.useRef({activatorEvent:null,active:null,activeNode:K,collisionRect:null,collisions:null,droppableRects:z,draggableNodes:q,draggingNode:null,draggingNodeRect:null,droppableContainers:k,over:null,scrollableAncestors:[],scrollAdjustedTranslate:null}),G=k.getNodeFor(null==(a=J.current.over)?void 0:a.id),Z=Zt({measure:F.dragOverlay.measure}),ee=null!=(i=Z.nodeRef.current)?i:K,te=j?null!=(s=Z.rect)?s:Q:null,ne=Boolean(Z.nodeRef.current&&Z.rect),re=He(ae=ne?null:Q,Kt(ae));var ae;const se=Jt(ee?oe(ee):null),ce=function(e){const n=t.useRef(e),r=ge(t=>e?t&&t!==Qt&&e&&n.current&&e.parentNode===n.current.parentNode?t:Ze(e):Qt,[e]);return t.useEffect(()=>{n.current=e},[e]),r}(j?null!=G?G:K:null),le=function(e,n){void 0===n&&(n=Je);const[r]=e,a=Jt(r?oe(r):null),[i,s]=t.useState(Gt);function c(){s(()=>e.length?e.map(e=>ct(e)?a:new pt(n(e),e)):Gt)}const o=Vt({callback:c});return he(()=>{null==o||o.disconnect(),c(),e.forEach(e=>null==o?void 0:o.observe(e))},[e]),i}(ce),de=function(e,t){let{transform:n,...r}=t;return null!=e&&e.length?e.reduce((e,t)=>t({transform:e,...r}),n):n}(_,{transform:{x:C.x-re.x,y:C.y-re.y,scaleX:1,scaleY:1},activatorEvent:T,active:M,activeNodeRect:Q,containerNodeRect:X,draggingNodeRect:te,over:J.current.over,overlayNodeRect:Z.rect,scrollableAncestors:ce,scrollableAncestorRects:le,windowRect:se}),ue=V?we(V,C):null,me=function(e){const[n,r]=t.useState(null),a=t.useRef(e),i=t.useCallback(e=>{const t=tt(e.target);t&&r(e=>e?(e.set(t,at(t)),new Map(e)):null)},[]);return t.useEffect(()=>{const t=a.current;if(e!==t){n(t);const s=e.map(e=>{const t=tt(e);return t?(t.addEventListener("scroll",i,{passive:!0}),[t,at(t)]):null}).filter(e=>null!=e);r(s.length?new Map(s):null),a.current=e}return()=>{n(e),n(t)};function n(e){e.forEach(e=>{const t=tt(e);null==t||t.removeEventListener("scroll",i)})}},[i,e]),t.useMemo(()=>e.length?n?Array.from(n.values()).reduce((e,t)=>we(e,t),We):mt(e):We,[e,n])}(ce),pe=Xt(me),fe=Xt(me,[Q]),ve=we(de,pe),xe=te?Qe(te,de):null,ye=M&&xe?h({active:M,collisionRect:xe,droppableRects:z,droppableContainers:W,pointerCoordinates:ue}):null,Ne=function(e,t){if(!e||0===e.length)return null;const[n]=e;return n[t]}(ye,"id"),[je,qe]=t.useState(null),Ce=function(e,t,n){return{...e,scaleX:t&&n?t.width/n.width:1,scaleY:t&&n?t.height/n.height:1}}(ne?de:we(de,fe),null!=(c=null==je?void 0:je.rect)?c:null,Q),ke=t.useRef(null),De=t.useCallback((e,t)=>{let{sensor:n,options:a}=t;if(null==R.current)return;const i=q.get(R.current);if(!i)return;const s=e.nativeEvent,c=new n({active:R.current,activeNode:i,event:s,options:a,context:J,onAbort(e){if(!q.get(e))return;const{onDragAbort:t}=P.current,n={id:e};null==t||t(n),b({type:"onDragAbort",event:n})},onPending(e,t,n,r){if(!q.get(e))return;const{onDragPending:a}=P.current,i={id:e,constraint:t,initialCoordinates:n,offset:r};null==a||a(i),b({type:"onDragPending",event:i})},onStart(e){const t=R.current;if(null==t)return;const n=q.get(t);if(!n)return;const{onDragStart:a}=P.current,i={activatorEvent:s,active:{id:t,data:n.data,rect:I}};r.unstable_batchedUpdates(()=>{null==a||a(i),N(hn.Initializing),x({type:Oe.DragStart,initialCoordinates:e,active:t}),b({type:"onDragStart",event:i}),E(ke.current),O(s)})},onMove(e){x({type:Oe.DragMove,coordinates:e})},onEnd:o(Oe.DragEnd),onCancel:o(Oe.DragCancel)});function o(e){return async function(){const{active:t,collisions:n,over:a,scrollAdjustedTranslate:i}=J.current;let c=null;if(t&&i){const{cancelDrop:r}=P.current;if(c={activatorEvent:s,active:t,collisions:n,delta:i,over:a},e===Oe.DragEnd&&"function"==typeof r){await Promise.resolve(r(c))&&(e=Oe.DragCancel)}}R.current=null,r.unstable_batchedUpdates(()=>{x({type:e}),N(hn.Uninitialized),qe(null),E(null),O(null),ke.current=null;const t=e===Oe.DragEnd?"onDragEnd":"onDragCancel";if(c){const e=P.current[t];null==e||e(c),b({type:t,event:c})}})}}ke.current=c},[q]),Ie=function(e,n){return t.useMemo(()=>e.reduce((e,t)=>{const{sensor:r}=t;return[...e,...r.activators.map(e=>({eventName:e.eventName,handler:n(e.handler,t)}))]},[]),[e,n])}(m,t.useCallback((e,t)=>(n,r)=>{const a=n.nativeEvent,i=q.get(r);if(null!==R.current||!i||a.dndKit||a.defaultPrevented)return;const s={active:i};!0===e(n,t.options,s)&&(a.dndKit={capturedBy:t.sensor},R.current=r,De(n,t))},[q,De]));!function(e){t.useEffect(()=>{if(!ie)return;const t=e.map(e=>{let{sensor:t}=e;return null==t.setup?void 0:t.setup()});return()=>{for(const e of t)null==e||e()}},e.map(e=>{let{sensor:t}=e;return t}))}(m),he(()=>{Q&&w===hn.Initializing&&N(hn.Initialized)},[Q,w]),t.useEffect(()=>{const{onDragMove:e}=P.current,{active:t,activatorEvent:n,collisions:a,over:i}=J.current;if(!t||!n)return;const s={active:t,activatorEvent:n,collisions:a,delta:{x:ve.x,y:ve.y},over:i};r.unstable_batchedUpdates(()=>{null==e||e(s),b({type:"onDragMove",event:s})})},[ve.x,ve.y]),t.useEffect(()=>{const{active:e,activatorEvent:t,collisions:n,droppableContainers:a,scrollAdjustedTranslate:i}=J.current;if(!e||null==R.current||!t||!i)return;const{onDragOver:s}=P.current,c=a.get(Ne),o=c&&c.rect.current?{id:c.id,rect:c.rect.current,data:c.data,disabled:c.disabled}:null,l={active:e,activatorEvent:t,collisions:n,delta:{x:i.x,y:i.y},over:o};r.unstable_batchedUpdates(()=>{qe(o),null==s||s(l),b({type:"onDragOver",event:l})})},[Ne]),he(()=>{J.current={activatorEvent:T,active:M,activeNode:K,collisionRect:xe,collisions:ye,droppableRects:z,draggableNodes:q,draggingNode:ee,draggingNodeRect:te,droppableContainers:k,over:je,scrollableAncestors:ce,scrollAdjustedTranslate:ve},I.current={initial:te,translated:xe}},[M,K,ye,xe,q,ee,te,z,k,je,ce,ve]),Wt({...H,delta:C,draggingRect:xe,pointerCoordinates:ue,scrollableAncestors:ce,scrollableAncestorRects:le});const Me=t.useMemo(()=>({active:M,activeNode:K,activeNodeRect:Q,activatorEvent:T,collisions:ye,containerNodeRect:X,dragOverlay:Z,draggableNodes:q,droppableContainers:k,droppableRects:z,over:je,measureDroppableContainers:U,scrollableAncestors:ce,scrollableAncestorRects:le,measuringConfiguration:F,measuringScheduled:B,windowRect:se}),[M,K,Q,T,ye,X,Z,q,k,z,je,U,ce,le,F,B,se]),$e=t.useMemo(()=>({activatorEvent:T,activators:Ie,active:M,activeNodeRect:Q,ariaDescribedById:{draggable:A},dispatch:x,draggableNodes:q,over:je,measureDroppableContainers:U}),[T,Ie,M,Q,x,A,q,je,U]);return n.createElement(Re.Provider,{value:y},n.createElement(cn.Provider,{value:$e},n.createElement(on.Provider,{value:Me},n.createElement(mn.Provider,{value:Ce},u)),n.createElement(un,{disabled:!1===(null==l?void 0:l.restoreFocus)})),n.createElement(Te,{...l,hiddenTextDescribedById:A}))}),gn=t.createContext(null),fn="button";function vn(e){let{id:n,data:r,disabled:a=!1,attributes:i}=e;const s=be("Draggable"),{activators:c,activatorEvent:o,active:l,activeNodeRect:d,ariaDescribedById:u,draggableNodes:m,over:h}=t.useContext(cn),{role:p=fn,roleDescription:_="draggable",tabIndex:g=0}=null!=i?i:{},f=(null==l?void 0:l.id)===n,v=t.useContext(f?mn:gn),[x,b]=fe(),[y,w]=fe(),N=function(e,n){return t.useMemo(()=>e.reduce((e,t)=>{let{eventName:r,handler:a}=t;return e[r]=e=>{a(e,n)},e},{}),[e,n])}(c,n),j=_e(r);he(()=>(m.set(n,{id:n,key:s,node:x,activatorNode:y,data:j}),()=>{const e=m.get(n);e&&e.key===s&&m.delete(n)}),[m,n]);return{active:l,activatorEvent:o,activeNodeRect:d,attributes:t.useMemo(()=>({role:p,tabIndex:g,"aria-disabled":a,"aria-pressed":!(!f||p!==fn)||void 0,"aria-roledescription":_,"aria-describedby":u.draggable}),[a,p,g,f,_,u.draggable]),isDragging:f,listeners:a?void 0:N,node:x,over:h,setNodeRef:b,setActivatorNodeRef:w,transform:v}}const xn={timeout:25};function bn(e,t,n){const r=e.slice();return r.splice(n<0?r.length+n:n,0,r.splice(t,1)[0]),r}function yn(e,t){return e.reduce((e,n,r)=>{const a=t.get(n);return a&&(e[r]=a),e},Array(e.length))}function wn(e){return null!==e&&e>=0}const Nn=e=>{let{rects:t,activeIndex:n,overIndex:r,index:a}=e;const i=bn(t,r,n),s=t[a],c=i[a];return c&&s?{x:c.left-s.left,y:c.top-s.top,scaleX:c.width/s.width,scaleY:c.height/s.height}:null},jn={scaleX:1,scaleY:1},Sn=e=>{var t;let{activeIndex:n,activeNodeRect:r,index:a,rects:i,overIndex:s}=e;const c=null!=(t=i[n])?t:r;if(!c)return null;if(a===n){const e=i[s];return e?{x:0,y:n<s?e.top+e.height-(c.top+c.height):e.top-c.top,...jn}:null}const o=function(e,t,n){const r=e[t],a=e[t-1],i=e[t+1];if(!r)return 0;if(n<t)return a?r.top-(a.top+a.height):i?i.top-(r.top+r.height):0;return i?i.top-(r.top+r.height):a?r.top-(a.top+a.height):0}(i,a,n);return a>n&&a<=s?{x:0,y:-c.height-o,...jn}:a<n&&a>=s?{x:0,y:c.height+o,...jn}:{x:0,y:0,...jn}};const qn="Sortable",Cn=n.createContext({activeIndex:-1,containerId:qn,disableTransforms:!1,items:[],overIndex:-1,useDragOverlay:!1,sortedRects:[],strategy:Nn,disabled:{draggable:!1,droppable:!1}});function kn(e){let{children:r,id:a,items:i,strategy:s=Nn,disabled:c=!1}=e;const{active:o,dragOverlay:l,droppableRects:d,over:u,measureDroppableContainers:m}=t.useContext(on),h=be(qn,a),p=Boolean(null!==l.rect),_=t.useMemo(()=>i.map(e=>"object"==typeof e&&"id"in e?e.id:e),[i]),g=null!=o,f=o?_.indexOf(o.id):-1,v=u?_.indexOf(u.id):-1,x=t.useRef(_),b=!function(e,t){if(e===t)return!0;if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}(_,x.current),y=-1!==v&&-1===f||b,w=function(e){return"boolean"==typeof e?{draggable:e,droppable:e}:e}(c);he(()=>{b&&g&&m(_)},[b,_,g,m]),t.useEffect(()=>{x.current=_},[_]);const N=t.useMemo(()=>({activeIndex:f,containerId:h,disabled:w,disableTransforms:y,items:_,overIndex:v,useDragOverlay:p,sortedRects:yn(_,d),strategy:s}),[f,h,w.draggable,w.droppable,y,_,v,d,p,s]);return n.createElement(Cn.Provider,{value:N},r)}const Dn=e=>{let{id:t,items:n,activeIndex:r,overIndex:a}=e;return bn(n,r,a).indexOf(t)},In=e=>{let{containerId:t,isSorting:n,wasDragging:r,index:a,items:i,newIndex:s,previousItems:c,previousContainerId:o,transition:l}=e;return!(!l||!r)&&((c===i||a!==s)&&(!!n||s!==a&&t===o))},Mn={duration:200,easing:"ease"},Rn="transform",$n=qe.Transition.toString({property:Rn,duration:0,easing:"linear"}),En={roleDescription:"sortable"};function Tn(e){let{animateLayoutChanges:n=In,attributes:r,disabled:a,data:i,getNewIndex:s=Dn,id:c,strategy:o,resizeObserverConfig:l,transition:d=Mn}=e;const{items:u,containerId:m,activeIndex:h,disabled:p,disableTransforms:_,sortedRects:g,overIndex:f,useDragOverlay:v,strategy:x}=t.useContext(Cn),b=function(e,t){var n,r;if("boolean"==typeof e)return{draggable:e,droppable:!1};return{draggable:null!=(n=null==e?void 0:e.draggable)?n:t.draggable,droppable:null!=(r=null==e?void 0:e.droppable)?r:t.droppable}}(a,p),y=u.indexOf(c),w=t.useMemo(()=>({sortable:{containerId:m,index:y,items:u},...i}),[m,i,y,u]),N=t.useMemo(()=>u.slice(u.indexOf(c)),[u,c]),{rect:j,node:S,isOver:q,setNodeRef:C}=function(e){let{data:n,disabled:r=!1,id:a,resizeObserverConfig:i}=e;const s=be("Droppable"),{active:c,dispatch:o,over:l,measureDroppableContainers:d}=t.useContext(cn),u=t.useRef({disabled:r}),m=t.useRef(!1),h=t.useRef(null),p=t.useRef(null),{disabled:_,updateMeasurementsFor:g,timeout:f}={...xn,...i},v=_e(null!=g?g:a),x=Vt({callback:t.useCallback(()=>{m.current?(null!=p.current&&clearTimeout(p.current),p.current=setTimeout(()=>{d(Array.isArray(v.current)?v.current:[v.current]),p.current=null},f)):m.current=!0},[f]),disabled:_||!c}),b=t.useCallback((e,t)=>{x&&(t&&(x.unobserve(t),m.current=!1),e&&x.observe(e))},[x]),[y,w]=fe(b),N=_e(n);return t.useEffect(()=>{x&&y.current&&(x.disconnect(),m.current=!1,x.observe(y.current))},[y,x]),t.useEffect(()=>(o({type:Oe.RegisterDroppable,element:{id:a,key:s,disabled:r,node:y,rect:h,data:N}}),()=>o({type:Oe.UnregisterDroppable,key:s,id:a})),[a]),t.useEffect(()=>{r!==u.current.disabled&&(o({type:Oe.SetDroppableDisabled,id:a,key:s,disabled:r}),u.current.disabled=r)},[a,s,r,o]),{active:c,rect:h,isOver:(null==l?void 0:l.id)===a,node:y,over:l,setNodeRef:w}}({id:c,data:w,disabled:b.droppable,resizeObserverConfig:{updateMeasurementsFor:N,...l}}),{active:k,activatorEvent:D,activeNodeRect:I,attributes:M,setNodeRef:R,listeners:$,isDragging:E,over:T,setActivatorNodeRef:O,transform:P}=vn({id:c,data:w,attributes:{...En,...r},disabled:b.draggable}),A=function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return t.useMemo(()=>e=>{n.forEach(t=>t(e))},n)}(C,R),W=Boolean(k),F=W&&!_&&wn(h)&&wn(f),L=!v&&E,z=L&&F?P:null,U=F?null!=z?z:(null!=o?o:x)({rects:g,activeNodeRect:I,activeIndex:h,overIndex:f,index:y}):null,B=wn(h)&&wn(f)?s({id:c,items:u,activeIndex:h,overIndex:f}):y,K=null==k?void 0:k.id,V=t.useRef({activeId:K,items:u,newIndex:B,containerId:m}),H=u!==V.current.items,Y=n({active:k,containerId:m,isDragging:E,isSorting:W,id:c,index:y,items:u,newIndex:V.current.newIndex,previousItems:V.current.items,previousContainerId:V.current.containerId,transition:d,wasDragging:null!=V.current.activeId}),Q=function(e){let{disabled:n,index:r,node:a,rect:i}=e;const[s,c]=t.useState(null),o=t.useRef(r);return he(()=>{if(!n&&r!==o.current&&a.current){const e=i.current;if(e){const t=Je(a.current,{ignoreTransform:!0}),n={x:e.left-t.left,y:e.top-t.top,scaleX:e.width/t.width,scaleY:e.height/t.height};(n.x||n.y)&&c(n)}}r!==o.current&&(o.current=r)},[n,r,a,i]),t.useEffect(()=>{s&&c(null)},[s]),s}({disabled:!Y,index:y,node:S,rect:j});return t.useEffect(()=>{W&&V.current.newIndex!==B&&(V.current.newIndex=B),m!==V.current.containerId&&(V.current.containerId=m),u!==V.current.items&&(V.current.items=u)},[W,B,m,u]),t.useEffect(()=>{if(K===V.current.activeId)return;if(null!=K&&null==V.current.activeId)return void(V.current.activeId=K);const e=setTimeout(()=>{V.current.activeId=K},50);return()=>clearTimeout(e)},[K]),{active:k,activeIndex:h,attributes:M,data:w,rect:j,index:y,newIndex:B,items:u,isOver:q,isSorting:W,isDragging:E,listeners:$,node:S,overIndex:f,over:T,setNodeRef:A,setActivatorNodeRef:O,setDroppableNodeRef:C,setDraggableNodeRef:R,transform:null!=Q?Q:U,transition:function(){if(Q||H&&V.current.newIndex===y)return $n;if(L&&!je(D)||!d)return;if(W||Y)return qe.Transition.toString({...d,property:Rn});return}()}}function On({children:e,onConfirm:n,disabled:r=!1,placeholder:s="날짜와 금액을 입력하세요",align:c="center",side:o="bottom",defaultDate:l,defaultAmount:d}){const[u,m]=t.useState(!1),[h,p]=t.useState(l),[_,g]=t.useState(d?.toString()||"");return a.jsxs(L,{open:u,onOpenChange:m,children:[a.jsx(z,{asChild:!0,disabled:r,children:e}),a.jsx(U,{className:"w-auto p-0 border-gray-200 shadow-lg",align:c,side:o,sideOffset:8,children:a.jsxs("div",{className:"bg-white business-radius-card p-3",children:[a.jsx("div",{className:"mb-2 px-1",children:a.jsx("div",{className:"modal-label text-gray-600 text-center",children:s})}),a.jsx(D,{mode:"single",selected:h,onSelect:p,locale:I,initialFocus:!0,className:"compact-calendar",disabled:!1,fromDate:new Date("2020-01-01"),toDate:new Date("2030-12-31"),defaultMonth:h||new Date,modifiers:{today:new Date},modifiersClassNames:{today:"bg-blue-500 text-white font-semibold cursor-pointer hover:bg-blue-600 rounded-md"}}),a.jsxs("div",{className:"mt-3 px-1",children:[a.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"지출금액"}),a.jsx(E,{type:"text",value:_,onChange:e=>{const t=e.target.value.replace(/[^0-9]/g,"");if(t){const e=parseInt(t,10);g(e.toLocaleString())}else g("")},placeholder:"금액을 입력하세요",className:"w-full"})]}),a.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[a.jsx(i,{variant:"outline",size:"sm",onClick:()=>m(!1),children:"취소"}),a.jsx(i,{size:"sm",onClick:()=>{if(!h)return;const e=parseFloat(_.replace(/,/g,""));isNaN(e)||e<=0||(n(h,e),m(!1),p(l),g(d?.toString()||""))},disabled:!h||!_||parseFloat(_.replace(/,/g,""))<=0,className:"button-base button-action-primary",children:"확인"})]})]})})]})}function Pn({children:e,onConfirm:n,disabled:r=!1,placeholder:s="날짜와 실제입고수량을 입력하세요",align:c="center",side:o="bottom",defaultDate:l,defaultQuantity:d,maxQuantity:u,hideQuantityInput:m=!1,quantityInfoText:h="요청입고수량과 동일한 수량으로 입력됩니다"}){const[p,_]=t.useState(!1),[g,f]=t.useState(l),[v,x]=t.useState(d?.toString()||"");return a.jsxs(L,{open:p,onOpenChange:_,children:[a.jsx(z,{asChild:!0,disabled:r,children:e}),a.jsx(U,{className:"w-auto p-0 border-gray-200 shadow-lg",align:c,side:o,sideOffset:8,children:a.jsxs("div",{className:"bg-white business-radius-card p-3",children:[a.jsx("div",{className:"mb-2 px-1",children:a.jsx("div",{className:"modal-label text-gray-600 text-center",children:s})}),m&&a.jsx("div",{className:"mb-2 px-1",children:a.jsxs("div",{className:"text-[10px] text-gray-500 text-center leading-tight",children:[a.jsx("div",{children:"요청입고수량과 동일한"}),a.jsx("div",{children:"수량으로 입력됩니다"})]})}),a.jsx(D,{mode:"single",selected:g,onSelect:f,locale:I,initialFocus:!0,className:"compact-calendar",disabled:!1,fromDate:new Date("2020-01-01"),toDate:new Date("2030-12-31"),defaultMonth:g||new Date,modifiers:{today:new Date},modifiersClassNames:{today:"bg-blue-500 text-white font-semibold cursor-pointer hover:bg-blue-600 rounded-md"}}),!m&&a.jsxs("div",{className:"mt-3 px-1",children:[a.jsxs("div",{className:"flex items-center justify-between mb-1 gap-2",children:[a.jsx("label",{className:"block text-xs font-medium text-gray-700",children:h?.includes("미입고")?"추가입고수량":"실제입고수량"}),void 0!==u&&a.jsx(i,{type:"button",variant:"outline",size:"sm",onClick:()=>{void 0!==u&&x(u.toString())},className:"h-6 px-2 text-[10px] border-gray-200 text-hansl-600",children:h?.includes("미입고")?"미입고 수량 전체":"요청수량과 동일"})]}),a.jsx(E,{type:"number",value:v,onChange:e=>{const t=e.target.value.replace(/[^0-9]/g,"");x(t)},placeholder:"수량을 입력하세요",className:"border-gray-200 rounded-lg text-center w-full !h-5 !px-1.5 !py-0.5 !text-[9px] font-normal text-gray-600 focus:border-blue-400",min:"0",max:u}),u&&a.jsx("p",{className:"text-xs text-gray-500 mt-1",children:h?.includes("미입고")?h:`최대: ${u.toLocaleString()}`})]}),a.jsxs("div",{className:"mt-3 flex justify-end gap-2",children:[a.jsx(i,{variant:"outline",size:"sm",onClick:()=>_(!1),className:"button-base",children:"취소"}),a.jsx(i,{size:"sm",onClick:()=>{if(!g)return;if(m)return n(g,void 0),_(!1),f(l),void x(d?.toString()||"");const e=parseFloat(v.replace(/,/g,""));isNaN(e)||e<0||u&&e>u||(n(g,e),_(!1),f(l),x(d?.toString()||""))},disabled:!g||!m&&(!v||parseFloat(v.replace(/,/g,""))<0||void 0!==u&&parseFloat(v.replace(/,/g,""))>u),className:"button-base button-action-primary",children:"확인"})]})]})})]})}function An({config:e,currentUserName:n,canPerformAction:r,purchaseId:a,onUpdate:i,onBeforeUpdate:m,onOptimisticUpdate:h}){const p=s(),_=t.useCallback(async(t,s,d,u)=>{if(!r)return c.warn("❌ 권한 없음",{canPerformAction:r,currentUserName:n}),void K.error(("statement_received"===e.field?"거래명세서":"입고")+" 확인 권한이 없습니다.");const _="number"==typeof t?t:Number(t);if(Number.isNaN(_))return c.error("❌ 잘못된 ID",{itemId:t,numericId:_}),void K.error("유효하지 않은 항목 ID 입니다.");if(d){const t=`품목명: ${d.item_name||"-"}\n규격: ${d.specification||"-"}\n수량: ${d.quantity?.toLocaleString()||0}\n단가: ₩${d.unit_price_value?.toLocaleString()||0}\n합계: ₩${d.amount_value?.toLocaleString()||0}\n비고: ${d.remark||"-"}\n\n${e.confirmMessage.confirm}`;if(!window.confirm(t))return}m?.();try{let t;if("statement_received"===e.field)t={is_statement_received:!0,statement_received_date:C(s),statement_received_by_name:n};else if("actual_received"===e.field){const e=d?.quantity||0,r=d?.received_quantity||0,a=void 0!==u?u:e,i=r+a,{data:o}=await p.from("purchase_request_items").select("receipt_history").eq("id",_).single(),l=o?.receipt_history||[],m={seq:l.length+1,qty:a,date:C(s),by:n||"알수없음"},h=[...l,m],g=i>=e;t={actual_received_date:C(s),is_received:g,received_quantity:i,delivery_status:0===i?"pending":g?"received":"partial",receipt_history:h},c.debug("📦 분할 입고 처리:",{requestedQuantity:e,currentReceivedQuantity:r,newReceivedQuantity:a,totalReceivedQuantity:i,isFullyReceived:g,historyCount:h.length})}c.debug("📝 업데이트할 데이터:",t);const{data:r,error:m}=await p.from("purchase_request_items").update(t).eq("id",_).select();if(c.debug("📝 DB 업데이트 결과:",{data:r,error:m}),m)throw c.error("❌ DB 업데이트 실패",m),m;if(c.info("✅ DB 업데이트 성공",r),a)if("actual_received"===e.field){o(a,_,C(s),u)||c.warn("[useConfirmDateAction] 메모리 캐시 입고완료 업데이트 실패",{purchaseId:a,itemId:_})}else if("statement_received"===e.field){l(a,_,C(s),n||void 0)||c.warn("[useConfirmDateAction] 메모리 캐시 거래명세서 확인 업데이트 실패",{purchaseId:a,itemId:_})}h&&h({itemId:_,selectedDate:s,action:"confirm",receivedQuantity:void 0!==u?u:d?.received_quantity,itemInfo:d}),i&&i(),K.success(e.successMessage.confirm)}catch(g){c.error("❌ 전체 처리 실패",g),K.error(("statement_received"===e.field?"거래명세서":"입고")+" 확인 처리 중 오류가 발생했습니다.")}},[e,n,r,a,i,m,h,p]),g=t.useCallback(async(t,s)=>{if(!r)return c.warn("❌ 취소 권한 없음",{canPerformAction:r,currentUserName:n}),void K.error(("statement_received"===e.field?"거래명세서":"입고")+" 확인 권한이 없습니다.");const o="number"==typeof t?t:Number(t);if(Number.isNaN(o))K.error("유효하지 않은 항목 ID 입니다.");else{if(s){const t=`품목명: ${s.item_name||"-"}\n규격: ${s.specification||"-"}\n수량: ${s.quantity?.toLocaleString()||0}\n단가: ₩${s.unit_price_value?.toLocaleString()||0}\n합계: ₩${s.amount_value?.toLocaleString()||0}\n비고: ${s.remark||"-"}\n\n${e.confirmMessage.cancel}`;if(!window.confirm(t))return}m?.();try{let n;c.debug(`🔄 ${e.field} 확인 취소 시작`,{itemId:t,itemName:s?.item_name}),"statement_received"===e.field?n={is_statement_received:!1,statement_received_date:null,statement_received_by_name:null}:"actual_received"===e.field&&(n={actual_received_date:null,is_received:!1,received_quantity:0,delivery_status:"pending",receipt_history:[]}),c.debug("🔄 취소 업데이트할 데이터:",n);const{data:r,error:l}=await p.from("purchase_request_items").update(n).eq("id",o).select();if(c.debug("🔄 취소 DB 업데이트 결과:",{data:r,error:l}),l)throw c.error("❌ DB 업데이트 실패",l),l;if(c.info(`✅ ${e.field} 확인 취소 성공`,r),a)if("actual_received"===e.field){d(a,o)||c.warn("[useConfirmDateAction] 메모리 캐시 입고취소 업데이트 실패",{purchaseId:a,itemId:o})}else if("statement_received"===e.field){u(a,o)||c.warn("[useConfirmDateAction] 메모리 캐시 거래명세서 취소 업데이트 실패",{purchaseId:a,itemId:o})}h&&h({itemId:o,action:"cancel",itemInfo:s}),i&&i(),K.success(e.successMessage.cancel)}catch(l){c.error(`❌ ${e.field} 확인 취소 실패`,l),K.error(("statement_received"===e.field?"거래명세서":"입고")+" 확인 취소 중 오류가 발생했습니다.")}}},[e,r,a,i,m,h,p]),f=t.useCallback(t=>"statement_received"===e.field?t.is_statement_received:"actual_received"===e.field&&t.is_received,[e.field]),v=t.useCallback(t=>{if("actual_received"===e.field){const e=t.received_quantity||0,n=t.quantity||0;return e>0&&e<n}return!1},[e.field]),x=t.useCallback(e=>{const t=e.received_quantity||0,n=e.quantity||0;return Math.max(0,n-t)},[]),b=t.useCallback(t=>"statement_received"===e.field?t.statement_received_date:"actual_received"===e.field?t.actual_received_date:null,[e.field]),y=t.useCallback(t=>"statement_received"===e.field?t.statement_received_by_name:(e.field,null),[e.field]);return{config:e,handleConfirm:_,handleCancel:g,isCompleted:f,isPartiallyReceived:v,getRemainingQuantity:x,getCompletedDate:b,getCompletedByName:y}}xt.Down,xt.Right,xt.Up,xt.Left;const Wn=[{id:"statement_progress",label:"거래명세서",description:"거래명세서 수령 진행률",defaultVisible:!0},{id:"purchase_order_number",label:"발주번호",description:"발주요청 번호",defaultVisible:!0},{id:"payment_category",label:"결제종류",description:"결제 방식 (구매요청, 발주, 현장결제 등)",defaultVisible:!0},{id:"requester_name",label:"요청자",description:"발주를 요청한 사용자",defaultVisible:!0},{id:"request_date",label:"청구일",description:"발주 요청 날짜",defaultVisible:!0},{id:"utk_status",label:"UTK",description:"UTK 확인 상태",defaultVisible:!0},{id:"vendor_name",label:"업체",description:"공급업체명",defaultVisible:!0},{id:"contact_name",label:"담당자",description:"업체 담당자명",defaultVisible:!0},{id:"delivery_request_date",label:"입고요청일",description:"입고 요청 날짜",defaultVisible:!0},{id:"revised_delivery_date",label:"변경입고일",description:"수정된 입고 날짜",defaultVisible:!0},{id:"item_name",label:"품명",description:"구매 품목명",defaultVisible:!0},{id:"specification",label:"규격",description:"품목 규격 정보",defaultVisible:!0},{id:"quantity",label:"수량",description:"구매 수량",defaultVisible:!0},{id:"unit_price",label:"단가",description:"품목 단가",defaultVisible:!0},{id:"amount",label:"합계",description:"총 금액",defaultVisible:!0},{id:"remark",label:"비고",description:"추가 메모 사항",defaultVisible:!0},{id:"link",label:"링크",description:"관련 링크",defaultVisible:!0},{id:"project_vendor",label:"PJ업체",description:"프로젝트 업체",defaultVisible:!0},{id:"project_item",label:"PJ ITEM",description:"프로젝트 아이템",defaultVisible:!0},{id:"sales_order_number",label:"수주번호",description:"수주 번호",defaultVisible:!0},{id:"purchase_progress",label:"구매진행",description:"구매 진행률",defaultVisible:!0},{id:"receipt_progress",label:"입고진행",description:"입고 진행률",defaultVisible:!0}],Fn=Wn.reduce((e,t)=>(e[t.id]=t.defaultVisible,e),{});Wn.reduce((e,t)=>(e[t.id]=t,e),{});const Ln=["purchase_order_number","vendor_name","item_name","specification"],zn=["statement_progress","utk_status","unit_price","amount"],Un=["app_admin","ceo","final_approver","purchase_manager","lead buyer","accounting"],Bn=["app_admin","lead buyer","accounting"],Kn=[{title:"기본 정보",columns:["statement_progress","purchase_order_number","payment_category","requester_name","request_date","utk_status"]},{title:"업체 정보",columns:["vendor_name","contact_name","delivery_request_date","revised_delivery_date"]},{title:"품목 정보",columns:["item_name","specification","quantity","unit_price","amount","remark","link"]},{title:"프로젝트 정보",columns:["project_vendor","project_item","sales_order_number"]},{title:"진행 상태",columns:["purchase_progress","receipt_progress"]}];function Vn(e){if(!e)return e;const t=e.toUpperCase().replace(/\s+/g,""),n=t.match(/^(F\d{8})[_-](\d{1,3})$/);if(n){const[,e,t]=n;return`${e}_${t.padStart(3,"0")}`}const r=t.match(/^(HS\d{6})-(\d{1,2})$/);if(r){const[,e,t]=r;return`${e}-${t.padStart(2,"0")}`}return t}const Hn=new class{constructor(){this.supabase=s()}async uploadStatement(e,t){try{const n=e.name.split(".").pop()?.toLowerCase()||"png",r=crypto.randomUUID(),a=`Transaction Statement/${`${r}.${n}`}`,{data:i,error:s}=await this.supabase.storage.from("receipt-images").upload(a,e,{contentType:e.type,upsert:!1});if(s)throw s;const{data:c}=this.supabase.storage.from("receipt-images").getPublicUrl(a),o=c.publicUrl,{data:{user:l}}=await this.supabase.auth.getUser(),{data:d,error:u}=await this.supabase.from("transaction_statements").insert({image_url:o,file_name:e.name,uploaded_by:l?.id,uploaded_by_name:t,status:"pending"}).select().single();if(u)throw new Error(`DB 저장 실패: ${u.message} (code: ${u.code})`);return{success:!0,data:{statementId:d.id,imageUrl:o}}}catch(n){return{success:!1,error:n instanceof Error?n.message:"업로드 중 오류가 발생했습니다."}}}async extractStatementData(e,t){try{await this.supabase.from("transaction_statements").update({status:"processing"}).eq("id",e);const{data:n,error:r}=await this.supabase.functions.invoke("ocr-transaction-statement",{body:{statementId:e,imageUrl:t}});if(r)throw r;if(!n.success)throw new Error(n.error||"OCR 추출 실패");return await this.getStatementWithItems(e)}catch(n){return{success:!1,error:n instanceof Error?n.message:"OCR 추출 중 오류가 발생했습니다."}}}async getStatements(e){try{let t=this.supabase.from("transaction_statements").select("\n          *,\n          items:transaction_statement_items(matched_purchase_id)\n        ",{count:"exact"}).order("uploaded_at",{ascending:!1});e?.status&&"all"!==e.status&&(t=t.eq("status",e.status)),e?.dateFrom&&(t=t.gte("uploaded_at",e.dateFrom)),e?.dateTo&&(t=t.lte("uploaded_at",e.dateTo+"T23:59:59")),e?.search&&(t=t.or(`vendor_name.ilike.%${e.search}%,file_name.ilike.%${e.search}%`)),e?.limit&&(t=t.limit(e.limit)),e?.offset&&(t=t.range(e.offset,e.offset+(e.limit||20)-1));const{data:n,count:r,error:a}=await t;if(a)throw a;const i=new Set;(n||[]).forEach(e=>{e.items?.forEach(e=>{e.matched_purchase_id&&i.add(e.matched_purchase_id)})});const s=new Map;if(i.size>0){const{data:e}=await this.supabase.from("purchase_requests").select("id, purchase_order_number, sales_order_number").in("id",Array.from(i));e?.forEach(e=>{s.set(e.id,{purchase_order_number:e.purchase_order_number,sales_order_number:e.sales_order_number})})}return{success:!0,data:(n||[]).map(e=>{const t=new Set;e.items?.forEach(e=>{e.matched_purchase_id&&t.add(e.matched_purchase_id)});const n=Array.from(t).map(e=>{const t=s.get(e);return{purchase_id:e,purchase_order_number:t?.purchase_order_number||"",sales_order_number:t?.sales_order_number}}),{items:r,...a}=e;return{...a,matched_purchase_id:n[0]?.purchase_id||null,matched_purchases:n}}),count:r||0}}catch(t){return{success:!1,error:t instanceof Error?t.message:"조회 중 오류가 발생했습니다."}}}async getStatementWithItems(e){try{const{data:t,error:n}=await this.supabase.from("transaction_statements").select("*").eq("id",e).single();if(n)throw n;const{data:r,error:a}=await this.supabase.from("transaction_statement_items").select("*").eq("statement_id",e).order("line_number",{ascending:!0});if(a)throw a;const i=t.vendor_name||"",s=await Promise.all((r||[]).map(async e=>{const t=await this.findMatchCandidates(e,i);let n,r;if(e.matched_purchase_id){const{data:t}=await this.supabase.from("purchase_requests").select("id, purchase_order_number, sales_order_number, vendor:vendors(vendor_name)").eq("id",e.matched_purchase_id).single();t&&(n={id:t.id,purchase_order_number:t.purchase_order_number||"",sales_order_number:t.sales_order_number,vendor_name:t.vendor?.vendor_name})}if(e.matched_item_id){const{data:t}=await this.supabase.from("purchase_request_items").select("id, item_name, specification, quantity, unit_price_value").eq("id",e.matched_item_id).single();t&&(r={id:t.id,item_name:t.item_name,specification:t.specification,quantity:t.quantity,unit_price_value:t.unit_price_value})}return{...e,match_candidates:t,matched_purchase:n,matched_item:r}}));return{success:!0,data:{...t,items:s}}}catch(t){return{success:!1,error:t instanceof Error?t.message:"조회 중 오류가 발생했습니다."}}}async findMatchCandidates(e,t){const n=new Map;try{const r=e.extracted_po_number||"",a=r?Vn(r):"",i=r.toUpperCase().match(/^(F)(\d{8})$/),s=r.toUpperCase().match(/^(HS)(\d{6})$/),c=!(!i&&!s),o=i?`F${i[2]}`:s?`HS${s[2]}`:"";if(a){const{data:r}=await this.supabase.from("purchase_requests").select("\n            id, \n            purchase_order_number, \n            sales_order_number,\n            vendor:vendors(vendor_name),\n            items:purchase_request_items(id, item_name, specification, quantity, unit_price_value)\n          ").or(`purchase_order_number.eq.${a},sales_order_number.eq.${a}`).limit(10);if(r)for(const a of r){const r=a.vendor?.vendor_name||"",i=t?this.calculateVendorSimilarity(t,r):100;if(!(i<50))for(const t of a.items||[]){const s=`${a.id}-${t.id}`,c=["발주/수주번호 일치"];let o=50;if(i>=90?(o+=10,c.push("거래처 일치")):i>=70&&(o+=5,c.push("거래처 유사")),e.extracted_item_name){const n=this.calculateItemMatchScore(e.extracted_item_name,t.item_name,t.specification);o+=.3*n.score,n.score>=80&&c.push("specification"===n.matchedField?"규격 일치":"품목명 일치")}e.extracted_quantity&&t.quantity&&(e.extracted_quantity===t.quantity?(o+=15,c.push(`수량 일치 (${e.extracted_quantity})`)):e.extracted_quantity<=t.quantity&&(o+=5,c.push(`수량 (요청:${t.quantity}, 입고:${e.extracted_quantity})`))),n.set(s,{purchase_id:a.id,purchase_order_number:a.purchase_order_number||"",sales_order_number:a.sales_order_number,item_id:t.id,item_name:t.item_name,specification:t.specification,quantity:t.quantity,unit_price:t.unit_price_value,vendor_name:r,score:o,match_reasons:c})}}}if(c&&o&&0===n.size){const{data:r}=await this.supabase.from("purchase_requests").select("\n            id, \n            purchase_order_number, \n            sales_order_number,\n            vendor:vendors(vendor_name),\n            items:purchase_request_items(id, item_name, specification, quantity, unit_price_value)\n          ").or(`purchase_order_number.ilike.${o}%,sales_order_number.ilike.${o}%`).limit(20);if(r)for(const a of r){const r=a.vendor?.vendor_name||"",i=t?this.calculateVendorSimilarity(t,r):100;if(!(i<50))for(const t of a.items||[]){const s=`${a.id}-${t.id}`;if(n.has(s))continue;const c=[`날짜 일치 (${o})`];let l=30;if(i>=90?(l+=20,c.push("거래처 일치")):i>=70&&(l+=10,c.push("거래처 유사")),e.extracted_item_name){const n=this.calculateItemMatchScore(e.extracted_item_name,t.item_name,t.specification);l+=.4*n.score,n.score>=80?c.push("specification"===n.matchedField?"규격 일치":"품목명 일치"):n.score>=50&&c.push("specification"===n.matchedField?"규격 유사":"품목명 유사")}e.extracted_quantity&&t.quantity&&(e.extracted_quantity===t.quantity?(l+=15,c.push(`수량 일치 (${e.extracted_quantity})`)):e.extracted_quantity<=t.quantity&&(l+=5,c.push(`수량 (요청:${t.quantity}, 입고:${e.extracted_quantity})`))),n.set(s,{purchase_id:a.id,purchase_order_number:a.purchase_order_number||"",sales_order_number:a.sales_order_number,item_id:t.id,item_name:t.item_name,specification:t.specification,quantity:t.quantity,unit_price:t.unit_price_value,vendor_name:r,score:l,match_reasons:c})}}}if(e.extracted_item_name){const r=e.extracted_item_name.trim(),i=[r,r.substring(0,Math.min(r.length,12)),r.substring(0,Math.min(r.length,8)),r.split(/\[|]|\s|_|-/)[0]].filter(e=>e&&e.length>=3),s=[...new Set(i)];for(const c of s){const{data:r}=await this.supabase.from("purchase_request_items").select("\n              id, \n              item_name, \n              specification, \n              quantity, \n              unit_price_value,\n              purchase:purchase_requests!inner(\n                id, \n                purchase_order_number, \n                sales_order_number,\n                vendor:vendors(vendor_name)\n              )\n            ").or(`item_name.ilike.%${c}%,specification.ilike.%${c}%`).limit(50);if(r&&r.length>0){for(const i of r){const r=`${i.purchase?.id}-${i.id}`;if(n.has(r))continue;const s=i.purchase?.vendor?.vendor_name||"",c=t?this.calculateVendorSimilarity(t,s):100;if(c<50)continue;const o=[];let l=0;c>=90?(l+=20,o.push("거래처 일치")):c>=70&&(l+=10,o.push("거래처 유사"));const d=this.calculateItemMatchScore(e.extracted_item_name,i.item_name,i.specification);d.score>=40&&(l+=.7*d.score,d.score>=85?o.push("specification"===d.matchedField?"규격 일치":"품목명 일치"):d.score>=50?o.push("specification"===d.matchedField?"규격 유사":"품목명 유사"):o.push("품목 부분일치")),e.extracted_quantity&&i.quantity&&(e.extracted_quantity===i.quantity?(l+=15,o.push(`수량 일치 (${e.extracted_quantity})`)):e.extracted_quantity<=i.quantity&&(l+=5,o.push(`수량 (요청:${i.quantity}, 입고:${e.extracted_quantity})`)));const u=i.purchase?.purchase_order_number||"",m=i.purchase?.sales_order_number||"";a&&u!==a&&m!==a&&o.push(`⚠️ OCR 오류 가능: ${a} → ${u||m}`),l>=15&&n.set(r,{purchase_id:i.purchase?.id,purchase_order_number:u,sales_order_number:m,item_id:i.id,item_name:i.item_name,specification:i.specification,quantity:i.quantity,unit_price:i.unit_price_value,vendor_name:i.purchase?.vendor?.vendor_name,score:l,match_reasons:o})}if(n.size>=5)break}}}const l=Array.from(n.values()).some(e=>e.score>=40);if((0===n.size||!l)&&t){const{data:r}=await this.supabase.from("vendors").select("id, vendor_name").limit(100);if(r){const i=r.filter(e=>this.calculateVendorSimilarity(t,e.vendor_name)>=70);if(i.length>0){const t=i.map(e=>e.id),r=new Date;r.setMonth(r.getMonth()-3);const{data:s}=await this.supabase.from("purchase_requests").select("\n                id, \n                purchase_order_number, \n                sales_order_number,\n                vendor:vendors(vendor_name),\n                items:purchase_request_items(id, item_name, specification, quantity, unit_price_value)\n              ").in("vendor_id",t).gte("created_at",r.toISOString()).order("created_at",{ascending:!1}).limit(30);if(s)for(const i of s){const t=i.vendor?.vendor_name||"";for(const r of i.items||[]){const s=`${i.id}-${r.id}`;if(n.has(s))continue;const c=["거래처 일치"];let o=20;if(e.extracted_item_name){const t=this.calculateItemMatchScore(e.extracted_item_name,r.item_name,r.specification);t.score>=40&&(o+=.5*t.score,t.score>=85?c.push("specification"===t.matchedField?"규격 일치":"품목명 일치"):t.score>=50&&c.push("specification"===t.matchedField?"규격 유사":"품목명 유사"))}e.extracted_quantity&&r.quantity&&(e.extracted_quantity===r.quantity?(o+=15,c.push(`수량 일치 (${e.extracted_quantity})`)):e.extracted_quantity<=r.quantity&&(o+=5,c.push(`수량 (요청:${r.quantity}, 입고:${e.extracted_quantity})`)));const l=i.purchase_order_number||"",d=i.sales_order_number||"";a&&c.push(`⚠️ OCR 오류 가능: ${a} → ${l||d}`),o>=15&&n.set(s,{purchase_id:i.id,purchase_order_number:l,sales_order_number:d,item_id:r.id,item_name:r.item_name,specification:r.specification,quantity:r.quantity,unit_price:r.unit_price_value,vendor_name:t,score:o,match_reasons:c})}}}}}const d=Array.from(n.values());return d.sort((e,t)=>t.score-e.score),d.length,d.slice(0,15)}catch(r){return[]}}calculateNameSimilarity(e,t){const n=e.toLowerCase().replace(/\s+/g,""),r=t.toLowerCase().replace(/\s+/g,"");if(!n||!r)return 0;if(n===r)return 100;if(n.includes(r)||r.includes(n))return 80;const a=Math.max(n.length,r.length),i=(a-this.levenshteinDistance(n,r))/a*100;return Math.round(i)}calculateItemMatchScore(e,t,n){if(!e)return{score:0,matchedField:"none"};const r=t?this.calculateNameSimilarity(e,t):0,a=n?this.calculateNameSimilarity(e,n):0;return r>=a?{score:r,matchedField:r>0?"item_name":"none"}:{score:a,matchedField:a>0?"specification":"none"}}calculateVendorSimilarity(e,t){if(!e||!t)return 0;const n=e=>e.toLowerCase().replace(/\(주\)|주식회사|㈜|주\)|주|co\.|co,|ltd\.|ltd|inc\.|inc|corp\.|corp|company|컴퍼니/gi,"").replace(/[^a-z0-9가-힣]/g,"").trim(),r=n(e),a=n(t);if(!r||!a)return 0;if(r===a)return 100;if(r.includes(a)||a.includes(r))return 90;const i={yg:["와이지","yg"],"와이지":["yg","와이지"],tech:["테크","텍","tech"],"테크":["tech","텍","테크"],"텍":["tech","테크","텍"],high:["하이","high"],"하이":["high","하이"],korea:["코리아","한국","korea"],"코리아":["korea","한국","코리아"],electric:["전기","일렉트릭","electric"],"전기":["electric","일렉트릭","전기"],steel:["스틸","철강","steel"],"스틸":["steel","철강","스틸"],metal:["메탈","금속","metal"],"메탈":["metal","금속","메탈"],system:["시스템","system"],"시스템":["system","시스템"],soft:["소프트","soft"],"소프트":["soft","소프트"],net:["넷","net"],"넷":["net","넷"],global:["글로벌","global"],"글로벌":["global","글로벌"],trade:["트레이드","무역","trade"],"트레이드":["trade","무역","트레이드"],international:["인터내셔널","international"],"인터내셔널":["international","인터내셔널"]};let s=r,c=a;for(const[d,u]of Object.entries(i)){if(r.includes(d)){for(const e of u)if(s=s.replace(d,e),s===a||a.includes(s)||s.includes(a))return 85;s=r}if(a.includes(d)){for(const e of u)if(c=c.replace(d,e),r===c||r.includes(c)||c.includes(r))return 85;c=a}}const o=Math.max(r.length,a.length),l=(o-this.levenshteinDistance(r,a))/o*100;return Math.round(l)}isVendorMatch(e,t,n=70){return this.calculateVendorSimilarity(e,t)>=n}levenshteinDistance(e,t){const n=e.length,r=t.length,a=Array(n+1).fill(null).map(()=>Array(r+1).fill(0));for(let i=0;i<=n;i++)a[i][0]=i;for(let i=0;i<=r;i++)a[0][i]=i;for(let i=1;i<=n;i++)for(let n=1;n<=r;n++)e[i-1]===t[n-1]?a[i][n]=a[i-1][n-1]:a[i][n]=Math.min(a[i-1][n-1],a[i-1][n],a[i][n-1])+1;return a[n][r]}calculateSimilarityScore(e,t){let n=0;if(e.extracted_item_name){n+=.4*this.calculateItemMatchScore(e.extracted_item_name,t.item_name||"",t.specification||"").score}if(e.extracted_specification){n+=.2*this.calculateItemMatchScore(e.extracted_specification,t.item_name||"",t.specification||"").score}if(e.extracted_quantity&&t.quantity){const r=Math.abs(e.extracted_quantity-t.quantity);0===r?n+=20:r<=.1*t.quantity?n+=15:r<=.2*t.quantity&&(n+=10)}if(e.extracted_unit_price&&t.unit_price_value){const r=Math.abs(e.extracted_unit_price-t.unit_price_value);0===r?n+=20:r<=.05*t.unit_price_value?n+=15:r<=.1*t.unit_price_value&&(n+=10)}return n}getMatchReasons(e,t,n){const r=[];if(e.extracted_item_name){const n=this.calculateItemMatchScore(e.extracted_item_name,t.item_name||"",t.specification||"");n.score>=90?r.push("specification"===n.matchedField?"규격 완전 일치":"품목명 완전 일치"):n.score>=70?r.push("specification"===n.matchedField?"규격 높은 유사도":"품목명 높은 유사도"):n.score>=50&&r.push("specification"===n.matchedField?"규격 부분 일치":"품목명 부분 일치")}return e.extracted_quantity&&t.quantity&&(e.extracted_quantity===t.quantity?r.push(`수량 일치 (${e.extracted_quantity})`):e.extracted_quantity<=t.quantity&&r.push(`수량 (요청:${t.quantity}, 입고:${e.extracted_quantity})`)),e.extracted_unit_price===t.unit_price_value&&r.push("단가 일치"),n>=70?r.push("높은 유사도"):n>=50&&r.push("보통 유사도"),r}async updateItemMatch(e,t,n,r="manual"){try{const{error:a}=await this.supabase.from("transaction_statement_items").update({matched_purchase_id:t,matched_item_id:n,match_method:r}).eq("id",e);if(a)throw a;return{success:!0}}catch(a){return{success:!1,error:a instanceof Error?a.message:"매칭 업데이트 중 오류가 발생했습니다."}}}async confirmStatement(e,t){try{const{data:{user:n}}=await this.supabase.auth.getUser();for(const t of e.items){const{error:e}=await this.supabase.from("transaction_statement_items").update({is_confirmed:!0,matched_purchase_id:t.matched_purchase_id,matched_item_id:t.matched_item_id,confirmed_quantity:t.confirmed_quantity,confirmed_unit_price:t.confirmed_unit_price,confirmed_amount:t.confirmed_amount,is_additional_item:t.is_additional_item||!1,parent_item_id:t.parent_item_id}).eq("id",t.itemId);if(e)throw e;const n=void 0!==t.confirmed_unit_price&&null!==t.confirmed_unit_price,r=void 0!==t.confirmed_amount&&null!==t.confirmed_amount;if(t.matched_item_id&&(n||r)){const e={};n&&(e.unit_price_value=t.confirmed_unit_price),r&&(e.amount_value=t.confirmed_amount);const{error:a}=await this.supabase.from("purchase_request_items").update(e).eq("id",t.matched_item_id)}if(t.is_additional_item&&t.matched_purchase_id&&!t.matched_item_id){const e=await this.getStatementItem(t.itemId);if(e){const{error:n}=await this.supabase.from("purchase_request_items").insert({purchase_request_id:t.matched_purchase_id,item_name:e.extracted_item_name||"추가 공정",specification:e.extracted_specification,quantity:t.confirmed_quantity||e.extracted_quantity||1,unit_price_value:t.confirmed_unit_price||e.extracted_unit_price,amount_value:t.confirmed_amount||e.extracted_amount,remark:"거래명세서에서 추가됨"})}}}const{error:r}=await this.supabase.from("transaction_statements").update({status:"confirmed",confirmed_at:(new Date).toISOString(),confirmed_by:n?.id,confirmed_by_name:t}).eq("id",e.statementId);if(r)throw r;return{success:!0}}catch(n){return{success:!1,error:n instanceof Error?n.message:"확정 중 오류가 발생했습니다."}}}async getStatementItem(e){const{data:t}=await this.supabase.from("transaction_statement_items").select("*").eq("id",e).single();return t}async rejectStatement(e){try{const{error:t}=await this.supabase.from("transaction_statements").update({status:"rejected"}).eq("id",e);if(t)throw t;return{success:!0}}catch(t){return{success:!1,error:t instanceof Error?t.message:"거부 처리 중 오류가 발생했습니다."}}}async deleteStatement(e){try{const{data:n}=await this.supabase.from("transaction_statements").select("image_url").eq("id",e).single(),{error:r}=await this.supabase.from("transaction_statements").delete().eq("id",e);if(r)throw r;if(n?.image_url)try{const e=n.image_url.split("/receipt-images/")[1];e&&await this.supabase.storage.from("receipt-images").remove([e])}catch(t){}return{success:!0}}catch(n){return{success:!1,error:n instanceof Error?n.message:"삭제 중 오류가 발생했습니다."}}}async findBestMatchingPurchaseOrderSet(e,t,n){try{const r=t?Vn(t):"",a=[];if(r){const{data:t}=await this.supabase.from("purchase_requests").select("\n            id, \n            purchase_order_number, \n            sales_order_number,\n            vendor:vendors(vendor_name),\n            items:purchase_request_items(id, item_name, specification, quantity, unit_price_value)\n          ").or(`purchase_order_number.eq.${r},sales_order_number.eq.${r}`).limit(5);if(t&&t.length>0)for(const r of t){const t=r.vendor?.vendor_name||"";if((n?this.calculateVendorSimilarity(n,t):100)<50)continue;const i=this.calculateSetMatchScore(e,r.items||[]);a.push({purchase_id:r.id,purchase_order_number:r.purchase_order_number||"",sales_order_number:r.sales_order_number,vendor_name:t,matchScore:i.score,matchedItemCount:i.matchedCount,totalItemCount:e.length,items:r.items||[],itemMatches:i.itemMatches})}}const i=a.length>0?a.reduce((e,t)=>e.matchScore>t.matchScore?e:t):null;if(i&&i.matchScore>=80)return{success:!0,data:{bestMatch:{...i,confidence:"high"},candidates:a.map(e=>({purchase_id:e.purchase_id,purchase_order_number:e.purchase_order_number,sales_order_number:e.sales_order_number,vendor_name:e.vendor_name,matchScore:e.matchScore,matchedItemCount:e.matchedItemCount}))}};const s=new Date;s.setMonth(s.getMonth()-3);const{data:c}=await this.supabase.from("purchase_requests").select("\n          id, \n          purchase_order_number, \n          sales_order_number,\n          vendor:vendors(vendor_name),\n          items:purchase_request_items(id, item_name, specification, quantity, unit_price_value)\n        ").gte("created_at",s.toISOString()).order("created_at",{ascending:!1}).limit(100);if(c)for(const t of c){if(a.some(e=>e.purchase_id===t.id))continue;const r=t.vendor?.vendor_name||"";if((n?this.calculateVendorSimilarity(n,r):100)<50)continue;const i=this.calculateSetMatchScore(e,t.items||[]);i.score>=40&&a.push({purchase_id:t.id,purchase_order_number:t.purchase_order_number||"",sales_order_number:t.sales_order_number,vendor_name:r,matchScore:i.score,matchedItemCount:i.matchedCount,totalItemCount:e.length,items:t.items||[],itemMatches:i.itemMatches})}a.sort((e,t)=>t.matchScore-e.matchScore);const o=a.length>0?a[0]:null;return{success:!0,data:{bestMatch:o?{...o,confidence:o.matchScore>=80?"high":o.matchScore>=50?"medium":"low"}:null,candidates:a.slice(0,10).map(e=>({purchase_id:e.purchase_id,purchase_order_number:e.purchase_order_number,sales_order_number:e.sales_order_number,vendor_name:e.vendor_name,matchScore:e.matchScore,matchedItemCount:e.matchedItemCount}))}}}catch(r){return{success:!1,error:r instanceof Error?r.message:"세트 매칭 중 오류가 발생했습니다."}}}calculateSetMatchScore(e,t){if(0===e.length||0===t.length)return{score:0,matchedCount:0,itemMatches:[]};const n=[],r=new Set;let a=0;for(const o of e){let e=null;for(const n of t){if(r.has(n.id))continue;const t=this.calculateItemMatchScore(o.extracted_item_name||"",n.item_name||"",n.specification||"");let a=0;o.extracted_quantity&&n.quantity&&(o.extracted_quantity===n.quantity?a=15:o.extracted_quantity<=n.quantity&&(a=5));const i=t.score+a;(!e||i>e.similarity)&&(e={id:n.id,name:n.item_name,similarity:i})}e&&e.similarity>=40&&(r.add(e.id),a+=e.similarity,n.push({ocrItemId:o.id,systemItemId:e.id,systemItemName:e.name,similarity:e.similarity}))}const i=n.length/e.length,s=n.length>0?a/n.length:0,c=Math.round(50*i+.5*s);return{score:Math.min(100,c),matchedCount:n.length,itemMatches:n}}async saveCorrection(e){try{const{data:{user:t}}=await this.supabase.auth.getUser(),{error:n}=await this.supabase.from("ocr_corrections").insert({statement_id:e.statement_id,statement_item_id:e.statement_item_id,original_text:e.original_text,corrected_text:e.corrected_text,field_type:e.field_type,corrected_by:t?.id});if(n)throw n;return{success:!0}}catch(t){return{success:!1,error:t instanceof Error?t.message:"교정 데이터 저장 중 오류가 발생했습니다."}}}async getStatementsByPurchaseId(e){try{const{data:t}=await this.supabase.from("transaction_statement_items").select("statement_id").eq("matched_purchase_id",e);if(!t||0===t.length)return{success:!0,data:[]};const n=[...new Set(t.map(e=>e.statement_id))],{data:r,error:a}=await this.supabase.from("transaction_statements").select("*").in("id",n).order("uploaded_at",{ascending:!1});if(a)throw a;return{success:!0,data:r||[]}}catch(t){return{success:!1,error:t instanceof Error?t.message:"조회 중 오류가 발생했습니다."}}}},Yn=({id:e,children:t})=>{const{attributes:n,listeners:r,setNodeRef:i,transform:s,transition:c,isDragging:o}=Tn({id:e}),l={transform:qe.Transform.toString(s),transition:c};return a.jsx(a.Fragment,{children:t({setNodeRef:i,attributes:n,listeners:r,isDragging:o,style:l})})};const Qn=t.memo(function({purchaseId:e,isOpen:n,onClose:r,embedded:d=!1,currentUserRoles:u=[],activeTab:D,onRefresh:I,onOptimisticUpdate:ie,onDelete:se}){const{allPurchases:ce,lastFetch:oe}=m(),[le,de]=t.useState(!1),[ue,me]=t.useState(null),[he,pe]=t.useState(!1),[_e,ge]=t.useState(null),[fe,ve]=t.useState([]),[xe,be]=t.useState([]),[ye,we]=t.useState([]),[Ne,je]=t.useState(""),[Se,qe]=t.useState([]),[Ce,ke]=t.useState(null),[De,Ie]=t.useState([]),[Me,Re]=t.useState(""),[$e,Ee]=t.useState(!1),[Te,Oe]=t.useState(""),[Pe,Ae]=t.useState(""),[We,Fe]=t.useState(!1),[Le,ze]=t.useState(!1),[Ue,Ke]=t.useState([]),Ve=function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return t.useMemo(()=>[...n].filter(e=>null!=e),[...n])}((He=It,Ye={activationConstraint:{distance:4}},t.useMemo(()=>({sensor:He,options:null!=Ye?Ye:{}}),[He,Ye])));var He,Ye;const Qe=t.useCallback((e,t)=>e?.stableKey?e.stableKey:null!=e?.id?`sk-item-${e.id}`:e?.tempId?`sk-tmp-${e.tempId}`:null!=e?.line_number?`sk-line-${e.line_number}-${t}`:`sk-idx-${t}`,[]),Xe=t.useCallback((e=[])=>e.map((e,t)=>{const n={...e,tempId:e?.tempId??`tmp-${e?.id??e?.line_number??t}-${t}`};return{...n,stableKey:Qe(n,t)}}),[Qe]),Je=t.useCallback((e,t)=>e?.stableKey?e.stableKey:null!=e?.id?`item-${e.id}`:e?.tempId?`tmp-${e.tempId}`:null!=e?.line_number?`line-${e.line_number}-${t}`:`temp-${t}`,[]),Ge=t.useCallback(e=>{const{active:t,over:n}=e;n&&t.id!==n.id&&ve(e=>{const r=e.findIndex((e,n)=>Je(e,n)===t.id),a=e.findIndex((e,t)=>Je(e,t)===n.id);if(-1===r||-1===a)return e;return bn(e,r,a).map((e,t)=>({...e,line_number:t+1,stableKey:e.stableKey??Qe(e,t)}))})},[Je,Qe]);t.useEffect(()=>{$e&&ue&&(Oe(`[수정요청] 발주번호 ${ue.purchase_order_number} 수정 요청합니다.`),Ae(""))},[$e,ue]);const Ze=t.useRef(he);t.useEffect(()=>{Ze.current=he},[he]);const et=t.useRef(Le);t.useEffect(()=>{et.current=Le},[Le]);const tt=t.useRef(0),nt=t.useRef(0),rt=t.useRef(!0),at=t.useRef(!1);t.useEffect(()=>{if(!n||!e)return;const t=h(()=>{if(rt.current)return void(rt.current=!1);if(Ze.current)return;if(et.current)return;if(tt.current&&Date.now()-tt.current<3e4)return void c.debug("[PurchaseDetailModal] 저장 직후(30s) - Realtime 캐시 이벤트 무시");if(at.current)return void c.debug("[PurchaseDetailModal] 업데이트 진행 중 - Realtime 이벤트 무시");const t=_(e);if(t){const e=t.items||t.purchase_request_items||[];me(n=>{const r=n?.items||n?.purchase_request_items||[],a=0===e.length&&r.length>0?r:e;return 0===e.length&&0===r.length&&n?(c.debug("[PurchaseDetailModal] 캐시/현재 items 모두 비어있음 - 업데이트 스킵"),n):{...t,id:String(t.id),is_po_generated:!1,items:a,purchase_request_items:a}})}});return()=>t()},[n,e]);const it=t.useMemo(()=>{if(ue?.items&&ue.items.length>0)return Xe(ue.items);if(ue?.purchase_request_items&&ue.purchase_request_items.length>0)return Xe(ue.purchase_request_items);if(e&&ce){const t=ce.find(t=>t.id===e);if(t){const e=t.items&&t.items.length>0?t.items:t.purchase_request_items||[];return Xe(e)}}return[]},[ue,e,ce,oe,Xe]),st=t.useMemo(()=>{if(he)return fe||[];return[...it||[]].sort((e,t)=>{const n=e?.line_number??999999,r=t?.line_number??999999;if(n!==r)return n-r;const a=e?.created_at?new Date(e.created_at).getTime():0,i=t?.created_at?new Date(t.created_at).getTime():0;if(a!==i)return a-i;const s=e?.id??0,c=t?.id??0;if(s!==c)return s-c;const o=e?.tempId??"",l=t?.tempId??"";return o<l?-1:o>l?1:0})},[he,fe,it]),ct=t.useMemo(()=>(fe||[]).map((e,t)=>Je(e,t)),[fe,Je]);t.useMemo(()=>{if(Se.length>0){const e=Se.length>1?12*(Se.length-1):0,t=24,n=Se.reduce((e,t)=>e+t,0)+e+t;return Math.max(n,720)}const e=[120,200,70,90,100,150,80];"purchase"===D&&e.push(120),"receipt"!==D&&"done"!==D||e.push(120),"receipt"===D&&e.push(140),"done"===D&&e.push(100,80,110),he&&e.push(110);const t=e.length>1?12*(e.length-1):0,n=e.reduce((e,t)=>e+t,0)+t+48;return Math.max(n,720)},[Se,D,he]);const ot=t.useRef(null),lt=s();t.useEffect(()=>{n&&(async()=>{try{const e="https://qvhbigvdfyvhoegkhvef.supabase.co";if(!e||e.includes("placeholder"))return void c.warn("Supabase 환경 변수가 설정되지 않음 - PurchaseDetailModal");const{data:{user:t}}=await lt.auth.getUser();if(t){let{data:e}=await lt.from("employees").select("*").eq("id",t.id).maybeSingle();if(!e&&t.email){const{data:n}=await lt.from("employees").select("*").eq("email",t.email).maybeSingle();e=n}if(e?.name&&je(e.name),e?.purchase_role){let t=[];t=Array.isArray(e.purchase_role)?e.purchase_role.map(e=>String(e).trim()):String(e.purchase_role).split(",").map(e=>e.trim()).filter(e=>e.length>0),we(t)}}}catch(e){c.error("사용자 권한 로드 실패:",e)}})()},[n]),t.useEffect(()=>{n&&(async()=>{try{const{data:e,error:t}=await lt.from("vendors").select("*").order("vendor_name",{ascending:!0});if(t)throw t;e&&Ie(e)}catch(e){c.error("업체 목록 로드 실패:",e)}})()},[n]);const dt=Array.isArray(u)&&u.length>0?u:ye,ut=dt.includes("final_approver")||dt.includes("app_admin")||dt.includes("ceo"),mt=dt.includes("lead buyer"),ht=ut||mt,pt=dt.some(e=>Un.includes(e)),_t="발주"===ue?.payment_category&&("done"===D||"receipt"===D&&dt.includes("lead buyer")),gt="발주"===ue?.payment_category&&"done"===D,ft="approved"===ue?.final_manager_status?ut:ut||ue?.requester_name===Ne,vt=dt.includes("app_admin")||dt.includes("lead buyer")||dt.includes("lead buyer"),xt=dt.includes("app_admin")||ue?.requester_name===Ne,bt=dt.includes("final_approver")||dt.includes("app_admin")||dt.includes("ceo"),yt=ue?.requester_name===Ne,wt=dt.includes("app_admin")||dt.includes("lead buyer")||dt.includes("accounting"),Nt=dt.includes("app_admin")||yt,jt=t.useCallback(async()=>{if(e)if(Ze.current||et.current)c.debug("[refreshModalData] 편집/저장 중 - DB 새로고침 스킵",{isEditing:Ze.current,isSaving:et.current});else try{const t=s(),{data:n,error:r}=await t.from("purchase_requests").select("\n          *,\n          vendors:vendor_id(id, vendor_name, is_active),\n          purchase_request_items(*),\n          contact:contact_id(id, contact_name, contact_email, contact_phone, position)\n        ").eq("id",e).single();if(r)throw r;let a=[];if(n&&n.vendor_id){const{data:e}=await t.from("vendor_contacts").select("id, contact_name, contact_email, contact_phone, position").eq("vendor_id",n.vendor_id).order("contact_name");if(e&&e.length>0){if(n.contact_id){const t=e.find(e=>e.id===n.contact_id),r=e.filter(e=>e.id!==n.contact_id);a=t?[t,...r]:e}else a=e;c.info("🔍 업체의 모든 담당자 로드:",{vendor_id:n.vendor_id,contact_id:n.contact_id,allContacts_count:e.length,vendorContacts:a})}}else n&&n.contact&&(a=[n.contact]);if(n){const e=Xe((n.purchase_request_items||[]).sort((e,t)=>(e.line_number||999999)-(t.line_number||999999))),t=e.map(e=>({id:e.id,item_name:e.item_name,amount_value:e.amount_value,unit_price_value:e.unit_price_value,quantity:e.quantity}));c.info("🔍 [refreshModalData] DB에서 가져온 품목 데이터:",{itemsData:t}),t.forEach(e=>{0===e.amount_value&&null!=e.unit_price_value&&0!==e.unit_price_value&&c.warn("⚠️ [refreshModalData] 합계금액이 0인데 단가가 있는 품목:",{itemId:e.id,item_name:e.item_name,amount_value:e.amount_value,unit_price_value:e.unit_price_value,quantity:e.quantity,calculated_amount:(e.quantity||0)*(e.unit_price_value||0)})});const r={...n,items:e,vendor:n.vendors||null,vendor_contacts:a,contact_id:n.contact_id,contact_name:a[0]?.contact_name||n.contact?.contact_name||null};me({...r,items:e}),ge(r),ve(e),c.info("🔍 refreshModalData DB에서 로드 완료:",{vendor_contacts:r.vendor_contacts,vendorContacts_from_query:a,purchase_updated:!0,vendor_id:n.vendor_id,has_vendor_contacts:a&&a.length>0}),c.debug("refreshModalData - DB에서 가져온 데이터:",{vendor_id:n.vendor_id,vendor_contacts:a,purchaseData_full:r,"담당자이름":a?.[0]?.contact_name||"없음"})}}catch(t){c.error("모달 데이터 새로고침 실패",t)}},[e]),St=t.useCallback(async()=>{at.current=!0;try{await jt()}finally{setTimeout(()=>{at.current=!1},3e3)}},[jt]),qt=t.useCallback(async()=>{if(!ue)return;if(!wt||!pt)return;const e=!(ue.is_utk_checked||!1),t=e?`발주번호: ${ue.purchase_order_number}\n\nUTK 확인 처리하시겠습니까?`:`발주번호: ${ue.purchase_order_number}\n\nUTK 확인을 취소하시겠습니까?`;if(window.confirm(t))try{const t=s(),{error:n}=await t.from("purchase_requests").update({is_utk_checked:e}).eq("id",ue.id);if(n)return c.error("UTK 확인 DB 업데이트 실패",{error:n,purchaseId:ue.id}),void K.error("UTK 확인 처리 중 오류가 발생했습니다.");me(t=>t?{...t,is_utk_checked:e,updated_at:(new Date).toISOString()}:null),ue.id&&p(ue.id,t=>({...t,is_utk_checked:e})),K.success(e?"UTK 확인이 완료되었습니다.":"UTK 확인이 취소되었습니다."),await St();const r=I?.(!0,{silent:!0});r instanceof Promise&&await r}catch(n){c.error("UTK 확인 처리 중 오류",n),K.error("UTK 확인 처리 중 오류가 발생했습니다.")}},[ue,wt,pt,I,St]);t.useEffect(()=>{if(!e||!ce||!ue)return;if(he||Le)return;const t=ce.find(t=>t.id===e);if(t){const e=Xe(t.items&&t.items.length>0?t.items:t.purchase_request_items||[]),n={...ue,...t,id:String(t.id),items:e,purchase_request_items:e};me(n),ge(n),ve(e.length>0?e:[])}},[ce,oe,he,Le]),t.useEffect(()=>{if(!n||!e||!ce)return;if(he||Le)return;const t=ce.find(t=>t.id===e);if(t){const e=Xe(t.items&&t.items.length>0?t.items:t.purchase_request_items||[]),n={...t,id:String(t.id),is_po_generated:!1,items:e,purchase_request_items:e,vendor:{id:t.vendor_id,vendor_name:t.vendor_name||"알 수 없음",is_active:!0,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()},vendor_contacts:[]};me(n),ge(n),ve(e.length>0?e:[])}},[n,e,ce,he,Le]);const[Ct,kt]=t.useState(!0),Dt=e?Number(e):ue?Number(ue.id):NaN,Mt=t.useCallback(({itemId:e,selectedDate:t,action:n,receivedQuantity:r})=>{const a=String(e),i=(new Date).toISOString(),s=t?C(t):void 0,c=e=>e?e.map(e=>String(e.id)!==a?e:"confirm"===n?{...e,is_received:!0,actual_received_date:s,received_at:i,received_quantity:void 0!==r?r:e.received_quantity}:{...e,is_received:!1,actual_received_date:void 0,received_at:void 0,received_quantity:void 0}):e;me(e=>{if(!e)return e;const t=c(e.items)||[],n=c(e.purchase_request_items)||[],r=t.length,a=t.filter(e=>e.is_received).length,s=r>0&&a===r;return{...e,items:t,purchase_request_items:n,is_received:s,received_at:s?e.received_at||i:void 0,updated_at:(new Date).toISOString()}}),ge(e=>{if(!e)return e;const t=c(e.items)||[],n=c(e.purchase_request_items)||[];return{...e,items:t,purchase_request_items:n}}),ve(e=>e&&0!==e.length?e.map(e=>e.id&&String(e.id)===a?"confirm"===n?{...e,is_received:!0,actual_received_date:s,received_at:i,received_quantity:void 0!==r?r:e.received_quantity}:{...e,is_received:!1,actual_received_date:void 0,received_at:void 0,received_quantity:void 0}:e):e),Number.isNaN(Dt)||ie?.(Dt,e=>{const t=c(e.items)||e.items||[],n=c(e.purchase_request_items)||e.purchase_request_items||[],r=t.length||e.items?.length||0,a=t.filter(e=>e.is_received).length,s=r>0&&a===r;return{...e,items:t,purchase_request_items:n,is_received:s,received_at:s?e.received_at||i:void 0,updated_at:(new Date).toISOString()}})},[ie,Dt]),Rt=t.useCallback(({itemId:e,selectedDate:t,action:n})=>{const r=String(e),a=t?C(t):void 0;let i=!1,o=null;if(me(e=>{if(!e)return e;const t=(e.items||[]).map(e=>String(e.id)!==r?e:"confirm"===n?{...e,is_statement_received:!0,statement_received_date:a,statement_received_by_name:Ne}:{...e,is_statement_received:!1,statement_received_date:null,statement_received_by_name:null});return i=t.length>0&&t.every(e=>e.is_statement_received),o=i?a||e.statement_received_at||(new Date).toISOString():null,{...e,items:t,is_statement_received:i,statement_received_at:o}}),ge(e=>{if(!e)return e;const t=(e.items||[]).map(e=>String(e.id)!==r?e:"confirm"===n?{...e,is_statement_received:!0,statement_received_date:a,statement_received_by_name:Ne}:{...e,is_statement_received:!1,statement_received_date:null,statement_received_by_name:null});return{...e,items:t,is_statement_received:i,statement_received_at:o}}),ve(e=>e?e.map(e=>String(e.id)!==r?e:"confirm"===n?{...e,is_statement_received:!0,statement_received_date:a,statement_received_by_name:Ne}:{...e,is_statement_received:!1,statement_received_date:null,statement_received_by_name:null}):e),Number.isNaN(Dt)||ie?.(Dt,e=>{const t=(e.items||[]).map(e=>String(e.id)!==r?e:"confirm"===n?{...e,is_statement_received:!0,statement_received_date:a,statement_received_by_name:Ne}:{...e,is_statement_received:!1,statement_received_date:null,statement_received_by_name:null}),i=t.length>0&&t.every(e=>e.is_statement_received);return{...e,items:t,is_statement_received:i}}),ue&&void 0!==i){s().from("purchase_requests").update({is_statement_received:i,statement_received_at:o}).eq("id",ue.id).then(({error:e})=>{e&&c.error("거래명세서 확인 purchase_requests 업데이트 실패",e)})}},[Ne,ie,Dt,ue]),$t=t.useCallback(()=>{at.current=!0,c.debug("[PurchaseDetailModal] 업데이트 시작 - Realtime 이벤트 무시 활성화")},[]),Et=An({config:{field:"statement_received",confirmMessage:{confirm:"거래명세서 확인을 처리하시겠습니까?",cancel:"거래명세서 확인을 취소하시겠습니까?"},successMessage:{confirm:"거래명세서 확인이 완료되었습니다.",cancel:"거래명세서 확인이 취소되었습니다."},completedText:"✓ 완료",waitingText:"대기"},currentUserName:Ne,canPerformAction:wt,purchaseId:ue?.id,onBeforeUpdate:$t,onUpdate:St,onOptimisticUpdate:Rt}),Tt=An({config:{field:"actual_received",confirmMessage:{confirm:"실제 입고 처리를 진행하시겠습니까?",cancel:"실제 입고 처리를 취소하시겠습니까?"},successMessage:{confirm:"실제 입고 처리가 완료되었습니다.",cancel:"실제 입고 처리가 취소되었습니다."},completedText:"입고완료",waitingText:"입고대기"},currentUserName:Ne,canPerformAction:Nt,purchaseId:ue?.id,onBeforeUpdate:$t,onUpdate:St,onOptimisticUpdate:Mt}),Ot=dt.includes("middle_manager")||dt.includes("app_admin")||dt.includes("ceo"),Pt=dt.includes("final_approver")||dt.includes("app_admin")||dt.includes("ceo"),At="inline-flex items-center gap-1 business-radius-badge !h-auto !min-h-0 !px-2.5 !py-0.5 badge-text leading-tight",Wt="inline-flex items-center gap-1 business-radius-badge px-2.5 py-0.5 badge-text leading-tight";t.useEffect(()=>{if(e&&n){const t=_(e);if(t){const e={...t,id:String(t.id),is_po_generated:!1,vendor:t.vendor||(t.vendor_id?{id:t.vendor_id,vendor_name:t.vendor_name||"알 수 없음",is_active:!0,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}:null),vendor_contacts:t.vendor_contacts||[]};me(e),ge(e),ve(t.items||[])}else Kt(e.toString());pe(!1),Ft(e)}},[e,n]);const Ft=async e=>{try{const t=await Hn.getStatementsByPurchaseId(e);t.success&&t.data&&Ke(t.data)}catch(t){Ke([])}},Lt=t.useCallback(()=>{const e=ue?.items&&ue.items.length>0?ue.items:ue?.purchase_request_items&&ue.purchase_request_items.length>0?ue.purchase_request_items:[];if(0===e.length)return[];const t=[{key:"line_number",minWidth:32,maxWidth:32,baseWidth:32,isFixed:!0},{key:"item_name",minWidth:80,maxWidth:500,baseWidth:80},{key:"specification",minWidth:80,maxWidth:200,baseWidth:150,isFixed:!1},{key:"quantity",minWidth:70,maxWidth:120,baseWidth:70},{key:"unit_price",minWidth:90,maxWidth:150,baseWidth:90},{key:"total_price",minWidth:100,maxWidth:180,baseWidth:100}];"발주"===ue?.payment_category&&t.push({key:"tax_amount",minWidth:80,maxWidth:150,baseWidth:80}),t.push({key:"link",minWidth:60,maxWidth:80,baseWidth:60,isFixed:!0}),t.push({key:"remarks",minWidth:150,maxWidth:150,baseWidth:150,isFixed:!0}),"pending"!==D&&t.push({key:"status",minWidth:70,maxWidth:100,baseWidth:70}),"receipt"===D&&(t.push({key:"actual_receipt_date",minWidth:100,maxWidth:160,baseWidth:100,isFixed:!1}),_t&&t.push({key:"transaction_confirm",minWidth:85,maxWidth:120,baseWidth:85,isFixed:!1},{key:"accounting_date",minWidth:70,maxWidth:70,baseWidth:70,isFixed:!0})),"done"===D&&"발주"===ue?.payment_category&&t.push({key:"transaction_confirm",minWidth:85,maxWidth:120,baseWidth:85,isFixed:!1},{key:"accounting_date",minWidth:70,maxWidth:70,baseWidth:70,isFixed:!0},{key:"expenditure_info",minWidth:90,maxWidth:150,baseWidth:90,isFixed:!1});const n=t.map((t,n)=>{let r=4;const a=(()=>{const e="purchase"===D?"구매상태":"receipt"===D||"done"===D?"입고상태":"상태",t="receipt"===D||"done"===D?"요청/실제 입고수량":"요청수량",n="pending"===D?["#","품목명","규격",t,"단가","합계","발주"===ue?.payment_category?"세액":null,"비고"].filter(e=>null!==e):["#","품목명","규격",t,"단가","합계","발주"===ue?.payment_category?"세액":null,"비고",e].filter(e=>null!==e);if("receipt"===D){const e=[...n,"실제입고일"];return _t&&e.push("거래명세서 확인","회계상 입고일"),e}if("done"===D){const e=[...n];return _t&&(e.push("거래명세서 확인","회계상 입고일"),gt&&e.push("지출정보")),e}return n})();if(a[n]&&(r=Math.max(r,a[n].length)),e.forEach(e=>{let n="";switch(t.key){case"line_number":n=e.line_number?.toString()||"";break;case"item_name":n=e.item_name||"";break;case"specification":n=e.specification||"";break;case"quantity":if("receipt"===D||"done"===D){const t=e.quantity||0,r=e.received_quantity??0;n=t>=100||r>=100?`${t}`:`${t}/${r}`}else n=e.quantity?.toString()||"";break;case"unit_price":n=null!=e.unit_price_value?e.unit_price_value.toLocaleString():"";break;case"total_price":n=null!=e.amount_value?e.amount_value.toLocaleString():null!=e.quantity&&null!=e.unit_price_value?(Number(e.quantity)*Number(e.unit_price_value)).toLocaleString():"";break;case"tax_amount":n=null!=e.tax_amount_value?e.tax_amount_value.toLocaleString():"";break;case"remarks":n=e.remark||"";break;case"status":n=zt(e)||"";break;case"actual_receipt_date":n=e.actual_received_date?k(e.actual_received_date):"";break;case"transaction_confirm":n=e.is_statement_received?"확인완료":"미확인";break;case"accounting_date":n=e.statement_received_date?k(e.statement_received_date):"";break;case"expenditure_info":n=e.expenditure_date&&null!==e.expenditure_amount&&void 0!==e.expenditure_amount?"2025. 11. 25.":"지출입력"}const a=n.split("").reduce((e,t)=>e+(/[가-힣]/.test(t)?1.5:1),0);r=Math.max(r,Math.ceil(a))}),t.isFixed)return t.baseWidth;let i=Math.max(t.minWidth,Math.min(t.maxWidth,7*r+20));return"expenditure_info"===t.key&&(i=110),i});return qe(n),n},[ue,D,_t,gt]),zt=e=>"purchase"===D?e.is_payment_completed?"구매완료":"구매요청":"receipt"===D?e.is_received?"입고":"입고대기":e.is_payment_completed?"구매완료":"구매요청",Ut=()=>{if(Se.length>0){return Se.map(e=>`${e}px`).join(" ")}const e=["32px","minmax(80px, 1fr)","200px","70px","90px","100px"];if("발주"===ue?.payment_category&&e.push("100px"),e.push("60px"),e.push("150px"),"pending"!==D&&e.push("80px"),"receipt"===D){const t=[...e,"100px"];return _t&&t.push("100px","80px"),t.join(" ")}if("done"===D){const t=[...e];return _t&&(t.push("100px","80px"),gt&&t.push("110px")),t.join(" ")}return e.join(" ")};t.useEffect(()=>{const e=ue?.items&&ue.items.length>0||ue?.purchase_request_items&&ue.purchase_request_items.length>0;ue&&e&&!he&&requestAnimationFrame(()=>{Lt()})},[ue,he,D,Lt]);const Bt=e=>{if(e&&!he){ge(ue);const e=[...it||[]].sort((e,t)=>(e?.line_number??999999)-(t?.line_number??999999));ve(e),be([]),Lt()}pe(e)},Kt=async e=>{try{const t=_(e);if(t){const e={...t,id:String(t.id),is_po_generated:!1,vendor:t.vendor||(t.vendor_id?{id:t.vendor_id,vendor_name:t.vendor_name||"알 수 없음",is_active:!0,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}:null),vendor_contacts:t.vendor_contacts||[]};return me({...e,items:Xe(t.items||e.items||[])}),ge(e),void ve(Xe(t.items||[]))}de(!0);const n=s(),{data:r,error:a}=await n.from("purchase_requests").select("\n          *,\n          vendors:vendor_id(id, vendor_name, is_active),\n          purchase_request_items(*),\n          contact:contact_id(id, contact_name, contact_email, contact_phone, position)\n        ").eq("id",e).single();if(a)throw a;let i=[];if(r&&r.vendor_id){const{data:e}=await n.from("vendor_contacts").select("id, contact_name, contact_email, contact_phone, position").eq("vendor_id",r.vendor_id).order("contact_name");if(e&&e.length>0){if(r.contact_id){const t=e.find(e=>e.id===r.contact_id),n=e.filter(e=>e.id!==r.contact_id);i=t?[t,...n]:e}else i=e;c.info("🔍 loadPurchaseDetail - 업체의 모든 담당자 로드:",{vendor_id:r.vendor_id,contact_id:r.contact_id,allContacts_count:e.length,vendorContacts:i})}}else r&&r.contact&&(i=[r.contact]);if(r){const e=Xe((r.purchase_request_items||[]).sort((e,t)=>(e.line_number||999999)-(t.line_number||999999))),t={...r,items:e,vendor:r.vendors||null,vendor_contacts:i,contact_id:r.contact_id,contact_name:i[0]?.contact_name||r.contact?.contact_name||null};me({...t,items:e}),ge(t),ve(e)}}catch(t){c.error("[PurchaseDetailModal] 발주 상세 로드 실패:",t),K.error("발주 상세 정보를 불러오는데 실패했습니다.")}finally{de(!1)}},Vt=(e,t=0)=>{if(null==e)return t;if("string"==typeof e){const n=e.trim();if(""===n)return t;const r=n.replace(/,/g,""),a=Number(r);return Number.isNaN(a)?t:a}const n=Number(e);return Number.isNaN(n)?t:n},Ht=e=>new Intl.NumberFormat("ko-KR").format(e),Yt=e=>"USD"===e?"USD":"KRW",Qt=()=>Yt(he?_e?.currency:ue?.currency),Xt=e=>Yt(e?.unit_price_currency??e?.amount_currency??e?.tax_amount_currency??Qt()),Jt=(e,t)=>`${(e=>"USD"===Yt(e)?"$":"₩")(t)}${Ht(e)}`,Gt=(e,t)=>Promise.race([Promise.resolve(e),new Promise((e,n)=>setTimeout(()=>n(new Error(`작업이 ${t}ms 내에 완료되지 않았습니다.`)),t))]),Zt=(e,t,n)=>{const r=[...fe];if("quantity"===t||"unit_price_value"===t){if(r[e]?.is_amount_manual)return r[e]={...r[e],[t]:n},void ve(r);const a="quantity"===t?n:r[e].quantity,i="unit_price_value"===t?n:r[e].unit_price_value;if(null!=i&&void 0!==i&&""!==i&&0!==i&&(null!=a&&void 0!==a&&0!==a)){const s=(a||0)*(i||0),c="발주"===ue?.payment_category?Math.round(.1*s):0;r[e]={...r[e],[t]:n,amount_value:s,tax_amount_value:c}}else r[e]={...r[e],[t]:n}}else if("amount_value"===t){let t=0;if(""!==n&&null!=n&&void 0!==n){const e=Number(n);Number.isNaN(e)||(t=e)}const a="발주"===ue?.payment_category?Math.round(.1*t):0;r[e]={...r[e],is_amount_manual:!0,amount_value:t,tax_amount_value:a}}else r[e]={...r[e],[t]:n};ve(r)},en=async(e,t)=>{if(!vt)return c.warn("[handlePaymentToggle] 권한 없음",{canPurchase:vt,currentUserRoles:u}),void K.error("구매완료 처리 권한이 없습니다.");const n=String(e),r="number"==typeof e?e:Number(e);if(Number.isNaN(r))return c.error("[handlePaymentToggle] 잘못된 ID",{itemId:e,numericId:r}),void K.error("유효하지 않은 항목 ID 입니다.");if(!ue)return;const a=ue.items&&ue.items.length>0?ue.items:[],i=ue.purchase_request_items&&ue.purchase_request_items.length>0?ue.purchase_request_items:[],s=(a.length>0?a:i).find(e=>String(e.id)===n);if(!s)return;const o=`품명: ${s.item_name}\n규격: ${s.specification||"미입력"}\n수량: ${s.quantity?.toLocaleString()||0}${s.unit||""}\n단가: ₩${s.unit_price_value?.toLocaleString()||0}\n합계: ₩${s.amount_value?.toLocaleString()||0}`,l=t?`다음 품목을 구매완료 처리하시겠습니까?\n\n${o}`:`다음 품목의 구매완료를 취소하시겠습니까?\n\n${o}`;if(window.confirm(l))try{const{error:e}=await lt.from("purchase_request_items").update({is_payment_completed:t,payment_completed_at:t?(new Date).toISOString():null}).eq("id",r);if(e)throw e;if(ue){(t?y(ue.id,r):S(ue.id,r))||c.warn("[PurchaseDetailModal] 메모리 캐시 품목 업데이트 실패",{purchaseId:ue.id,itemId:r,isCompleted:t})}if(me(e=>{if(!e)return null;const r=e.items&&e.items.length>0?e.items:[],a=e.purchase_request_items&&e.purchase_request_items.length>0?e.purchase_request_items:[],i=(r.length>0?r:a).map(e=>String(e.id)===n?{...e,is_payment_completed:t,payment_completed_at:t?(new Date).toISOString():null}:e);return{...e,items:e.items?i:e.items,purchase_request_items:e.purchase_request_items?i:e.purchase_request_items}}),ue){const e=Number(ue.id);Number.isNaN(e)||ie?.(e,e=>{const r=(e.items||[]).map(e=>String(e.id)===n?{...e,is_payment_completed:t}:e),a=r.length||e.items?.length||0,i=r.filter(e=>e.is_payment_completed).length,s=a>0&&i===a;return{...e,items:r,is_payment_completed:s,payment_completed_at:s?(new Date).toISOString():null,payment_completed_by_name:s&&Ne||e.payment_completed_by_name}})}K.success(t?"구매완료 처리되었습니다.":"구매완료가 취소되었습니다."),await St();const a=I?.(!0,{silent:!0});a instanceof Promise&&await a}catch(d){K.error("구매완료 처리 중 오류가 발생했습니다.")}},tn=async(e,t,n)=>{if(at.current=!0,!xt)return K.error("입고 처리 권한이 없습니다."),void(at.current=!1);const r=String(e),a="number"==typeof e?e:Number(e);if(Number.isNaN(a))return void K.error("유효하지 않은 항목 ID 입니다.");const i=ue?.items?.find(e=>String(e.id)===r)||ue?.purchase_request_items?.find(e=>String(e.id)===r),s=i?.quantity||0,l=void 0!==n?n:s,d=(i?.received_quantity||0)+l,u=d>=s,m=0===d?"pending":u?"received":"partial",h=i?.receipt_history||[],p={seq:h.length+1,qty:l,date:C(t),by:Ne||"알수없음"},_=[...h,p],g=ue?Number(ue.id):NaN;try{const{error:e}=await lt.from("purchase_request_items").update({is_received:u,delivery_status:m,received_at:(new Date).toISOString(),actual_received_date:C(t),received_quantity:d,receipt_history:_}).eq("id",a);if(e)throw e;if(ue){o(ue.id,a,C(t),d)||c.warn("[PurchaseDetailModal] 메모리 캐시 개별 품목 입고완료 업데이트 실패",{purchaseId:ue.id,itemId:a})}me(e=>{if(!e)return null;const n=e.items?.map(e=>String(e.id)===r?{...e,is_received:u,delivery_status:m,received_at:(new Date).toISOString(),actual_received_date:C(t),received_quantity:d,receipt_history:_}:e),a=e.purchase_request_items?.map(e=>String(e.id)===r?{...e,is_received:u,delivery_status:m,received_at:(new Date).toISOString(),actual_received_date:C(t),received_quantity:d,receipt_history:_}:e);return{...e,items:n,purchase_request_items:a,updated_at:(new Date).toISOString()}}),Number.isNaN(g)||ie?.(g,e=>{const n=(e.items||[]).map(e=>String(e.id)===r?{...e,is_received:u,delivery_status:m,actual_received_date:C(t),received_quantity:d,receipt_history:_}:e),a=n.length||e.items?.length||0,i=n.filter(e=>e.is_received).length,s=a>0&&i===a;return{...e,items:n,is_received:s,received_at:s?(new Date).toISOString():e.received_at}});const n=ue?.items?.find(e=>String(e.id)===r);K.success(`"${n?.item_name}" 품목이 입고완료 처리되었습니다.`),await St();const i=I?.(!0,{silent:!0});i instanceof Promise&&await i}catch(f){K.error("입고완료 처리 중 오류가 발생했습니다.")}},nn=async e=>{if(!ue)return;const t="middle"===e?"1차 승인":"최종 승인",n=`발주번호: ${ue.purchase_order_number}\n\n${t}을 진행하시겠습니까?`;if(window.confirm(n))try{const t="middle"===e?{middle_manager_status:"approved"}:{final_manager_status:"approved"},{error:n}=await lt.from("purchase_requests").update(t).eq("id",ue.id);if(n)throw n;if(me("middle"===e?e=>e?{...e,middle_manager_status:"approved"}:null:e=>e?{...e,final_manager_status:"approved"}:null),p(String(ue.id),t=>({...t,..."middle"===e?{middle_manager_status:"approved"}:{final_manager_status:"approved"}})),ue&&ie){const t=Number(ue.id);Number.isNaN(t)||ie(t,t=>"middle"===e?{...t,middle_manager_status:"approved"}:{...t,final_manager_status:"approved"})}K.success(("middle"===e?"중간":"최종")+" 승인이 완료되었습니다."),await St();const r=I?.(!0,{silent:!0});r instanceof Promise&&await r}catch(r){K.error("승인 처리 중 오류가 발생했습니다.")}},rn=async(e,t,n)=>{if(!ue||!wt)return void K.error("지출 정보 입력 권한이 없습니다.");const r=String(e),a="number"==typeof e?e:Number(e);if(Number.isNaN(a))return void c.error("유효하지 않은 itemId",{itemId:e});const i=ue.items?.find(e=>String(e.id)===r);if(!i)return;const s=ue?Number(ue.id):NaN;try{Number.isNaN(s)||ie?.(s,e=>{const a=(e.items||[]).map(e=>String(e.id)===r?{...e,expenditure_date:C(t),expenditure_amount:n}:e);return{...e,items:a}}),me(e=>{if(!e)return null;const a=(e.items||e.purchase_request_items||[]).map(e=>String(e.id)===r?{...e,expenditure_date:C(t),expenditure_amount:n}:e),i=a.reduce((e,t)=>e+(t.expenditure_amount||0),0);return{...e,items:a,purchase_request_items:a,total_expenditure_amount:i,updated_at:(new Date).toISOString()}});const{error:e}=await lt.from("purchase_request_items").update({expenditure_date:C(t),expenditure_amount:n}).eq("id",a);if(e)throw c.error("지출 정보 DB 업데이트 실패",{error:e,itemId:a}),e;const o=(ue.items||ue.purchase_request_items||[]).reduce((e,t)=>String(t.id)===r?e+n:e+(t.expenditure_amount||0),0);if(await lt.from("purchase_requests").update({total_expenditure_amount:o}).eq("id",s),ue?.id){q(ue.id,a,C(t),n)||c.warn("[PurchaseDetailModal] 메모리 캐시 지출 정보 업데이트 실패",{purchaseId:ue.id,itemId:a})}K.success(`"${i.item_name}" 품목의 지출 정보가 저장되었습니다.`),await St();const l=I?.(!0,{silent:!0});l instanceof Promise&&await l}catch(o){c.error("지출 정보 입력 중 오류",o),K.error("지출 정보 입력 중 오류가 발생했습니다.")}},an=(e,t,n,r)=>{const s=r||e?.stableKey||Je(e,t),c={className:`px-2 sm:px-3 py-1 border-b border-gray-50 hover:bg-gray-50/50 relative overflow-visible w-fit ${he?"pl-7 sm:pl-8":""} ${n?.isDragging?"shadow-lg ring-2 ring-blue-200 bg-white":""}`,key:s};return n?.setNodeRef&&(c.ref=n.setNodeRef),n?.style&&(c.style=n.style),a.jsxs("div",{...c,children:[he&&n&&a.jsx("button",{className:"absolute left-1 top-2 sm:top-3 text-gray-400 hover:text-gray-600 p-1 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-200",...n.attributes,...n.listeners,"aria-label":"드래그하여 품목 순서 변경",children:a.jsx(ee,{className:"w-3.5 h-3.5"})}),a.jsxs("div",{className:"hidden sm:grid items-center gap-1 overflow-visible w-fit",style:{gridTemplateColumns:Ut()},children:[a.jsx("div",{className:"flex justify-center items-center text-[11px] text-gray-500 font-medium -ml-2 sm:-ml-3",children:e.line_number||t+1}),a.jsx("div",{className:"min-w-0 relative overflow-visible flex items-center",children:he?a.jsx(E,{value:e.item_name,onChange:e=>Zt(t,"item_name",e.target.value),onFocus:()=>ke(`item_name_${t}`),onBlur:()=>ke(null),className:"modal-label border-gray-200 rounded-lg w-full !px-1.5 !py-0.5 !text-[10px] focus:border-blue-400 transition-all duration-200 "+(Ce===`item_name_${t}`?"!h-auto !min-h-[20px] !absolute !z-[9999] !bg-white !shadow-lg !left-0 !right-0 !-translate-y-1/2 !top-1/2 !whitespace-normal":"!h-5 !truncate"),placeholder:"품목명"}):a.jsx("div",{className:"modal-value",style:{whiteSpace:"normal",wordBreak:"break-all",overflowWrap:"break-word",hyphens:"none",WebkitHyphens:"none",MozHyphens:"none",msHyphens:"none",lineHeight:"1.4",maxHeight:"2.8em",overflow:"hidden",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical"},title:e.item_name||"품목명 없음",children:e.item_name||"품목명 없음"})}),a.jsx("div",{className:"min-w-0 relative overflow-visible flex items-center w-full",children:he?a.jsx(E,{value:e.specification,onChange:e=>Zt(t,"specification",e.target.value),onFocus:()=>ke(`specification_${t}`),onBlur:()=>ke(null),className:"modal-label border-gray-200 rounded-lg w-full !px-1.5 !py-0.5 !text-[10px] focus:border-blue-400 transition-all duration-200 "+(Ce===`specification_${t}`?"!h-auto !min-h-[20px] !absolute !z-[9999] !bg-white !shadow-lg !left-0 !right-0 !-translate-y-1/2 !top-1/2 !whitespace-normal":"!h-5 !truncate"),placeholder:"규격"}):a.jsx("div",{className:"text-[11px] text-gray-600 font-medium",style:{whiteSpace:"normal",wordBreak:"break-all",overflowWrap:"break-word",hyphens:"none",WebkitHyphens:"none",MozHyphens:"none",msHyphens:"none",lineHeight:"1.4",maxHeight:"2.8em",overflow:"hidden",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical"},title:e.specification||"-",children:e.specification||"-"})}),a.jsx("div",{className:"text-center min-w-0 flex items-center justify-center",children:he?"receipt"===D||"done"===D?a.jsxs("div",{className:"flex flex-col items-center gap-0.5 w-full",children:[a.jsx(E,{type:"number",value:e.quantity,onChange:e=>Zt(t,"quantity",Number(e.target.value)),className:"border-gray-200 rounded-lg text-center w-full !h-5 !px-1.5 !py-0.5 !text-[9px] font-normal text-gray-600 focus:border-blue-400",placeholder:"요청수량",max:"99999",disabled:mt&&!ut}),a.jsxs("div",{className:"flex items-center gap-0.5 w-full",children:[a.jsx("span",{className:"text-[9px] text-gray-500",children:"/"}),a.jsx(E,{type:"number",value:e.received_quantity??"",onChange:e=>Zt(t,"received_quantity",e.target.value?Number(e.target.value):null),className:"border-gray-200 rounded-lg text-center flex-1 !h-5 !px-1.5 !py-0.5 !text-[9px] font-normal text-gray-600 focus:border-blue-400",placeholder:"실제입고",max:"99999",disabled:mt&&!ut})]})]}):a.jsx(E,{type:"number",value:e.quantity,onChange:e=>Zt(t,"quantity",Number(e.target.value)),className:"border-gray-200 rounded-lg text-center w-full !h-5 !px-1.5 !py-0.5 !text-[9px] font-normal text-gray-600 focus:border-blue-400",placeholder:"수량",max:"99999",disabled:mt&&!ut}):"receipt"===D||"done"===D?(()=>{const t=e.quantity||0,n=e.received_quantity??0,r=n>0;return t>=100||n>=100?a.jsxs("div",{className:"flex flex-col items-center leading-tight",children:[a.jsx("div",{className:"modal-subtitle "+(r?"text-gray-400":""),children:t}),a.jsxs("div",{className:"modal-subtitle "+(r?"":"text-gray-400"),children:["/",n]})]}):a.jsxs("span",{className:"modal-subtitle",children:[a.jsx("span",{className:r?"text-gray-400":"",children:t}),a.jsxs("span",{className:r?"":"text-gray-400",children:["/",n]})]})})():a.jsx("span",{className:"modal-subtitle",children:e.quantity||0})}),a.jsx("div",{className:"text-right min-w-0 flex items-center justify-end",children:he?a.jsx(E,{type:"number",value:e.unit_price_value??0,onChange:e=>Zt(t,"unit_price_value",Number(e.target.value)),onWheel:e=>e.currentTarget.blur(),className:"border-gray-200 rounded-lg text-right w-full !h-5 !px-1.5 !py-0.5 !text-[9px] font-normal text-gray-600 focus:border-blue-400",placeholder:"단가",max:"100000000000"}):a.jsx("span",{className:"modal-subtitle",children:"done"!==D||pt?Jt(e.unit_price_value??0,Xt(e)):"-"})}),a.jsx("div",{className:"text-right min-w-0 flex items-center justify-end",children:he?a.jsx(E,{type:"number",value:e.amount_value||0,onChange:e=>Zt(t,"amount_value",Number(e.target.value)),onWheel:e=>e.currentTarget.blur(),className:"border-gray-200 rounded-lg w-full !h-6 !px-1.5 !py-0.5 !text-[10px] font-normal text-gray-600 focus:border-blue-400 text-right",placeholder:"합계"}):a.jsx("span",{className:"modal-value",children:"done"!==D||pt?Jt(e.amount_value||0,Xt(e)):"-"})}),"발주"===ue?.payment_category&&a.jsx("div",{className:"text-right min-w-0 flex items-center justify-end",children:a.jsx("span",{className:he?"modal-subtitle":"modal-value",children:"done"!==D||pt?Jt(e.tax_amount_value||0,Xt(e)):"-"})}),a.jsx("div",{className:"text-center min-w-0 flex items-center justify-center",children:he?a.jsx(E,{value:e.link||"",onChange:e=>Zt(t,"link",e.target.value),className:"border-gray-200 rounded-lg text-center w-full !h-5 !px-1.5 !py-0.5 !text-[9px] font-normal text-gray-600 focus:border-blue-400",placeholder:"링크(URL)"}):e.link?a.jsx("a",{href:e.link,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:text-blue-800 underline text-[11px]",onClick:e=>e.stopPropagation(),children:"링크"}):a.jsx("span",{className:"text-gray-400 text-[11px]",children:"-"})}),a.jsx("div",{className:"min-w-0 flex justify-center items-center text-center relative overflow-visible",style:{width:"150px",maxWidth:"150px",minWidth:"150px"},children:he?a.jsx(E,{value:e.remark||"",disabled:mt&&!ut,onChange:e=>Zt(t,"remark",e.target.value),onFocus:()=>ke(`remark_${t}`),onBlur:()=>ke(null),className:"modal-label border-gray-200 rounded-lg text-center w-full !px-1.5 !py-0.5 !text-[10px] focus:border-blue-400 transition-all duration-200 "+(Ce===`remark_${t}`?"!h-auto !min-h-[20px] !absolute !z-[9999] !bg-white !shadow-lg !left-0 !right-0 !-translate-y-1/2 !top-1/2 !whitespace-normal !text-left":"!h-5 !truncate"),placeholder:"비고"}):a.jsx("div",{className:"text-[11px] text-gray-600 font-medium",style:{width:"150px",maxWidth:"150px",minWidth:"150px",boxSizing:"border-box",whiteSpace:"normal",wordBreak:"break-all",overflowWrap:"break-word",hyphens:"none",WebkitHyphens:"none",MozHyphens:"none",msHyphens:"none",lineHeight:"1.4",maxHeight:"2.8em",overflow:"hidden",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical"},title:e.remark||"-",children:e.remark||"-"})}),"pending"!==D&&a.jsx("div",{className:"text-center flex justify-center items-center",children:he?a.jsx(i,{size:"sm",variant:"ghost",onClick:()=>(e=>{const t=fe[e];t.id&&be([...xe,t.id]);const n=fe.filter((t,n)=>n!==e).sort((e,t)=>(e.line_number||999999)-(t.line_number||999999)).map((e,t)=>({...e,line_number:t+1,stableKey:e.stableKey??Qe(e,t)}));ve(n)})(t),className:"text-red-600 hover:bg-red-50 rounded-lg p-1 h-6 w-6",disabled:mt&&!ut,children:a.jsx(Q,{className:"w-3 h-3"})}):a.jsxs(a.Fragment,{children:["purchase"===D&&a.jsx("div",{className:"flex flex-col items-center gap-1",children:a.jsx("div",{className:"flex justify-center",children:vt?a.jsx("button",{onClick:()=>en(e.id,!e.is_payment_completed),className:""+(e.is_payment_completed?"button-toggle-active bg-orange-500 hover:bg-orange-600 text-white":"button-toggle-inactive"),children:e.is_payment_completed?"구매완료":"구매대기"}):a.jsx("span",{className:""+(e.is_payment_completed?"button-toggle-active bg-orange-500 text-white":"button-waiting-inactive"),children:e.is_payment_completed?"구매완료":"구매대기"})})}),"receipt"===D&&a.jsx("div",{className:"flex justify-center",children:xt?Tt.isCompleted(e)?a.jsx("button",{onClick:()=>{Tt.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-action-primary",children:Tt.config.completedText}):Tt.isPartiallyReceived(e)?a.jsx(Pn,{onConfirm:(t,n)=>{tn(e.id,t,n)},placeholder:"추가 입고수량을 입력하세요",align:"center",side:"bottom",maxQuantity:Tt.getRemainingQuantity(e),quantityInfoText:`미입고: ${Tt.getRemainingQuantity(e)}개`,children:a.jsx("button",{className:"button-base bg-blue-300 hover:bg-blue-400 text-white",children:"부분입고"})}):a.jsx(Pn,{onConfirm:(t,n)=>{tn(e.id,t,n)},placeholder:"날짜와 실제입고수량을 입력하세요",align:"center",side:"bottom",defaultQuantity:e.received_quantity??void 0,maxQuantity:e.quantity,children:a.jsx("button",{className:"button-toggle-inactive",children:Tt.config.waitingText})}):a.jsx("span",{className:""+(Tt.isCompleted(e)?"button-action-primary":Tt.isPartiallyReceived(e)?"button-base bg-blue-300 text-white":"button-waiting-inactive"),children:Tt.isCompleted(e)?Tt.config.completedText:Tt.isPartiallyReceived(e)?"부분입고":Tt.config.waitingText})}),"done"===D&&a.jsx("div",{className:"flex justify-center",children:xt?Tt.isCompleted(e)?a.jsx("button",{onClick:()=>{Tt.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-base bg-blue-500 hover:bg-blue-600 text-white",children:Tt.config.completedText}):Tt.isPartiallyReceived(e)?a.jsx(Pn,{onConfirm:(t,n)=>{tn(e.id,t,n)},placeholder:"추가 입고수량을 입력하세요",align:"center",side:"bottom",maxQuantity:Tt.getRemainingQuantity(e),quantityInfoText:`미입고: ${Tt.getRemainingQuantity(e)}개`,children:a.jsx("button",{className:"button-base bg-blue-300 hover:bg-blue-400 text-white",children:"부분입고"})}):a.jsx(M,{onDateSelect:t=>{Tt.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"실제 입고된 날짜를 선택하세요",align:"center",side:"bottom",children:a.jsx("button",{className:"button-base border border-gray-300 text-gray-600 bg-white hover:bg-gray-50",children:Tt.config.waitingText})}):a.jsx("span",{className:"button-base "+(Tt.isCompleted(e)?"bg-blue-500 hover:bg-blue-600 text-white":Tt.isPartiallyReceived(e)?"bg-blue-300 text-white":"border border-gray-300 text-gray-600 bg-white hover:bg-gray-50"),children:Tt.isCompleted(e)?"입고완료":Tt.isPartiallyReceived(e)?"부분입고":"입고대기"})}),"purchase"!==D&&"receipt"!==D&&"done"!==D&&a.jsx("div",{className:"flex justify-center",children:a.jsx("span",{className:"badge-text",children:"-"})})]})}),"receipt"===D&&a.jsx("div",{className:"text-center flex justify-center items-center pl-2",children:Tt.getCompletedDate(e)?a.jsx("div",{className:"modal-subtitle text-green-700",children:new Date(Tt.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})}):a.jsx("span",{className:"modal-subtitle text-gray-400",children:"-"})}),_t&&a.jsx("div",{className:"text-center flex justify-center items-center",children:wt?Et.isCompleted(e)?a.jsx("button",{onClick:()=>{Et.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-action-primary hover:bg-green-600",title:"클릭하여 거래명세서 확인 취소",children:Et.config.completedText}):a.jsx(M,{onDateSelect:t=>{Et.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"회계상 입고일을 선택하세요",align:"center",side:"bottom",children:a.jsx("button",{className:"button-toggle-inactive",onClick:()=>{},children:Et.config.waitingText})}):a.jsx("span",{className:""+(Et.isCompleted(e)?"button-action-primary":"button-waiting-inactive"),children:Et.isCompleted(e)?Et.config.completedText:Et.config.waitingText})}),_t&&a.jsx("div",{className:"text-center flex justify-center items-center",children:Et.getCompletedDate(e)?a.jsx("div",{className:"modal-subtitle text-blue-700",children:new Date(Et.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})}):a.jsx("span",{className:"modal-subtitle text-gray-400",children:"-"})}),gt&&a.jsx("div",{className:"text-center flex justify-center items-center",children:(()=>{const t=!!e.expenditure_date,n=null!==e.expenditure_amount&&void 0!==e.expenditure_amount;return wt?t?a.jsxs("div",{className:"w-full px-1 leading-none",children:[a.jsx("div",{className:"text-blue-700 text-[9px] leading-[1.1] font-normal",children:(()=>{const t=new Date(e.expenditure_date);return`${t.getFullYear().toString().slice(-2)}.${(t.getMonth()+1).toString().padStart(2,"0")}.${t.getDate().toString().padStart(2,"0")}`})()}),a.jsx("div",{className:"text-gray-700 text-[9px] leading-[1.1] font-normal",children:pt?n?`₩${Number(e.expenditure_amount).toLocaleString()}`:"":"-"})]}):a.jsx(On,{onConfirm:(t,n)=>rn(e.id,t,n),placeholder:"지출 날짜와 금액을 입력하세요",align:"center",side:"bottom",children:a.jsx("button",{className:"button-toggle-inactive",children:"지출입력"})}):t?a.jsxs("div",{className:"w-full px-1 leading-none",children:[a.jsx("div",{className:"text-blue-700 text-[9px] leading-[1.1] font-normal",children:(()=>{const t=new Date(e.expenditure_date);return`${t.getFullYear().toString().slice(-2)}.${(t.getMonth()+1).toString().padStart(2,"0")}.${t.getDate().toString().padStart(2,"0")}`})()}),a.jsx("div",{className:"text-gray-700 text-[9px] leading-[1.1] font-normal",children:pt?n?`₩${Number(e.expenditure_amount).toLocaleString()}`:"":"-"})]}):a.jsx("span",{className:"modal-subtitle text-gray-400",children:"-"})})()})]}),a.jsxs("div",{className:"block sm:hidden space-y-2",children:[a.jsxs("div",{className:"flex justify-between items-start",children:[a.jsxs("div",{className:"flex-1 min-w-0 relative",children:[he?a.jsx(E,{value:e.item_name,onChange:e=>Zt(t,"item_name",e.target.value),onFocus:()=>ke(`m_item_name_${t}`),onBlur:()=>ke(null),className:"modal-label border-gray-200 rounded-lg w-full !px-1.5 !py-0.5 !text-[10px] focus:border-blue-400 transition-all duration-200 "+(Ce===`m_item_name_${t}`?"!h-auto !min-h-[20px] !absolute !z-[9999] !bg-white !shadow-lg !left-0 !right-0 !-translate-y-1/2 !top-1/2 !whitespace-normal":"!h-5 !truncate"),placeholder:"품목명"}):a.jsx("div",{className:"modal-value font-medium",children:e.item_name||"품목명 없음"}),he?a.jsx(E,{value:e.specification,onChange:e=>Zt(t,"specification",e.target.value),onFocus:()=>ke(`m_specification_${t}`),onBlur:()=>ke(null),className:"modal-label border-gray-200 rounded-lg mt-1 w-full !px-1.5 !py-0.5 !text-[10px] focus:border-blue-400 transition-all duration-200 "+(Ce===`m_specification_${t}`?"!h-auto !min-h-[20px] !absolute !z-[9999] !bg-white !shadow-lg !left-0 !right-0 !-translate-y-1/2 !top-1/2 !whitespace-normal !w-full":"!h-5 !truncate"),placeholder:"규격"}):a.jsx("div",{className:"modal-subtitle text-gray-500",children:e.specification||"-"})]}),a.jsxs("div",{className:"ml-3 text-right flex-shrink-0",children:[he?a.jsx(E,{type:"number",value:e.amount_value||0,onChange:e=>Zt(t,"amount_value",Number(e.target.value)),onWheel:e=>e.currentTarget.blur(),className:"border-gray-200 rounded-lg w-24 !h-6 !px-1.5 !py-0.5 !text-[10px] font-normal text-gray-600 focus:border-blue-400 text-right",placeholder:"합계"}):a.jsx("div",{className:"modal-value font-semibold",children:Jt(e.amount_value||0,Xt(e))}),a.jsxs("div",{className:"text-[10px] text-gray-500 mt-0.5",children:["done"!==D||pt?`${Jt(e.unit_price_value||0,Xt(e))}`:"-"," / 단가"]})]})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"수량"}),he?"receipt"===D||"done"===D?a.jsxs("div",{className:"grid grid-cols-2 gap-1 mt-1",children:[a.jsx(E,{type:"number",value:e.quantity,onChange:e=>Zt(t,"quantity",Number(e.target.value)),className:"border-gray-200 rounded-lg text-center w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"요청수량",max:"99999"}),a.jsx(E,{type:"number",value:e.received_quantity??"",onChange:e=>Zt(t,"received_quantity",e.target.value?Number(e.target.value):null),className:"border-gray-200 rounded-lg text-center w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"실제입고",max:"99999"})]}):a.jsx(E,{type:"number",value:e.quantity,onChange:e=>Zt(t,"quantity",Number(e.target.value)),className:"border-gray-200 rounded-lg text-center w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400 mt-1",placeholder:"수량",max:"99999"}):a.jsx("div",{className:"modal-subtitle mt-1",children:"receipt"===D||"done"===D?a.jsxs(a.Fragment,{children:[a.jsx("span",{className:"text-gray-500",children:e.quantity||0}),a.jsxs("span",{className:"text-gray-400",children:["/",e.received_quantity??0]})]}):e.quantity||0})]}),a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"링크"}),a.jsx("div",{className:"mt-1",children:he?a.jsx(E,{value:e.link||"",onChange:e=>Zt(t,"link",e.target.value),className:"border-gray-200 rounded-lg text-center w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"링크(URL)"}):e.link?a.jsx("a",{href:e.link,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:text-blue-800 underline text-[11px] break-all",onClick:e=>e.stopPropagation(),children:e.link}):a.jsx("span",{className:"text-gray-400 text-[11px]",children:"-"})})]})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-2 items-center",children:[a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"상태"}),a.jsx("div",{className:"mt-1",children:"pending"===D?a.jsx("span",{className:"text-xs text-gray-400",children:"-"}):a.jsxs(a.Fragment,{children:["purchase"===D&&a.jsx("div",{className:"flex items-center gap-2",children:vt?a.jsx("button",{onClick:()=>en(e.id,!e.is_payment_completed),className:"text-xs px-2 py-1 rounded "+(e.is_payment_completed?"button-action-primary":"bg-gray-100 text-gray-600"),children:e.is_payment_completed?"구매완료":"구매대기"}):a.jsx("span",{className:"text-xs px-2 py-1 rounded "+(e.is_payment_completed?"button-action-primary":"bg-gray-100 text-gray-400"),children:e.is_payment_completed?"구매완료":"구매대기"})}),"receipt"===D&&a.jsx("div",{className:"flex items-center gap-2",children:xt?Tt.isCompleted(e)?a.jsx("button",{onClick:()=>{Tt.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"text-xs px-2 py-1 rounded button-action-primary",children:Tt.config.completedText}):a.jsx(M,{onDateSelect:t=>{Tt.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"실제 입고된 날짜를 선택하세요",align:"center",side:"bottom",children:a.jsx("button",{className:"text-xs px-2 py-1 rounded bg-gray-100 text-gray-600",children:Tt.config.waitingText})}):a.jsx("span",{className:"text-xs px-2 py-1 rounded "+(Tt.isCompleted(e)?"button-action-primary":"bg-gray-100 text-gray-400"),children:Tt.isCompleted(e)?Tt.config.completedText:Tt.config.waitingText})}),"done"===D&&a.jsx(a.Fragment,{children:a.jsx("span",{className:"button-base "+(Tt.isCompleted(e)?"bg-green-500 text-white":"border border-gray-300 text-gray-600 bg-white"),children:Tt.isCompleted(e)?"입고완료":"입고대기"})}),"purchase"!==D&&"receipt"!==D&&"done"!==D&&a.jsx("span",{className:"text-xs text-gray-400",children:"-"})]})})]}),(e.remark||he)&&a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"비고:"}),he?a.jsx(E,{value:e.remark||"",onChange:e=>Zt(t,"remark",e.target.value),className:"modal-label border-gray-200 rounded-lg mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] focus:border-blue-400",placeholder:"비고"}):a.jsx("div",{className:"modal-subtitle text-gray-500 mt-1",children:e.remark||"-"})]})]}),!he&&"receipt"===D&&Tt.getCompletedDate(e)&&a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"실제입고일:"}),a.jsxs("div",{className:"mt-1",children:[a.jsx("div",{className:"modal-subtitle text-green-700",children:new Date(Tt.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})}),a.jsx("div",{className:"text-[9px] text-gray-500",children:new Date(Tt.getCompletedDate(e)).toLocaleTimeString("ko-KR",{hour:"2-digit",minute:"2-digit"})})]})]}),!he&&_t&&a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"거래명세서 확인:"}),a.jsx("div",{className:"flex items-center gap-2",children:wt?Et.isCompleted(e)?a.jsx("button",{onClick:()=>{Et.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"text-xs px-2 py-1 rounded button-action-primary",children:Et.config.completedText}):a.jsx(M,{onDateSelect:t=>{Et.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"회계상 입고일을 선택하세요",align:"center",side:"bottom",children:a.jsx("button",{className:"text-xs px-2 py-1 rounded bg-gray-100 text-gray-600",children:Et.config.waitingText})}):a.jsx("span",{className:"text-xs px-2 py-1 rounded "+(Et.isCompleted(e)?"button-action-primary":"bg-gray-100 text-gray-400"),children:Et.isCompleted(e)?Et.config.completedText:Et.config.waitingText})})]}),!he&&_t&&Et.getCompletedDate(e)&&a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"회계상 입고일:"}),a.jsx("span",{className:"modal-subtitle text-blue-700",children:new Date(Et.getCompletedDate(e)).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})})]}),!he&&gt&&a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("span",{className:"text-gray-500 text-xs",children:"지출정보:"}),a.jsx("div",{className:"text-right",children:e.expenditure_date?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"text-blue-700 text-[11px]",children:(()=>{const t=new Date(e.expenditure_date);return`${t.getFullYear().toString().slice(-2)}.${(t.getMonth()+1).toString().padStart(2,"0")}.${t.getDate().toString().padStart(2,"0")}`})()}),a.jsx("div",{className:"text-gray-700 text-[11px]",children:pt?null!==e.expenditure_amount&&void 0!==e.expenditure_amount?`₩${Number(e.expenditure_amount).toLocaleString()}`:"":"-"})]}):a.jsx("span",{className:"text-gray-400 text-[11px]",children:"-"})})]})]})]})},sn=a.jsx("div",{className:"space-y-1 sm:space-y-4",children:le?a.jsx("div",{className:"flex items-center justify-center py-12",children:a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-hansl-600"})}):ue?a.jsxs("div",{children:[a.jsx("div",{className:"bg-gray-50 rounded-lg p-2 sm:p-3 mb-1 sm:mb-2 border border-gray-100",children:a.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 items-center gap-3 sm:gap-0",children:[a.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-4",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[(()=>{if(!ue)return null;if(ue.payment_category){const e=ue.payment_category.trim();return"발주"===e?a.jsx("span",{className:"badge-stats bg-green-500 text-white",children:"발주"}):"구매요청"===e?a.jsx("span",{className:"badge-stats bg-blue-500 text-white",children:"구매요청"}):"현장결제"===e?a.jsx("span",{className:"badge-stats bg-gray-500 text-white",children:"현장결제"}):a.jsx("span",{className:"badge-stats bg-blue-500 text-white",children:e})}return a.jsx("span",{className:"badge-stats bg-blue-500 text-white",children:"구매요청"})})(),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"modal-label",children:"요청자:"}),a.jsx("span",{className:"modal-value",children:ue.requester_name})]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(V,{className:"w-3 h-3 text-gray-500"}),a.jsxs("span",{className:"modal-subtitle",children:["청구일: ",k(ue.request_date)]})]})]}),a.jsxs("div",{className:"flex items-center justify-center gap-2 sm:gap-3 flex-wrap",children:[Ot&&"pending"===ue.middle_manager_status&&a.jsx(i,{size:"sm",variant:"outline",onClick:()=>nn("middle"),className:`${At} border border-gray-400 bg-white hover:bg-gray-50 hover:border-gray-500`,children:"1차 승인 대기"}),"approved"===ue.middle_manager_status&&a.jsxs("div",{className:"button-approved badge-text shadow-sm",children:[a.jsx(H,{className:"w-3 h-3"}),"1차 승인완료"]}),"rejected"===ue.middle_manager_status&&a.jsxs("div",{className:"button-rejected badge-text",children:[a.jsx(g,{className:"w-3 h-3"}),"1차 반려"]}),"pending"===ue.middle_manager_status&&!Ot&&a.jsx("div",{className:`${Wt} border border-gray-300 text-gray-600 bg-white`,children:"1차 승인대기"}),Pt&&"approved"===ue.middle_manager_status&&"pending"===ue.final_manager_status&&a.jsxs(i,{size:"sm",variant:"outline",onClick:()=>nn("final"),className:`${At} border border-gray-400 bg-white hover:bg-gray-50 hover:border-gray-500`,children:[a.jsx(H,{className:"w-3 h-3"}),"최종 승인"]}),"approved"===ue.final_manager_status&&a.jsxs("div",{className:"button-approved badge-text",children:[a.jsx(H,{className:"w-3 h-3"}),"최종 승인완료"]}),"rejected"===ue.final_manager_status&&a.jsxs("div",{className:"button-rejected badge-text",children:[a.jsx(g,{className:"w-3 h-3"}),"최종 반려"]}),"approved"!==ue.middle_manager_status&&"pending"===ue.final_manager_status&&a.jsx("div",{className:`${Wt} border border-gray-300 text-gray-600 bg-white`,children:"최종 승인대기"})]}),a.jsx("div",{})]})}),a.jsxs("div",{className:"flex flex-col lg:flex-row gap-3 sm:gap-6",children:[a.jsxs("div",{className:"lg:w-80 lg:flex-shrink-0 space-y-1 sm:space-y-4 relative",children:[a.jsxs("div",{className:"bg-white rounded-lg p-2 sm:p-3 border border-gray-100 shadow-sm",children:[a.jsx("div",{className:"mb-3",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("h3",{className:"modal-section-title flex items-center",children:[a.jsx(f,{className:"w-4 h-4 mr-2 text-gray-600"}),ue?.purchase_order_number||"PO번호 없음"]}),wt&&pt&&("done"===D||"receipt"===D)&&a.jsxs("button",{onClick:qt,className:"button-base text-xs px-2 py-1 flex items-center "+(ue?.is_utk_checked?"button-toggle-active bg-orange-500 hover:bg-orange-600 text-white":"button-toggle-inactive"),title:ue?.is_utk_checked?"UTK 확인 취소":"UTK 확인",children:[a.jsx(G,{className:"w-3 h-3 mr-1"}),"UTK ",ue?.is_utk_checked?"완료":"확인"]})]})}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"발주서 종류"}),he?a.jsx(E,{value:_e?.request_type||"",onChange:e=>ge(t=>t?{...t,request_type:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"일반",disabled:mt&&!ut}):a.jsx("p",{className:"modal-value",children:ue.request_type||"일반"})]}),a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"결제 종류"}),he?a.jsx(E,{value:_e?.payment_category||"",onChange:e=>ge(t=>t?{...t,payment_category:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"발주/구매요청/현장결제",disabled:mt&&!ut}):a.jsx("p",{className:"modal-value",children:ue.payment_category||"-"})]})]}),a.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"입고 요청일"}),he?a.jsx(M,{onDateSelect:e=>{ge(t=>t?{...t,delivery_request_date:R(e,"yyyy-MM-dd")}:null)},placeholder:"입고 요청일을 선택하세요",align:"start",side:"bottom",children:a.jsxs(i,{variant:"outline",className:"mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] justify-start text-left font-normal business-radius-input",disabled:mt&&!ut,children:[a.jsx(V,{className:"mr-1 h-3 w-3"}),_e?.delivery_request_date?k(_e.delivery_request_date):"날짜 선택"]})}):a.jsx("p",{className:"modal-subtitle",children:k(ue.delivery_request_date)})]}),a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label text-orange-500",children:"변경 입고일"}),he?a.jsx(M,{onDateSelect:e=>{ge(t=>t?{...t,revised_delivery_request_date:R(e,"yyyy-MM-dd")}:null)},placeholder:"변경 입고일을 선택하세요",align:"start",side:"bottom",children:a.jsxs(i,{variant:"outline",className:"mt-1 w-full h-5 px-1.5 py-0.5 text-[10px] justify-start text-left font-normal business-radius-input",disabled:mt&&!ut,children:[a.jsx(V,{className:"mr-1 h-3 w-3"}),_e?.revised_delivery_request_date?k(_e.revised_delivery_request_date):"날짜 선택"]})}):a.jsx("p",{className:"modal-subtitle text-orange-700",children:ue.revised_delivery_request_date?k(ue.revised_delivery_request_date):"미설정"})]})]})]})]}),a.jsxs("div",{className:"bg-white rounded-lg p-2 sm:p-3 border border-gray-100 shadow-sm",children:[a.jsxs("h3",{className:"modal-section-title mb-3 flex items-center",children:[a.jsx(v,{className:"w-4 h-4 mr-2 text-gray-600"}),"업체 정보"]}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"업체명"}),he?a.jsx($,{options:De.map(e=>({value:e.id.toString(),label:e.vendor_name})),value:_e?.vendor_id?{value:_e.vendor_id.toString(),label:_e.vendor_name||De.find(e=>e.id===_e.vendor_id)?.vendor_name||""}:null,isDisabled:mt&&!ut,onChange:e=>{if(c.info("ReactSelect onChange:",{option:e}),e){const t=De.find(t=>t.id.toString()===e.value);if(c.info("Selected vendor:",{selectedVendor:t}),t){s().from("vendor_contacts").select("id, contact_name, contact_email, contact_phone, position").eq("vendor_id",t.id).then(({data:e,error:n})=>{n&&c.error("담당자 목록 로드 오류:",n),c.info("🔍 업체 변경 - 담당자 목록 로드:",{vendor_id:t.id,vendor_name:t.vendor_name,contactsData:e,contactsCount:e?.length||0}),c.debug("업체 변경 - 담당자 목록:",e),ge(n=>{const r=n?{...n,vendor_id:t.id,vendor_name:t.vendor_name,vendor:t,vendor_contacts:Array.isArray(e)?e:[],contact_id:void 0,contact_name:void 0}:null;return c.info("🔍 업체 변경 - editedPurchase 업데이트 완료:",{vendor_id:t.id,vendor_name:t.vendor_name,contactsData:e,updated_vendor_contacts:r?.vendor_contacts,updated_full:r}),c.debug("업체 변경 - editedPurchase 전체:",{updated:r}),r})})}}else ge(e=>e?{...e,vendor_id:void 0,vendor_name:"",vendor:void 0,vendor_contacts:[],contact_id:void 0,contact_name:void 0}:null)},placeholder:"업체 선택",isClearable:!0,isSearchable:!0,menuPortalTarget:document.body,styles:{control:e=>({...e,minHeight:"20px",height:"20px",fontSize:"10px",borderRadius:"8px",borderColor:"#e5e7eb",borderWidth:"1px",backgroundColor:"#ffffff",boxShadow:"none",paddingLeft:"6px",paddingRight:"6px","&:hover":{borderColor:"#e5e7eb"},"&:focus-within":{borderColor:"#60a5fa",boxShadow:"none",outline:"none"}}),valueContainer:e=>({...e,height:"18px",padding:"0 2px",margin:"0"}),input:e=>({...e,margin:"0",padding:"0",fontSize:"10px"}),indicatorsContainer:e=>({...e,height:"18px",padding:"0"}),indicatorSeparator:()=>({display:"none"}),dropdownIndicator:e=>({...e,padding:"0 2px",svg:{width:"12px",height:"12px"}}),clearIndicator:e=>({...e,padding:"0 2px",svg:{width:"12px",height:"12px"}}),option:e=>({...e,fontSize:"10px",padding:"4px 8px"}),menuPortal:e=>({...e,zIndex:9999})},classNamePrefix:"vendor-select"}):a.jsx("p",{className:"modal-value",children:ue.vendor?.vendor_name||"-"})]}),a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"업체 담당자"}),he?_e?.vendor_id?a.jsx($,{isDisabled:mt&&!ut,options:(()=>{const e=Array.isArray(_e.vendor_contacts)?_e.vendor_contacts:[],t=e.filter((e,t,n)=>n.findIndex(t=>t.id===e.id)===t),n=t.filter((e,t,n)=>n.findIndex(t=>t.contact_name===e.contact_name)===t),r=n.map(e=>({value:e.id.toString(),label:e.contact_name||""}))||[];return c.info("🔍 담당자 드롭다운 옵션:",{vendor_id:_e.vendor_id,vendor_contacts_raw:_e.vendor_contacts,vendor_contacts_count:e.length,unique_by_id_count:t.length,final_unique_count:n.length,options:r}),c.debug("담당자 드롭다운 옵션:",{options:r}),r})(),value:(()=>{const e=(Array.isArray(_e.vendor_contacts)?_e.vendor_contacts:[])[0];return e?.id?{value:e.id.toString(),label:e.contact_name||""}:null})(),onChange:e=>{if(c.info("🔍 담당자 선택 변경:",{option:e}),e){const t=Array.isArray(_e.vendor_contacts)?_e.vendor_contacts:[],n=t.find(t=>t.id.toString()===e.value);n&&ge(e=>e?{...e,contact_id:n.id,contact_name:n.contact_name,vendor_contacts:[n,...t.filter(e=>e.id!==n.id)]}:null)}else ge(e=>e?{...e,contact_id:void 0,contact_name:void 0,vendor_contacts:Array.isArray(_e.vendor_contacts)?_e.vendor_contacts:[]}:null)},placeholder:"담당자를 선택하세요",isClearable:!0,isSearchable:!0,noOptionsMessage:()=>"담당자가 없습니다",menuPortalTarget:document.body,styles:{control:e=>({...e,minHeight:"20px",height:"20px",fontSize:"10px",borderRadius:"8px",borderColor:"#e5e7eb",borderWidth:"1px",backgroundColor:"#ffffff",boxShadow:"none",paddingLeft:"6px",paddingRight:"6px","&:hover":{borderColor:"#e5e7eb"},"&:focus-within":{borderColor:"#60a5fa",boxShadow:"none",outline:"none"}}),valueContainer:e=>({...e,height:"18px",padding:"0 2px",margin:"0"}),input:e=>({...e,margin:"0",padding:"0",fontSize:"10px"}),indicatorsContainer:e=>({...e,height:"18px",padding:"0"}),indicatorSeparator:()=>({display:"none"}),dropdownIndicator:e=>({...e,padding:"0 2px",svg:{width:"12px",height:"12px"}}),clearIndicator:e=>({...e,padding:"0 2px",svg:{width:"12px",height:"12px"}}),option:e=>({...e,fontSize:"10px",padding:"4px 8px"}),menuPortal:e=>({...e,zIndex:9999})},classNamePrefix:"contact-select"}):a.jsx(E,{value:"",disabled:!0,className:"mt-1 rounded-lg border-gray-200 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"업체를 먼저 선택하세요"}):a.jsx("p",{className:"modal-value",children:(()=>{const e=Array.isArray(ue.vendor_contacts)?ue.vendor_contacts:[],t=ue.contact_name||e[0]?.contact_name||"-";return c.info("🔍 vendor_contacts display 렌더링:",{purchase_id:ue?.id,vendor_id:ue?.vendor_id,contact_id:ue?.contact_id,vendor_contacts:ue.vendor_contacts,purchase_contact_name:ue.contact_name,contactName:t,purchase_full:ue}),c.debug("vendor_contacts display 렌더링:",{purchase_id:ue?.id,vendor_id:ue?.vendor_id,contact_id:ue?.contact_id,vendor_contacts:ue.vendor_contacts,purchase_contact_name:ue.contact_name,contactName:t}),t})()})]})]}),a.jsxs("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:[a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"PJ업체"}),he?a.jsx(E,{value:_e?.project_vendor||"",onChange:e=>ge(t=>t?{...t,project_vendor:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"입력",disabled:mt&&!ut}):a.jsx("p",{className:"modal-value",children:ue.project_vendor||"-"})]}),a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"Item"}),he?a.jsx(E,{value:_e?.project_item||"",onChange:e=>ge(t=>t?{...t,project_item:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"입력",disabled:mt&&!ut}):a.jsx("p",{className:"modal-subtitle break-all whitespace-pre-wrap",style:{whiteSpace:"pre-wrap",wordBreak:"break-all"},children:ue.project_item||"-"})]})]}),a.jsx("div",{className:"grid grid-cols-1 sm:flex sm:gap-8",children:a.jsxs("div",{className:"w-32",children:[a.jsx("span",{className:"modal-label",children:"수주번호"}),he?a.jsx(E,{value:_e?.sales_order_number||"",onChange:e=>ge(t=>t?{...t,sales_order_number:e.target.value}:null),className:"mt-1 rounded-lg border-gray-200 focus:border-blue-400 w-full h-5 px-1.5 py-0.5 text-[10px]",placeholder:"입력",disabled:mt&&!ut}):a.jsx("p",{className:"modal-subtitle",children:ue.sales_order_number||"-"})]})})]})]}),Ue.length>0&&a.jsxs("div",{className:"bg-white rounded-lg p-2 sm:p-3 border border-gray-100 shadow-sm mt-3",children:[a.jsx("div",{className:"mb-2",children:a.jsxs("h3",{className:"modal-section-title flex items-center",children:[a.jsx(x,{className:"w-4 h-4 mr-2 text-gray-600"}),"연결된 거래명세서",a.jsxs("span",{className:"ml-2 badge-stats bg-green-500 text-white text-[10px]",children:[Ue.length,"건"]})]})}),a.jsx("div",{className:"space-y-2",children:Ue.map(e=>a.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors",onClick:()=>(e=>{const t=(window.screen.width-1e3)/2,n=(window.screen.height-800)/2;window.open(e,"_blank",`width=1000,height=800,left=${t},top=${n},scrollbars=yes,resizable=yes`)})(e.image_url),children:[a.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[a.jsx(te,{className:"w-4 h-4 text-gray-400 flex-shrink-0"}),a.jsxs("div",{className:"min-w-0",children:[a.jsx("p",{className:"text-xs font-medium text-gray-900 truncate",children:e.vendor_name||e.file_name||"거래명세서"}),a.jsxs("p",{className:"text-[10px] text-gray-500",children:[e.statement_date?k(e.statement_date):k(e.uploaded_at),e.grand_total&&a.jsxs("span",{className:"ml-2 text-gray-700",children:[e.grand_total.toLocaleString(),"원"]})]})]})]}),a.jsx(i,{size:"sm",variant:"ghost",className:"h-6 w-6 p-0 flex-shrink-0",title:"이미지 보기",children:a.jsx(te,{className:"w-3 h-3"})})]},e.id))})]})]}),a.jsx("div",{className:"lg:w-fit lg:min-w-0 relative overflow-visible",children:a.jsxs("div",{className:"bg-white rounded-lg border border-gray-100 shadow-sm",children:[a.jsxs("div",{className:"p-2 sm:p-3 bg-gray-50 border-b border-gray-100 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-0",children:[a.jsxs("h3",{className:"modal-section-title flex items-center",children:[a.jsx(b,{className:"w-4 h-4 mr-2 text-gray-600"}),"품목 리스트",a.jsxs("span",{className:"ml-2 badge-stats bg-gray-500 text-white",children:[it?.length||0,"개"]}),he?a.jsx($,{isDisabled:mt&&!ut,options:[{value:"KRW",label:"KRW"},{value:"USD",label:"USD"},{value:"EUR",label:"EUR"},{value:"JPY",label:"JPY"},{value:"CNY",label:"CNY"}],value:_e?.currency?{value:_e.currency,label:_e.currency}:{value:"KRW",label:"KRW"},onChange:e=>{e&&ge(t=>t?{...t,currency:e.value}:null)},menuPortalTarget:document.body,styles:{control:e=>({...e,minHeight:"20px",height:"20px",width:"75px",fontSize:"10px",borderRadius:"8px",borderColor:"#e5e7eb",marginLeft:"8px"}),valueContainer:e=>({...e,padding:"0 6px",height:"20px"}),singleValue:e=>({...e,margin:0,position:"absolute",top:"50%",transform:"translateY(-50%)"}),input:e=>({...e,margin:0,padding:0}),indicatorsContainer:e=>({...e,height:"20px"}),indicatorSeparator:()=>({display:"none"}),dropdownIndicator:e=>({...e,padding:"0 4px"}),option:e=>({...e,fontSize:"10px",padding:"4px 8px"}),menuPortal:e=>({...e,zIndex:9999})}}):a.jsx("span",{className:"ml-2 badge-stats bg-blue-500 text-white",children:ue.currency||"KRW"})]}),!he&&a.jsxs(a.Fragment,{children:["purchase"===D&&vt&&a.jsxs(i,{size:"sm",onClick:async()=>{if(!ue||!vt)return;const e=`발주번호: ${ue.purchase_order_number}\n\n전체 구매완료 처리하시겠습니까?`;if(window.confirm(e)){ue&&Number(ue.id);try{const e=ue.purchase_request_items||[],t=e.filter(e=>!e.is_payment_completed);if(0===t.length)return void K.info("모든 품목이 이미 구매완료되었습니다.");c.info(`전체 구매완료 처리: ${t.length}개 품목 (총 ${e.length}개 중)`);for(const r of t){const e={is_payment_completed:!0,payment_completed_at:(new Date).toISOString()},{error:t}=await lt.from("purchase_request_items").update(e).eq("id",r.id);if(t)throw t;y(ue.id,r.id)||c.warn("[PurchaseDetailModal] 메모리 캐시 개별 품목 구매완료 업데이트 실패",{purchaseId:ue.id,itemId:r.id})}K.success(`${t.length}개 품목이 구매완료 처리되었습니다.`),await St();const n=I?.(!0,{silent:!0});n instanceof Promise&&await n}catch(t){c.error("전체 구매완료 처리 오류",t),K.error("구매완료 처리 중 오류가 발생했습니다.")}}},className:"button-base bg-orange-500 hover:bg-orange-600 text-white",children:[a.jsx(Y,{className:"w-3 h-3 mr-1"}),"전체 구매완료"]}),"receipt"===D&&xt&&a.jsx(Pn,{onConfirm:async(e,t)=>{if(!ue||!xt)return;const n=`발주번호: ${ue.purchase_order_number}\n\n전체 입고완료 처리하시겠습니까?`;if(!window.confirm(n))return;const r=ue?Number(ue.id):NaN;try{const n=ue.purchase_request_items||[],a=n.filter(e=>!e.is_received),i=()=>{Number.isNaN(r)||ie?.(r,n=>{const r=(n.items||[]).map(n=>a.find(e=>String(e.id)===String(n.id))?{...n,is_received:!0,actual_received_date:n.actual_received_date||C(e),received_quantity:void 0!==t?t:n.quantity}:n),i=(n.purchase_request_items||[]).map(n=>a.find(e=>String(e.id)===String(n.id))?{...n,is_received:!0,actual_received_date:n.actual_received_date||C(e),received_quantity:void 0!==t?t:n.quantity}:n);return{...n,items:r,purchase_request_items:i,is_received:!0,received_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}})};if(0===a.length)return void K.info("모든 품목이 이미 입고완료되었습니다.");c.info(`전체 입고완료 처리: ${a.length}개 품목 (총 ${n.length}개 중)`),i(),me(n=>{if(!n)return null;const r=n.items?.map(n=>a.find(e=>String(e.id)===String(n.id))?{...n,is_received:!0,received_at:(new Date).toISOString(),actual_received_date:C(e),received_quantity:void 0!==t?t:n.quantity}:n)||[],i=n.purchase_request_items?.map(n=>a.find(e=>String(e.id)===String(n.id))?{...n,is_received:!0,received_at:(new Date).toISOString(),actual_received_date:C(e),received_quantity:void 0!==t?t:n.quantity}:n)||[],s=r.length,c=r.filter(e=>e.is_received).length,o=s>0&&c===s;return{...n,items:r,purchase_request_items:i,is_received:o,received_at:o?(new Date).toISOString():n.received_at,updated_at:(new Date).toISOString()}});for(const r of a){const n={actual_received_date:C(e),is_received:!0,received_quantity:void 0!==t?t:r.quantity},{error:a}=await lt.from("purchase_request_items").update(n).eq("id",r.id);if(a)throw a;const i=void 0!==t?t:r.quantity;o(ue.id,r.id,C(e),i)||c.warn("[PurchaseDetailModal] 메모리 캐시 개별 품목 입고완료 업데이트 실패",{purchaseId:ue.id,itemId:r.id})}K.success(`${a.length}개 품목이 입고완료 처리되었습니다.`),await St();const s=I?.(!0,{silent:!0});s instanceof Promise&&await s}catch(a){c.error("전체 입고완료 처리 오류",a),K.error("입고완료 처리 중 오류가 발생했습니다.")}},placeholder:"입고일을 선택하세요",align:"end",side:"bottom",hideQuantityInput:!0,quantityInfoText:"요청입고수량과 동일한 수량으로 입력됩니다",children:a.jsxs(i,{size:"sm",className:"button-base button-action-primary",children:[a.jsx(ae,{className:"w-3 h-3 mr-1"}),"전체 입고완료"]})}),_t&&wt&&pt&&a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(M,{onDateSelect:async e=>{if(!ue||!wt)return;e.toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"});const t=`발주번호: ${ue.purchase_order_number}\n\n전체 거래명세서 확인 처리하시겠습니까?`;if(!window.confirm(t))return;const n=C(e);ue&&Number(ue.id);try{const e=ue.purchase_request_items||[],t=e.filter(e=>!e.is_statement_received);if(0===t.length)return void K.info("모든 품목의 거래명세서가 이미 확인되었습니다.");c.info(`전체 거래명세서 확인 처리: ${t.length}개 품목 (총 ${e.length}개 중)`);for(const a of t){const e={is_statement_received:!0,statement_received_date:n,statement_received_by_name:Ne||null},{error:t}=await lt.from("purchase_request_items").update(e).eq("id",a.id);if(t)throw t;l(ue.id,a.id,n,Ne||void 0)||c.warn("[PurchaseDetailModal] 메모리 캐시 개별 품목 거래명세서 확인 업데이트 실패",{purchaseId:ue.id,itemId:a.id})}K.success(`${t.length}개 품목의 거래명세서 확인이 완료되었습니다.`),await St();const r=I?.(!0,{silent:!0});r instanceof Promise&&await r}catch(r){c.error("전체 거래명세서 확인 처리 오류",r),K.error("거래명세서 확인 처리 중 오류가 발생했습니다.")}},placeholder:"전체 회계상 입고일을 선택하세요",align:"end",side:"bottom",children:a.jsxs(i,{size:"sm",className:"button-base button-action-primary",children:[a.jsx(f,{className:"w-3 h-3 mr-1"}),"거래명세서 확인"]})}),"done"===D&&"발주"===ue.payment_category&&a.jsx(On,{onConfirm:async(e,t)=>{if(!ue||!wt)return void K.error("지출 정보 입력 권한이 없습니다.");const n=`발주번호: ${ue.purchase_order_number}\n\n일괄 지출 정보를 입력하시겠습니까?\n날짜: ${e.toLocaleDateString("ko-KR")}\n총 금액: ${t.toLocaleString()}원\n\n* 주의: 기존에 입력된 개별 품목의 지출 정보가 모두 초기화되고, 입력하신 총 금액으로 설정됩니다.`;if(!window.confirm(n))return;const r=ue?Number(ue.id):NaN;try{Number.isNaN(r)||ie?.(r,n=>{const r=(n.items||[]).map(t=>({...t,expenditure_date:C(e),expenditure_amount:null}));return{...n,items:r,total_expenditure_amount:t}});const n=ue.items||ue.purchase_request_items||[];if(0===n.length)return void K.error("품목이 없습니다.");me(n=>{if(!n)return null;const r=(n.items||n.purchase_request_items||[]).map(t=>({...t,expenditure_date:C(e),expenditure_amount:null}));return{...n,items:r,purchase_request_items:r,total_expenditure_amount:t,updated_at:(new Date).toISOString()}});const{error:a}=await lt.from("purchase_request_items").update({expenditure_date:C(e),expenditure_amount:null}).in("id",n.map(e=>e.id));if(a)throw c.error("일괄 지출 정보 아이템 DB 업데이트 실패",{error:a}),a;const{error:i}=await lt.from("purchase_requests").update({total_expenditure_amount:t}).eq("id",r);if(i)throw c.error("일괄 지출 정보 총액 DB 업데이트 실패",{error:i}),i;w(ue.id,C(e),t),K.success("일괄 지출 정보가 입력되었습니다.")}catch(a){c.error("일괄 지출 정보 입력 중 오류",a),K.error("일괄 지출 정보 입력 중 오류가 발생했습니다.")}},placeholder:"일괄 지출 날짜와 금액을 입력하세요",align:"end",side:"bottom",children:a.jsxs(i,{size:"sm",className:"button-base button-action-primary",children:[a.jsx(Z,{className:"w-3 h-3 mr-1"}),"일괄지출"]})})]})]})]}),a.jsx("div",{className:"block sm:hidden bg-gray-50 px-2 py-1 border-b border-gray-100",children:a.jsx("div",{className:"text-xs font-medium text-gray-600",children:"품목 목록 (터치하여 스크롤)"})}),a.jsx("div",{className:"max-h-[50vh] sm:max-h-[40vh] overflow-auto",children:a.jsxs("div",{className:"w-fit",children:[a.jsx("div",{className:"bg-gray-50 px-2 sm:px-3 py-1 border-b border-gray-100 sticky top-0 z-10 w-fit "+(he?"pl-7 sm:pl-8":""),children:a.jsxs("div",{ref:ot,className:"hidden sm:grid gap-1 modal-label w-fit",style:{gridTemplateColumns:Ut()},children:[a.jsx("div",{className:"text-center -ml-2 sm:-ml-3",children:"#"}),a.jsx("div",{children:"품목명"}),a.jsx("div",{children:"규격"}),a.jsx("div",{className:"text-center",children:"receipt"!==D&&"done"!==D||he?"요청수량":a.jsxs("div",{className:"flex flex-col items-center leading-tight",children:[a.jsx("div",{className:"text-[9px]",children:"요청/실제"}),a.jsx("div",{className:"text-[10px]",children:"입고수량"})]})}),a.jsx("div",{className:"text-right",children:"단가"}),a.jsx("div",{className:"text-right",children:"합계"}),"발주"===ue.payment_category&&a.jsx("div",{className:"text-right",children:"세액"}),a.jsx("div",{className:"text-center",children:"링크"}),a.jsx("div",{className:"text-center",children:"비고"}),"pending"!==D&&(he?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"text-center",children:"삭제"}),"receipt"===D&&a.jsx(a.Fragment,{children:a.jsx("div",{className:"text-center",children:"실제입고일"})}),_t&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"text-center",children:"거래명세서 확인"}),a.jsx("div",{className:"text-center",children:"회계상 입고일"}),gt&&a.jsx("div",{className:"text-center",children:"지출정보"})]})]}):a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"text-center",children:"purchase"===D?"구매상태":"receipt"===D||"done"===D?"입고상태":"상태"}),"receipt"===D&&a.jsx(a.Fragment,{children:a.jsx("div",{className:"text-center",children:"실제입고일"})}),_t&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"text-center",children:"거래명세서 확인"}),a.jsx("div",{className:"text-center",children:"회계상 입고일"}),gt&&a.jsx("div",{className:"text-center",children:"지출정보"})]})]}))]})}),he&&a.jsx(_n,{sensors:Ve,collisionDetection:Be,onDragEnd:Ge,children:a.jsx(kn,{items:ct,strategy:Sn,children:(fe||[]).map((e,t)=>a.jsx(Yn,{id:Je(e,t),children:n=>an(e,t,n,Je(e,t))},Je(e,t)))})}),!he&&a.jsx("div",{className:"divide-y divide-gray-100 overflow-visible w-fit",children:st?.map((e,t)=>an(e,t,void 0,Je(e,t)))})]})}),a.jsxs("div",{className:"bg-gray-50 px-2 sm:px-3 border-t border-gray-100",children:[a.jsxs("div",{className:"hidden sm:grid items-center gap-1 py-2 w-fit",style:{gridTemplateColumns:Ut()},children:[a.jsx("div",{className:"-ml-2 sm:-ml-3"}),a.jsx("div",{}),a.jsx("div",{}),a.jsx("div",{}),a.jsx("div",{className:"text-right flex items-center justify-end",children:a.jsx("span",{className:"text-[11px] text-gray-600 font-medium",children:"공급가액"})}),a.jsx("div",{className:"text-right flex items-center justify-end",children:a.jsx("span",{className:"text-[12px] font-bold text-gray-900",children:"done"!==D||pt?`${"USD"===(he?_e?.currency:ue.currency)?"$":"₩"}${Ht(st?.reduce((e,t)=>e+(t.amount_value||0),0)||0)}`:"-"})}),"발주"===ue.payment_category&&a.jsx("div",{className:"text-right flex items-center justify-end",children:a.jsx("span",{className:"text-[12px] font-bold text-gray-900",children:"done"!==D||pt?`${"USD"===(he?_e?.currency:ue.currency)?"$":"₩"}${Ht(st?.reduce((e,t)=>e+(t.tax_amount_value||0),0)||0)}`:"-"})}),a.jsx("div",{}),a.jsx("div",{}),"pending"!==D&&(he?a.jsx("div",{}):a.jsx("div",{className:"done"===D&&"발주"===ue.payment_category?"text-right flex items-center justify-end":"",children:"done"===D&&"발주"===ue.payment_category&&a.jsx("span",{className:"text-[11px] text-gray-600 font-medium",children:"지출총합"})})),"receipt"===D&&a.jsx("div",{}),"done"===D&&a.jsx(a.Fragment,{children:"발주"===ue.payment_category&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"text-right flex items-center justify-end",children:a.jsx("div",{className:"text-[12px] font-bold text-blue-700",children:pt?`₩${Ht(ue.total_expenditure_amount??((he?fe:it)?.reduce((e,t)=>e+(Number(t.expenditure_amount)||0),0)||0))}`:"-"})}),a.jsx("div",{}),a.jsx("div",{})]})})]}),"발주"===ue.payment_category&&a.jsxs("div",{className:"hidden sm:grid items-center gap-1 py-2 w-fit border-t border-gray-300",style:{gridTemplateColumns:Ut()},children:[a.jsx("div",{className:"-ml-2 sm:-ml-3"}),a.jsx("div",{}),a.jsx("div",{}),a.jsx("div",{}),a.jsx("div",{}),a.jsx("div",{className:"text-right flex items-center justify-end",children:a.jsx("span",{className:"text-[11px] text-gray-600 font-medium",children:"총액"})}),a.jsx("div",{className:"text-right flex items-center justify-end",children:a.jsx("span",{className:"text-[12px] font-bold text-blue-600",children:"done"!==D||pt?Jt((he?fe:it)?.reduce((e,t)=>e+(t.amount_value||0)+(t.tax_amount_value||0),0)||0,Qt()):"-"})}),a.jsx("div",{}),a.jsx("div",{}),a.jsx("div",{}),"receipt"===D&&a.jsx("div",{}),"done"===D&&"발주"===ue.payment_category&&a.jsxs(a.Fragment,{children:[a.jsx("div",{}),a.jsx("div",{}),a.jsx("div",{})]})]}),a.jsxs("div",{className:"block sm:hidden py-2 space-y-1",children:[a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsx("span",{className:"text-[12px] text-gray-500",children:"합계 총액"}),a.jsx("span",{className:"text-[13px] font-bold text-gray-900",children:"done"!==D||pt?Jt((he?fe:it)?.reduce((e,t)=>e+(t.amount_value||0),0)||0,Qt()):"-"})]}),"발주"===ue.payment_category&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsx("span",{className:"text-[12px] text-gray-500",children:"세액 총액"}),a.jsx("span",{className:"text-[13px] font-bold text-gray-900",children:"done"!==D||pt?Jt((he?fe:it)?.reduce((e,t)=>e+(t.tax_amount_value||0),0)||0,Qt()):"-"})]}),a.jsxs("div",{className:"flex justify-between items-center border-t pt-1",children:[a.jsx("span",{className:"text-[12px] text-gray-500",children:"합계+세액"}),a.jsx("span",{className:"text-[13px] font-bold text-blue-600",children:"done"!==D||pt?Jt((he?fe:it)?.reduce((e,t)=>e+(t.amount_value||0)+(t.tax_amount_value||0),0)||0,Qt()):"-"})]})]}),"done"===D&&"발주"===ue.payment_category&&a.jsxs("div",{className:"flex justify-between items-center border-t pt-1",children:[a.jsx("span",{className:"text-[12px] text-gray-500",children:"지출 총합"}),a.jsx("span",{className:"text-[13px] font-bold text-blue-700",children:pt?`₩${Ht(ue.total_expenditure_amount??((he?fe:it)?.reduce((e,t)=>e+(Number(t.expenditure_amount)||0),0)||0))}`:"-"})]})]})]}),he&&a.jsx("div",{className:"p-2 sm:p-3 border-t border-gray-100",children:a.jsxs(i,{type:"button",size:"sm",variant:"outline",onClick:e=>{if(e?.preventDefault?.(),e?.stopPropagation?.(),!he)return;const t=Date.now();t-nt.current<350?c.warn("[PurchaseDetailModal] handleAddItem 중복 호출 차단",{deltaMs:t-nt.current}):(nt.current=t,ve(e=>{const n=e||[],r={item_name:"",specification:"",quantity:1,unit_price_value:0,amount_value:0,remark:"",line_number:n.reduce((e,t)=>{const n=t.line_number||0;return n>e?n:e},0)+1,tempId:`tmp-new-${t}-${Math.random()}`};return[...n,r].sort((e,t)=>(e.line_number||999999)-(t.line_number||999999)).map((e,t)=>({...e,line_number:t+1,stableKey:e.stableKey??Qe(e,t)}))}))},className:"w-full rounded-lg border-dashed border-2 border-gray-300 hover:border-gray-400 py-2 badge-text",children:[a.jsx(T,{className:"w-4 h-4 mr-1"}),"항목 추가"]})})]})})]})]}):a.jsx("div",{className:"text-center py-12",children:le?a.jsxs("div",{className:"flex items-center justify-center gap-2",children:[a.jsx("div",{className:"w-5 h-5 border-2 border-gray-300 border-t-transparent rounded-full animate-spin"}),a.jsx("span",{className:"modal-subtitle",children:"불러오는 중..."})]}):a.jsxs("div",{className:"space-y-3",children:[a.jsx("span",{className:"modal-subtitle",children:"발주내역이 삭제 되었거나 없습니다."}),!d&&a.jsx("div",{children:a.jsx(i,{size:"sm",variant:"outline",onClick:r,className:"button-base button-action-secondary",children:"닫기"})})]})})});return d?sn:a.jsx(a.Fragment,{children:a.jsx(O,{open:n,onOpenChange:r,children:a.jsxs(P,{className:"overflow-hidden bg-white rounded-lg shadow-sm border-0 w-full sm:w-auto max-w-[calc(100vw-48px)] sm:max-w-[calc(100vw-80px)] lg:max-w-[90vw] xl:max-w-[85vw] h-[95vh] sm:h-auto sm:max-h-[90vh] lg:max-h-[85vh] sm:rounded-lg flex flex-col",showCloseButton:!1,children:[a.jsx(A,{className:"sr-only",children:a.jsx(W,{children:"발주 상세 정보"})}),a.jsxs("div",{className:"relative px-3 sm:px-6 pt-0 sm:pt-3 lg:pt-4 pb-0 sm:pb-2 lg:pb-3 flex-shrink-0",children:[a.jsxs("div",{className:"absolute right-3 sm:right-6 top-3 sm:top-3 lg:top-4 flex items-center gap-2 z-10",children:[!he&&ht&&a.jsxs(i,{size:"sm",variant:"outline",onClick:()=>Bt(!0),className:"button-base button-action-secondary h-8 text-xs px-3",children:[a.jsx(re,{className:"w-3.5 h-3.5 mr-1.5"}),"수정"]}),!he&&ft&&se&&a.jsxs(i,{size:"sm",variant:"outline",onClick:()=>{ue&&se(ue)},className:"button-base button-action-danger h-8 text-xs px-3",children:[a.jsx(Q,{className:"w-3.5 h-3.5 mr-1.5"}),"삭제"]}),!bt&&!he&&a.jsxs(L,{open:$e,onOpenChange:Ee,children:[a.jsx(z,{asChild:!0,children:a.jsxs(i,{variant:"outline",size:"sm",className:"button-base button-action-secondary h-8 text-xs px-3 gap-1.5",title:"수정 요청",children:[a.jsx(ne,{className:"w-3.5 h-3.5 text-gray-500"}),a.jsx("span",{children:"수정 요청"})]})}),a.jsx(U,{className:"w-80 sm:w-96 p-4",align:"end",onOpenAutoFocus:e=>e.preventDefault(),children:a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx("h4",{className:"font-medium leading-none",children:"수정 요청"}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"해당 발주서에 대한 수정 요청사항을 입력해주세요."})]}),a.jsxs("div",{className:"space-y-3",children:[a.jsxs("div",{className:"space-y-1",children:[a.jsx(F,{htmlFor:"subject",className:"text-xs",children:"제목"}),a.jsx(E,{id:"subject",value:Te,onChange:e=>Oe(e.target.value),className:"h-8 text-xs",placeholder:"제목을 입력하세요"})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx(F,{htmlFor:"message",className:"text-xs",children:"내용"}),a.jsx("div",{className:"relative",onWheel:e=>e.stopPropagation(),children:a.jsx(B,{id:"message",value:Pe,onChange:e=>Ae(e.target.value),className:"min-h-[150px] text-xs font-mono overflow-auto",placeholder:"요청 내용을 입력하세요",style:{resize:"none"}})})]})]}),a.jsxs("div",{className:"flex justify-end gap-2",children:[a.jsx(i,{variant:"outline",size:"sm",onClick:()=>Ee(!1),className:"h-8 text-xs",children:"취소"}),a.jsx(i,{size:"sm",onClick:async()=>{if(Te.trim()&&Pe.trim()){Fe(!0);try{const{data:{user:e}}=await lt.auth.getUser();if(!e)return void K.error("로그인이 필요합니다.");const{data:t,error:n}=await lt.from("support_inquires").insert({user_id:e.id,user_email:e.email,user_name:Ne,inquiry_type:"modify",subject:Te,message:Pe,status:"open",purchase_request_id:ue?.id,purchase_order_number:ue?.purchase_order_number,requester_id:ue?.requester_id,purchase_info:JSON.stringify({vendor_name:ue?.vendor_name,total_amount:ue?.total_amount,item_count:ue?.purchase_request_items?.length||0})}).select("id").single();if(n)throw n;const r=t?.id;if(r){const{error:t}=await lt.from("support_inquiry_messages").insert({inquiry_id:r,sender_role:"user",sender_email:e.email,message:Pe,attachments:[]});if(t)throw t}K.success("수정 요청이 전송되었습니다."),Ee(!1),Oe(""),Ae("")}catch(e){c.error("수정 요청 전송 실패",e),K.error("수정 요청 전송 중 오류가 발생했습니다.")}finally{Fe(!1)}}else K.error("제목과 내용을 모두 입력해주세요.")},disabled:We,className:"h-8 text-xs bg-blue-600 hover:bg-blue-700",children:We?"전송 중...":"요청 전송"})]})]})})]}),a.jsx("button",{onClick:r,className:"button-base button-action-secondary w-8 h-8 rounded-full flex items-center justify-center",children:a.jsx(g,{className:"w-4 h-4 text-gray-500"})})]}),a.jsx("div",{className:"pr-8 sm:pr-16",children:a.jsxs("div",{className:"flex items-start gap-4 mb-0 sm:mb-3",children:[a.jsx("div",{className:"min-w-0 flex-1",children:a.jsx("h1",{className:"page-title mb-0 sm:mb-1",children:"발주 기본정보"})}),a.jsx("div",{className:"flex items-center gap-3",children:he&&a.jsxs(a.Fragment,{children:[a.jsxs(i,{size:"sm",variant:"outline",onClick:()=>{Bt(!1),ge(ue),ve(ue?.items||[]),be([])},className:"button-base button-action-secondary",children:[a.jsx(g,{className:"w-4 h-4 mr-2"}),"취소"]}),a.jsx(i,{size:"sm",onClick:async()=>{if(ue&&_e){tt.current=Date.now(),et.current=!0,ze(!0),c.debug("[handleSave] 저장 시작");try{const a=s(),i=2e4;c.debug("[handleSave] Step 1: 발주 기본 정보 업데이트 시작");const o=fe.reduce((e,t)=>e+(t.amount_value||0),0);let l=null;_e.contact_id?l=_e.contact_id:Array.isArray(_e.vendor_contacts)&&_e.vendor_contacts.length>0&&(l=_e.vendor_contacts[0].id||null);const d=await Gt(a.from("purchase_requests").update({purchase_order_number:_e.purchase_order_number||null,requester_name:_e.requester_name||null,vendor_id:_e.vendor_id||null,vendor_name:_e.vendor_name||null,contact_id:l,delivery_request_date:_e.delivery_request_date||null,revised_delivery_request_date:_e.revised_delivery_request_date||null,payment_category:_e.payment_category||null,project_vendor:_e.project_vendor||null,project_item:_e.project_item||null,sales_order_number:_e.sales_order_number||null,total_amount:Number(o),updated_at:(new Date).toISOString()}).eq("id",ue.id),i),u=d?.error;if(u)throw c.error("Purchase update error:",u),u;c.debug("[handleSave] Step 1 완료"),c.debug("[handleSave] Step 2: 담당자 정보 업데이트 시작");let m=null;try{if(_e.vendor_id&&Array.isArray(_e.vendor_contacts)&&_e.vendor_contacts.length>0){const e=_e.vendor_contacts[0];if(e.id){m=e.id;const{error:t}=await a.from("vendor_contacts").update({contact_name:e.contact_name||"",contact_email:e.contact_email||"",contact_phone:e.contact_phone||"",position:e.position||""}).eq("id",e.id);t?c.error("담당자 업데이트 오류:",t):me(t=>t?{...t,vendor_contacts:[e],contact_id:e.id,contact_name:e.contact_name}:null)}else if(e.contact_name){const{data:t,error:n}=await a.from("vendor_contacts").insert({vendor_id:_e.vendor_id,contact_name:e.contact_name,contact_email:e.contact_email||"",contact_phone:e.contact_phone||"",position:e.position||""}).select().single();if(n)c.error("담당자 생성 오류:",n);else if(t){m=t.id,_e.vendor_contacts=[t],me(e=>e?{...e,vendor_contacts:[t],contact_id:t.id,contact_name:t.contact_name}:null);const{error:e}=await a.from("purchase_requests").update({contact_id:t.id}).eq("id",ue.id);e&&c.error("purchase_requests contact_id 업데이트 오류:",e)}}}}catch(e){c.warn("⚠️ [handleSave] 담당자 정보 업데이트 실패 (무시하고 계속)",{error:e})}if(c.debug("[handleSave] Step 2 완료"),c.debug("[handleSave] Step 3: 삭제된 항목 처리 시작"),xe.length>0){const e=await Gt(a.from("purchase_request_items").delete().in("id",xe),i),t=e?.error;if(t)throw c.error("품목 삭제 에러:",t),t}if(c.debug("[handleSave] Step 3 완료"),0===fe.length){c.info("🚀 모든 품목이 삭제되어 발주기본정보도 삭제합니다",{purchaseId:ue.id,deletedItemIds:xe});const{error:e}=await a.from("purchase_requests").delete().eq("id",ue.id);if(e)throw c.error("발주기본정보 삭제 실패",e),e;const t=Number(ue.id);if(!Number.isNaN(t)){N(t)?c.info("✅ [handleSave] 발주기본정보 삭제 메모리 캐시 업데이트 성공",{purchaseId:t}):c.warn("[handleSave] 발주기본정보 삭제 메모리 캐시 업데이트 실패",{purchaseId:t})}K.success("모든 품목이 삭제되어 발주요청이 삭제되었습니다."),Bt(!1),be([]),r();const n=I?.(!0,{silent:!1});return void(n instanceof Promise&&await n)}c.debug(`[handleSave] Step 4: 아이템 저장 시작, 총 ${fe.length}개`);for(let e=0;e<fe.length;e++){const t=fe[e],n=6e4;if(!t.item_name||!t.item_name.trim())throw new Error("품목명은 필수입니다.");(!t.quantity||t.quantity<=0)&&(t.quantity=1);const r=Vt(t.unit_price_value,0),i=Vt(t.amount_value,0);if(r<0)throw new Error("단가는 0 이상이어야 합니다.");if(i<0)throw new Error("합계는 0 이상이어야 합니다.");const s=t.id?Number(t.id):null,o=s&&!Number.isNaN(s)&&s>0,l=Vt(t.unit_price_value,0),d=Vt(t.amount_value,0);if(o){const r=await Gt(a.from("purchase_request_items").update({item_name:t.item_name.trim(),specification:t.specification||null,quantity:Vt(t.quantity,1),received_quantity:null!=t.received_quantity?Vt(t.received_quantity):null,unit_price_value:l,unit_price_currency:ue.currency||"KRW",amount_value:d,amount_currency:ue.currency||"KRW",remark:t.remark||null,link:t.link&&String(t.link).trim()?String(t.link).trim():null,updated_at:(new Date).toISOString()}).eq("id",s),n),i=r?.error;if(i)throw c.error("기존 항목 업데이트 오류",i),i;c.debug(`[handleSave] 아이템 ${e+1} 업데이트 완료`)}else{const r={purchase_request_id:ue.id,item_name:t.item_name.trim(),specification:t.specification||null,quantity:Vt(t.quantity,1),received_quantity:null!=t.received_quantity?Vt(t.received_quantity):null,unit_price_value:l,unit_price_currency:ue.currency||"KRW",amount_value:d,amount_currency:ue.currency||"KRW",remark:t.remark||null,link:t.link&&String(t.link).trim()?String(t.link).trim():null,line_number:t.line_number||fe.indexOf(t)+1,created_at:(new Date).toISOString()},i=await Gt(a.from("purchase_request_items").insert(r),n),s=i?.error;if(s)throw c.error("새 항목 생성 오류",s),s;c.debug(`[handleSave] 아이템 ${e+1} 삽입 완료`)}}c.debug("[handleSave] Step 4 완료: 모든 아이템 저장됨");const h=ue?Number(ue.id):NaN,_=_e||ue;try{!Number.isNaN(h)&&xe.length>0&&xe.forEach(e=>{try{j(h,e)||c.warn("[handleSave] 개별 품목 삭제 메모리 캐시 업데이트 실패",{purchaseId:h,itemId:e})}catch(t){c.warn("⚠️ [handleSave] 개별 품목 삭제 메모리 캐시 업데이트 중 에러 (무시)",{error:t})}})}catch(t){c.warn("⚠️ [handleSave] 메모리 캐시 삭제 처리 중 에러 (무시하고 계속)",{error:t})}try{if(!Number.isNaN(h)){p(h,e=>{const t=fe.reduce((e,t)=>e+(t.amount_value||0),0);return{...e,purchase_order_number:_?.purchase_order_number||e.purchase_order_number,requester_name:_?.requester_name||e.requester_name,vendor_id:_?.vendor_id||e.vendor_id,vendor_name:_?.vendor_name||e.vendor_name,vendor:_?.vendor||e.vendor,vendor_contacts:_?.vendor_contacts||e.vendor_contacts,delivery_request_date:_?.delivery_request_date||e.delivery_request_date,revised_delivery_request_date:_?.revised_delivery_request_date||e.revised_delivery_request_date,payment_category:_?.payment_category||e.payment_category,project_vendor:_?.project_vendor||e.project_vendor,project_item:_?.project_item||e.project_item,total_amount:t,items:fe,purchase_request_items:fe,updated_at:(new Date).toISOString()}})}}catch(t){c.warn("⚠️ [handleSave] 메모리 캐시 업데이트 중 에러 (무시하고 계속)",{error:t})}try{const e=()=>{!Number.isNaN(h)&&ie&&ie(h,e=>{const t=fe,n=t.reduce((e,t)=>e+(t.amount_value||0),0);return{...e,purchase_order_number:_?.purchase_order_number||e.purchase_order_number,requester_name:_?.requester_name||e.requester_name,vendor_id:_?.vendor_id||e.vendor_id,vendor_name:_?.vendor_name||e.vendor_name,vendor:_?.vendor||e.vendor,vendor_contacts:_?.vendor_contacts||e.vendor_contacts,delivery_request_date:_?.delivery_request_date||e.delivery_request_date,revised_delivery_request_date:_?.revised_delivery_request_date||e.revised_delivery_request_date,payment_category:_?.payment_category||e.payment_category,project_vendor:_?.project_vendor||e.project_vendor,project_item:_?.project_item||e.project_item,total_amount:n,items:t,purchase_request_items:t,updated_at:(new Date).toISOString()}})};c.debug("[handleSave] Step 5 - UI 업데이트 시작"),e(),c.debug("[handleSave] Step 5 완료 - 저장 성공!")}catch(n){c.warn("⚠️ [handleSave] OptimisticUpdate 중 에러 (무시하고 계속)",{error:n})}c.debug("[handleSave] Step 5 완료: UI 업데이트됨"),K.success("발주 내역이 성공적으로 저장되었습니다."),Bt(!1),be([]),c.debug("[handleSave] 저장 완료! 로딩 해제"),ze(!1),St().catch(e=>{c.warn("⚠️ [handleSave] 백그라운드 새로고침 실패",{error:e});const t=e instanceof Error?e.message:String(e);K.error(`저장 후 새로고침 실패: ${t}`,{duration:5e3})});const g=I?.(!0,{silent:!0});g instanceof Promise&&g.catch(e=>{c.warn("⚠️ [handleSave] 백그라운드 onRefresh 실패 (무시)",{error:e})})}catch(a){c.error("[handleSave] 저장 실패:",a);const e=a instanceof Error?a.message:"알 수 없는 오류가 발생했습니다";K.error(`저장 실패: ${e}`,{duration:5e3})}finally{c.debug("[handleSave] finally 블록 실행 - 로딩 해제"),et.current=!1,ze(!1)}}else K.error("저장할 데이터가 없습니다.")},disabled:Le,className:"button-base button-action-primary",children:Le?a.jsxs(a.Fragment,{children:[a.jsx(X,{className:"w-4 h-4 mr-2 animate-spin"}),"저장 중..."]}):a.jsxs(a.Fragment,{children:[a.jsx(J,{className:"w-4 h-4 mr-2"}),"저장"]})})]})})]})})]}),a.jsx("div",{className:"overflow-y-auto flex-1 px-3 sm:px-6 pb-1 sm:pb-6 mt-0",children:sn})]})})})}),Xn=Object.freeze(Object.defineProperty({__proto__:null,default:Qn},Symbol.toStringTag,{value:"Module"}));export{Un as A,G as C,Fn as D,te as I,ne as M,Qn as P,Ln as R,ae as T,Bn as U,Kn as a,zn as b,Z as c,re as d,Xn as e,Vn as n,Hn as t,An as u};
//# sourceMappingURL=PurchaseDetailModal-CCHz74r9.js.map
