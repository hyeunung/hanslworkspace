const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/FastPurchaseTable-DFCyUfpN.js","assets/index-BB8gWBJ2.js","assets/index-B8I1hY2t.css","assets/index-l6dIyOGf.js","assets/PurchaseDetailModal-EEP2oGMm.js","assets/helpers-Buk9LCEc.js","assets/useConfirmDateAction-B0CzcavP.js","assets/calendar-Df68Rohm.js","assets/chevron-right-CS8It64c.js","assets/chevron-down-mLqwS25_.js","assets/popover-Dab1q9VQ.js","assets/input-DOpXoeIB.js","assets/dialog-BL5kYNM2.js","assets/calendar-BkG57ZdC.js","assets/package-CLYiXfq8.js","assets/credit-card-DZzKtiF3.js","assets/trash-2-DI4tI9fs.js","assets/plus-CZmc5UA0.js","assets/pen--oC37y8t.js","assets/save-rPe_p8JE.js","assets/eye-C7m3RS89.js","assets/PurchaseItemsModal-Bl51WLzi.js"])))=>i.map(i=>d[i]);
import{c as e,r as a,a as t,l as s,j as r,_ as n,B as l,X as i,U as c,u as d,e as o}from"./index-BB8gWBJ2.js";import{t as u,B as m}from"./index-l6dIyOGf.js";import{I as h}from"./input-DOpXoeIB.js";import{P as p,a as b,b as g}from"./popover-Dab1q9VQ.js";import{S as x,a as y,b as _,c as f,d as v}from"./select-BCurjaLW.js";import{C as j,f as w,a as N}from"./calendar-Df68Rohm.js";import{C as k,a as C,b as S,c as q,d as M}from"./command-UkDlkCr2.js";import{C as D}from"./calendar-BkG57ZdC.js";import{P as F}from"./package-CLYiXfq8.js";import{C as T}from"./chevron-down-mLqwS25_.js";import{A}from"./arrow-up-down-BDTAQ-G0.js";import{S as P,C as I,a as R,b as O,c as E}from"./card-DZF3OWWB.js";import{P as $}from"./plus-CZmc5UA0.js";import"./chevron-right-CS8It64c.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const L=e("building",[["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M9 22v-3a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v3",key:"cabbwy"}],["rect",{x:"4",y:"2",width:"16",height:"20",rx:"2",key:"1uxh74"}]]),U=e("dollar-sign",[["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}],["path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6",key:"1b0p4s"}]]),Y=e("info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]),z=e("sliders-vertical",[["line",{x1:"4",x2:"4",y1:"21",y2:"14",key:"1p332r"}],["line",{x1:"4",x2:"4",y1:"10",y2:"3",key:"gb41h5"}],["line",{x1:"12",x2:"12",y1:"21",y2:"12",key:"hf2csr"}],["line",{x1:"12",x2:"12",y1:"8",y2:"3",key:"1kfi7u"}],["line",{x1:"20",x2:"20",y1:"21",y2:"16",key:"1lhrwl"}],["line",{x1:"20",x2:"20",y1:"12",y2:"3",key:"16vvfq"}],["line",{x1:"2",x2:"6",y1:"14",y2:"14",key:"1uebub"}],["line",{x1:"10",x2:"14",y1:"8",y2:"8",key:"1yglbp"}],["line",{x1:"18",x2:"22",y1:"16",y2:"16",key:"1jxqpz"}]]),B={purchases:null,lastFetch:0,userInfo:null,CACHE_DURATION:3e5,filteredData:new Map,FILTER_CACHE_DURATION:3e4},H=()=>{const e=Date.now(),r=B.lastFetch&&e-B.lastFetch<B.CACHE_DURATION&&B.purchases&&B.purchases.length>0,[n,l]=a.useState(r?B.purchases:[]),[i,c]=a.useState(!r),[d,o]=a.useState([]),[m,h]=a.useState(""),[p,b]=a.useState(""),[g,x]=a.useState(""),y=t(),_=a.useRef(!1),f=a.useRef(r);a.useEffect(()=>{(async()=>{if(_.current)return;_.current=!0;const e=Date.now(),a=B.lastFetch&&e-B.lastFetch<B.CACHE_DURATION;try{if(a&&B.userInfo)try{const e=B.userInfo;if(e){let a=[];if(e.purchase_role)if(Array.isArray(e.purchase_role))a=e.purchase_role.map(e=>String(e).trim());else{a=String(e.purchase_role).split(",").map(e=>e.trim()).filter(e=>e.length>0)}o(a),h(e.name||e.full_name||""),b(e.email||""),x(e.id||"")}return}catch(t){s.error("캐시 데이터 사용 중 오류",t),B.purchases=null,B.userInfo=null,B.lastFetch=0}const r=await y.auth.getUser();if(r.data.user&&!r.error){let a=null;if(r.data.user.email){a=(await y.from("employees").select("*").eq("email",r.data.user.email).maybeSingle()).data}if(a){B.userInfo=a;let e=[];if(a.purchase_role)if(Array.isArray(a.purchase_role))e=a.purchase_role.map(e=>String(e).trim());else{e=String(a.purchase_role).split(",").map(e=>e.trim()).filter(e=>e.length>0)}o(e),h(a.name||a.full_name||""),b(a.email||""),x(a.id||"")}B.lastFetch=e}}catch(t){s.error("초기 데이터 로드 실패",t)}})()},[]);const v=a.useCallback(async(e,a)=>{const t=!a?.silent&&!f.current;try{const r=Date.now(),n=B.lastFetch&&r-B.lastFetch<B.CACHE_DURATION;if(e)B.filteredData.clear(),B.purchases=null,B.lastFetch=0,f.current=!1,t&&c(!0);else{if(n&&B.purchases)return l(B.purchases),c(!1),f.current=!0,void(a?.silent||setTimeout(async()=>{try{await v(!0,{silent:!0})}catch(e){s.debug("백그라운드 데이터 업데이트 실패 (무시됨)",e)}},100));t&&!f.current&&c(!0)}const{data:{user:i},error:d}=await y.auth.getUser();if(d||!i)return s.error("사용자 인증 실패",d),u.error("로그인이 필요합니다."),void(t&&c(!1));const{data:o,error:m}=await y.from("purchase_requests").select("\n          *,\n          purchase_request_items(*)\n        ").order("request_date",{ascending:!1}).limit(1e3);if(m)throw m;let h=[],p=[],b=[];if(o&&o.length>0){const[e,a,t]=await Promise.all([y.from("employees").select("id, name, email"),y.from("vendors").select("id, vendor_name, vendor_payment_schedule"),y.from("vendor_contacts").select("id, contact_name")]);h=e.data||[],p=a.data||[],b=t.data||[]}const g=(new Date).toISOString().split("T")[0],x=((o||[]).filter(e=>e.request_date?.startsWith(g)),(o||[]).map(e=>{const a=e.purchase_request_items?.[0]||{},t=h.find(a=>a.id===e.requester_id),s=p.find(a=>a.id===e.vendor_id),r=b.find(a=>a.id===e.contact_id);return{id:Number(e.id),purchase_order_number:e.purchase_order_number,request_date:e.request_date,delivery_request_date:e.delivery_request_date??null,revised_delivery_request_date:e.revised_delivery_request_date??null,progress_type:e.progress_type,payment_completed_at:e.payment_completed_at,payment_completed_by_name:e.payment_completed_by_name,payment_category:e.payment_category,currency:e.currency,request_type:e.request_type,vendor:void 0,vendor_name:e.vendor_name||"",vendor_payment_schedule:s?.vendor_payment_schedule||"",vendor_contacts:[],requester_id:e.requester_id,requester_name:e.requester_name,requester_full_name:t?.name||e.requester_name||"",item_name:a.item_name||"",specification:a.specification||"",quantity:Number(a.quantity)||0,unit_price_value:Number(a.unit_price_value)||0,amount_value:Number(a.amount_value)||0,remark:a.remark||"",project_vendor:e.project_vendor,sales_order_number:e.sales_order_number,project_item:e.project_item,line_number:Number(a.line_number)||1,contact_name:r?.contact_name||"",middle_manager_status:e.middle_manager_status,final_manager_status:e.final_manager_status,is_received:!!e.is_received,received_at:e.received_at,is_payment_completed:!!e.is_payment_completed,is_utk_checked:!!e.is_utk_checked,is_statement_received:!!e.is_statement_received,is_po_download:!!e.is_po_download,link:a.link,items:(e.purchase_request_items||[]).sort((e,a)=>(e.line_number||0)-(a.line_number||0)),total_amount:e.purchase_request_items?.reduce((e,a)=>e+(Number(a.amount_value)||0),0)||0}}));l(x),B.purchases=x,B.lastFetch=r,f.current=!0}catch(r){s.error("발주 목록 로드 실패",r),u.error("발주 목록을 불러올 수 없습니다.")}finally{c(!1)}},[y]),j=a.useCallback((e,a)=>{l(t=>{const s=t.map(t=>t.id===e?a(t):t);return B.purchases=s,s})},[]);return a.useEffect(()=>{f.current?setTimeout(()=>{v(!0,{silent:!0}).catch(()=>{})},100):v()},[v]),{purchases:n,loading:i,currentUserRoles:d,currentUserName:m,currentUserEmail:p,currentUserId:g,refreshPurchases:v,updatePurchaseOptimistic:j}},V=["정희웅"],W=a.lazy(()=>n(()=>import("./FastPurchaseTable-DFCyUfpN.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]))),J=a.memo(()=>r.jsx("div",{className:"p-4 space-y-4",children:[...Array(5)].map((e,a)=>r.jsxs("div",{className:"flex space-x-4 animate-pulse",children:[r.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4"}),r.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4"}),r.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4"}),r.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4"})]},a))}));J.displayName="TableSkeleton";const K=a.memo(({purchases:e,activeTab:t,currentUserRoles:s,onRefresh:n,onOptimisticUpdate:l,onPaymentComplete:i,onReceiptComplete:c})=>r.jsx(a.Suspense,{fallback:r.jsx(J,{}),children:r.jsx(W,{purchases:e,activeTab:t,currentUserRoles:s,onRefresh:n,onOptimisticUpdate:l,onPaymentComplete:i,onReceiptComplete:c})}));K.displayName="LazyPurchaseTable";const G=[{key:"date_range",label:"기간별",type:"date_range",icon:D,category:"날짜"},{key:"date_month",label:"월별",type:"date_month",icon:D,category:"날짜"},{key:"requester_name",label:"요청자",type:"searchable_select",icon:c,category:"사용자"},{key:"vendor_name",label:"업체",type:"searchable_select",icon:L,category:"사용자"},{key:"contact_name",label:"담당자",type:"searchable_select",icon:c,category:"사용자"},{key:"purchase_order_number",label:"발주번호",type:"text",icon:F,category:"텍스트"},{key:"item_name",label:"품명",type:"text",icon:F,category:"텍스트"},{key:"specification",label:"규격",type:"text",icon:F,category:"텍스트"},{key:"remark",label:"비고",type:"text",icon:F,category:"텍스트"},{key:"project_vendor",label:"PJ업체",type:"text",icon:L,category:"텍스트"},{key:"project_item",label:"PJ ITEM",type:"text",icon:F,category:"텍스트"},{key:"sales_order_number",label:"수주번호",type:"text",icon:F,category:"텍스트"},{key:"quantity",label:"수량",type:"number",icon:U,category:"숫자"},{key:"unit_price_value",label:"단가",type:"number",icon:U,category:"숫자"},{key:"total_amount",label:"합계",type:"number",icon:U,category:"숫자"},{key:"payment_category",label:"결제종류",type:"select",icon:j,category:"상태",options:["현장결제","구매요청","발주요청"]},{key:"payment_schedule",label:"지출예정일",type:"select_with_empty",icon:D,category:"상태"},{key:"is_payment_completed",label:"구매현황",type:"select",icon:T,category:"상태",options:["대기","완료"]},{key:"is_received",label:"입고현황",type:"select",icon:T,category:"상태",options:["대기","완료"]},{key:"is_statement_received",label:"거래명세서 확인",type:"select",icon:T,category:"상태",options:["대기","완료"]},{key:"is_utk_checked",label:"UTK 확인",type:"select",icon:j,category:"상태",options:["대기","완료"]}],Q=[{value:"request_date",label:"청구일"},{value:"delivery_request_date",label:"입고요청일"},{value:"payment_completed_at",label:"구매완료일"},{value:"received_at",label:"입고완료일"},{value:"created_at",label:"생성일"},{value:"statement_received_at",label:"거래명세서입고일"}],X=[{value:"request_date",label:"요청일"},{value:"purchase_order_number",label:"발주번호"},{value:"vendor_name",label:"업체명"},{value:"requester_name",label:"요청자"},{value:"total_amount",label:"합계"},{value:"delivery_request_date",label:"입고요청일"},{value:"created_at",label:"생성일"}];function Z({activeFilters:e,sortConfig:t,searchTerm:s,onFiltersChange:n,onSortChange:c,onSearchChange:d,availableEmployees:o=[],availableVendors:u=[],availableContacts:j=[],availablePaymentSchedules:F=[]}){const[I,R]=a.useState(!1),[O,E]=a.useState(!1),[$,L]=a.useState(!1),[U,Y]=a.useState({}),[B,H]=a.useState(!1),[V,W]=a.useState(!1),[J,K]=a.useState({}),[Z,ee]=a.useState(),[ae,te]=a.useState({}),[se,re]=a.useState({}),ne=a.useRef(null);a.useEffect(()=>{$&&ne.current&&ne.current.focus()},[$]),a.useEffect(()=>{O&&re({field:t?.field||"",direction:t?.direction||"asc"})},[O,t]);const le=a=>{n(e.filter(e=>e.id!==a))},ie=()=>{const e=G.find(e=>e.key===U.field);if(!e)return null;switch(e.type){case"text":return r.jsx(h,{placeholder:"값 입력",value:U.value||"",onChange:e=>Y(a=>({...a,value:e.target.value})),className:"w-full business-radius-input border border-gray-300 bg-white text-gray-700 card-description h-auto",style:{padding:"2px 10px",fontSize:"10px",fontWeight:"500"}});case"number":return r.jsx(h,{type:"number",placeholder:"숫자 입력",value:U.value||"",onChange:e=>Y(a=>({...a,value:e.target.value})),className:"w-full business-radius-input border border-gray-300 bg-white text-gray-700 card-description h-auto",style:{padding:"2px 10px",fontSize:"10px",fontWeight:"500"}});case"searchable_select":let a=[],t="선택";return"requester_name"===e.key?(a=o,t="요청자"):"vendor_name"===e.key?(a=u,t="업체"):"contact_name"===e.key&&(a=j,t="담당자"),r.jsxs(p,{children:[r.jsx(b,{asChild:!0,children:r.jsxs(l,{variant:"outline",role:"combobox",className:"w-full button-base business-radius-button border border-gray-300 bg-white text-gray-700 justify-between [&>svg]:hidden",children:[r.jsx("span",{className:"truncate text-left",style:{fontSize:"12px",fontWeight:"500"},children:U.value||t}),r.jsx(P,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),r.jsx(g,{className:"w-[200px] p-0 border-0 shadow-lg",align:"start",children:r.jsxs(k,{className:"border-0",children:[r.jsx(C,{placeholder:`${t} 검색...`,className:"h-auto border-0 focus:ring-0 focus:outline-none card-description placeholder:card-description",style:{padding:"2px 10px"}}),r.jsxs(S,{children:[t,"를 찾을 수 없습니다."]}),r.jsx(q,{className:"max-h-[200px] overflow-y-auto",children:a.map(e=>r.jsxs(M,{value:e,onSelect:e=>{Y(a=>({...a,value:e}))},className:"cursor-pointer",children:[r.jsx(T,{className:"mr-2 h-3 w-3 "+(U.value===e?"opacity-100":"opacity-0")}),r.jsx("span",{className:"card-description",children:e})]},e))})]})})]});case"select":return r.jsxs(x,{value:U.value||"",onValueChange:e=>Y(a=>({...a,value:e})),children:[r.jsx(y,{className:"button-base business-radius-button border border-gray-300 bg-white text-gray-700 [&>svg]:hidden text-center",children:r.jsx(_,{placeholder:"선택"})}),r.jsx(f,{children:e.options?.map(e=>r.jsx(v,{value:e,children:r.jsx("span",{className:"card-description",children:e})},e))})]});case"select_with_empty":const s=["공란",...F];return r.jsxs(x,{value:U.value||"",onValueChange:e=>Y(a=>({...a,value:e})),children:[r.jsx(y,{className:"button-base business-radius-button border border-gray-300 bg-white text-gray-700 [&>svg]:hidden text-center",children:r.jsx(_,{placeholder:"지출예정일"})}),r.jsx(f,{children:s.map(e=>r.jsx(v,{value:e,children:r.jsx("span",{className:"card-description",children:e})},e))})]});case"date_range":return r.jsxs(p,{open:B,onOpenChange:e=>{if(e)if(U.value)if(U.value.includes("~")){const[e,a]=U.value.split("~");K({from:new Date(e),to:new Date(a)})}else K({from:new Date(U.value),to:void 0});else K({});H(e)},children:[r.jsx(b,{asChild:!0,children:r.jsx(l,{variant:"outline",className:"w-full button-base business-radius-button border border-gray-300 bg-white text-gray-700 justify-between h-auto",children:r.jsxs("div",{className:"flex items-center gap-1.5 min-h-[32px]",children:[r.jsx(D,{className:"w-3 h-3 flex-shrink-0"}),r.jsx("span",{className:"card-description leading-tight whitespace-pre-line",children:U.value?(()=>{if(U.value.includes("~")){const[e,a]=U.value.split("~");return`${w(new Date(e),"yy/MM/dd")}\n~ ${w(new Date(a),"yy/MM/dd")}`}return w(new Date(U.value),"yy/MM/dd")})():"날짜 선택"})]})})}),r.jsx(g,{className:"w-auto p-0",align:"start",children:r.jsxs("div",{className:"space-y-3",children:[r.jsxs("div",{className:"p-3 pb-0",children:[r.jsx("div",{className:"text-xs font-medium text-gray-600 mb-2",children:"날짜 범위 선택"}),r.jsx(N,{mode:"range",selected:J,onSelect:e=>{e&&K(e)},numberOfMonths:1,initialFocus:!0,className:"compact-calendar"})]}),r.jsxs("div",{className:"flex gap-2 p-3 pt-0",children:[r.jsx(l,{onClick:()=>{K({}),H(!1)},variant:"outline",className:"button-base border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 flex-1",children:"취소"}),r.jsx(l,{onClick:()=>{if(J.from){if(J.to){const e=`${w(J.from,"yyyy-MM-dd")}~${w(J.to,"yyyy-MM-dd")}`;Y(a=>({...a,value:e}))}else Y(e=>({...e,value:w(J.from,"yyyy-MM-dd")}));H(!1)}},disabled:!J.from,className:"button-base bg-blue-500 text-white hover:bg-blue-600 flex-1",children:"확인"})]})]})})]});case"date_month":return r.jsxs(p,{open:V,onOpenChange:e=>{if(e)if(U.value)if(U.value.includes("~")){const[e,a]=U.value.split("~");te({from:new Date(`${e}-01`),to:new Date(`${a}-01`)})}else te({from:new Date(`${U.value}-01`),to:void 0});else te({});W(e)},children:[r.jsx(b,{asChild:!0,children:r.jsx(l,{variant:"outline",className:"w-full button-base business-radius-button border border-gray-300 bg-white text-gray-700 justify-between h-auto",children:r.jsxs("div",{className:"flex items-center gap-1.5",children:[r.jsx(D,{className:"w-3 h-3 flex-shrink-0"}),r.jsx("span",{className:"card-description leading-tight whitespace-pre-line",children:U.value?(()=>{if(U.value.includes("~")){const[e,a]=U.value.split("~"),[t,s]=e.split("-"),[r,n]=a.split("-");return`${t.slice(-2)}/${s}\n~ ${r.slice(-2)}/${n}`}{const[e,a]=U.value.split("-");return`${e.slice(-2)}/${a}`}})():"월 선택"})]})})}),r.jsx(g,{className:"w-auto p-0",align:"start",children:r.jsxs("div",{className:"space-y-3",children:[r.jsxs("div",{className:"p-3 pb-0",children:[r.jsx("div",{className:"text-xs font-medium text-gray-600 mb-3",children:"월 선택"}),r.jsxs("div",{className:"flex gap-4",children:[r.jsxs("div",{className:"flex-1",children:[r.jsx("div",{className:"text-xs text-gray-500 mb-2",children:"시작 월 선택"}),r.jsx("div",{className:"mb-3",children:r.jsxs("div",{className:"flex items-center justify-between mb-2",children:[r.jsx(l,{onClick:()=>{const e=ae.from?ae.from.getFullYear():(new Date).getFullYear(),a=new Date(e-1,ae.from?ae.from.getMonth():0,1);te(e=>({...e,from:a}))},variant:"outline",size:"sm",className:"button-base border border-gray-300 bg-white text-gray-600 hover:bg-gray-50",children:"‹"}),r.jsxs("span",{className:"text-sm font-medium text-gray-700",children:[ae.from?ae.from.getFullYear():(new Date).getFullYear(),"년"]}),r.jsx(l,{onClick:()=>{const e=ae.from?ae.from.getFullYear():(new Date).getFullYear(),a=new Date(e+1,ae.from?ae.from.getMonth():0,1);te(e=>({...e,from:a}))},variant:"outline",size:"sm",className:"button-base border border-gray-300 bg-white text-gray-600 hover:bg-gray-50",children:"›"})]})}),r.jsx("div",{className:"grid grid-cols-3 gap-2",children:Array.from({length:12},(e,a)=>{const t=ae.from?ae.from.getFullYear():(new Date).getFullYear(),s=new Date(t,a,1),n=ae.from&&ae.from.getFullYear()===t&&ae.from.getMonth()===a;return r.jsxs(l,{onClick:()=>{te(e=>({...e,from:s}))},variant:"outline",className:"button-base text-xs h-8 "+(n?"bg-blue-500 text-white border-blue-500 hover:bg-blue-600":"border-gray-300 bg-white text-gray-700 hover:bg-gray-50"),children:[a+1,"월"]},a)})})]}),ae.from&&r.jsxs("div",{className:"flex-1",children:[r.jsx("div",{className:"text-xs text-gray-500 mb-2",children:"종료 월 선택 (선택사항)"}),r.jsx("div",{className:"mb-3",children:r.jsxs("div",{className:"flex items-center justify-between mb-2",children:[r.jsx(l,{onClick:()=>{const e=ae.to?ae.to.getFullYear():ae.from.getFullYear(),a=new Date(e-1,ae.to?ae.to.getMonth():11,1);te(e=>({...e,to:a}))},variant:"outline",size:"sm",className:"button-base border border-gray-300 bg-white text-gray-600 hover:bg-gray-50",children:"‹"}),r.jsxs("span",{className:"text-sm font-medium text-gray-700",children:[ae.to?ae.to.getFullYear():ae.from.getFullYear(),"년"]}),r.jsx(l,{onClick:()=>{const e=ae.to?ae.to.getFullYear():ae.from.getFullYear(),a=new Date(e+1,ae.to?ae.to.getMonth():11,1);te(e=>({...e,to:a}))},variant:"outline",size:"sm",className:"button-base border border-gray-300 bg-white text-gray-600 hover:bg-gray-50",children:"›"})]})}),r.jsx("div",{className:"grid grid-cols-3 gap-2",children:Array.from({length:12},(e,a)=>{const t=ae.to?ae.to.getFullYear():ae.from.getFullYear(),s=new Date(t,a,1),n=ae.to&&ae.to.getFullYear()===t&&ae.to.getMonth()===a,i=s<ae.from;return r.jsxs(l,{onClick:()=>{i||te(e=>({...e,to:s}))},variant:"outline",disabled:i,className:"button-base text-xs h-8 "+(n?"bg-blue-500 text-white border-blue-500 hover:bg-blue-600":i?"border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed":"border-gray-300 bg-white text-gray-700 hover:bg-gray-50"),children:[a+1,"월"]},a)})}),r.jsx("div",{className:"mt-3",children:r.jsx(l,{onClick:()=>{te(e=>({...e,to:void 0}))},variant:"outline",size:"sm",className:"button-base border border-gray-300 bg-white text-gray-600 hover:bg-gray-50 text-xs",children:"종료 월 제거"})})]})]})]}),r.jsxs("div",{className:"flex gap-2 p-3 pt-0",children:[r.jsx(l,{onClick:()=>{te({}),W(!1)},variant:"outline",className:"button-base border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 flex-1",children:"취소"}),r.jsx(l,{onClick:()=>{if(ae.from){if(ae.to){const e=`${w(ae.from,"yyyy-MM")}~${w(ae.to,"yyyy-MM")}`;Y(a=>({...a,value:e}))}else Y(e=>({...e,value:w(ae.from,"yyyy-MM")}));W(!1)}},disabled:!ae.from,className:"button-base bg-blue-500 text-white hover:bg-blue-600 flex-1",children:"확인"})]})]})})]});default:return null}};return r.jsxs("div",{className:"w-full space-y-3",children:[r.jsx("div",{className:"flex items-center justify-between",children:r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsxs(p,{open:I,onOpenChange:R,children:[r.jsx(b,{asChild:!0,children:r.jsxs(l,{variant:"outline",className:"button-base border border-gray-300 bg-white text-gray-700 hover:bg-gray-50",children:[r.jsx(z,{className:"w-4 h-4 mr-1"}),r.jsx("span",{className:"button-text",children:"필터"}),e.length>0&&r.jsx(m,{variant:"secondary",className:"ml-1 badge-stats-primary",children:e.length})]})}),r.jsx(g,{className:"w-64 p-3",align:"start",children:r.jsxs("div",{className:"space-y-3",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("h4",{className:"card-title",children:"필터"}),e.length>0&&r.jsx(l,{variant:"ghost",onClick:()=>{n([]),R(!1)},className:"button-base text-red-600 hover:text-red-700 hover:bg-red-50",children:r.jsx("span",{className:"button-text",children:"모두 지우기"})})]}),e.length>0&&r.jsxs("div",{className:"space-y-2",children:[e.map(e=>r.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-50 business-radius",children:[r.jsxs("span",{className:"card-description",children:[e.label,e.dateField&&r.jsxs("span",{className:"text-blue-600",children:["(",Q.find(a=>a.value===e.dateField)?.label,")"]}),": ",e.value]}),r.jsx(l,{variant:"ghost",onClick:()=>le(e.id),className:"button-base h-6 w-6 p-0 hover:bg-red-50",children:r.jsx(i,{className:"w-3 h-3"})})]},e.id)),r.jsx("div",{className:"border-t border-gray-200 my-2"})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs(x,{onValueChange:e=>{const a=G.find(a=>a.key===e);if(!a)return;let t="contains";"date_range"!==a.type&&"date_month"!==a.type||(t="equals"),Y({id:`${e}_${Date.now()}`,field:e,condition:t,value:"",label:a.label})},children:[r.jsx(y,{className:"button-base business-radius-button border border-gray-300 bg-white text-gray-700 [&>svg]:hidden text-center",children:r.jsx(_,{placeholder:"+ 필터 추가"})}),r.jsx(f,{className:"w-64 max-h-80 overflow-y-auto",style:{scrollbarWidth:"auto",scrollbarColor:"#9ca3af #f3f4f6",WebkitScrollbarWidth:"8px"},children:Object.entries(G.reduce((e,a)=>(e[a.category]||(e[a.category]=[]),e[a.category].push(a),e),{})).map(([e,a])=>r.jsxs("div",{children:[r.jsx("div",{className:"px-2 py-1 card-description uppercase",children:e}),a.map(e=>r.jsx(v,{value:e.key,children:r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(e.icon,{className:"w-4 h-4"}),r.jsx("span",{className:"card-description",children:e.label})]})},e.key))]},e))})]}),U.field&&r.jsxs("div",{className:"space-y-2 p-3 border business-radius bg-white",children:[r.jsx("div",{className:"flex items-center gap-2",children:r.jsxs("span",{className:"card-title",children:[U.label," 필터"]})}),"date_range"===U.field||"date_month"===U.field?r.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[r.jsx("div",{className:"flex items-start",children:r.jsxs(x,{value:U.dateField||"",onValueChange:e=>Y(a=>({...a,dateField:e})),children:[r.jsx(y,{className:"w-full button-base business-radius-button border border-gray-300 bg-white text-gray-700 [&>svg]:hidden text-center justify-center",children:r.jsx(_,{placeholder:"날짜 항목",className:"text-center"})}),r.jsx(f,{children:Q.map(e=>r.jsx(v,{value:e.value,children:r.jsx("span",{className:"card-description",children:e.label})},e.value))})]})}),r.jsx("div",{className:"flex items-start",children:ie()})]}):r.jsx("div",{children:ie()}),r.jsxs("div",{className:"flex gap-2",children:[r.jsx(l,{onClick:()=>{const a="date_range"===U.field||"date_month"===U.field,t=a&&!U.dateField;let s=U.condition;if(!s)if(a)s="equals";else{const e=G.find(e=>e.key===U.field);s="select"===e?.type||"select_with_empty"===e?.type||"searchable_select"===e?.type?"equals":"contains"}if(U.field&&void 0!==s&&""!==U.value&&!t){const a={id:U.id,field:U.field,condition:s,value:U.value,label:U.label,dateField:U.dateField};n([...e,a]),Y({}),R(!1)}},disabled:!U.field||""===U.value||("date_range"===U.field||"date_month"===U.field)&&!U.dateField,className:"button-base bg-blue-500 text-white hover:bg-blue-600 flex-1",children:"적용"}),r.jsx(l,{variant:"outline",onClick:()=>Y({}),className:"button-base border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 flex-1",children:"취소"})]})]})]})]})})]}),r.jsxs(p,{open:O,onOpenChange:E,children:[r.jsx(b,{asChild:!0,children:r.jsxs(l,{variant:"outline",className:"button-base border border-gray-300 bg-white text-gray-700 hover:bg-gray-50",children:[r.jsx(A,{className:"w-4 h-4 mr-1"}),r.jsx("span",{className:"button-text",children:"정렬"}),t&&r.jsxs("span",{className:"ml-1 card-description",children:["(","asc"===t.direction?"↑":"↓",")"]})]})}),r.jsx(g,{className:"w-56 p-3",align:"start",children:r.jsxs("div",{className:"space-y-3",children:[r.jsx("h4",{className:"card-title",children:"정렬 설정"}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs("div",{children:[r.jsx("label",{className:"text-xs text-gray-500 mb-1 block",children:"정렬 기준"}),r.jsxs(x,{value:se.field||"",onValueChange:e=>{re(a=>({...a,field:e}))},children:[r.jsx(y,{className:"button-base business-radius-button border border-gray-300 bg-white text-gray-700 [&>svg]:hidden",children:r.jsx(_,{placeholder:"선택하세요"})}),r.jsx(f,{children:X.map(e=>r.jsx(v,{value:e.value,children:r.jsx("span",{className:"card-description",children:e.label})},e.value))})]})]}),se.field&&r.jsxs("div",{children:[r.jsx("label",{className:"text-xs text-gray-500 mb-1 block",children:"정렬 방향"}),r.jsxs(x,{value:se.direction||"",onValueChange:e=>{re(a=>({...a,direction:e}))},children:[r.jsx(y,{className:"button-base business-radius-button border border-gray-300 bg-white text-gray-700 [&>svg]:hidden",children:r.jsx(_,{placeholder:"선택하세요"})}),r.jsxs(f,{children:[r.jsx(v,{value:"asc",children:r.jsx("span",{className:"card-description",children:"오름차순 ↑"})}),r.jsx(v,{value:"desc",children:r.jsx("span",{className:"card-description",children:"내림차순 ↓"})})]})]})]}),r.jsxs("div",{className:"flex gap-2 pt-2",children:[r.jsx(l,{onClick:()=>{if(se.field&&se.direction){const e=X.find(e=>e.value===se.field);e&&c({field:se.field,direction:se.direction,label:e.label})}E(!1),re({})},disabled:!se.field||!se.direction,className:"button-base bg-blue-500 hover:bg-blue-600 text-white flex-1",children:"적용"}),r.jsx(l,{onClick:()=>{c(null),re({}),E(!1)},className:"button-base border border-gray-300 bg-white text-gray-700 hover:bg-gray-50",children:"초기화"})]})]}),t&&r.jsx("div",{className:"border-t pt-2",children:r.jsx(l,{variant:"outline",onClick:()=>c(null),className:"button-base w-full border border-gray-300 text-gray-700",children:r.jsx("span",{className:"button-text",children:"정렬 해제"})})})]})})]}),r.jsx("div",{className:"flex items-center gap-2",children:$?r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(h,{ref:ne,placeholder:"전체 검색...",value:s,onChange:e=>d(e.target.value),className:"w-64 business-radius-input button-base border border-gray-300 bg-white text-gray-700"}),r.jsx(l,{variant:"ghost",onClick:()=>{L(!1),d("")},className:"button-base h-8 w-8 p-0",children:r.jsx(i,{className:"w-4 h-4"})})]}):r.jsxs(l,{variant:"outline",onClick:()=>L(!0),className:"button-base border border-gray-300 bg-white text-gray-700 hover:bg-gray-50",children:[r.jsx(P,{className:"w-4 h-4 mr-1"}),r.jsx("span",{className:"button-text",children:"검색"})]})}),r.jsxs(l,{variant:"outline",onClick:()=>{d(""),n([]),c({field:"created_at",direction:"desc",label:"생성일"}),L(!1)},className:"button-base border border-gray-300 bg-white text-blue-600 hover:bg-blue-50 hover:border-blue-300",children:["↻ ",r.jsx("span",{className:"button-text text-blue-600",children:"초기화"})]})]})}),e.length>0&&r.jsx("div",{className:"flex flex-wrap gap-2",children:e.map(e=>r.jsxs(m,{variant:"secondary",className:"badge-base flex items-center gap-1 bg-blue-50 text-blue-700 border-blue-200",children:[e.label,e.dateField&&r.jsxs("span",{className:"text-blue-600",children:["(",Q.find(a=>a.value===e.dateField)?.label,")"]}),": ",e.value,r.jsx(l,{variant:"ghost",size:"sm",onClick:()=>le(e.id),className:"h-4 w-4 p-0 hover:bg-blue-100 ml-1",children:r.jsx(i,{className:"w-3 h-3"})})]},e.id))})]})}const ee=a.lazy(()=>n(()=>import("./PurchaseItemsModal-Bl51WLzi.js"),__vite__mapDeps([21,1,2,12,11,3,6,7,8,9,10,18,17,19,16]))),ae=[{key:"pending",label:"승인대기"},{key:"purchase",label:"구매 현황"},{key:"receipt",label:"입고 현황"},{key:"done",label:"전체 항목"}];function te({showEmailButton:e=!0}){const n=d(),i=o(),c=t(),[h,p]=a.useState(null),[b,g]=a.useState(!1),[x,y]=a.useState([]),[_,f]=a.useState({field:"created_at",direction:"desc",label:"생성일"}),[v,j]=a.useState(""),[w,N]=a.useState([]),[k,C]=a.useState([]),[S,q]=a.useState([]),[M,D]=a.useState([]),{purchases:T,loading:A,currentUserRoles:P,currentUserName:L,refreshPurchases:U,updatePurchaseOptimistic:z}=H(),B=P?.includes("app_admin"),{activeTab:W,setActiveTab:J,filteredPurchases:G}=((e,s,r)=>{t();const[n,l]=a.useState("pending"),[i,c]=a.useState(""),d=a.useMemo(()=>{if(!s||0===s.length)return{isAdmin:!1,isFinalApprover:!1,isMiddleManager:!1,isPurchaseManager:!1,hasApprovalRole:!1,isLeadBuyer:!1,isHr:!1};const e=s.includes("app_admin"),a=s.includes("final_approver"),t=s.includes("middle_manager");return{isAdmin:e,isFinalApprover:a,isMiddleManager:t,isPurchaseManager:s.includes("purchase_manager"),hasApprovalRole:e||a||t,isLeadBuyer:s.includes("raw_material_manager")||s.includes("consumable_manager")||s.includes("purchase_manager"),isHr:s.includes("hr")}},[s]),{isAdmin:o,isFinalApprover:u,isMiddleManager:m,isPurchaseManager:h,hasApprovalRole:p,isLeadBuyer:b,isHr:g}=d,x=a.useMemo(()=>s&&0!==s.length?h?2:s.some(e=>["middle_manager","final_approver","app_admin","ceo"].includes(e))?3:1:1,[s,h]),y=a.useCallback(e=>{if(!r)return"all";if("purchase"===e)return b||g||o?"all":r;if("receipt"===e)return b||g||o?"all":r;switch(x){case 1:case 2:return"done"===e?"all":r;case 3:return"all";default:return r}},[r,x,b,g,o]);a.useEffect(()=>{if(!r)return;const e=y(n);c(e)},[n,r,x,y]);const _=a.useMemo(()=>h||o?e:e.filter(e=>!V.includes(e.requester_name)),[e,h,o]),f=a.useMemo(()=>(new Date).toISOString().split("T")[0],[]),v=a.useMemo(()=>({isPending:e=>{const a=e.middle_manager_status,t=e.final_manager_status;if("rejected"===a||"rejected"===t)return!1;if("approved"===a&&"approved"===t)return!1;const s=["pending","대기","",null,void 0].includes(a),r=["pending","대기","",null,void 0].includes(t);return s||r},isPurchase:e=>{if(e.is_payment_completed)return!1;if("구매 요청"!==e.payment_category)return!1;const a=e.progress_type||"",t=a.includes("선진행"),s=a.includes("일반"),r="approved"===e.final_manager_status;return t||s&&r},isReceipt:e=>{if(e.is_received)return!1;const a=(e.progress_type||"").includes("선진행"),t="approved"===e.final_manager_status;return a||t}}),[]),j=a.useMemo(()=>{switch(n){case"pending":return _.filter(v.isPending);case"purchase":return _.filter(v.isPurchase);case"receipt":return _.filter(v.isReceipt);default:return _}},[_,n,v]),w=a.useMemo(()=>{let e;return e=i&&"all"!==i&&"전체"!==i?j.filter(e=>e.requester_name===i):j,e},[j,i]),N=a.useMemo(()=>[...w].sort((e,a)=>{const t=e.request_date?new Date(e.request_date).getTime():0;return(a.request_date?new Date(a.request_date).getTime():0)-t}),[w]),k=a.useMemo(()=>{const e=_,a=e=>new Set(e.map(e=>e.purchase_order_number)).size,t=a=>{if("purchase"===a)return b||g||o?e:e.filter(e=>e.requester_name===r);if("receipt"===a)return b||g||o?e:e.filter(e=>e.requester_name===r);const t=y(a);return"all"===t||"전체"===t?e:e.filter(e=>e.requester_name===t)},s=t("pending"),n=t("purchase"),l=t("receipt"),i=t("done"),c=s.filter(e=>{(new Date).toISOString().split("T")[0];const a=["pending","대기","",null,void 0].includes(e.middle_manager_status),t=["pending","대기","",null,void 0].includes(e.final_manager_status),s="rejected"===e.middle_manager_status,r="rejected"===e.final_manager_status;if(s||r)return!1;const n="approved"===e.middle_manager_status,l="approved"===e.final_manager_status;return(!n||!l)&&(a||t)}),d=n.filter(e=>{(new Date).toISOString().split("T")[0];const a="구매 요청"===e.payment_category,t=(e.progress_type||"").includes("선진행"),s=(e.progress_type||"").includes("일반"),r="approved"===e.final_manager_status;return!e.is_payment_completed&&!!a&&(t||s&&r)}),u=l.filter(e=>{(new Date).toISOString().split("T")[0];const a=(e.progress_type||"").includes("선진행"),t="approved"===e.final_manager_status;return!e.is_received&&(a||t)});return{pending:a(c),purchase:a(d),receipt:a(u),done:a(i)}},[_,x,r,y,b,g,o,f]);return{activeTab:n,selectedEmployee:i,setActiveTab:l,setSelectedEmployee:c,filteredPurchases:N,tabCounts:k}})(T,P,L);a.useEffect(()=>{"purchase"===new URLSearchParams(i.search).get("tab")&&J("purchase")},[i.search,J]),a.useEffect(()=>{(async()=>{try{const{data:e}=await c.from("employees").select("name");if(e){const a=[...new Set(e.map(e=>e.name).filter(Boolean))];N(a)}const{data:a}=await c.from("vendors").select("vendor_name");if(a){const e=[...new Set(a.map(e=>e.vendor_name).filter(Boolean))];C(e)}const{data:t}=await c.from("vendor_contacts").select("contact_name");if(t){const e=[...new Set(t.map(e=>e.contact_name).filter(Boolean))];q(e)}const{data:s}=await c.from("vendors").select("vendor_payment_schedule");if(s){const e=[...new Set(s.map(e=>e.vendor_payment_schedule).filter(Boolean))];D(e)}}catch(e){s.error("필터 옵션 데이터 로드 실패",e)}})()},[c]);const Q=a.useRef(!1);a.useEffect(()=>{if(!Q.current)return void(Q.current=!0);(async()=>{try{await U(!0,{silent:!0})}catch(e){s.error("탭 전환 시 발주 데이터 새로고침 실패",e)}})()},[W,U]),a.useCallback(e=>e.is_received?r.jsx(m,{variant:null,className:"badge-success",children:"입고완료"}):"approved"===e.middle_manager_status&&"approved"===e.final_manager_status?r.jsx(m,{variant:null,className:"badge-primary",children:"구매진행"}):"rejected"===e.middle_manager_status||"rejected"===e.final_manager_status?r.jsx(m,{variant:null,className:"badge-danger",children:"반려"}):r.jsx(m,{variant:null,className:"badge-warning",children:"승인대기"}),[]);const X=a.useCallback((e,a)=>{switch(a){case"purchase_order_number":return e.purchase_order_number;case"payment_category":return e.payment_category;case"requester_name":return e.requester_name;case"vendor_name":return e.vendor_name;case"contact_name":return e.contact_name;case"item_name":return e.item_name;case"specification":return e.specification;case"quantity":return e.quantity;case"unit_price_value":return e.unit_price_value;case"total_amount":return e.total_amount;case"remark":return e.remark;case"project_vendor":return e.project_vendor;case"project_item":return e.project_item;case"sales_order_number":return e.sales_order_number;case"payment_schedule":return e.vendor_payment_schedule;case"is_payment_completed":return e.is_payment_completed?"완료":"대기";case"is_received":return e.is_received?"완료":"대기";case"is_statement_received":return e.is_statement_received?"완료":"대기";case"is_utk_checked":return e.is_utk_checked?"완료":"대기";case"request_date":return e.request_date;case"delivery_request_date":return e.delivery_request_date;case"payment_completed_at":return e.payment_completed_at;case"received_at":return e.received_at;case"created_at":return e.created_at;case"statement_received_at":return e.statement_received_at;default:return null}},[]),te=a.useCallback((e,a,t,r)=>{if(null==e)return"is_empty"===a;if("date_range"===r&&t&&t.includes("~")){if(!e)return!1;const[a,s]=t.split("~"),r=new Date(e),n=new Date(a),l=new Date(s);return r>=n&&r<=l}if("date_month"===r&&t&&t.includes("~")){if(!e)return!1;const[a,s]=t.split("~"),r=new Date(e),n=new Date(`${a}-01`),l=new Date(`${s}-01`),i=new Date(l.getFullYear(),l.getMonth()+1,0,23,59,59);return r>=n&&r<=i}if(r&&("date_month"===r||r.endsWith("_month"))){if(!t)return!0;const a=new Date(e),[s,r]=t.split("-");return a.getFullYear()===parseInt(s)&&a.getMonth()+1===parseInt(r)}const n=String(e).toLowerCase(),l=String(t).toLowerCase();switch(a){case"contains":return n.includes(l);case"equals":if("date_range"===r||t.match(/^\d{4}-\d{2}-\d{2}/)){if(!e)return!1;try{const a=new Date(e).toISOString().split("T")[0];return a===t.split("T")[0]}catch(i){return s.error("날짜 비교 오류:",i),!1}}return n===l;case"starts_with":return n.startsWith(l);case"ends_with":return n.endsWith(l);case"is_empty":return!e||""===n.trim();case"is_not_empty":return!!e&&""!==n.trim();case"greater_than":return Number(e)>Number(t);case"less_than":return Number(e)<Number(t);case"between":default:return!0;case"after":return new Date(e)>new Date(t);case"before":return new Date(e)<new Date(t);case"not_equals":return n!==l}},[]),se=a.useCallback(e=>{let a=e;if(!(x.length>0||""!==v.trim())){const e=new Date;e.setDate(e.getDate()-60),a=a.filter(a=>{if(!a.request_date)return!1;return new Date(a.request_date)>=e})}if(v.trim()){const e=v.toLowerCase().trim();a=a.filter(a=>a.purchase_order_number?.toLowerCase().includes(e)||a.vendor_name?.toLowerCase().includes(e)||a.requester_name?.toLowerCase().includes(e)||a.item_name?.toLowerCase().includes(e)||a.specification?.toLowerCase().includes(e)||a.remark?.toLowerCase().includes(e)||a.project_vendor?.toLowerCase().includes(e)||a.project_item?.toLowerCase().includes(e)||a.sales_order_number?.toLowerCase().includes(e))}return x.forEach(e=>{a=a.filter(a=>{const t=("date_range"===e.field||"date_month"===e.field)&&e.dateField||e.field,s=X(a,t),r="date_month"===e.field?"date_month":"date_range"===e.field?"date_range":void 0;return te(s,e.condition,e.value,r)})}),a},[v,x,X,te]),re=a.useCallback(e=>_?[...e].sort((e,a)=>{const t=X(e,_.field),s=X(a,_.field);if(null==t)return 1;if(null==s)return-1;let r=0;return r="number"==typeof t&&"number"==typeof s?t-s:t instanceof Date&&s instanceof Date?t.getTime()-s.getTime():String(t).localeCompare(String(s)),"desc"===_.direction?-r:r}):e,[_,X]),ne=a.useMemo(()=>{const e=se(G);return re(e)},[G,se,re]),le=a.useMemo(()=>{const e=["정희웅"],a=P?.includes("purchase_manager")||P?.includes("app_admin")?T:T.filter(a=>!e.includes(a.requester_name)),t=se(a),s=e=>new Set(e.map(e=>e.purchase_order_number)).size,r=t.filter(e=>{const a=["pending","대기","",null,void 0].includes(e.middle_manager_status),t=["pending","대기","",null,void 0].includes(e.final_manager_status),s="rejected"===e.middle_manager_status,r="rejected"===e.final_manager_status;if(s||r)return!1;const n="approved"===e.middle_manager_status,l="approved"===e.final_manager_status;return(!n||!l)&&(a||t)}),n=t.filter(e=>{const a="구매 요청"===e.payment_category,t=(e.progress_type||"").includes("선진행"),s=(e.progress_type||"").includes("일반"),r="approved"===e.final_manager_status;return!e.is_payment_completed&&(!!a&&(t||s&&r))}),l=t.filter(e=>{const a=(e.progress_type||"").includes("선진행"),t="approved"===e.final_manager_status;return!e.is_received&&(a||t)});return{pending:s(r),purchase:s(n),receipt:s(l),done:s(t)}},[T,se,P]),ie=a.useMemo(()=>{const e=x.filter(e=>"date_month"===e.field||"date_range"===e.field&&e.dateField&&e.dateField.includes("_month"));if(0===e.length)return null;const a=e[0].value;if(a&&a.includes("~")){const[e,t]=a.split("~"),s=new Date(`${e}-01`),r=new Date(`${t}-01`),n=[];let l=0;const i=new Date(s);for(;i<=r;){const e=i.getFullYear(),a=i.getMonth()+1,t=`${e}-${a.toString().padStart(2,"0")}`,s=ne.filter(t=>{const s=new Date(t.request_date);return s.getFullYear()===e&&s.getMonth()+1===a}),r=s.reduce((e,a)=>e+(a.amount_value||a.total_amount||0),0);n.push({year:e,month:a,monthStr:t,total:r,count:s.length}),l+=r,i.setMonth(i.getMonth()+1)}return{type:"range",months:n,grandTotal:l}}{const[e,t]=a.split("-"),s=ne.filter(a=>{const s=new Date(a.request_date);return s.getFullYear()===parseInt(e)&&s.getMonth()+1===parseInt(t)}),r=s.reduce((e,a)=>e+(a.amount_value||a.total_amount||0),0);return{type:"single",year:parseInt(e),month:parseInt(t),total:r,count:s.length}}},[x,ne]),ce=a.useCallback(async e=>{try{const a=(new Date).toISOString(),[t,s]=await Promise.all([c.from("purchase_requests").update({is_received:!0,received_at:a}).eq("id",e),c.from("purchase_request_items").update({is_received:!0,delivery_status:"received"}).eq("purchase_request_id",e)]);if(t.error)throw t.error;if(s.error)throw s.error;u.success("입고완료 처리되었습니다."),await U()}catch(a){u.error("처리 중 오류가 발생했습니다.")}},[c,U]),de=a.useCallback(async e=>{try{const a=(new Date).toISOString(),[t,s]=await Promise.all([c.from("purchase_requests").update({is_payment_completed:!0,payment_completed_at:a}).eq("id",e),c.from("purchase_request_items").update({is_payment_completed:!0}).eq("purchase_request_id",e)]);if(t.error)throw t.error;if(s.error)throw s.error;u.success("구매완료 처리되었습니다."),await U()}catch(a){u.error("처리 중 오류가 발생했습니다.")}},[c,U]);a.useCallback(e=>{p(e),g(!0)},[]);const oe=a.useMemo(()=>h?{...h,vendor_name:h.vendor_name||"",project_vendor:h.project_vendor||"",sales_order_number:h.sales_order_number||"",project_item:h.project_item||""}:null,[h]);return r.jsxs("div",{className:"w-full",children:[r.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4",children:[r.jsxs("div",{children:[r.jsx("h1",{className:"page-title",children:"발주요청 관리"}),r.jsx("p",{className:"page-subtitle",style:{marginTop:"-2px",marginBottom:"-4px"},children:"Purchase Management"})]}),r.jsxs(l,{onClick:()=>n("/purchase/new"),className:"mt-4 sm:mt-0 bg-hansl-500 hover:bg-hansl-600",children:[r.jsx($,{className:"w-4 h-4 mr-2"}),"새 발주요청 작성"]})]}),r.jsxs("div",{className:"mb-3",children:[r.jsx(Z,{activeFilters:x,sortConfig:_,searchTerm:v,onFiltersChange:y,onSortChange:f,onSearchChange:j,availableEmployees:w,availableVendors:k,availableContacts:S,availablePaymentSchedules:M}),0===x.length&&!v.trim()&&r.jsxs("div",{className:"mt-2 flex items-center gap-1.5 text-xs text-gray-500",children:[r.jsx(Y,{className:"w-3.5 h-3.5"}),r.jsx("span",{children:"최근 60일 데이터만 표시됩니다. 더 오래된 데이터를 보려면 필터를 적용해주세요."})]})]}),r.jsxs("div",{className:"space-y-3",children:[r.jsx("div",{className:"flex flex-col sm:flex-row sm:space-x-1 space-y-1 sm:space-y-0 bg-gray-50 p-1 business-radius-card border border-gray-200",children:ae.map(e=>r.jsxs("button",{onClick:()=>{J(e.key)},className:"flex-1 flex items-center justify-center space-x-2 py-1.5 px-3 sm:px-4 business-radius-button button-text font-medium transition-colors "+(W===e.key?"text-hansl-600 bg-white shadow-sm border border-gray-200":"text-gray-600 bg-transparent hover:text-gray-900 hover:bg-white/50"),children:[r.jsx("span",{className:"whitespace-nowrap",children:e.label}),r.jsx(m,{variant:"secondary",className:W===e.key?"badge-stats-active":"badge-stats-secondary",children:le[e.key]})]},e.key))}),ie&&r.jsx("div",{className:"mb-3",children:"single"===ie.type?r.jsxs("div",{className:"inline-flex items-center gap-2 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 business-radius-badge px-3 py-2 shadow-sm",children:[r.jsxs("div",{className:"flex items-center gap-1.5",children:[r.jsx("div",{className:"w-1.5 h-1.5 bg-blue-500 rounded-full"}),r.jsxs("span",{className:"card-subtitle text-gray-700",children:[ie.year,"년 ",ie.month,"월"]}),r.jsxs("span",{className:"badge-text text-gray-500",children:[ie.count,"건"]})]}),r.jsx("div",{className:"h-4 w-px bg-blue-300"}),r.jsxs("span",{className:"modal-value text-blue-700 font-semibold",children:["₩",ie.total.toLocaleString()]})]}):r.jsxs(I,{className:"business-radius-card border border-gray-200 shadow-sm",children:[r.jsx(R,{className:"pb-3 pt-4 px-4",children:r.jsxs("div",{className:"flex items-center gap-4",children:[r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("div",{className:"w-1.5 h-1.5 bg-blue-500 rounded-full"}),r.jsx(O,{className:"section-title text-gray-800",children:"월별 발주요청 총액"})]}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsxs("span",{className:"badge-text text-gray-600",children:["(",ie.months.reduce((e,a)=>e+a.count,0),"건)"]}),r.jsx("div",{className:"h-4 w-px bg-gray-300"}),r.jsxs("span",{className:"modal-value text-gray-500 font-bold",children:["₩",ie.grandTotal.toLocaleString()]})]})]})}),r.jsx(E,{className:"px-4 pb-4",children:r.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2",children:ie.months.map(e=>r.jsx("div",{className:"bg-gray-50 business-radius-card px-3 py-1.5 border border-gray-200 hover:border-blue-300 hover:bg-blue-50 transition-all flex-shrink-0",children:r.jsxs("div",{className:"flex items-baseline gap-1.5",children:[r.jsxs("span",{className:"modal-value font-bold text-gray-800 whitespace-nowrap",children:[e.month,"월"]}),r.jsxs("span",{className:"text-[9px] text-gray-500 whitespace-nowrap",children:["(",e.count,")"]}),r.jsxs("span",{className:"modal-value text-gray-500 font-bold whitespace-nowrap ml-1",children:["₩",e.total.toLocaleString()]})]})},e.monthStr))})})]})}),r.jsx(I,{className:"overflow-hidden border border-gray-200",children:r.jsx(E,{className:"p-0",children:A?r.jsxs("div",{className:"flex items-center justify-center py-12",children:[r.jsx("div",{className:"w-8 h-8 border-2 border-hansl-500 border-t-transparent rounded-full animate-spin"}),r.jsx("span",{className:"ml-3 card-subtitle",children:"로딩 중..."})]}):0===ne.length?r.jsxs("div",{className:"text-center py-12",children:[r.jsx(F,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),r.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"발주요청서가 없습니다"}),r.jsx("p",{className:"card-subtitle",children:"새로운 발주요청서를 작성해보세요."})]}):r.jsx(K,{purchases:ne,activeTab:W,currentUserRoles:P,onRefresh:U,onOptimisticUpdate:z,onPaymentComplete:de,onReceiptComplete:ce})})})]}),oe&&r.jsx(a.Suspense,{fallback:r.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white"})}),children:r.jsx(ee,{isOpen:b,onClose:()=>{g(!1),p(null)},purchase:oe,isAdmin:B||!1,onUpdate:U,activeTab:W})})]})}export{te as default};
//# sourceMappingURL=PurchaseListMain-CTB7K-_Y.js.map
