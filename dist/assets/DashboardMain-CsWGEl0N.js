import{c as e,a,l as s,u as t,r,j as l,X as n,B as i,S as d,b as c,d as o}from"./index-D1D5qv-9.js";import{C as m,a as u,b as p,c as h,S as g}from"./card-WPMpAy6a.js";import{D as x,a as _,b as y,c as b,I as v}from"./input-gluI5Byl.js";import{E as j}from"./exceljs.min-C8XMncME.js";import{D as f,T as N,P as w}from"./PurchaseDetailModal-BoD9pFVr.js";import{t as q}from"./index-xM-dRg0G.js";import{P as S}from"./package-C9UMlyQc.js";import{C as D}from"./calendar-CwZ7Y6yx.js";import{D as k}from"./download-BUy48PW8.js";import"./helpers-CsHcdtkA.js";import"./popover-DE4y84bL.js";import"./calendar-BFBN-M30.js";import"./chevron-down-C60V1RFS.js";import"./credit-card-BB0tYRxe.js";import"./plus-CNWOuMa9.js";import"./save-sg00ldh4.js";import"./chevron-right-BZRFf3a5.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const C=e("arrow-right",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]),P=e("circle-check",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]),R=e("clock",[["path",{d:"M12 6v6l4 2",key:"mmk7yg"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]),O={data:null,lastFetch:0,CACHE_DURATION:3e4,employeeId:null};const A=new class{constructor(){this.supabase=a()}parseRoles(e){let a=[];if(e)if(Array.isArray(e))a=e.map(e=>String(e).trim());else{a=String(e).split(",").map(e=>e.trim()).filter(e=>e.length>0)}return a}async getDashboardData(e,a=!1){const t=Date.now();if(!a&&O.data&&O.employeeId===e.id&&t-O.lastFetch<O.CACHE_DURATION&&O.data)return O.data;const r=await Promise.allSettled([this.getDashboardStats(e),this.getMyRecentRequests(e),this.getPendingApprovals(e),this.getQuickActions(e),this.getTodaySummary(e),this.getMyPurchaseStatus(e)]),l=r[0],n=r[1],i=r[2],d=r[3],c=r[4],o=r[5],m="fulfilled"===l.status?l.value:{total:0,myRequests:0,pending:0,completed:0,urgent:0,todayActions:0},u="fulfilled"===n.status?n.value:[],p="fulfilled"===i.status?i.value:[],h="fulfilled"===d.status?d.value:[],g="fulfilled"===c.status?c.value:{approved:0,requested:0,received:0},x="fulfilled"===o.status?o.value:{waitingPurchase:[],waitingDelivery:[],recentCompleted:[]};"rejected"===l.status&&s.error("[DashboardService] getDashboardStats ì‹¤íŒ¨:",l.reason),"rejected"===n.status&&s.error("[DashboardService] getMyRecentRequests ì‹¤íŒ¨:",n.reason),"rejected"===i.status&&s.error("[DashboardService] getPendingApprovals ì‹¤íŒ¨:",i.reason),"rejected"===d.status&&s.error("[DashboardService] getQuickActions ì‹¤íŒ¨:",d.reason),"rejected"===c.status&&s.error("[DashboardService] getTodaySummary ì‹¤íŒ¨:",c.reason),"rejected"===o.status&&s.error("[DashboardService] getMyPurchaseStatus ì‹¤íŒ¨:",o.reason);const _={employee:e,stats:m,urgentRequests:[],myRecentRequests:u,pendingApprovals:p,quickActions:h,todaySummary:g,myPurchaseStatus:x};return O.data=_,O.lastFetch=t,O.employeeId=e.id,_}async getDashboardStats(e){const a=(new Date).toISOString().split("T")[0],s=this.parseRoles(e.purchase_role),[t,r,l,n,i,d]=await Promise.all([this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("requester_name",e.name),this.getPendingCount(e,s),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("is_received",!0).gte("received_at",new Date((new Date).getFullYear(),(new Date).getMonth(),1).toISOString()),this.getUrgentCount(e,s),this.getTodayActionsCount(e,a)]);return{total:t.count||0,myRequests:r.count||0,pending:l,completed:n.count||0,urgent:i,todayActions:d}}async getMyRecentRequests(e){const{data:a}=await this.supabase.from("purchase_requests").select("*,vendors(vendor_name),purchase_request_items(id)").eq("requester_name",e.name).or("and(middle_manager_status.eq.approved,final_manager_status.eq.pending),and(final_manager_status.eq.approved,is_payment_completed.eq.false)").order("created_at",{ascending:!1}).limit(5);return(a||[]).map(e=>({...e,vendor_name:e.vendors?.vendor_name,total_items:e.purchase_request_items?.length||0,progress_percentage:this.calculateProgress(e),current_step:this.getCurrentStep(e),next_action:this.getNextAction(e),estimated_completion:this.estimateCompletion(e)}))}async getPendingApprovals(e){const a=this.parseRoles(e.purchase_role);let t=[];const r=await this.supabase.from("purchase_requests").select("*").order("request_date",{ascending:!1}).limit(100);if(r.error){r.error;const e=await this.supabase.from("purchase_requests").select("*").order("request_date",{ascending:!1}).limit(100);if(e.error)return[];t=e.data||[]}else t=r.data||[];let l=t||[];const n=e=>"pending"===e||"ëŒ€ê¸°"===e||""===e||null==e;if(s.debug("ðŸ” ìŠ¹ì¸ëŒ€ê¸° í•„í„°ë§ ì „ ë°ì´í„°",{employeeName:e.name,employeeRoles:this.parseRoles(e.purchase_role),totalRequests:t?.length||0,sampleData:t?.slice(0,3).map(e=>({id:e.id,purchase_order_number:e.purchase_order_number,middle_manager_status:e.middle_manager_status,final_manager_status:e.final_manager_status,vendor_name:e.vendor_name}))||[]}),l=l.filter(e=>{const a=n(e.middle_manager_status),t=n(e.final_manager_status),r="rejected"===e.middle_manager_status,l="rejected"===e.final_manager_status;if(r||l)return!1;const i=a||t;return s.debug("âœ… ìŠ¹ì¸ëŒ€ê¸° í•­ëª© í•„í„°ë§",{id:e.id,purchase_order_number:e.purchase_order_number,middle_manager_status:e.middle_manager_status,final_manager_status:e.final_manager_status,middlePending:a,finalPending:t,shouldInclude:i}),i}),s.debug("ðŸ” ìŠ¹ì¸ëŒ€ê¸° í•„í„°ë§ í›„ ë°ì´í„°",{filteredCount:l.length,filteredItems:l.map(e=>({id:e.id,purchase_order_number:e.purchase_order_number,middle_manager_status:e.middle_manager_status,final_manager_status:e.final_manager_status}))}),0===a.length)return[];let i=l;a.includes("app_admin")?s.debug("ðŸ”‘ app_admin ê¶Œí•œìœ¼ë¡œ ëª¨ë“  ìŠ¹ì¸ëŒ€ê¸° í•­ëª© í‘œì‹œ",{totalItems:i.length}):a.includes("middle_manager")?(i=l.filter(e=>n(e.middle_manager_status)),s.debug("ðŸ”‘ middle_manager ê¶Œí•œìœ¼ë¡œ ì¤‘ê°„ìŠ¹ì¸ ëŒ€ê¸° í•­ëª©ë§Œ í‘œì‹œ",{beforeFilter:l.length,afterFilter:i.length})):a.includes("final_approver")||a.includes("ceo")?(i=l.filter(e=>{const a="approved"===e.middle_manager_status,s=n(e.final_manager_status);return a&&s}),s.debug("ðŸ”‘ final_approver/ceo ê¶Œí•œìœ¼ë¡œ ìµœì¢…ìŠ¹ì¸ ëŒ€ê¸° í•­ëª©ë§Œ í‘œì‹œ",{beforeFilter:l.length,afterFilter:i.length})):a.includes("raw_material_manager")||a.includes("consumable_manager")?(i=l.filter(e=>{const a="approved"===e.middle_manager_status,s=n(e.final_manager_status);return a&&s}),s.debug("ðŸ”‘ material_manager ê¶Œí•œìœ¼ë¡œ ìµœì¢…ìŠ¹ì¸ ëŒ€ê¸° í•­ëª©ë§Œ í‘œì‹œ",{beforeFilter:l.length,afterFilter:i.length})):a.includes("lead buyer")?(i=l.filter(e=>{const a="approved"===e.final_manager_status,s=!e.is_payment_completed;return a&&s}),s.debug("ðŸ”‘ lead buyer ê¶Œí•œìœ¼ë¡œ êµ¬ë§¤ ëŒ€ê¸° í•­ëª©ë§Œ í‘œì‹œ",{beforeFilter:l.length,afterFilter:i.length})):(i=[],s.debug("ðŸ”‘ ìŠ¹ì¸ ê¶Œí•œ ì—†ëŠ” ì—­í• ",{roles:a,result:"empty"})),l=i,s.debug("ðŸ“‹ í’ˆëª© ì •ë³´ ì¡°íšŒ ì‹œìž‘",{filteredDataCount:l.length,filteredDataIds:l.map(e=>({id:e.id,purchase_order_number:e.purchase_order_number}))});const d=await Promise.all(l.map(async e=>{const{data:a}=await this.supabase.from("purchase_request_items").select("*").eq("purchase_request_id",e.id);let s=e.vendor_name;if(!s&&e.vendor_id){const{data:a}=await this.supabase.from("vendors").select("vendor_name").eq("id",e.vendor_id).single();s=a?.vendor_name}const t=a||[],r=t.reduce((e,a)=>e+(Number(a?.amount_value)||(Number(a?.quantity)||0)*(Number(a?.unit_price_value)||0)),0);return{...e,vendor_name:s,purchase_request_items:t,total_amount:r}}));return s.debug("ðŸ“‹ í’ˆëª© ì •ë³´ ì¡°íšŒ ì™„ë£Œ",{enhancedDataCount:d.length,enhancedDataSummary:d.map(e=>({id:e.id,purchase_order_number:e.purchase_order_number,itemsCount:e.purchase_request_items?.length||0,total_amount:e.total_amount}))}),d}async getQuickActions(e){const a=this.parseRoles(e.purchase_role),s=[];if(a.includes("app_admin")||a.includes("middle_manager")||a.includes("final_approver")||a.includes("ceo")){const t=await this.getPendingCount(e,a);t>0&&s.push({id:"approve",type:"approve",label:"ìŠ¹ì¸ ëŒ€ê¸°",description:`${t}ê±´ì˜ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘`,count:t,color:"red"})}if(a.includes("lead buyer")||a.includes("lead buyer")){const{count:e}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("final_manager_status","approved").eq("is_payment_completed",!1);e&&e>0&&s.push({id:"purchase",type:"purchase",label:"êµ¬ë§¤ ì²˜ë¦¬",description:`${e}ê±´ì˜ êµ¬ë§¤ ëŒ€ê¸° ì¤‘`,count:e,color:"yellow"})}return s}async getTodaySummary(e){const a=(new Date).toISOString().split("T")[0],s=new Date(Date.now()+864e5).toISOString().split("T")[0],[t,r,l]=await Promise.all([this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).gte("updated_at",a).lt("updated_at",s).or("middle_manager_status.eq.approved,final_manager_status.eq.approved"),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("requester_name",e.name).gte("created_at",a).lt("created_at",s),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("is_received",!0).gte("received_at",a).lt("received_at",s)]);return{approved:t.count||0,requested:r.count||0,received:l.count||0}}async getMyPurchaseStatus(e){const a=e.name||e.email,t=new Date(Date.now()-6048e5).toISOString(),r=await this.supabase.from("purchase_requests").select("*,vendors(vendor_name),purchase_request_items(item_name,quantity,specification,amount_value)").eq("requester_name",a).order("created_at",{ascending:!1}).limit(100);if(r.error)return s.error("getMyPurchaseStatus ì—ëŸ¬",r.error),{waitingPurchase:[],waitingDelivery:[],recentCompleted:[]};const l=r.data||[];return{waitingPurchase:l.filter(e=>{const a=(e.payment_category||"").trim().replace(/\s+/g,""),s=["êµ¬ë§¤ìš”ì²­","ë°œì£¼ìš”ì²­"].includes(a),t=!e.is_payment_completed,r=(e.progress_type||"").includes("ì„ ì§„í–‰");if(s&&t&&r)return!0;const l=(e.progress_type||"").includes("ì¼ë°˜")||!e.progress_type||""===e.progress_type,n="approved"===e.final_manager_status;return s&&t&&l&&n}).slice(0,10),waitingDelivery:l.filter(e=>{const a=!e.is_received,s=(e.progress_type||"").includes("ì„ ì§„í–‰");if(a&&s)return!0;const t="approved"===e.final_manager_status;return a&&t}).slice(0,10),recentCompleted:l.filter(e=>{if(!0!==e.is_received)return!1;if(!e.received_at)return!1;return new Date(e.received_at)>=new Date(t)}).slice(0,10)}}async quickApprove(e,a){try{const s=this.parseRoles(a.purchase_role),{data:t}=await this.supabase.from("purchase_requests").select("middle_manager_status, final_manager_status").eq("id",e).single();if(!t)return{success:!1,error:"ìš”ì²­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."};let r={};const l=e=>"pending"===e||"ëŒ€ê¸°"===e||""===e||null==e;if(s.includes("app_admin")?l(t.middle_manager_status)?r={middle_manager_status:"approved"}:"approved"===t.middle_manager_status&&l(t.final_manager_status)&&(r={final_manager_status:"approved"}):s.includes("middle_manager")?l(t.middle_manager_status)&&(r={middle_manager_status:"approved"}):s.includes("final_approver")||s.includes("ceo")?"approved"===t.middle_manager_status&&l(t.final_manager_status)&&(r={final_manager_status:"approved"}):(s.includes("raw_material_manager")||s.includes("consumable_manager"))&&"approved"===t.middle_manager_status&&l(t.final_manager_status)&&(r={final_manager_status:"approved"}),0===Object.keys(r).length)return{success:!1,error:"ìŠ¹ì¸í•  ìˆ˜ ìžˆëŠ” ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤."};const{data:n,error:i}=await this.supabase.from("purchase_requests").update(r).eq("id",e).select().single();if(i)throw i;return{success:!0}}catch(s){return{success:!1,error:s.message}}}async getPendingCount(e,a){if(a.includes("app_admin")){const[e,a,s]=await Promise.all([this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).or("middle_manager_status.in.(pending,ëŒ€ê¸°),middle_manager_status.is.null"),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("middle_manager_status","approved").or("final_manager_status.in.(pending,ëŒ€ê¸°),final_manager_status.is.null"),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("final_manager_status","approved").eq("is_payment_completed",!1)]);return(e.count||0)+(a.count||0)+(s.count||0)}if(a.includes("middle_manager")){const{count:e,error:a}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).or("middle_manager_status.in.(pending,ëŒ€ê¸°),middle_manager_status.is.null");return a?0:e||0}if(a.includes("final_approver")||a.includes("ceo")){const{count:e,error:a}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("middle_manager_status","approved").or("final_manager_status.in.(pending,ëŒ€ê¸°),final_manager_status.is.null");return a?0:e||0}if(a.includes("lead buyer")){const{count:e,error:a}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("final_manager_status","approved").eq("is_payment_completed",!1);return a?0:e||0}return 0}async getUrgentCount(e,a){if(0===a.length)return 0;const s=new Date(Date.now()-2592e5).toISOString();let t=this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).lt("created_at",s);if(a.includes("app_admin"))t=t.or("middle_manager_status.eq.pending,final_manager_status.eq.pending,is_payment_completed.eq.false");else if(a.includes("middle_manager"))t=t.eq("middle_manager_status","pending");else if(a.includes("final_approver")||a.includes("ceo"))t=t.eq("middle_manager_status","approved").eq("final_manager_status","pending");else{if(!a.includes("lead buyer"))return 0;t=t.eq("final_manager_status","approved").eq("is_payment_completed",!1)}const{count:r}=await t;return r||0}async getTodayActionsCount(e,a){const s=new Date(Date.now()+864e5).toISOString().split("T")[0],{count:t}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).gte("updated_at",a).lt("updated_at",s).eq("requester_name",e.name);return t||0}async getTotalDeliveryWaitingCount(){const{count:e}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("is_received",!1).or("is_payment_completed.eq.true,progress_type.ilike.%ì„ ì§„í–‰%");return e||0}calculateProgress(e){let a=0;return"approved"===e.middle_manager_status&&(a+=25),"approved"===e.final_manager_status&&(a+=25),e.is_payment_completed&&(a+=25),e.is_received&&(a+=25),a}getCurrentStep(e){return e.is_received?"completed":e.is_payment_completed?"delivery":"approved"===e.final_manager_status?"purchase":"approval"}getNextAction(e){return"pending"===e.middle_manager_status?"ì¤‘ê°„ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘":"pending"===e.final_manager_status?"ìµœì¢… ìŠ¹ì¸ ëŒ€ê¸° ì¤‘":e.is_payment_completed?e.is_received?"ì™„ë£Œ":"ìž…ê³  ëŒ€ê¸° ì¤‘":"êµ¬ë§¤ ì²˜ë¦¬ ëŒ€ê¸° ì¤‘"}estimateCompletion(e){const a=new Date(e.created_at),s=new Date;Math.floor((s.getTime()-a.getTime())/864e5);let t=7;"ê¸´ê¸‰"===e.progress_type&&(t=3);return new Date(a.getTime()+24*t*60*60*1e3).toLocaleDateString("ko-KR")}async getUndownloadedOrders(e){const a=this.parseRoles(e.purchase_role);if(!a.includes("lead buyer")&&!a.includes("app_admin"))return[];const{data:t,error:r}=await this.supabase.from("purchase_requests").select("*,purchase_request_items(id,item_name,specification,quantity,unit_price_value,amount_value)").order("created_at",{ascending:!1}).limit(100);if(r)return s.error("Failed to fetch undownloaded orders",r),[];const l=(t||[]).filter(e=>{const a="ì„ ì§„í–‰"===e.progress_type||"approved"===e.middle_manager_status&&"approved"===e.final_manager_status,s=!e.is_po_download||!1===e.is_po_download||null===e.is_po_download;return a&&s});return l.sort((e,a)=>new Date(e.created_at).getTime()-new Date(a.created_at).getTime()),l.slice(0,10)}};function I({isOpen:e,onClose:c,item:o,type:m,onRefresh:u}){const p=t(),h=a(),[g,v]=r.useState([]),[j,w]=r.useState(!1),[k,O]=r.useState(o);r.useEffect(()=>{O(o)},[o]),r.useEffect(()=>{(async()=>{const{data:{user:e}}=await h.auth.getUser();if(e?.email){const{data:a}=await h.from("employees").select("purchase_role").eq("email",e.email).single();if(a?.purchase_role){const e=Array.isArray(a.purchase_role)?a.purchase_role:a.purchase_role.split(",").map(e=>e.trim());v(e)}}})()},[m]);if(!k)return null;const A=k.purchase_request_items||[],I=A.reduce((e,a)=>e+(Number(a.amount_value)||0),0);A.reduce((e,a)=>e+(Number(a.quantity)||0),0),s.debug("ðŸš¨ PurchaseStatusModal ê¸´ê¸‰ ë””ë²„ê¹…",{type:`"${m}"`,typeType:typeof m,currentUserRoles:g,item:k.purchase_order_number,showPurchaseButton:"purchase"===m,showDeliveryButton:"delivery"===m,hasAdminPermission:g.includes("app_admin"),hasLeadBuyerPermission:g.includes("lead buyer"),leadBuyerCheck:g.some(e=>"lead buyer"===e.trim().toLowerCase()),itemData:{is_payment_completed:k.is_payment_completed,is_received:k.is_received},shouldShowPurchaseColumn:"purchase"===m,actualTypeValue:JSON.stringify(m)});const L=(()=>{switch(m){case"pending":return{icon:l.jsx(R,{className:"w-6 h-6 text-orange-600"}),title:"ìŠ¹ì¸ ëŒ€ê¸°",status:"ìŠ¹ì¸ ì²˜ë¦¬ ëŒ€ê¸°ì¤‘",color:"bg-orange-50 text-orange-700 border-orange-200"};case"purchase":return{icon:l.jsx(d,{className:"w-6 h-6 text-yellow-600"}),title:"êµ¬ë§¤ ëŒ€ê¸°",status:"êµ¬ë§¤ ì²˜ë¦¬ ëŒ€ê¸°ì¤‘",color:"bg-yellow-50 text-yellow-700 border-yellow-200"};case"delivery":return{icon:l.jsx(N,{className:"w-6 h-6 text-blue-600"}),title:"ìž…ê³  ëŒ€ê¸°",status:"ìž…ê³  ì²˜ë¦¬ ëŒ€ê¸°ì¤‘",color:"bg-blue-50 text-blue-700 border-blue-200"};case"completed":return{icon:l.jsx(D,{className:"w-6 h-6 text-green-600"}),title:"ì²˜ë¦¬ ì™„ë£Œ",status:"ëª¨ë“  ì²˜ë¦¬ ì™„ë£Œ",color:"bg-green-50 text-green-700 border-green-200"};default:return{icon:l.jsx(S,{className:"w-6 h-6 text-gray-600"}),title:"ìƒíƒœ í™•ì¸",status:"ìƒíƒœ í™•ì¸ í•„ìš”",color:"bg-gray-50 text-gray-700 border-gray-200"}}})();return l.jsx(x,{open:e,onOpenChange:c,children:l.jsxs(_,{className:"overflow-hidden bg-white rounded-3xl shadow-2xl border-0",style:{maxWidth:"1280px",width:"90vw",maxHeight:"50vh"},showCloseButton:!1,children:[l.jsx(y,{className:"sr-only",children:l.jsx(b,{children:"ë°œì£¼ ì§„í–‰ ìƒíƒœ"})}),l.jsxs("div",{className:"relative px-6 pt-6 pb-4",children:[l.jsx("button",{onClick:c,className:"absolute right-6 top-6 w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-all duration-200",children:l.jsx(n,{className:"w-4 h-4 text-gray-500"})}),l.jsx("div",{className:"pr-16",children:l.jsxs("div",{className:"flex items-start gap-4 mb-2",children:[l.jsx("div",{className:"w-10 h-10 rounded-2xl bg-blue-50 flex items-center justify-center flex-shrink-0",children:L.icon}),l.jsxs("div",{className:"min-w-0 flex-1",children:[l.jsx("h1",{className:"modal-title mb-1",children:k.purchase_order_number||"POë²ˆí˜¸ ì—†ìŒ"}),l.jsx("p",{className:"modal-subtitle",children:k.vendor_name||"ì—…ì²´ëª… ì—†ìŒ"})]}),l.jsx("div",{className:`px-3 py-1.5 business-radius-badge badge-text ${L.color}`,children:L.title})]})})]}),l.jsxs("div",{className:"overflow-y-auto max-h-[calc(50vh-160px)] px-6 pb-4 space-y-3",children:[l.jsx("div",{className:"bg-gray-50 rounded-xl p-3 border border-gray-100",children:l.jsxs("div",{className:"grid grid-cols-3 gap-x-4 gap-y-2 text-xs",children:[l.jsxs("div",{children:[l.jsx("span",{className:"modal-label",children:"ìš”ì²­ìž:"})," ",l.jsx("span",{className:"modal-value",children:k.requester_name})]}),l.jsxs("div",{children:[l.jsx("span",{className:"modal-label",children:"ìš”ì²­ì¼:"})," ",l.jsx("span",{className:"modal-value",children:new Date(k.request_date||k.created_at).toLocaleDateString("ko-KR")})]}),l.jsxs("div",{children:[l.jsx("span",{className:"modal-label",children:"ë‚©ê¸°ìš”ì²­ì¼:"})," ",l.jsx("span",{className:"modal-value",children:k.delivery_request_date?new Date(k.delivery_request_date).toLocaleDateString("ko-KR"):"ë¯¸ì§€ì •"})]}),l.jsxs("div",{children:[l.jsx("span",{className:"modal-label",children:"ì—…ì²´ëª…:"})," ",l.jsx("span",{className:"modal-value",children:k.vendor_name||"-"})]}),l.jsxs("div",{children:[l.jsx("span",{className:"modal-label",children:"ê²°ì œìœ í˜•:"})," ",l.jsx("span",{className:"modal-value",children:k.payment_category||"ì¼ë°˜"})]}),l.jsxs("div",{children:[l.jsx("span",{className:"modal-label",children:"ì§„í–‰êµ¬ë¶„:"})," ",l.jsx("span",{className:"modal-value",children:k.progress_type||"ì¼ë°˜"})]}),l.jsxs("div",{children:[l.jsx("span",{className:"modal-label",children:"í”„ë¡œì íŠ¸ì—…ì²´:"})," ",l.jsx("span",{className:"modal-value",children:k.project_vendor||"-"})]}),l.jsxs("div",{children:[l.jsx("span",{className:"modal-label",children:"íŒë§¤ì£¼ë¬¸ë²ˆí˜¸:"})," ",l.jsx("span",{className:"modal-value",children:k.sales_order_number||"-"})]}),l.jsxs("div",{children:[l.jsx("span",{className:"modal-label",children:"ë°°ì†¡ì§€:"})," ",l.jsx("span",{className:"modal-value",children:k.shipping_address||"ë³¸ì‚¬"})]}),l.jsxs("div",{children:[l.jsx("span",{className:"modal-label",children:"í†µí™”:"})," ",l.jsx("span",{className:"modal-value",children:k.currency||"KRW"})]}),l.jsxs("div",{children:[l.jsx("span",{className:"modal-label",children:"í…œí”Œë¦¿:"})," ",l.jsx("span",{className:"modal-value",children:k.po_template_type||"ì¼ë°˜"})]}),k.revised_delivery_request_date&&l.jsxs("div",{children:[l.jsx("span",{className:"modal-label text-orange-500",children:"ë³€ê²½ìž…ê³ ì¼:"})," ",l.jsx("span",{className:"modal-value text-orange-900",children:new Date(k.revised_delivery_request_date).toLocaleDateString("ko-KR")})]})]})}),l.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 overflow-hidden",children:[l.jsx("div",{className:"bg-gray-50 px-3 py-2 border-b border-gray-100",children:l.jsxs("h3",{className:"modal-section-title text-gray-700",children:["ì£¼ë¬¸ í’ˆëª© (",A.length,"ê°œ, ì´ â‚©",I.toLocaleString(),")"]})}),l.jsx("div",{className:"overflow-x-auto",children:l.jsxs("table",{className:"w-full text-xs table-fixed",children:[l.jsxs("colgroup",{children:[l.jsx("col",{className:"w-[25%]"}),l.jsx("col",{className:"w-[20%]"}),l.jsx("col",{className:"w-[10%]"}),l.jsx("col",{className:"w-[15%]"}),l.jsx("col",{className:"w-[15%]"}),("delivery"===m||"purchase"===m)&&l.jsx("col",{className:"w-[15%]"})]}),l.jsx("thead",{className:"bg-gray-50 border-b border-gray-100",children:l.jsxs("tr",{children:[l.jsx("th",{className:"text-left p-2 modal-label text-gray-600",children:"í’ˆëª©ëª…"}),l.jsx("th",{className:"text-left p-2 modal-label text-gray-600",children:"ê·œê²©"}),l.jsx("th",{className:"text-right p-2 modal-label text-gray-600",children:"ìˆ˜ëŸ‰"}),l.jsx("th",{className:"text-right p-2 modal-label text-gray-600",children:"ë‹¨ê°€"}),l.jsx("th",{className:"text-right p-2 modal-label text-gray-600",children:"ê¸ˆì•¡"}),"delivery"===m&&l.jsx("th",{className:"text-center p-2 modal-label text-gray-600",children:"ìž…ê³ ìƒíƒœ"}),"purchase"===m&&l.jsx("th",{className:"text-center p-2 modal-label text-gray-600",children:"êµ¬ë§¤ìƒíƒœ"})]})}),l.jsx("tbody",{className:"divide-y divide-gray-100",children:A.map((e,a)=>{const t=e.quantity>0?(Number(e.amount_value)||0)/e.quantity:0;return l.jsxs("tr",{className:"hover:bg-gray-50",children:[l.jsxs("td",{className:"p-2",children:[l.jsx("div",{className:"modal-value text-gray-900",children:e.item_name||"í’ˆëª©ëª… ì—†ìŒ"}),e.remark&&l.jsxs("div",{className:"text-xs text-amber-600 mt-1",children:["ë¹„ê³ : ",e.remark]})]}),l.jsx("td",{className:"p-2 text-gray-600",children:e.specification||"-"}),l.jsx("td",{className:"p-2 text-right modal-value",children:e.quantity||0}),l.jsxs("td",{className:"p-2 text-right",children:["â‚©",t.toLocaleString()]}),l.jsxs("td",{className:"p-2 text-right modal-value",children:["â‚©",(Number(e.amount_value)||0).toLocaleString()]}),"delivery"===m&&l.jsx("td",{className:"p-2 text-center",children:e.actual_received_date?l.jsxs("span",{className:"inline-flex items-center gap-1 bg-green-50 text-green-700 px-2 py-1 business-radius-badge text-xs border border-green-200",children:[l.jsx(P,{className:"w-3 h-3"}),"ì™„ë£Œ"]}):(g.includes("app_admin")||g.includes("requester"))&&l.jsx(f,{onDateSelect:a=>(async(e,a)=>{try{const{error:s}=await h.from("purchase_request_items").update({is_received:!0,received_at:(new Date).toISOString(),actual_received_date:e.toISOString()}).eq("id",a);if(s)throw s;O(s=>({...s,purchase_request_items:s.purchase_request_items?.map(s=>s.id===a?{...s,is_received:!0,received_at:(new Date).toISOString(),actual_received_date:e.toISOString()}:s)||[]})),q.success("ìž…ê³ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."),u&&u()}catch(s){q.error("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}})(a,e.id),placeholder:"ì‹¤ì œ ìž…ê³ ëœ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”",align:"center",side:"bottom",children:l.jsx(i,{size:"sm",className:"button-base bg-blue-600 hover:bg-blue-700 text-white",children:"ìž…ê³ ì™„ë£Œ"})})}),"purchase"===m&&l.jsx("td",{className:"p-2 text-center",children:e.is_payment_completed?l.jsxs("span",{className:"inline-flex items-center gap-1 bg-green-50 text-green-700 px-2 py-1 business-radius-badge text-xs border border-green-200",children:[l.jsx(P,{className:"w-3 h-3"}),"ì™„ë£Œ"]}):(g.includes("app_admin")||g.some(e=>"lead buyer"===e.trim().toLowerCase()))&&l.jsx(i,{size:"sm",onClick:()=>(async e=>{if(s.debug("ðŸ–±ï¸ êµ¬ë§¤ì™„ë£Œ ë²„íŠ¼ í´ë¦­ë¨",{itemId:e,timestamp:(new Date).toISOString()}),confirm("ì´ í’ˆëª©ì„ êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){s.debug("âœ… êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ ì‹œìž‘",{itemId:e});try{const{error:a}=await h.from("purchase_request_items").update({is_payment_completed:!0,payment_completed_at:(new Date).toISOString()}).eq("id",e);if(a)throw a;O(a=>({...a,purchase_request_items:a.purchase_request_items?.map(a=>a.id===e?{...a,is_payment_completed:!0,payment_completed_at:(new Date).toISOString()}:a)})),s.debug("âœ… êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ ì„±ê³µ",{itemId:e}),q.success("í’ˆëª© êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."),u?.()}catch(a){s.error("âŒ êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ ì‹¤íŒ¨",a,{itemId:e}),q.error("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}}else s.debug("âŒ ì‚¬ìš©ìžê°€ êµ¬ë§¤ì™„ë£Œ í™•ì¸ ì·¨ì†Œ")})(e.id),className:"button-base bg-yellow-600 hover:bg-yellow-700 text-white",children:"êµ¬ë§¤ì™„ë£Œ"})})]},a)})})]})})]}),"delivery"===m&&A.length>1&&l.jsx("div",{className:"bg-blue-50 rounded-xl p-3 border border-blue-100",children:(()=>{const e=A.filter(e=>e.actual_received_date).length,a=A.length,s=e/a*100;return l.jsxs("div",{className:"flex items-center gap-4",children:[l.jsx("div",{className:"modal-value text-blue-700",children:"ìž…ê³  ì§„í–‰ë¥ "}),l.jsx("div",{className:"flex-1 bg-blue-200 rounded-full h-2",children:l.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-500",style:{width:`${s}%`}})}),l.jsxs("div",{className:"modal-value text-blue-700",children:[e,"/",a," (",s.toFixed(0),"%)"]})]})})()})]}),l.jsx("div",{className:"sticky bottom-0 bg-white border-t border-gray-100 px-6 py-6",children:l.jsxs("div",{className:"flex items-center justify-between gap-6",children:["purchase"===m&&(g.includes("app_admin")||g.some(e=>"lead buyer"===e.trim().toLowerCase()))&&l.jsxs(i,{onClick:async()=>{w(!0);try{const{error:e}=await h.from("purchase_requests").update({is_payment_completed:!0,payment_completed_at:(new Date).toISOString()}).eq("id",k.id);if(e)throw e;O(e=>({...e,is_payment_completed:!0,payment_completed_at:(new Date).toISOString()})),q.success("êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."),u?.()}catch(e){q.error("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}finally{w(!1)}},disabled:j,className:"bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-8 py-4 rounded-2xl shadow-lg transition-all duration-200 modal-subtitle",children:[j?l.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-3"}):l.jsx(P,{className:"w-5 h-5 mr-3"}),"êµ¬ë§¤ ì™„ë£Œ ì²˜ë¦¬"]}),l.jsxs("div",{className:"flex items-center gap-4 ml-auto",children:[l.jsxs(i,{variant:"outline",onClick:()=>{p(`/purchase?highlight=${k.id}`),c()},className:"border-gray-300 text-gray-700 hover:bg-gray-50 hover:text-gray-900 hover:border-gray-400 px-8 py-4 rounded-2xl modal-subtitle transition-all duration-200",children:["ë°œì£¼ ëª©ë¡ì—ì„œ ë³´ê¸°",l.jsx(C,{className:"w-5 h-5 ml-3"})]}),l.jsx(i,{onClick:c,className:"bg-gray-900 hover:bg-gray-800 text-white px-10 py-4 rounded-2xl modal-subtitle transition-all duration-200 shadow-lg",children:"ì™„ë£Œ"})]})]})})]})})}function L(){const[e,f]=r.useState(null),[P,O]=r.useState(!0),[L,T]=r.useState(null),[F,M]=r.useState(null),[E,U]=r.useState(!1),[$,B]=r.useState([]),[K,z]=r.useState([]),[H,W]=r.useState(new Set),[Q,Y]=r.useState(null),[J,V]=r.useState(!1),G=a(),[X,Z]=r.useState(null),[ee,ae]=r.useState(null),[se,te]=r.useState(!1),[re,le]=r.useState({undownloaded:"",pending:"",purchase:"",delivery:""}),ne=t(),{employee:ie,currentUserRoles:de}=c(),ce=r.useCallback(async(a=!0,t=!1)=>{if(!ie)return s.error("[DashboardMain] No employee data available"),void(a&&O(!1));try{!a||t||e||O(!0);const s=await A.getDashboardData(ie,t);if(f(s),B(de),de.includes("lead buyer")||de.includes("app_admin"))try{const e=await A.getUndownloadedOrders(ie);z(e)}catch(r){}}catch(l){s.error("[DashboardMain] Failed to load dashboard data:",l),q.error("ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."),O(!1),f(null)}finally{a&&O(!1)}},[ie,de,e]);r.useEffect(()=>{ce()},[ce]);const oe=(e,a)=>{Z(e),ae(a),te(!0)},me=(e,a)=>a.trim()?e.filter(e=>[e.purchase_order_number||"",e.vendor_name||"",(e.purchase_request_items||[]).map(e=>e.item_name||"").join(" ")].join(" ").toLowerCase().includes(a.toLowerCase())):e,ue=async e=>{try{W(a=>new Set(a).add(e.id));const a=new j.Workbook,s=a.addWorksheet("ë°œì£¼ì„œ");s.columns=[{header:"ë°œì£¼ë²ˆí˜¸",key:"purchase_order_number",width:20},{header:"ì—…ì²´ëª…",key:"vendor_name",width:30},{header:"í’ˆëª©ëª…",key:"item_name",width:40},{header:"ê·œê²©",key:"specification",width:30},{header:"ìˆ˜ëŸ‰",key:"quantity",width:15},{header:"ë‹¨ê°€",key:"unit_price",width:20},{header:"ê¸ˆì•¡",key:"amount",width:20},{header:"ìš”ì²­ì¼",key:"request_date",width:15},{header:"ì§„í–‰ìƒíƒœ",key:"progress_type",width:15}];(e.purchase_request_items||[]).forEach(a=>{s.addRow({purchase_order_number:e.purchase_order_number,vendor_name:e.vendor_name||e.vendors?.vendor_name||"",item_name:a.item_name||"",specification:a.specification||"",quantity:a.quantity||0,unit_price:a.unit_price_value||0,amount:a.amount_value||0,request_date:e.request_date||"",progress_type:e.progress_type||""})}),s.getRow(1).font={bold:!0},s.getRow(1).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFE0E0E0"}};const t=await a.xlsx.writeBuffer(),r=new Blob([t],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),l=window.URL.createObjectURL(r),n=document.createElement("a");n.href=l,n.download=`ë°œì£¼ì„œ_${e.purchase_order_number}_${(new Date).toISOString().slice(0,10)}.xlsx`,n.click(),window.URL.revokeObjectURL(l),($.includes("lead buyer")||$.includes("app_admin"))&&(await G.from("purchase_requests").update({is_po_download:!0}).eq("id",e.id),z(a=>a.filter(a=>a.id!==e.id))),q.success("ë°œì£¼ì„œê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.")}catch(a){q.error("ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}finally{W(a=>{const s=new Set(a);return s.delete(e.id),s})}};if(P)return l.jsx("div",{className:"flex items-center justify-center",style:{minHeight:"400px",backgroundColor:"#f9fafb"},children:l.jsxs("div",{className:"text-center",children:[l.jsx("div",{className:"w-12 h-12 border-3 border-hansl-500 border-t-transparent rounded-full animate-spin mx-auto"}),l.jsx("p",{className:"mt-4 card-subtitle",children:"ëŒ€ì‹œë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìžˆìŠµë‹ˆë‹¤..."}),l.jsxs("p",{className:"text-xs text-gray-400 mt-2",children:["Employee: ",ie?.name||"ì—†ìŒ"]})]})});if(!e?.employee)return s.warn("[DashboardMain] ë°ì´í„° ì—†ìŒ",{hasData:!!e,hasEmployee:!!ie,employeeName:ie?.name,loading:P}),l.jsx("div",{className:"flex items-center justify-center",style:{minHeight:"400px",backgroundColor:"#f9fafb"},children:l.jsxs("div",{className:"text-center bg-white p-8 rounded-lg border border-gray-200 shadow-sm",children:[l.jsx("h3",{className:"modal-subtitle mb-2",children:"ì‚¬ìš©ìž ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"}),l.jsx("p",{className:"card-subtitle mb-4",children:"ë¡œê·¸ì¸ì„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."}),l.jsxs("div",{className:"text-xs text-gray-400 space-y-1",children:[l.jsxs("p",{children:["Employee: ",ie?.name||"ì—†ìŒ"]}),l.jsxs("p",{children:["Loading: ",P?"true":"false"]}),l.jsxs("p",{children:["Has Data: ",e?"true":"false"]})]})]})});const pe=(Array.isArray(e.employee.purchase_role)?e.employee.purchase_role.map(e=>String(e).trim()):e.employee.purchase_role?String(e.employee.purchase_role).split(",").map(e=>e.trim()).filter(e=>e.length>0):[]).some(e=>["middle_manager","final_approver","app_admin","raw_material_manager","consumable_manager"].includes(e));return l.jsxs("div",{className:"min-h-screen bg-gray-50",children:[l.jsxs("div",{className:"w-full px-4 lg:px-6",children:[l.jsx("div",{className:"mb-3",children:l.jsxs("div",{className:"flex items-center justify-between",children:[l.jsxs("div",{children:[l.jsx("h1",{className:"page-title",children:"ëŒ€ì‹œë³´ë“œ"}),l.jsx("p",{className:"page-subtitle",style:{marginTop:"-2px",marginBottom:"-4px"},children:"Dashboard"})]}),l.jsx("div",{className:"flex items-center gap-2",children:l.jsx("span",{className:"badge-stats border border-gray-300 bg-white text-gray-600",children:(new Date).toLocaleDateString("ko-KR",{month:"long",day:"numeric",weekday:"short"})})})]})}),l.jsx("div",{className:"mb-2",children:l.jsxs("h2",{className:"section-title mb-2 flex items-center gap-1.5",children:[l.jsx(S,{className:"w-3.5 h-3.5 text-gray-600"}),"ì „ì²´ í˜„í™©"]})}),l.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3",children:[($.includes("lead buyer")||$.includes("app_admin"))&&K.length>0&&l.jsxs(m,{className:"w-full col-span-1 row-span-2 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[l.jsx(u,{className:"py-3 px-4 bg-gray-50 border-b",children:l.jsxs(p,{className:"section-title flex items-center justify-between",children:[l.jsxs("div",{className:"flex items-center gap-2",children:[l.jsx(k,{className:"w-4 h-4 text-orange-600"}),l.jsx("span",{children:"ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œ"})]}),l.jsx("span",{className:"badge-stats bg-orange-100 text-orange-700",children:K.length})]})}),l.jsx(h,{className:"p-4",children:l.jsxs("div",{className:"space-y-3",children:[l.jsxs("div",{className:"relative",children:[l.jsx(g,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),l.jsx(v,{placeholder:"ë°œì£¼ë²ˆí˜¸, ì—…ì²´ëª…, í’ˆëª©ìœ¼ë¡œ ê²€ìƒ‰...",value:re.undownloaded,onChange:e=>le(a=>({...a,undownloaded:e.target.value})),className:"pl-10 h-8 text-xs"})]}),l.jsx("div",{className:"space-y-2 h-[36rem] overflow-y-auto",children:me(K,re.undownloaded).map(e=>{const a=e.purchase_request_items||[],s=a[0]||{};a.reduce((e,a)=>e+(Number(a.amount_value)||0),0),a.reduce((e,a)=>e+(Number(a.quantity)||0),0);const t=Math.floor((Date.now()-new Date(e.created_at).getTime())/864e5),r="ì„ ì§„í–‰"===e.progress_type;return l.jsx("div",{className:"border rounded-lg p-2 transition-all cursor-pointer hover:shadow-sm "+(r?"bg-red-50 hover:bg-red-100 border-red-200":"bg-white hover:bg-gray-50 border-gray-200"),onClick:()=>{Y(e),V(!0)},children:l.jsxs("div",{className:"flex items-center justify-between gap-2",children:[l.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[l.jsx("span",{className:"card-title",children:e.purchase_order_number||`PO-${e.id.slice(0,8)}`}),l.jsx("span",{className:"card-subtitle truncate",children:e.vendor_name||"ì—…ì²´ëª… ì—†ìŒ"}),l.jsxs("span",{className:"card-description truncate",children:[s.item_name||"í’ˆëª©",a.length>1&&l.jsxs("span",{className:"text-gray-400",children:[" ì™¸ ",a.length-1,"ê±´"]})]}),t>3&&l.jsxs("span",{className:"badge-stats border border-gray-300 bg-white text-gray-600 flex-shrink-0",children:[t,"ì¼"]})]}),l.jsx("div",{children:l.jsx(i,{size:"sm",variant:"outline",className:"h-7 px-2 badge-text border-orange-200 hover:bg-orange-50",onClick:a=>{a.stopPropagation(),ue(e)},disabled:H.has(e.id),children:H.has(e.id)?l.jsx("div",{className:"w-3 h-3 border border-orange-600 border-t-transparent rounded-full animate-spin"}):l.jsxs(l.Fragment,{children:[l.jsx(k,{className:"w-3 h-3 mr-1"}),"ë‹¤ìš´ë¡œë“œ"]})})})]})},e.id)})})]})})]}),pe&&l.jsxs(m,{className:"w-full col-span-1 row-span-2",children:[l.jsx(u,{className:"pb-2 pt-3",children:l.jsxs("div",{className:"flex items-center justify-between",children:[l.jsxs(p,{className:"section-title flex items-center gap-1.5",children:[l.jsx(R,{className:"w-3.5 h-3.5 text-orange-500"}),"ìŠ¹ì¸ ëŒ€ê¸°",e.pendingApprovals.length>0&&l.jsx("span",{className:"badge-stats bg-red-500 text-white h-4 px-1",children:e.pendingApprovals.length})]}),e.pendingApprovals.length>0&&l.jsx(i,{size:"sm",variant:"ghost",onClick:()=>ne("/purchase"),className:"h-6 px-2",children:l.jsx(C,{className:"w-3 h-3"})})]})}),l.jsx(h,{className:"p-3",children:0===e.pendingApprovals.length?l.jsxs("div",{className:"text-center py-4 text-gray-400",children:[l.jsx(D,{className:"w-6 h-6 mx-auto mb-1"}),l.jsx("p",{className:"card-description",children:"ëŒ€ê¸° í•­ëª© ì—†ìŒ"})]}):l.jsxs("div",{className:"space-y-3",children:[l.jsxs("div",{className:"relative",children:[l.jsx(g,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),l.jsx(v,{placeholder:"ë°œì£¼ë²ˆí˜¸, ì—…ì²´ëª…, í’ˆëª©ìœ¼ë¡œ ê²€ìƒ‰...",value:re.pending,onChange:e=>le(a=>({...a,pending:e.target.value})),className:"pl-10 h-8 text-xs"})]}),l.jsx("div",{style:{maxHeight:"36rem",overflowY:"auto",display:"flex",flexDirection:"column",gap:"0.375rem"},children:me(e.pendingApprovals,re.pending).slice(0,10).map((a,s)=>{const t=a.purchase_request_items||[],r=t[0]||{};a.total_amount||t.reduce((e,a)=>e+(Number(a.amount_value)||0),0);const n="ì„ ì§„í–‰"===a.progress_type;return l.jsx("div",{className:"border rounded-lg p-2 hover:shadow-sm transition-all cursor-pointer mb-1.5 "+(n?"bg-red-50 border-red-200":"hover:bg-orange-50/30"),style:{display:"block"},onClick:e=>{e.target.closest("button")||(M(Number(a.id)),U(!0))},children:l.jsxs("div",{className:"flex items-center justify-between gap-2",children:[l.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[l.jsx("span",{className:"card-title",children:a.purchase_order_number}),l.jsx("span",{className:"card-subtitle truncate",children:a.vendor_name||"ì—…ì²´"}),l.jsxs("span",{className:"card-description truncate",children:[r.item_name||"í’ˆëª©"," ",t.length>1&&`ì™¸ ${t.length-1}ê±´`]})]}),l.jsx(i,{size:"sm",onClick:s=>{s.stopPropagation(),(async a=>{if(!e?.employee)return void q.error("ì‚¬ìš©ìž ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");if(!confirm("ì •ë§ë¡œ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"))return;T(a);const s=e;f(e=>e?{...e,pendingApprovals:e.pendingApprovals.filter(e=>e.id!==a),stats:{...e.stats,pending:Math.max(0,e.stats.pending-1)}}:e);try{const t=await A.quickApprove(a,e.employee);t.success?(q.success("ìŠ¹ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."),setTimeout(()=>{ce(!1)},1e3)):(f(s),q.error(t.error||"ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."))}catch(t){f(s),q.error("ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}finally{T(null)}})(a.id)},disabled:L===a.id,className:"h-7 px-2 text-white badge-text shrink-0 "+("approved"===a.middle_manager_status?"bg-blue-600 hover:bg-blue-700":"bg-green-600 hover:bg-green-700"),children:L===a.id?l.jsx("div",{className:"w-3 h-3 border border-white border-t-transparent rounded-full animate-spin"}):l.jsxs(l.Fragment,{children:["approved"===a.middle_manager_status?"ìµœì¢…":"1ì°¨"," ìŠ¹ì¸"]})})]})},`approval-${a.id}`)})})]})})]}),$.includes("lead buyer")&&l.jsxs(m,{className:"w-full col-span-1 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[l.jsx(u,{className:"py-3 px-4 bg-gray-50 border-b",children:l.jsxs(p,{className:"section-title flex items-center justify-between",children:[l.jsxs("div",{className:"flex items-center gap-2",children:[l.jsx(d,{className:"w-4 h-4 text-yellow-600"}),l.jsx("span",{children:"êµ¬ë§¤ ëŒ€ê¸°"})]}),e.myPurchaseStatus&&e.myPurchaseStatus.waitingPurchase&&e.myPurchaseStatus.waitingPurchase.length>0&&l.jsx("span",{className:"badge-stats bg-yellow-100 text-yellow-700",children:e.myPurchaseStatus.waitingPurchase.length})]})}),l.jsx(h,{className:"p-4",children:e.myPurchaseStatus&&e.myPurchaseStatus.waitingPurchase&&0!==e.myPurchaseStatus.waitingPurchase.length?l.jsxs("div",{className:"space-y-3",children:[l.jsxs("div",{className:"relative",children:[l.jsx(g,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),l.jsx(v,{placeholder:"ë°œì£¼ë²ˆí˜¸, ì—…ì²´ëª…, í’ˆëª©ìœ¼ë¡œ ê²€ìƒ‰...",value:re.purchase,onChange:e=>le(a=>({...a,purchase:e.target.value})),className:"pl-10 h-8 text-xs"})]}),l.jsx("div",{className:"space-y-2 h-[36rem] overflow-y-auto",children:me(e.myPurchaseStatus.waitingPurchase,re.purchase).slice(0,10).map(e=>{const a=e.purchase_request_items||[],s=a[0];a.reduce((e,a)=>e+(Number(a.amount_value)||0),0);const t=(e.progress_type||"").includes("ì„ ì§„í–‰");return l.jsx("div",{className:"border rounded-lg p-3 transition-all hover:shadow-sm "+(t?"bg-red-50 hover:bg-red-100 border-red-200":"bg-white hover:bg-gray-50 border-gray-200"),children:l.jsxs("div",{className:"flex items-center justify-between gap-2",children:[l.jsxs("div",{className:"flex items-center gap-2 flex-1 cursor-pointer",onClick:()=>oe(e,"purchase"),children:[l.jsx("span",{className:"card-title",children:e.purchase_order_number||`PO-${e.id.slice(0,8)}`}),l.jsx("span",{className:"card-subtitle truncate",children:e.vendor_name||"ì—…ì²´ëª… ì—†ìŒ"}),l.jsxs("span",{className:"card-description truncate",children:[s?.item_name||"í’ˆëª©",a.length>1&&l.jsxs("span",{className:"text-gray-400",children:[" ì™¸ ",a.length-1,"ê±´"]})]})]}),($.includes("lead buyer")||$.includes("app_admin"))&&!e.is_payment_completed&&l.jsx(i,{size:"sm",onClick:async a=>{if(a.stopPropagation(),confirm("ì´ ë°œì£¼ë¥¼ êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"))try{const{error:a}=await G.from("purchase_requests").update({is_payment_completed:!0,payment_completed_at:(new Date).toISOString()}).eq("id",e.id);if(a)throw a;q.success("êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."),ce(!1)}catch(s){q.error("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},className:"bg-yellow-600 hover:bg-yellow-700 text-white h-7 px-2 badge-text shrink-0",children:"êµ¬ë§¤ì™„ë£Œ"}),e.is_payment_completed&&l.jsx("div",{className:"bg-green-100 text-green-700 px-2 py-1 business-radius-badge badge-text shrink-0",children:"ì™„ë£Œë¨"})]})},e.id)})})]}):l.jsxs("div",{className:"text-center py-12 text-gray-400",children:[l.jsx(d,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),l.jsx("p",{className:"card-subtitle",children:"êµ¬ë§¤ ëŒ€ê¸° í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤"})]})})]}),l.jsxs(m,{className:"w-full col-span-1 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[l.jsx(u,{className:"py-3 px-4 bg-gray-50 border-b",children:l.jsxs(p,{className:"section-title flex items-center justify-between",children:[l.jsxs("div",{className:"flex items-center gap-2",children:[l.jsx(N,{className:"w-4 h-4 text-blue-600"}),l.jsx("span",{children:"ìž…ê³  ëŒ€ê¸°"})]}),e.myPurchaseStatus.waitingDelivery.length>0&&l.jsx("span",{className:"badge-stats bg-blue-100 text-blue-700",children:e.myPurchaseStatus.waitingDelivery.length})]})}),l.jsx(h,{className:"p-4",children:0===e.myPurchaseStatus.waitingDelivery.length?l.jsxs("div",{className:"text-center py-12 text-gray-400",children:[l.jsx(N,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),l.jsx("p",{className:"card-subtitle",children:"ìž…ê³  ëŒ€ê¸° í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤"})]}):l.jsxs("div",{className:"space-y-3",children:[l.jsxs("div",{className:"relative",children:[l.jsx(g,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),l.jsx(v,{placeholder:"ë°œì£¼ë²ˆí˜¸, ì—…ì²´ëª…, í’ˆëª©ìœ¼ë¡œ ê²€ìƒ‰...",value:re.delivery,onChange:e=>le(a=>({...a,delivery:e.target.value})),className:"pl-10 h-8 text-xs"})]}),l.jsx("div",{className:"space-y-2 h-[36rem] overflow-y-auto",children:me(e.myPurchaseStatus.waitingDelivery,re.delivery).slice(0,10).map(e=>{const a=e.purchase_request_items||[],s=a[0],t=a.length;a.filter(e=>e.is_received).length,a.reduce((e,a)=>e+(Number(a.amount_value)||0),0);const r=(e.progress_type||"").includes("ì„ ì§„í–‰");return l.jsx("div",{className:"border rounded-lg p-3 transition-all cursor-pointer hover:shadow-sm "+(r?"bg-red-50 hover:bg-red-100 border-red-200":"bg-white hover:bg-gray-50 border-gray-200"),onClick:()=>oe(e,"delivery"),children:l.jsxs("div",{className:"flex items-center gap-2",children:[l.jsx("span",{className:"card-title",children:e.purchase_order_number||`PO-${e.id.slice(0,8)}`}),l.jsx("span",{className:"card-subtitle truncate",children:e.vendor_name||"ì—…ì²´ëª… ì—†ìŒ"}),l.jsxs("span",{className:"card-description truncate",children:[s?.item_name||"í’ˆëª©",t>1&&l.jsxs("span",{className:"text-gray-400",children:[" ì™¸ ",t-1,"ê±´"]})]})]})},e.id)})})]})})]})]})]}),l.jsx(w,{purchaseId:F,isOpen:E,onClose:()=>{U(!1),M(null)},currentUserRoles:$,onRefresh:()=>{ce(),U(!1),M(null)},onOptimisticUpdate:(e,a)=>{o(e,a),ce(!1)}}),l.jsx(I,{isOpen:se,onClose:()=>{te(!1),Z(null),ae(null)},item:X,type:ee,onRefresh:()=>ce(!1)}),J&&Q&&l.jsx(x,{open:J,onOpenChange:()=>{V(!1),Y(null)},children:l.jsxs(_,{className:"overflow-hidden bg-white rounded-3xl shadow-2xl border-0",style:{maxWidth:"1280px",width:"90vw",maxHeight:"50vh"},showCloseButton:!1,children:[l.jsx(y,{className:"sr-only",children:l.jsx(b,{children:"ë°œì£¼ ìš”ì²­ ì„¸ë¶€ì‚¬í•­"})}),l.jsxs("div",{className:"relative px-6 pt-6 pb-4",children:[l.jsx("button",{onClick:()=>{V(!1),Y(null)},className:"absolute right-6 top-6 w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-all duration-200",children:l.jsx(n,{className:"w-4 h-4 text-gray-500"})}),l.jsx("div",{className:"pr-16",children:l.jsxs("div",{className:"flex items-start gap-4 mb-2",children:[l.jsx("div",{className:"w-10 h-10 rounded-2xl bg-orange-50 flex items-center justify-center flex-shrink-0",children:l.jsx(k,{className:"w-6 h-6 text-orange-600"})}),l.jsxs("div",{className:"min-w-0 flex-1",children:[l.jsx("h1",{className:"modal-title mb-1",children:Q.purchase_order_number||"POë²ˆí˜¸ ì—†ìŒ"}),l.jsx("p",{className:"modal-subtitle",children:Q.vendor_name||"ì—…ì²´ëª… ì—†ìŒ"})]}),l.jsx("span",{className:"badge-stats bg-orange-50 text-orange-700",children:"ë¯¸ë‹¤ìš´ë¡œë“œ"})]})})]}),l.jsxs("div",{className:"overflow-y-auto max-h-[calc(50vh-160px)] px-6 pb-4 space-y-3",children:[l.jsx("div",{className:"bg-gray-50 rounded-xl p-3 border border-gray-100",children:l.jsxs("div",{className:"grid grid-cols-3 gap-x-4 gap-y-2 text-xs",children:[l.jsxs("div",{children:[l.jsx("span",{className:"text-gray-500",children:"ìš”ì²­ìž:"})," ",l.jsx("span",{className:"font-medium",children:Q.requester_name})]}),l.jsxs("div",{children:[l.jsx("span",{className:"text-gray-500",children:"ìš”ì²­ì¼:"})," ",l.jsx("span",{className:"font-medium",children:new Date(Q.request_date||Q.created_at).toLocaleDateString("ko-KR")})]}),l.jsxs("div",{children:[l.jsx("span",{className:"text-gray-500",children:"ë‚©ê¸°ìš”ì²­ì¼:"})," ",l.jsx("span",{className:"font-medium",children:Q.delivery_request_date?new Date(Q.delivery_request_date).toLocaleDateString("ko-KR"):"ë¯¸ì§€ì •"})]}),l.jsxs("div",{children:[l.jsx("span",{className:"text-gray-500",children:"ì—…ì²´ëª…:"})," ",l.jsx("span",{className:"font-medium",children:Q.vendor_name||"-"})]}),l.jsxs("div",{children:[l.jsx("span",{className:"text-gray-500",children:"ê²°ì œìœ í˜•:"})," ",l.jsx("span",{className:"font-medium",children:Q.payment_category||"ì¼ë°˜"})]}),l.jsxs("div",{children:[l.jsx("span",{className:"text-gray-500",children:"ì§„í–‰êµ¬ë¶„:"})," ",l.jsx("span",{className:"font-medium",children:Q.progress_type||"ì¼ë°˜"})]}),l.jsxs("div",{children:[l.jsx("span",{className:"text-gray-500",children:"í”„ë¡œì íŠ¸ì—…ì²´:"})," ",l.jsx("span",{className:"font-medium",children:Q.project_vendor||"-"})]}),l.jsxs("div",{children:[l.jsx("span",{className:"text-gray-500",children:"íŒë§¤ì£¼ë¬¸ë²ˆí˜¸:"})," ",l.jsx("span",{className:"font-medium",children:Q.sales_order_number||"-"})]}),l.jsxs("div",{children:[l.jsx("span",{className:"text-gray-500",children:"ë°°ì†¡ì§€:"})," ",l.jsx("span",{className:"font-medium",children:Q.shipping_address||"ë³¸ì‚¬"})]}),l.jsxs("div",{children:[l.jsx("span",{className:"text-gray-500",children:"í†µí™”:"})," ",l.jsx("span",{className:"font-medium",children:Q.currency||"KRW"})]}),l.jsxs("div",{children:[l.jsx("span",{className:"text-gray-500",children:"í…œí”Œë¦¿:"})," ",l.jsx("span",{className:"font-medium",children:Q.po_template_type||"ì¼ë°˜"})]}),Q.revised_delivery_request_date&&l.jsxs("div",{children:[l.jsx("span",{className:"text-orange-500",children:"ë³€ê²½ìž…ê³ ì¼:"})," ",l.jsx("span",{className:"font-medium text-orange-900",children:new Date(Q.revised_delivery_request_date).toLocaleDateString("ko-KR")})]})]})}),l.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 overflow-hidden",children:[l.jsx("div",{className:"bg-gray-50 px-3 py-2 border-b border-gray-100",children:l.jsxs("h3",{className:"text-sm font-medium text-gray-700",children:["ì£¼ë¬¸ í’ˆëª© (",(Q.purchase_request_items||[]).length,"ê°œ, ì´ â‚©",(Q.purchase_request_items||[]).reduce((e,a)=>e+(Number(a.amount_value)||0),0).toLocaleString(),")"]})}),l.jsx("div",{className:"overflow-x-auto",children:l.jsxs("table",{className:"w-full text-xs table-fixed",children:[l.jsxs("colgroup",{children:[l.jsx("col",{className:"w-[30%]"}),l.jsx("col",{className:"w-[25%]"}),l.jsx("col",{className:"w-[10%]"}),l.jsx("col",{className:"w-[15%]"}),l.jsx("col",{className:"w-[20%]"})]}),l.jsx("thead",{className:"bg-gray-50 border-b border-gray-100",children:l.jsxs("tr",{children:[l.jsx("th",{className:"text-left p-2 font-medium text-gray-600",children:"í’ˆëª©ëª…"}),l.jsx("th",{className:"text-left p-2 font-medium text-gray-600",children:"ê·œê²©"}),l.jsx("th",{className:"text-right p-2 font-medium text-gray-600",children:"ìˆ˜ëŸ‰"}),l.jsx("th",{className:"text-right p-2 font-medium text-gray-600",children:"ë‹¨ê°€"}),l.jsx("th",{className:"text-right p-2 font-medium text-gray-600",children:"ê¸ˆì•¡"})]})}),l.jsx("tbody",{className:"divide-y divide-gray-100",children:(Q.purchase_request_items||[]).map((e,a)=>{const s=e.quantity>0?(Number(e.amount_value)||0)/e.quantity:0;return l.jsxs("tr",{className:"hover:bg-gray-50",children:[l.jsxs("td",{className:"p-2",children:[l.jsx("div",{className:"font-medium text-gray-900",children:e.item_name||"í’ˆëª©ëª… ì—†ìŒ"}),e.remark&&l.jsxs("div",{className:"text-xs text-amber-600 mt-1",children:["ë¹„ê³ : ",e.remark]})]}),l.jsx("td",{className:"p-2 text-gray-600",children:e.specification||"-"}),l.jsx("td",{className:"p-2 text-right font-medium",children:e.quantity||0}),l.jsxs("td",{className:"p-2 text-right",children:["â‚©",s.toLocaleString()]}),l.jsxs("td",{className:"p-2 text-right font-medium",children:["â‚©",(Number(e.amount_value)||0).toLocaleString()]})]},a)})})]})})]})]}),l.jsx("div",{className:"sticky bottom-0 bg-white border-t border-gray-100 px-6 py-6",children:l.jsxs("div",{className:"flex items-center justify-between gap-6",children:[l.jsxs(i,{onClick:()=>ue(Q),disabled:H.has(Q.id),className:"bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white px-8 py-4 rounded-2xl shadow-lg transition-all duration-200 modal-subtitle",children:[H.has(Q.id)?l.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-3"}):l.jsx(k,{className:"w-5 h-5 mr-3"}),"Excel ë‹¤ìš´ë¡œë“œ"]}),l.jsxs("div",{className:"flex items-center gap-4 ml-auto",children:[l.jsxs(i,{variant:"outline",onClick:()=>{ne("/purchase/list?tab=purchase"),V(!1),Y(null)},className:"border-gray-300 text-gray-700 hover:bg-gray-50 hover:text-gray-900 hover:border-gray-400 px-8 py-4 rounded-2xl modal-subtitle transition-all duration-200",children:["ë°œì£¼ ëª©ë¡ì—ì„œ ë³´ê¸°",l.jsx(C,{className:"w-5 h-5 ml-3"})]}),l.jsx(i,{onClick:()=>{V(!1),Y(null)},className:"bg-gray-900 hover:bg-gray-800 text-white px-10 py-4 rounded-2xl modal-subtitle transition-all duration-200 shadow-lg",children:"ì™„ë£Œ"})]})]})})]})})]})}export{L as default};
//# sourceMappingURL=DashboardMain-CsWGEl0N.js.map
