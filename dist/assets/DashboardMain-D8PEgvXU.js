import{c as e,l as t,u as a,p as s,C as r,r as n,a as i,b as l,d,j as o,P as c,B as u,M as m}from"./index-B0aFbCDa.js";import{C as p,a as h,b as g,c as _,S as f,T as y}from"./card-rzhbDXoW.js";import{I as v}from"./dialog-B9JpRg3-.js";import{T as x,P as b,A as w,a as j,b as N,c as q,d as S,e as D,f as P,g as M}from"./PurchaseDetailModal-D_hFDaXe.js";import{d as C}from"./excelDownload-T7nXjtXn.js";import{t as T}from"./index-DqxGfJS2.js";import{s as A}from"./supportService-C51a4I52.js";import{C as R}from"./clock-CiwhqvnK.js";import{C as F}from"./transactionStatementService-CwTePWPx.js";import{D as k}from"./download-DE4_RAxd.js";import{f as I}from"./react-select.esm-BC1txWwb.js";import"./helpers-CsHcdtkA.js";import"./popover-DZeKSEjt.js";import"./textarea-C0QyP4q-.js";import"./label-tQeQKrVk.js";import"./calendar-gkyAGM11.js";import"./check-BFmJFwUt.js";import"./credit-card-KOaGmOFp.js";import"./loader-circle-Yppxpi33.js";import"./save-xm8dx6KV.js";import"./chevron-right-BW_r-sHF.js";import"./chevron-down-H143nN2r.js";const O={data:null,lastFetch:0,CACHE_DURATION:3e4,employeeId:null};const U=new class{constructor(){this.supabase=e()}hasValidPurchaseMemory(e){if(!s.allPurchases||0===s.allPurchases.length)return!1;if(!e?.id)return!1;const t=Date.now()-(s.lastFetch||0)<r,a=s.currentUser?.id===String(e.id);return t&&a}invalidateDashboardCache(){O.data=null,O.lastFetch=0,O.employeeId=null}invalidateCache(){this.invalidateDashboardCache()}getPurchaseMemory(){return s.allPurchases||[]}parseRoles(e){let t=[];if(e)if(Array.isArray(e))t=e.map(e=>String(e).trim());else{t=String(e).split(",").map(e=>e.trim()).filter(e=>e.length>0)}return t}async getDashboardData(e,a=!1){const s=Date.now();if(!a&&O.data&&O.employeeId===e.id&&s-O.lastFetch<O.CACHE_DURATION&&O.data)return O.data;const r=!a&&this.hasValidPurchaseMemory(e),n=await Promise.allSettled([r?this.getDashboardStatsFromMemory(e):this.getDashboardStats(e),r?this.getMyRecentRequestsFromMemory(e):this.getMyRecentRequests(e),r?this.getPendingApprovalsFromMemory(e):this.getPendingApprovals(e),r?this.getQuickActionsFromMemory(e):this.getQuickActions(e),r?this.getTodaySummaryFromMemory(e):this.getTodaySummary(e),r?this.getMyPurchaseStatusFromMemory(e):this.getMyPurchaseStatus(e)]),i=n[0],l=n[1],d=n[2],o=n[3],c=n[4],u=n[5],m="fulfilled"===i.status?i.value:{total:0,myRequests:0,pending:0,completed:0,urgent:0,todayActions:0},p="fulfilled"===l.status?l.value:[],h="fulfilled"===d.status?d.value:[],g="fulfilled"===o.status?o.value:[],_="fulfilled"===c.status?c.value:{approved:0,requested:0,received:0},f="fulfilled"===u.status?u.value:{waitingPurchase:[],waitingDelivery:[],recentCompleted:[]};"rejected"===i.status&&t.error("[DashboardService] getDashboardStats Ïã§Ìå®:",i.reason),"rejected"===l.status&&t.error("[DashboardService] getMyRecentRequests Ïã§Ìå®:",l.reason),"rejected"===d.status&&t.error("[DashboardService] getPendingApprovals Ïã§Ìå®:",d.reason),"rejected"===o.status&&t.error("[DashboardService] getQuickActions Ïã§Ìå®:",o.reason),"rejected"===c.status&&t.error("[DashboardService] getTodaySummary Ïã§Ìå®:",c.reason),"rejected"===u.status&&t.error("[DashboardService] getMyPurchaseStatus Ïã§Ìå®:",u.reason);const y={employee:e,stats:m,urgentRequests:[],myRecentRequests:p,pendingApprovals:h,quickActions:g,todaySummary:_,myPurchaseStatus:f};return O.data=y,O.lastFetch=s,O.employeeId=e.id,y}isPendingStatus(e){return"pending"===e||"ÎåÄÍ∏∞"===e||""===e||null==e}toTime(e){if(!e)return 0;const t=new Date(e).getTime();return Number.isFinite(t)?t:0}async getDashboardStatsFromMemory(e){const t=this.getPurchaseMemory(),a=(new Date).toISOString().split("T")[0],s=this.parseRoles(e.purchase_role);e.name||e.email;const r=new Date((new Date).getFullYear(),(new Date).getMonth(),1).toISOString(),n=new Date(Date.now()-2592e5).toISOString();return{total:t.length,myRequests:t.filter(t=>(t.requester_name||"")===e.name).length,pending:await this.getPendingCountFromMemory(e,s),completed:t.filter(e=>!0===e.is_received&&this.toTime(e.received_at)>=this.toTime(r)).length,urgent:this.getUrgentCountFromMemory(e,s,n),todayActions:this.getTodayActionsCountFromMemory(e,a)}}async getMyRecentRequestsFromMemory(e){const t=this.getPurchaseMemory(),a=e.name||e.email;return t.filter(e=>(e.requester_name||"")===a).filter(e=>{const t="approved"===e.middle_manager_status,a=this.isPendingStatus(e.final_manager_status),s="approved"===e.final_manager_status,r=!e.is_payment_completed;return t&&a||s&&r}).sort((e,t)=>this.toTime(t.created_at)-this.toTime(e.created_at)).slice(0,5).map(e=>({...e,vendor_name:e.vendor_name,total_items:(e.purchase_request_items||[]).length,progress_percentage:this.calculateProgress(e),current_step:this.getCurrentStep(e),next_action:this.getNextAction(e),estimated_completion:this.estimateCompletion(e)}))}async getPendingApprovalsFromMemory(e){const t=this.parseRoles(e.purchase_role);if(0===t.length)return[];const a=[...this.getPurchaseMemory()].sort((e,t)=>this.toTime(t.request_date)-this.toTime(e.request_date)).filter(e=>{const t=this.isPendingStatus(e.middle_manager_status),a=this.isPendingStatus(e.final_manager_status),s="rejected"===e.middle_manager_status,r="rejected"===e.final_manager_status;return!s&&!r&&(t||a)});let s=a;t.includes("app_admin")||(s=t.includes("middle_manager")?a.filter(e=>this.isPendingStatus(e.middle_manager_status)):t.includes("final_approver")||t.includes("ceo")||t.includes("raw_material_manager")||t.includes("consumable_manager")?a.filter(e=>"approved"===e.middle_manager_status&&this.isPendingStatus(e.final_manager_status)):t.includes("lead buyer")?a.filter(e=>"approved"===e.final_manager_status&&!e.is_payment_completed):[]);return s.slice(0,100).map(e=>{const t=e.purchase_request_items||e.items||[],a=Number(e.total_amount)||t.reduce((e,t)=>e+(Number(t?.amount_value)||(Number(t?.quantity)||0)*(Number(t?.unit_price_value)||0)),0);return{...e,purchase_request_items:t,items:t,total_amount:a,vendor_name:e.vendor_name||e.project_vendor||e.vendor?.vendor_name}})}async getQuickActionsFromMemory(e){const t=this.parseRoles(e.purchase_role),a=[];if(t.includes("app_admin")||t.includes("middle_manager")||t.includes("final_approver")||t.includes("ceo")){const s=await this.getPendingCountFromMemory(e,t);s>0&&a.push({id:"approve",type:"approve",label:"ÏäπÏù∏ ÎåÄÍ∏∞",description:`${s}Í±¥Ïùò ÏäπÏù∏ ÎåÄÍ∏∞ Ï§ë`,count:s,color:"red"})}if(t.includes("lead buyer")||t.includes("lead buyer")){const e=this.getPurchaseMemory().filter(e=>"approved"===e.final_manager_status&&!1===e.is_payment_completed).length;e>0&&a.push({id:"purchase",type:"purchase",label:"Íµ¨Îß§ Ï≤òÎ¶¨",description:`${e}Í±¥Ïùò Íµ¨Îß§ ÎåÄÍ∏∞ Ï§ë`,count:e,color:"yellow"})}return a}async getTodaySummaryFromMemory(e){const t=this.getPurchaseMemory(),a=(new Date).toISOString().split("T")[0],s=new Date(Date.now()+864e5).toISOString().split("T")[0],r=e=>{const t=this.toTime(e);return t>=this.toTime(a)&&t<this.toTime(s)};return{approved:t.filter(e=>r(e.updated_at)&&("approved"===e.middle_manager_status||"approved"===e.final_manager_status)).length,requested:t.filter(t=>(t.requester_name||"")===e.name&&r(t.created_at)).length,received:t.filter(e=>!0===e.is_received&&r(e.received_at)).length}}async getMyPurchaseStatusFromMemory(e){const t=this.parseRoles(e.purchase_role),a=t.includes("lead buyer")||t.includes("app_admin"),s=e.name||e.email,r=this.getPurchaseMemory(),n=new Date(Date.now()-6048e5).toISOString(),i=(a?r:r.filter(e=>(e.requester_name||"")===s)).filter(e=>{const t="Íµ¨Îß§ ÏöîÏ≤≠"===(e.payment_category||"").trim(),a=!e.is_payment_completed;if(!t||!a)return!1;if((e.progress_type||"").includes("ÏÑ†ÏßÑÌñâ"))return!0;const s=(e.progress_type||"").includes("ÏùºÎ∞ò")||!e.progress_type||""===e.progress_type,r="approved"===e.final_manager_status;return s&&r}),l=r.filter(e=>{const t=!e.is_received,a=(e.progress_type||"").includes("ÏÑ†ÏßÑÌñâ");if((e.requester_name||"")!==s)return!1;if(t&&a)return!0;const r="approved"===e.final_manager_status;return t&&r}),d=r.filter(e=>!0===e.is_received&&(!!e.received_at&&((e.requester_name||"")===s&&this.toTime(e.received_at)>=this.toTime(n)))),o=(e,t)=>this.toTime(t.created_at)-this.toTime(e.created_at);return{waitingPurchase:[...i].sort(o),waitingDelivery:[...l].sort(o),recentCompleted:[...d].sort(o)}}async getPendingCountFromMemory(e,t){const a=this.getPurchaseMemory();if(t.includes("app_admin")){return a.filter(e=>this.isPendingStatus(e.middle_manager_status)).length+a.filter(e=>"approved"===e.middle_manager_status&&this.isPendingStatus(e.final_manager_status)).length+a.filter(e=>"approved"===e.final_manager_status&&!1===e.is_payment_completed).length}return t.includes("middle_manager")?a.filter(e=>this.isPendingStatus(e.middle_manager_status)).length:t.includes("final_approver")||t.includes("ceo")?a.filter(e=>"approved"===e.middle_manager_status&&this.isPendingStatus(e.final_manager_status)).length:t.includes("lead buyer")?a.filter(e=>"approved"===e.final_manager_status&&!1===e.is_payment_completed).length:0}getUrgentCountFromMemory(e,t,a){const s=this.getPurchaseMemory(),r=this.toTime(a),n=s.filter(e=>this.toTime(e.created_at)>0&&this.toTime(e.created_at)<r);return t.includes("app_admin")?n.filter(e=>"pending"===e.middle_manager_status||"pending"===e.final_manager_status||!1===e.is_payment_completed).length:t.includes("middle_manager")?n.filter(e=>"pending"===e.middle_manager_status).length:t.includes("final_approver")||t.includes("ceo")?n.filter(e=>"approved"===e.middle_manager_status&&"pending"===e.final_manager_status).length:t.includes("lead buyer")?n.filter(e=>"approved"===e.final_manager_status&&!1===e.is_payment_completed).length:0}getTodayActionsCountFromMemory(e,t){const a=this.getPurchaseMemory(),s=new Date(Date.now()+864e5).toISOString().split("T")[0],r=e=>{const a=this.toTime(e);return a>=this.toTime(t)&&a<this.toTime(s)};return a.filter(t=>r(t.updated_at)&&(t.requester_name||"")===e.name).length}async getDashboardStats(e){const t=(new Date).toISOString().split("T")[0],a=this.parseRoles(e.purchase_role),[s,r,n,i,l,d]=await Promise.all([this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("requester_name",e.name),this.getPendingCount(e,a),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("is_received",!0).gte("received_at",new Date((new Date).getFullYear(),(new Date).getMonth(),1).toISOString()),this.getUrgentCount(e,a),this.getTodayActionsCount(e,t)]);return{total:s.count||0,myRequests:r.count||0,pending:n,completed:i.count||0,urgent:l,todayActions:d}}async getMyRecentRequests(e){const{data:t}=await this.supabase.from("purchase_requests").select("*,vendors(vendor_name),purchase_request_items(id)").eq("requester_name",e.name).or("and(middle_manager_status.eq.approved,final_manager_status.eq.pending),and(final_manager_status.eq.approved,is_payment_completed.eq.false)").order("created_at",{ascending:!1}).limit(5);return(t||[]).map(e=>({...e,vendor_name:e.vendors?.vendor_name,total_items:e.purchase_request_items?.length||0,progress_percentage:this.calculateProgress(e),current_step:this.getCurrentStep(e),next_action:this.getNextAction(e),estimated_completion:this.estimateCompletion(e)}))}async getPendingApprovals(e){const a=this.parseRoles(e.purchase_role);if(0===a.length)return[];t.debug("üöÄ ÏäπÏù∏ ÎåÄÍ∏∞ Ìï≠Î™© Ï°∞Ìöå ÏãúÏûë",{employeeName:e.name,employeeRoles:a});const{data:s,error:r}=await this.supabase.from("purchase_requests").select("\n        *,\n        vendors(vendor_name),\n        purchase_request_items(\n          id,\n          item_name,\n          specification,\n          quantity,\n          unit_price_value,\n          amount_value\n        )\n      ").order("request_date",{ascending:!1}).limit(100);if(r)return t.error("‚ùå ÏäπÏù∏ ÎåÄÍ∏∞ Ìï≠Î™© Ï°∞Ìöå Ïã§Ìå®",r),[];let n=s||[];const i=e=>"pending"===e||"ÎåÄÍ∏∞"===e||""===e||null==e;t.debug("üîç ÏäπÏù∏ ÎåÄÍ∏∞ ÌïÑÌÑ∞ÎßÅ Ï†Ñ Îç∞Ïù¥ÌÑ∞",{totalRequests:s?.length||0}),n=n.filter(e=>{const t=i(e.middle_manager_status),a=i(e.final_manager_status),s="rejected"===e.middle_manager_status,r="rejected"===e.final_manager_status;return!s&&!r&&(t||a)});let l=n;a.includes("app_admin")?t.debug("üîë app_admin Í∂åÌïúÏúºÎ°ú Î™®Îì† ÏäπÏù∏ÎåÄÍ∏∞ Ìï≠Î™© ÌëúÏãú",{totalItems:l.length}):a.includes("middle_manager")?(l=n.filter(e=>i(e.middle_manager_status)),t.debug("üîë middle_manager Í∂åÌïúÏúºÎ°ú Ï§ëÍ∞ÑÏäπÏù∏ ÎåÄÍ∏∞ Ìï≠Î™©Îßå ÌëúÏãú",{beforeFilter:n.length,afterFilter:l.length})):a.includes("final_approver")||a.includes("ceo")?(l=n.filter(e=>{const t="approved"===e.middle_manager_status,a=i(e.final_manager_status);return t&&a}),t.debug("üîë final_approver/ceo Í∂åÌïúÏúºÎ°ú ÏµúÏ¢ÖÏäπÏù∏ ÎåÄÍ∏∞ Ìï≠Î™©Îßå ÌëúÏãú",{beforeFilter:n.length,afterFilter:l.length})):a.includes("raw_material_manager")||a.includes("consumable_manager")?(l=n.filter(e=>{const t="approved"===e.middle_manager_status,a=i(e.final_manager_status);return t&&a}),t.debug("üîë material_manager Í∂åÌïúÏúºÎ°ú ÏµúÏ¢ÖÏäπÏù∏ ÎåÄÍ∏∞ Ìï≠Î™©Îßå ÌëúÏãú",{beforeFilter:n.length,afterFilter:l.length})):a.includes("lead buyer")?(l=n.filter(e=>{const t="approved"===e.final_manager_status,a=!e.is_payment_completed;return t&&a}),t.debug("üîë lead buyer Í∂åÌïúÏúºÎ°ú Íµ¨Îß§ ÎåÄÍ∏∞ Ìï≠Î™©Îßå ÌëúÏãú",{beforeFilter:n.length,afterFilter:l.length})):(l=[],t.debug("üîë ÏäπÏù∏ Í∂åÌïú ÏóÜÎäî Ïó≠Ìï†",{roles:a,result:"empty"}));const d=l.map(e=>{const t=e.vendors?.vendor_name||e.vendor_name||"ÏóÖÏ≤¥ Ï†ïÎ≥¥ ÏóÜÏùå",a=e.purchase_request_items||[],s=a.reduce((e,t)=>e+(Number(t?.amount_value)||(Number(t?.quantity)||0)*(Number(t?.unit_price_value)||0)),0);return{...e,vendor_name:t,purchase_request_items:a,total_amount:s}});return t.debug("‚úÖ ÏäπÏù∏ ÎåÄÍ∏∞ Ìï≠Î™© Ï°∞Ìöå ÏôÑÎ£å (ÏµúÏ†ÅÌôîÎê®)",{finalCount:d.length,performanceNote:"N+1 Î¨∏Ï†ú Ìï¥Í≤∞ - Îã®Ïùº JOIN ÏøºÎ¶¨ ÏÇ¨Ïö©"}),d}async getQuickActions(e){const t=this.parseRoles(e.purchase_role),a=[];if(t.includes("app_admin")||t.includes("middle_manager")||t.includes("final_approver")||t.includes("ceo")){const s=await this.getPendingCount(e,t);s>0&&a.push({id:"approve",type:"approve",label:"ÏäπÏù∏ ÎåÄÍ∏∞",description:`${s}Í±¥Ïùò ÏäπÏù∏ ÎåÄÍ∏∞ Ï§ë`,count:s,color:"red"})}if(t.includes("lead buyer")||t.includes("lead buyer")){const{count:e}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("final_manager_status","approved").eq("is_payment_completed",!1);e&&e>0&&a.push({id:"purchase",type:"purchase",label:"Íµ¨Îß§ Ï≤òÎ¶¨",description:`${e}Í±¥Ïùò Íµ¨Îß§ ÎåÄÍ∏∞ Ï§ë`,count:e,color:"yellow"})}return a}async getTodaySummary(e){const t=(new Date).toISOString().split("T")[0],a=new Date(Date.now()+864e5).toISOString().split("T")[0],[s,r,n]=await Promise.all([this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).gte("updated_at",t).lt("updated_at",a).or("middle_manager_status.eq.approved,final_manager_status.eq.approved"),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("requester_name",e.name).gte("created_at",t).lt("created_at",a),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("is_received",!0).gte("received_at",t).lt("received_at",a)]);return{approved:s.count||0,requested:r.count||0,received:n.count||0}}async getMyPurchaseStatus(e){const a=this.parseRoles(e.purchase_role),s=a.includes("lead buyer")||a.includes("app_admin"),r=e.name||e.email,n=new Date(Date.now()-6048e5).toISOString();let i=this.supabase.from("purchase_requests").select("*,vendors(vendor_name),purchase_request_items(*)").order("created_at",{ascending:!1}).limit(500);s||(i=i.eq("requester_name",r));const l=await i;if(l.error)return t.error("getMyPurchaseStatus ÏóêÎü¨",l.error),{waitingPurchase:[],waitingDelivery:[],recentCompleted:[]};const d=l.data||[];return{waitingPurchase:d.filter(e=>{const t="Íµ¨Îß§ ÏöîÏ≤≠"===(e.payment_category||"").trim(),a=!e.is_payment_completed;if(!t||!a)return!1;if((e.progress_type||"").includes("ÏÑ†ÏßÑÌñâ"))return!0;const s=(e.progress_type||"").includes("ÏùºÎ∞ò")||!e.progress_type||""===e.progress_type,r="approved"===e.final_manager_status;return s&&r}),waitingDelivery:d.filter(e=>{const t=!e.is_received,a=(e.progress_type||"").includes("ÏÑ†ÏßÑÌñâ");if(e.requester_name!==r)return!1;if(t&&a)return!0;const s="approved"===e.final_manager_status;return t&&s}),recentCompleted:d.filter(e=>{if(!0!==e.is_received)return!1;if(!e.received_at)return!1;if(e.requester_name!==r)return!1;return new Date(e.received_at)>=new Date(n)})}}async quickApprove(e,t){try{const s=this.parseRoles(t.purchase_role),{data:r}=await this.supabase.from("purchase_requests").select("middle_manager_status, final_manager_status").eq("id",e).single();if(!r)return{success:!1,error:"ÏöîÏ≤≠ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§."};let n={},i=null;const l=e=>"pending"===e||"ÎåÄÍ∏∞"===e||""===e||null==e;if(s.includes("app_admin")?l(r.middle_manager_status)?(n={middle_manager_status:"approved"},i="middle"):"approved"===r.middle_manager_status&&l(r.final_manager_status)&&(n={final_manager_status:"approved"},i="final"):s.includes("middle_manager")?l(r.middle_manager_status)&&(n={middle_manager_status:"approved"},i="middle"):s.includes("final_approver")||s.includes("ceo")?"approved"===r.middle_manager_status&&l(r.final_manager_status)&&(n={final_manager_status:"approved"},i="final"):(s.includes("raw_material_manager")||s.includes("consumable_manager"))&&"approved"===r.middle_manager_status&&l(r.final_manager_status)&&(n={final_manager_status:"approved"},i="final"),!i||0===Object.keys(n).length)return{success:!1,error:"ÏäπÏù∏Ìï† Ïàò ÏûàÎäî ÏÉÅÌÉúÍ∞Ä ÏïÑÎãôÎãàÎã§."};const{error:d}=await this.supabase.from("purchase_requests").update(n).eq("id",e);if(d)throw d;return a(e,e=>({...e,...n})),this.invalidateDashboardCache(),{success:!0,stage:i}}catch(s){return{success:!1,error:s.message}}}async getPendingCount(e,t){if(t.includes("app_admin")){const[e,t,a]=await Promise.all([this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).or("middle_manager_status.in.(pending,ÎåÄÍ∏∞),middle_manager_status.is.null"),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("middle_manager_status","approved").or("final_manager_status.in.(pending,ÎåÄÍ∏∞),final_manager_status.is.null"),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("final_manager_status","approved").eq("is_payment_completed",!1)]);return(e.count||0)+(t.count||0)+(a.count||0)}if(t.includes("middle_manager")){const{count:e,error:t}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).or("middle_manager_status.in.(pending,ÎåÄÍ∏∞),middle_manager_status.is.null");return t?0:e||0}if(t.includes("final_approver")||t.includes("ceo")){const{count:e,error:t}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("middle_manager_status","approved").or("final_manager_status.in.(pending,ÎåÄÍ∏∞),final_manager_status.is.null");return t?0:e||0}if(t.includes("lead buyer")){const{count:e,error:t}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("final_manager_status","approved").eq("is_payment_completed",!1);return t?0:e||0}return 0}async getUrgentCount(e,t){if(0===t.length)return 0;const a=new Date(Date.now()-2592e5).toISOString();let s=this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).lt("created_at",a);if(t.includes("app_admin"))s=s.or("middle_manager_status.eq.pending,final_manager_status.eq.pending,is_payment_completed.eq.false");else if(t.includes("middle_manager"))s=s.eq("middle_manager_status","pending");else if(t.includes("final_approver")||t.includes("ceo"))s=s.eq("middle_manager_status","approved").eq("final_manager_status","pending");else{if(!t.includes("lead buyer"))return 0;s=s.eq("final_manager_status","approved").eq("is_payment_completed",!1)}const{count:r}=await s;return r||0}async getTodayActionsCount(e,t){const a=new Date(Date.now()+864e5).toISOString().split("T")[0],{count:s}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).gte("updated_at",t).lt("updated_at",a).eq("requester_name",e.name);return s||0}async getTotalDeliveryWaitingCount(){const{count:e}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("is_received",!1).or("is_payment_completed.eq.true,progress_type.ilike.%ÏÑ†ÏßÑÌñâ%");return e||0}calculateProgress(e){let t=0;return"approved"===e.middle_manager_status&&(t+=25),"approved"===e.final_manager_status&&(t+=25),e.is_payment_completed&&(t+=25),e.is_received&&(t+=25),t}getCurrentStep(e){return e.is_received?"completed":e.is_payment_completed?"delivery":"approved"===e.final_manager_status?"purchase":"approval"}getNextAction(e){return"pending"===e.middle_manager_status?"Ï§ëÍ∞Ñ ÏäπÏù∏ ÎåÄÍ∏∞ Ï§ë":"pending"===e.final_manager_status?"ÏµúÏ¢Ö ÏäπÏù∏ ÎåÄÍ∏∞ Ï§ë":e.is_payment_completed?e.is_received?"ÏôÑÎ£å":"ÏûÖÍ≥† ÎåÄÍ∏∞ Ï§ë":"Íµ¨Îß§ Ï≤òÎ¶¨ ÎåÄÍ∏∞ Ï§ë"}estimateCompletion(e){const t=new Date(e.created_at),a=new Date;Math.floor((a.getTime()-t.getTime())/864e5);let s=7;"Í∏¥Í∏â"===e.progress_type&&(s=3);return new Date(t.getTime()+24*s*60*60*1e3).toLocaleDateString("ko-KR")}async getUndownloadedOrders(e){const a=this.parseRoles(e.purchase_role);if(!a.includes("lead buyer")&&!a.includes("app_admin"))return t.info("[DashboardService] ÎØ∏Îã§Ïö¥Î°úÎìú Î∞úÏ£ºÏÑú Ï°∞Ìöå Í∂åÌïú ÏóÜÏùå:",{roles:a}),[];if(this.hasValidPurchaseMemory(e)){return this.getPurchaseMemory().filter(e=>!0!==e.is_po_download).sort((e,t)=>this.toTime(t.created_at)-this.toTime(e.created_at)).slice(0,500).filter(e=>!0!==e.is_po_download&&("ÏÑ†ÏßÑÌñâ"===e.progress_type||"approved"===e.final_manager_status))}try{const{data:e,error:a}=await this.supabase.from("purchase_requests").select("\n          *,\n          purchase_request_items(\n            id,\n            item_name,\n            specification,\n            quantity,\n            unit_price_value,\n            amount_value\n          )\n        ").or("is_po_download.is.null,is_po_download.eq.false").order("created_at",{ascending:!1}).limit(500);if(a)throw t.error("[DashboardService] ÎØ∏Îã§Ïö¥Î°úÎìú Î∞úÏ£ºÏÑú Ï°∞Ìöå ÏøºÎ¶¨ ÏóêÎü¨:",a),a;return(e||[]).filter(e=>!0!==e.is_po_download&&("ÏÑ†ÏßÑÌñâ"===e.progress_type||"approved"===e.final_manager_status))}catch(s){throw t.error("[DashboardService] getUndownloadedOrders ÏóêÎü¨:",s),s}}};function $(){const[s,r]=n.useState(null),[O,$]=n.useState(!0),[E,H]=n.useState(null),[L,Q]=n.useState([]),[V,B]=n.useState([]),[K,Y]=n.useState(new Set),[J,W]=n.useState(new Set),[z,G]=n.useState([]),[X,Z]=n.useState(!1),[ee,te]=n.useState(null),ae=e(),[se,re]=n.useState(null),[ne,ie]=n.useState(!1),[le,de]=n.useState("pending"),[oe,ce]=n.useState(!1),[ue,me]=n.useState(null),[pe,he]=n.useState({undownloaded:"",pending:"",purchase:"",delivery:""}),ge=i(),{employee:_e,currentUserRoles:fe}=l(),ye=n.useCallback(async(e=!0,a=!1)=>{if(!_e)return t.error("[DashboardMain] No employee data available"),void(e&&$(!1));try{!e||a||s||$(!0);const l=await U.getDashboardData(_e,a),d=l.pendingApprovals.filter(e=>!J.has(String(e.id))),o=l.pendingApprovals.length-d.length,c=l.stats?{...l.stats,pending:Math.max(0,l.stats.pending-o)}:l.stats;if(o>0&&W(e=>{const t=new Set(e);return d.forEach(e=>t.delete(String(e.id))),t}),r({...l,pendingApprovals:d,stats:c}),Q(fe),fe.includes("lead buyer")||fe.includes("app_admin"))try{const e=await U.getUndownloadedOrders(_e);t.info("[DashboardMain] ÎØ∏Îã§Ïö¥Î°úÎìú Î∞úÏ£ºÏÑú Ï°∞Ìöå Í≤∞Í≥º:",{count:e.length,userRoles:fe,employeeName:_e.name,sampleItems:e.slice(0,3).map(e=>({purchase_order_number:e.purchase_order_number,requester_name:e.requester_name,vendor_name:e.vendor_name}))}),B(e)}catch(n){t.error("[DashboardMain] ÎØ∏Îã§Ïö¥Î°úÎìú Î∞úÏ£ºÏÑú Ï°∞Ìöå Ïã§Ìå®:",n),T.error("ÎØ∏Îã§Ïö¥Î°úÎìú Î∞úÏ£ºÏÑúÎ•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.")}if(fe.includes("app_admin"))try{Z(!0);const e=await A.getAllInquiries();if(e.success){const t=e.data.filter(e=>"open"===e.status||"in_progress"===e.status);G(t)}}catch(i){t.error("[DashboardMain] Î¨∏Ïùò Î™©Î°ù Ï°∞Ìöå Ïã§Ìå®:",i)}finally{Z(!1)}}catch(l){t.error("[DashboardMain] Failed to load dashboard data:",l),T.error("ÎåÄÏãúÎ≥¥Îìú Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§."),$(!1),r(null)}finally{e&&$(!1)}},[_e,fe,J]);n.useEffect(()=>{ye()},[ye]);const ve=n.useRef(!0);n.useEffect(()=>{const e=d(()=>{ve.current?ve.current=!1:ye(!1,!0)});return()=>e()},[ye]);const xe=async e=>{const t=String(e);if(!s?.employee)return void T.error("ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");if(!confirm("Ï†ïÎßêÎ°ú ÏäπÏù∏ÌïòÏãúÍ≤†ÏäµÎãàÍπå?"))return;H(t);const n=s;try{const e=await U.quickApprove(t,s.employee);e.success&&e.stage?(i=e.stage,r(e=>{if(!e)return e;if("middle"===i)return{...e,pendingApprovals:e.pendingApprovals.map(e=>String(e.id)===t?{...e,middle_manager_status:"approved"}:e)};W(e=>{const a=new Set(e);return a.add(t),a});const a=Math.max(0,(e.stats?.pending||0)-1);return{...e,pendingApprovals:e.pendingApprovals.filter(e=>String(e.id)!==t),stats:e.stats?{...e.stats,pending:a}:e.stats}}),a(t,t=>"middle"===e.stage?{...t,middle_manager_status:"approved"}:{...t,final_manager_status:"approved"}),T.success("ÏäπÏù∏Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§."),setTimeout(()=>ye(!1,!0),500)):(r(n),T.error(e.error||"ÏäπÏù∏ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."))}catch(l){r(n),T.error("ÏäπÏù∏ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.")}finally{H(null)}var i},be=(e,t="pending")=>{re(Number(e.id)),de(t),ie(!0)},we=n.useCallback((e,t)=>t.trim()?e.filter(e=>[e.purchase_order_number||"",e.vendor_name||"",(e.purchase_request_items||[]).map(e=>e.item_name||"").join(" ")].join(" ").toLowerCase().includes(t.toLowerCase())):e,[]),je=n.useMemo(()=>we(V,pe.undownloaded),[V,pe.undownloaded,we]),Ne=n.useMemo(()=>we(s?.pendingApprovals||[],pe.pending),[s?.pendingApprovals,pe.pending,we]);n.useMemo(()=>we(s?.myPurchaseStatus?.waitingPurchase||[],pe.purchase),[s?.myPurchaseStatus?.waitingPurchase,pe.purchase,we]);const qe=n.useMemo(()=>we(s?.myPurchaseStatus?.waitingDelivery||[],pe.delivery),[s?.myPurchaseStatus?.waitingDelivery,pe.delivery,we]);if(O)return o.jsx("div",{className:"flex items-center justify-center",style:{minHeight:"400px",backgroundColor:"#f9fafb"},children:o.jsxs("div",{className:"text-center",children:[o.jsx("div",{className:"w-12 h-12 border-3 border-hansl-500 border-t-transparent rounded-full animate-spin mx-auto"}),o.jsx("p",{className:"mt-4 card-subtitle",children:"ÎåÄÏãúÎ≥¥ÎìúÎ•º Î∂àÎü¨Ïò§Í≥† ÏûàÏäµÎãàÎã§..."}),o.jsxs("p",{className:"text-xs text-gray-400 mt-2",children:["Employee: ",_e?.name||"ÏóÜÏùå"]})]})});if(!s?.employee)return t.warn("[DashboardMain] Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå",{hasData:!!s,hasEmployee:!!_e,employeeName:_e?.name,loading:O}),o.jsx("div",{className:"flex items-center justify-center",style:{minHeight:"400px",backgroundColor:"#f9fafb"},children:o.jsxs("div",{className:"text-center bg-white p-8 rounded-lg border border-gray-200 shadow-sm",children:[o.jsx("h3",{className:"modal-subtitle mb-2",children:"ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§"}),o.jsx("p",{className:"card-subtitle mb-4",children:"Î°úÍ∑∏Ïù∏ÏùÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî."}),o.jsxs("div",{className:"text-xs text-gray-400 space-y-1",children:[o.jsxs("p",{children:["Employee: ",_e?.name||"ÏóÜÏùå"]}),o.jsxs("p",{children:["Loading: ",O?"true":"false"]}),o.jsxs("p",{children:["Has Data: ",s?"true":"false"]})]})]})});const Se=(Array.isArray(s.employee.purchase_role)?s.employee.purchase_role.map(e=>String(e).trim()):s.employee.purchase_role?String(s.employee.purchase_role).split(",").map(e=>e.trim()).filter(e=>e.length>0):[]).some(e=>["middle_manager","final_approver","app_admin","raw_material_manager","consumable_manager"].includes(e));return o.jsxs("div",{className:"min-h-screen bg-gray-50",children:[o.jsxs("div",{className:"w-full px-4 lg:px-6",children:[o.jsx("div",{className:"mb-3",children:o.jsxs("div",{children:[o.jsx("h1",{className:"page-title",children:"ÎåÄÏãúÎ≥¥Îìú"}),o.jsx("p",{className:"page-subtitle",style:{marginTop:"-2px",marginBottom:"-4px"},children:"Dashboard"})]})}),o.jsx("div",{className:"mb-2",children:o.jsxs("h2",{className:"section-title mb-2 flex items-center gap-1.5",children:[o.jsx(c,{className:"w-3.5 h-3.5 text-gray-600"}),"Ï†ÑÏ≤¥ ÌòÑÌô©",o.jsx("span",{className:"badge-stats border border-gray-300 bg-white text-gray-600 ml-2",children:(new Date).toLocaleDateString("ko-KR",{month:"long",day:"numeric",weekday:"short"})})]})}),o.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3",children:[Se&&o.jsxs(p,{className:"w-full col-span-1",children:[o.jsx(h,{className:"h-12 px-4 bg-gray-50 border-b flex items-center",children:o.jsxs(g,{className:"section-title flex items-center justify-between w-full",children:[o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx(R,{className:"w-3.5 h-3.5 text-orange-500"}),o.jsx("span",{children:"ÏäπÏù∏ ÎåÄÍ∏∞"})]}),s.pendingApprovals.length>0&&o.jsx("span",{className:"badge-stats bg-gray-200 text-gray-700",children:s.pendingApprovals.length})]})}),o.jsx(_,{className:"p-4",children:0===s.pendingApprovals.length?o.jsxs("div",{className:"text-center py-4 text-gray-400",children:[o.jsx(F,{className:"w-6 h-6 mx-auto mb-1"}),o.jsx("p",{className:"card-description",children:"ÎåÄÍ∏∞ Ìï≠Î™© ÏóÜÏùå"})]}):o.jsxs("div",{className:"space-y-3",children:[o.jsxs("div",{className:"relative",children:[o.jsx(f,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),o.jsx(v,{placeholder:"Î∞úÏ£ºÎ≤àÌò∏, ÏóÖÏ≤¥Î™Ö, ÌíàÎ™©ÏúºÎ°ú Í≤ÄÏÉâ...",value:pe.pending,onChange:e=>he(t=>({...t,pending:e.target.value})),className:"pl-10 h-8 text-xs"})]}),o.jsx("div",{className:"space-y-2 h-[36rem] overflow-y-auto",children:Ne.slice(0,10).map((e,t)=>{const a=e.purchase_request_items||[],s=a[0]||{};e.total_amount||a.reduce((e,t)=>e+(Number(t.amount_value)||0),0);const r="ÏÑ†ÏßÑÌñâ"===e.progress_type,n=(e=>{const t=(e||"").toLowerCase().replace(/\s+/g,""),a=t.includes("ÌòÑÏû•Í≤∞Ï†ú"),s=t.includes("Î∞úÏ£º"),r=t.includes("Íµ¨Îß§");return a?"bg-gray-500":s?"bg-green-500":r?"bg-blue-500":"bg-gray-300"})(e.payment_category);return o.jsxs("div",{className:"relative border rounded-lg p-2 hover:shadow-sm transition-all cursor-pointer mb-2 pl-3 "+(r?"bg-red-50 border-red-200":"hover:bg-orange-50/30"),onClick:t=>{t.target.closest("button")||be(e,"pending")},children:[o.jsx("div",{className:`absolute inset-y-1 left-1 w-1 rounded-full ${n}`}),o.jsxs("div",{className:"flex items-center justify-between gap-2",children:[o.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[o.jsx("span",{className:"card-title",children:e.purchase_order_number}),o.jsx("span",{className:"card-subtitle truncate",children:e.vendor_name||"ÏóÖÏ≤¥"}),o.jsxs("span",{className:"card-description truncate",children:[s.item_name||"ÌíàÎ™©"," ",a.length>1&&`Ïô∏ ${a.length-1}Í±¥`]})]}),o.jsx(u,{onClick:async t=>{t.stopPropagation(),await xe(e.id)},disabled:E===e.id,className:"button-base text-white "+("approved"===e.middle_manager_status?"bg-blue-600 hover:bg-blue-700":"bg-green-600 hover:bg-green-700"),children:E===e.id?o.jsx("div",{className:"w-3 h-3 border border-white border-t-transparent rounded-full animate-spin"}):o.jsxs(o.Fragment,{children:["approved"===e.middle_manager_status?"ÏµúÏ¢Ö":"1Ï∞®"," ÏäπÏù∏"]})})]})]},`approval-${e.id}`)})})]})})]}),L.includes("app_admin")&&o.jsxs(p,{className:"w-full col-span-1 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[o.jsx(h,{className:"h-12 px-4 bg-gray-50 border-b flex items-center",children:o.jsx(g,{className:"section-title flex items-center w-full",children:o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx(m,{className:"w-4 h-4 text-purple-600"}),o.jsx("span",{children:"ÎØ∏Ï≤òÎ¶¨ Î¨∏Ïùò"}),z.length>0&&o.jsx("span",{className:"badge-stats bg-red-100 text-red-700",children:z.length})]})})}),o.jsx(_,{className:"p-4",children:X?o.jsx("div",{className:"flex items-center justify-center py-8",children:o.jsx("div",{className:"w-6 h-6 border-2 border-gray-300 border-t-transparent rounded-full animate-spin"})}):0===z.length?o.jsxs("div",{className:"text-center py-12 text-gray-400",children:[o.jsx(F,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),o.jsx("p",{className:"card-subtitle",children:"ÎØ∏Ï≤òÎ¶¨ Î¨∏ÏùòÍ∞Ä ÏóÜÏäµÎãàÎã§"})]}):o.jsxs("div",{className:"space-y-2 max-h-[20rem] overflow-y-auto",children:[z.slice(0,10).map(e=>{const a=ee===e.id;return o.jsxs("div",{className:"border rounded-lg overflow-hidden hover:shadow-sm transition-all",children:[o.jsx("div",{className:"p-2 hover:bg-purple-50/30 cursor-pointer",onClick:()=>te(a?null:e.id),children:o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx("span",{className:"badge-stats "+("open"===e.status?"bg-yellow-100 text-yellow-800":"bg-blue-100 text-blue-800"),children:"open"===e.status?"ÎåÄÍ∏∞":"Ï≤òÎ¶¨Ï§ë"}),o.jsx("span",{className:"card-title truncate flex-1",children:e.subject}),o.jsx("span",{className:"card-description whitespace-nowrap",children:e.user_name}),o.jsx("span",{className:"card-date whitespace-nowrap",children:e.created_at&&I(new Date(e.created_at),"MM/dd HH:mm")})]})}),a&&o.jsxs("div",{className:"px-3 py-2 bg-gray-50 border-t text-xs space-y-2",children:[e.purchase_order_number&&o.jsxs("div",{children:[o.jsx("span",{className:"modal-label text-gray-500",children:"Î∞úÏ£ºÎ≤àÌò∏:"}),o.jsx("button",{className:"text-blue-600 underline ml-2 hover:text-blue-800",onClick:a=>{a.stopPropagation(),(async e=>{try{if(e.purchase_request_id)return re(e.purchase_request_id),void ie(!0);const t=e.purchase_order_number?.trim();if(!t)return void T.error("Î∞úÏ£ºÎÇ¥Ïó≠Ïù¥ ÏÇ≠Ï†ú ÎêòÏóàÍ±∞ÎÇò ÏóÜÏäµÎãàÎã§.");const{data:a,error:s}=await ae.from("purchase_requests").select("id").eq("purchase_order_number",t).limit(1).maybeSingle();if(s)throw s;if(!a?.id)return void T.error("Î∞úÏ£ºÎÇ¥Ïó≠Ïù¥ ÏÇ≠Ï†ú ÎêòÏóàÍ±∞ÎÇò ÏóÜÏäµÎãàÎã§.");re(a.id),ie(!0)}catch(a){t.error("[DashboardMain] Î∞úÏ£º ÏÉÅÏÑ∏ Ï°∞Ìöå Ïã§Ìå®:",a),T.error("Î∞úÏ£º ÏÉÅÏÑ∏Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.")}})(e)},title:"Î∞úÏ£º ÏÉÅÏÑ∏ Ïó¥Í∏∞",children:e.purchase_order_number})]}),o.jsxs("div",{children:[o.jsx("span",{className:"modal-label text-gray-500",children:"ÎÇ¥Ïö©:"}),o.jsx("p",{className:"text-gray-600 mt-1 whitespace-pre-wrap",children:e.message})]}),e.attachments&&e.attachments.length>0&&o.jsxs("div",{children:[o.jsx("span",{className:"modal-label text-gray-500",children:"Ï≤®Î∂Ä Ïù¥ÎØ∏ÏßÄ:"}),o.jsx("div",{className:"flex flex-wrap gap-2 mt-1",children:e.attachments.map((e,t)=>o.jsx("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",children:o.jsx("img",{src:e.url,alt:e.name,className:"w-16 h-16 object-cover rounded border border-gray-200 hover:border-blue-400"})},t))})]}),o.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[o.jsxs("button",{className:"button-action-danger",onClick:t=>{t.stopPropagation(),(async e=>{if(!confirm("Ï†ïÎßêÎ°ú Ïù¥ Î¨∏ÏùòÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏÇ≠Ï†úÎêú Î¨∏ÏùòÎäî Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§."))return;const t=await A.deleteInquiry(e);t.success?(T.success("Î¨∏ÏùòÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§."),G(t=>t.filter(t=>t.id!==e)),te(null)):T.error(t.error||"Î¨∏Ïùò ÏÇ≠Ï†ú Ïã§Ìå®")})(e.id)},children:[o.jsx(y,{className:"w-3 h-3 mr-1"}),"ÏÇ≠Ï†ú"]}),o.jsx("button",{className:"button-action-primary",onClick:async()=>{const t=prompt("Ï≤òÎ¶¨ ÏôÑÎ£å ÎãµÎ≥ÄÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî:");if(!t||""===t.trim())return void T.error("ÎãµÎ≥Ä ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ïïº ÏôÑÎ£å Ï≤òÎ¶¨Ìï† Ïàò ÏûàÏäµÎãàÎã§.");const a=await A.updateInquiryStatus(e.id,"resolved",t.trim());a.success?(T.success("Î¨∏ÏùòÍ∞Ä ÏôÑÎ£å Ï≤òÎ¶¨ÎêòÏóàÏäµÎãàÎã§."),G(t=>t.filter(t=>t.id!==e.id)),te(null)):T.error(a.error||"ÏôÑÎ£å Ï≤òÎ¶¨ Ïã§Ìå®")},children:"ÏôÑÎ£å Ï≤òÎ¶¨"})]})]})]},e.id)}),z.length>10&&o.jsx("div",{className:"text-center pt-2",children:o.jsxs("button",{className:"button-action-secondary",onClick:()=>ge("/support"),children:["Ï†ÑÏ≤¥ Î≥¥Í∏∞ (",z.length,"Í±¥)"]})})]})})]}),o.jsxs(p,{className:"w-full col-span-1 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[o.jsx(h,{className:"h-12 px-4 bg-gray-50 border-b flex items-center",children:o.jsxs(g,{className:"section-title flex items-center justify-between w-full",children:[o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx(x,{className:"w-4 h-4 text-blue-600"}),o.jsx("span",{children:"ÏûÖÍ≥† ÎåÄÍ∏∞"})]}),s.myPurchaseStatus.waitingDelivery.length>0&&o.jsx("span",{className:"badge-stats bg-gray-200 text-gray-700",children:s.myPurchaseStatus.waitingDelivery.length})]})}),o.jsx(_,{className:"p-4",children:0===s.myPurchaseStatus.waitingDelivery.length?o.jsxs("div",{className:"text-center py-12 text-gray-400",children:[o.jsx(x,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),o.jsx("p",{className:"card-subtitle",children:"ÏûÖÍ≥† ÎåÄÍ∏∞ Ìï≠Î™©Ïù¥ ÏóÜÏäµÎãàÎã§"})]}):o.jsxs("div",{className:"space-y-3",children:[o.jsxs("div",{className:"relative",children:[o.jsx(f,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),o.jsx(v,{placeholder:"Î∞úÏ£ºÎ≤àÌò∏, ÏóÖÏ≤¥Î™Ö, ÌíàÎ™©ÏúºÎ°ú Í≤ÄÏÉâ...",value:pe.delivery,onChange:e=>he(t=>({...t,delivery:e.target.value})),className:"pl-10 h-8 text-xs"})]}),o.jsx("div",{className:"space-y-2 h-[36rem] overflow-y-auto",children:qe.slice(0,10).map(e=>{const t=e.purchase_request_items||[],a=t[0],s=t.length;t.filter(e=>e.is_received).length,t.reduce((e,t)=>e+(Number(t.amount_value)||0),0);const r=(e.progress_type||"").includes("ÏÑ†ÏßÑÌñâ");return o.jsx("div",{className:"border rounded-lg p-2 transition-all cursor-pointer hover:shadow-sm mb-2 "+(r?"bg-red-50 hover:bg-red-100 border-red-200":"bg-white hover:bg-gray-50 border-gray-200"),onClick:t=>{t.target.closest("button")||be(e,"receipt")},children:o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx("span",{className:"card-title",children:e.purchase_order_number||`PO-${e.id.slice(0,8)}`}),o.jsx("span",{className:"card-subtitle truncate",children:e.vendor_name||"ÏóÖÏ≤¥Î™Ö ÏóÜÏùå"}),o.jsxs("span",{className:"card-description truncate",children:[a?.item_name||"ÌíàÎ™©",s>1&&o.jsxs("span",{className:"text-gray-400",children:[" Ïô∏ ",s-1,"Í±¥"]})]})]})},e.id)})})]})})]}),(L.includes("lead buyer")||L.includes("app_admin"))&&o.jsxs(p,{className:"w-full col-span-1 row-span-2 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[o.jsx(h,{className:"h-12 px-4 bg-gray-50 border-b flex items-center",children:o.jsxs(g,{className:"section-title flex items-center justify-between w-full",children:[o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx(k,{className:"w-4 h-4 text-orange-600"}),o.jsx("span",{children:"ÎØ∏Îã§Ïö¥Î°úÎìú Î∞úÏ£ºÏÑú"})]}),o.jsx("span",{className:"badge-stats bg-gray-200 text-gray-700",children:V.length})]})}),o.jsx(_,{className:"p-4",children:o.jsxs("div",{className:"space-y-3",children:[o.jsxs("div",{className:"relative",children:[o.jsx(f,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),o.jsx(v,{placeholder:"Î∞úÏ£ºÎ≤àÌò∏, ÏóÖÏ≤¥Î™Ö, ÌíàÎ™©ÏúºÎ°ú Í≤ÄÏÉâ...",value:pe.undownloaded,onChange:e=>he(t=>({...t,undownloaded:e.target.value})),className:"pl-10 h-8 text-xs"})]}),o.jsxs("div",{className:"space-y-2 h-[36rem] overflow-y-auto",children:[0===je.length?o.jsxs("div",{className:"text-center py-12 text-gray-400",children:[o.jsx(k,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),o.jsx("p",{className:"card-subtitle",children:"ÎØ∏Îã§Ïö¥Î°úÎìú Î∞úÏ£ºÏÑúÍ∞Ä ÏóÜÏäµÎãàÎã§"})]}):je.map((e,a)=>{const s=e.purchase_request_items||[],r=s[0]||{},n="ÏÑ†ÏßÑÌñâ"===e.progress_type;return o.jsx("div",{className:"border rounded-lg p-2 hover:shadow-sm transition-all cursor-pointer mb-2 "+(n?"bg-red-50 border-red-200":"hover:bg-orange-50/30"),onClick:t=>{t.target.closest("button")||be(e,"pending")},children:o.jsxs("div",{className:"flex items-center justify-between gap-2",children:[o.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[o.jsx("span",{className:"card-title",children:e.purchase_order_number||`PO-${e.id.slice(0,8)}`}),o.jsx("span",{className:"card-subtitle truncate",children:e.vendor_name||"ÏóÖÏ≤¥Î™Ö ÏóÜÏùå"}),o.jsxs("span",{className:"card-description truncate",children:[r.item_name||"ÌíàÎ™©",s.length>1&&o.jsxs("span",{className:"text-gray-400",children:[" Ïô∏ ",s.length-1,"Í±¥"]})]})]}),o.jsx(u,{className:"button-base bg-gray-500 hover:bg-gray-600 text-white",onClick:async a=>{a.stopPropagation(),await(async e=>{try{Y(t=>new Set(t).add(e.id)),await new Promise(e=>setTimeout(e,0)),await C({id:e.id,purchase_order_number:e.purchase_order_number,vendor_name:e.vendor_name,vendor_id:e.vendor_id,contact_id:e.contact_id},L,()=>{B(t=>t.filter(t=>t.id!==e.id))})}catch(a){t.error("Excel Îã§Ïö¥Î°úÎìú Ï§ë Ïò§Î•ò Î∞úÏÉù",a)}finally{Y(t=>{const a=new Set(t);return a.delete(e.id),a})}})(e)},disabled:K.has(e.id),children:K.has(e.id)?o.jsx("div",{className:"w-3 h-3 border border-white border-t-transparent rounded-full animate-spin"}):"Îã§Ïö¥Î°úÎìú"})]})},`undownloaded-${e.id}`)}),je.length>=100&&o.jsxs("div",{className:"text-center text-xs text-gray-500 mt-3 pb-2",children:["ÌëúÏãúÎêú Ìï≠Î™©: ",je.length,"Í∞ú",o.jsx("br",{}),"Îçî ÎßéÏùÄ Ìï≠Î™©Ïù¥ ÏûàÏùÑ Ïàò ÏûàÏäµÎãàÎã§. Í≤ÄÏÉâÏúºÎ°ú ÌïÑÌÑ∞ÎßÅÌïòÏÑ∏Ïöî."]}),je.length>0&&o.jsxs("div",{className:"text-center text-xs text-gray-400 mt-2 pb-2",children:["Ï¥ù ",je.length,"Í∞ú ÎØ∏Îã§Ïö¥Î°úÎìú Î∞úÏ£ºÏÑú"]})]})]})})]})]})]}),o.jsx(b,{purchaseId:se,isOpen:ne,onClose:()=>{ie(!1),re(null),de("pending")},currentUserRoles:L,activeTab:le,onRefresh:()=>{ye(!1),ie(!1),re(null),de("pending")},onOptimisticUpdate:(e,t)=>{a(e,t),ye(!1)},onDelete:e=>{me(e),ce(!0)}}),o.jsx(w,{open:oe,onOpenChange:e=>{ce(e),e||me(null)},children:o.jsxs(j,{children:[o.jsxs(N,{children:[o.jsx(q,{children:"Î∞úÏ£ºÏöîÏ≤≠ ÎÇ¥Ïó≠ ÏÇ≠Ï†ú"}),o.jsxs(S,{children:["Î∞úÏ£ºÏöîÏ≤≠Î≤àÌò∏ ",o.jsx("strong",{children:ue?.purchase_order_number||"Ïïå Ïàò ÏóÜÏùå"}),"Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?",o.jsx("br",{}),"Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§."]})]}),o.jsxs(D,{children:[o.jsx(P,{children:"Ï∑®ÏÜå"}),o.jsx(M,{onClick:async()=>{if(ue?.id)try{const e="string"==typeof ue.id?parseInt(ue.id,10):ue.id;if(!e||Number.isNaN(e))return void T.error("Î∞úÏ£º IDÍ∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.");const{error:t}=await ae.from("support_inquires").update({purchase_request_id:null}).eq("purchase_request_id",e);if(t)throw t;const{error:a}=await ae.from("purchase_request_items").delete().eq("purchase_request_id",e);if(a)throw a;const{error:s}=await ae.from("purchase_requests").delete().eq("id",e);if(s)throw s;T.success("Î∞úÏ£ºÏöîÏ≤≠Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§."),ce(!1),me(null),ie(!1),re(null),r(t=>{if(!t)return t;const a=String(e),s=(e=[])=>e.filter(e=>String(e.id)!==a),r=t.myPurchaseStatus?{...t.myPurchaseStatus,waitingDelivery:s(t.myPurchaseStatus.waitingDelivery),waitingPurchase:s(t.myPurchaseStatus.waitingPurchase),recentCompleted:s(t.myPurchaseStatus.recentCompleted)}:t.myPurchaseStatus;return{...t,pendingApprovals:s(t.pendingApprovals),myRecentRequests:s(t.myRecentRequests),myPurchaseStatus:r}}),B(t=>t.filter(t=>String(t.id)!==String(e))),U.invalidateCache(),ye(!1,!0)}catch(e){t.error("[DashboardMain] Î∞úÏ£º ÏÇ≠Ï†ú Ïã§Ìå®:",e),T.error("Î∞úÏ£º ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.")}else T.error("ÏÇ≠Ï†úÌï† Î∞úÏ£º Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.")},className:"bg-red-600 hover:bg-red-700",children:"ÏÇ≠Ï†ú"})]})]})})]})}export{$ as default};
//# sourceMappingURL=DashboardMain-D8PEgvXU.js.map
