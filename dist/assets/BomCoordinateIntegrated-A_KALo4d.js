import{e,r as t,j as a,z as r,c as s,B as n,b as i,P as o,w as l,X as c,_ as d}from"./index-BvgUOoDT.js";import{t as p}from"./index-CFnxfa1n.js";import{T as m,C as x,c as u}from"./card-Wm6gpivN.js";import{B as h}from"./badge-BpJaaGkj.js";import{D as g,a as f,b as y,c as b,P as N,L as w,I as j}from"./dialog-DdzUS4Ws.js";import{C as _,a as C,b as v,f as O,c as T,d as D,e as S}from"./command-BtXwBQ7z.js";import{P as E,a as M,b as k}from"./popover-Bde3Div9.js";import{P}from"./progress-N2FDc28L.js";import{T as R,a as I,b as B,c as F,d as U,e as A}from"./table-CmDPjweM.js";import{E as $}from"./exceljs.min-DMmTejNe.js";import{read as L,utils as q}from"./xlsx-ByDo_lG2.js";import{L as Q}from"./loader-circle-s52mQtgW.js";import{D as W}from"./download-BryjDUOb.js";import{E as z}from"./eye-CCwSQ4-s.js";import{C as V}from"./check-7yeTsVP_.js";import{R as X}from"./rotate-ccw-B8bGSoFO.js";import{S as Y}from"./save-BaaXvmMI.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=e("link-2",[["path",{d:"M9 17H7A5 5 0 0 1 7 7h2",key:"8i5ue5"}],["path",{d:"M15 7h2a5 5 0 1 1 0 10h-2",key:"1b9ql8"}],["line",{x1:"8",x2:"16",y1:"12",y2:"12",key:"1jonct"}]]),H=t.createContext(null),K=t.forwardRef(({className:e,defaultValue:s,value:n,onValueChange:i,...o},l)=>{const[c,d]=t.useState(s||""),p=void 0!==n?n:c,m=t.useCallback(e=>{i?i(e):d(e)},[i]);return a.jsx(H.Provider,{value:{value:p,onValueChange:m},children:a.jsx("div",{ref:l,className:r("",e),...o})})});K.displayName="Tabs";const J=t.forwardRef(({className:e,...t},s)=>a.jsx("div",{ref:s,className:r("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",e),...t}));J.displayName="TabsList";const Z=t.forwardRef(({className:e,value:s,onClick:n,...i},o)=>{const l=t.useContext(H);if(!l)throw new Error("TabsTrigger must be used within a Tabs component");const c=l.value===s;return a.jsx("button",{ref:o,type:"button",role:"tab","aria-selected":c,"data-state":c?"active":"inactive",className:r("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",e),onClick:e=>{l.onValueChange(s),n?.(e)},...i})});Z.displayName="TabsTrigger";const ee=t.forwardRef(({className:e,value:s,forceMount:n=!1,...i},o)=>{const l=t.useContext(H);if(!l)throw new Error("TabsContent must be used within a Tabs component");const c=l.value===s;return c||n?a.jsx("div",{ref:o,role:"tabpanel","aria-hidden":!c,hidden:!c,className:r("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",e),...i}):null});async function te(e,t,a,r){const s=new $.Workbook;try{const e=await fetch("/templates/BOM_Template.xlsx");if(!e.ok)throw new Error("템플릿 파일을 찾을 수 없습니다.");const t=await e.arrayBuffer();await s.xlsx.load(t)}catch(i){throw new Error("템플릿 파일 로드에 실패했습니다.")}s.creator="HANSL BOM System",s.modified=new Date,function(e,t,a){const r=e.worksheets[0];if(!r)throw new Error("BOM 시트를 찾을 수 없습니다.");const s=(a.boardName||"").trim().replace(/_\d{6}_정리본$/,"").replace(/_정리본$/,"").replace(/_\d{6}$/,""),n=e=>((e||"").replace(/[\*\?:\\\/\[\]]/g,"_").replace(/^'+|'+$/g,"").trim()||"BOM").substring(0,31);s&&(r.name=n(s));r.getCell("A2").value=a.artworkManager||"",r.getCell("C2").value=a.productionManager||"",r.getCell("H3").value=s,r.getCell("H5").value=`${s} 부품리스트`,r.mergeCells("A7:J7");const i=r.getCell("A7");i.value=`${s}  |  SET : ${a.productionQuantity}`,i.alignment={horizontal:"center",vertical:"middle"},i.font={bold:!0};const o=8,l={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}};let c="";t.forEach((e,s)=>{const n=o+s,i=r.getRow(n);i.getCell("A").value=s+1;const d=e.itemType||"";d!==c?(i.getCell("B").value=d,c=d):i.getCell("B").value="",i.getCell("C").value=e.itemName||"",i.getCell("D").value=e.setCount||0;const p=(e.itemName||"").toUpperCase(),m=(e.remark||"").toUpperCase().includes("미삽")||p.includes("_OPEN")||p.includes("OPEN_")||p.includes("_POGO")||p.includes("POGO_")||p.includes("_PAD")||p.includes("PAD_")||p.includes("_NC")||p.includes("NC_"),x=e.setCount||0;i.getCell("E").value=m?0:a.productionQuantity*x,i.getCell("G").value="□양호 □불량",i.getCell("H").value=e.refList||"",i.getCell("J").value=m?"미삽":e.remark||"";const u=[1,4,5,7,10],h={size:11,name:"굴림체",family:3,charset:129,color:m?{argb:"FFFF0000"}:{argb:"FF000000"}},g=d!==(s<t.length-1&&t[s+1].itemType||""),f=d!==(s>0&&t[s-1].itemType||"");for(let t=1;t<=10;t++){const e=i.getCell(t);let a=l;2===t&&(a={left:{style:"thin"},right:{style:"thin"},top:f?{style:"thin"}:void 0,bottom:g?{style:"thin"}:void 0}),e.style={font:h,border:a,alignment:{vertical:"middle",horizontal:u.includes(t)?"center":"left",wrapText:!0}}}const y=(e.refList||"").length;if(y>50){const e=Math.ceil(y/50);i.height=Math.max(15,15*e)}i.commit()})}(s,e,r),ae(s,"TOP",t),ae(s,"BOTTOM",a);const n=await s.xlsx.writeBuffer();return new Blob([n],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"})}function ae(e,t,a){if(0===a.length)return;const r=e.getWorksheet(t);if(!r)return;let s="";a.forEach((e,n)=>{const i=r.getRow(2+n),o=e.type||"";n<a.length-1&&a[n+1].type;const l=o!==s,c=n===a.length-1;l?(i.getCell("A").value=o,s=o):i.getCell("A").value="",i.getCell("B").value=e.partName||"",i.getCell("C").value=e.refDes||"",i.getCell("D").value=e.layer||t,i.getCell("E").value=e.locationX||0,i.getCell("F").value=e.locationY||0,i.getCell("G").value=e.rotation||0,i.getCell("H").value=e.remark||"";const d=(e.partName||"").toUpperCase(),p=(e.remark||"").toUpperCase().includes("미삽")||d.includes("_OPEN")||d.includes("OPEN_")||d.includes("_POGO")||d.includes("POGO_")||d.includes("_PAD")||d.includes("PAD_")||d.includes("_NC")||d.includes("NC_");for(let t=1;t<=8;t++){i.getCell(t).style={font:{size:10,name:"굴림체",color:p?{argb:"FFFF0000"}:{argb:"FF000000"}},alignment:{vertical:"middle",horizontal:t<=2?"left":"center"},border:{top:l?{style:"thick"}:void 0,bottom:c?{style:"thick"}:void 0,left:void 0,right:void 0}}}i.commit()})}async function re(e,t){if("showSaveFilePicker"in window)try{const a=await window.showSaveFilePicker({suggestedName:t,types:[{description:"Excel 파일",accept:{"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":[".xlsx"]}}]}),r=await a.createWritable();return await r.write(e),void(await r.close())}catch(s){if("AbortError"===s.name)return}const a=URL.createObjectURL(e),r=document.createElement("a");r.href=a,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a)}ee.displayName="TabsContent";let se=null;const ne=["1u/1005|C1UF_1005","10u/1005|C10UF_1005","1u/1608|C1UF_1608","0.01u/1005|C0.01UF_1005","0.1u/1005|C0.1UF_1005","10uf/1608|C10UF_1608","10pf/1005|C10PF_1005","10nf/1005|C10NF_1005","220pf/1005|C220PF_1005","47u/2012|C47UF_16V_2012","2.2u/1005|C2.2UF_16V_1005","0.001u/1005|C0.001UF_1005","4.7u/1005|C4.7UF_1005","|R1K_1005_0.1%"],ie={"FI-RE41S-HF":"FI-RE41S-HF-R1500","FI-RE51S-HF":"FI-RE51S-HF-R1500","24LC256ISN":"24LC256-I/SN",TLP3107:"TLP3107","AD5175BRMZ-10-RL7":"AD5175BRMZ-10-RL7","AD5175BCPZ-10-RL7":"AD5175BCPZ-10-RL7",ADS7828E_250:"ADS7828E/250",TPD2EUSB30DRTR_OPEN:"TPD2EUSB30DRTR_OPEN",TPD2EUSB30DRTR:"TPD2EUSB30DRTR",C10PF_50V_1005_OPEN:"C10pF/50V_1005_OPEN",C10PF_1005_OPEN:"C10PF/10V_1005_OPEN",R0_1005_OPEN:"R0_1005_OPEN","C0.1UF_16V_1005_OPEN":"C0.1uF/16V_1005_OPEN",W25Q16JVSSIQ_OPEN:"W25Q16JVSSIQ_OPEN",R1K_1005_OPEN_1903:"R1K_1005_OPEN",R10K_1005_OPEN_1903:"R10K_1005_OPEN",R10K_1005_OPEN:"R10K_1005_OPEN","R4.7K_1005":"R4.7K_1005_1%",R10_1005:"R10_1005_1%",R15_1005:"R15_1005_1%","MAX3373EEKA+T_NEW":"MAX3373EEKA+T","C0.1UF_16V_1005":"C0.1uF/16V_1005","T47UF_16V-B":'T47uF/16V "B"',"SN65DP141RLJR_R-PWQFN-N38_RLJ":"SN65DP141RLJR","TSM6963SD_TSSOP-8":"TSM6963SD","SW-DJMM-12V":"SW-DJMM-12V","BOI_C70_CUBE_Z-CAL_POGO":"BOI_C70_CUBE_Z-CAL_POGO",MGL_G1_AA_MASTER_SENSOR_POGO:"B2B","TPD2EUSB30DRTR/OPEN|TPD2EUSB30DRTR":"TPD2EUSB30DRTR_OPEN"};async function oe(){if(se)return se;try{const[t,a,r,n,i]=await Promise.all([fetch("/data/종류_매핑.json"),fetch("/data/품명_매핑.json"),fetch("/data/품명_충돌목록.json"),fetch("/data/종류_정렬순서.json"),fetch("/data/미삽항목.json")]);if(!t.ok)throw new Error(`종류_매핑.json 로드 실패: ${t.status}`);if(!a.ok)throw new Error(`품명_매핑.json 로드 실패: ${a.status}`);if(!r.ok)throw new Error(`품명_충돌목록.json 로드 실패: ${r.status}`);if(!n.ok)throw new Error(`종류_정렬순서.json 로드 실패: ${n.status}`);if(!i.ok)throw new Error(`미삽항목.json 로드 실패: ${i.status}`);const o=await t.json(),l=await a.json(),c=await r.json(),d=await n.json(),p=await i.json(),m={...l,...ie},x={...o};try{const e=s(),{data:t,error:a}=await e.from("ai_learning_records").select("processed_bom_data").not("processed_bom_data","is",null).order("created_at",{ascending:!1});if(a);else if(t&&t.length>0){let e=0,a=0;for(const r of t){const t=r.processed_bom_data;if(Array.isArray(t))for(const r of t){if(!r.originalPart&&!r.originalFootprint)continue;const t=(r.originalPart||"").trim(),s=(r.originalFootprint||"").trim().toUpperCase(),n=(r.itemName||"").trim(),i=(r.itemType||"").trim();if(s&&n&&"데이터 없음 (수동 확인 필요)"!==n){const a=n!==s&&n.toUpperCase()!==s;if(t){const r=`${t}|${s}`;!a&&m[r]||(m[r]=n,e++)}!a&&m[s]||(m[s]=n,e++)}n&&i&&"데이터 없음"!==i&&(x[n]&&x[n]===i||(x[n]=i,a++))}}}}catch(e){}return se={typeMapping:x,partNameMapping:m,partNameConflicts:c,typeSortOrder:d,misapKeywords:p,manualInputRequired:ne},se}catch(t){throw t}}const le={normalizePartName:e=>e?e.toLowerCase().replace(/[/\s_-]/g,"").replace(/"/g,"").trim():"",normalizePartFootprintCombo(e,t){let a=(e||"").toLowerCase().replace(/uf/g,"u").replace(/pf/g,"p").replace(/nf/g,"n").replace(/\s/g,"");/^c\d/.test(a)&&(a=a.substring(1));return`${a}|${(t||"").toUpperCase()}`},isManualInputRequired(e,t,a){const r=(t||"").toUpperCase();return a.manualInputRequired.some(a=>{const[s,n]=a.split("|");if(n&&r===n.toUpperCase())return!0;return this.normalizePartFootprintCombo(e,t)===this.normalizePartFootprintCombo(s,n)})},isMisap(e,t,a){const r=(e||"").toUpperCase(),s=(t||"").toUpperCase();return a.misapKeywords.some(e=>r.includes(e)||s.includes(e))},parseRefs(e){if(!e)return[];const t=[],a=e.split(/[,.\s]+/).map(e=>e.trim()).filter(e=>e.length>0);for(const r of a){if(/^[-_=]+$/.test(r))continue;const e=r.match(/^([A-Z]+)(\d+)[-~]([A-Z]*)(\d+)$/i);if(e){const a=e[1],r=parseInt(e[2]),s=parseInt(e[4]);for(let e=r;e<=s;e++)t.push(a+e)}else t.push(r)}return t},isTP:e=>/^TP/i.test(e),normalizeType(e){if(!e)return"";const t=e.trim();return{"TP/DIP":"TEST POINT/DIP","TP/SMD":"TEST POINT/SMD",SENSOR:"SENSOR(SMD)","PEM NUT":"PEMNUT","BEAD(012)":"BEAD(2012)","TEST POINT":"TEST POINT/SMD",CONNECTGOR:"CONNECTOR",CONNECTO4R:"CONNECTOR",CONNECTROR:"CONNECTOR","DIOODE(SMD)":"DIODE(SMD)","X-TAL":"X-TAL(SMD)"}[t]||t}};function ce(e,t,a){const r=t.toUpperCase(),s=`${e}|${t}`;return a.partNameMapping[s]?{partName:a.partNameMapping[s],isNew:!1}:a.partNameMapping[r]?{partName:a.partNameMapping[r],isNew:!1}:a.partNameMapping[t]?{partName:a.partNameMapping[t],isNew:!1}:a.partNameMapping[e]?{partName:a.partNameMapping[e],isNew:!1}:{partName:t||e,isNew:!0}}function de(e,t){if(t.typeMapping[e])return t.typeMapping[e];const a=le.normalizePartName(e);for(const[r,s]of Object.entries(t.typeMapping))if(le.normalizePartName(r)===a)return s;return""}function pe(e,t,a){const r=t.toUpperCase(),s=`${e}|${t}`;if(a.partNameMapping[s]){const e=de(a.partNameMapping[s],a);if(e)return e}const n=[r,t];for(const i of n)if(a.partNameMapping[i]){const e=de(a.partNameMapping[i],a);if(e)return e}if(a.partNameMapping[e]){const t=de(a.partNameMapping[e],a);if(t)return t}for(const[i,o]of Object.entries(a.partNameMapping))if(i.toUpperCase().includes(r)||r.includes(i.toUpperCase())){const e=de(o,a);if(e)return e}return""}async function me(e,t,a){const r=await oe(),s=await async function(e){const t=await e.arrayBuffer(),a=new Uint8Array(t),r=L(a,{type:"array"}),s=r.Sheets[r.SheetNames[0]],n=q.sheet_to_json(s,{header:1}),i=[];let o=-1;const l={item:0,ref:1,qty:2,part:3,footprint:-1},c=["reference","references","ref","designator"],d=["part","part number"],p=["pcb footprint","footprint","partnumber"];for(let h=0;h<Math.min(30,n.length);h++){const e=n[h];if(!e)continue;const t=e.map(e=>String(e||"").toLowerCase()).join(" ");if(c.some(e=>t.includes(e))){o=h,e.forEach((e,t)=>{const a=String(e||"").toLowerCase().trim();"item"!==a&&"no"!==a||(l.item=t),c.some(e=>a===e)&&(l.ref=t),"quantity"!==a&&"qty"!==a||(l.qty=t),d.some(e=>a===e)&&(l.part=t),p.some(e=>a===e)&&(l.footprint=t)});break}}let m=-1!==o;-1===o&&(o=0,m=!1);const x=e=>{if(!e||"string"!=typeof e)return!1;const t=e.trim();return!!t&&(/^[A-Z]{1,3}\d+$/i.test(t)||/^[A-Z]{1,3}\d+([,.\s]+[A-Z]{1,3}\d+)*$/i.test(t)||/^[A-Z]{1,3}\d+[-~][A-Z]*\d+$/i.test(t))};if(!m||1===l.ref){const e=n.slice(o+1,Math.min(o+20,n.length)),t=[],a=Math.max(...e.map(e=>e?e.length:0));for(let s=0;s<a;s++){let a=0,r=0;for(const t of e){if(!t||s>=t.length)continue;const e=String(t[s]||"").trim();e&&(r++,x(e)&&a++)}const n=r>=3?a/r:0;t.push(n)}const r=Math.max(...t);if(r>=.6){const e=t.indexOf(r);l.ref=e}}let u=null;for(let h=o+1;h<n.length;h++){const e=n[h];if(!e||0===e.length)continue;const t=String(e[l.item]||"").trim(),a=String(e[l.ref]||"").trim(),r=String(e[l.qty]||"").trim(),s=String(e[l.part]||"").trim(),o=l.footprint>=0?String(e[l.footprint]||"").trim():"";if(!a.startsWith("_"))if(t&&/^\d+$/.test(t)){u&&u.refs.length>0&&i.push(u);const e=le.parseRefs(a).filter(e=>!le.isTP(e));u={quantity:parseInt(r)||e.length,refs:e,part:s,footprint:o||s}}else if(u&&a){const e=le.parseRefs(a).filter(e=>!le.isTP(e));u.refs.push(...e)}}return u&&u.refs.length>0&&i.push(u),i}(e),n=await async function(e){const t=await e.arrayBuffer(),a=[];if(e.name.endsWith(".txt")){const e=new TextDecoder("utf-8").decode(t).split("\n");let r=!1;const s={ref:0,x:1,y:2,rotation:3,layer:4};for(const t of e){const e=t.trim();if(!e)continue;if(!r){const t=e.toLowerCase();if(t.includes("refdes")||t.includes("ref")||t.includes("designator")){r=!0,e.split(/\t|\s{2,}/).map(e=>e.trim().replace(/"/g,"")).forEach((e,t)=>{const a=e.toLowerCase();(a.includes("ref")||a.includes("designator"))&&(s.ref=t),(a.includes("locationx")||"x"===a||"x"===a&&1===t)&&(s.x=t),(a.includes("locationy")||"y"===a||"y"===a&&2===t)&&(s.y=t),(a.includes("rotation")||a.includes("angle")||a.includes("rot"))&&(s.rotation=t),(a.includes("layer")||a.includes("side"))&&(s.layer=t)});continue}continue}const n=e.split(/\t|\s{2,}/).map(e=>e.trim().replace(/"/g,""));if(n.length<3)continue;const i=(n[s.ref]||"").trim().toUpperCase().replace(/"/g,"");if(!i||le.isTP(i)||/^\d+$/.test(i))continue;const o=parseFloat(n[s.x]||"0"),l=parseFloat(n[s.y]||"0"),c=parseFloat(n[s.rotation]||"0"),d=(n[s.layer]||"").toUpperCase().replace(/"/g,"").includes("BOT")?"BOTTOM":"TOP";a.push({ref:i,x:o,y:l,rotation:c,layer:d})}a.length}else{const e=new Uint8Array(t),r=L(e,{type:"array"}),s=r.Sheets[r.SheetNames[0]],n=q.sheet_to_json(s,{header:1});let i=-1;const o={ref:0,x:3,y:4,rotation:5,layer:2};for(let t=0;t<Math.min(10,n.length);t++){const e=n[t];if(!e)continue;const a=e.map(e=>String(e||"").toLowerCase()).join(" ");if(a.includes("ref")||a.includes("designator")){i=t,e.forEach((e,t)=>{const a=String(e||"").toLowerCase().trim();(a.includes("ref")||a.includes("designator"))&&(o.ref=t),(a.includes("locationx")||"x"===a)&&(o.x=t),(a.includes("locationy")||"y"===a)&&(o.y=t),(a.includes("rotation")||a.includes("angle"))&&(o.rotation=t),(a.includes("layer")||a.includes("side"))&&(o.layer=t)});break}}for(let t=i+1;t<n.length;t++){const e=n[t];if(!e)continue;const r=String(e[o.ref]||"").trim().toUpperCase();!r||le.isTP(r)||/^\d+$/.test(r)||a.push({ref:r,x:parseFloat(String(e[o.x]))||0,y:parseFloat(String(e[o.y]))||0,rotation:parseFloat(String(e[o.rotation]))||0,layer:String(e[o.layer]||"").toUpperCase().includes("BOT")?"BOTTOM":"TOP"})}}return a}(t);s.forEach(e=>{e.refs=e.refs.map(e=>e.toUpperCase())});const i=n.map(e=>({...e,ref:e.ref.toUpperCase()})),o=new Map;for(const b of i)o.set(b.ref,b);const l=[],c=[],d=[];let p=0,m=0,x=0,u=1;for(const b of s){const e=le.isManualInputRequired(b.part,b.footprint,r);let t,s=!1;if(e)t="데이터 없음 (수동 확인 필요)",p++;else{const e=ce(b.part,b.footprint,r);t=e.partName,s=e.isNew,s&&m++}const n=de(t,r);n||e||s||(s=!0,m++);const i=le.isMisap(b.footprint,b.part,r);i&&x++;const h=(e,t,a)=>{const r=t.toUpperCase(),s=e.toUpperCase(),n=(a[0]||"").toUpperCase().replace(/\d+/g,"");let i="1005";return r.includes("0603")||s.includes("0603")?i="0603":r.includes("1005")||s.includes("1005")?i="1005":r.includes("1608")||s.includes("1608")?i="1608":r.includes("2012")||s.includes("2012")?i="2012":(r.includes("3225")||s.includes("3225"))&&(i="3225"),/^C\d/.test(s)||/^C[_-]/.test(s)||s.includes("UF")||s.includes("PF")||s.includes("NF")?`C/C(${i})`:/^R\d/.test(s)||/^R[_-]/.test(s)||s.includes("OHM")||/R\d+K/.test(s)?`저항(${i})`:s.includes("IC")||s.includes("MAX")||s.includes("LM")||s.includes("TPS")||s.includes("STM")||s.includes("AD5")||s.includes("ADS")||s.includes("PCA")||s.includes("TCA")||s.includes("SN6")||s.includes("SN7")?"IC(SMD)":s.includes("DMN")||s.includes("MOSFET")||s.includes("2N")||/^Q\d/.test(n)?"TR(SMD)":s.includes("DIODE")||s.includes("1N")||s.includes("BAT")||s.includes("D5V")||s.includes("D10V")||s.includes("TPD")?"DIODE(SMD)":s.includes("BEAD")||s.includes("BLM")||s.includes("FB")?"BEAD(2012)":s.includes("CONN")||s.includes("B2B")||s.includes("HEADER")||s.includes("POGO")||s.includes("PIN")||r.includes("CONN")||/^\d{5}/.test(s)?"CONNECTOR":s.includes("LED")?"LED(1608)":s.includes("OSC")||s.includes("XTAL")||s.includes("CRYSTAL")?"OSC(SMD)":s.includes("SW")||s.includes("SWITCH")?"S/W(DIP)":s.includes("TANT")||s.includes("T/T")?"T/T":"C"===n?`C/C(${i})`:"R"===n?`저항(${i})`:"U"===n?"IC(SMD)":"Q"===n?"TR(SMD)":"D"===n?"DIODE(SMD)":"L"===n||"FB"===n||"BD"===n?"BEAD(2012)":"LED"===n?"LED(1608)":"J"===n||"CN"===n||"CON"===n?"CONNECTOR":"SW"===n?"S/W(DIP)":"Y"===n||"X"===n?"OSC(SMD)":"데이터 없음"};let g;if(e||s||!n){const e=pe(b.part,b.footprint,r);g=e?le.normalizeType(e):h(b.part,b.footprint,b.refs)}else g=le.normalizeType(n);const f={lineNumber:u,itemType:g,itemName:t,setCount:b.refs.length,totalQuantity:b.refs.length*a,checkStatus:"□양호",refList:b.refs.join(", "),remark:i?"미삽":"",isManualRequired:e,isNewPart:s,originalPart:b.part,originalFootprint:b.footprint};l.push(f),u++;for(const a of b.refs){const e=a.toUpperCase(),t=o.get(e);if(!t)continue;const r={type:f.itemType,partName:f.itemName,refDes:a,layer:t.layer,locationX:t.x,locationY:t.y,rotation:t.rotation,remark:i?"미삽":void 0};"TOP"===t.layer?c.push(r):d.push(r),o.delete(e)}}o.forEach(e=>{const t={type:"좌표만 존재",partName:"BOM 없음",refDes:e.ref,layer:e.layer,locationX:e.x,locationY:e.y,rotation:e.rotation,remark:"BOM 미존재"};"TOP"===e.layer?c.push(t):d.push(t)});const h=["IC","SENSOR","TR","DIODE","T/T","C/C","저항","BEAD","OSC","LED","S/W","CONNECTOR","PEMNUT"],g=e=>{if(e.itemType&&"데이터 없음"!==e.itemType)return(t=e.itemType)&&"데이터 없음"!==t?t.startsWith("IC")?"IC":t.startsWith("SENSOR")?"SENSOR":t.startsWith("TR")?"TR":t.startsWith("DIODE")?"DIODE":t.startsWith("T/T")?"T/T":t.startsWith("C/C")?"C/C":t.startsWith("저항")?"저항":t.startsWith("BEAD")?"BEAD":t.startsWith("OSC")?"OSC":t.startsWith("LED")?"LED":t.startsWith("S/W")?"S/W":"CONNECTOR"===t?"CONNECTOR":"PEMNUT"===t?"PEMNUT":t:"";var t;const a=(e.refList||"").split(",")[0].trim().toUpperCase().replace(/\d+/g,"");if("C"===a)return"C/C";if("R"===a)return"저항";if("U"===a)return"IC";if("Q"===a)return"TR";if("D"===a)return"DIODE";if("L"===a||"FB"===a||"BD"===a)return"BEAD";if("LED"===a)return"LED";if("J"===a||"CN"===a||"CON"===a)return"CONNECTOR";if("SW"===a)return"S/W";if("Y"===a||"X"===a)return"OSC";const r=(e.originalPart||e.itemName||"").toUpperCase();return(e.originalFootprint||"").toUpperCase(),/^C\d/.test(r)||/^C[_-]/.test(r)||r.startsWith("CC")||r.includes("PF")||r.includes("UF")||r.includes("NF")?"C/C":/^R\d/.test(r)||/^R[_-]/.test(r)||r.includes("OHM")||/^\d+[KMR]$/.test(r)?"저항":/^U\d/.test(r)||r.includes("IC")||r.includes("MAX")||r.includes("LM")||r.includes("TPS")||r.includes("STM")||r.includes("MC")?"IC":/^Q\d/.test(r)||r.includes("TR")||r.includes("MOSFET")||r.includes("2N")?"TR":/^D\d/.test(r)||r.includes("DIODE")||r.includes("1N")||r.includes("BAT")?"DIODE":r.includes("LED")?"LED":r.includes("SENSOR")?"SENSOR":r.includes("BEAD")||r.includes("FB")?"BEAD":r.includes("CONN")||r.includes("B2B")||r.includes("HEADER")||r.includes("USB")||r.includes("PIN")||/^J\d/.test(r)?"CONNECTOR":r.includes("SW")||r.includes("SWITCH")||r.includes("BTN")?"S/W":r.includes("OSC")||r.includes("XTAL")||r.includes("CRYSTAL")?"OSC":r.includes("T/T")||r.includes("TANT")?"T/T":"CONNECTOR"},f=(e,t)=>{const a=(e||"").toUpperCase();return(t||"").toUpperCase().includes("미삽")||a.includes("_OPEN")||a.includes("OPEN_")||a.includes("_POGO")||a.includes("POGO_")||a.includes("_PAD")||a.includes("PAD_")||a.includes("_NC")||a.includes("NC_")};l.sort((e,t)=>{const a=g(e),r=g(t),s=h.indexOf(a),n=h.indexOf(r),i=-1===s?999:s,o=-1===n?999:n;if(i!==o)return i-o;if(e.itemType!==t.itemType)return(e.itemType||"").localeCompare(t.itemType||"");const l=f(e.itemName,e.remark);return l!==f(t.itemName,t.remark)?l?1:-1:(e.itemName||"").localeCompare(t.itemName||"")}),l.forEach((e,t)=>{e.lineNumber=t+1});const y=e=>e.sort((e,t)=>{const a=e=>{const t=(e||"").toUpperCase();return t.includes("IC")?"IC":t.includes("DIODE")?"DIODE":t.includes("C/C")||t.includes("C_C")?"C/C":t.includes("저항")?"저항":t.includes("BEAD")?"BEAD":t.includes("S/W")||t.includes("SW")?"S/W":t.includes("CONNECTOR")||t.includes("CONN")?"CONNECTOR":"ETC"},r=a(e.type||""),s=a(t.type||""),n=h.indexOf(r),i=h.indexOf(s),o=-1===n?999:n,l=-1===i?999:i;if(o!==l)return o-l;if(e.type!==t.type)return(e.type||"").localeCompare(t.type||"");const c=f(e.partName??"",e.remark??"");return c!==f(t.partName??"",t.remark??"")?c?1:-1:(e.partName||"").localeCompare(t.partName||"")});y(c),y(d);l.filter(e=>f(e.itemName,e.remark));return{bomItems:l,topCoordinates:c,bottomCoordinates:d,summary:{totalItems:l.length,manualRequiredCount:p,newPartCount:m,misapCount:x}}}const xe=["IC","DIODE","C/C","저항","BEAD","S/W","CONNECTOR"];function ue(e,t){const a=(t||"").toUpperCase(),r=(e||"").toUpperCase();return a.includes("미삽")||r.includes("_OPEN")||r.includes("OPEN_")||r.includes("_POGO")||r.includes("POGO_")||r.includes("_PAD")||r.includes("PAD_")||r.includes("_NC")||r.includes("NC_")}function he(e){const t=e=>{const t=(e.itemType||"").toUpperCase();return t.includes("IC")?"IC":t.includes("DIODE")?"DIODE":t.includes("C/C")||t.includes("C_C")?"C/C":t.includes("저항")?"저항":t.includes("BEAD")?"BEAD":t.includes("S/W")||t.includes("SW")?"S/W":t.includes("CONNECTOR")||t.includes("CONN")?"CONNECTOR":"ETC"};return[...e].sort((e,a)=>{const r=t(e),s=t(a),n=xe.indexOf(r),i=xe.indexOf(s),o=-1===n?999:n,l=-1===i?999:i;if(o!==l)return o-l;if(e.itemType!==a.itemType)return(e.itemType||"").localeCompare(a.itemType||"");const c=ue(e.itemName,e.remark);return c!==ue(a.itemName,a.remark)?c?1:-1:(e.itemName||"").localeCompare(a.itemName||"")})}function ge(e){const t=e=>{const t=(e||"").toUpperCase();return t.includes("IC")?"IC":t.includes("DIODE")?"DIODE":t.includes("C/C")||t.includes("C_C")?"C/C":t.includes("저항")?"저항":t.includes("BEAD")?"BEAD":t.includes("S/W")||t.includes("SW")?"S/W":t.includes("CONNECTOR")||t.includes("CONN")?"CONNECTOR":"ETC"};return[...e].sort((e,a)=>{const r=t(e.type||""),s=t(a.type||""),n=xe.indexOf(r),i=xe.indexOf(s),o=-1===n?999:n,l=-1===i?999:i;if(o!==l)return o-l;if(e.type!==a.type)return(e.type||"").localeCompare(a.type||"");const c=ue(e.partName,e.remark);return c!==ue(a.partName,a.remark)?c?1:-1:(e.partName||"").localeCompare(a.partName||"")})}const fe=Object.freeze(Object.defineProperty({__proto__:null,loadLearningData:oe,processBOMAndCoordinates:me,resetLearningDataCache:function(){se=null},sortBOMItems:he,sortCoordinateItems:ge},Symbol.toStringTag,{value:"Module"})),ye=t.forwardRef(({bomItems:e,coordinates:r,boardName:s,productionQuantity:i,artworkManager:o="",productionManager:l="",onSave:c,onMergeStateChange:d,onBomChange:x,onDeleteRefs:u},h)=>{const[g,f]=t.useState(e),[y,b]=t.useState(null),N=t.useRef({});t.useEffect(()=>{f(e),b(null),d?.(!1)},[e]),t.useLayoutEffect(()=>{Object.values(N.current).forEach(e=>{if(e){e.style.height="auto";const t=Math.max(24,e.scrollHeight);e.style.height=t+"px"}})},[g]),g.filter(e=>e.isManualRequired).length,g.filter(e=>e.isNewPart).length,g.filter(e=>"미삽"===e.remark).length;const w=g.reduce((e,t)=>e+(t.setCount||0),0),j=t.useMemo(()=>{const e=new Set;return r.forEach(t=>{t.refDes&&e.add(t.refDes.trim().toUpperCase())}),e},[r]),_=e=>{if(!e.refList)return!1;return e.refList.split(",").map(e=>e.trim().toUpperCase()).filter(Boolean).some(e=>!j.has(e))},C=(e,t=10)=>{const a=document.createElement("canvas").getContext("2d");return a?(a.font=`${t}px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif`,Math.ceil(a.measureText(e).width)):10*e.length},v=Math.max(...g.map(e=>C(e.itemType||"",10)),C("종류",10),50)+20,O=Math.max(...g.map(e=>C(e.itemName||"",10)),C("품명",10),100)+20,T=g.flatMap(e=>(e.refList||"").split(",").map(e=>e.trim()).filter(e=>e)),D=(T.length>0?T.reduce((e,t)=>e+C(t,10),0)/T.length:C("C10",10))+C(", ",10),S=Math.ceil(15.5*D)+20,E=Math.max(C(String(g.length),10),C("No",10),30)+20,M=async()=>{try{if(!g||0===g.length)throw new Error("BOM 데이터가 없습니다. 데이터를 확인해주세요.");if(!s||""===s.trim())throw new Error("보드 이름이 설정되지 않았습니다.");const e=g.filter(e=>e.isManualRequired&&("데이터 없음 (수동 확인 필요)"===e.itemName||"데이터 없음"===e.itemType));if(e.length>0){if(!window.confirm(`수동 확인이 필요한 항목이 ${e.length}개 있습니다.\n그대로 다운로드하시겠습니까?\n\n(해당 항목들은 "데이터 없음"으로 표시됩니다)`))return}const t={boardName:s,artworkManager:o,productionManager:l,productionQuantity:i},a=r.filter(e=>"TOP"===e.layer),n=r.filter(e=>"BOTTOM"===e.layer),c=he(g),d=ge(a),m=ge(n),x=await te(c,d,m,t);if(!x||0===x.size)throw new Error("엑셀 파일 생성에 실패했습니다. (빈 파일)");const u=new Date,h=u.getFullYear().toString().slice(2)+String(u.getMonth()+1).padStart(2,"0")+String(u.getDate()).padStart(2,"0");re(x,`${s.trim().replace(/_\d{6}_정리본$/,"").replace(/_정리본$/,"").replace(/_\d{6}$/,"")}_${h}_정리본.xlsx`),p.success("엑셀 파일이 다운로드되었습니다.")}catch(e){let t="알 수 없는 오류";e instanceof Error&&(t=e.message),p.error(`다운로드 중 오류가 발생했습니다: ${t}`)}},k=()=>{confirm("모든 수정사항을 초기화하시겠습니까?")&&f(e)},P=()=>{if(y)return f(y),b(null),d?.(!1),void p.success("합치기가 해제되었습니다.");const e=new Map;g.forEach(t=>{if(t.itemName.includes("데이터 없음")||"데이터 없음"===t.itemType){const a=`__unique__${t.lineNumber}`;return void e.set(a,[t])}const a=`${t.itemType}|${t.itemName}`;e.has(a)||e.set(a,[]),e.get(a).push(t)});let t=0;if(e.forEach(e=>{e.length>1&&t++}),0===t)return void p.info("합칠 수 있는 동일 항목이 없습니다.");if(!confirm(`동일한 종류+품명 항목 ${t}건을 합치시겠습니까?`))return;b([...g]);const a=[];let r=1;e.forEach(e=>{if(1===e.length)a.push({...e[0],lineNumber:r++});else{const t=e[0],s=e.map(e=>e.refList).join(", "),n=e.reduce((e,t)=>e+(t.setCount||0),0),i=e.reduce((e,t)=>e+(t.totalQuantity||0),0);a.push({...t,lineNumber:r++,refList:s,setCount:n,totalQuantity:i})}}),f(a),d?.(!0),p.success(`${t}건의 동일 항목이 합쳐졌습니다.`)},$=()=>{c(g)};t.useImperativeHandle(h,()=>({handleDownload:M,handleSave:$,handleReset:k,handleMerge:P,isMerged:()=>null!==y}));const L=(e,t,a)=>{const r=[...g],s={...r[e]};s[t]="setCount"===t||"totalQuantity"===t||"stockQuantity"===t?Number(a)||0:a,"itemName"===t&&a&&"데이터 없음 (수동 확인 필요)"!==a&&(s.isManualRequired=!1),"itemType"===t&&a&&"데이터 없음"!==a&&(s.isNewPart=!1),r[e]=s,f(r),"itemType"!==t&&"itemName"!==t||x?.(r)},q=e=>{const t=(e.refList||"").split(",").map(e=>e.trim()).filter(Boolean);if(!t.length)return;window.confirm(`해당 행을 삭제하시겠습니까?\n\n품명: ${e.itemName||"-"}\nREF: ${t.join(", ")}`)&&u?.(t)},Q=e=>e.isManualRequired?"bg-yellow-50 hover:bg-yellow-100":_(e)?"bg-red-50 hover:bg-red-100":e.isNewPart?"bg-gray-100 hover:bg-gray-200":"미삽"===e.remark?"bg-gray-50 hover:bg-gray-100":"hover:bg-gray-50";return a.jsx("div",{className:"space-y-3",children:a.jsx("div",{className:"border rounded-lg overflow-hidden bg-white shadow-sm w-full",children:a.jsx("div",{className:"overflow-x-auto w-full max-w-full",children:a.jsxs(R,{className:"w-full",style:{tableLayout:"fixed"},children:[a.jsx(I,{className:"bg-gray-50 sticky top-0 z-10",children:a.jsxs(B,{className:"h-6",children:[a.jsx(F,{className:"text-center !h-auto !py-0.5 !px-2",style:{width:`${E}px`},children:a.jsx("span",{className:"card-description",children:"No"})}),a.jsx(F,{className:"text-center whitespace-nowrap !h-auto !py-0.5 !px-2",style:{width:`${v}px`},children:a.jsx("span",{className:"card-description",children:"종류"})}),a.jsx(F,{className:"whitespace-nowrap !h-auto !py-0.5 !px-2",style:{width:`${O}px`},children:a.jsx("span",{className:"card-description",children:"품명"})}),a.jsx(F,{className:"w-[60px] text-center !h-auto !py-0.5 !px-2",children:a.jsx("span",{className:"card-description",children:"SET"})}),a.jsx(F,{className:"w-[70px] text-center !h-auto !py-0.5 !px-2",children:a.jsx("span",{className:"card-description",children:"수량"})}),a.jsx(F,{className:"w-[60px] text-center hidden sm:table-cell !h-auto !py-0.5 !px-2",children:a.jsx("span",{className:"card-description",children:"재고"})}),a.jsx(F,{className:"!h-auto !py-0.5 !px-2",style:{width:`${Math.min(S,350)}px`},children:a.jsx("span",{className:"card-description",children:"REF"})}),a.jsx(F,{className:"hidden md:table-cell !h-auto !py-0.5 !px-2",style:{width:"240px"},children:a.jsx("span",{className:"card-description",children:"대체품"})}),a.jsx(F,{className:"!h-auto !py-0.5 !px-2",children:a.jsx("span",{className:"card-description",children:"비고"})}),a.jsx(F,{className:"w-[46px] text-center !h-auto !py-0.5 !px-1",children:a.jsx("span",{className:"card-description",children:"삭제"})})]})}),a.jsx(U,{children:g.map((e,t)=>a.jsxs(B,{className:Q(e),children:[a.jsx(A,{className:"text-center py-1 px-2",children:a.jsx("div",{className:"card-subtitle",children:t+1})}),a.jsx(A,{className:"text-center py-1 px-1 whitespace-nowrap",children:a.jsx("input",{type:"text",className:"w-full text-[10px] text-gray-600 text-center border border-transparent hover:border-gray-200 focus:border-primary focus:outline-none rounded px-1 "+("데이터 없음"===e.itemType?"!text-red-500 font-bold bg-red-50":"bg-transparent"),style:{fontSize:"10px",height:"24px"},value:e.itemType||"",onChange:e=>L(t,"itemType",e.target.value),placeholder:"종류"})}),a.jsx(A,{className:"py-1 px-1 whitespace-nowrap",children:a.jsx("input",{type:"text",className:"w-full text-[10px] border border-transparent hover:border-gray-200 focus:border-primary focus:outline-none rounded px-1 "+(_(e)?"text-gray-500 bg-red-50":e.isNewPart?"text-gray-500 bg-gray-100":e.isManualRequired?"text-red-600 bg-yellow-50":"text-gray-500 bg-transparent"),style:{fontSize:"10px",height:"24px"},value:e.itemName,onChange:e=>L(t,"itemName",e.target.value),placeholder:"품명 입력",title:e.originalFootprint?`원본: ${e.originalFootprint}`:""})}),a.jsx(A,{className:"text-center py-1 px-2",children:a.jsx("input",{type:"number",className:"w-full text-[10px] font-medium text-gray-900 text-center border border-transparent hover:border-gray-200 focus:border-primary focus:outline-none rounded bg-transparent px-1",style:{fontSize:"10px",height:"24px"},value:e.setCount,onChange:e=>L(t,"setCount",e.target.value)})}),a.jsx(A,{className:"text-center py-1 px-2",children:a.jsx("input",{type:"number",className:"w-full text-[10px] font-bold text-gray-900 text-center border border-transparent hover:border-gray-200 focus:border-primary focus:outline-none rounded bg-gray-50 px-1",style:{fontSize:"10px",height:"24px"},value:e.totalQuantity,readOnly:!0,onChange:e=>L(t,"totalQuantity",e.target.value)})}),a.jsx(A,{className:"hidden sm:table-cell text-center py-1 px-2",children:a.jsx("input",{type:"number",className:"w-full text-[10px] font-medium text-gray-900 text-center border border-transparent hover:border-gray-200 focus:border-primary focus:outline-none rounded bg-transparent px-1",style:{fontSize:"10px",height:"24px"},value:e.stockQuantity||"",placeholder:"0",onChange:e=>L(t,"stockQuantity",e.target.value)})}),a.jsx(A,{className:"px-1 py-1 align-middle",children:a.jsx("div",{contentEditable:!0,suppressContentEditableWarning:!0,className:"text-[10px] text-gray-600 outline-none w-full",style:{lineHeight:"14px",wordWrap:"break-word",overflowWrap:"break-word",whiteSpace:"pre-wrap"},onBlur:e=>L(t,"refList",e.currentTarget.textContent||""),children:(e.refList||"").split(",").map(e=>e.trim()).filter(e=>e).join(", ")})}),a.jsx(A,{className:"hidden md:table-cell py-1 px-2",children:a.jsx("input",{type:"text",className:"w-full text-[10px] text-gray-500 px-1 border border-transparent hover:border-gray-200 focus:border-primary focus:outline-none rounded bg-transparent",style:{fontSize:"10px",height:"24px"},value:e.alternativeItem||"",onChange:e=>L(t,"alternativeItem",e.target.value)})}),a.jsx(A,{className:"py-1 px-2",children:a.jsx("input",{type:"text",className:"w-full text-[10px] text-gray-500 px-1 border border-transparent hover:border-gray-200 focus:border-primary focus:outline-none rounded "+("미삽"===e.remark?"!text-gray-500 font-bold bg-gray-50":"bg-transparent"),style:{fontSize:"10px",height:"24px"},value:e.remark||"",onChange:e=>L(t,"remark",e.target.value)})}),a.jsx(A,{className:"text-center py-1 px-1",children:a.jsx(n,{type:"button",variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>q(e),title:"행 삭제",children:a.jsx(m,{className:"w-3.5 h-3.5 text-red-600"})})})]},t))}),a.jsx("tfoot",{className:"bg-gray-50 border-t",children:a.jsxs("tr",{children:[a.jsx("td",{className:"py-2 px-2",children:a.jsxs("span",{className:"card-description whitespace-nowrap",children:["총 ",g.length,"개 항목"]})}),a.jsx("td",{}),a.jsx("td",{className:"text-right pr-2",children:a.jsx("span",{className:"card-description",children:"합계:"})}),a.jsx("td",{className:"text-center py-2",children:a.jsx("span",{className:"text-[11px] text-gray-700",children:w})}),a.jsx("td",{}),a.jsx("td",{className:"hidden sm:table-cell"}),a.jsx("td",{}),a.jsx("td",{className:"hidden md:table-cell"}),a.jsx("td",{className:"py-2 px-2 text-right",children:a.jsxs("div",{className:"flex gap-4 card-description justify-end whitespace-nowrap",children:[a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"w-3 h-3 bg-yellow-100 border border-yellow-300 rounded"}),"수동 확인"]}),a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"w-3 h-3 bg-red-50 border border-red-200 rounded"}),"미삽"]})]})}),a.jsx("td",{})]})})]})})})})});function be({coordinates:e,bomItems:r=[],onCoordinatesChange:s,onDeleteRef:n}){const[i,o]=t.useState(e),l=t.useCallback(e=>{const t=(e||"").trim().toUpperCase();return t?"TOP"===t||"T"===t||"TOPSIDE"===t||"FRONT"===t||"F"===t?"TOP":"BOTTOM"===t||"BOT"===t||"B"===t||"BOTTOMSIDE"===t||"BACK"===t?"BOTTOM":t:""},[]);t.useEffect(()=>{o(e.map(e=>({...e,layer:l(e.layer)||e.layer})))},[e,l]);const c=t.useCallback((e,t)=>{o(a=>{const r=[...a];return r[e]={...r[e],...t},s?.(r),r})},[s]),d=t.useCallback((e,t)=>{o(t=>t.filter((t,a)=>a!==e)),n?.(t)},[n]),p=t.useMemo(()=>{const e=new Set;return r.forEach(t=>{if(t.refList){t.refList.split(",").map(e=>e.trim().toUpperCase()).filter(Boolean).forEach(t=>e.add(t))}}),e},[r]),m=t.useMemo(()=>{const e=new Set;return r.forEach(t=>{if(!t.isManualRequired)return;(t.refList||"").split(",").map(e=>e.trim().toUpperCase()).filter(Boolean).forEach(t=>e.add(t))}),e},[r]),x=t.useMemo(()=>i.map((e,t)=>({coord:e,index:t})).filter(e=>"TOP"===l(e.coord.layer)),[i]),u=t.useMemo(()=>i.map((e,t)=>({coord:e,index:t})).filter(e=>"BOTTOM"===l(e.coord.layer)),[i]);return a.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4 w-full",children:[a.jsxs("div",{className:"w-full",children:[a.jsxs("div",{className:"mb-2 flex items-center gap-2",children:[a.jsx("h4",{className:"text-xs font-semibold text-gray-700",children:"TOP"}),a.jsx("span",{className:"badge-stats bg-gray-100 text-gray-600",children:x.length})]}),a.jsx(Ne,{rows:x,bomRefSet:p,manualRefSet:m,onUpdate:c,onDelete:d})]}),a.jsxs("div",{className:"w-full",children:[a.jsxs("div",{className:"mb-2 flex items-center gap-2",children:[a.jsx("h4",{className:"text-xs font-semibold text-gray-700",children:"BOTTOM"}),a.jsx("span",{className:"badge-stats bg-gray-100 text-gray-600",children:u.length})]}),a.jsx(Ne,{rows:u,bomRefSet:p,manualRefSet:m,onUpdate:c,onDelete:d})]})]})}function Ne({rows:e,bomRefSet:t,manualRefSet:r,onUpdate:s,onDelete:i}){const o=e.length,l=e=>{const t=(e||"").trim().toUpperCase();return t?"TOP"===t||"T"===t||"TOPSIDE"===t||"FRONT"===t||"F"===t?"TOP":"BOTTOM"===t||"BOT"===t||"B"===t||"BOTTOMSIDE"===t||"BACK"===t?"BOTTOM":t:""},c="BOTTOM"===e[0]?.coord?.layer?"BOTTOM":"TOP";return a.jsx("div",{className:"border rounded-lg overflow-hidden bg-white shadow-sm w-full",children:a.jsx("div",{className:"overflow-x-auto w-full max-w-full",children:a.jsxs(R,{className:"w-full table-auto",children:[a.jsx(I,{className:"bg-gray-50 sticky top-0 z-10",children:a.jsxs(B,{className:"h-6",children:[a.jsx(F,{className:"w-[50px] text-center !h-auto !py-0.5 !px-2",children:a.jsx("span",{className:"card-description",children:"No"})}),a.jsx(F,{className:"text-center whitespace-nowrap !h-auto !py-0.5 !px-2",style:{minWidth:"80px"},children:a.jsx("span",{className:"card-description",children:"종류"})}),a.jsx(F,{className:"whitespace-nowrap !h-auto !py-0.5 !px-2",style:{minWidth:"120px"},children:a.jsx("span",{className:"card-description",children:"품명"})}),a.jsx(F,{className:"w-[80px] text-center !h-auto !py-0.5 !px-2",children:a.jsx("span",{className:"card-description",children:"RefDes"})}),a.jsx(F,{className:"w-[70px] text-center !h-auto !py-0.5 !px-2",children:a.jsx("span",{className:"card-description",children:"Layer"})}),a.jsx(F,{className:"w-[90px] text-center !h-auto !py-0.5 !px-2",children:a.jsx("span",{className:"card-description",children:"X"})}),a.jsx(F,{className:"w-[90px] text-center !h-auto !py-0.5 !px-2",children:a.jsx("span",{className:"card-description",children:"Y"})}),a.jsx(F,{className:"w-[70px] text-center !h-auto !py-0.5 !px-2",children:a.jsx("span",{className:"card-description",children:"Angle"})}),a.jsx(F,{className:"!h-auto !py-0.5 !px-2",style:{minWidth:"80px"},children:a.jsx("span",{className:"card-description",children:"비고"})}),a.jsx(F,{className:"w-[46px] text-center !h-auto !py-0.5 !px-1",children:a.jsx("span",{className:"card-description",children:"삭제"})})]})}),a.jsx(U,{children:0===e.length?a.jsx(B,{children:a.jsx(A,{colSpan:10,className:"text-center py-6 card-description",children:"데이터가 없습니다."})}):e.map(({coord:e,index:o},d)=>{const p="BOM 미존재"===e.remark,x=e.refDes&&!t.has(e.refDes.toUpperCase()),u=e.refDes&&r.has(e.refDes.toUpperCase());return a.jsxs(B,{className:`hover:bg-gray-50 ${"미삽"===e.remark?"bg-gray-50":""} ${p||x?"bg-red-50/60":""} ${!u||p||x?"":"bg-yellow-50 hover:bg-yellow-100"}`,children:[a.jsx(A,{className:"text-center py-1 px-2",children:a.jsx("span",{className:"text-[10px] text-gray-500",children:d+1})}),a.jsx(A,{className:"text-center py-1 px-1 whitespace-nowrap",children:a.jsx("input",{type:"text",className:"w-full text-[10px] text-center border border-transparent hover:border-gray-200 focus:border-primary focus:outline-none rounded px-1 "+(p||x?"text-red-600 font-medium bg-red-50/40":u?"text-red-600 bg-yellow-50":"text-gray-600 bg-transparent"),style:{fontSize:"10px",height:"24px"},value:e.type||"",onChange:e=>s(o,{type:e.target.value}),placeholder:"-"})}),a.jsx(A,{className:"py-1 px-1 whitespace-nowrap",children:a.jsx("input",{type:"text",className:"w-full text-[10px] border border-transparent hover:border-gray-200 focus:border-primary focus:outline-none rounded px-1 "+("미삽"===e.remark?"text-gray-400 bg-gray-50":p||x?"text-red-600 font-medium bg-red-50/40":u?"text-red-600 bg-yellow-50":"text-gray-600 bg-transparent"),style:{fontSize:"10px",height:"24px"},value:e.partName||"",onChange:e=>s(o,{partName:e.target.value}),placeholder:"-"})}),a.jsx(A,{className:"text-center py-1 px-2",children:a.jsx("input",{type:"text",className:"w-full text-[10px] text-center border border-transparent hover:border-gray-200 focus:border-primary focus:outline-none rounded px-1 "+(p||x?"text-red-700 font-medium bg-red-50/40":u?"text-red-700 bg-yellow-50":"text-gray-900 bg-transparent"),style:{fontSize:"10px",height:"24px"},value:e.refDes||"",onChange:e=>s(o,{refDes:e.target.value}),placeholder:"-"})}),a.jsx(A,{className:"text-center py-1 px-2",children:a.jsxs("select",{className:"w-full text-[10px] text-center border border-gray-200 rounded px-1 h-6 bg-white "+(p||x?"text-red-700 border-red-200 bg-red-50/40":u?"text-red-700 border-yellow-300 bg-yellow-50":"text-gray-700"),value:l(e.layer)||c,onChange:e=>s(o,{layer:e.target.value}),children:[a.jsx("option",{value:"TOP",children:"TOP"}),a.jsx("option",{value:"BOTTOM",children:"BOTTOM"})]})}),a.jsx(A,{className:"text-center py-1 px-2",children:a.jsx("input",{type:"number",inputMode:"decimal",step:"0.01",className:"w-full text-[10px] font-mono text-center border border-transparent hover:border-gray-200 focus:border-primary focus:outline-none rounded px-1 "+(p||x?"text-red-600 bg-red-50/40":u?"text-red-600 bg-yellow-50":"text-gray-600 bg-transparent"),style:{fontSize:"10px",height:"24px"},value:Number.isFinite(e.locationX)?e.locationX:0,onChange:t=>{const a=Number(t.target.value);s(o,{locationX:Number.isFinite(a)?a:e.locationX})}})}),a.jsx(A,{className:"text-center py-1 px-2",children:a.jsx("input",{type:"number",inputMode:"decimal",step:"0.01",className:"w-full text-[10px] font-mono text-center border border-transparent hover:border-gray-200 focus:border-primary focus:outline-none rounded px-1 "+(p||x?"text-red-600 bg-red-50/40":u?"text-red-600 bg-yellow-50":"text-gray-600 bg-transparent"),style:{fontSize:"10px",height:"24px"},value:Number.isFinite(e.locationY)?e.locationY:0,onChange:t=>{const a=Number(t.target.value);s(o,{locationY:Number.isFinite(a)?a:e.locationY})}})}),a.jsx(A,{className:"text-center py-1 px-2",children:a.jsx("input",{type:"number",inputMode:"decimal",step:"0.01",className:"w-full text-[10px] font-mono text-center border border-transparent hover:border-gray-200 focus:border-primary focus:outline-none rounded px-1 "+(p||x?"text-red-600 bg-red-50/40":u?"text-red-600 bg-yellow-50":"text-gray-600 bg-transparent"),style:{fontSize:"10px",height:"24px"},value:Number.isFinite(e.rotation)?e.rotation:0,onChange:t=>{const a=Number(t.target.value);s(o,{rotation:Number.isFinite(a)?a:e.rotation})}})}),a.jsx(A,{className:"py-1 px-2",children:a.jsx("input",{type:"text",className:"w-full text-[10px] border border-transparent hover:border-gray-200 focus:border-primary focus:outline-none rounded px-1 "+("미삽"===e.remark?"text-red-500 font-medium bg-gray-50":p||x?"text-red-600 font-medium bg-red-50/40":"text-gray-500 bg-transparent"),style:{fontSize:"10px",height:"24px"},value:e.remark||"",onChange:e=>s(o,{remark:e.target.value}),placeholder:x&&!p?"BOM에 없음":""})}),a.jsx(A,{className:"text-center py-1 px-1",children:a.jsx(n,{type:"button",variant:"ghost",size:"icon",className:"h-6 w-6",disabled:!e.refDes,onClick:()=>{if(!e.refDes)return;window.confirm(`해당 좌표 행을 삭제하시겠습니까?\n\nRefDes: ${e.refDes}`)&&i?.(o,e.refDes)},title:"행 삭제",children:a.jsx(m,{className:"w-3.5 h-3.5 text-red-600"})})})]},o)})}),a.jsx("tfoot",{className:"bg-gray-50 border-t",children:a.jsx("tr",{children:a.jsx("td",{colSpan:10,className:"py-2 px-2",children:a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsxs("span",{className:"card-description",children:["총 ",o,"개 항목"]}),a.jsxs("div",{className:"flex gap-4 card-description",children:[a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"w-3 h-3 bg-yellow-100 border border-yellow-300 rounded"}),"수동 확인"]}),a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"w-3 h-3 bg-gray-100 border border-gray-300 rounded"}),"미삽"]}),a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"w-3 h-3 bg-red-50 border border-red-200 rounded"}),"BOM에 없음"]})]})]})})})})]})})})}function we({boardId:e,isOpen:r,onClose:i}){const[o,l]=t.useState(!1),[c,d]=t.useState(null),[m,x]=t.useState(!1),u=s();t.useEffect(()=>{r&&e&&h()},[r,e]);const h=async()=>{if(e){l(!0);try{const{data:t,error:a}=await u.from("cad_drawings").select("*").eq("id",e).single();if(a)throw a;const{data:r,error:s}=await u.from("bom_items").select("*").eq("cad_drawing_id",e).order("line_number");if(s)throw s;const{data:n,error:i}=await u.from("part_placements").select("*").eq("cad_drawing_id",e);if(i)throw i;const o=(r||[]).map(e=>({lineNumber:e.line_number,itemType:e.item_type||"",itemName:e.item_name||"",setCount:e.set_count||0,totalQuantity:e.total_quantity||0,stockQuantity:e.stock_quantity||0,checkStatus:e.check_status||"",refList:Array.isArray(e.ref_list)?e.ref_list.join(", "):e.ref_list||"",alternativeItem:e.alternative_item||"",remark:e.remark||"",isManualRequired:e.is_manual_required||!1,isNewPart:e.is_new_part||!1,originalPart:e.original_part||"",originalFootprint:e.original_footprint||""})),l=[],c=[];(n||[]).forEach(e=>{const t={refDes:e.ref||"",type:e.part_type||"",partName:e.part_name||"",layer:e.side||"TOP",locationX:e.x_coordinate||0,locationY:e.y_coordinate||0,rotation:e.angle||0,remark:e.remark||""};"TOP"===e.side?l.push(t):c.push(t)}),d({id:t.id,board_name:t.board_name,artwork_manager:t.artwork_manager||"",production_manager:t.production_manager||"",production_quantity:t.production_quantity||0,created_at:t.created_at,bomItems:o,topCoordinates:l,bottomCoordinates:c})}catch(t){p.error("데이터를 불러오는데 실패했습니다.")}finally{l(!1)}}},N=(e,t)=>{const a=(e||"").toUpperCase();return(t||"").toUpperCase().includes("미삽")||a.includes("_OPEN")||a.includes("OPEN_")||a.includes("_POGO")||a.includes("POGO_")||a.includes("_PAD")||a.includes("PAD_")||a.includes("_NC")||a.includes("NC_")};return r?a.jsx(g,{open:r,onOpenChange:e=>!e&&i(),children:a.jsxs(f,{maxWidth:"max-w-fit",showCloseButton:!1,className:"w-fit min-w-[600px] max-w-[90vw] max-h-[90vh] overflow-hidden flex flex-col p-4",children:[a.jsx(y,{className:"flex-shrink-0 !p-0 !border-0",children:a.jsxs("div",{className:"flex justify-between items-start",children:[a.jsxs("div",{children:[a.jsx(b,{className:"text-lg font-semibold text-gray-900",children:c?(w=c.board_name,(w||"").trim().replace(/_\d{6}_정리본$/,"").replace(/_정리본$/,"").replace(/_\d{6}$/,"")):"로딩 중..."}),c&&a.jsxs("div",{className:"flex gap-4 mt-1 text-xs text-gray-500",children:[a.jsxs("span",{children:["Artwork: ",c.artwork_manager||"-"]}),a.jsxs("span",{children:["생산: ",c.production_manager||"-"]}),a.jsxs("span",{children:["수량: ",c.production_quantity]})]})]}),a.jsx("div",{className:"flex gap-2",children:a.jsxs(n,{onClick:async()=>{if(c){x(!0);try{const e={boardName:c.board_name,artworkManager:c.artwork_manager,productionManager:c.production_manager,productionQuantity:c.production_quantity},t=he(c.bomItems),a=ge(c.topCoordinates),r=ge(c.bottomCoordinates),s=await te(t,a,r,e),n=new Date,i=n.getFullYear().toString().slice(2)+String(n.getMonth()+1).padStart(2,"0")+String(n.getDate()).padStart(2,"0"),o=`${c.board_name.trim().replace(/_\d{6}_정리본$/,"").replace(/_정리본$/,"").replace(/_\d{6}$/,"")}_${i}_정리본.xlsx`;await re(s,o),p.success("엑셀 파일이 다운로드되었습니다.")}catch(e){p.error("엑셀 다운로드에 실패했습니다.")}finally{x(!1)}}},disabled:m||!c,className:"h-8 px-3 text-xs bg-green-600 hover:bg-green-700 text-white",children:[m?a.jsx(Q,{className:"w-3 h-3 animate-spin mr-1"}):a.jsx(W,{className:"w-3 h-3 mr-1"}),"Excel 다운로드"]})})]})}),a.jsx("div",{className:"flex-1 overflow-hidden mt-3",children:o?a.jsxs("div",{className:"flex items-center justify-center h-64",children:[a.jsx(Q,{className:"w-6 h-6 text-hansl-600 animate-spin mr-2"}),a.jsx("span",{className:"text-sm text-gray-600",children:"데이터를 불러오는 중..."})]}):c?a.jsxs(K,{defaultValue:"bom",className:"h-full flex flex-col",children:[a.jsxs(J,{className:"flex-shrink-0 mb-3 grid grid-cols-3 h-8 bg-gray-100 p-1 business-radius-button",children:[a.jsxs(Z,{value:"bom",className:"text-[10px] h-7 data-[state=active]:bg-white data-[state=active]:text-hansl-600 data-[state=active]:shadow-sm",children:["정리된 BOM",a.jsx("span",{className:"ml-1 badge-stats bg-gray-100 text-gray-600 data-[state=active]:bg-hansl-50 data-[state=active]:text-hansl-700",children:c.bomItems.length})]}),a.jsxs(Z,{value:"top",className:"text-[10px] h-7 data-[state=active]:bg-white data-[state=active]:text-hansl-600 data-[state=active]:shadow-sm",children:["TOP",a.jsx("span",{className:"ml-1 badge-stats bg-gray-100 text-gray-600 data-[state=active]:bg-hansl-50 data-[state=active]:text-hansl-700",children:c.topCoordinates.length})]}),a.jsxs(Z,{value:"bottom",className:"text-[10px] h-7 data-[state=active]:bg-white data-[state=active]:text-hansl-600 data-[state=active]:shadow-sm",children:["BOTTOM",a.jsx("span",{className:"ml-1 badge-stats bg-gray-100 text-gray-600 data-[state=active]:bg-orange-50 data-[state=active]:text-orange-700",children:c.bottomCoordinates.length})]})]}),a.jsx(ee,{value:"bom",className:"flex-1 overflow-auto mt-0",children:a.jsx(je,{items:c.bomItems,checkIsMisap:N,productionQuantity:c.production_quantity})}),a.jsx(ee,{value:"top",className:"flex-1 overflow-auto mt-0",children:a.jsx(_e,{coordinates:c.topCoordinates,bomItems:c.bomItems,checkIsMisap:N})}),a.jsx(ee,{value:"bottom",className:"flex-1 overflow-auto mt-0",children:a.jsx(_e,{coordinates:c.bottomCoordinates,bomItems:c.bomItems,checkIsMisap:N})})]}):a.jsx("div",{className:"flex items-center justify-center h-64 text-gray-500",children:"데이터를 불러올 수 없습니다."})})]})}):null;var w}function je({items:e,checkIsMisap:t,productionQuantity:r}){let s="";const n=e.reduce((e,t)=>e+(t.setCount||0),0),i=e=>{const a=t(e.itemName,e.remark);return e.isManualRequired?"bg-yellow-50 hover:bg-yellow-100":e.isNewPart?"bg-red-50 hover:bg-red-100":a?"bg-gray-50 hover:bg-gray-100":"hover:bg-gray-50"};return a.jsx("div",{className:"border rounded-lg bg-white shadow-sm max-h-[55vh] overflow-auto",children:a.jsxs("table",{className:"table-auto w-auto border-collapse text-[13px]",children:[a.jsx("thead",{className:"bg-gray-50 sticky top-0 z-20",children:a.jsxs("tr",{className:"h-6 border-b border-gray-200",children:[a.jsx("th",{className:"w-[40px] sm:w-[50px] text-center py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"No"})}),a.jsx("th",{className:"text-center whitespace-nowrap py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"종류"})}),a.jsx("th",{className:"whitespace-nowrap py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"품명"})}),a.jsx("th",{className:"w-[50px] sm:w-[60px] text-center py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"SET"})}),a.jsx("th",{className:"w-[60px] sm:w-[80px] text-center py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"수량"})}),a.jsx("th",{className:"w-[50px] sm:w-[60px] text-center hidden sm:table-cell py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"재고"})}),a.jsx("th",{className:"min-w-[200px] sm:min-w-[300px] py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"REF"})}),a.jsx("th",{className:"w-[100px] sm:w-[150px] hidden md:table-cell py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"대체품"})}),a.jsx("th",{className:"w-[100px] sm:w-[150px] py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"비고"})})]})}),a.jsx("tbody",{children:0===e.length?a.jsx("tr",{children:a.jsx("td",{colSpan:9,className:"text-center py-6 card-description",children:"데이터가 없습니다."})}):e.map((e,r)=>{const n=t(e.itemName,e.remark),o=e.itemType!==s;return s=e.itemType,a.jsxs("tr",{className:`${i(e)} border-b border-gray-100`,children:[a.jsx("td",{className:"text-center py-1 px-2",children:a.jsx("span",{className:"text-[10px] "+(n?"text-red-600":"text-gray-500"),children:r+1})}),a.jsx("td",{className:"text-center py-1 px-1 whitespace-nowrap",children:a.jsx("span",{className:`text-[10px] ${n?"text-red-600":"text-gray-600"} ${"데이터 없음"===e.itemType?"!text-red-500 font-bold":""}`,children:o?e.itemType||"-":""})}),a.jsx("td",{className:"py-1 px-1 whitespace-nowrap",children:a.jsx("span",{className:"text-[10px] "+(n?"text-red-600 font-medium":e.isManualRequired||e.isNewPart?"text-red-600":"text-gray-500"),children:e.itemName||"-"})}),a.jsx("td",{className:"text-center py-1 px-2",children:a.jsx("span",{className:"text-[10px] font-medium "+(n?"text-red-600":"text-gray-900"),children:e.setCount})}),a.jsx("td",{className:"text-center py-1 px-2",children:a.jsx("span",{className:"text-[10px] font-bold "+(n?"text-red-600":"text-gray-900"),children:e.totalQuantity})}),a.jsx("td",{className:"hidden sm:table-cell text-center py-1 px-2",children:a.jsx("span",{className:"text-[10px] font-medium "+(n?"text-red-600":"text-gray-900"),children:e.stockQuantity||""})}),a.jsx("td",{className:"px-1 py-1 align-middle",style:{width:"300px",maxWidth:"300px"},children:a.jsx("span",{className:"text-[10px] "+(n?"text-red-600":"text-gray-600"),style:{display:"block",width:"300px",maxWidth:"300px",lineHeight:"14px",wordWrap:"break-word",overflowWrap:"break-word",whiteSpace:"pre-wrap"},children:e.refList||"-"})}),a.jsx("td",{className:"hidden md:table-cell py-1 px-2",children:a.jsx("span",{className:"text-[10px] "+(n?"text-red-600":"text-gray-500"),children:e.alternativeItem||""})}),a.jsx("td",{className:"py-1 px-2",children:a.jsx("span",{className:"text-[10px] "+(n?"text-red-600 font-medium":"text-gray-500"),children:e.remark||""})})]},r)})}),a.jsx("tfoot",{className:"bg-gray-50 border-t sticky bottom-0 z-20",children:a.jsxs("tr",{children:[a.jsx("td",{className:"py-2 px-2 bg-gray-50",children:a.jsxs("span",{className:"card-description whitespace-nowrap",children:["총 ",e.length,"개 항목"]})}),a.jsx("td",{className:"bg-gray-50"}),a.jsx("td",{className:"text-right pr-2 bg-gray-50",children:a.jsx("span",{className:"card-description",children:"합계:"})}),a.jsx("td",{className:"text-center py-2 bg-gray-50",children:a.jsx("span",{className:"text-[11px] text-gray-700",children:n})}),a.jsx("td",{className:"bg-gray-50"}),a.jsx("td",{className:"hidden sm:table-cell bg-gray-50"}),a.jsx("td",{className:"bg-gray-50"}),a.jsx("td",{className:"hidden md:table-cell bg-gray-50"}),a.jsx("td",{className:"py-2 px-2 text-right bg-gray-50",children:a.jsxs("div",{className:"flex gap-4 card-description justify-end whitespace-nowrap",children:[a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"w-3 h-3 bg-yellow-100 border border-yellow-300 rounded"}),"수동 확인"]}),a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"w-3 h-3 bg-red-50 border border-red-200 rounded"}),"미삽"]})]})})]})})]})})}function _e({coordinates:e,bomItems:t=[],checkIsMisap:r}){let s="";const n=e.length,i=new Set;return t.forEach(e=>{if(e.refList){e.refList.split(",").map(e=>e.trim().toUpperCase()).filter(Boolean).forEach(e=>i.add(e))}}),a.jsx("div",{className:"border rounded-lg bg-white shadow-sm max-h-[55vh] overflow-auto",children:a.jsxs("table",{className:"table-auto w-auto border-collapse text-[13px]",children:[a.jsx("thead",{className:"bg-gray-50 sticky top-0 z-20",children:a.jsxs("tr",{className:"h-6 border-b border-gray-200",children:[a.jsx("th",{className:"w-[40px] text-center py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"No"})}),a.jsx("th",{className:"text-center whitespace-nowrap py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"종류"})}),a.jsx("th",{className:"whitespace-nowrap py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"품명"})}),a.jsx("th",{className:"w-[80px] text-center py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"RefDes"})}),a.jsx("th",{className:"w-[60px] text-center py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"Layer"})}),a.jsx("th",{className:"w-[80px] text-center py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"X"})}),a.jsx("th",{className:"w-[80px] text-center py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"Y"})}),a.jsx("th",{className:"w-[60px] text-center py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"Angle"})}),a.jsx("th",{className:"w-[80px] py-0.5 px-2 bg-gray-50 text-[12px] font-semibold text-gray-700",children:a.jsx("span",{className:"card-description",children:"비고"})})]})}),a.jsx("tbody",{children:0===e.length?a.jsx("tr",{children:a.jsx("td",{colSpan:9,className:"text-center py-6 card-description",children:"데이터가 없습니다."})}):e.map((e,t)=>{const n=r(e.partName||"",e.remark||""),o=e.type!==s;s=e.type||"";const l=e.refDes&&!i.has(e.refDes.toUpperCase());return a.jsxs("tr",{className:`hover:bg-gray-50 border-b border-gray-100 ${n?"bg-gray-50":""} ${l?"bg-red-50/60":""}`,children:[a.jsx("td",{className:"text-center py-1 px-2",children:a.jsx("span",{className:"text-[10px] "+(n?"text-red-600":"text-gray-500"),children:t+1})}),a.jsx("td",{className:"text-center py-1 px-1 whitespace-nowrap",children:a.jsx("span",{className:"text-[10px] "+(n||l?"text-red-600":"text-gray-600"),children:o?e.type||"-":""})}),a.jsx("td",{className:"py-1 px-1 whitespace-nowrap",children:a.jsx("span",{className:"text-[10px] "+(n||l?"text-red-600":"text-gray-600"),children:e.partName||"-"})}),a.jsx("td",{className:"text-center py-1 px-2",children:a.jsx("span",{className:"text-[10px] font-medium "+(n||l?"text-red-700":"text-gray-900"),children:e.refDes})}),a.jsx("td",{className:"text-center py-1 px-2",children:a.jsx(h,{variant:"TOP"===e.layer?"default":"secondary",className:"text-[9px] px-1.5 py-0 h-4 "+(l?"bg-red-100 text-red-700 border border-red-200":""),children:e.layer})}),a.jsx("td",{className:"text-center py-1 px-2",children:a.jsx("span",{className:"text-[10px] font-mono "+(n||l?"text-red-600":"text-gray-600"),children:e.locationX?.toFixed(2)})}),a.jsx("td",{className:"text-center py-1 px-2",children:a.jsx("span",{className:"text-[10px] font-mono "+(n||l?"text-red-600":"text-gray-600"),children:e.locationY?.toFixed(2)})}),a.jsx("td",{className:"text-center py-1 px-2",children:a.jsx("span",{className:"text-[10px] font-mono "+(n||l?"text-red-600":"text-gray-600"),children:e.rotation||0})}),a.jsx("td",{className:"py-1 px-2",children:a.jsx("span",{className:"text-[10px] "+(n||l?"text-red-600 font-medium":"text-gray-500"),children:l?"BOM에 없음":e.remark||""})})]},t)})}),a.jsx("tfoot",{className:"bg-gray-50 border-t sticky bottom-0 z-20",children:a.jsx("tr",{children:a.jsx("td",{colSpan:9,className:"py-2 px-2 bg-gray-50",children:a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsxs("span",{className:"card-description",children:["총 ",n,"개 항목"]}),a.jsxs("div",{className:"flex gap-4 card-description",children:[a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"w-3 h-3 bg-gray-100 border border-gray-300 rounded"}),"미삽"]}),a.jsxs("span",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"w-3 h-3 bg-red-50 border border-red-200 rounded"}),"BOM에 없음"]})]})]})})})})]})})}function Ce(){const[e,g]=t.useState("create"),[f,y]=t.useState("input"),[b,$]=t.useState({bomFile:null,coordFile:null}),[L,q]=t.useState({boardName:"",artworkManager:"",productionManager:"",productionQuantity:0}),[H,ae]=t.useState([]),[se,ne]=t.useState(null),[ie,oe]=t.useState(!1),[le,ce]=t.useState(!1),[de,pe]=t.useState(!1),[xe,ue]=t.useState(!1),[Ne,je]=t.useState(null),[_e,Ce]=t.useState(null),[ve,Oe]=t.useState([]),[Te,De]=t.useState(null),[Se,Ee]=t.useState(!1),[Me,ke]=t.useState(null),[Pe,Re]=t.useState(null),[Ie,Be]=t.useState(0),[Fe,Ue]=t.useState(""),[Ae,$e]=t.useState(!1),[Le,qe]=t.useState(null),[Qe,We]=t.useState(null),[ze,Ve]=t.useState(!1),[Xe,Ye]=t.useState(!1),[Ge,He]=t.useState(!1),{mismatchCount:Ke,missingInCoord:Je,missingInBom:Ze}=t.useMemo(()=>{const e=Ne?.processedData?.bomItems??[],t=Ne?.processedData?.coordinates??[];t.length;const a=new Set;e.forEach(e=>{(e.refList||"").split(",").map(e=>e.trim().toUpperCase()).filter(Boolean).forEach(e=>a.add(e))});const r=new Set;t.forEach(e=>{const t=e?.refDes||e?.ref;t&&r.add(t.trim().toUpperCase())});let s=0;a.forEach(e=>{r.has(e)||(s+=1)});let n=0;return r.forEach(e=>{a.has(e)||(n+=1)}),{mismatchCount:s+n,missingInCoord:s,missingInBom:n}},[Ne?.processedData?.bomItems,Ne?.processedData?.coordinates]),et=(()=>{const e=Ne?.processedData?.bomItems||[];if(0===e.length)return!1;const t=new Map;return e.forEach(e=>{if(e.itemName?.includes("데이터 없음")||"데이터 없음"===e.itemType)return;const a=`${e.itemType}|${e.itemName}`;t.set(a,(t.get(a)||0)+1)}),Array.from(t.values()).some(e=>e>1)})(),tt=s(),at=t.useRef(null),{currentUserRoles:rt}=i(),st=rt.includes("app_admin"),nt=e=>(e||"").trim(),it=t.useCallback(e=>{if(st)return!0;if("completed"!==e.status)return!1;const t=nt(e.production_manager),a=nt(se?.name),r=nt(se?.id);if(!t)return!1;if(a&&t===a)return!0;if(r&&t===r)return!0;if(a&&H?.length){const e=H.find(e=>nt(e.id)===t)?.name;if(nt(e)&&nt(e)===a)return!0}return!1},[st,se,H]),ot=e=>`bom_temp_data_${e}`,lt=async()=>{try{const{data:{user:e}}=await tt.auth.getUser();e&&localStorage.removeItem(ot(e.id))}catch(e){}};t.useEffect(()=>{(async()=>{try{const{data:e}=await tt.from("employees").select("id, name").order("name");e&&ae(e);const{data:{user:t}}=await tt.auth.getUser();if(t&&t.email){const{data:e}=await tt.from("employees").select("id, name").eq("email",t.email).single();ne({email:t.email,name:e?.name||t.email.split("@")[0]}),q(t=>t.boardName||t.productionManager||0!==t.productionQuantity||Ge?t:{...t,artworkManager:e?.id||""}),Ge||(async(e,t=!1)=>{try{if(Ge)return;const a=localStorage.getItem(ot(e));if(!a)return;const r=JSON.parse(a);if(t&&(Ne||L.boardName||L.productionManager||L.productionQuantity>0||b.bomFile||b.coordFile))return;const s=new Date(r.savedAt);if(((new Date).getTime()-s.getTime())/36e5>24)return void localStorage.removeItem(ot(e));let n=r.processedResult;n?.processedData?.coordinates&&(n={...n,processedData:{...n.processedData,coordinates:n.processedData.coordinates.map(e=>({...e,refDes:e.refDes||e.ref||""}))}}),y(r.step),q(r.metadata),je(n),g("create")}catch(a){}})(t.id,!0)}}catch(e){}})()},[tt]),t.useEffect(()=>{(async()=>{if(!Ne||"preview"!==f)return;const{data:{user:e}}=await tt.auth.getUser();e&&(e=>{if(Ne&&e)try{const t={step:f,metadata:L,processedResult:Ne,savedAt:(new Date).toISOString()};localStorage.setItem(ot(e),JSON.stringify(t))}catch(t){}})(e.id)})()},[Ne,L,f]),t.useEffect(()=>{(async()=>{if("list"===e)try{Ee(!0);const{data:e,error:t}=await tt.from("cad_drawings").select("id, board_name, created_at, artwork_manager, production_manager, status").order("created_at",{ascending:!1});if(t)throw t;Oe(e||[])}catch(t){p.error("저장된 BOM 목록을 불러오는데 실패했습니다.")}finally{Ee(!1)}})()},[e,tt]),t.useEffect(()=>{if(b.bomFile){let e=b.bomFile.name;e=e.replace(/\.(xlsx|xls|csv)$/i,""),e=e.replace(/(\.|_|\s)?(part)?(\.|_|\s)?bom$/i,""),e=e.replace(/^\d+_bom_/,"");const t=new Date,a=t.getFullYear().toString().slice(2)+(t.getMonth()+1).toString().padStart(2,"0")+t.getDate().toString().padStart(2,"0");e=`${e}_${a}_정리본`,q(t=>({...t,boardName:e}))}},[b.bomFile]);const ct=t.useCallback((e,t)=>{e.preventDefault(),e.stopPropagation(),"dragenter"===e.type||"dragover"===e.type?Ce(t):"dragleave"===e.type&&Ce(null)},[]),dt=t.useCallback((e,t)=>{if(e.preventDefault(),e.stopPropagation(),Ce(null),e.dataTransfer.files&&e.dataTransfer.files[0]){const a=e.dataTransfer.files[0];$("bom"===t?e=>({...e,bomFile:a}):e=>({...e,coordFile:a}))}},[]),pt=t.useCallback((e,t)=>{if(e.target.files&&e.target.files[0]){const a=e.target.files[0];$("bom"===t?e=>({...e,bomFile:a}):e=>({...e,coordFile:a}))}},[]),mt=t.useCallback(e=>{$("bom"===e?e=>({...e,bomFile:null,bomUrl:void 0}):e=>({...e,coordFile:null,coordUrl:void 0}))},[]),xt=t.useCallback(e=>{je(t=>t?.processedData?{...t,processedData:{...t.processedData,coordinates:e}}:t)},[]),ut=t.useCallback(e=>{const t=new Set((e||[]).map(e=>(e||"").trim().toUpperCase()).filter(Boolean));0!==t.size&&je(e=>{if(!e?.processedData)return e;const a=e.processedData?.bomItems??[],r=e.processedData?.coordinates??[],s=e.processedData?.topCoordinates??[],n=e.processedData?.bottomCoordinates??[],i=e=>(e||"").trim().toUpperCase(),o=e=>(e||"").split(",").map(e=>e.trim()).filter(Boolean),l=r.filter(e=>!t.has(i(e.refDes))),c=s.filter(e=>!t.has(i(e.refDes))),d=n.filter(e=>!t.has(i(e.refDes))),p=[];for(const x of a){const e=o(x.refList);if(0===e.length){p.push(x);continue}const a=e.filter(e=>!t.has(i(e)));if(0===a.length)continue;const r=a.length,s=L.productionQuantity>0?r*L.productionQuantity:x.totalQuantity;p.push({...x,refList:a.join(", "),setCount:r,totalQuantity:s})}const m=p.map((e,t)=>({...e,lineNumber:t+1}));return{...e,processedData:{...e.processedData,bomItems:m,coordinates:l,...e.processedData?.topCoordinates?{topCoordinates:c}:{},...e.processedData?.bottomCoordinates?{bottomCoordinates:d}:{}}}})},[L.productionQuantity]),ht=t.useCallback(e=>ut([e]),[ut]);return a.jsxs("div",{className:"w-full",children:[a.jsx("div",{className:"mb-4",children:a.jsxs("div",{children:[a.jsx("h1",{className:"page-title",children:"BOM/좌표 정리"}),a.jsxs("div",{className:"flex justify-between items-center",style:{marginTop:"-2px",marginBottom:"-4px"},children:[a.jsx("p",{className:"page-subtitle mb-0",children:"BOM & Coordinate Management"}),a.jsxs("div",{className:"flex gap-2",children:[a.jsxs(n,{onClick:async()=>{await lt(),He(!0),y("input"),$({bomFile:null,coordFile:null}),q({boardName:"",artworkManager:"",productionManager:"",productionQuantity:0}),je(null),ke(null),Re(null),Be(0),Ue(""),$e(!1),He(!0),De(null),g("create"),y("input"),setTimeout(()=>{He(!1)},1e3)},className:"button-base "+("create"===e?"bg-hansl-600 hover:bg-hansl-700 text-white":"border border-gray-300 bg-white text-gray-700 hover:bg-gray-50"),children:[a.jsx(N,{className:"w-4 h-4 mr-2"}),"새로 만들기"]}),a.jsxs(n,{onClick:()=>{g("list"),y("input")},className:"button-base "+("list"===e?"bg-hansl-600 hover:bg-hansl-700 text-white":"border border-gray-300 bg-white text-gray-700 hover:bg-gray-50"),children:[a.jsx(z,{className:"w-4 h-4 mr-2"}),"보드별 BOM/좌표 정리"]})]})]})]})}),"list"===e&&a.jsx("div",{className:"space-y-4",children:a.jsx(x,{children:a.jsx(u,{className:"p-4 sm:p-6",children:Se?a.jsxs("div",{className:"flex items-center justify-center py-12",children:[a.jsx(Q,{className:"w-6 h-6 text-hansl-600 animate-spin mr-2"}),a.jsx("span",{className:"text-sm text-gray-600",children:"목록을 불러오는 중..."})]}):0===ve.length?a.jsxs("div",{className:"text-center py-12",children:[a.jsx(o,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),a.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"저장된 BOM이 없습니다."}),a.jsxs(n,{onClick:()=>g("create"),className:"button-base bg-hansl-600 hover:bg-hansl-700 text-white",children:[a.jsx(N,{className:"w-4 h-4 mr-2"}),"새 BOM 만들기"]})]}):a.jsxs("div",{className:"space-y-3",children:[a.jsx("div",{className:"flex justify-between items-center mb-4",children:a.jsxs("div",{children:[a.jsx("h3",{className:"page-title",children:"보드별 BOM/좌표 정리"}),a.jsx("p",{className:"page-subtitle",children:"검토대기 항목을 클릭하여 검토 및 최종 저장하세요."})]})}),a.jsx("div",{className:"border rounded-lg overflow-hidden bg-white shadow-sm",children:a.jsx("div",{className:"overflow-x-auto",children:a.jsxs(R,{className:"table-auto",children:[a.jsx(I,{className:"bg-gray-50 sticky top-0 z-10",children:a.jsxs(B,{className:"h-6",children:[a.jsx(F,{className:"w-[50px] text-center !py-1 !h-auto",children:a.jsx("span",{className:"card-description",children:"No"})}),a.jsx(F,{className:"min-w-[200px] !py-1 !h-auto",children:a.jsx("span",{className:"card-description",children:"보드명"})}),a.jsx(F,{className:"w-[100px] text-center !py-1 !h-auto",children:a.jsx("span",{className:"card-description",children:"아트웍 담당"})}),a.jsx(F,{className:"w-[100px] text-center !py-1 !h-auto",children:a.jsx("span",{className:"card-description",children:"생산 담당"})}),a.jsx(F,{className:"w-[80px] text-center !py-1 !h-auto",children:a.jsx("span",{className:"card-description",children:"상태"})}),a.jsx(F,{className:"w-[100px] text-center !py-1 !h-auto",children:a.jsx("span",{className:"card-description",children:"생성일"})}),a.jsx(F,{className:"w-[120px] text-center !py-1 !h-auto",children:a.jsx("span",{className:"card-description",children:"액션"})})]})}),a.jsx(U,{children:ve.map((e,t)=>a.jsxs(B,{className:"hover:bg-gray-50 cursor-pointer",onClick:()=>{"pending"===e.status?(async e=>{try{oe(!0),Ue("데이터를 불러오는 중...");const{data:t,error:a}=await tt.from("cad_drawings").select("id, board_name, artwork_manager, production_manager, production_quantity, status").eq("id",e).single();if(a)throw a;const{data:r,error:s}=await tt.from("bom_items").select("*").eq("cad_drawing_id",e).order("line_number");if(s)throw s;const{data:n,error:i}=await tt.from("part_placements").select("*").eq("cad_drawing_id",e);if(i)throw i;const o=(r||[]).map(e=>{const t=e.item_name||"",a="데이터 없음"===t||t.includes("수동 확인");return{lineNumber:e.line_number,itemType:e.item_type||"",itemName:t,specification:e.specification||"",setCount:e.set_count,totalQuantity:e.total_quantity||0,stockQuantity:e.stock_quantity||0,checkStatus:e.check_status||"□양호",refList:Array.isArray(e.ref_list)?e.ref_list.join(","):e.ref_list||"",alternativeItem:e.alternative_item||"",remark:e.remark||"",isManualRequired:a,isNewPart:a}}),l=(n||[]).map(e=>({type:e.part_type||"",partName:e.part_name||"",refDes:e.ref||"",ref:e.ref||"",layer:e.side||"",locationX:e.x_coordinate||0,locationY:e.y_coordinate||0,rotation:e.angle||0,remark:e.remark||""}));q({boardName:t.board_name,artworkManager:t.artwork_manager||"",productionManager:t.production_manager||"",productionQuantity:t.production_quantity||0}),await lt(),He(!0),je({cadDrawingId:e,isEditMode:!0,processedData:{bomItems:o,coordinates:l}}),De(e),setTimeout(()=>{He(!1)},500),g("create"),y("preview"),p.success("데이터를 불러왔습니다. 검토 후 최종 저장해주세요.")}catch(t){p.error(`데이터 로드 실패: ${t.message}`)}finally{oe(!1),Ue("")}})(e.id):(We(e.id),Ve(!0))},children:[a.jsx(A,{className:"text-center py-1",children:a.jsx("span",{className:"card-subtitle",children:t+1})}),a.jsx(A,{className:"py-1",children:a.jsx("span",{className:"text-[11px] font-medium text-gray-900",children:e.board_name})}),a.jsx(A,{className:"text-center py-1",children:a.jsx("span",{className:"text-[10px] text-gray-600",children:e.artwork_manager||"-"})}),a.jsx(A,{className:"text-center py-1",children:a.jsx("span",{className:"text-[10px] text-gray-600",children:e.production_manager||"-"})}),a.jsx(A,{className:"text-center py-1",children:"pending"===e.status?a.jsx(h,{className:"bg-yellow-100 text-yellow-800 hover:bg-yellow-100 text-[9px] px-1.5 py-0.5",children:"검토대기"}):a.jsx(h,{className:"bg-green-100 text-green-800 hover:bg-green-100 text-[9px] px-1.5 py-0.5",children:"완료"})}),a.jsx(A,{className:"text-center py-1",children:a.jsx("span",{className:"text-[10px] text-gray-500",children:new Date(e.created_at).toLocaleDateString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit"})})}),a.jsx(A,{className:"text-center py-1",onClick:e=>e.stopPropagation(),children:a.jsxs("div",{className:"flex gap-1 justify-center",children:[a.jsxs(n,{onClick:()=>(async(e,t)=>{try{const{data:a,error:r}=await tt.from("cad_drawings").select("artwork_manager, production_manager, production_quantity").eq("id",e).single();if(r)throw r;const{data:s,error:n}=await tt.from("bom_items").select("*").eq("cad_drawing_id",e).order("line_number");if(n)throw n;const{data:i,error:o}=await tt.from("part_placements").select("*").eq("cad_drawing_id",e);if(o)throw o;const l=(s||[]).map(e=>({lineNumber:e.line_number,itemType:e.item_type||"",itemName:e.item_name,specification:e.specification||"",setCount:e.set_count,totalQuantity:e.total_quantity||0,stockQuantity:e.stock_quantity||0,checkStatus:e.check_status||"□양호",refList:Array.isArray(e.ref_list)?e.ref_list.join(","):e.ref_list||"",alternativeItem:e.alternative_item||"",remark:e.remark||""})),c=e=>{const t=(e||"").trim().toUpperCase();return t?"TOP"===t||"T"===t||"TOPSIDE"===t||"FRONT"===t||"F"===t?"TOP":"BOTTOM"===t||"BOT"===t||"B"===t||"BOTTOMSIDE"===t||"BACK"===t?"BOTTOM":t:""},d=(i||[]).map(e=>({type:e.part_type||"",partName:e.part_name||"",refDes:e.ref||"",layer:c(e.side)||e.side||"",locationX:Number(e.x_coordinate??0)||0,locationY:Number(e.y_coordinate??0)||0,rotation:Number(e.angle??0)||0,remark:e.remark||""})),m={boardName:t,artworkManager:a?.artwork_manager||se?.name||"",productionManager:a?.production_manager||"",productionQuantity:a?.production_quantity||(l[0]?.totalQuantity&&l[0]?.setCount?Math.round(l[0].totalQuantity/l[0].setCount):0)},x=d.filter(e=>(e.layer||"").toUpperCase().includes("TOP")),u=d.filter(e=>(e.layer||"").toUpperCase().includes("BOT")),h=he(l),g=ge(x),f=ge(u),y=await te(h,g,f,m),b=new Date,N=b.getFullYear().toString().slice(2)+String(b.getMonth()+1).padStart(2,"0")+String(b.getDate()).padStart(2,"0");re(y,`${t.trim().replace(/_\d{6}_정리본$/,"").replace(/_정리본$/,"").replace(/_\d{6}$/,"")}_${N}_정리본.xlsx`),p.success("엑셀 파일이 다운로드되었습니다.")}catch(a){p.error(`다운로드 중 오류가 발생했습니다: ${a.message}`)}})(e.id,e.board_name),variant:"outline",size:"sm",className:"h-6 px-2 text-[10px] text-green-600 hover:text-green-700 hover:bg-green-50 border-green-200",children:[a.jsx(W,{className:"w-3 h-3 mr-1"}),"Excel"]}),it(e)&&a.jsx(n,{onClick:()=>(async(e,t)=>{const a=ve.find(t=>t.id===e);if(!a||!it(a))return void p.error("삭제 권한이 없습니다.");if(window.confirm(`"${t}" BOM을 삭제하시겠습니까?\n\n관련된 모든 데이터(BOM 항목, 좌표 데이터, 원본 파일 정보)가 함께 삭제됩니다.`))try{qe(e);const{error:a}=await tt.from("bom_items").delete().eq("cad_drawing_id",e),{error:s}=await tt.from("part_placements").delete().eq("cad_drawing_id",e),{data:n}=await tt.from("bom_raw_files").select("bom_file_url, coordinate_file_url").eq("cad_drawing_id",e);if(n&&n.length>0)for(const e of n)try{if(e.bom_file_url){const t=e.bom_file_url.split("/bom-files/")[1]?.split("?")[0];t&&await tt.storage.from("bom-files").remove([decodeURIComponent(t)])}if(e.coordinate_file_url){const t=e.coordinate_file_url.split("/bom-files/")[1]?.split("?")[0];t&&await tt.storage.from("bom-files").remove([decodeURIComponent(t)])}}catch(r){}const{error:i}=await tt.from("bom_raw_files").delete().eq("cad_drawing_id",e),{error:o}=await tt.from("cad_drawings").delete().eq("id",e);if(o)throw o;Oe(t=>t.filter(t=>t.id!==e)),p.success(`"${t}" BOM이 삭제되었습니다.`)}catch(s){p.error(`삭제 중 오류가 발생했습니다: ${s.message}`)}finally{qe(null)}})(e.id,e.board_name),variant:"outline",size:"sm",disabled:Le===e.id,className:"h-6 px-2 text-[10px] text-red-600 hover:text-red-700 hover:bg-red-50 border-red-200",children:Le===e.id?a.jsx(Q,{className:"w-3 h-3 animate-spin"}):a.jsx(m,{className:"w-3 h-3"})})]})})]},e.id))}),a.jsx("tfoot",{className:"bg-gray-50 border-t",children:a.jsx("tr",{children:a.jsx("td",{colSpan:7,className:"py-2 px-4",children:a.jsxs("span",{className:"card-description",children:["총 ",ve.length,"개 항목"]})})})})]})})})]})})})}),"create"===e&&a.jsxs(a.Fragment,{children:["input"===f&&a.jsxs("div",{className:"space-y-4",children:[Pe&&a.jsxs("div",{className:"bg-red-50 border border-red-200 text-red-700 px-6 py-4 rounded-lg text-sm flex flex-col gap-2 shadow-sm animate-in fade-in slide-in-from-top-2",children:[a.jsxs("div",{className:"flex items-center gap-2 font-semibold",children:[a.jsx(l,{className:"w-5 h-5 flex-shrink-0 text-red-600"}),a.jsx("span",{children:"오류가 발생했습니다"})]}),a.jsx("p",{className:"pl-7",children:Pe}),Pe.includes("quota")&&a.jsx("p",{className:"pl-7 text-xs text-red-600 mt-1",children:"* OpenAI 결제 정보가 반영되기까지 최대 10~20분이 소요될 수 있습니다. 잠시 후 다시 시도해주세요."})]}),a.jsx(x,{children:a.jsx(u,{className:"py-4",children:a.jsxs("div",{className:"flex flex-col lg:flex-row gap-4 lg:gap-6 items-stretch",children:[a.jsxs("div",{className:"w-full lg:w-[50%] grid grid-cols-1 sm:grid-cols-2 gap-3",children:[a.jsxs("div",{className:r("border-2 border-dashed rounded-lg p-2 text-center transition-colors cursor-pointer relative flex flex-col items-center justify-center h-full","bom"===_e?"border-primary bg-primary/5":"border-gray-200 hover:border-gray-300",b.bomFile?"bg-green-50 border-green-200":""),onDragEnter:e=>ct(e,"bom"),onDragLeave:e=>ct(e,"bom"),onDragOver:e=>ct(e,"bom"),onDrop:e=>dt(e,"bom"),onClick:()=>document.getElementById("bom-upload")?.click(),children:[a.jsx("input",{id:"bom-upload",type:"file",className:"hidden",accept:".xlsx,.xls",onChange:e=>pt(e,"bom")}),b.bomFile?a.jsxs("div",{className:"flex flex-col items-center gap-1 w-full px-1",children:[a.jsx("span",{className:"text-xs font-bold text-green-600",children:"BOM"}),a.jsx("p",{className:"text-[10px] font-medium text-green-700 w-full text-center break-all line-clamp-2",title:b.bomFile.name,children:b.bomFile.name}),a.jsx(n,{variant:"ghost",size:"sm",className:"absolute top-1 right-1 p-0 w-4 h-4 min-w-0",onClick:e=>{e.stopPropagation(),mt("bom")},children:a.jsx(c,{size:12})})]}):a.jsxs("div",{className:"flex flex-col items-center gap-1",children:[a.jsx("span",{className:"text-xs font-bold text-gray-400",children:"BOM"}),a.jsx("p",{className:"text-[10px] font-medium text-gray-700",children:"파일 업로드"})]})]}),a.jsxs("div",{className:r("border-2 border-dashed rounded-lg p-2 text-center transition-colors cursor-pointer relative flex flex-col items-center justify-center h-full","coord"===_e?"border-primary bg-primary/5":"border-gray-200 hover:border-gray-300",b.coordFile?"bg-blue-50 border-blue-200":""),onDragEnter:e=>ct(e,"coord"),onDragLeave:e=>ct(e,"coord"),onDragOver:e=>ct(e,"coord"),onDrop:e=>dt(e,"coord"),onClick:()=>document.getElementById("coord-upload")?.click(),children:[a.jsx("input",{id:"coord-upload",type:"file",className:"hidden",accept:".xlsx,.xls,.txt,.csv",onChange:e=>pt(e,"coord")}),b.coordFile?a.jsxs("div",{className:"flex flex-col items-center gap-1 w-full px-1",children:[a.jsx("span",{className:"text-xs font-bold text-blue-600",children:"좌표"}),a.jsx("p",{className:"text-[10px] font-medium text-blue-700 w-full text-center break-all line-clamp-2",title:b.coordFile.name,children:b.coordFile.name}),a.jsx(n,{variant:"ghost",size:"sm",className:"absolute top-1 right-1 p-0 w-4 h-4 min-w-0",onClick:e=>{e.stopPropagation(),mt("coord")},children:a.jsx(c,{size:12})})]}):a.jsxs("div",{className:"flex flex-col items-center gap-1",children:[a.jsx("span",{className:"text-xs font-bold text-gray-400",children:"좌표"}),a.jsx("p",{className:"text-[10px] font-medium text-gray-700",children:"파일 업로드"})]})]})]}),a.jsxs("div",{className:"w-full lg:w-[50%] space-y-1",children:[a.jsxs("div",{className:"space-y-1 mb-3.5",children:[a.jsx(w,{className:"text-[10px] text-gray-500",children:"보드 이름 (자동)"}),a.jsx(j,{value:L.boardName||"BOM 파일 업로드 시 자동",disabled:!0,className:"w-full bg-gray-50 border border-[#d2d2d7] rounded-md text-xs shadow-sm",style:{height:"32px"}})]}),a.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2",children:[a.jsxs("div",{className:"space-y-1",children:[a.jsxs(w,{className:"text-[10px] text-gray-500",children:["Artwork 담당자 ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsxs(E,{open:de,onOpenChange:pe,children:[a.jsx(M,{asChild:!0,children:a.jsxs(n,{variant:"outline",role:"combobox","aria-expanded":de,className:"w-full justify-between text-xs h-8 min-h-[32px] px-2 bg-white border-[#d2d2d7] shadow-sm hover:bg-gray-50",children:[L.artworkManager?H.find(e=>e.id===L.artworkManager)?.name||L.artworkManager:se?.name||"담당자 선택",a.jsx(_,{className:"ml-2 h-3 w-3 shrink-0 opacity-50"})]})}),a.jsx(k,{className:"w-[200px] p-0",children:a.jsxs(C,{children:[a.jsx(v,{placeholder:"이름 검색...",className:"h-8 text-xs"}),a.jsxs(O,{children:[a.jsx(T,{children:"검색 결과 없음"}),a.jsx(D,{children:H.map(e=>a.jsxs(S,{value:e.name,onSelect:()=>{q(t=>({...t,artworkManager:e.id})),pe(!1)},className:"text-xs",children:[a.jsx(V,{className:r("mr-2 h-3 w-3",L.artworkManager===e.id?"opacity-100":"opacity-0")}),e.name]},e.id))})]})]})})]})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsx(w,{className:"text-[10px] text-gray-400",children:"생산 담당자"}),a.jsxs(E,{open:xe,onOpenChange:ue,children:[a.jsx(M,{asChild:!0,children:a.jsxs(n,{variant:"outline",role:"combobox","aria-expanded":xe,disabled:!0,className:"w-full justify-between text-xs h-8 min-h-[32px] px-2 bg-gray-100 border-[#d2d2d7] shadow-sm cursor-not-allowed text-gray-400",children:[L.productionManager?H.find(e=>e.id===L.productionManager)?.name:"최종 저장 시 자동 배정",a.jsx(_,{className:"ml-2 h-3 w-3 shrink-0 opacity-50"})]})}),a.jsx(k,{className:"w-[200px] p-0",children:a.jsxs(C,{children:[a.jsx(v,{placeholder:"이름 검색...",className:"h-8 text-xs"}),a.jsxs(O,{children:[a.jsx(T,{children:"검색 결과 없음"}),a.jsx(D,{children:H.map(e=>a.jsxs(S,{value:e.name,onSelect:()=>{q(t=>({...t,productionManager:e.id})),ue(!1)},className:"text-xs",children:[a.jsx(V,{className:r("mr-2 h-3 w-3",L.productionManager===e.id?"opacity-100":"opacity-0")}),e.name]},e.id))})]})]})})]})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsxs(w,{className:"text-[10px] text-gray-500",children:["생산 수량 ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsxs("div",{className:"relative",children:[a.jsx(j,{type:"number",min:"0",value:0===L.productionQuantity?"":L.productionQuantity,onChange:e=>q(t=>({...t,productionQuantity:parseInt(e.target.value)||0})),className:"w-full bg-white border border-[#d2d2d7] rounded-md text-xs shadow-sm hover:shadow-md transition-shadow duration-200 pr-8",style:{height:"32px"},placeholder:"0"}),a.jsx("span",{className:"absolute right-2.5 top-1/2 -translate-y-1/2 text-[10px] text-gray-500 font-medium pointer-events-none",children:"SET"})]})]}),a.jsx("div",{className:"flex items-end",children:a.jsx(n,{onClick:async()=>{if(!b.bomFile||!b.coordFile)return void p.error("BOM 파일과 좌표 파일을 모두 선택해주세요.");if(!L.boardName.trim())return void p.error("보드 이름을 입력해주세요.");if(L.productionQuantity<=0)return void p.error("생산 수량을 입력해주세요 (1 이상).");let e=null,t=null;try{ce(!0),y("processing"),Re(null),Be(0),Ue("파일 업로드 준비 중...");const a=15e3+((b.bomFile?.size||0)+(b.coordFile?.size||0))/1024*50,r=500,s=90/(a/r);e=setInterval(()=>{Be(e=>{if(e>=95)return e;const t=.5*Math.random()+.8;return Math.min(e+s*t,95)})},r),t=setInterval(()=>{Ue(e=>"파일 업로드 준비 중..."===e?"BOM 파일 읽는 중...":"BOM 파일 읽는 중..."===e?"데이터 구조 분석 중...":"데이터 구조 분석 중..."===e?"좌표 데이터 매칭 중...":"좌표 데이터 매칭 중..."===e?"AI가 최종 정리 중입니다...":"AI가 최종 정리 중입니다..."===e?"거의 다 되었습니다. 잠시만요!":e)},a/5);const{data:{user:n}}=await tt.auth.getUser();if(!n)throw new Error("로그인이 필요합니다.");const i=Date.now(),o=e=>{const t=e.lastIndexOf("."),a=t>-1?e.slice(t):"";return((t>-1?e.slice(0,t):e).replace(/[^a-zA-Z0-9\-_]/g,"_").replace(/_+/g,"_").replace(/^_|_$/g,"")||"file")+a},l=o(b.bomFile.name),c=o(b.coordFile.name),d=`raw/${i}_bom_${l}`,m=`raw/${i}_coord_${c}`,x=await tt.storage.from("bom-files").upload(d,b.bomFile,{cacheControl:"3600",upsert:!0});if(x.error)throw x.error;const u=await tt.storage.from("bom-files").upload(m,b.coordFile,{cacheControl:"3600",upsert:!0});if(u.error)throw await tt.storage.from("bom-files").remove([d]),u.error;const{data:h}=await tt.storage.from("bom-files").createSignedUrl(d,3600),{data:g}=await tt.storage.from("bom-files").createSignedUrl(m,3600);if(!h?.signedUrl||!g?.signedUrl)throw new Error("파일 URL 생성 실패");ke({bomPath:d,coordPath:m}),Ue("학습 데이터 기반 분석 중...");const f=await me(b.bomFile,b.coordFile,L.productionQuantity);if(e&&clearInterval(e),t&&clearInterval(t),Be(100),Ue("완료!"),!f||!f.bomItems)throw new Error("BOM 처리 결과가 올바르지 않습니다.");const N={cadDrawingId:`cad_${Date.now()}`,processedData:{bomItems:f.bomItems,topCoordinates:f.topCoordinates,bottomCoordinates:f.bottomCoordinates,coordinates:[...f.topCoordinates,...f.bottomCoordinates],summary:f.summary}};je(N),await new Promise(e=>setTimeout(e,500)),p.success("BOM 분석 및 정리가 완료되었습니다."),y("preview")}catch(a){const r=`처리 중 오류가 발생했습니다: ${a.message||a}`;Re(r),e&&clearInterval(e),t&&clearInterval(t),ce(!1),y("input"),window.scrollTo({top:0,behavior:"smooth"})}finally{"processing"===f&&Pe&&ce(!1)}},disabled:!b.bomFile||!b.coordFile||!L.boardName||L.productionQuantity<=0||le,className:"w-full bg-hansl-500 hover:bg-hansl-600 text-white shadow-sm text-xs disabled:bg-gray-300 disabled:cursor-not-allowed",style:{height:"32px"},children:"정리 및 생성"})})]})]})]})})}),!b.bomFile&&!b.coordFile&&a.jsxs("div",{className:"text-center py-6 sm:py-8 text-gray-500",children:[a.jsx(o,{className:"w-10 h-10 sm:w-12 sm:h-12 mx-auto mb-3 text-gray-300"}),a.jsx("p",{className:"text-xs sm:text-sm px-4",children:"BOM 파일과 좌표 파일을 업로드하여 시작하세요"})]})]}),"processing"===f&&a.jsx(x,{children:a.jsx(u,{className:"py-12 sm:py-16 lg:py-20",children:a.jsxs("div",{className:"flex flex-col items-center justify-center max-w-md mx-auto",children:[a.jsx(Q,{className:"w-8 h-8 sm:w-10 sm:h-10 text-hansl-600 animate-spin mb-6"}),a.jsx("h3",{className:"text-base sm:text-lg lg:text-xl font-semibold text-center mb-2",children:Fe||"AI가 BOM을 분석하고 있습니다"}),a.jsx("p",{className:"text-xs sm:text-sm text-gray-600 mb-6 text-center px-4",children:"잠시만 기다려주세요... (약 30초 ~ 1분 소요)"}),a.jsxs("div",{className:"w-full px-4",children:[a.jsx(P,{value:Ie,className:"h-2"}),a.jsxs("p",{className:"text-right text-xs text-gray-500 mt-1",children:[Math.round(Ie),"%"]})]})]})})}),"preview"===f&&Ne&&a.jsx("div",{className:"space-y-4",children:a.jsx(x,{children:a.jsxs(u,{className:"p-4 sm:p-6 w-full max-w-full overflow-hidden",children:[a.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-end gap-3 mb-4",children:[a.jsxs("div",{children:[a.jsxs("h3",{className:"page-title",children:["데이터 미리보기 ",a.jsx("span",{className:"text-xs font-medium text-gray-500 ml-3",children:(L.boardName||"").trim().replace(/_\d{6}_정리본$/,"").replace(/_정리본$/,"").replace(/_\d{6}$/,"")})]}),a.jsx("p",{className:"page-subtitle",children:"데이터 클릭 수정 후 저장 바랍니다."})]}),a.jsxs("div",{className:"flex gap-2",children:[a.jsxs(n,{onClick:()=>at.current?.handleMerge(),disabled:!et&&!Ae,className:"button-base border "+(et||Ae?Ae?"border-orange-300 bg-orange-50 text-orange-700 hover:bg-orange-100":"border-gray-300 bg-white text-gray-700 hover:bg-gray-50":"border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed"),children:[a.jsx(G,{className:"w-4 h-4 mr-2"}),Ae?"합치기 해제":"동일 항목 합치기"]}),a.jsxs(n,{onClick:()=>at.current?.handleReset(),className:"button-base border border-gray-300 bg-white text-gray-700 hover:bg-gray-50",children:[a.jsx(X,{className:"w-4 h-4 mr-2"}),"초기화"]}),a.jsx(n,{onClick:()=>at.current?.handleSave(),disabled:Xe,className:"button-base text-white "+(Ne?.isEditMode?"bg-green-600 hover:bg-green-700":"bg-hansl-500 hover:bg-hansl-600"),children:Xe?a.jsxs(a.Fragment,{children:[a.jsx(Q,{className:"w-4 h-4 mr-2 animate-spin"}),Ne?.isEditMode?"저장 중...":"요청 중..."]}):a.jsx(a.Fragment,{children:Ne?.isEditMode?a.jsxs(a.Fragment,{children:[a.jsx(V,{className:"w-4 h-4 mr-2"}),"최종 저장"]}):a.jsxs(a.Fragment,{children:[a.jsx(Y,{className:"w-4 h-4 mr-2"}),"검토 요청"]})})}),a.jsxs(n,{onClick:()=>at.current?.handleDownload(),className:"button-base bg-green-500 hover:bg-green-600 text-white",children:[a.jsx(W,{className:"w-4 h-4 mr-2"}),"Excel"]})]})]}),a.jsxs(K,{defaultValue:"bom",className:"w-full max-w-full",children:[a.jsxs(J,{className:"flex space-x-1 bg-gray-50 p-1 business-radius-card border border-gray-200 mb-4 w-full",children:[a.jsxs(Z,{value:"bom",className:"flex-1 flex items-center justify-center space-x-2 py-1.5 px-3 sm:px-4 business-radius-button !text-xs font-medium transition-colors data-[state=active]:text-hansl-600 data-[state=active]:bg-white data-[state=active]:shadow-sm data-[state=active]:border data-[state=active]:border-gray-200 data-[state=inactive]:text-gray-600 data-[state=inactive]:bg-transparent data-[state=inactive]:hover:text-gray-900 data-[state=inactive]:hover:bg-white/50",children:[a.jsx("span",{className:"whitespace-nowrap",children:"정리된 BOM"}),a.jsx("span",{className:"badge-stats data-[state=active]:bg-hansl-50 data-[state=active]:text-hansl-700 bg-gray-100 text-gray-600",children:(Ne.processedData?.bomItems??[]).reduce((e,t)=>e+(t.setCount||0),0)}),(Ne.processedData?.bomItems?.filter(e=>e.isManualRequired).length??0)>0&&a.jsxs("span",{className:"badge-stats bg-yellow-100 text-yellow-700 border border-yellow-300",children:["⚠️ 수동 작성: ",Ne.processedData?.bomItems?.filter(e=>e.isManualRequired).length]}),Ke>0&&a.jsxs("span",{className:"badge-stats bg-red-100 text-red-700 border border-red-200",children:["REF 불일치: ",Ke]}),Je>0&&a.jsxs("span",{className:"badge-stats bg-red-100 text-red-700 border border-red-200",children:["좌표에 없음: ",Je,"개"]})]}),a.jsxs(Z,{value:"coord",className:"flex-1 flex items-center justify-center space-x-2 py-1.5 px-3 sm:px-4 business-radius-button !text-xs font-medium transition-colors data-[state=active]:text-hansl-600 data-[state=active]:bg-white data-[state=active]:shadow-sm data-[state=active]:border data-[state=active]:border-gray-200 data-[state=inactive]:text-gray-600 data-[state=inactive]:bg-transparent data-[state=inactive]:hover:text-gray-900 data-[state=inactive]:hover:bg-white/50",children:[a.jsx("span",{className:"whitespace-nowrap",children:"좌표 데이터"}),a.jsx("span",{className:"badge-stats data-[state=active]:bg-hansl-50 data-[state=active]:text-hansl-700 bg-gray-100 text-gray-600",children:Ne.processedData?.coordinates?.filter(e=>"TOP"===e.layer).length||0}),a.jsx("span",{className:"badge-stats data-[state=active]:bg-orange-50 data-[state=active]:text-orange-700 bg-gray-100 text-gray-600",children:Ne.processedData?.coordinates?.filter(e=>"BOTTOM"===e.layer).length||0}),(Ne.processedData?.bomItems?.filter(e=>e.isManualRequired).length??0)>0&&a.jsxs("span",{className:"badge-stats bg-yellow-100 text-yellow-700 border border-yellow-300",children:["⚠️ 수동 작성: ",Ne.processedData?.bomItems?.filter(e=>e.isManualRequired).length]}),Ze>0&&a.jsxs("span",{className:"badge-stats bg-red-100 text-red-700 border border-red-200",children:["BOM에 없음: ",Ze,"개"]})]})]}),a.jsx(ee,{value:"bom",forceMount:!0,className:"mt-0 w-full max-w-full overflow-hidden",children:a.jsx(ye,{ref:at,bomItems:Ne.processedData?.bomItems||[],coordinates:Ne.processedData?.coordinates||[],boardName:L.boardName||"Board",productionQuantity:L.productionQuantity,artworkManager:H.find(e=>e.id===L.artworkManager)?.name||se?.name||"",productionManager:H.find(e=>e.id===L.productionManager)?.name||"",onSave:async e=>{if(!Ne?.cadDrawingId)return;const t=!0===Ne.isEditMode;try{const{data:{user:a}}=await tt.auth.getUser();if(!a)throw new Error("로그인이 필요합니다.");let r=Ne.cadDrawingId;const s=H.find(e=>e.id===L.artworkManager)?.name||se?.name||"",n=(H.find(e=>e.id===L.productionManager)?.name||L.productionManager,t?"completed":"pending"),i=t?se?.name:null;if(t){const{data:e,error:t}=await tt.from("cad_drawings").update({artwork_manager:s,production_manager:i,production_quantity:L.productionQuantity,status:n}).eq("id",r).select("id, status, production_manager");if(t)throw t;if(!e||0===e.length)throw p.error("상태 업데이트가 차단되었습니다(RLS). 관리자에게 cad_drawings UPDATE 정책 추가가 필요합니다."),new Error("cad_drawings update blocked (0 rows updated)")}else if(r.startsWith("cad_")){const e=new Date,t=e.getFullYear().toString().slice(2)+String(e.getMonth()+1).padStart(2,"0")+String(e.getDate()).padStart(2,"0"),a=`${L.boardName.trim().replace(/_\d{6}_정리본$/,"").replace(/_정리본$/,"").replace(/_\d{6}$/,"")}_${t}_정리본`,{data:o,error:l}=await tt.from("cad_drawings").insert({board_name:a,artwork_manager:s,production_manager:i,production_quantity:L.productionQuantity,status:n}).select("id").single();if(l)throw l;r=o.id;const{data:c,error:d}=await tt.from("cad_drawings").select("id, status, production_manager, created_at").eq("id",r).single()}else if(!Ne.cadDrawingId.startsWith("cad_")){const{error:e}=await tt.from("cad_drawings").update({artwork_manager:s,production_manager:i,production_quantity:L.productionQuantity,status:n}).eq("id",r);if(e)throw e}if(b.bomFile&&b.coordFile&&Me){let e="",t="";const{data:s}=await tt.storage.from("bom-files").createSignedUrl(Me.bomPath,31536e3),{data:n}=await tt.storage.from("bom-files").createSignedUrl(Me.coordPath,31536e3);s?.signedUrl&&(e=s.signedUrl),n?.signedUrl&&(t=n.signedUrl);const{data:i}=await tt.from("bom_raw_files").select("id").eq("cad_drawing_id",r).single();if(i){const{error:r}=await tt.from("bom_raw_files").update({bom_file_url:e,coordinate_file_url:t,bom_file_name:b.bomFile.name,coordinate_file_name:b.coordFile.name,uploaded_by:a.email||a.id}).eq("id",i.id);if(r)throw r}else{const{error:s}=await tt.from("bom_raw_files").insert({cad_drawing_id:r,bom_file_url:e,coordinate_file_url:t,bom_file_name:b.bomFile.name,coordinate_file_name:b.coordFile.name,uploaded_by:a.email||a.id});if(s)throw s}}const{error:o}=await tt.from("bom_items").delete().eq("cad_drawing_id",r);if(o)throw o;const{error:l}=await tt.from("bom_items").insert(e.map(e=>({cad_drawing_id:r,line_number:e.lineNumber,item_type:e.itemType,item_name:e.itemName,specification:e.originalFootprint||"",set_count:e.setCount,total_quantity:e.totalQuantity,stock_quantity:e.stockQuantity||0,check_status:e.checkStatus,ref_list:Array.isArray(e.refList)?e.refList:e.refList?e.refList.split(",").map(e=>e.trim()):[],alternative_item:e.alternativeItem||"",remark:e.remark||""})));if(l)throw l;if(Ne.processedData?.coordinates){const{error:e}=await tt.from("part_placements").delete().eq("cad_drawing_id",r);if(e)throw e;const{error:t}=await tt.from("part_placements").insert(Ne.processedData.coordinates.map(e=>({cad_drawing_id:r,ref:e.refDes,part_name:e.partName,part_type:e.type,side:e.layer,x_coordinate:e.locationX||0,y_coordinate:e.locationY||0,angle:e.rotation||null})));if(t)throw t}if(Me){const{error:t}=await tt.from("ai_learning_records").insert({cad_drawing_id:r,processed_bom_data:e,processed_coordinate_data:Ne.processedData?.coordinates,cad_program_type:"unknown",created_at:(new Date).toISOString()});if(t);else{const{resetLearningDataCache:e}=await d(async()=>{const{resetLearningDataCache:e}=await Promise.resolve().then(()=>fe);return{resetLearningDataCache:e}},void 0);e()}}je(t=>({...t,cadDrawingId:r,processedData:{...t.processedData,bomItems:e}})),lt(),De(null),Oe(e=>e.map(e=>e.id===r?{...e,status:n,production_manager:i??e.production_manager}:e)),g("list"),y("input"),$({bomFile:null,coordFile:null}),q({boardName:"",artworkManager:"",productionManager:"",productionQuantity:0}),je(null),t?p.success("최종 저장이 완료되었습니다."):p.success("검토 요청이 완료되었습니다. 생산 담당자의 확인을 기다려주세요.")}catch(a){p.error(`저장에 실패했습니다: ${a.message}`)}},onMergeStateChange:$e,onBomChange:e=>{if(!Ne?.processedData?.coordinates)return;const t=new Map;e.forEach(e=>{(e.refList||"").split(",").map(e=>e.trim()).filter(e=>e).forEach(a=>{t.set(a.toUpperCase(),{type:e.itemType||"",partName:e.itemName||""})})});const a=Ne.processedData.coordinates.map(e=>{const a=(e.refDes||"").toUpperCase(),r=t.get(a);return r?{...e,type:r.type,partName:r.partName}:e});je(t=>({...t,processedData:{...t.processedData,bomItems:e,coordinates:a}}))},onDeleteRefs:ut})}),a.jsx(ee,{value:"coord",forceMount:!0,className:"mt-0 w-full max-w-full overflow-hidden",children:a.jsx(be,{coordinates:Ne.processedData?.coordinates||[],bomItems:Ne.processedData?.bomItems||[],onCoordinatesChange:xt,onDeleteRef:ht})})]})]})})})]}),a.jsx(we,{boardId:Qe,isOpen:ze,onClose:()=>{Ve(!1),We(null)}})]})}ye.displayName="GeneratedPreviewPanel";export{Ce as default};
//# sourceMappingURL=BomCoordinateIntegrated-A_KALo4d.js.map
