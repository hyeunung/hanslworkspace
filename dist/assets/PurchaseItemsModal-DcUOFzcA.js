import{r as e,a as t,l as a,j as s,B as i,X as r}from"./index-CKEqwJSz.js";import{D as n,a as l,b as c,c as m}from"./dialog-Cqyzfg3m.js";import{T as o,a as d,b as u,c as h,d as x,e as p}from"./table-CwE9CNAa.js";import{I as g}from"./input-CgVah532.js";import{t as _}from"./index-B9l5zrB7.js";import{u as v,D as b}from"./useConfirmDateAction-DHUnptEz.js";import{P as j}from"./pen-D5lRmeDC.js";import{P as f}from"./plus-BUM3zqNZ.js";import{S as N}from"./save-DVmvDKUi.js";import{T as y}from"./trash-2-ZJ4A1c4Z.js";import{f as w}from"./calendar-BhDx0rst.js";import"./popover-C9aXdwPA.js";import"./chevron-right-DLm4TFj2.js";import"./chevron-down-B3SfS_0a.js";function q({isOpen:q,onClose:C,purchase:k,isAdmin:T,onUpdate:M,activeTab:D="done"}){const[S,z]=e.useState(k.items||[]),[I,E]=e.useState(!1),[A,U]=e.useState(""),[L,P]=e.useState({width:0,height:0}),H=t();e.useEffect(()=>{const e=()=>{P({width:window.innerWidth,height:window.innerHeight})};return e(),window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}},[]);const $=e.useMemo(()=>{const{width:e}=L;if(0===e)return"800px";const t=e-48-20-40;return`${Math.max(800,Math.min(t,.95*e))}px`},[L]);e.useEffect(()=>{q&&(async()=>{try{const{data:{user:e}}=await H.auth.getUser();if(e?.email){const{data:t}=await H.from("employees").select("name").eq("email",e.email).single();U(t?.name?t.name:e.email)}if(k.id){const{data:e}=await H.from("purchase_request_items").select("*").eq("purchase_request_id",k.id).order("line_number");e&&z(e)}}catch(e){a.error("Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®",e),U("ÏÇ¨Ïö©Ïûê")}})()},[q,H,k.id]);const W=k?.requester_name===A,B=T||W;a.debug("üîê PurchaseItemsModal Í∂åÌïú Ï≤¥ÌÅ¨ Ï†ïÎ≥¥",{currentUserName:A,isAdmin:T,isRequester:W,canReceiptCheck:B,purchaseRequesterName:k?.requester_name,activeTab:D}),a.debug("üì± PurchaseItemsModal Î∞òÏùëÌòï Ï†ïÎ≥¥",{viewportWidth:L.width,viewportHeight:L.height,tableMaxWidth:$,modalWidth:`min(98vw, ${$})`});const F=e.useCallback(async()=>{if(k.id)try{const{data:e}=await H.from("purchase_request_items").select("*").eq("purchase_request_id",k.id).order("line_number");e&&(z(e),a.debug("Î™®Îã¨ ÏïÑÏù¥ÌÖú Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ® ÏôÑÎ£å - Î™®Îã¨ ÏÉÅÌÉú Ïú†ÏßÄ"))}catch(e){a.error("Î™®Îã¨ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ® Ïã§Ìå®",e)}},[k.id,H]),R=v({config:{field:"statement_received",confirmMessage:{confirm:"Í±∞ÎûòÎ™ÖÏÑ∏ÏÑú ÌôïÏù∏ÏùÑ Ï≤òÎ¶¨ÌïòÏãúÍ≤†ÏäµÎãàÍπå?",cancel:"Í±∞ÎûòÎ™ÖÏÑ∏ÏÑú ÌôïÏù∏ÏùÑ Ï∑®ÏÜåÌïòÏãúÍ≤†ÏäµÎãàÍπå?"},successMessage:{confirm:"Í±∞ÎûòÎ™ÖÏÑ∏ÏÑú ÌôïÏù∏Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.",cancel:"Í±∞ÎûòÎ™ÖÏÑ∏ÏÑú ÌôïÏù∏Ïù¥ Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§."},completedText:"‚úì ÏôÑÎ£å",waitingText:"ÎåÄÍ∏∞"},currentUserName:A,canPerformAction:B,onUpdate:F}),O=v({config:{field:"actual_received",confirmMessage:{confirm:"Ïã§Ï†ú ÏûÖÍ≥† Ï≤òÎ¶¨Î•º ÏßÑÌñâÌïòÏãúÍ≤†ÏäµÎãàÍπå?",cancel:"Ïã§Ï†ú ÏûÖÍ≥† Ï≤òÎ¶¨Î•º Ï∑®ÏÜåÌïòÏãúÍ≤†ÏäµÎãàÍπå?"},successMessage:{confirm:"Ïã§Ï†ú ÏûÖÍ≥† Ï≤òÎ¶¨Í∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.",cancel:"Ïã§Ï†ú ÏûÖÍ≥† Ï≤òÎ¶¨Í∞Ä Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§."},completedText:"ÏûÖÍ≥†ÏôÑÎ£å",waitingText:"ÏûÖÍ≥†ÎåÄÍ∏∞"},currentUserName:A,canPerformAction:B,onUpdate:F}),G=(e,t,a)=>{const s=[...S];if(s[e]={...s[e],[t]:"quantity"===t||"unit_price_value"===t||"amount_value"===t?Number(a):a},"quantity"===t||"unit_price_value"===t){const t=s[e].quantity||0,a=s[e].unit_price_value||0;s[e].amount_value=a>0?t*a:0}z(s)},J=S,K=J.reduce((e,t)=>e+(t.amount_value||0),0);return s.jsx(n,{open:q,onOpenChange:C,children:s.jsxs(l,{className:"w-full max-w-[95vw] max-h-[90vh] overflow-hidden flex flex-col bg-white p-3 sm:p-6",children:[s.jsx(c,{className:"flex-shrink-0",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs(m,{className:"modal-title",children:["Î∞úÏ£º ÏÉÅÏÑ∏ Ìï≠Î™© - ",k.purchase_order_number]}),s.jsxs("div",{className:"flex items-center gap-2",children:[T&&!I&&s.jsxs(i,{variant:"outline",size:"sm",onClick:()=>{E(!0),z([...k.items||[]])},children:[s.jsx(j,{className:"h-4 w-4 mr-1"}),"Ìé∏Ïßë"]}),I&&s.jsxs(s.Fragment,{children:[s.jsxs(i,{variant:"outline",size:"sm",onClick:()=>{const e={line_number:S.reduce((e,t)=>{const a=t.line_number||0;return a>e?a:e},0)+1,item_name:"",specification:"",quantity:1,unit_price_value:void 0,amount_value:0,remark:"",is_received:!1},t=[...S,e].sort((e,t)=>(e.line_number||999999)-(t.line_number||999999));z(t)},children:[s.jsx(f,{className:"h-4 w-4 mr-1"}),"ÌíàÎ™© Ï∂îÍ∞Ä"]}),s.jsxs(i,{variant:"default",size:"sm",onClick:async()=>{try{a.debug("ÌíàÎ™© Ï†ÄÏû• ÏãúÏûë",{editingItems:S.length,purchaseId:k.id});if(S.filter(e=>!e.item_name||!e.item_name.trim()).length>0)return void _.error("ÌíàÎ™©Î™ÖÏùÄ ÌïÑÏàò ÏûÖÎ†• Ìï≠Î™©ÏûÖÎãàÎã§.");const{error:e}=await H.from("purchase_request_items").delete().eq("purchase_request_id",k.id);if(e)throw a.error("Í∏∞Ï°¥ ÌíàÎ™© ÏÇ≠Ï†ú Ïã§Ìå®",e),e;const t=S.map(e=>({purchase_request_id:k.id,purchase_order_number:k.purchase_order_number,line_number:e.line_number,item_name:e.item_name.trim(),specification:e.specification||"",quantity:Number(e.quantity)||0,unit_price_value:null!==e.unit_price_value&&void 0!==e.unit_price_value&&""!==e.unit_price_value?Number(e.unit_price_value):null,amount_value:Number(e.amount_value)||0,remark:e.remark||"",link:e.link||null,is_received:e.is_received||!1,delivery_status:e.delivery_status||"pending"}));a.debug("ÌíàÎ™© ÏÇΩÏûÖ Îç∞Ïù¥ÌÑ∞",{itemsToInsert:t});const{error:s}=await H.from("purchase_request_items").insert(t);if(s)throw a.error("ÌíàÎ™© ÏÇΩÏûÖ Ïã§Ìå®",s),s;const i=S.reduce((e,t)=>e+(Number(t.amount_value)||0),0),{error:r}=await H.from("purchase_requests").update({total_amount:i}).eq("id",k.id);if(r)throw a.error("Ï¥ùÍ∏àÏï° ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®",r),r;a.debug("ÌíàÎ™© Ï†ÄÏû• ÏôÑÎ£å"),_.success("ÌíàÎ™©Ïù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§."),E(!1),M(),C()}catch(e){a.error("ÌíàÎ™© Ï†ÄÏû• Ï§ë Ïò§Î•ò",e),_.error(`Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${e instanceof Error?e.message:e}`)}},children:[s.jsx(N,{className:"h-4 w-4 mr-1"}),"Ï†ÄÏû•"]}),s.jsx(i,{variant:"ghost",size:"sm",onClick:()=>{E(!1),z(k.items||[])},children:"Ï∑®ÏÜå"})]}),s.jsx(i,{variant:"ghost",size:"icon",onClick:C,className:"h-6 w-6",children:s.jsx(r,{className:"h-4 w-4"})})]})]})}),s.jsxs("div",{className:"flex-shrink-0 grid grid-cols-2 md:grid-cols-4 gap-3 py-3 border-b",children:[s.jsxs("div",{children:[s.jsx("p",{className:"modal-label",children:"ÏóÖÏ≤¥Î™Ö"}),s.jsx("p",{className:"modal-value",children:k.vendor_name})]}),s.jsxs("div",{children:[s.jsx("p",{className:"modal-label",children:"ÏöîÏ≤≠Ïûê"}),s.jsx("p",{className:"modal-value",children:k.requester_name})]}),s.jsxs("div",{children:[s.jsx("p",{className:"modal-label",children:"ÌîÑÎ°úÏ†ùÌä∏"}),s.jsx("p",{className:"modal-value truncate",title:k.project_vendor,children:k.project_vendor})]}),s.jsxs("div",{children:[s.jsx("p",{className:"modal-label",children:"ÎÇ©Í∏∞Ïùº"}),s.jsx("p",{className:"modal-value",children:k.delivery_request_date&&w(new Date(k.delivery_request_date),"yyyy-MM-dd")})]})]}),s.jsx("div",{className:"flex-1 overflow-hidden",children:s.jsx("div",{className:"w-full h-full overflow-x-auto overflow-y-auto",style:{maxHeight:"60vh"},children:s.jsxs(o,{className:"min-w-[800px] w-full",children:[s.jsx(d,{className:"sticky top-0 bg-white z-10",children:s.jsxs(u,{children:[s.jsx(h,{className:"w-12",children:"No."}),s.jsx(h,{children:"ÌíàÎ™©"}),s.jsx(h,{children:"Í∑úÍ≤©"}),s.jsx(h,{className:"text-right",children:"ÏàòÎüâ"}),s.jsx(h,{className:"text-right",children:"Îã®Í∞Ä"}),s.jsx(h,{className:"text-right",children:"Í∏àÏï°"}),"purchase"===D&&s.jsx(h,{children:"Íµ¨Îß§ÏÉÅÌÉú"}),("receipt"===D||"done"===D)&&s.jsx(h,{children:"ÏûÖÍ≥†ÏÉÅÌÉú"}),"done"===D&&s.jsxs(s.Fragment,{children:[s.jsx(h,{className:"text-center",children:"Í±∞ÎûòÎ™ÖÏÑ∏ÏÑú ÌôïÏù∏"}),s.jsx(h,{className:"text-center",children:"ÌöåÍ≥ÑÏÉÅ ÏûÖÍ≥†Ïùº"}),s.jsx(h,{className:"text-center",children:"Ï≤òÎ¶¨Ïûê"})]}),"receipt"===D&&s.jsx(h,{className:"text-center",children:"Ïã§Ï†ú ÏûÖÍ≥†Ïùº"}),s.jsx(h,{children:"ÎπÑÍ≥†"}),I&&s.jsx(h,{className:"w-20",children:"ÏÇ≠Ï†ú"})]})}),s.jsx(x,{children:(I?S:J).map((e,t)=>s.jsxs(u,{children:[s.jsx(p,{className:"modal-value",children:e.line_number||t+1}),s.jsx(p,{children:I?s.jsx(g,{value:e.item_name,onChange:e=>G(t,"item_name",e.target.value),className:"h-7 modal-label"}):s.jsx("div",{className:"sm:max-w-[200px]",children:s.jsx("p",{className:"modal-value truncate",title:e.item_name,children:e.item_name})})}),s.jsx(p,{children:I?s.jsx(g,{value:e.specification,onChange:e=>G(t,"specification",e.target.value),className:"h-7 modal-label"}):s.jsx("div",{className:"sm:max-w-[150px] truncate",title:e.specification,children:e.specification})}),s.jsx(p,{className:"text-right",children:I?s.jsx(g,{type:"number",value:e.quantity,onChange:e=>G(t,"quantity",e.target.value),className:"h-7 text-xs text-right"}):s.jsx("div",{className:"text-right",children:s.jsx("span",{className:"modal-value text-right",style:{display:"block",textAlign:"right"},children:e.quantity.toLocaleString()})})}),s.jsx(p,{className:"text-right",children:I?s.jsx(g,{type:"number",value:e.unit_price_value,onChange:e=>G(t,"unit_price_value",e.target.value),className:"h-7 text-xs text-right"}):s.jsx("div",{className:"text-right",children:s.jsxs("span",{className:"modal-subtitle text-right",style:{display:"block",textAlign:"right"},children:[(e.unit_price_value||0).toLocaleString()," ",k.currency]})})}),s.jsx(p,{className:"text-right",children:I?s.jsx(g,{type:"number",value:e.amount_value,onChange:e=>G(t,"amount_value",e.target.value),className:"h-7 modal-label text-right"}):s.jsx("div",{className:"text-right",children:s.jsxs("span",{className:"modal-value text-right",style:{display:"block",textAlign:"right"},children:[(e.amount_value||0).toLocaleString()," ",k.currency]})})}),"purchase"===D&&s.jsx(p,{children:B?e.is_payment_completed?s.jsx("button",{onClick:async()=>{try{if(a.debug("Íµ¨Îß§Ï∑®ÏÜå Î≤ÑÌäº ÌÅ¥Î¶≠",{itemId:e.id,itemName:e.item_name,currentStatus:e.is_payment_completed}),!e.id)throw new Error("ÌíàÎ™© IDÍ∞Ä ÏóÜÏäµÎãàÎã§.");const{error:t,data:s}=await H.from("purchase_request_items").update({is_payment_completed:!1}).eq("id",e.id).select();if(t)throw a.error("Íµ¨Îß§Ï∑®ÏÜå ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®",t),t;a.debug("Íµ¨Îß§Ï∑®ÏÜå ÏóÖÎç∞Ïù¥Ìä∏ ÏÑ±Í≥µ",{data:s}),_.success("Íµ¨Îß§ Ï∑®ÏÜå Ï≤òÎ¶¨ÎêòÏóàÏäµÎãàÎã§."),await F()}catch(t){a.error("Íµ¨Îß§Ï∑®ÏÜå Ï≤òÎ¶¨ Ï§ë Ïò§Î•ò",t),_.error(`Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${t instanceof Error?t.message:t}`)}},className:"button-base bg-green-500 hover:bg-green-600 text-white transition-colors",title:"ÌÅ¥Î¶≠ÌïòÏó¨ Íµ¨Îß§ Ï∑®ÏÜå",children:"Íµ¨Îß§ÏôÑÎ£å"}):s.jsx("button",{onClick:async()=>{try{if(a.debug("Íµ¨Îß§ÏôÑÎ£å Î≤ÑÌäº ÌÅ¥Î¶≠",{itemId:e.id,itemName:e.item_name,currentStatus:e.is_payment_completed}),!e.id)throw new Error("ÌíàÎ™© IDÍ∞Ä ÏóÜÏäµÎãàÎã§.");const{error:t,data:s}=await H.from("purchase_request_items").update({is_payment_completed:!0}).eq("id",e.id).select();if(t)throw a.error("Íµ¨Îß§ÏôÑÎ£å ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®",t),t;a.debug("Íµ¨Îß§ÏôÑÎ£å ÏóÖÎç∞Ïù¥Ìä∏ ÏÑ±Í≥µ",{data:s}),_.success("Íµ¨Îß§ÏôÑÎ£å Ï≤òÎ¶¨ÎêòÏóàÏäµÎãàÎã§."),await F()}catch(t){a.error("Íµ¨Îß§ÏôÑÎ£å Ï≤òÎ¶¨ Ï§ë Ïò§Î•ò",t),_.error(`Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${t instanceof Error?t.message:t}`)}},className:"button-base border border-gray-300 text-gray-600 bg-white hover:bg-gray-50",children:"Íµ¨Îß§ÎåÄÍ∏∞"}):s.jsx("span",{className:"button-base "+(e.is_payment_completed?"bg-green-500 text-white":"border border-gray-300 text-gray-400 bg-white"),children:e.is_payment_completed?"Íµ¨Îß§ÏôÑÎ£å":"Íµ¨Îß§ÎåÄÍ∏∞"})}),("receipt"===D||"done"===D)&&s.jsx(p,{children:"receipt"===D?B?O.isCompleted(e)?s.jsx("button",{onClick:()=>{O.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-base bg-green-500 hover:bg-green-600 text-white transition-colors",title:"ÌÅ¥Î¶≠ÌïòÏó¨ Ïã§Ï†ú ÏûÖÍ≥† Ï≤òÎ¶¨ Ï∑®ÏÜå",children:O.config.completedText}):s.jsx(b,{onDateSelect:t=>{O.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"Ïã§Ï†ú ÏûÖÍ≥† ÎÇ†Ïßú ÏÑ†ÌÉù",children:s.jsx(i,{variant:"outline",size:"sm",className:"button-base border border-gray-300 text-gray-600 bg-white hover:bg-gray-50",children:O.config.waitingText})}):s.jsx("span",{className:"button-base "+(O.isCompleted(e)?"bg-green-500 text-white":"border border-gray-300 text-gray-400 bg-white"),children:O.isCompleted(e)?O.config.completedText:O.config.waitingText}):s.jsx("span",{className:"button-base "+(O.isCompleted(e)?"bg-green-500 text-white":"border border-gray-300 text-gray-600 bg-white"),children:O.isCompleted(e)?O.config.completedText:O.config.waitingText})}),"receipt"===D&&s.jsx(p,{className:"text-center",children:O.getCompletedDate(e)?s.jsx("span",{className:"modal-subtitle text-green-600",children:w(new Date(O.getCompletedDate(e)),"yyyy-MM-dd HH:mm")}):s.jsx("span",{className:"modal-subtitle",children:"-"})}),"done"===D&&s.jsxs(s.Fragment,{children:[s.jsx(p,{className:"text-center",children:B?R.isCompleted(e)?s.jsx("button",{onClick:()=>{R.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-base bg-green-500 hover:bg-green-600 text-white transition-colors",title:"ÌÅ¥Î¶≠ÌïòÏó¨ Í±∞ÎûòÎ™ÖÏÑ∏ÏÑú ÌôïÏù∏ Ï∑®ÏÜå",children:R.config.completedText}):s.jsx(b,{onDateSelect:t=>{R.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"ÎÇ†Ïßú ÏÑ†ÌÉù",children:s.jsx(i,{variant:"outline",size:"sm",className:"button-base border border-gray-300 text-gray-600 bg-white hover:bg-gray-50",children:R.config.waitingText})}):s.jsx("span",{className:"button-base "+(R.isCompleted(e)?"bg-green-500 text-white":"border border-gray-300 text-gray-400 bg-white"),children:R.isCompleted(e)?R.config.completedText:R.config.waitingText})}),s.jsx(p,{className:"text-center",children:R.getCompletedDate(e)?s.jsx("span",{className:"modal-subtitle",children:w(new Date(R.getCompletedDate(e)),"yyyy-MM-dd")}):s.jsx("span",{className:"modal-subtitle",children:"-"})}),s.jsx(p,{className:"text-center",children:R.getCompletedByName(e)?s.jsx("span",{className:"modal-subtitle",children:R.getCompletedByName(e)}):s.jsx("span",{className:"modal-subtitle",children:"-"})})]}),s.jsx(p,{children:I?s.jsx(g,{value:e.remark||"",onChange:e=>G(t,"remark",e.target.value),className:"h-7 modal-label",placeholder:"ÎπÑÍ≥†"}):s.jsx("div",{className:"sm:max-w-[150px]",children:s.jsx("span",{className:"modal-subtitle truncate block",title:e.remark,children:e.remark||"-"})})}),I&&s.jsx(p,{children:s.jsx(i,{variant:"ghost",size:"icon",onClick:()=>(e=>{const t=S.filter((t,a)=>a!==e).sort((e,t)=>(e.line_number||999999)-(t.line_number||999999));z(t)})(t),className:"h-7 w-7 text-red-500 hover:text-red-700",children:s.jsx(y,{className:"h-4 w-4"})})})]},e.id||t))})]})})}),s.jsxs("div",{className:"flex-shrink-0 border-t pt-4 flex justify-between items-center",children:[s.jsxs("div",{className:"modal-subtitle",children:["Ï¥ù ",J.length,"Í∞ú ÌíàÎ™©"]}),s.jsxs("div",{className:"modal-value-large",children:["Ï¥ù Í∏àÏï°: ",K.toLocaleString()," ",k.currency]})]})]})})}export{q as default};
//# sourceMappingURL=PurchaseItemsModal-DcUOFzcA.js.map
