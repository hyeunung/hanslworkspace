import{c as e,E as a,j as t,a as s,r as i,B as n,X as r,l}from"./index-eZHgl9gv.js";import{D as c,a as m,b as o,c as d,I as u}from"./input-DIFHe_3T.js";import{T as h,a as x,b as p,c as j,d as g,e as _}from"./table-BuNHfLz5.js";import{B as v,t as f}from"./index-CCh-a4cX.js";import{E as b}from"./eye-qWu4ggQo.js";import{D as N}from"./download-BEawOhid.js";import{u as y,D as w}from"./useConfirmDateAction-CtsM0gFy.js";import{P as C,f as k}from"./format-g5YX1Z6Z.js";import{P as q}from"./plus-C30oij3E.js";import{S as T}from"./save-xHT3yRCF.js";import{T as U}from"./trash-2-B85lil0N.js";import"./chevron-down-C5t9dDW8.js";import"./popover-BDgdt5kx.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const D=e("file-x",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"m14.5 12.5-5 5",key:"b62r18"}],["path",{d:"m9.5 12.5 5 5",key:"1rk7el"}]]),M=({itemId:e,receiptUrl:i,itemName:n,paymentCategory:r,onUpdate:l})=>{const[c,m]=a.useState(!1);if("현장 결제"!==r&&"현장결제"!==r)return null;return i?t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("button",{onClick:()=>{if(!i)return;const e=document.createElement("div");e.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: rgba(0, 0, 0, 0.9);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      z-index: 9999;\n      cursor: pointer;\n    ";const a=document.createElement("img");a.src=i,a.style.cssText="\n      max-width: 90%;\n      max-height: 90%;\n      object-fit: contain;\n      border-radius: 8px;\n    ",e.appendChild(a),e.onclick=()=>document.body.removeChild(e),document.body.appendChild(e)},className:"inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-semibold text-white bg-blue-500 hover:bg-blue-600 rounded-md transition-colors",title:"영수증 미리보기",children:[t.jsx(b,{className:"w-4 h-4"}),t.jsx("span",{children:"보기"})]}),t.jsxs("button",{onClick:async()=>{if(i){m(!0);try{const a=new URL(i).pathname.split("/"),t=a.indexOf("receipt-images");if(-1===t)throw new Error("잘못된 영수증 URL입니다");const r=a.slice(t+1).join("/"),l=s(),{data:c,error:m}=await l.storage.from("receipt-images").download(r);if(m)throw m;const o=new Blob([c],{type:"image/jpeg"}),d=window.URL.createObjectURL(o),u=document.createElement("a");u.href=d,u.download=`영수증_${n}_${e}_${Date.now()}.jpg`,document.body.appendChild(u),u.click(),document.body.removeChild(u),window.URL.revokeObjectURL(d),"undefined"!=typeof window&&"function"==typeof window.alert&&alert("✅ 영수증이 다운로드되었습니다.")}catch(a){alert(`❌ 다운로드 실패: ${a instanceof Error?a.message:a}`)}finally{m(!1)}}},disabled:c,className:"inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-semibold text-white bg-green-500 hover:bg-green-600 disabled:bg-gray-400 disabled:cursor-not-allowed rounded-md transition-colors",title:"영수증 다운로드",children:[t.jsx(N,{className:"w-4 h-4"}),t.jsx("span",{children:c?"다운로드 중...":"다운로드"})]})]}):t.jsxs("div",{className:"flex items-center gap-2 text-gray-400",children:[t.jsx(D,{className:"w-4 h-4"}),t.jsx("span",{className:"text-sm",children:"영수증 없음"})]})};function z({isOpen:e,onClose:a,purchase:b,isAdmin:N,onUpdate:D,activeTab:z="done"}){const[S,L]=i.useState(b.items||[]),[E,B]=i.useState(!1),[R,F]=i.useState(""),O=s();i.useEffect(()=>{e&&(async()=>{try{const{data:{user:e}}=await O.auth.getUser();if(e?.email){const{data:a}=await O.from("employees").select("name").eq("email",e.email).single();F(a?.name?a.name:e.email)}if(b.id){const{data:e}=await O.from("purchase_request_items").select("*").eq("purchase_request_id",b.id).order("line_number");e&&L(e)}}catch(e){l.error("데이터 로드 실패",e),F("사용자")}})()},[e,O,b.id]);const A=N||b?.requester_name===R,P=y({config:{field:"statement_received",confirmMessage:{confirm:"거래명세서 확인을 처리하시겠습니까?",cancel:"거래명세서 확인을 취소하시겠습니까?"},successMessage:{confirm:"거래명세서 확인이 완료되었습니다.",cancel:"거래명세서 확인이 취소되었습니다."},completedText:"✓ 완료",waitingText:"대기"},currentUserName:R,canPerformAction:A,onUpdate:()=>{D&&D();(async()=>{if(b.id){const{data:e}=await O.from("purchase_request_items").select("*").eq("purchase_request_id",b.id).order("line_number");e&&L(e)}})()}}),$=y({config:{field:"actual_received",confirmMessage:{confirm:"실제 입고 처리를 진행하시겠습니까?",cancel:"실제 입고 처리를 취소하시겠습니까?"},successMessage:{confirm:"실제 입고 처리가 완료되었습니다.",cancel:"실제 입고 처리가 취소되었습니다."},completedText:"입고완료",waitingText:"입고대기"},currentUserName:R,canPerformAction:A,onUpdate:()=>{D&&D();(async()=>{if(b.id){const{data:e}=await O.from("purchase_request_items").select("*").eq("purchase_request_id",b.id).order("line_number");e&&L(e)}})()}}),H=(e,a,t)=>{const s=[...S];s[e]={...s[e],[a]:"quantity"===a||"unit_price_value"===a||"amount_value"===a?Number(t):t},"quantity"!==a&&"unit_price_value"!==a||(s[e].amount_value=s[e].quantity*(s[e].unit_price_value||0)),L(s)},I=S,V=I.reduce((e,a)=>e+(a.amount_value||0),0);return t.jsx(c,{open:e,onOpenChange:a,children:t.jsxs(m,{className:"w-full max-w-[95vw] sm:max-w-6xl max-h-[80vh] overflow-hidden flex flex-col bg-white",children:[t.jsx(o,{className:"flex-shrink-0",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs(d,{className:"modal-title",children:["발주 상세 항목 - ",b.purchase_order_number]}),t.jsxs("div",{className:"flex items-center gap-2",children:[N&&!E&&t.jsxs(n,{variant:"outline",size:"sm",onClick:()=>{B(!0),L([...b.items||[]])},children:[t.jsx(C,{className:"h-4 w-4 mr-1"}),"편집"]}),E&&t.jsxs(t.Fragment,{children:[t.jsxs(n,{variant:"outline",size:"sm",onClick:()=>{const e={line_number:S.length+1,item_name:"",specification:"",quantity:0,unit_price_value:0,amount_value:0,remark:"",is_received:!1};L([...S,e])},children:[t.jsx(q,{className:"h-4 w-4 mr-1"}),"품목 추가"]}),t.jsxs(n,{variant:"default",size:"sm",onClick:async()=>{try{await O.from("purchase_request_items").delete().eq("purchase_request_id",b.id);const e=S.map(e=>({purchase_request_id:b.id,purchase_order_number:b.purchase_order_number,line_number:e.line_number,item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark,link:e.link,is_received:e.is_received||!1,delivery_status:e.delivery_status||"pending"})),{error:t}=await O.from("purchase_request_items").insert(e);if(t)throw t;const s=S.reduce((e,a)=>e+(a.amount_value||0),0);await O.from("purchase_requests").update({total_amount:s}).eq("id",b.id),f.success("품목이 수정되었습니다."),B(!1),D(),a()}catch(e){f.error("저장 중 오류가 발생했습니다.")}},children:[t.jsx(T,{className:"h-4 w-4 mr-1"}),"저장"]}),t.jsx(n,{variant:"ghost",size:"sm",onClick:()=>{B(!1),L(b.items||[])},children:"취소"})]}),t.jsx(n,{variant:"ghost",size:"icon",onClick:a,className:"h-6 w-6",children:t.jsx(r,{className:"h-4 w-4"})})]})]})}),t.jsxs("div",{className:"flex-shrink-0 grid grid-cols-2 md:grid-cols-4 gap-3 py-3 border-b",children:[t.jsxs("div",{children:[t.jsx("p",{className:"modal-label",children:"업체명"}),t.jsx("p",{className:"modal-value",children:b.vendor_name})]}),t.jsxs("div",{children:[t.jsx("p",{className:"modal-label",children:"요청자"}),t.jsx("p",{className:"modal-value",children:b.requester_name})]}),t.jsxs("div",{children:[t.jsx("p",{className:"modal-label",children:"프로젝트"}),t.jsx("p",{className:"modal-value truncate",title:b.project_vendor,children:b.project_vendor})]}),t.jsxs("div",{children:[t.jsx("p",{className:"modal-label",children:"납기일"}),t.jsx("p",{className:"modal-value",children:b.delivery_request_date&&k(new Date(b.delivery_request_date),"yyyy-MM-dd")})]})]}),t.jsx("div",{className:"flex-1 overflow-auto",children:t.jsxs(h,{children:[t.jsx(x,{className:"sticky top-0 bg-white z-10",children:t.jsxs(p,{children:[t.jsx(j,{className:"w-12",children:"No."}),t.jsx(j,{children:"품목"}),t.jsx(j,{children:"규격"}),t.jsx(j,{className:"text-right",children:"수량"}),t.jsx(j,{className:"text-right",children:"단가"}),t.jsx(j,{className:"text-right",children:"금액"}),t.jsx(j,{children:"purchase"===z?"구매상태":"입고상태"}),t.jsx(j,{children:"영수증"}),"done"===z&&t.jsxs(t.Fragment,{children:[t.jsx(j,{className:"text-center",children:"거래명세서 확인"}),t.jsx(j,{className:"text-center",children:"회계상 입고일"}),t.jsx(j,{className:"text-center",children:"처리자"})]}),"receipt"===z&&t.jsxs(t.Fragment,{children:[t.jsx(j,{className:"text-center",children:"실제 입고일"}),t.jsx(j,{className:"text-center",children:"처리자"})]}),t.jsx(j,{children:"비고"}),E&&t.jsx(j,{className:"w-20",children:"삭제"})]})}),t.jsx(g,{children:I.map((e,a)=>t.jsxs(p,{children:[t.jsx(_,{className:"modal-value",children:e.line_number||a+1}),t.jsx(_,{children:E?t.jsx(u,{value:e.item_name,onChange:e=>H(a,"item_name",e.target.value),className:"h-7 modal-label"}):t.jsx("div",{className:"sm:max-w-[200px]",children:t.jsx("p",{className:"modal-value truncate",title:e.item_name,children:e.item_name})})}),t.jsx(_,{children:E?t.jsx(u,{value:e.specification,onChange:e=>H(a,"specification",e.target.value),className:"h-7 modal-label"}):t.jsx("div",{className:"sm:max-w-[150px] truncate",title:e.specification,children:e.specification})}),t.jsx(_,{className:"text-right",children:E?t.jsx(u,{type:"number",value:e.quantity,onChange:e=>H(a,"quantity",e.target.value),className:"h-7 text-xs text-right"}):t.jsx("span",{className:"modal-value",children:e.quantity.toLocaleString()})}),t.jsx(_,{className:"text-right",children:E?t.jsx(u,{type:"number",value:e.unit_price_value,onChange:e=>H(a,"unit_price_value",e.target.value),className:"h-7 text-xs text-right"}):t.jsxs("span",{className:"modal-subtitle",children:[(e.unit_price_value||0).toLocaleString()," ",b.currency]})}),t.jsx(_,{className:"text-right",children:E?t.jsx(u,{type:"number",value:e.amount_value,onChange:e=>H(a,"amount_value",e.target.value),className:"h-7 modal-label text-right"}):t.jsxs("span",{className:"modal-value",children:[(e.amount_value||0).toLocaleString()," ",b.currency]})}),t.jsx(_,{children:"receipt"===z?A?$.isCompleted(e)?t.jsx("button",{onClick:()=>{$.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-base bg-green-500 hover:bg-green-600 text-white transition-colors",title:"클릭하여 실제 입고 처리 취소",children:$.config.completedText}):t.jsx(w,{onDateSelect:a=>{$.handleConfirm(e.id,a,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"실제 입고 날짜 선택",children:t.jsx(n,{variant:"outline",size:"sm",className:"button-base border border-gray-300 text-gray-600 bg-white hover:bg-gray-50",children:$.config.waitingText})}):t.jsx("span",{className:"button-base "+($.isCompleted(e)?"bg-green-500 text-white":"border border-gray-300 text-gray-400 bg-white"),children:$.isCompleted(e)?$.config.completedText:$.config.waitingText}):e.is_received?t.jsx(v,{variant:null,className:"badge-success",children:"입고완료"}):t.jsx(v,{variant:null,className:"badge-secondary",children:"대기"})}),t.jsx(_,{className:"text-center",children:t.jsx(M,{itemId:Number(e.id),receiptUrl:e.receipt_image_url,itemName:e.item_name,paymentCategory:b.payment_category,onUpdate:D})}),"done"===z&&t.jsxs(t.Fragment,{children:[t.jsx(_,{className:"text-center",children:A?P.isCompleted(e)?t.jsx("button",{onClick:()=>{P.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-base bg-green-500 hover:bg-green-600 text-white transition-colors",title:"클릭하여 거래명세서 확인 취소",children:P.config.completedText}):t.jsx(w,{onDateSelect:a=>{P.handleConfirm(e.id,a,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"날짜 선택",children:t.jsx(n,{variant:"outline",size:"sm",className:"button-base border border-gray-300 text-gray-600 bg-white hover:bg-gray-50",children:P.config.waitingText})}):t.jsx("span",{className:"button-base "+(P.isCompleted(e)?"bg-green-500 text-white":"border border-gray-300 text-gray-400 bg-white"),children:P.isCompleted(e)?P.config.completedText:P.config.waitingText})}),t.jsx(_,{className:"text-center",children:P.getCompletedDate(e)?t.jsx("span",{className:"modal-subtitle",children:k(new Date(P.getCompletedDate(e)),"yyyy-MM-dd")}):t.jsx("span",{className:"modal-subtitle",children:"-"})}),t.jsx(_,{className:"text-center",children:P.getCompletedByName(e)?t.jsx("span",{className:"modal-subtitle",children:P.getCompletedByName(e)}):t.jsx("span",{className:"modal-subtitle",children:"-"})})]}),"receipt"===z&&t.jsxs(t.Fragment,{children:[t.jsx(_,{className:"text-center",children:$.getCompletedDate(e)?t.jsx("span",{className:"modal-subtitle text-green-600",children:k(new Date($.getCompletedDate(e)),"yyyy-MM-dd HH:mm")}):t.jsx("span",{className:"modal-subtitle",children:"-"})}),t.jsx(_,{className:"text-center",children:$.getCompletedByName(e)?t.jsx("span",{className:"modal-subtitle",children:$.getCompletedByName(e)}):t.jsx("span",{className:"modal-subtitle",children:"-"})})]}),t.jsx(_,{children:E?t.jsx(u,{value:e.remark||"",onChange:e=>H(a,"remark",e.target.value),className:"h-7 modal-label",placeholder:"비고"}):t.jsx("div",{className:"sm:max-w-[150px]",children:t.jsx("span",{className:"modal-subtitle truncate block",title:e.remark,children:e.remark||"-"})})}),E&&t.jsx(_,{children:t.jsx(n,{variant:"ghost",size:"icon",onClick:()=>(e=>{const a=S.filter((a,t)=>t!==e);a.forEach((e,a)=>{e.line_number=a+1}),L(a)})(a),className:"h-7 w-7 text-red-500 hover:text-red-700",children:t.jsx(U,{className:"h-4 w-4"})})})]},e.id||a))})]})}),t.jsxs("div",{className:"flex-shrink-0 border-t pt-4 flex justify-between items-center",children:[t.jsxs("div",{className:"modal-subtitle",children:["총 ",I.length,"개 품목"]}),t.jsxs("div",{className:"modal-value-large",children:["총 금액: ",V.toLocaleString()," ",b.currency]})]})]})})}export{z as default};
//# sourceMappingURL=PurchaseItemsModal-CGRN2RoP.js.map
