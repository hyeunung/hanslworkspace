import{r as e,c as t,d as a,l as s,j as r,B as i,X as n}from"./index-BvgUOoDT.js";import{D as l,a as c,b as m,c as o,P as d,I as u}from"./dialog-DdzUS4Ws.js";import{t as p}from"./index-CFnxfa1n.js";import{f as x,D as h}from"./react-select.esm-B52KLWOb.js";import{u as g,d as _}from"./PurchaseDetailModal-CCHz74r9.js";import{S as y}from"./save-BaaXvmMI.js";import{T as j}from"./card-Wm6gpivN.js";import"./chevron-right-BrDLAKzG.js";import"./chevron-down-CoVvPEu-.js";import"./popover-Bde3Div9.js";import"./helpers-CmqE03mo.js";import"./textarea-joNJfKvn.js";import"./calendar-Bl9nu6EP.js";import"./check-7yeTsVP_.js";import"./credit-card-DT2RYO8x.js";import"./loader-circle-s52mQtgW.js";function v({isOpen:v,onClose:b,purchase:f,isAdmin:w,onUpdate:N,activeTab:q="done"}){const[k,C]=e.useState(f.purchase_request_items||[]),[M,S]=e.useState(!1),[T,D]=e.useState(""),z=t();e.useEffect(()=>{v&&(async()=>{try{const{data:{user:e}}=await z.auth.getUser();if(e?.email){const{data:t}=await z.from("employees").select("name").eq("email",e.email).single();D(t?.name?t.name:e.email)}if(f.id){const{data:e}=await z.from("purchase_request_items").select("*").eq("purchase_request_id",f.id).order("line_number");e&&C(e)}}catch(e){s.error("데이터 로드 실패",e),D("사용자")}})()},[v,z,f.id]);const E=e.useRef(!0);e.useEffect(()=>{if(!v)return;const e=a(()=>{E.current?E.current=!1:N?.()});return()=>e()},[v,N]);const L=w||f?.requester_name===T,A=e.useCallback(async()=>{if(f.id)try{const{data:e}=await z.from("purchase_request_items").select("*").eq("purchase_request_id",f.id).order("line_number");e&&C(e)}catch(e){s.error("모달 데이터 새로고침 실패",e)}},[f.id,z]),I=g({config:{field:"statement_received",confirmMessage:{confirm:"거래명세서 확인을 처리하시겠습니까?",cancel:"거래명세서 확인을 취소하시겠습니까?"},successMessage:{confirm:"거래명세서 확인이 완료되었습니다.",cancel:"거래명세서 확인이 취소되었습니다."},completedText:"✓ 완료",waitingText:"대기"},currentUserName:T,canPerformAction:L,purchaseId:f.id,onUpdate:A}),U=g({config:{field:"actual_received",confirmMessage:{confirm:"실제 입고 처리를 진행하시겠습니까?",cancel:"실제 입고 처리를 취소하시겠습니까?"},successMessage:{confirm:"실제 입고 처리가 완료되었습니다.",cancel:"실제 입고 처리가 취소되었습니다."},completedText:"입고완료",waitingText:"입고대기"},currentUserName:T,canPerformAction:L,purchaseId:f?.id,onUpdate:A}),$=(e,t,a)=>{const s=[...k];if(s[e]={...s[e],[t]:"quantity"===t||"unit_price_value"===t||"amount_value"===t?Number(a):a},"quantity"===t||"unit_price_value"===t){const t=s[e].quantity||0,a=s[e].unit_price_value||0;s[e].amount_value=a>0?t*a:0}C(s)},B=k.length>0?k:f.purchase_request_items||[],P=M?k:B,F=e.useMemo(()=>{const e=P.length>0?P:B;if(!e||0===e.length)return 960;const t=[{key:"line_number",base:32,header:"#",accessor:(e,t)=>`${e.line_number||t+1}`},{key:"item_name",base:150,max:320,header:"품목",accessor:e=>e.item_name},{key:"specification",base:150,max:320,header:"규격",accessor:e=>e.specification},{key:"quantity",base:90,header:"수량",accessor:e=>null!=e.quantity?e.quantity.toLocaleString():""},{key:"unit_price_value",base:120,header:"단가",accessor:e=>null!=e.unit_price_value?e.unit_price_value.toLocaleString():""},{key:"amount_value",base:140,header:"금액",accessor:e=>null!=e.amount_value?e.amount_value.toLocaleString():""},{key:"remark",base:140,max:320,header:"비고",accessor:e=>e.remark}].map((t,a)=>{const s=e.map((e,a)=>t.accessor?t.accessor(e,a)??"":""),r=t.header?t.header.length:0,i=8*Math.max(r,...s.map(e=>e?String(e).length:0))+32,n=t.max?Math.min(t.max,i):i;return Math.max(t.base,n)});"purchase"===q&&t.push(120),"receipt"!==q&&"done"!==q||t.push(120),"receipt"===q&&t.push(140),"done"===q&&t.push(140,140,110),M&&t.push(100);const a=t.length>1?16*(t.length-1):0,s=t.reduce((e,t)=>e+t,0)+a+48;return Math.max(s,960)},[P,B,q,M]),O=P.reduce((e,t)=>e+(t.amount_value||0),0);return r.jsx(l,{open:v,onOpenChange:b,children:r.jsxs(c,{className:"w-full sm:w-auto max-w-[92vw] sm:max-w-[88vw] lg:max-w-[90vw] xl:max-w-[85vw] h-[95vh] sm:h-auto max-h-[90vh] flex flex-col bg-white p-3 sm:p-6",maxWidth:"max-w-none",showCloseButton:!1,children:[r.jsx(m,{className:"flex-shrink-0",children:r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs(o,{className:"modal-title",children:["발주 상세 항목 - ",f.purchase_order_number]}),r.jsxs("div",{className:"flex items-center gap-2",children:[w&&!M&&r.jsxs(i,{variant:"outline",size:"sm",onClick:()=>{S(!0),C([...f.purchase_request_items||[]])},children:[r.jsx(_,{className:"h-4 w-4 mr-1"}),"편집"]}),M&&r.jsxs(r.Fragment,{children:[r.jsxs(i,{variant:"outline",size:"sm",onClick:()=>{const e={line_number:k.reduce((e,t)=>{const a=t.line_number||0;return a>e?a:e},0)+1,item_name:"",specification:"",quantity:1,unit_price_value:void 0,amount_value:0,remark:"",is_received:!1},t=[...k,e].sort((e,t)=>(e.line_number||999999)-(t.line_number||999999));C(t)},children:[r.jsx(d,{className:"h-4 w-4 mr-1"}),"품목 추가"]}),r.jsxs(i,{variant:"default",size:"sm",onClick:async()=>{try{if(k.filter(e=>!e.item_name||!e.item_name.trim()).length>0)return void p.error("품목명은 필수 입력 항목입니다.");const{error:e}=await z.from("purchase_request_items").delete().eq("purchase_request_id",f.id);if(e)throw s.error("기존 품목 삭제 실패",e),e;const t=k.map(e=>({purchase_request_id:f.id,purchase_order_number:f.purchase_order_number,line_number:e.line_number,item_name:e.item_name.trim(),specification:e.specification||"",quantity:Number(e.quantity)||0,unit_price_value:null!==e.unit_price_value&&void 0!==e.unit_price_value?Number(e.unit_price_value):null,amount_value:Number(e.amount_value)||0,remark:e.remark||"",link:e.link||null,is_received:e.is_received||!1,delivery_status:e.delivery_status||"pending"})),{error:a}=await z.from("purchase_request_items").insert(t);if(a)throw s.error("품목 삽입 실패",a),a;const r=k.reduce((e,t)=>e+(Number(t.amount_value)||0),0),{error:i}=await z.from("purchase_requests").update({total_amount:r}).eq("id",f.id);if(i)throw s.error("총금액 업데이트 실패",i),i;p.success("품목이 수정되었습니다."),S(!1),N(),b()}catch(e){s.error("품목 저장 중 오류",e),p.error(`저장 중 오류가 발생했습니다: ${e instanceof Error?e.message:e}`)}},children:[r.jsx(y,{className:"h-4 w-4 mr-1"}),"저장"]}),r.jsx(i,{variant:"ghost",size:"sm",onClick:()=>{S(!1),C(f.purchase_request_items||[])},children:"취소"})]}),r.jsx(i,{variant:"ghost",size:"icon",onClick:b,className:"h-6 w-6",children:r.jsx(n,{className:"h-4 w-4"})})]})]})}),r.jsxs("div",{className:"flex-shrink-0 grid grid-cols-2 md:grid-cols-4 gap-3 py-3 border-b",children:[r.jsxs("div",{children:[r.jsx("p",{className:"modal-label",children:"업체명"}),r.jsx("p",{className:"modal-value",children:f.vendor_name})]}),r.jsxs("div",{children:[r.jsx("p",{className:"modal-label",children:"요청자"}),r.jsx("p",{className:"modal-value",children:f.requester_name})]}),r.jsxs("div",{children:[r.jsx("p",{className:"modal-label",children:"프로젝트"}),r.jsx("p",{className:"modal-value truncate",title:f.project_vendor,children:f.project_vendor})]}),r.jsxs("div",{children:[r.jsx("p",{className:"modal-label",children:"납기일"}),r.jsx("p",{className:"modal-value",children:f.delivery_request_date&&x(new Date(f.delivery_request_date),"yyyy-MM-dd")})]})]}),r.jsx("div",{className:"flex-1 min-h-0",children:r.jsx("div",{className:"h-full overflow-x-auto",children:r.jsx("div",{className:"inline-block align-top",style:{minWidth:`${F}px`},children:r.jsx("div",{className:"max-h-[60vh] overflow-y-auto",children:r.jsxs("table",{className:"w-full text-[13px] leading-[1.6] border-collapse",style:{minWidth:`${F}px`},children:[r.jsx("thead",{className:"sticky top-0 bg-white z-10 shadow-sm",children:r.jsxs("tr",{children:[r.jsx("th",{className:"py-2 text-center font-medium text-gray-600 w-[32px] min-w-[32px]",children:"#"}),r.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-600 min-w-[140px]",children:"품목"}),r.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-600 min-w-[120px]",children:"규격"}),r.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-600 min-w-[80px]",children:"수량"}),r.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-600 min-w-[110px]",children:"단가"}),r.jsx("th",{className:"px-3 py-2 text-right font-medium text-gray-600 min-w-[130px]",children:"금액"}),"purchase"===q&&r.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-600 min-w-[110px]",children:"구매상태"}),("receipt"===q||"done"===q)&&r.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-600 min-w-[110px]",children:"입고상태"}),"done"===q&&r.jsxs(r.Fragment,{children:[r.jsx("th",{className:"px-3 py-2 text-center font-medium text-gray-600 min-w-[130px]",children:"거래명세서 확인"}),r.jsx("th",{className:"px-3 py-2 text-center font-medium text-gray-600 min-w-[130px]",children:"회계상 입고일"}),r.jsx("th",{className:"px-3 py-2 text-center font-medium text-gray-600 min-w-[90px]",children:"처리자"})]}),"receipt"===q&&r.jsx("th",{className:"px-3 py-2 text-center font-medium text-gray-600 min-w-[130px]",children:"실제 입고일"}),r.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-600 min-w-[110px]",children:"비고"}),M&&r.jsx("th",{className:"px-3 py-2 text-left font-medium text-gray-600 w-20 min-w-[90px]",children:"삭제"})]})}),r.jsx("tbody",{children:(M?k:P).map((e,t)=>r.jsxs("tr",{className:"border-b last:border-b-0",children:[r.jsx("td",{className:"py-2 text-center align-top modal-value",children:e.line_number||t+1}),r.jsx("td",{className:"px-3 py-2 align-top min-w-[140px]",children:M?r.jsx(u,{value:e.item_name,onChange:e=>$(t,"item_name",e.target.value),className:"h-7 modal-label w-full"}):r.jsx("div",{className:"max-w-[200px]",children:r.jsx("p",{className:"modal-value truncate",title:e.item_name,children:e.item_name})})}),r.jsx("td",{className:"px-3 py-2 align-top min-w-[120px]",children:M?r.jsx(u,{value:e.specification,onChange:e=>$(t,"specification",e.target.value),className:"h-7 modal-label w-full"}):r.jsx("div",{className:"max-w-[150px] truncate",title:e.specification,children:e.specification})}),r.jsx("td",{className:"px-3 py-2 text-right align-top min-w-[80px]",children:M?r.jsx(u,{type:"number",value:e.quantity,onChange:e=>$(t,"quantity",e.target.value),className:"h-7 text-xs text-right w-full"}):r.jsx("div",{className:"text-right",children:r.jsx("span",{className:"modal-value",style:{display:"block",textAlign:"right"},children:e.quantity.toLocaleString()})})}),r.jsx("td",{className:"px-3 py-2 text-right align-top min-w-[110px]",children:M?r.jsx(u,{type:"number",value:e.unit_price_value,onChange:e=>$(t,"unit_price_value",e.target.value),className:"h-7 text-xs text-right w-full"}):r.jsx("div",{className:"text-right",children:r.jsxs("span",{className:"modal-subtitle",style:{display:"block",textAlign:"right"},children:[(e.unit_price_value||0).toLocaleString()," ",f.currency]})})}),r.jsx("td",{className:"px-3 py-2 text-right align-top min-w-[130px]",children:M?r.jsx(u,{type:"number",value:e.amount_value,onChange:e=>$(t,"amount_value",e.target.value),className:"h-7 modal-label text-right w-full"}):r.jsx("div",{className:"text-right",children:r.jsxs("span",{className:"modal-value",style:{display:"block",textAlign:"right"},children:[(e.amount_value||0).toLocaleString()," ",f.currency]})})}),"purchase"===q&&r.jsx("td",{className:"px-3 py-2 align-top min-w-[110px]",children:L?e.is_payment_completed?r.jsx("button",{onClick:async()=>{try{if(!e.id)throw new Error("품목 ID가 없습니다.");const{error:t,data:a}=await z.from("purchase_request_items").update({is_payment_completed:!1}).eq("id",e.id).select();if(t)throw s.error("구매취소 업데이트 실패",t),t;p.success("구매 취소 처리되었습니다."),await A()}catch(t){s.error("구매취소 처리 중 오류",t),p.error(`처리 중 오류가 발생했습니다: ${t instanceof Error?t.message:t}`)}},className:"button-base bg-green-500 hover:bg-green-600 text-white transition-colors",title:"클릭하여 구매 취소",children:"구매완료"}):r.jsx("button",{onClick:async()=>{try{if(!e.id)throw new Error("품목 ID가 없습니다.");const t=(new Date).toISOString(),{error:a,data:r}=await z.from("purchase_request_items").update({is_payment_completed:!0,payment_completed_at:t}).eq("id",e.id).select();if(a)throw s.error("구매완료 업데이트 실패",a),a;const i=P.map(t=>t.id===e.id?{...t,is_payment_completed:!0}:t);i.every(e=>!0===e.is_payment_completed)&&f?.id&&await z.from("purchase_requests").update({is_payment_completed:!0,payment_completed_at:t}).eq("id",f.id),p.success("구매완료 처리되었습니다."),await A()}catch(t){s.error("구매완료 처리 중 오류",t),p.error(`처리 중 오류가 발생했습니다: ${t instanceof Error?t.message:t}`)}},className:"button-base border border-gray-300 text-gray-600 bg-white hover:bg-gray-50",children:"구매대기"}):r.jsx("span",{className:"button-base "+(e.is_payment_completed?"bg-green-500 text-white":"border border-gray-300 text-gray-400 bg-white"),children:e.is_payment_completed?"구매완료":"구매대기"})}),("receipt"===q||"done"===q)&&r.jsx("td",{className:"px-3 py-2 align-top min-w-[110px]",children:"receipt"===q?L?U.isCompleted(e)?r.jsx("button",{onClick:()=>{U.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-base bg-green-500 hover:bg-green-600 text-white transition-colors",title:"클릭하여 실제 입고 처리 취소",children:U.config.completedText}):r.jsx(h,{onDateSelect:t=>{U.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"실제 입고 날짜 선택",children:r.jsx(i,{variant:"outline",size:"sm",className:"button-base border border-gray-300 text-gray-600 bg-white hover:bg-gray-50",children:U.config.waitingText})}):r.jsx("span",{className:"button-base "+(U.isCompleted(e)?"bg-green-500 text-white":"border border-gray-300 text-gray-400 bg-white"),children:U.isCompleted(e)?U.config.completedText:U.config.waitingText}):r.jsx("span",{className:"button-base "+(U.isCompleted(e)?"bg-green-500 text-white":"border border-gray-300 text-gray-600 bg-white"),children:U.isCompleted(e)?U.config.completedText:U.config.waitingText})}),"receipt"===q&&r.jsx("td",{className:"px-3 py-2 text-center align-top min-w-[130px]",children:U.getCompletedDate(e)?r.jsx("span",{className:"modal-subtitle text-green-600",children:x(new Date(U.getCompletedDate(e)),"yyyy-MM-dd HH:mm")}):r.jsx("span",{className:"modal-subtitle",children:"-"})}),"done"===q&&r.jsxs(r.Fragment,{children:[r.jsx("td",{className:"px-3 py-2 text-center align-top min-w-[130px]",children:L?I.isCompleted(e)?r.jsx("button",{onClick:()=>{I.handleCancel(e.id,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},className:"button-base bg-green-500 hover:bg-green-600 text-white transition-colors",title:"클릭하여 거래명세서 확인 취소",children:I.config.completedText}):r.jsx(h,{onDateSelect:t=>{I.handleConfirm(e.id,t,{item_name:e.item_name,specification:e.specification,quantity:e.quantity,unit_price_value:e.unit_price_value,amount_value:e.amount_value,remark:e.remark})},placeholder:"날짜 선택",children:r.jsx(i,{variant:"outline",size:"sm",className:"button-base border border-gray-300 text-gray-600 bg-white hover:bg-gray-50",children:I.config.waitingText})}):r.jsx("span",{className:"button-base "+(I.isCompleted(e)?"bg-green-500 text-white":"border border-gray-300 text-gray-400 bg-white"),children:I.isCompleted(e)?I.config.completedText:I.config.waitingText})}),r.jsx("td",{className:"px-3 py-2 text-center align-top min-w-[130px]",children:I.getCompletedDate(e)?r.jsx("span",{className:"modal-subtitle",children:x(new Date(I.getCompletedDate(e)),"yyyy-MM-dd")}):r.jsx("span",{className:"modal-subtitle",children:"-"})}),r.jsx("td",{className:"px-3 py-2 text-center align-top min-w-[90px]",children:I.getCompletedByName(e)?r.jsx("span",{className:"modal-subtitle",children:I.getCompletedByName(e)}):r.jsx("span",{className:"modal-subtitle",children:"-"})})]}),r.jsx("td",{className:"px-3 py-2 align-top min-w-[110px]",children:M?r.jsx(u,{value:e.remark||"",onChange:e=>$(t,"remark",e.target.value),className:"h-7 modal-label w-full",placeholder:"비고"}):r.jsx("div",{className:"max-w-[150px]",children:r.jsx("span",{className:"modal-subtitle truncate block",title:e.remark,children:e.remark||"-"})})}),M&&r.jsx("td",{className:"px-3 py-2 align-top min-w-[90px]",children:r.jsx(i,{variant:"ghost",size:"icon",onClick:()=>(e=>{const t=k.filter((t,a)=>a!==e).sort((e,t)=>(e.line_number||999999)-(t.line_number||999999));C(t)})(t),className:"h-7 w-7 text-red-500 hover:text-red-700",children:r.jsx(j,{className:"h-4 w-4"})})})]},e.id||t))})]})})})})}),r.jsxs("div",{className:"flex-shrink-0 border-t pt-4 flex justify-between items-center",children:[r.jsxs("div",{className:"modal-subtitle",children:["총 ",P.length,"개 품목"]}),r.jsxs("div",{className:"modal-value-large",children:["총 금액: ",O.toLocaleString()," ",f.currency]})]})]})})}export{v as default};
//# sourceMappingURL=PurchaseItemsModal-wIojfJz8.js.map
