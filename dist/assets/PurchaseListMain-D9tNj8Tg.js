const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/FastPurchaseTable-N8DpHqXO.js","assets/index-rMBGTd87.js","assets/index-D9oJljUO.css","assets/index-DiLU9-tm.js","assets/PurchaseDetailModal-B5CvhOPO.js","assets/helpers-Buk9LCEc.js","assets/useConfirmDateAction-CZG_EaPY.js","assets/format-CcjXrrmY.js","assets/chevron-right-JNINHwx9.js","assets/chevron-down-C-Hhx38H.js","assets/popover-DNAXKSVZ.js","assets/input-pxWhe-9G.js","assets/calendar-mVGv9M0P.js","assets/check-CjyzQNti.js","assets/package-BWVZ-jU5.js","assets/credit-card-DmlxYJGN.js","assets/trash-2-CNF6PH9J.js","assets/plus-B0MG206g.js","assets/save-DdIxjnq2.js","assets/eye-eY77KLcz.js","assets/PurchaseItemsModal-CeBKmauh.js","assets/table-CG5Zc0D8.js"])))=>i.map(i=>d[i]);
import{r as e,a as t,l as s,j as r,_ as a,u as n,e as i,B as l}from"./index-rMBGTd87.js";import{t as c,B as o}from"./index-DiLU9-tm.js";import{C as u,c as m}from"./card-CbG2ntnB.js";import{P as d}from"./plus-B0MG206g.js";import{P as p}from"./package-BWVZ-jU5.js";const _={purchases:null,vendors:null,employees:null,lastFetch:0,userInfo:null,CACHE_DURATION:3e5,filteredData:new Map,FILTER_CACHE_DURATION:3e4},h=e=>{_.filteredData.clear()};const f=["정희웅"],g=(s,r,a,n,i)=>{t();const[l,c]=e.useState("pending"),[o,u]=e.useState(""),[m,d]=e.useState(""),[p,_]=e.useState(""),[h,g]=e.useState(""),[y,v]=e.useState(""),[b,w]=e.useState(""),[x,j]=e.useState(""),[S,N]=e.useState(""),q=function(t,s=500){const[r,a]=e.useState(t);return e.useEffect(()=>{const e=setTimeout(()=>{a(t)},s);return()=>{clearTimeout(e)}},[t,s]),r}(o,300),C=r?.includes("app_admin");r?.includes("final_approver"),r?.includes("middle_manager");const T=r?.includes("purchase_manager"),k=r?.includes("raw_material_manager")||r?.includes("consumable_manager")||r?.includes("purchase_manager"),L=e.useMemo(()=>r&&0!==r.length?T?2:r.some(e=>["middle_manager","final_approver","app_admin","ceo"].includes(e))?3:1:1,[r,T]),F=e.useCallback(e=>{if(!a)return"all";if("purchase"===e)return k||C?"all":a;switch(L){case 1:case 2:return"done"===e?"all":a;case 3:return"all";default:return a}},[a,L,k,C]);e.useEffect(()=>{if(!a)return;const e=F(l);_(e)},[l,a,L,F]);const I=e.useMemo(()=>r.includes("purchase_manager")||r.includes("app_admin")?s:s.filter(e=>!f.includes(e.requester_name)),[s,r]),O=e.useMemo(()=>{(new Date).toISOString().split("T")[0];return I.filter(e=>{let t=!1;switch(l){case"pending":const s=["pending","대기","",null,void 0].includes(e.middle_manager_status),r=["pending","대기","",null,void 0].includes(e.final_manager_status),a="rejected"===e.middle_manager_status,n="rejected"===e.final_manager_status;if(a||n)return!1;const i="approved"===e.middle_manager_status,l="approved"===e.final_manager_status;return(!i||!l)&&(t=s||r,t);case"purchase":{const s="구매 요청"===e.payment_category,r=(e.progress_type||"").includes("선진행"),a=(e.progress_type||"").includes("일반"),n="approved"===e.final_manager_status;return!e.is_payment_completed&&(t=!!s&&(r||a&&n),t)}case"receipt":{const s=(e.progress_type||"").includes("선진행"),r="approved"===e.final_manager_status;return!e.is_received&&(t=s||r,t)}case"done":return t=!0,t;default:return!0}})},[I,l]),P=e.useMemo(()=>{let e;return e=p&&"all"!==p&&"전체"!==p?O.filter(e=>e.requester_name===p):O,e},[O,p]),E=e.useMemo(()=>m?P.filter(e=>e.vendor_name===m):P,[P,m]),R=e.useMemo(()=>{let e=E;if(h){const t=h.trim().toLowerCase();e=e.filter(e=>e.purchase_order_number?.toLowerCase().includes(t))}if(y){const t=y.trim().toLowerCase();e=e.filter(e=>!!(e.items&&e.items.length>0)&&e.items.some(e=>e.item_name?.toLowerCase().includes(t)))}if(b){const t=b.trim().toLowerCase();e=e.filter(e=>!!(e.items&&e.items.length>0)&&e.items.some(e=>e.specification?.toLowerCase().includes(t)))}if(x&&"all"!==x&&(e=e.filter(e=>{switch(x){case"pending":return!e.final_manager_status||"pending"===e.final_manager_status||"대기"===e.final_manager_status;case"approved":return"approved"===e.final_manager_status;case"rejected":return"rejected"===e.final_manager_status||"rejected"===e.middle_manager_status;default:return!0}})),S){const t=S.trim().toLowerCase();e=e.filter(e=>!!(e.items&&e.items.length>0)&&e.items.some(e=>e.remark?.toLowerCase().includes(t)))}return e},[E,h,y,b,x,S]),A=e.useMemo(()=>{if(!q)return R;const e=q.trim().toLowerCase();return R.filter(t=>!!(t.purchase_order_number?.toLowerCase().includes(e)||t.vendor_name?.toLowerCase().includes(e)||t.requester_name?.toLowerCase().includes(e)||t.project_vendor?.toLowerCase().includes(e))||!!(t.items&&t.items.length>0)&&t.items.some(t=>t.item_name&&t.item_name.toLowerCase().includes(e)||t.specification&&t.specification.toLowerCase().includes(e)))},[R,q]),M=e.useMemo(()=>[...A].sort((e,t)=>{const s=e.request_date?new Date(e.request_date).getTime():0;return(t.request_date?new Date(t.request_date).getTime():0)-s}),[A]),D=e.useMemo(()=>{const e=I,t=e=>new Set(e.map(e=>e.purchase_order_number)).size,s=t=>{if("purchase"===t)return k||C?e:e.filter(e=>e.requester_name===a);const s=F(t);return"all"===s||"전체"===s?e:e.filter(e=>e.requester_name===s)},r=s("pending"),n=s("purchase"),i=s("receipt"),l=s("done"),c=r.filter(e=>{(new Date).toISOString().split("T")[0];const t=["pending","대기","",null,void 0].includes(e.middle_manager_status),s=["pending","대기","",null,void 0].includes(e.final_manager_status),r="rejected"===e.middle_manager_status,a="rejected"===e.final_manager_status;if(r||a)return!1;const n="approved"===e.middle_manager_status,i="approved"===e.final_manager_status;return(!n||!i)&&(t||s)}),o=n.filter(e=>{(new Date).toISOString().split("T")[0];const t="구매 요청"===e.payment_category,s=(e.progress_type||"").includes("선진행"),r=(e.progress_type||"").includes("일반"),a="approved"===e.final_manager_status;return!e.is_payment_completed&&(!!t&&(s||r&&a))}),u=i.filter(e=>{(new Date).toISOString().split("T")[0];const t=(e.progress_type||"").includes("선진행"),s="approved"===e.final_manager_status;return!e.is_received&&(t||s)});return{pending:t(c),purchase:t(o),receipt:t(u),done:t(l)}},[I,L,a,F,k,C]);return{activeTab:l,searchTerm:o,vendorFilter:m,selectedEmployee:p,purchaseNumberFilter:h,itemNameFilter:y,specificationFilter:b,approvalStatusFilter:x,remarkFilter:S,setActiveTab:c,setSearchTerm:u,setVendorFilter:d,setSelectedEmployee:_,setPurchaseNumberFilter:g,setItemNameFilter:v,setSpecificationFilter:w,setApprovalStatusFilter:j,setRemarkFilter:N,filteredPurchases:M,tabCounts:D}},y=e.lazy(()=>a(()=>import("./FastPurchaseTable-N8DpHqXO.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19]))),v=e.memo(()=>r.jsx("div",{className:"p-4 space-y-4",children:[...Array(5)].map((e,t)=>r.jsxs("div",{className:"flex space-x-4 animate-pulse",children:[r.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4"}),r.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4"}),r.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4"}),r.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4"})]},t))}));v.displayName="TableSkeleton";const b=e.memo(({purchases:t,activeTab:s,currentUserRoles:a,onRefresh:n,onOptimisticUpdate:i,onPaymentComplete:l,onReceiptComplete:c})=>r.jsx(e.Suspense,{fallback:r.jsx(v,{}),children:r.jsx(y,{purchases:t,activeTab:s,currentUserRoles:a,onRefresh:n,onOptimisticUpdate:i,onPaymentComplete:l,onReceiptComplete:c})}));b.displayName="LazyPurchaseTable";class w{constructor(){this.measurements=new Map,this.SLOW_THRESHOLD=1e3}static getInstance(){return w.instance||(w.instance=new w),w.instance}startMeasure(e){this.measurements.set(e,performance.now())}endMeasure(e,t){const r=this.measurements.get(e);if(!r)return s.warn("성능 측정 시작 시간을 찾을 수 없습니다",{key:e}),0;const a=performance.now()-r;this.measurements.delete(e);const n=a>this.SLOW_THRESHOLD;return s[n?"warn":"debug"](`⚡ 성능 측정: ${e}`,{duration:`${a.toFixed(2)}ms`,context:t,isSlow:n,threshold:`${this.SLOW_THRESHOLD}ms`}),a}async measureAsync(e,t,s){this.startMeasure(e);try{const r=await t();return this.endMeasure(e,s),r}catch(r){throw this.endMeasure(e,`Error: ${s}`),r}}measureSync(e,t,s){this.startMeasure(e);try{const r=t();return this.endMeasure(e,s),r}catch(r){throw this.endMeasure(e,`Error: ${s}`),r}}}const x=w.getInstance(),j=e.lazy(()=>a(()=>import("./PurchaseItemsModal-CeBKmauh.js"),__vite__mapDeps([20,1,2,11,21,3,6,7,8,9,10,17,18,16]))),S=[{key:"pending",label:"승인대기"},{key:"purchase",label:"구매 현황"},{key:"receipt",label:"입고 현황"},{key:"done",label:"전체 항목"}];function N({onEmailToggle:a,showEmailButton:f=!0}){const y=n(),v=i(),w=t(),[N,q]=e.useState(null),[C,T]=e.useState({}),[k,L]=e.useState(null),[F,I]=e.useState(!1),{purchases:O,loading:P,currentUserRoles:E,currentUserName:R,refreshPurchases:A,updatePurchaseOptimistic:M}=(()=>{const[r,a]=e.useState([]),[n,i]=e.useState([]),[l,o]=e.useState([]),[u,m]=e.useState(!0),[d,p]=e.useState([]),[f,g]=e.useState(""),[y,v]=e.useState(""),[b,w]=e.useState(""),x=t(),j=e.useRef(!1);e.useEffect(()=>{(async()=>{if(j.current)return;j.current=!0;const e=Date.now(),t=_.lastFetch&&e-_.lastFetch<_.CACHE_DURATION;try{if(t&&_.vendors&&_.employees&&_.userInfo)try{i(_.vendors),o(_.employees);const e=_.userInfo;if(e){let t=[];e.purchase_role&&(t=Array.isArray(e.purchase_role)?e.purchase_role.map(e=>String(e).trim()):String(e.purchase_role).split(",").map(e=>e.trim()).filter(e=>e.length>0)),p(t),g(e.name||e.full_name||""),v(e.email||""),w(e.id||"")}return}catch(r){s.error("캐시 데이터 사용 중 오류",r),_.purchases=null,_.vendors=null,_.employees=null,_.userInfo=null,_.lastFetch=0}const[a,n,l]=await Promise.all([x.from("vendors").select("*"),x.from("employees").select("*"),x.auth.getUser()]);if(a.error)throw a.error;const c=a.data||[];if(i(c),_.vendors=c,n.error)throw n.error;const u=n.data||[];if(o(u),_.employees=u,l.data.user&&!l.error){let t=null;if(l.data.user.email&&(t=(await x.from("employees").select("*").eq("email",l.data.user.email).maybeSingle()).data),t){_.userInfo=t;let e=[];t.purchase_role&&(e=Array.isArray(t.purchase_role)?t.purchase_role.map(e=>String(e).trim()):String(t.purchase_role).split(",").map(e=>e.trim()).filter(e=>e.length>0)),p(e),g(t.name||t.full_name||""),v(t.email||""),w(t.id||"")}_.lastFetch=e}}catch(r){s.error("초기 데이터 로드 실패",r)}})()},[]);const S=e.useCallback(async(e,t)=>{const r=!t?.silent;r&&m(!0);try{const t=Date.now(),o=_.lastFetch&&t-_.lastFetch<_.CACHE_DURATION;if(e&&(h(),_.purchases=null,_.lastFetch=0),!e&&o&&_.purchases)try{return a(_.purchases),void(r&&m(!1))}catch(i){s.error("발주 데이터 캐시 사용 중 오류",i),_.purchases=null,_.lastFetch=0,h()}let u=l;if(0===u.length&&(u=_.employees||[],0===u.length)){const{data:e}=await x.from("employees").select("*");u=e||[]}let d=n;if(0===d.length&&(d=_.vendors||[],0===d.length)){const{data:e}=await x.from("vendors").select("*");d=e||[]}const{data:{user:p},error:f}=await x.auth.getUser();if(f||!p)return s.error("사용자 인증 실패",f),c.error("로그인이 필요합니다."),void(r&&m(!1));const{data:g,error:y}=await x.from("purchase_requests").select("\n          *,\n          purchase_request_items(*)\n        ").order("request_date",{ascending:!1}).limit(1e3);if(y)throw y;const v=(new Date).toISOString().split("T")[0],b=((g||[]).filter(e=>e.request_date?.startsWith(v)),(g||[]).map(e=>{const t=e.purchase_request_items?.[0]||{},s=u.find(t=>t.id===e.requester_id),r=d.find(t=>t.id===e.vendor_id);return{id:Number(e.id),purchase_order_number:e.purchase_order_number,request_date:e.request_date,delivery_request_date:e.delivery_request_date,progress_type:e.progress_type,payment_completed_at:e.payment_completed_at,payment_completed_by_name:e.payment_completed_by_name,payment_category:e.payment_category,currency:e.currency,request_type:e.request_type,vendor:void 0,vendor_name:e.vendor_name||"",vendor_payment_schedule:r?.vendor_payment_schedule||"",vendor_contacts:[],requester_id:e.requester_id,requester_name:e.requester_name,requester_full_name:s?.full_name||s?.name||e.requester_name||"",item_name:t.item_name||"",specification:t.specification||"",quantity:Number(t.quantity)||0,unit_price_value:Number(t.unit_price_value)||0,amount_value:Number(t.amount_value)||0,remark:t.remark||"",project_vendor:e.project_vendor,sales_order_number:e.sales_order_number,project_item:e.project_item,line_number:Number(t.line_number)||1,contact_name:"",middle_manager_status:e.middle_manager_status,final_manager_status:e.final_manager_status,is_received:!!e.is_received,received_at:e.received_at,is_payment_completed:!!e.is_payment_completed,is_po_download:!!e.is_po_download,link:t.link,items:(e.purchase_request_items||[]).sort((e,t)=>(e.line_number||0)-(t.line_number||0)),total_amount:e.purchase_request_items?.reduce((e,t)=>e+(Number(t.amount_value)||0),0)||0,purchase_status:e.purchase_status||"pending"}}));a(b),_.purchases=b,_.lastFetch=t}catch(o){s.error("발주 목록 로드 실패",o),c.error("발주 목록을 불러올 수 없습니다.")}finally{r&&m(!1)}},[l]),N=e.useCallback((e,t)=>{a(s=>{const r=s.map(s=>s.id===e?t(s):s);return _.purchases=r,r})},[]);return e.useEffect(()=>{S()},[S]),{purchases:r,vendors:n,employees:l,loading:u,currentUserRoles:d,currentUserName:f,currentUserEmail:y,currentUserId:b,refreshPurchases:S,updatePurchaseOptimistic:N}})(),D=E?.includes("app_admin"),{activeTab:U,setActiveTab:H,filteredPurchases:$,tabCounts:z}=g(O,E,R);e.useEffect(()=>{"purchase"===new URLSearchParams(v.search).get("tab")&&H("purchase")},[v.search,H]),e.useCallback(e=>e.is_received?r.jsx(o,{variant:null,className:"badge-success",children:"입고완료"}):"approved"===e.middle_manager_status&&"approved"===e.final_manager_status?r.jsx(o,{variant:null,className:"badge-primary",children:"구매진행"}):"rejected"===e.middle_manager_status||"rejected"===e.final_manager_status?r.jsx(o,{variant:null,className:"badge-danger",children:"반려"}):r.jsx(o,{variant:null,className:"badge-warning",children:"승인대기"}),[]);const B=e.useCallback(async e=>{try{const t=(new Date).toISOString(),[s,r]=await Promise.all([w.from("purchase_requests").update({is_received:!0,received_at:t}).eq("id",e),w.from("purchase_request_items").update({is_received:!0,delivery_status:"received"}).eq("purchase_request_id",e)]);if(s.error)throw s.error;if(r.error)throw r.error;c.success("입고완료 처리되었습니다."),await A()}catch(t){c.error("처리 중 오류가 발생했습니다.")}},[w,A]),W=e.useCallback(async e=>{try{const t=(new Date).toISOString(),[s,r]=await Promise.all([w.from("purchase_requests").update({is_payment_completed:!0,payment_completed_at:t}).eq("id",e),w.from("purchase_request_items").update({is_payment_completed:!0}).eq("purchase_request_id",e)]);if(s.error)throw s.error;if(r.error)throw r.error;c.success("구매완료 처리되었습니다."),await A()}catch(t){c.error("처리 중 오류가 발생했습니다.")}},[w,A]);e.useCallback(e=>{(async(e,t)=>{x.measureAsync(`modal-load-${e}`,async()=>{const e=t();e instanceof Promise&&await e},`Modal load: ${e}`)})("PurchaseItems",()=>{L(e),I(!0)})},[]);const V=e.useMemo(()=>k?{...k,vendor_name:k.vendor_name||"",project_vendor:k.project_vendor||"",sales_order_number:k.sales_order_number||"",project_item:k.project_item||""}:null,[k]);return r.jsxs("div",{className:"w-full",children:[r.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4",children:[r.jsxs("div",{children:[r.jsx("h1",{className:"page-title",children:"발주요청 관리"}),r.jsx("p",{className:"page-subtitle",style:{marginTop:"-2px",marginBottom:"-4px"},children:"Purchase Management"})]}),r.jsxs(l,{onClick:()=>y("/purchase/new"),className:"mt-4 sm:mt-0 bg-hansl-500 hover:bg-hansl-600",children:[r.jsx(d,{className:"w-4 h-4 mr-2"}),"새 발주요청 작성"]})]}),r.jsxs("div",{className:"space-y-3",children:[r.jsx("div",{className:"flex flex-col sm:flex-row sm:space-x-1 space-y-1 sm:space-y-0 bg-gray-50 p-1 business-radius-card border border-gray-200",children:S.map(e=>r.jsxs("button",{onClick:()=>(async(e,t)=>x.measureAsync(`tab-switch-${e}`,async()=>{const e=t();e instanceof Promise&&await e},`Tab switch to ${e}`))(e.key,()=>H(e.key)),className:"flex-1 flex items-center justify-center space-x-2 py-1.5 px-3 sm:px-4 business-radius-button button-text font-medium transition-colors "+(U===e.key?"text-hansl-600 bg-white shadow-sm border border-gray-200":"text-gray-600 bg-transparent hover:text-gray-900 hover:bg-white/50"),children:[r.jsx("span",{className:"whitespace-nowrap",children:e.label}),r.jsx(o,{variant:"secondary",className:U===e.key?"badge-stats-active":"badge-stats-secondary",children:z[e.key]})]},e.key))}),r.jsx(u,{className:"overflow-hidden border border-gray-200",children:r.jsx(m,{className:"p-0",children:P?r.jsxs("div",{className:"flex items-center justify-center py-12",children:[r.jsx("div",{className:"w-8 h-8 border-2 border-hansl-500 border-t-transparent rounded-full animate-spin"}),r.jsx("span",{className:"ml-3 card-subtitle",children:"로딩 중..."})]}):0===$.length?r.jsxs("div",{className:"text-center py-12",children:[r.jsx(p,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),r.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"발주요청서가 없습니다"}),r.jsx("p",{className:"card-subtitle",children:"새로운 발주요청서를 작성해보세요."})]}):r.jsx(b,{purchases:$,activeTab:U,currentUserRoles:E,onRefresh:A,onOptimisticUpdate:M,onPaymentComplete:W,onReceiptComplete:B})})})]}),V&&r.jsx(e.Suspense,{fallback:r.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white"})}),children:r.jsx(j,{isOpen:F,onClose:()=>{I(!1),L(null)},purchase:V,isAdmin:D||!1,onUpdate:A,activeTab:U})})]})}export{N as default};
//# sourceMappingURL=PurchaseListMain-D9tNj8Tg.js.map
