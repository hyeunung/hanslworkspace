import{c as e,a,l as s,u as t,r,j as n,X as l,B as i,S as d,b as c}from"./index-D8M7vxbM.js";import{C as o,a as m,b as u,c as p,S as h}from"./card-CEIU5XSb.js";import{D as g,a as x,b as _,c as b,I as y}from"./input-z_v8gvEl.js";import{E as v}from"./exceljs.min-DowPrxBb.js";import{D as j,T as f,P as N}from"./PurchaseDetailModal-BXQ5x2G0.js";import{t as w}from"./index-DEpWIVDZ.js";import{P as q}from"./package-D1-VROro.js";import{C as S}from"./calendar-D4AzkUn4.js";import{D}from"./download-LWTata4W.js";import"./helpers-CsHcdtkA.js";import"./popover-DYLNkvmj.js";import"./calendar-AemyNNBp.js";import"./chevron-down-BFcFynQ9.js";import"./credit-card-A4to8Srp.js";import"./plus-Dk4c22r9.js";import"./save-DzwwSIA_.js";import"./chevron-right-EPuiEj_O.js";
/**
 * @license lucide-react v0.541.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const k=e("arrow-right",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]),C=e("circle-check",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]),P=e("clock",[["path",{d:"M12 6v6l4 2",key:"mmk7yg"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]),R={data:null,lastFetch:0,CACHE_DURATION:3e4,employeeId:null};const O=new class{constructor(){this.supabase=a()}parseRoles(e){let a=[];if(e)if(Array.isArray(e))a=e.map(e=>String(e).trim());else{a=String(e).split(",").map(e=>e.trim()).filter(e=>e.length>0)}return a}async getDashboardData(e,a=!1){const s=Date.now();if(!a&&R.data&&R.employeeId===e.id&&s-R.lastFetch<R.CACHE_DURATION&&R.data)return R.data;const[t,r,n,l,i,d]=await Promise.all([this.getDashboardStats(e),this.getMyRecentRequests(e),this.getPendingApprovals(e),this.getQuickActions(e),this.getTodaySummary(e),this.getMyPurchaseStatus(e)]),c={employee:e,stats:t,urgentRequests:[],myRecentRequests:r,pendingApprovals:n,quickActions:l,todaySummary:i,myPurchaseStatus:d};return R.data=c,R.lastFetch=s,R.employeeId=e.id,c}async getDashboardStats(e){const a=(new Date).toISOString().split("T")[0],s=this.parseRoles(e.purchase_role),[t,r,n,l,i,d]=await Promise.all([this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("requester_name",e.name),this.getPendingCount(e,s),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("is_received",!0).gte("received_at",new Date((new Date).getFullYear(),(new Date).getMonth(),1).toISOString()),this.getUrgentCount(e,s),this.getTodayActionsCount(e,a)]);return{total:t.count||0,myRequests:r.count||0,pending:n,completed:l.count||0,urgent:i,todayActions:d}}async getMyRecentRequests(e){const{data:a}=await this.supabase.from("purchase_requests").select("*,vendors(vendor_name),purchase_request_items(id)").eq("requester_name",e.name).or("and(middle_manager_status.eq.approved,final_manager_status.eq.pending),and(final_manager_status.eq.approved,is_payment_completed.eq.false)").order("created_at",{ascending:!1}).limit(5);return(a||[]).map(e=>({...e,vendor_name:e.vendors?.vendor_name,total_items:e.purchase_request_items?.length||0,progress_percentage:this.calculateProgress(e),current_step:this.getCurrentStep(e),next_action:this.getNextAction(e),estimated_completion:this.estimateCompletion(e)}))}async getPendingApprovals(e){const a=this.parseRoles(e.purchase_role);let t=null;const r=await this.supabase.from("purchase_requests").select("*").order("request_date",{ascending:!1}).limit(100);if(r.error){r.error;const e=await this.supabase.from("purchase_requests").select("*").order("request_date",{ascending:!1}).limit(100);if(e.error)return[];t=e.data||[]}else t=r.data||[];s.debug("ğŸ“Š ì „ì²´ ì¡°íšŒëœ ë°œì£¼ìš”ì²­ ê°œìˆ˜",{count:t.length}),s.debug("ğŸ“Š ìµœê·¼ 5ê°œ ë°œì£¼ìš”ì²­",{items:t.slice(0,5).map(e=>({id:e.id,purchase_order_number:e.purchase_order_number,request_date:e.request_date,created_at:e.created_at,middle_manager_status:e.middle_manager_status,final_manager_status:e.final_manager_status}))});let n=t||[];const l=e=>"pending"===e||"ëŒ€ê¸°"===e||""===e||null==e;if(s.debug("ğŸ” ìŠ¹ì¸ëŒ€ê¸° í•„í„°ë§ ì „ ë°ì´í„°",{employeeName:e.name,employeeRoles:this.parseRoles(e.purchase_role),totalRequests:t?.length||0,sampleData:t?.slice(0,3).map(e=>({id:e.id,purchase_order_number:e.purchase_order_number,middle_manager_status:e.middle_manager_status,final_manager_status:e.final_manager_status,vendor_name:e.vendor_name}))||[]}),n=n.filter(e=>{const a=l(e.middle_manager_status),t=l(e.final_manager_status),r="rejected"===e.middle_manager_status,n="rejected"===e.final_manager_status;if(r||n)return!1;const i=a||t;return s.debug("âœ… ìŠ¹ì¸ëŒ€ê¸° í•­ëª© í•„í„°ë§",{id:e.id,purchase_order_number:e.purchase_order_number,middle_manager_status:e.middle_manager_status,final_manager_status:e.final_manager_status,middlePending:a,finalPending:t,shouldInclude:i}),i}),s.debug("ğŸ” ìŠ¹ì¸ëŒ€ê¸° í•„í„°ë§ í›„ ë°ì´í„°",{filteredCount:n.length,filteredItems:n.map(e=>({id:e.id,purchase_order_number:e.purchase_order_number,middle_manager_status:e.middle_manager_status,final_manager_status:e.final_manager_status}))}),0===a.length)return[];let i=n;a.includes("app_admin")?s.debug("ğŸ”‘ app_admin ê¶Œí•œìœ¼ë¡œ ëª¨ë“  ìŠ¹ì¸ëŒ€ê¸° í•­ëª© í‘œì‹œ",{totalItems:i.length}):a.includes("middle_manager")?(i=n.filter(e=>l(e.middle_manager_status)),s.debug("ğŸ”‘ middle_manager ê¶Œí•œìœ¼ë¡œ ì¤‘ê°„ìŠ¹ì¸ ëŒ€ê¸° í•­ëª©ë§Œ í‘œì‹œ",{beforeFilter:n.length,afterFilter:i.length})):a.includes("final_approver")||a.includes("ceo")?(i=n.filter(e=>{const a="approved"===e.middle_manager_status,s=l(e.final_manager_status);return a&&s}),s.debug("ğŸ”‘ final_approver/ceo ê¶Œí•œìœ¼ë¡œ ìµœì¢…ìŠ¹ì¸ ëŒ€ê¸° í•­ëª©ë§Œ í‘œì‹œ",{beforeFilter:n.length,afterFilter:i.length})):a.includes("raw_material_manager")||a.includes("consumable_manager")?(i=n.filter(e=>{const a="approved"===e.middle_manager_status,s=l(e.final_manager_status);return a&&s}),s.debug("ğŸ”‘ material_manager ê¶Œí•œìœ¼ë¡œ ìµœì¢…ìŠ¹ì¸ ëŒ€ê¸° í•­ëª©ë§Œ í‘œì‹œ",{beforeFilter:n.length,afterFilter:i.length})):a.includes("lead buyer")?(i=n.filter(e=>{const a="approved"===e.final_manager_status,s=!e.is_payment_completed;return a&&s}),s.debug("ğŸ”‘ lead buyer ê¶Œí•œìœ¼ë¡œ êµ¬ë§¤ ëŒ€ê¸° í•­ëª©ë§Œ í‘œì‹œ",{beforeFilter:n.length,afterFilter:i.length})):(i=[],s.debug("ğŸ”‘ ìŠ¹ì¸ ê¶Œí•œ ì—†ëŠ” ì—­í• ",{roles:a,result:"empty"})),n=i,s.debug("ğŸ“‹ í’ˆëª© ì •ë³´ ì¡°íšŒ ì‹œì‘",{filteredDataCount:n.length,filteredDataIds:n.map(e=>({id:e.id,purchase_order_number:e.purchase_order_number}))});const d=await Promise.all(n.map(async e=>{const{data:a}=await this.supabase.from("purchase_request_items").select("*").eq("purchase_request_id",e.id);let s=e.vendor_name;if(!s&&e.vendor_id){const{data:a}=await this.supabase.from("vendors").select("vendor_name").eq("id",e.vendor_id).single();s=a?.vendor_name}const t=a||[],r=t.reduce((e,a)=>e+(Number(a?.amount_value)||(Number(a?.quantity)||0)*(Number(a?.unit_price_value)||0)),0);return{...e,vendor_name:s,purchase_request_items:t,total_amount:r}}));return s.debug("ğŸ“‹ í’ˆëª© ì •ë³´ ì¡°íšŒ ì™„ë£Œ",{enhancedDataCount:d.length,enhancedDataSummary:d.map(e=>({id:e.id,purchase_order_number:e.purchase_order_number,itemsCount:e.purchase_request_items?.length||0,total_amount:e.total_amount}))}),d}async getQuickActions(e){const a=this.parseRoles(e.purchase_role),s=[];if(a.includes("app_admin")||a.includes("middle_manager")||a.includes("final_approver")||a.includes("ceo")){const t=await this.getPendingCount(e,a);t>0&&s.push({id:"approve",type:"approve",label:"ìŠ¹ì¸ ëŒ€ê¸°",description:`${t}ê±´ì˜ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘`,count:t,color:"red"})}if(a.includes("lead buyer")||a.includes("lead buyer")){const{count:e}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("final_manager_status","approved").eq("is_payment_completed",!1);e&&e>0&&s.push({id:"purchase",type:"purchase",label:"êµ¬ë§¤ ì²˜ë¦¬",description:`${e}ê±´ì˜ êµ¬ë§¤ ëŒ€ê¸° ì¤‘`,count:e,color:"yellow"})}return s}async getTodaySummary(e){const a=(new Date).toISOString().split("T")[0],s=new Date(Date.now()+864e5).toISOString().split("T")[0],[t,r,n]=await Promise.all([this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).gte("updated_at",a).lt("updated_at",s).or("middle_manager_status.eq.approved,final_manager_status.eq.approved"),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("requester_name",e.name).gte("created_at",a).lt("created_at",s),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("is_received",!0).gte("received_at",a).lt("received_at",s)]);return{approved:t.count||0,requested:r.count||0,received:n.count||0}}async getMyPurchaseStatus(e){const a=e.name||e.email,t=new Date(Date.now()-6048e5).toISOString(),r=await this.supabase.from("purchase_requests").select("*,vendors(vendor_name),purchase_request_items(item_name,quantity,specification,amount_value)").eq("requester_name",a).order("created_at",{ascending:!1}).limit(100);if(r.error)return s.error("getMyPurchaseStatus ì—ëŸ¬",r.error),{waitingPurchase:[],waitingDelivery:[],recentCompleted:[]};const n=r.data||[];return{waitingPurchase:n.filter(e=>{const a=(e.payment_category||"").trim().replace(/\s+/g,""),s=["êµ¬ë§¤ìš”ì²­","ë°œì£¼ìš”ì²­"].includes(a),t=!e.is_payment_completed,r=(e.progress_type||"").includes("ì„ ì§„í–‰");if(s&&t&&r)return!0;const n=(e.progress_type||"").includes("ì¼ë°˜")||!e.progress_type||""===e.progress_type,l="approved"===e.final_manager_status;return s&&t&&n&&l}).slice(0,10),waitingDelivery:n.filter(e=>{const a=!e.is_received,s=(e.progress_type||"").includes("ì„ ì§„í–‰");if(a&&s)return!0;const t="approved"===e.final_manager_status;return a&&t}).slice(0,10),recentCompleted:n.filter(e=>{if(!0!==e.is_received)return!1;if(!e.received_at)return!1;return new Date(e.received_at)>=new Date(t)}).slice(0,10)}}async quickApprove(e,a){try{const s=this.parseRoles(a.purchase_role),{data:t}=await this.supabase.from("purchase_requests").select("middle_manager_status, final_manager_status").eq("id",e).single();if(!t)return{success:!1,error:"ìš”ì²­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."};let r={};const n=e=>"pending"===e||"ëŒ€ê¸°"===e||""===e||null==e;if(s.includes("app_admin")?n(t.middle_manager_status)?r={middle_manager_status:"approved"}:"approved"===t.middle_manager_status&&n(t.final_manager_status)&&(r={final_manager_status:"approved"}):s.includes("middle_manager")?n(t.middle_manager_status)&&(r={middle_manager_status:"approved"}):s.includes("final_approver")||s.includes("ceo")?"approved"===t.middle_manager_status&&n(t.final_manager_status)&&(r={final_manager_status:"approved"}):(s.includes("raw_material_manager")||s.includes("consumable_manager"))&&"approved"===t.middle_manager_status&&n(t.final_manager_status)&&(r={final_manager_status:"approved"}),0===Object.keys(r).length)return{success:!1,error:"ìŠ¹ì¸í•  ìˆ˜ ìˆëŠ” ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤."};const{data:l,error:i}=await this.supabase.from("purchase_requests").update(r).eq("id",e).select().single();if(i)throw i;return{success:!0}}catch(s){return{success:!1,error:s.message}}}async getPendingCount(e,a){if(a.includes("app_admin")){const[e,a,s]=await Promise.all([this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).or("middle_manager_status.in.(pending,ëŒ€ê¸°),middle_manager_status.is.null"),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("middle_manager_status","approved").or("final_manager_status.in.(pending,ëŒ€ê¸°),final_manager_status.is.null"),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("final_manager_status","approved").eq("is_payment_completed",!1)]);return(e.count||0)+(a.count||0)+(s.count||0)}if(a.includes("middle_manager")){const{count:e,error:a}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).or("middle_manager_status.in.(pending,ëŒ€ê¸°),middle_manager_status.is.null");return a?0:e||0}if(a.includes("final_approver")||a.includes("ceo")){const{count:e,error:a}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("middle_manager_status","approved").or("final_manager_status.in.(pending,ëŒ€ê¸°),final_manager_status.is.null");return a?0:e||0}if(a.includes("lead buyer")){const{count:e,error:a}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("final_manager_status","approved").eq("is_payment_completed",!1);return a?0:e||0}return 0}async getUrgentCount(e,a){if(0===a.length)return 0;const s=new Date(Date.now()-2592e5).toISOString();let t=this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).lt("created_at",s);if(a.includes("app_admin"))t=t.or("middle_manager_status.eq.pending,final_manager_status.eq.pending,is_payment_completed.eq.false");else if(a.includes("middle_manager"))t=t.eq("middle_manager_status","pending");else if(a.includes("final_approver")||a.includes("ceo"))t=t.eq("middle_manager_status","approved").eq("final_manager_status","pending");else{if(!a.includes("lead buyer"))return 0;t=t.eq("final_manager_status","approved").eq("is_payment_completed",!1)}const{count:r}=await t;return r||0}async getTodayActionsCount(e,a){const s=new Date(Date.now()+864e5).toISOString().split("T")[0],{count:t}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).gte("updated_at",a).lt("updated_at",s).eq("requester_name",e.name);return t||0}async getTotalDeliveryWaitingCount(){const{count:e}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("is_received",!1).or("is_payment_completed.eq.true,progress_type.ilike.%ì„ ì§„í–‰%");return e||0}calculateProgress(e){let a=0;return"approved"===e.middle_manager_status&&(a+=25),"approved"===e.final_manager_status&&(a+=25),e.is_payment_completed&&(a+=25),e.is_received&&(a+=25),a}getCurrentStep(e){return e.is_received?"completed":e.is_payment_completed?"delivery":"approved"===e.final_manager_status?"purchase":"approval"}getNextAction(e){return"pending"===e.middle_manager_status?"ì¤‘ê°„ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘":"pending"===e.final_manager_status?"ìµœì¢… ìŠ¹ì¸ ëŒ€ê¸° ì¤‘":e.is_payment_completed?e.is_received?"ì™„ë£Œ":"ì…ê³  ëŒ€ê¸° ì¤‘":"êµ¬ë§¤ ì²˜ë¦¬ ëŒ€ê¸° ì¤‘"}estimateCompletion(e){const a=new Date(e.created_at),s=new Date;Math.floor((s.getTime()-a.getTime())/864e5);let t=7;"ê¸´ê¸‰"===e.progress_type&&(t=3);return new Date(a.getTime()+24*t*60*60*1e3).toLocaleDateString("ko-KR")}async getUndownloadedOrders(e){const a=this.parseRoles(e.purchase_role);if(!a.includes("lead buyer")&&!a.includes("lead buyer"))return[];const{data:t,error:r}=await this.supabase.from("purchase_requests").select("*,purchase_request_items(id,item_name,specification,quantity,unit_price_value,amount_value)").order("created_at",{ascending:!1}).limit(100);if(r)return s.error("Failed to fetch undownloaded orders",r),[];const n=(t||[]).filter(e=>{const a="ì„ ì§„í–‰"===e.progress_type||"approved"===e.middle_manager_status&&"approved"===e.final_manager_status,s=!e.is_po_download||!1===e.is_po_download||null===e.is_po_download;return a&&s});return n.sort((e,a)=>new Date(e.created_at).getTime()-new Date(a.created_at).getTime()),n.slice(0,10)}};function I({isOpen:e,onClose:c,item:o,type:m,onRefresh:u}){const p=t(),h=a(),[y,v]=r.useState([]),[N,D]=r.useState(!1),[R,O]=r.useState(o);r.useEffect(()=>{O(o)},[o]),r.useEffect(()=>{(async()=>{const{data:{user:e}}=await h.auth.getUser();if(e?.email){const{data:a}=await h.from("employees").select("purchase_role").eq("email",e.email).single();if(a?.purchase_role){const e=Array.isArray(a.purchase_role)?a.purchase_role:a.purchase_role.split(",").map(e=>e.trim());v(e)}}})()},[m]);if(!R)return null;const I=R.purchase_request_items||[],A=I.reduce((e,a)=>e+(Number(a.amount_value)||0),0);I.reduce((e,a)=>e+(Number(a.quantity)||0),0),s.debug("ğŸš¨ PurchaseStatusModal ê¸´ê¸‰ ë””ë²„ê¹…",{type:`"${m}"`,typeType:typeof m,currentUserRoles:y,item:R.purchase_order_number,showPurchaseButton:"purchase"===m,showDeliveryButton:"delivery"===m,hasAdminPermission:y.includes("app_admin"),hasLeadBuyerPermission:y.includes("lead buyer"),leadBuyerCheck:y.some(e=>"lead buyer"===e.trim().toLowerCase()),itemData:{is_payment_completed:R.is_payment_completed,is_received:R.is_received},shouldShowPurchaseColumn:"purchase"===m,actualTypeValue:JSON.stringify(m)});const L=(()=>{switch(m){case"pending":return{icon:n.jsx(P,{className:"w-6 h-6 text-orange-600"}),title:"ìŠ¹ì¸ ëŒ€ê¸°",status:"ìŠ¹ì¸ ì²˜ë¦¬ ëŒ€ê¸°ì¤‘",color:"bg-orange-50 text-orange-700 border-orange-200"};case"purchase":return{icon:n.jsx(d,{className:"w-6 h-6 text-yellow-600"}),title:"êµ¬ë§¤ ëŒ€ê¸°",status:"êµ¬ë§¤ ì²˜ë¦¬ ëŒ€ê¸°ì¤‘",color:"bg-yellow-50 text-yellow-700 border-yellow-200"};case"delivery":return{icon:n.jsx(f,{className:"w-6 h-6 text-blue-600"}),title:"ì…ê³  ëŒ€ê¸°",status:"ì…ê³  ì²˜ë¦¬ ëŒ€ê¸°ì¤‘",color:"bg-blue-50 text-blue-700 border-blue-200"};case"completed":return{icon:n.jsx(S,{className:"w-6 h-6 text-green-600"}),title:"ì²˜ë¦¬ ì™„ë£Œ",status:"ëª¨ë“  ì²˜ë¦¬ ì™„ë£Œ",color:"bg-green-50 text-green-700 border-green-200"};default:return{icon:n.jsx(q,{className:"w-6 h-6 text-gray-600"}),title:"ìƒíƒœ í™•ì¸",status:"ìƒíƒœ í™•ì¸ í•„ìš”",color:"bg-gray-50 text-gray-700 border-gray-200"}}})();return n.jsx(g,{open:e,onOpenChange:c,children:n.jsxs(x,{className:"overflow-hidden bg-white rounded-3xl shadow-2xl border-0",style:{maxWidth:"1280px",width:"90vw",maxHeight:"50vh"},showCloseButton:!1,children:[n.jsx(_,{className:"sr-only",children:n.jsx(b,{children:"ë°œì£¼ ì§„í–‰ ìƒíƒœ"})}),n.jsxs("div",{className:"relative px-6 pt-6 pb-4",children:[n.jsx("button",{onClick:c,className:"absolute right-6 top-6 w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-all duration-200",children:n.jsx(l,{className:"w-4 h-4 text-gray-500"})}),n.jsx("div",{className:"pr-16",children:n.jsxs("div",{className:"flex items-start gap-4 mb-2",children:[n.jsx("div",{className:"w-10 h-10 rounded-2xl bg-blue-50 flex items-center justify-center flex-shrink-0",children:L.icon}),n.jsxs("div",{className:"min-w-0 flex-1",children:[n.jsx("h1",{className:"modal-title mb-1",children:R.purchase_order_number||"POë²ˆí˜¸ ì—†ìŒ"}),n.jsx("p",{className:"modal-subtitle",children:R.vendor_name||"ì—…ì²´ëª… ì—†ìŒ"})]}),n.jsx("div",{className:`px-3 py-1.5 business-radius-badge badge-text ${L.color}`,children:L.title})]})})]}),n.jsxs("div",{className:"overflow-y-auto max-h-[calc(50vh-160px)] px-6 pb-4 space-y-3",children:[n.jsx("div",{className:"bg-gray-50 rounded-xl p-3 border border-gray-100",children:n.jsxs("div",{className:"grid grid-cols-3 gap-x-4 gap-y-2 text-xs",children:[n.jsxs("div",{children:[n.jsx("span",{className:"modal-label",children:"ìš”ì²­ì:"})," ",n.jsx("span",{className:"modal-value",children:R.requester_name})]}),n.jsxs("div",{children:[n.jsx("span",{className:"modal-label",children:"ìš”ì²­ì¼:"})," ",n.jsx("span",{className:"modal-value",children:new Date(R.request_date||R.created_at).toLocaleDateString("ko-KR")})]}),n.jsxs("div",{children:[n.jsx("span",{className:"modal-label",children:"ë‚©ê¸°ìš”ì²­ì¼:"})," ",n.jsx("span",{className:"modal-value",children:R.delivery_request_date?new Date(R.delivery_request_date).toLocaleDateString("ko-KR"):"ë¯¸ì§€ì •"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"modal-label",children:"ì—…ì²´ëª…:"})," ",n.jsx("span",{className:"modal-value",children:R.vendor_name||"-"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"modal-label",children:"ê²°ì œìœ í˜•:"})," ",n.jsx("span",{className:"modal-value",children:R.payment_category||"ì¼ë°˜"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"modal-label",children:"ì§„í–‰êµ¬ë¶„:"})," ",n.jsx("span",{className:"modal-value",children:R.progress_type||"ì¼ë°˜"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"modal-label",children:"í”„ë¡œì íŠ¸ì—…ì²´:"})," ",n.jsx("span",{className:"modal-value",children:R.project_vendor||"-"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"modal-label",children:"íŒë§¤ì£¼ë¬¸ë²ˆí˜¸:"})," ",n.jsx("span",{className:"modal-value",children:R.sales_order_number||"-"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"modal-label",children:"ë°°ì†¡ì§€:"})," ",n.jsx("span",{className:"modal-value",children:R.shipping_address||"ë³¸ì‚¬"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"modal-label",children:"í†µí™”:"})," ",n.jsx("span",{className:"modal-value",children:R.currency||"KRW"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"modal-label",children:"í…œí”Œë¦¿:"})," ",n.jsx("span",{className:"modal-value",children:R.po_template_type||"ì¼ë°˜"})]}),R.revised_delivery_request_date&&n.jsxs("div",{children:[n.jsx("span",{className:"modal-label text-orange-500",children:"ë³€ê²½ì…ê³ ì¼:"})," ",n.jsx("span",{className:"modal-value text-orange-900",children:new Date(R.revised_delivery_request_date).toLocaleDateString("ko-KR")})]})]})}),n.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 overflow-hidden",children:[n.jsx("div",{className:"bg-gray-50 px-3 py-2 border-b border-gray-100",children:n.jsxs("h3",{className:"modal-section-title text-gray-700",children:["ì£¼ë¬¸ í’ˆëª© (",I.length,"ê°œ, ì´ â‚©",A.toLocaleString(),")"]})}),n.jsx("div",{className:"overflow-x-auto",children:n.jsxs("table",{className:"w-full text-xs table-fixed",children:[n.jsxs("colgroup",{children:[n.jsx("col",{className:"w-[25%]"}),n.jsx("col",{className:"w-[20%]"}),n.jsx("col",{className:"w-[10%]"}),n.jsx("col",{className:"w-[15%]"}),n.jsx("col",{className:"w-[15%]"}),("delivery"===m||"purchase"===m)&&n.jsx("col",{className:"w-[15%]"})]}),n.jsx("thead",{className:"bg-gray-50 border-b border-gray-100",children:n.jsxs("tr",{children:[n.jsx("th",{className:"text-left p-2 modal-label text-gray-600",children:"í’ˆëª©ëª…"}),n.jsx("th",{className:"text-left p-2 modal-label text-gray-600",children:"ê·œê²©"}),n.jsx("th",{className:"text-right p-2 modal-label text-gray-600",children:"ìˆ˜ëŸ‰"}),n.jsx("th",{className:"text-right p-2 modal-label text-gray-600",children:"ë‹¨ê°€"}),n.jsx("th",{className:"text-right p-2 modal-label text-gray-600",children:"ê¸ˆì•¡"}),"delivery"===m&&n.jsx("th",{className:"text-center p-2 modal-label text-gray-600",children:"ì…ê³ ìƒíƒœ"}),"purchase"===m&&n.jsx("th",{className:"text-center p-2 modal-label text-gray-600",children:"êµ¬ë§¤ìƒíƒœ"})]})}),n.jsx("tbody",{className:"divide-y divide-gray-100",children:I.map((e,a)=>{const t=e.quantity>0?(Number(e.amount_value)||0)/e.quantity:0;return n.jsxs("tr",{className:"hover:bg-gray-50",children:[n.jsxs("td",{className:"p-2",children:[n.jsx("div",{className:"modal-value text-gray-900",children:e.item_name||"í’ˆëª©ëª… ì—†ìŒ"}),e.remark&&n.jsxs("div",{className:"text-xs text-amber-600 mt-1",children:["ë¹„ê³ : ",e.remark]})]}),n.jsx("td",{className:"p-2 text-gray-600",children:e.specification||"-"}),n.jsx("td",{className:"p-2 text-right modal-value",children:e.quantity||0}),n.jsxs("td",{className:"p-2 text-right",children:["â‚©",t.toLocaleString()]}),n.jsxs("td",{className:"p-2 text-right modal-value",children:["â‚©",(Number(e.amount_value)||0).toLocaleString()]}),"delivery"===m&&n.jsx("td",{className:"p-2 text-center",children:e.actual_received_date?n.jsxs("span",{className:"inline-flex items-center gap-1 bg-green-50 text-green-700 px-2 py-1 business-radius-badge text-xs border border-green-200",children:[n.jsx(C,{className:"w-3 h-3"}),"ì™„ë£Œ"]}):(y.includes("app_admin")||y.includes("requester"))&&n.jsx(j,{onDateSelect:a=>(async(e,a)=>{try{const{error:s}=await h.from("purchase_request_items").update({is_received:!0,received_at:(new Date).toISOString(),actual_received_date:e.toISOString()}).eq("id",a);if(s)throw s;O(s=>({...s,purchase_request_items:s.purchase_request_items?.map(s=>s.id===a?{...s,is_received:!0,received_at:(new Date).toISOString(),actual_received_date:e.toISOString()}:s)||[]})),w.success("ì…ê³ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."),u&&u()}catch(s){w.error("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}})(a,e.id),placeholder:"ì‹¤ì œ ì…ê³ ëœ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”",align:"center",side:"bottom",children:n.jsx(i,{size:"sm",className:"button-base bg-blue-600 hover:bg-blue-700 text-white",children:"ì…ê³ ì™„ë£Œ"})})}),"purchase"===m&&n.jsx("td",{className:"p-2 text-center",children:e.is_payment_completed?n.jsxs("span",{className:"inline-flex items-center gap-1 bg-green-50 text-green-700 px-2 py-1 business-radius-badge text-xs border border-green-200",children:[n.jsx(C,{className:"w-3 h-3"}),"ì™„ë£Œ"]}):(y.includes("app_admin")||y.some(e=>"lead buyer"===e.trim().toLowerCase()))&&n.jsx(i,{size:"sm",onClick:()=>(async e=>{if(s.debug("ğŸ–±ï¸ êµ¬ë§¤ì™„ë£Œ ë²„íŠ¼ í´ë¦­ë¨",{itemId:e,timestamp:(new Date).toISOString()}),confirm("ì´ í’ˆëª©ì„ êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){s.debug("âœ… êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ ì‹œì‘",{itemId:e});try{const{error:a}=await h.from("purchase_request_items").update({is_payment_completed:!0,payment_completed_at:(new Date).toISOString()}).eq("id",e);if(a)throw a;O(a=>({...a,purchase_request_items:a.purchase_request_items?.map(a=>a.id===e?{...a,is_payment_completed:!0,payment_completed_at:(new Date).toISOString()}:a)})),s.debug("âœ… êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ ì„±ê³µ",{itemId:e}),w.success("í’ˆëª© êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."),u?.()}catch(a){s.error("âŒ êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ ì‹¤íŒ¨",a,{itemId:e}),w.error("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}}else s.debug("âŒ ì‚¬ìš©ìê°€ êµ¬ë§¤ì™„ë£Œ í™•ì¸ ì·¨ì†Œ")})(e.id),className:"button-base bg-yellow-600 hover:bg-yellow-700 text-white",children:"êµ¬ë§¤ì™„ë£Œ"})})]},a)})})]})})]}),"delivery"===m&&I.length>1&&n.jsx("div",{className:"bg-blue-50 rounded-xl p-3 border border-blue-100",children:(()=>{const e=I.filter(e=>e.actual_received_date).length,a=I.length,s=e/a*100;return n.jsxs("div",{className:"flex items-center gap-4",children:[n.jsx("div",{className:"modal-value text-blue-700",children:"ì…ê³  ì§„í–‰ë¥ "}),n.jsx("div",{className:"flex-1 bg-blue-200 rounded-full h-2",children:n.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-500",style:{width:`${s}%`}})}),n.jsxs("div",{className:"modal-value text-blue-700",children:[e,"/",a," (",s.toFixed(0),"%)"]})]})})()})]}),n.jsx("div",{className:"sticky bottom-0 bg-white border-t border-gray-100 px-6 py-6",children:n.jsxs("div",{className:"flex items-center justify-between gap-6",children:["purchase"===m&&(y.includes("app_admin")||y.some(e=>"lead buyer"===e.trim().toLowerCase()))&&n.jsxs(i,{onClick:async()=>{D(!0);try{const{error:e}=await h.from("purchase_requests").update({is_payment_completed:!0,payment_completed_at:(new Date).toISOString()}).eq("id",R.id);if(e)throw e;O(e=>({...e,is_payment_completed:!0,payment_completed_at:(new Date).toISOString()})),w.success("êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."),u?.()}catch(e){w.error("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}finally{D(!1)}},disabled:N,className:"bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-8 py-4 rounded-2xl shadow-lg transition-all duration-200 modal-subtitle",children:[N?n.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-3"}):n.jsx(C,{className:"w-5 h-5 mr-3"}),"êµ¬ë§¤ ì™„ë£Œ ì²˜ë¦¬"]}),n.jsxs("div",{className:"flex items-center gap-4 ml-auto",children:[n.jsxs(i,{variant:"outline",onClick:()=>{p(`/purchase?highlight=${R.id}`),c()},className:"border-gray-300 text-gray-700 hover:bg-gray-50 hover:text-gray-900 hover:border-gray-400 px-8 py-4 rounded-2xl modal-subtitle transition-all duration-200",children:["ë°œì£¼ ëª©ë¡ì—ì„œ ë³´ê¸°",n.jsx(k,{className:"w-5 h-5 ml-3"})]}),n.jsx(i,{onClick:c,className:"bg-gray-900 hover:bg-gray-800 text-white px-10 py-4 rounded-2xl modal-subtitle transition-all duration-200 shadow-lg",children:"ì™„ë£Œ"})]})]})})]})})}function A(){const[e,a]=r.useState(null),[j,C]=r.useState(!0),[R,A]=r.useState(null),[L,T]=r.useState(null),[F,M]=r.useState(!1),[U,$]=r.useState([]),[E,B]=r.useState([]),[K,z]=r.useState(new Set),[W,H]=r.useState(null),[Q,Y]=r.useState(!1),[J,V]=r.useState(null),[G,X]=r.useState(null),[Z,ee]=r.useState(!1),[ae,se]=r.useState({undownloaded:"",pending:"",purchase:"",delivery:""}),te=t(),{employee:re,currentUserRoles:ne}=c(),le=r.useCallback(async(t=!0,r=!1)=>{if(re)try{!t||r||e||C(!0);const s=await O.getDashboardData(re,r);if(a(s),$(ne),ne.includes("lead buyer")){const e=await O.getUndownloadedOrders(re);B(e)}}catch(n){s.error("[DashboardMain] Failed to load dashboard data:",n),w.error("ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}finally{t&&C(!1)}else s.error("[DashboardMain] No employee data available")},[re,ne,e]);r.useEffect(()=>{le()},[le]);const ie=(e,a)=>{V(e),X(a),ee(!0)},de=(e,a)=>a.trim()?e.filter(e=>[e.purchase_order_number||"",e.vendor_name||"",(e.purchase_request_items||[]).map(e=>e.item_name||"").join(" ")].join(" ").toLowerCase().includes(a.toLowerCase())):e,ce=async e=>{try{z(a=>new Set(a).add(e.id));const a=new v.Workbook,s=a.addWorksheet("ë°œì£¼ì„œ");s.columns=[{header:"ë°œì£¼ë²ˆí˜¸",key:"purchase_order_number",width:20},{header:"ì—…ì²´ëª…",key:"vendor_name",width:30},{header:"í’ˆëª©ëª…",key:"item_name",width:40},{header:"ê·œê²©",key:"specification",width:30},{header:"ìˆ˜ëŸ‰",key:"quantity",width:15},{header:"ë‹¨ê°€",key:"unit_price",width:20},{header:"ê¸ˆì•¡",key:"amount",width:20},{header:"ìš”ì²­ì¼",key:"request_date",width:15},{header:"ì§„í–‰ìƒíƒœ",key:"progress_type",width:15}];(e.purchase_request_items||[]).forEach(a=>{s.addRow({purchase_order_number:e.purchase_order_number,vendor_name:e.vendor_name||e.vendors?.vendor_name||"",item_name:a.item_name||"",specification:a.specification||"",quantity:a.quantity||0,unit_price:a.unit_price_value||0,amount:a.amount_value||0,request_date:e.request_date||"",progress_type:e.progress_type||""})}),s.getRow(1).font={bold:!0},s.getRow(1).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFE0E0E0"}};const t=await a.xlsx.writeBuffer(),r=new Blob([t],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),n=window.URL.createObjectURL(r),l=document.createElement("a");l.href=n,l.download=`ë°œì£¼ì„œ_${e.purchase_order_number}_${(new Date).toISOString().slice(0,10)}.xlsx`,l.click(),window.URL.revokeObjectURL(n),(U.includes("lead buyer")||U.includes("lead buyer"))&&(await supabase.from("purchase_requests").update({is_po_download:!0}).eq("id",e.id),B(a=>a.filter(a=>a.id!==e.id))),w.success("ë°œì£¼ì„œê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.")}catch(a){w.error("ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}finally{z(a=>{const s=new Set(a);return s.delete(e.id),s})}};if(j)return n.jsx("div",{className:"flex items-center justify-center h-screen bg-gray-50",children:n.jsxs("div",{className:"text-center",children:[n.jsx("div",{className:"w-12 h-12 border-3 border-hansl-500 border-t-transparent rounded-full animate-spin mx-auto"}),n.jsx("p",{className:"mt-4 card-subtitle",children:"ëŒ€ì‹œë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤..."})]})});if(!e?.employee)return n.jsx("div",{className:"flex items-center justify-center h-screen bg-gray-50",children:n.jsxs("div",{className:"text-center bg-white p-8 rounded-lg border border-gray-200",children:[n.jsx("h3",{className:"modal-subtitle mb-2",children:"ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"}),n.jsx("p",{className:"card-subtitle",children:"ë¡œê·¸ì¸ì„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."})]})});const oe=(Array.isArray(e.employee.purchase_role)?e.employee.purchase_role.map(e=>String(e).trim()):e.employee.purchase_role?String(e.employee.purchase_role).split(",").map(e=>e.trim()).filter(e=>e.length>0):[]).some(e=>["middle_manager","final_approver","app_admin","raw_material_manager","consumable_manager"].includes(e));return n.jsxs("div",{className:"min-h-screen bg-gray-50",children:[n.jsxs("div",{className:"w-full px-4 lg:px-6",children:[n.jsx("div",{className:"mb-3",children:n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{children:[n.jsx("h1",{className:"page-title",children:"ëŒ€ì‹œë³´ë“œ"}),n.jsx("p",{className:"page-subtitle",style:{marginTop:"-2px",marginBottom:"-4px"},children:"Dashboard"})]}),n.jsx("div",{className:"flex items-center gap-2",children:n.jsx("span",{className:"badge-stats border border-gray-300 bg-white text-gray-600",children:(new Date).toLocaleDateString("ko-KR",{month:"long",day:"numeric",weekday:"short"})})})]})}),n.jsx("div",{className:"mb-2",children:n.jsxs("h2",{className:"section-title mb-2 flex items-center gap-1.5",children:[n.jsx(q,{className:"w-3.5 h-3.5 text-gray-600"}),"ì „ì²´ í˜„í™©"]})}),n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3",children:[(U.includes("lead buyer")||U.includes("lead buyer"))&&E.length>0&&n.jsxs(o,{className:"w-full col-span-1 row-span-2 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[n.jsx(m,{className:"py-3 px-4 bg-gray-50 border-b",children:n.jsxs(u,{className:"section-title flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(D,{className:"w-4 h-4 text-orange-600"}),n.jsx("span",{children:"ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œ"})]}),n.jsx("span",{className:"badge-stats bg-orange-100 text-orange-700",children:E.length})]})}),n.jsx(p,{className:"p-4",children:n.jsxs("div",{className:"space-y-3",children:[n.jsxs("div",{className:"relative",children:[n.jsx(h,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),n.jsx(y,{placeholder:"ë°œì£¼ë²ˆí˜¸, ì—…ì²´ëª…, í’ˆëª©ìœ¼ë¡œ ê²€ìƒ‰...",value:ae.undownloaded,onChange:e=>se(a=>({...a,undownloaded:e.target.value})),className:"pl-10 h-8 text-xs"})]}),n.jsx("div",{className:"space-y-2 h-[36rem] overflow-y-auto",children:de(E,ae.undownloaded).slice(0,10).map(e=>{const a=e.purchase_request_items||[],s=a[0]||{};a.reduce((e,a)=>e+(Number(a.amount_value)||0),0),a.reduce((e,a)=>e+(Number(a.quantity)||0),0);const t=Math.floor((Date.now()-new Date(e.created_at).getTime())/864e5),r="ì„ ì§„í–‰"===e.progress_type;return n.jsx("div",{className:"border rounded-lg p-2 transition-all cursor-pointer hover:shadow-sm "+(r?"bg-red-50 hover:bg-red-100 border-red-200":"bg-white hover:bg-gray-50 border-gray-200"),onClick:()=>{H(e),Y(!0)},children:n.jsxs("div",{className:"flex items-center justify-between gap-2",children:[n.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[n.jsx("span",{className:"card-title",children:e.purchase_order_number||`PO-${e.id.slice(0,8)}`}),n.jsx("span",{className:"card-subtitle truncate",children:e.vendor_name||"ì—…ì²´ëª… ì—†ìŒ"}),n.jsxs("span",{className:"card-description truncate",children:[s.item_name||"í’ˆëª©",a.length>1&&n.jsxs("span",{className:"text-gray-400",children:[" ì™¸ ",a.length-1,"ê±´"]})]}),t>3&&n.jsxs("span",{className:"badge-stats border border-gray-300 bg-white text-gray-600 flex-shrink-0",children:[t,"ì¼"]})]}),n.jsx("div",{children:n.jsx(i,{size:"sm",variant:"outline",className:"h-7 px-2 badge-text border-orange-200 hover:bg-orange-50",onClick:a=>{a.stopPropagation(),ce(e)},disabled:K.has(e.id),children:K.has(e.id)?n.jsx("div",{className:"w-3 h-3 border border-orange-600 border-t-transparent rounded-full animate-spin"}):n.jsxs(n.Fragment,{children:[n.jsx(D,{className:"w-3 h-3 mr-1"}),"ë‹¤ìš´ë¡œë“œ"]})})})]})},e.id)})})]})})]}),oe&&n.jsxs(o,{className:"w-full col-span-1 row-span-2",children:[n.jsx(m,{className:"pb-2 pt-3",children:n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs(u,{className:"section-title flex items-center gap-1.5",children:[n.jsx(P,{className:"w-3.5 h-3.5 text-orange-500"}),"ìŠ¹ì¸ ëŒ€ê¸°",e.pendingApprovals.length>0&&n.jsx("span",{className:"badge-stats bg-red-500 text-white h-4 px-1",children:e.pendingApprovals.length})]}),e.pendingApprovals.length>0&&n.jsx(i,{size:"sm",variant:"ghost",onClick:()=>te("/purchase"),className:"h-6 px-2",children:n.jsx(k,{className:"w-3 h-3"})})]})}),n.jsx(p,{className:"p-3",children:0===e.pendingApprovals.length?n.jsxs("div",{className:"text-center py-4 text-gray-400",children:[n.jsx(S,{className:"w-6 h-6 mx-auto mb-1"}),n.jsx("p",{className:"card-description",children:"ëŒ€ê¸° í•­ëª© ì—†ìŒ"})]}):n.jsxs("div",{className:"space-y-3",children:[n.jsxs("div",{className:"relative",children:[n.jsx(h,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),n.jsx(y,{placeholder:"ë°œì£¼ë²ˆí˜¸, ì—…ì²´ëª…, í’ˆëª©ìœ¼ë¡œ ê²€ìƒ‰...",value:ae.pending,onChange:e=>se(a=>({...a,pending:e.target.value})),className:"pl-10 h-8 text-xs"})]}),n.jsx("div",{style:{maxHeight:"36rem",overflowY:"auto",display:"flex",flexDirection:"column",gap:"0.375rem"},children:de(e.pendingApprovals,ae.pending).slice(0,10).map((s,t)=>{const r=s.purchase_request_items||[],l=r[0]||{};s.total_amount||r.reduce((e,a)=>e+(Number(a.amount_value)||0),0);const d="ì„ ì§„í–‰"===s.progress_type;return n.jsx("div",{className:"border rounded-lg p-2 hover:shadow-sm transition-all cursor-pointer mb-1.5 "+(d?"bg-red-50 border-red-200":"hover:bg-orange-50/30"),style:{display:"block"},onClick:e=>{e.target.closest("button")||(T(Number(s.id)),M(!0))},children:n.jsxs("div",{className:"flex items-center justify-between gap-2",children:[n.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[n.jsx("span",{className:"card-title",children:s.purchase_order_number}),n.jsx("span",{className:"card-subtitle truncate",children:s.vendor_name||"ì—…ì²´"}),n.jsxs("span",{className:"card-description truncate",children:[l.item_name||"í’ˆëª©"," ",r.length>1&&`ì™¸ ${r.length-1}ê±´`]})]}),n.jsx(i,{size:"sm",onClick:t=>{t.stopPropagation(),(async s=>{if(!e?.employee)return void w.error("ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");if(!confirm("ì •ë§ë¡œ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"))return;A(s);const t=e;a(e=>e?{...e,pendingApprovals:e.pendingApprovals.filter(e=>e.id!==s),stats:{...e.stats,pending:Math.max(0,e.stats.pending-1)}}:e);try{const r=await O.quickApprove(s,e.employee);r.success?(w.success("ìŠ¹ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."),setTimeout(()=>{le(!1)},1e3)):(a(t),w.error(r.error||"ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."))}catch(r){a(t),w.error("ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}finally{A(null)}})(s.id)},disabled:R===s.id,className:"h-7 px-2 text-white badge-text shrink-0 "+("approved"===s.middle_manager_status?"bg-blue-600 hover:bg-blue-700":"bg-green-600 hover:bg-green-700"),children:R===s.id?n.jsx("div",{className:"w-3 h-3 border border-white border-t-transparent rounded-full animate-spin"}):n.jsxs(n.Fragment,{children:["approved"===s.middle_manager_status?"ìµœì¢…":"1ì°¨"," ìŠ¹ì¸"]})})]})},`approval-${s.id}`)})})]})})]}),U.includes("lead buyer")&&n.jsxs(o,{className:"w-full col-span-1 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[n.jsx(m,{className:"py-3 px-4 bg-gray-50 border-b",children:n.jsxs(u,{className:"section-title flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(d,{className:"w-4 h-4 text-yellow-600"}),n.jsx("span",{children:"êµ¬ë§¤ ëŒ€ê¸°"})]}),e.myPurchaseStatus&&e.myPurchaseStatus.waitingPurchase&&e.myPurchaseStatus.waitingPurchase.length>0&&n.jsx("span",{className:"badge-stats bg-yellow-100 text-yellow-700",children:e.myPurchaseStatus.waitingPurchase.length})]})}),n.jsx(p,{className:"p-4",children:e.myPurchaseStatus&&e.myPurchaseStatus.waitingPurchase&&0!==e.myPurchaseStatus.waitingPurchase.length?n.jsxs("div",{className:"space-y-3",children:[n.jsxs("div",{className:"relative",children:[n.jsx(h,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),n.jsx(y,{placeholder:"ë°œì£¼ë²ˆí˜¸, ì—…ì²´ëª…, í’ˆëª©ìœ¼ë¡œ ê²€ìƒ‰...",value:ae.purchase,onChange:e=>se(a=>({...a,purchase:e.target.value})),className:"pl-10 h-8 text-xs"})]}),n.jsx("div",{className:"space-y-2 h-[36rem] overflow-y-auto",children:de(e.myPurchaseStatus.waitingPurchase,ae.purchase).slice(0,10).map(e=>{const a=e.purchase_request_items||[],s=a[0];a.reduce((e,a)=>e+(Number(a.amount_value)||0),0);const t=(e.progress_type||"").includes("ì„ ì§„í–‰");return n.jsx("div",{className:"border rounded-lg p-3 transition-all hover:shadow-sm "+(t?"bg-red-50 hover:bg-red-100 border-red-200":"bg-white hover:bg-gray-50 border-gray-200"),children:n.jsxs("div",{className:"flex items-center justify-between gap-2",children:[n.jsxs("div",{className:"flex items-center gap-2 flex-1 cursor-pointer",onClick:()=>ie(e,"purchase"),children:[n.jsx("span",{className:"card-title",children:e.purchase_order_number||`PO-${e.id.slice(0,8)}`}),n.jsx("span",{className:"card-subtitle truncate",children:e.vendor_name||"ì—…ì²´ëª… ì—†ìŒ"}),n.jsxs("span",{className:"card-description truncate",children:[s?.item_name||"í’ˆëª©",a.length>1&&n.jsxs("span",{className:"text-gray-400",children:[" ì™¸ ",a.length-1,"ê±´"]})]})]}),(U.includes("lead buyer")||U.includes("app_admin"))&&!e.is_payment_completed&&n.jsx(i,{size:"sm",onClick:async a=>{if(a.stopPropagation(),confirm("ì´ ë°œì£¼ë¥¼ êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"))try{const{error:a}=await supabase.from("purchase_requests").update({is_payment_completed:!0,payment_completed_at:(new Date).toISOString()}).eq("id",e.id);if(a)throw a;w.success("êµ¬ë§¤ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."),le(!1)}catch(s){w.error("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}},className:"bg-yellow-600 hover:bg-yellow-700 text-white h-7 px-2 badge-text shrink-0",children:"êµ¬ë§¤ì™„ë£Œ"}),e.is_payment_completed&&n.jsx("div",{className:"bg-green-100 text-green-700 px-2 py-1 business-radius-badge badge-text shrink-0",children:"ì™„ë£Œë¨"})]})},e.id)})})]}):n.jsxs("div",{className:"text-center py-12 text-gray-400",children:[n.jsx(d,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),n.jsx("p",{className:"card-subtitle",children:"êµ¬ë§¤ ëŒ€ê¸° í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤"})]})})]}),n.jsxs(o,{className:"w-full col-span-1 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[n.jsx(m,{className:"py-3 px-4 bg-gray-50 border-b",children:n.jsxs(u,{className:"section-title flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(f,{className:"w-4 h-4 text-blue-600"}),n.jsx("span",{children:"ì…ê³  ëŒ€ê¸°"})]}),e.myPurchaseStatus.waitingDelivery.length>0&&n.jsx("span",{className:"badge-stats bg-blue-100 text-blue-700",children:e.myPurchaseStatus.waitingDelivery.length})]})}),n.jsx(p,{className:"p-4",children:0===e.myPurchaseStatus.waitingDelivery.length?n.jsxs("div",{className:"text-center py-12 text-gray-400",children:[n.jsx(f,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),n.jsx("p",{className:"card-subtitle",children:"ì…ê³  ëŒ€ê¸° í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤"})]}):n.jsxs("div",{className:"space-y-3",children:[n.jsxs("div",{className:"relative",children:[n.jsx(h,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),n.jsx(y,{placeholder:"ë°œì£¼ë²ˆí˜¸, ì—…ì²´ëª…, í’ˆëª©ìœ¼ë¡œ ê²€ìƒ‰...",value:ae.delivery,onChange:e=>se(a=>({...a,delivery:e.target.value})),className:"pl-10 h-8 text-xs"})]}),n.jsx("div",{className:"space-y-2 h-[36rem] overflow-y-auto",children:de(e.myPurchaseStatus.waitingDelivery,ae.delivery).slice(0,10).map(e=>{const a=e.purchase_request_items||[],s=a[0],t=a.length;a.filter(e=>e.is_received).length,a.reduce((e,a)=>e+(Number(a.amount_value)||0),0);const r=(e.progress_type||"").includes("ì„ ì§„í–‰");return n.jsx("div",{className:"border rounded-lg p-3 transition-all cursor-pointer hover:shadow-sm "+(r?"bg-red-50 hover:bg-red-100 border-red-200":"bg-white hover:bg-gray-50 border-gray-200"),onClick:()=>ie(e,"delivery"),children:n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("span",{className:"card-title",children:e.purchase_order_number||`PO-${e.id.slice(0,8)}`}),n.jsx("span",{className:"card-subtitle truncate",children:e.vendor_name||"ì—…ì²´ëª… ì—†ìŒ"}),n.jsxs("span",{className:"card-description truncate",children:[s?.item_name||"í’ˆëª©",t>1&&n.jsxs("span",{className:"text-gray-400",children:[" ì™¸ ",t-1,"ê±´"]})]})]})},e.id)})})]})})]})]})]}),n.jsx(N,{purchaseId:L,isOpen:F,onClose:()=>{M(!1),T(null)},currentUserRoles:U,onRefresh:()=>{le(),M(!1),T(null)}}),n.jsx(I,{isOpen:Z,onClose:()=>{ee(!1),V(null),X(null)},item:J,type:G,onRefresh:()=>le(!1)}),Q&&W&&n.jsx(g,{open:Q,onOpenChange:()=>{Y(!1),H(null)},children:n.jsxs(x,{className:"overflow-hidden bg-white rounded-3xl shadow-2xl border-0",style:{maxWidth:"1280px",width:"90vw",maxHeight:"50vh"},showCloseButton:!1,children:[n.jsx(_,{className:"sr-only",children:n.jsx(b,{children:"ë°œì£¼ ìš”ì²­ ì„¸ë¶€ì‚¬í•­"})}),n.jsxs("div",{className:"relative px-6 pt-6 pb-4",children:[n.jsx("button",{onClick:()=>{Y(!1),H(null)},className:"absolute right-6 top-6 w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-all duration-200",children:n.jsx(l,{className:"w-4 h-4 text-gray-500"})}),n.jsx("div",{className:"pr-16",children:n.jsxs("div",{className:"flex items-start gap-4 mb-2",children:[n.jsx("div",{className:"w-10 h-10 rounded-2xl bg-orange-50 flex items-center justify-center flex-shrink-0",children:n.jsx(D,{className:"w-6 h-6 text-orange-600"})}),n.jsxs("div",{className:"min-w-0 flex-1",children:[n.jsx("h1",{className:"modal-title mb-1",children:W.purchase_order_number||"POë²ˆí˜¸ ì—†ìŒ"}),n.jsx("p",{className:"modal-subtitle",children:W.vendor_name||"ì—…ì²´ëª… ì—†ìŒ"})]}),n.jsx("span",{className:"badge-stats bg-orange-50 text-orange-700",children:"ë¯¸ë‹¤ìš´ë¡œë“œ"})]})})]}),n.jsxs("div",{className:"overflow-y-auto max-h-[calc(50vh-160px)] px-6 pb-4 space-y-3",children:[n.jsx("div",{className:"bg-gray-50 rounded-xl p-3 border border-gray-100",children:n.jsxs("div",{className:"grid grid-cols-3 gap-x-4 gap-y-2 text-xs",children:[n.jsxs("div",{children:[n.jsx("span",{className:"text-gray-500",children:"ìš”ì²­ì:"})," ",n.jsx("span",{className:"font-medium",children:W.requester_name})]}),n.jsxs("div",{children:[n.jsx("span",{className:"text-gray-500",children:"ìš”ì²­ì¼:"})," ",n.jsx("span",{className:"font-medium",children:new Date(W.request_date||W.created_at).toLocaleDateString("ko-KR")})]}),n.jsxs("div",{children:[n.jsx("span",{className:"text-gray-500",children:"ë‚©ê¸°ìš”ì²­ì¼:"})," ",n.jsx("span",{className:"font-medium",children:W.delivery_request_date?new Date(W.delivery_request_date).toLocaleDateString("ko-KR"):"ë¯¸ì§€ì •"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"text-gray-500",children:"ì—…ì²´ëª…:"})," ",n.jsx("span",{className:"font-medium",children:W.vendor_name||"-"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"text-gray-500",children:"ê²°ì œìœ í˜•:"})," ",n.jsx("span",{className:"font-medium",children:W.payment_category||"ì¼ë°˜"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"text-gray-500",children:"ì§„í–‰êµ¬ë¶„:"})," ",n.jsx("span",{className:"font-medium",children:W.progress_type||"ì¼ë°˜"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"text-gray-500",children:"í”„ë¡œì íŠ¸ì—…ì²´:"})," ",n.jsx("span",{className:"font-medium",children:W.project_vendor||"-"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"text-gray-500",children:"íŒë§¤ì£¼ë¬¸ë²ˆí˜¸:"})," ",n.jsx("span",{className:"font-medium",children:W.sales_order_number||"-"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"text-gray-500",children:"ë°°ì†¡ì§€:"})," ",n.jsx("span",{className:"font-medium",children:W.shipping_address||"ë³¸ì‚¬"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"text-gray-500",children:"í†µí™”:"})," ",n.jsx("span",{className:"font-medium",children:W.currency||"KRW"})]}),n.jsxs("div",{children:[n.jsx("span",{className:"text-gray-500",children:"í…œí”Œë¦¿:"})," ",n.jsx("span",{className:"font-medium",children:W.po_template_type||"ì¼ë°˜"})]}),W.revised_delivery_request_date&&n.jsxs("div",{children:[n.jsx("span",{className:"text-orange-500",children:"ë³€ê²½ì…ê³ ì¼:"})," ",n.jsx("span",{className:"font-medium text-orange-900",children:new Date(W.revised_delivery_request_date).toLocaleDateString("ko-KR")})]})]})}),n.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 overflow-hidden",children:[n.jsx("div",{className:"bg-gray-50 px-3 py-2 border-b border-gray-100",children:n.jsxs("h3",{className:"text-sm font-medium text-gray-700",children:["ì£¼ë¬¸ í’ˆëª© (",(W.purchase_request_items||[]).length,"ê°œ, ì´ â‚©",(W.purchase_request_items||[]).reduce((e,a)=>e+(Number(a.amount_value)||0),0).toLocaleString(),")"]})}),n.jsx("div",{className:"overflow-x-auto",children:n.jsxs("table",{className:"w-full text-xs table-fixed",children:[n.jsxs("colgroup",{children:[n.jsx("col",{className:"w-[30%]"}),n.jsx("col",{className:"w-[25%]"}),n.jsx("col",{className:"w-[10%]"}),n.jsx("col",{className:"w-[15%]"}),n.jsx("col",{className:"w-[20%]"})]}),n.jsx("thead",{className:"bg-gray-50 border-b border-gray-100",children:n.jsxs("tr",{children:[n.jsx("th",{className:"text-left p-2 font-medium text-gray-600",children:"í’ˆëª©ëª…"}),n.jsx("th",{className:"text-left p-2 font-medium text-gray-600",children:"ê·œê²©"}),n.jsx("th",{className:"text-right p-2 font-medium text-gray-600",children:"ìˆ˜ëŸ‰"}),n.jsx("th",{className:"text-right p-2 font-medium text-gray-600",children:"ë‹¨ê°€"}),n.jsx("th",{className:"text-right p-2 font-medium text-gray-600",children:"ê¸ˆì•¡"})]})}),n.jsx("tbody",{className:"divide-y divide-gray-100",children:(W.purchase_request_items||[]).map((e,a)=>{const s=e.quantity>0?(Number(e.amount_value)||0)/e.quantity:0;return n.jsxs("tr",{className:"hover:bg-gray-50",children:[n.jsxs("td",{className:"p-2",children:[n.jsx("div",{className:"font-medium text-gray-900",children:e.item_name||"í’ˆëª©ëª… ì—†ìŒ"}),e.remark&&n.jsxs("div",{className:"text-xs text-amber-600 mt-1",children:["ë¹„ê³ : ",e.remark]})]}),n.jsx("td",{className:"p-2 text-gray-600",children:e.specification||"-"}),n.jsx("td",{className:"p-2 text-right font-medium",children:e.quantity||0}),n.jsxs("td",{className:"p-2 text-right",children:["â‚©",s.toLocaleString()]}),n.jsxs("td",{className:"p-2 text-right font-medium",children:["â‚©",(Number(e.amount_value)||0).toLocaleString()]})]},a)})})]})})]})]}),n.jsx("div",{className:"sticky bottom-0 bg-white border-t border-gray-100 px-6 py-6",children:n.jsxs("div",{className:"flex items-center justify-between gap-6",children:[n.jsxs(i,{onClick:()=>ce(W),disabled:K.has(W.id),className:"bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white px-8 py-4 rounded-2xl shadow-lg transition-all duration-200 modal-subtitle",children:[K.has(W.id)?n.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-3"}):n.jsx(D,{className:"w-5 h-5 mr-3"}),"Excel ë‹¤ìš´ë¡œë“œ"]}),n.jsxs("div",{className:"flex items-center gap-4 ml-auto",children:[n.jsxs(i,{variant:"outline",onClick:()=>{te("/purchase/list?tab=purchase"),Y(!1),H(null)},className:"border-gray-300 text-gray-700 hover:bg-gray-50 hover:text-gray-900 hover:border-gray-400 px-8 py-4 rounded-2xl modal-subtitle transition-all duration-200",children:["ë°œì£¼ ëª©ë¡ì—ì„œ ë³´ê¸°",n.jsx(k,{className:"w-5 h-5 ml-3"})]}),n.jsx(i,{onClick:()=>{Y(!1),H(null)},className:"bg-gray-900 hover:bg-gray-800 text-white px-10 py-4 rounded-2xl modal-subtitle transition-all duration-200 shadow-lg",children:"ì™„ë£Œ"})]})]})})]})})]})}export{A as default};
//# sourceMappingURL=DashboardMain-DvCjoQlc.js.map
