import{c as e,l as t,u as a,p as s,C as r,a as n,b as i,r as l,d,j as o,P as c,B as u,M as m}from"./index-OhAlTnXm.js";import{C as p,a as h,b as g,c as _,S as f,T as y}from"./card-DihKXQy2.js";import{I as v}from"./dialog-BNCLF8EC.js";import{A as x,a as b,b as w,c as j,d as N,e as q,f as S,g as D}from"./alert-dialog-BBZJTjgD.js";import{u as P,D as C,d as M}from"./DeliveryDateWarningModal-DMdlifJN.js";import{C as T,T as A,P as R}from"./PurchaseDetailModal-DDTOks9x.js";import{t as F}from"./index-DHCdAbzM.js";import{s as I}from"./supportService-C4QE9-Fj.js";import{C as k}from"./clock-Cr2V4R_O.js";import{D as O}from"./download-Bv3ekGH3.js";import{f as E}from"./react-select.esm-MWsEDFnU.js";import"./helpers-CmqE03mo.js";import"./progress-Xq1yFnuf.js";import"./textarea-DpPMQXSK.js";import"./popover-LDFkB-hM.js";import"./calendar-BqXThlL6.js";import"./check-oKo7AeuV.js";import"./loader-circle-BonUffEQ.js";import"./credit-card-BbgstfM1.js";import"./save-Cdwj6v0x.js";import"./chevron-right-B82EHtZl.js";const U={data:null,lastFetch:0,CACHE_DURATION:3e4,employeeId:null};const $=new class{constructor(){this.supabase=e()}hasValidPurchaseMemory(e){if(!s.allPurchases||0===s.allPurchases.length)return!1;if(!e?.id)return!1;const t=Date.now()-(s.lastFetch||0)<r,a=s.currentUser?.id===String(e.id);return t&&a}invalidateDashboardCache(){U.data=null,U.lastFetch=0,U.employeeId=null}invalidateCache(){this.invalidateDashboardCache()}hasValidCache(e){const t=Date.now(),a=null!==U.data&&U.employeeId===e&&t-U.lastFetch<U.CACHE_DURATION,s=this.hasValidPurchaseMemory({id:e});return a||s}getPurchaseMemory(){return s.allPurchases||[]}parseRoles(e){let t=[];if(e)if(Array.isArray(e))t=e.map(e=>String(e).trim());else{t=String(e).split(",").map(e=>e.trim()).filter(e=>e.length>0)}return t}async getDashboardData(e,a=!1){const s=Date.now();if(!a&&U.data&&U.employeeId===e.id&&s-U.lastFetch<U.CACHE_DURATION&&U.data)return U.data;const r=!a&&this.hasValidPurchaseMemory(e),n=await Promise.allSettled([r?this.getDashboardStatsFromMemory(e):this.getDashboardStats(e),r?this.getMyRecentRequestsFromMemory(e):this.getMyRecentRequests(e),r?this.getPendingApprovalsFromMemory(e):this.getPendingApprovals(e),r?this.getQuickActionsFromMemory(e):this.getQuickActions(e),r?this.getTodaySummaryFromMemory(e):this.getTodaySummary(e),r?this.getMyPurchaseStatusFromMemory(e):this.getMyPurchaseStatus(e)]),i=n[0],l=n[1],d=n[2],o=n[3],c=n[4],u=n[5],m="fulfilled"===i.status?i.value:{total:0,myRequests:0,pending:0,completed:0,urgent:0,todayActions:0},p="fulfilled"===l.status?l.value:[],h="fulfilled"===d.status?d.value:[],g="fulfilled"===o.status?o.value:[],_="fulfilled"===c.status?c.value:{approved:0,requested:0,received:0},f="fulfilled"===u.status?u.value:{waitingPurchase:[],waitingDelivery:[],recentCompleted:[]};"rejected"===i.status&&t.error("[DashboardService] getDashboardStats ì‹¤íŒ¨:",i.reason),"rejected"===l.status&&t.error("[DashboardService] getMyRecentRequests ì‹¤íŒ¨:",l.reason),"rejected"===d.status&&t.error("[DashboardService] getPendingApprovals ì‹¤íŒ¨:",d.reason),"rejected"===o.status&&t.error("[DashboardService] getQuickActions ì‹¤íŒ¨:",o.reason),"rejected"===c.status&&t.error("[DashboardService] getTodaySummary ì‹¤íŒ¨:",c.reason),"rejected"===u.status&&t.error("[DashboardService] getMyPurchaseStatus ì‹¤íŒ¨:",u.reason);const y={employee:e,stats:m,urgentRequests:[],myRecentRequests:p,pendingApprovals:h,quickActions:g,todaySummary:_,myPurchaseStatus:f};return U.data=y,U.lastFetch=s,U.employeeId=e.id,y}isPendingStatus(e){return"pending"===e||"ëŒ€ê¸°"===e||""===e||null==e}toTime(e){if(!e)return 0;const t=new Date(e).getTime();return Number.isFinite(t)?t:0}async getDashboardStatsFromMemory(e){const t=this.getPurchaseMemory(),a=(new Date).toISOString().split("T")[0],s=this.parseRoles(e.purchase_role);e.name||e.email;const r=new Date((new Date).getFullYear(),(new Date).getMonth(),1).toISOString(),n=new Date(Date.now()-2592e5).toISOString();return{total:t.length,myRequests:t.filter(t=>(t.requester_name||"")===e.name).length,pending:await this.getPendingCountFromMemory(e,s),completed:t.filter(e=>!0===e.is_received&&this.toTime(e.received_at)>=this.toTime(r)).length,urgent:this.getUrgentCountFromMemory(e,s,n),todayActions:this.getTodayActionsCountFromMemory(e,a)}}async getMyRecentRequestsFromMemory(e){const t=this.getPurchaseMemory(),a=e.name||e.email;return t.filter(e=>(e.requester_name||"")===a).filter(e=>{const t="approved"===e.middle_manager_status,a=this.isPendingStatus(e.final_manager_status),s="approved"===e.final_manager_status,r=!e.is_payment_completed;return t&&a||s&&r}).sort((e,t)=>this.toTime(t.created_at)-this.toTime(e.created_at)).slice(0,5).map(e=>({...e,vendor_name:e.vendor_name,total_items:(e.purchase_request_items||[]).length,progress_percentage:this.calculateProgress(e),current_step:this.getCurrentStep(e),next_action:this.getNextAction(e),estimated_completion:this.estimateCompletion(e)}))}async getPendingApprovalsFromMemory(e){const t=this.parseRoles(e.purchase_role);if(0===t.length)return[];const a=[...this.getPurchaseMemory()].sort((e,t)=>this.toTime(t.request_date)-this.toTime(e.request_date)).filter(e=>{const t=this.isPendingStatus(e.middle_manager_status),a=this.isPendingStatus(e.final_manager_status),s="rejected"===e.middle_manager_status,r="rejected"===e.final_manager_status;return!s&&!r&&(t||a)});let s=a;t.includes("app_admin")||(s=t.includes("middle_manager")?a.filter(e=>this.isPendingStatus(e.middle_manager_status)):t.includes("final_approver")||t.includes("ceo")||t.includes("raw_material_manager")||t.includes("consumable_manager")?a.filter(e=>"approved"===e.middle_manager_status&&this.isPendingStatus(e.final_manager_status)):t.includes("lead buyer")?a.filter(e=>"approved"===e.final_manager_status&&!e.is_payment_completed):[]);return s.slice(0,100).map(e=>{const t=e.purchase_request_items||e.items||[],a=Number(e.total_amount)||t.reduce((e,t)=>e+(Number(t?.amount_value)||(Number(t?.quantity)||0)*(Number(t?.unit_price_value)||0)),0);return{...e,purchase_request_items:t,items:t,total_amount:a,vendor_name:e.vendor_name||e.project_vendor||e.vendor?.vendor_name}})}async getQuickActionsFromMemory(e){const t=this.parseRoles(e.purchase_role),a=[];if(t.includes("app_admin")||t.includes("middle_manager")||t.includes("final_approver")||t.includes("ceo")){const s=await this.getPendingCountFromMemory(e,t);s>0&&a.push({id:"approve",type:"approve",label:"ìŠ¹ì¸ ëŒ€ê¸°",description:`${s}ê±´ì˜ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘`,count:s,color:"red"})}if(t.includes("lead buyer")||t.includes("lead buyer")){const e=this.getPurchaseMemory().filter(e=>"approved"===e.final_manager_status&&!1===e.is_payment_completed).length;e>0&&a.push({id:"purchase",type:"purchase",label:"êµ¬ë§¤ ì²˜ë¦¬",description:`${e}ê±´ì˜ êµ¬ë§¤ ëŒ€ê¸° ì¤‘`,count:e,color:"yellow"})}return a}async getTodaySummaryFromMemory(e){const t=this.getPurchaseMemory(),a=(new Date).toISOString().split("T")[0],s=new Date(Date.now()+864e5).toISOString().split("T")[0],r=e=>{const t=this.toTime(e);return t>=this.toTime(a)&&t<this.toTime(s)};return{approved:t.filter(e=>r(e.updated_at)&&("approved"===e.middle_manager_status||"approved"===e.final_manager_status)).length,requested:t.filter(t=>(t.requester_name||"")===e.name&&r(t.created_at)).length,received:t.filter(e=>!0===e.is_received&&r(e.received_at)).length}}async getMyPurchaseStatusFromMemory(e){const t=this.parseRoles(e.purchase_role),a=t.includes("lead buyer")||t.includes("app_admin"),s=e.name||e.email,r=this.getPurchaseMemory(),n=new Date(Date.now()-6048e5).toISOString(),i=(a?r:r.filter(e=>(e.requester_name||"")===s)).filter(e=>{const t="êµ¬ë§¤ ìš”ì²­"===(e.payment_category||"").trim(),a=!e.is_payment_completed;if(!t||!a)return!1;if((e.progress_type||"").includes("ì„ ì§„í–‰"))return!0;const s=(e.progress_type||"").includes("ì¼ë°˜")||!e.progress_type||""===e.progress_type,r="approved"===e.final_manager_status;return s&&r}),l=r.filter(e=>{const t=!e.is_received,a=(e.progress_type||"").includes("ì„ ì§„í–‰");if((e.requester_name||"")!==s)return!1;if(t&&a)return!0;const r="approved"===e.final_manager_status;return t&&r}),d=r.filter(e=>!0===e.is_received&&(!!e.received_at&&((e.requester_name||"")===s&&this.toTime(e.received_at)>=this.toTime(n)))),o=(e,t)=>this.toTime(t.created_at)-this.toTime(e.created_at);return{waitingPurchase:[...i].sort(o),waitingDelivery:[...l].sort(o),recentCompleted:[...d].sort(o)}}async getPendingCountFromMemory(e,t){const a=this.getPurchaseMemory();if(t.includes("app_admin")){return a.filter(e=>this.isPendingStatus(e.middle_manager_status)).length+a.filter(e=>"approved"===e.middle_manager_status&&this.isPendingStatus(e.final_manager_status)).length+a.filter(e=>"approved"===e.final_manager_status&&!1===e.is_payment_completed).length}return t.includes("middle_manager")?a.filter(e=>this.isPendingStatus(e.middle_manager_status)).length:t.includes("final_approver")||t.includes("ceo")?a.filter(e=>"approved"===e.middle_manager_status&&this.isPendingStatus(e.final_manager_status)).length:t.includes("lead buyer")?a.filter(e=>"approved"===e.final_manager_status&&!1===e.is_payment_completed).length:0}getUrgentCountFromMemory(e,t,a){const s=this.getPurchaseMemory(),r=this.toTime(a),n=s.filter(e=>this.toTime(e.created_at)>0&&this.toTime(e.created_at)<r);return t.includes("app_admin")?n.filter(e=>"pending"===e.middle_manager_status||"pending"===e.final_manager_status||!1===e.is_payment_completed).length:t.includes("middle_manager")?n.filter(e=>"pending"===e.middle_manager_status).length:t.includes("final_approver")||t.includes("ceo")?n.filter(e=>"approved"===e.middle_manager_status&&"pending"===e.final_manager_status).length:t.includes("lead buyer")?n.filter(e=>"approved"===e.final_manager_status&&!1===e.is_payment_completed).length:0}getTodayActionsCountFromMemory(e,t){const a=this.getPurchaseMemory(),s=new Date(Date.now()+864e5).toISOString().split("T")[0],r=e=>{const a=this.toTime(e);return a>=this.toTime(t)&&a<this.toTime(s)};return a.filter(t=>r(t.updated_at)&&(t.requester_name||"")===e.name).length}async getDashboardStats(e){const t=(new Date).toISOString().split("T")[0],a=this.parseRoles(e.purchase_role),[s,r,n,i,l,d]=await Promise.all([this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("requester_name",e.name),this.getPendingCount(e,a),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("is_received",!0).gte("received_at",new Date((new Date).getFullYear(),(new Date).getMonth(),1).toISOString()),this.getUrgentCount(e,a),this.getTodayActionsCount(e,t)]);return{total:s.count||0,myRequests:r.count||0,pending:n,completed:i.count||0,urgent:l,todayActions:d}}async getMyRecentRequests(e){const{data:t}=await this.supabase.from("purchase_requests").select("*,vendors(vendor_name),purchase_request_items(id)").eq("requester_name",e.name).or("and(middle_manager_status.eq.approved,final_manager_status.eq.pending),and(final_manager_status.eq.approved,is_payment_completed.eq.false)").order("created_at",{ascending:!1}).limit(5);return(t||[]).map(e=>({...e,vendor_name:e.vendors?.vendor_name,total_items:e.purchase_request_items?.length||0,progress_percentage:this.calculateProgress(e),current_step:this.getCurrentStep(e),next_action:this.getNextAction(e),estimated_completion:this.estimateCompletion(e)}))}async getPendingApprovals(e){const a=this.parseRoles(e.purchase_role);if(0===a.length)return[];t.debug("ðŸš€ ìŠ¹ì¸ ëŒ€ê¸° í•­ëª© ì¡°íšŒ ì‹œìž‘",{employeeName:e.name,employeeRoles:a});const{data:s,error:r}=await this.supabase.from("purchase_requests").select("\n        *,\n        vendors(vendor_name),\n        purchase_request_items(\n          id,\n          item_name,\n          specification,\n          quantity,\n          unit_price_value,\n          amount_value\n        )\n      ").order("request_date",{ascending:!1}).limit(100);if(r)return t.error("âŒ ìŠ¹ì¸ ëŒ€ê¸° í•­ëª© ì¡°íšŒ ì‹¤íŒ¨",r),[];let n=s||[];const i=e=>"pending"===e||"ëŒ€ê¸°"===e||""===e||null==e;t.debug("ðŸ” ìŠ¹ì¸ ëŒ€ê¸° í•„í„°ë§ ì „ ë°ì´í„°",{totalRequests:s?.length||0}),n=n.filter(e=>{const t=i(e.middle_manager_status),a=i(e.final_manager_status),s="rejected"===e.middle_manager_status,r="rejected"===e.final_manager_status;return!s&&!r&&(t||a)});let l=n;a.includes("app_admin")?t.debug("ðŸ”‘ app_admin ê¶Œí•œìœ¼ë¡œ ëª¨ë“  ìŠ¹ì¸ëŒ€ê¸° í•­ëª© í‘œì‹œ",{totalItems:l.length}):a.includes("middle_manager")?(l=n.filter(e=>i(e.middle_manager_status)),t.debug("ðŸ”‘ middle_manager ê¶Œí•œìœ¼ë¡œ ì¤‘ê°„ìŠ¹ì¸ ëŒ€ê¸° í•­ëª©ë§Œ í‘œì‹œ",{beforeFilter:n.length,afterFilter:l.length})):a.includes("final_approver")||a.includes("ceo")?(l=n.filter(e=>{const t="approved"===e.middle_manager_status,a=i(e.final_manager_status);return t&&a}),t.debug("ðŸ”‘ final_approver/ceo ê¶Œí•œìœ¼ë¡œ ìµœì¢…ìŠ¹ì¸ ëŒ€ê¸° í•­ëª©ë§Œ í‘œì‹œ",{beforeFilter:n.length,afterFilter:l.length})):a.includes("raw_material_manager")||a.includes("consumable_manager")?(l=n.filter(e=>{const t="approved"===e.middle_manager_status,a=i(e.final_manager_status);return t&&a}),t.debug("ðŸ”‘ material_manager ê¶Œí•œìœ¼ë¡œ ìµœì¢…ìŠ¹ì¸ ëŒ€ê¸° í•­ëª©ë§Œ í‘œì‹œ",{beforeFilter:n.length,afterFilter:l.length})):a.includes("lead buyer")?(l=n.filter(e=>{const t="approved"===e.final_manager_status,a=!e.is_payment_completed;return t&&a}),t.debug("ðŸ”‘ lead buyer ê¶Œí•œìœ¼ë¡œ êµ¬ë§¤ ëŒ€ê¸° í•­ëª©ë§Œ í‘œì‹œ",{beforeFilter:n.length,afterFilter:l.length})):(l=[],t.debug("ðŸ”‘ ìŠ¹ì¸ ê¶Œí•œ ì—†ëŠ” ì—­í• ",{roles:a,result:"empty"}));const d=l.map(e=>{const t=e.vendors?.vendor_name||e.vendor_name||"ì—…ì²´ ì •ë³´ ì—†ìŒ",a=e.purchase_request_items||[],s=a.reduce((e,t)=>e+(Number(t?.amount_value)||(Number(t?.quantity)||0)*(Number(t?.unit_price_value)||0)),0);return{...e,vendor_name:t,purchase_request_items:a,total_amount:s}});return t.debug("âœ… ìŠ¹ì¸ ëŒ€ê¸° í•­ëª© ì¡°íšŒ ì™„ë£Œ (ìµœì í™”ë¨)",{finalCount:d.length,performanceNote:"N+1 ë¬¸ì œ í•´ê²° - ë‹¨ì¼ JOIN ì¿¼ë¦¬ ì‚¬ìš©"}),d}async getQuickActions(e){const t=this.parseRoles(e.purchase_role),a=[];if(t.includes("app_admin")||t.includes("middle_manager")||t.includes("final_approver")||t.includes("ceo")){const s=await this.getPendingCount(e,t);s>0&&a.push({id:"approve",type:"approve",label:"ìŠ¹ì¸ ëŒ€ê¸°",description:`${s}ê±´ì˜ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘`,count:s,color:"red"})}if(t.includes("lead buyer")||t.includes("lead buyer")){const{count:e}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("final_manager_status","approved").eq("is_payment_completed",!1);e&&e>0&&a.push({id:"purchase",type:"purchase",label:"êµ¬ë§¤ ì²˜ë¦¬",description:`${e}ê±´ì˜ êµ¬ë§¤ ëŒ€ê¸° ì¤‘`,count:e,color:"yellow"})}return a}async getTodaySummary(e){const t=(new Date).toISOString().split("T")[0],a=new Date(Date.now()+864e5).toISOString().split("T")[0],[s,r,n]=await Promise.all([this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).gte("updated_at",t).lt("updated_at",a).or("middle_manager_status.eq.approved,final_manager_status.eq.approved"),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("requester_name",e.name).gte("created_at",t).lt("created_at",a),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("is_received",!0).gte("received_at",t).lt("received_at",a)]);return{approved:s.count||0,requested:r.count||0,received:n.count||0}}async getMyPurchaseStatus(e){const a=this.parseRoles(e.purchase_role),s=a.includes("lead buyer")||a.includes("app_admin"),r=e.name||e.email,n=new Date(Date.now()-6048e5).toISOString();let i=this.supabase.from("purchase_requests").select("*,vendors(vendor_name),purchase_request_items(*)").order("created_at",{ascending:!1}).limit(500);s||(i=i.eq("requester_name",r));const l=await i;if(l.error)return t.error("getMyPurchaseStatus ì—ëŸ¬",l.error),{waitingPurchase:[],waitingDelivery:[],recentCompleted:[]};const d=l.data||[];return{waitingPurchase:d.filter(e=>{const t="êµ¬ë§¤ ìš”ì²­"===(e.payment_category||"").trim(),a=!e.is_payment_completed;if(!t||!a)return!1;if((e.progress_type||"").includes("ì„ ì§„í–‰"))return!0;const s=(e.progress_type||"").includes("ì¼ë°˜")||!e.progress_type||""===e.progress_type,r="approved"===e.final_manager_status;return s&&r}),waitingDelivery:d.filter(e=>{const t=!e.is_received,a=(e.progress_type||"").includes("ì„ ì§„í–‰");if(e.requester_name!==r)return!1;if(t&&a)return!0;const s="approved"===e.final_manager_status;return t&&s}),recentCompleted:d.filter(e=>{if(!0!==e.is_received)return!1;if(!e.received_at)return!1;if(e.requester_name!==r)return!1;return new Date(e.received_at)>=new Date(n)})}}async quickApprove(e,t){try{const s=this.parseRoles(t.purchase_role),{data:r}=await this.supabase.from("purchase_requests").select("middle_manager_status, final_manager_status").eq("id",e).single();if(!r)return{success:!1,error:"ìš”ì²­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."};let n={},i=null;const l=e=>"pending"===e||"ëŒ€ê¸°"===e||""===e||null==e;if(s.includes("app_admin")?l(r.middle_manager_status)?(n={middle_manager_status:"approved"},i="middle"):"approved"===r.middle_manager_status&&l(r.final_manager_status)&&(n={final_manager_status:"approved"},i="final"):s.includes("middle_manager")?l(r.middle_manager_status)&&(n={middle_manager_status:"approved"},i="middle"):s.includes("final_approver")||s.includes("ceo")?"approved"===r.middle_manager_status&&l(r.final_manager_status)&&(n={final_manager_status:"approved"},i="final"):(s.includes("raw_material_manager")||s.includes("consumable_manager"))&&"approved"===r.middle_manager_status&&l(r.final_manager_status)&&(n={final_manager_status:"approved"},i="final"),!i||0===Object.keys(n).length)return{success:!1,error:"ìŠ¹ì¸í•  ìˆ˜ ìžˆëŠ” ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤."};const{error:d}=await this.supabase.from("purchase_requests").update(n).eq("id",e);if(d)throw d;return a(e,e=>({...e,...n})),this.invalidateDashboardCache(),{success:!0,stage:i}}catch(s){return{success:!1,error:s.message}}}async getPendingCount(e,t){if(t.includes("app_admin")){const[e,t,a]=await Promise.all([this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).or("middle_manager_status.in.(pending,ëŒ€ê¸°),middle_manager_status.is.null"),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("middle_manager_status","approved").or("final_manager_status.in.(pending,ëŒ€ê¸°),final_manager_status.is.null"),this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("final_manager_status","approved").eq("is_payment_completed",!1)]);return(e.count||0)+(t.count||0)+(a.count||0)}if(t.includes("middle_manager")){const{count:e,error:t}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).or("middle_manager_status.in.(pending,ëŒ€ê¸°),middle_manager_status.is.null");return t?0:e||0}if(t.includes("final_approver")||t.includes("ceo")){const{count:e,error:t}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("middle_manager_status","approved").or("final_manager_status.in.(pending,ëŒ€ê¸°),final_manager_status.is.null");return t?0:e||0}if(t.includes("lead buyer")){const{count:e,error:t}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("final_manager_status","approved").eq("is_payment_completed",!1);return t?0:e||0}return 0}async getUrgentCount(e,t){if(0===t.length)return 0;const a=new Date(Date.now()-2592e5).toISOString();let s=this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).lt("created_at",a);if(t.includes("app_admin"))s=s.or("middle_manager_status.eq.pending,final_manager_status.eq.pending,is_payment_completed.eq.false");else if(t.includes("middle_manager"))s=s.eq("middle_manager_status","pending");else if(t.includes("final_approver")||t.includes("ceo"))s=s.eq("middle_manager_status","approved").eq("final_manager_status","pending");else{if(!t.includes("lead buyer"))return 0;s=s.eq("final_manager_status","approved").eq("is_payment_completed",!1)}const{count:r}=await s;return r||0}async getTodayActionsCount(e,t){const a=new Date(Date.now()+864e5).toISOString().split("T")[0],{count:s}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).gte("updated_at",t).lt("updated_at",a).eq("requester_name",e.name);return s||0}async getTotalDeliveryWaitingCount(){const{count:e}=await this.supabase.from("purchase_requests").select("id",{count:"exact",head:!0}).eq("is_received",!1).or("is_payment_completed.eq.true,progress_type.ilike.%ì„ ì§„í–‰%");return e||0}calculateProgress(e){let t=0;return"approved"===e.middle_manager_status&&(t+=25),"approved"===e.final_manager_status&&(t+=25),e.is_payment_completed&&(t+=25),e.is_received&&(t+=25),t}getCurrentStep(e){return e.is_received?"completed":e.is_payment_completed?"delivery":"approved"===e.final_manager_status?"purchase":"approval"}getNextAction(e){return"pending"===e.middle_manager_status?"ì¤‘ê°„ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘":"pending"===e.final_manager_status?"ìµœì¢… ìŠ¹ì¸ ëŒ€ê¸° ì¤‘":e.is_payment_completed?e.is_received?"ì™„ë£Œ":"ìž…ê³  ëŒ€ê¸° ì¤‘":"êµ¬ë§¤ ì²˜ë¦¬ ëŒ€ê¸° ì¤‘"}estimateCompletion(e){const t=new Date(e.created_at),a=new Date;Math.floor((a.getTime()-t.getTime())/864e5);let s=7;"ê¸´ê¸‰"===e.progress_type&&(s=3);return new Date(t.getTime()+24*s*60*60*1e3).toLocaleDateString("ko-KR")}async getUndownloadedOrders(e){const a=this.parseRoles(e.purchase_role);if(!a.includes("lead buyer")&&!a.includes("app_admin"))return t.info("[DashboardService] ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œ ì¡°íšŒ ê¶Œí•œ ì—†ìŒ:",{roles:a}),[];if(this.hasValidPurchaseMemory(e)){return this.getPurchaseMemory().filter(e=>!0!==e.is_po_download).sort((e,t)=>this.toTime(t.created_at)-this.toTime(e.created_at)).slice(0,500).filter(e=>!0!==e.is_po_download&&("ì„ ì§„í–‰"===e.progress_type||"approved"===e.final_manager_status))}try{const{data:e,error:a}=await this.supabase.from("purchase_requests").select("\n          *,\n          purchase_request_items(\n            id,\n            item_name,\n            specification,\n            quantity,\n            unit_price_value,\n            amount_value\n          )\n        ").or("is_po_download.is.null,is_po_download.eq.false").order("created_at",{ascending:!1}).limit(500);if(a)throw t.error("[DashboardService] ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œ ì¡°íšŒ ì¿¼ë¦¬ ì—ëŸ¬:",a),a;return(e||[]).filter(e=>!0!==e.is_po_download&&("ì„ ì§„í–‰"===e.progress_type||"approved"===e.final_manager_status))}catch(s){throw t.error("[DashboardService] getUndownloadedOrders ì—ëŸ¬:",s),s}}};function H(){const s=n(),{employee:r,currentUserRoles:U,currentUserName:H}=i(),L=Boolean(r?.id&&$.hasValidCache(r.id)),[V,Q]=l.useState(null),[B,K]=l.useState(!L),[W,Y]=l.useState(null),[J,z]=l.useState([]),[G,X]=l.useState([]),[Z,ee]=l.useState(new Set),[te,ae]=l.useState(new Set),[se,re]=l.useState([]),[ne,ie]=l.useState(!1),[le,de]=l.useState(null),oe=e(),[ce,ue]=l.useState(null),[me,pe]=l.useState(!1),[he,ge]=l.useState("pending"),[_e,fe]=l.useState(!1),[ye,ve]=l.useState(null),[xe,be]=l.useState(!1),we=l.useRef(!1),[je,Ne]=l.useState({undownloaded:"",pending:"",purchase:"",delivery:""}),qe=l.useCallback(async(e=!0,a=!1)=>{if(!r)return t.error("[DashboardMain] No employee data available"),void(e&&K(!1));try{!e||a||V||K(!0);const n=await $.getDashboardData(r,a),i=n.pendingApprovals.filter(e=>!te.has(String(e.id))),l=n.pendingApprovals.length-i.length,d=n.stats?{...n.stats,pending:Math.max(0,n.stats.pending-l)}:n.stats;if(l>0&&ae(e=>{const t=new Set(e);return i.forEach(e=>t.delete(String(e.id))),t}),Q({...n,pendingApprovals:i,stats:d}),z(U),U.includes("lead buyer")||U.includes("app_admin"))try{const e=await $.getUndownloadedOrders(r);t.info("[DashboardMain] ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œ ì¡°íšŒ ê²°ê³¼:",{count:e.length,userRoles:U,employeeName:r.name,sampleItems:e.slice(0,3).map(e=>({purchase_order_number:e.purchase_order_number,requester_name:e.requester_name,vendor_name:e.vendor_name}))}),X(e)}catch(s){t.error("[DashboardMain] ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œ ì¡°íšŒ ì‹¤íŒ¨:",s),F.error("ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}}catch(n){t.error("[DashboardMain] Failed to load dashboard data:",n),F.error("ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."),K(!1),Q(null)}finally{e&&K(!1)}},[r,U,te]);l.useEffect(()=>{qe()},[qe]);const Se=l.useRef(!0);l.useEffect(()=>{const e=d(()=>{Se.current?Se.current=!1:qe(!1,!0)});return()=>e()},[qe]),l.useEffect(()=>{if(!J.includes("app_admin"))return;(async()=>{try{ie(!0);const e=await I.getAllInquiries();if(e.success){const t=e.data.filter(e=>"open"===e.status||"in_progress"===e.status);re(t)}}catch(e){t.error("[DashboardMain] ë¬¸ì˜ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:",e)}finally{ie(!1)}})()},[J]),l.useEffect(()=>{if(!J.includes("app_admin"))return;const e=I.subscribeToInquiries(e=>{const t=e?.eventType,a=e?.new,s=e?.old;if("DELETE"===t){const e=s?.id;if(!e)return;return re(t=>t.filter(t=>t.id!==e)),void(le===e&&de(null))}const r=a;r?.id&&re(e=>{const t="open"===r.status||"in_progress"===r.status,a=e.findIndex(e=>e.id===r.id);if(!t)return-1===a?e:e.filter(e=>e.id!==r.id);const s=[...e];return a>=0?s[a]=r:s.unshift(r),s.sort((e,t)=>{const a=e.created_at?new Date(e.created_at).getTime():0;return(t.created_at?new Date(t.created_at).getTime():0)-a}),s})});return()=>{e.unsubscribe()}},[J,le]);const De=async e=>{const t=String(e);if(!V?.employee)return void F.error("ì‚¬ìš©ìž ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");if(!confirm("ì •ë§ë¡œ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"))return;Y(t);const s=V;try{const e=await $.quickApprove(t,V.employee);e.success&&e.stage?(r=e.stage,Q(e=>{if(!e)return e;if("middle"===r)return{...e,pendingApprovals:e.pendingApprovals.map(e=>String(e.id)===t?{...e,middle_manager_status:"approved"}:e)};ae(e=>{const a=new Set(e);return a.add(t),a});const a=Math.max(0,(e.stats?.pending||0)-1);return{...e,pendingApprovals:e.pendingApprovals.filter(e=>String(e.id)!==t),stats:e.stats?{...e.stats,pending:a}:e.stats}}),a(t,t=>"middle"===e.stage?{...t,middle_manager_status:"approved"}:{...t,final_manager_status:"approved"}),F.success("ìŠ¹ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."),setTimeout(()=>qe(!1,!0),500)):(Q(s),F.error(e.error||"ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."))}catch(n){Q(s),F.error("ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}finally{Y(null)}var r},Pe=(e,t="pending")=>{ue(Number(e.id)),ge(t),pe(!0)},Ce=l.useCallback((e,t)=>t.trim()?e.filter(e=>[e.purchase_order_number||"",e.vendor_name||"",(e.purchase_request_items||[]).map(e=>e.item_name||"").join(" ")].join(" ").toLowerCase().includes(t.toLowerCase())):e,[]),Me=l.useMemo(()=>Ce(G,je.undownloaded),[G,je.undownloaded,Ce]),Te=l.useMemo(()=>Ce(V?.pendingApprovals||[],je.pending),[V?.pendingApprovals,je.pending,Ce]);l.useMemo(()=>Ce(V?.myPurchaseStatus?.waitingPurchase||[],je.purchase),[V?.myPurchaseStatus?.waitingPurchase,je.purchase,Ce]);const Ae=l.useMemo(()=>Ce(V?.myPurchaseStatus?.waitingDelivery||[],je.delivery),[V?.myPurchaseStatus?.waitingDelivery,je.delivery,Ce]),Re=l.useMemo(()=>V?.myPurchaseStatus?.waitingDelivery?V.myPurchaseStatus.waitingDelivery.map(e=>({...e,id:"string"==typeof e.id?parseInt(e.id)||0:e.id,purchase_request_items:e.purchase_request_items||[]})):[],[V?.myPurchaseStatus?.waitingDelivery]),Fe=P(Re,H);l.useEffect(()=>{if(!we.current&&!B&&Fe>0&&Re.length>0){const e=setTimeout(()=>{we.current||(we.current=!0,be(!0))},500);return()=>clearTimeout(e)}},[B,Fe,Re.length]);if(B)return o.jsx("div",{className:"flex items-center justify-center",style:{minHeight:"400px",backgroundColor:"#f9fafb"},children:o.jsxs("div",{className:"text-center",children:[o.jsx("div",{className:"w-12 h-12 border-3 border-hansl-500 border-t-transparent rounded-full animate-spin mx-auto"}),o.jsx("p",{className:"mt-4 card-subtitle",children:"ëŒ€ì‹œë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìžˆìŠµë‹ˆë‹¤..."}),o.jsxs("p",{className:"text-xs text-gray-400 mt-2",children:["Employee: ",r?.name||"ì—†ìŒ"]})]})});if(!V?.employee)return t.warn("[DashboardMain] ë°ì´í„° ì—†ìŒ",{hasData:!!V,hasEmployee:!!r,employeeName:r?.name,loading:B}),o.jsx("div",{className:"flex items-center justify-center",style:{minHeight:"400px",backgroundColor:"#f9fafb"},children:o.jsxs("div",{className:"text-center bg-white p-8 rounded-lg border border-gray-200 shadow-sm",children:[o.jsx("h3",{className:"modal-subtitle mb-2",children:"ì‚¬ìš©ìž ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"}),o.jsx("p",{className:"card-subtitle mb-4",children:"ë¡œê·¸ì¸ì„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."}),o.jsxs("div",{className:"text-xs text-gray-400 space-y-1",children:[o.jsxs("p",{children:["Employee: ",r?.name||"ì—†ìŒ"]}),o.jsxs("p",{children:["Loading: ",B?"true":"false"]}),o.jsxs("p",{children:["Has Data: ",V?"true":"false"]})]})]})});const Ie=(Array.isArray(V.employee.purchase_role)?V.employee.purchase_role.map(e=>String(e).trim()):V.employee.purchase_role?String(V.employee.purchase_role).split(",").map(e=>e.trim()).filter(e=>e.length>0):[]).some(e=>["middle_manager","final_approver","app_admin","raw_material_manager","consumable_manager"].includes(e));return o.jsxs("div",{className:"min-h-screen bg-gray-50",children:[o.jsxs("div",{className:"w-full px-4 lg:px-6",children:[o.jsx("div",{className:"mb-3",children:o.jsxs("div",{children:[o.jsx("h1",{className:"page-title",children:"ëŒ€ì‹œë³´ë“œ"}),o.jsx("p",{className:"page-subtitle",style:{marginTop:"-2px",marginBottom:"-4px"},children:"Dashboard"})]})}),o.jsx("div",{className:"mb-2",children:o.jsxs("h2",{className:"section-title mb-2 flex items-center gap-1.5",children:[o.jsx(c,{className:"w-3.5 h-3.5 text-gray-600"}),"ì „ì²´ í˜„í™©",o.jsx("span",{className:"badge-stats border border-gray-300 bg-white text-gray-600 ml-2",children:(new Date).toLocaleDateString("ko-KR",{month:"long",day:"numeric",weekday:"short"})})]})}),o.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3",children:[Ie&&o.jsxs(p,{className:"w-full col-span-1",children:[o.jsx(h,{className:"h-12 px-4 bg-gray-50 border-b flex items-center",children:o.jsxs(g,{className:"section-title flex items-center justify-between w-full",children:[o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx(k,{className:"w-3.5 h-3.5 text-orange-500"}),o.jsx("span",{children:"ìŠ¹ì¸ ëŒ€ê¸°"})]}),V.pendingApprovals.length>0&&o.jsx("span",{className:"badge-stats bg-gray-200 text-gray-700",children:V.pendingApprovals.length})]})}),o.jsx(_,{className:"p-4",children:0===V.pendingApprovals.length?o.jsxs("div",{className:"text-center py-4 text-gray-400",children:[o.jsx(T,{className:"w-6 h-6 mx-auto mb-1"}),o.jsx("p",{className:"card-description",children:"ëŒ€ê¸° í•­ëª© ì—†ìŒ"})]}):o.jsxs("div",{className:"space-y-3",children:[o.jsxs("div",{className:"relative",children:[o.jsx(f,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),o.jsx(v,{placeholder:"ë°œì£¼ë²ˆí˜¸, ì—…ì²´ëª…, í’ˆëª©ìœ¼ë¡œ ê²€ìƒ‰...",value:je.pending,onChange:e=>Ne(t=>({...t,pending:e.target.value})),className:"pl-10 h-8 text-xs"})]}),o.jsx("div",{className:"space-y-2 h-[36rem] overflow-y-auto",children:Te.slice(0,10).map((e,t)=>{const a=e.purchase_request_items||[],s=a[0]||{};e.total_amount||a.reduce((e,t)=>e+(Number(t.amount_value)||0),0);const r="ì„ ì§„í–‰"===e.progress_type,n=(e=>{const t=(e||"").toLowerCase().replace(/\s+/g,""),a=t.includes("í˜„ìž¥ê²°ì œ"),s=t.includes("ë°œì£¼"),r=t.includes("êµ¬ë§¤");return a?"bg-gray-500":s?"bg-green-500":r?"bg-blue-500":"bg-gray-300"})(e.payment_category);return o.jsxs("div",{className:"relative border rounded-lg p-2 hover:shadow-sm transition-all cursor-pointer mb-2 pl-3 "+(r?"bg-red-50 border-red-200":"hover:bg-orange-50/30"),onClick:t=>{t.target.closest("button")||Pe(e,"pending")},children:[o.jsx("div",{className:`absolute inset-y-1 left-1 w-1 rounded-full ${n}`}),o.jsxs("div",{className:"flex items-center justify-between gap-2",children:[o.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[o.jsx("span",{className:"card-title",children:e.purchase_order_number}),o.jsx("span",{className:"card-subtitle truncate",children:e.vendor_name||"ì—…ì²´"}),o.jsxs("span",{className:"card-description truncate",children:[s.item_name||"í’ˆëª©"," ",a.length>1&&`ì™¸ ${a.length-1}ê±´`]})]}),o.jsx(u,{onClick:async t=>{t.stopPropagation(),await De(e.id)},disabled:W===e.id,className:"button-base text-white "+("approved"===e.middle_manager_status?"bg-blue-600 hover:bg-blue-700":"bg-green-600 hover:bg-green-700"),children:W===e.id?o.jsx("div",{className:"w-3 h-3 border border-white border-t-transparent rounded-full animate-spin"}):o.jsxs(o.Fragment,{children:["approved"===e.middle_manager_status?"ìµœì¢…":"1ì°¨"," ìŠ¹ì¸"]})})]})]},`approval-${e.id}`)})})]})})]}),J.includes("app_admin")&&o.jsxs(p,{className:"w-full col-span-1 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[o.jsx(h,{className:"h-12 px-4 bg-gray-50 border-b flex items-center",children:o.jsx(g,{className:"section-title flex items-center w-full",children:o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx(m,{className:"w-4 h-4 text-purple-600"}),o.jsx("span",{children:"ë¯¸ì²˜ë¦¬ ë¬¸ì˜"}),se.length>0&&o.jsx("span",{className:"badge-stats bg-red-100 text-red-700",children:se.length})]})})}),o.jsx(_,{className:"p-4",children:ne?o.jsx("div",{className:"flex items-center justify-center py-8",children:o.jsx("div",{className:"w-6 h-6 border-2 border-gray-300 border-t-transparent rounded-full animate-spin"})}):0===se.length?o.jsxs("div",{className:"text-center py-12 text-gray-400",children:[o.jsx(T,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),o.jsx("p",{className:"card-subtitle",children:"ë¯¸ì²˜ë¦¬ ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤"})]}):o.jsxs("div",{className:"space-y-2 max-h-[20rem] overflow-y-auto",children:[se.slice(0,10).map(e=>{const a=le===e.id;return o.jsxs("div",{className:"border rounded-lg overflow-hidden hover:shadow-sm transition-all",children:[o.jsx("div",{className:"p-2 hover:bg-purple-50/30 cursor-pointer",onClick:()=>de(a?null:e.id),children:o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx("span",{className:"badge-stats "+("open"===e.status?"bg-yellow-100 text-yellow-800":"bg-blue-100 text-blue-800"),children:"open"===e.status?"ëŒ€ê¸°":"ì²˜ë¦¬ì¤‘"}),o.jsx("span",{className:"card-title truncate flex-1",children:e.subject}),o.jsx("span",{className:"card-description whitespace-nowrap",children:e.user_name}),o.jsx("span",{className:"card-date whitespace-nowrap",children:e.created_at&&E(new Date(e.created_at),"MM/dd HH:mm")})]})}),a&&o.jsxs("div",{className:"px-3 py-2 bg-gray-50 border-t text-xs space-y-2",children:[e.purchase_order_number&&o.jsxs("div",{children:[o.jsx("span",{className:"modal-label text-gray-500",children:"ë°œì£¼ë²ˆí˜¸:"}),o.jsx("button",{className:"text-blue-600 underline ml-2 hover:text-blue-800",onClick:a=>{a.stopPropagation(),(async e=>{try{if(e.purchase_request_id)return ue(e.purchase_request_id),ge("done"),void pe(!0);const t=e.purchase_order_number?.trim();if(!t)return void F.error("ë°œì£¼ë‚´ì—­ì´ ì‚­ì œ ë˜ì—ˆê±°ë‚˜ ì—†ìŠµë‹ˆë‹¤.");const{data:a,error:s}=await oe.from("purchase_requests").select("id").eq("purchase_order_number",t).limit(1).maybeSingle();if(s)throw s;if(!a?.id)return void F.error("ë°œì£¼ë‚´ì—­ì´ ì‚­ì œ ë˜ì—ˆê±°ë‚˜ ì—†ìŠµë‹ˆë‹¤.");ue(a.id),ge("done"),pe(!0)}catch(a){t.error("[DashboardMain] ë°œì£¼ ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨:",a),F.error("ë°œì£¼ ìƒì„¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}})(e)},title:"ë°œì£¼ ìƒì„¸ ì—´ê¸°",children:e.purchase_order_number})]}),o.jsxs("div",{children:[o.jsx("span",{className:"modal-label text-gray-500",children:"ë‚´ìš©:"}),o.jsx("p",{className:"text-gray-600 mt-1 whitespace-pre-wrap",children:e.message})]}),e.attachments&&e.attachments.length>0&&o.jsxs("div",{children:[o.jsx("span",{className:"modal-label text-gray-500",children:"ì²¨ë¶€ ì´ë¯¸ì§€:"}),o.jsx("div",{className:"flex flex-wrap gap-2 mt-1",children:e.attachments.map((e,t)=>o.jsx("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",children:o.jsx("img",{src:e.url,alt:e.name,className:"w-16 h-16 object-cover rounded border border-gray-200 hover:border-blue-400"})},t))})]}),o.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[o.jsxs("button",{className:"button-action-danger",onClick:t=>{t.stopPropagation(),(async e=>{if(!confirm("ì •ë§ë¡œ ì´ ë¬¸ì˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ ë¬¸ì˜ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."))return;const t=await I.deleteInquiry(e);t.success?(F.success("ë¬¸ì˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."),re(t=>t.filter(t=>t.id!==e)),de(null)):F.error(t.error||"ë¬¸ì˜ ì‚­ì œ ì‹¤íŒ¨")})(e.id)},children:[o.jsx(y,{className:"w-3 h-3 mr-1"}),"ì‚­ì œ"]}),o.jsx("button",{className:"button-action-primary",onClick:async()=>{const t=prompt("ì²˜ë¦¬ ì™„ë£Œ ë‹µë³€ì„ ìž…ë ¥í•´ì£¼ì„¸ìš”:");if(!t||""===t.trim())return void F.error("ë‹µë³€ ë‚´ìš©ì„ ìž…ë ¥í•´ì•¼ ì™„ë£Œ ì²˜ë¦¬í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.");const a=await I.updateInquiryStatus(e.id,"resolved",t.trim());a.success?(F.success("ë¬¸ì˜ê°€ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."),re(t=>t.filter(t=>t.id!==e.id)),de(null)):F.error(a.error||"ì™„ë£Œ ì²˜ë¦¬ ì‹¤íŒ¨")},children:"ì™„ë£Œ ì²˜ë¦¬"})]})]})]},e.id)}),se.length>10&&o.jsx("div",{className:"text-center pt-2",children:o.jsxs("button",{className:"button-action-secondary",onClick:()=>s("/support"),children:["ì „ì²´ ë³´ê¸° (",se.length,"ê±´)"]})})]})})]}),o.jsxs(p,{className:"w-full col-span-1 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[o.jsx(h,{className:"h-12 px-4 bg-gray-50 border-b flex items-center",children:o.jsxs(g,{className:"section-title flex items-center justify-between w-full",children:[o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx(A,{className:"w-4 h-4 text-blue-600"}),o.jsx("span",{children:"ìž…ê³  ëŒ€ê¸°"})]}),V.myPurchaseStatus.waitingDelivery.length>0&&o.jsx("span",{className:"badge-stats bg-gray-200 text-gray-700",children:V.myPurchaseStatus.waitingDelivery.length})]})}),o.jsx(_,{className:"p-4",children:0===V.myPurchaseStatus.waitingDelivery.length?o.jsxs("div",{className:"text-center py-12 text-gray-400",children:[o.jsx(A,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),o.jsx("p",{className:"card-subtitle",children:"ìž…ê³  ëŒ€ê¸° í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤"})]}):o.jsxs("div",{className:"space-y-3",children:[o.jsxs("div",{className:"relative",children:[o.jsx(f,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),o.jsx(v,{placeholder:"ë°œì£¼ë²ˆí˜¸, ì—…ì²´ëª…, í’ˆëª©ìœ¼ë¡œ ê²€ìƒ‰...",value:je.delivery,onChange:e=>Ne(t=>({...t,delivery:e.target.value})),className:"pl-10 h-8 text-xs"})]}),o.jsx("div",{className:"space-y-2 h-[36rem] overflow-y-auto",children:Ae.slice(0,10).map(e=>{const t=e.purchase_request_items||[],a=t[0],s=t.length;t.filter(e=>e.is_received).length,t.reduce((e,t)=>e+(Number(t.amount_value)||0),0);const r=(e.progress_type||"").includes("ì„ ì§„í–‰");return o.jsx("div",{className:"border rounded-lg p-2 transition-all cursor-pointer hover:shadow-sm mb-2 "+(r?"bg-red-50 hover:bg-red-100 border-red-200":"bg-white hover:bg-gray-50 border-gray-200"),onClick:t=>{t.target.closest("button")||Pe(e,"receipt")},children:o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx("span",{className:"card-title",children:e.purchase_order_number||`PO-${e.id.slice(0,8)}`}),o.jsx("span",{className:"card-subtitle truncate",children:e.vendor_name||"ì—…ì²´ëª… ì—†ìŒ"}),o.jsxs("span",{className:"card-description truncate",children:[a?.item_name||"í’ˆëª©",s>1&&o.jsxs("span",{className:"text-gray-400",children:[" ì™¸ ",s-1,"ê±´"]})]})]})},e.id)})})]})})]}),(J.includes("lead buyer")||J.includes("app_admin"))&&o.jsxs(p,{className:"w-full col-span-1 row-span-2 border-gray-200 shadow-sm hover:shadow-md transition-shadow",children:[o.jsx(h,{className:"h-12 px-4 bg-gray-50 border-b flex items-center",children:o.jsxs(g,{className:"section-title flex items-center justify-between w-full",children:[o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx(O,{className:"w-4 h-4 text-orange-600"}),o.jsx("span",{children:"ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œ"})]}),o.jsx("span",{className:"badge-stats bg-gray-200 text-gray-700",children:G.length})]})}),o.jsx(_,{className:"p-4",children:o.jsxs("div",{className:"space-y-3",children:[o.jsxs("div",{className:"relative",children:[o.jsx(f,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),o.jsx(v,{placeholder:"ë°œì£¼ë²ˆí˜¸, ì—…ì²´ëª…, í’ˆëª©ìœ¼ë¡œ ê²€ìƒ‰...",value:je.undownloaded,onChange:e=>Ne(t=>({...t,undownloaded:e.target.value})),className:"pl-10 h-8 text-xs"})]}),o.jsxs("div",{className:"space-y-2 h-[36rem] overflow-y-auto",children:[0===Me.length?o.jsxs("div",{className:"text-center py-12 text-gray-400",children:[o.jsx(O,{className:"w-10 h-10 mx-auto mb-3 text-gray-300"}),o.jsx("p",{className:"card-subtitle",children:"ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œê°€ ì—†ìŠµë‹ˆë‹¤"})]}):Me.map((e,a)=>{const s=e.purchase_request_items||[],r=s[0]||{},n="ì„ ì§„í–‰"===e.progress_type;return o.jsx("div",{className:"border rounded-lg p-2 hover:shadow-sm transition-all cursor-pointer mb-2 "+(n?"bg-red-50 border-red-200":"hover:bg-orange-50/30"),onClick:t=>{t.target.closest("button")||Pe(e,"pending")},children:o.jsxs("div",{className:"flex items-center justify-between gap-2",children:[o.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[o.jsx("span",{className:"card-title",children:e.purchase_order_number||`PO-${e.id.slice(0,8)}`}),o.jsx("span",{className:"card-subtitle truncate",children:e.vendor_name||"ì—…ì²´ëª… ì—†ìŒ"}),o.jsxs("span",{className:"card-description truncate",children:[r.item_name||"í’ˆëª©",s.length>1&&o.jsxs("span",{className:"text-gray-400",children:[" ì™¸ ",s.length-1,"ê±´"]})]})]}),o.jsx(u,{className:"button-base bg-gray-500 hover:bg-gray-600 text-white",onClick:async a=>{a.stopPropagation(),await(async e=>{try{ee(t=>new Set(t).add(e.id)),await new Promise(e=>setTimeout(e,0)),await M({id:e.id,purchase_order_number:e.purchase_order_number,vendor_name:e.vendor_name,vendor_id:e.vendor_id,contact_id:e.contact_id},J,()=>{X(t=>t.filter(t=>t.id!==e.id))})}catch(a){t.error("Excel ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ",a)}finally{ee(t=>{const a=new Set(t);return a.delete(e.id),a})}})(e)},disabled:Z.has(e.id),children:Z.has(e.id)?o.jsx("div",{className:"w-3 h-3 border border-white border-t-transparent rounded-full animate-spin"}):"ë‹¤ìš´ë¡œë“œ"})]})},`undownloaded-${e.id}`)}),Me.length>=100&&o.jsxs("div",{className:"text-center text-xs text-gray-500 mt-3 pb-2",children:["í‘œì‹œëœ í•­ëª©: ",Me.length,"ê°œ",o.jsx("br",{}),"ë” ë§Žì€ í•­ëª©ì´ ìžˆì„ ìˆ˜ ìžˆìŠµë‹ˆë‹¤. ê²€ìƒ‰ìœ¼ë¡œ í•„í„°ë§í•˜ì„¸ìš”."]}),Me.length>0&&o.jsxs("div",{className:"text-center text-xs text-gray-400 mt-2 pb-2",children:["ì´ ",Me.length,"ê°œ ë¯¸ë‹¤ìš´ë¡œë“œ ë°œì£¼ì„œ"]})]})]})})]})]})]}),o.jsx(R,{purchaseId:ce,isOpen:me,onClose:()=>{pe(!1),ue(null),ge("pending")},currentUserRoles:J,activeTab:he,onRefresh:()=>{qe(!1),pe(!1),ue(null),ge("pending")},onOptimisticUpdate:(e,t)=>{a(e,t),qe(!1)},onDelete:e=>{ve(e),fe(!0)}}),o.jsx(x,{open:_e,onOpenChange:e=>{fe(e),e||ve(null)},children:o.jsxs(b,{children:[o.jsxs(w,{children:[o.jsx(j,{children:"ë°œì£¼ìš”ì²­ ë‚´ì—­ ì‚­ì œ"}),o.jsxs(N,{children:["ë°œì£¼ìš”ì²­ë²ˆí˜¸ ",o.jsx("strong",{children:ye?.purchase_order_number||"ì•Œ ìˆ˜ ì—†ìŒ"}),"ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",o.jsx("br",{}),"ì´ ìž‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."]})]}),o.jsxs(q,{children:[o.jsx(S,{children:"ì·¨ì†Œ"}),o.jsx(D,{onClick:async()=>{if(ye?.id)try{const e="string"==typeof ye.id?parseInt(ye.id,10):ye.id;if(!e||Number.isNaN(e))return void F.error("ë°œì£¼ IDê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");const{error:t}=await oe.from("support_inquires").update({purchase_request_id:null}).eq("purchase_request_id",e);if(t)throw t;const{error:a}=await oe.from("purchase_request_items").delete().eq("purchase_request_id",e);if(a)throw a;const{error:s}=await oe.from("purchase_requests").delete().eq("id",e);if(s)throw s;F.success("ë°œì£¼ìš”ì²­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."),fe(!1),ve(null),pe(!1),ue(null),Q(t=>{if(!t)return t;const a=String(e),s=(e=[])=>e.filter(e=>String(e.id)!==a),r=t.myPurchaseStatus?{...t.myPurchaseStatus,waitingDelivery:s(t.myPurchaseStatus.waitingDelivery),waitingPurchase:s(t.myPurchaseStatus.waitingPurchase),recentCompleted:s(t.myPurchaseStatus.recentCompleted)}:t.myPurchaseStatus;return{...t,pendingApprovals:s(t.pendingApprovals),myRecentRequests:s(t.myRecentRequests),myPurchaseStatus:r}}),X(t=>t.filter(t=>String(t.id)!==String(e))),$.invalidateCache(),qe(!1,!0)}catch(e){t.error("[DashboardMain] ë°œì£¼ ì‚­ì œ ì‹¤íŒ¨:",e),F.error("ë°œì£¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}else F.error("ì‚­ì œí•  ë°œì£¼ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.")},className:"bg-red-600 hover:bg-red-700",children:"ì‚­ì œ"})]})]})}),o.jsx(C,{isOpen:xe,onClose:()=>{be(!1),qe(!1,!0)},purchases:Re,currentUserName:H,onRefresh:()=>qe(!1,!0)})]})}export{H as default};
//# sourceMappingURL=DashboardMain-Cr6_GyjA.js.map
